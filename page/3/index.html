<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 8.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/my_icon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/my_icon/favicon-16x16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="manifest" href="/images/my_icon/manifest.json">
  <meta name="msapplication-config" content="/images/my_icon/browserconfig.xml">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC|Roboto/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Roboto:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"cursorhu.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="ThinkNotes">
<meta property="og:url" content="https://cursorhu.github.io/page/3/index.html">
<meta property="og:site_name" content="ThinkNotes">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="cursorhu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://cursorhu.github.io/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>ThinkNotes</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ThinkNotes</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Simple is not easy | 化繁为简，知易行难</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于我</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/08/30/UEFI%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%80%EF%BC%89EDK2%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/30/UEFI%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%80%EF%BC%89EDK2%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">UEFI开发（一）EDK2环境搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-08-30 17:52:38" itemprop="dateCreated datePublished" datetime="2024-08-30T17:52:38+08:00">2024-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:27:38" itemprop="dateModified" datetime="2025-11-04T17:27:38+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UEFI%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">UEFI开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="UEFI开发（一）EDK2环境搭建"><a href="#UEFI开发（一）EDK2环境搭建" class="headerlink" title="UEFI开发（一）EDK2环境搭建"></a>UEFI开发（一）EDK2环境搭建</h1><p>官方文档：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/tianocore/tianocore.github.io/wiki/Getting-Started-with-EDK-II">https://github.com/tianocore/tianocore.github.io/wiki/Getting-Started-with-EDK-II</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/tianocore/tianocore.github.io/wiki/EDK-II-User-Documentation">https://github.com/tianocore/tianocore.github.io/wiki/EDK-II-User-Documentation</a></p>
<h2 id="下载代码"><a href="#下载代码" class="headerlink" title="下载代码"></a>下载代码</h2><p>参考：<a target="_blank" rel="noopener" href="https://github.com/tianocore/edk2?tab=readme-ov-file#submodules">edk2&#x2F;Submodules</a></p>
<p>在C盘根目录用git命令下载edk2并下载submodule：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/tianocore/edk2.git</span><br><span class="line">cd edk2</span><br><span class="line">git submodule update --init</span><br></pre></td></tr></table></figure>

<p>如果要切换到stable tag版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git tag -l #列出tag， -l: list</span><br><span class="line">git checkout edk2-stable202X0X #切table tag</span><br><span class="line">git submodule update #更新submodule（对应stable tag）</span><br></pre></td></tr></table></figure>

<p>我的环境是VS2022，当前edk2 master主线支持VS2022，而最新的stable tag不支持，所以用master版本，没必要checkout到stable tag。</p>
<h2 id="编译EDK2"><a href="#编译EDK2" class="headerlink" title="编译EDK2"></a>编译EDK2</h2><h3 id="编译环境准备"><a href="#编译环境准备" class="headerlink" title="编译环境准备"></a>编译环境准备</h3><p>参考：<a target="_blank" rel="noopener" href="https://github.com/tianocore/tianocore.github.io/wiki/Windows-systems">https://github.com/tianocore/tianocore.github.io/wiki/Windows-systems</a></p>
<ol>
<li><p>按 <a href="edk2%5CBaseTools%5CBin"><strong>Build</strong></a> 下载NASM和ASL二进制包，放到C盘跟&#x3D;根目录（和edk2同路径）</p>
</li>
<li><p>运行edksetup.bat，编译edk2&#x2F;BaseTool</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">C:\edk2&gt;edksetup.bat</span><br><span class="line"></span><br><span class="line">**********************************************************************</span><br><span class="line"></span><br><span class="line">** Visual Studio 2022 Developer Command Prompt v17.13.6</span><br><span class="line">** Copyright (c) 2022 Microsoft Corporation</span><br><span class="line"></span><br><span class="line">**********************************************************************</span><br><span class="line"></span><br><span class="line">[vcvarsall.bat] Environment initialized for: &#x27;x86&#x27;</span><br><span class="line">Using EDK2 in-source Basetools</span><br><span class="line">          PATH      = C:\edk2\BaseTools\BinWrappers\WindowsLike;D:\Program Files\Microsoft Visual Studio\2022\Community\VC\Tools\MSVC\14.43.34808\bin\HostX86\x86;D:\Program Files\Microsoft Visual .... Studio\2022\Community\Common7\IDE\VC\Linux\bin\ConnectionManagerExe;D:\Program Files\Microsoft Visual Studio\2022\Community\VC\vcpkg</span><br><span class="line"></span><br><span class="line">     WORKSPACE      = C:\edk2</span><br><span class="line"></span><br><span class="line">EDK_TOOLS_PATH      = C:\edk2\BaseTools</span><br><span class="line">BASE_TOOLS_PATH     = C:\edk2\BaseTools</span><br><span class="line"> EDK_TOOLS_BIN      = C:\edk2\BaseTools\Bin\Win32</span><br><span class="line">     CONF_PATH      = C:\edk2\Conf</span><br><span class="line">     PYTHON_COMMAND = py -3</span><br><span class="line">         PYTHONPATH = C:\edk2\BaseTools\Source\Python;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">!!! WARNING !!! NASM_PREFIX environment variable is not set</span><br><span class="line">  Found nasm.exe, setting the environment variable to C:\nasm\</span><br><span class="line"></span><br><span class="line">!!! WARNING !!! CLANG_BIN environment variable is not set</span><br></pre></td></tr></table></figure>

<p>log中的一些信息含义：</p>
<p>（1）新版本edk2已经包含python包，无需自己再去下载和指定python路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PYTHONPATH = C:\edk2\BaseTools\Source\Python;</span><br></pre></td></tr></table></figure>

<p>（2）已自动设置nasm路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Found nasm.exe, setting the environment variable to C:\nasm\</span><br></pre></td></tr></table></figure>

<p>（3）用VS2022编译，CLANG_BIN不用设置</p>
<p>编译输出二进制在edk2\BaseTools\Bin</p>
<h3 id="编译目标模块"><a href="#编译目标模块" class="headerlink" title="编译目标模块"></a>编译目标模块</h3><p>运行edksetup后，再执行编译：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">build</span><br></pre></td></tr></table></figure>

<p>编译目标由edk2&#x2F;Conf&#x2F;target.txt的ACTIVE_PLATFORM和TARGET_ARCH指定</p>
<h3 id="终端乱码问题"><a href="#终端乱码问题" class="headerlink" title="终端乱码问题"></a>终端乱码问题</h3><p>在编译前可用以下命令将命令行的输出转成UTF8格式，防止输出乱码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chcp 65001</span><br></pre></td></tr></table></figure>

<p>下图说明从Conf&#x2F;target的产生到编译完成的全流程</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504141429251.png" alt="image-20250414142907112"></p>
<h2 id="搭建UEFI-shell启动盘"><a href="#搭建UEFI-shell启动盘" class="headerlink" title="搭建UEFI shell启动盘"></a>搭建UEFI shell启动盘</h2><h3 id="创建UEFI-shell盘"><a href="#创建UEFI-shell盘" class="headerlink" title="创建UEFI shell盘"></a>创建UEFI shell盘</h3><ol>
<li>找一个U盘，格式化成FAT32，然后在U盘根目录下建立&#x2F;efi&#x2F;boot目录。</li>
<li>自己编译UEFI shell.efi或者下载Shell.efi</li>
<li>把Shell.efi改名成BOOTX64.efi，然后把BOOTX64.efi拷贝到U盘&#x2F;efi&#x2F;boot&#x2F;目录下。</li>
<li>自己编译的其他UEFI程序，如MdeModulePkg Application efi或者DXE efi驱动，都可放到U盘根目录</li>
<li>U盘插入电脑，开机后按F12(不同厂商电脑可能有所不同)进入UEFI menu选择页面，选择从U盘启动</li>
</ol>
<p>(1) 如何自己编译UEFI shell.efi：</p>
<p>前面edk2编译环境ok后，改Conf&#x2F;target.txt为编译ShellPkg：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ACTIVE_PLATFORM       = ShellPkg/ShellPkg.dsc</span><br><span class="line">TARGET_ARCH           = X64</span><br><span class="line">TOOL_CHAIN_TAG        = VS2019</span><br></pre></td></tr></table></figure>

<p>编译完成后输出Shell.efi在Build&#x2F;Shell&#x2F;<TOOL_CHAIN_TAG>&#x2F;<TARGET_ARCH>&#x2F;ShellPkg&#x2F;Application&#x2F;Shell&#x2F;Shell&#x2F;OUTPUT&#x2F;目录下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Finished generating code</span><br><span class="line">        &quot;GenFw&quot; -e UEFI_APPLICATION -o C:\edk2\Build\Shell\DEBUG_VS2019\X64\ShellPkg\Application\Shell\Shell\OUTPUT\Shell.efi C:\edk2\Build\Shell\DEBUG_VS2019\X64\ShellPkg\Application\Shell\Shell\DEBUG\Shell.dll</span><br><span class="line">        copy /y C:\edk2\Build\Shell\DEBUG_VS2019\X64\ShellPkg\Application\Shell\Shell\OUTPUT\Shell.efi </span><br><span class="line"></span><br><span class="line">- Done -</span><br></pre></td></tr></table></figure>

<p>(2)下载编译好的Shell.efi</p>
<p><a target="_blank" rel="noopener" href="https://github.com/pbatard/UEFI-Shell/releases">https://github.com/pbatard/UEFI-Shell/releases</a></p>
<p>包含各平台的shell.efi</p>
<h3 id="startup-nsh脚本"><a href="#startup-nsh脚本" class="headerlink" title="startup.nsh脚本"></a>startup.nsh脚本</h3><p>UEFI Shell.efi启动时会查找根目录下有没有startup.nsh脚本，如果有的话会自动执行startup.nsh脚本</p>
<p>比如U盘在UEFI shell下的盘符为 FS0: ，想要启动自动执行根目录的myUefiApp.efi程序，startup.nsh脚本如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#切换到FS0盘符的根目录</span><br><span class="line">FS0:</span><br><span class="line">#执行程序（预先放在根目录）</span><br><span class="line">MyUefiApp.efi</span><br></pre></td></tr></table></figure>

<p>也可以用绝对路径执行MyUefiApp.efi，即 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FS0:\MyUefiApp.efi</span><br></pre></td></tr></table></figure>

<h3 id="进入UEFI-shell"><a href="#进入UEFI-shell" class="headerlink" title="进入UEFI shell"></a>进入UEFI shell</h3><p>如图是F12进入U盘UEFI shell环境，其中：</p>
<p>UEFI shell版本v2.7，可见来源信息</p>
<p>map -r显示可识别设备信息：</p>
<ol>
<li><p>FS是filesystem文件系统设备。FS0是USB设备，位于PCi bridge 0x14上；FS1是Sata硬盘，位于PCi bridge 0x17上</p>
</li>
<li><p>BLK是文件分区。BLK0是USB的分区，BLK2和4都是Sata硬盘的文件分区</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504161706334.png" alt="image-20250416170607057"></p>
<h3 id="copy-startup加快测试"><a href="#copy-startup加快测试" class="headerlink" title="copy+startup加快测试"></a>copy+startup加快测试</h3><p><a target="_blank" rel="noopener" href="https://ss64.com/nt/xcopy.html">https://ss64.com/nt/xcopy.html</a></p>
<p>调试efi经常要重新编译和拷贝efi到u盘，用copy命令自动化</p>
<p>build编译模块时，输出的efi已经拷贝过一次。这里再创建一个.bat拷到u盘（E盘根目录）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">copy /y C:\edk2\Build\MdeModule\DEBUG_VS2019\X64\MdeModulePkg\Bus\Pci\SdMmcPciHcDxe\SdMmcPciHcDxe\OUTPUT\SdMmcPciHcDxe.efi C:\edk2\Build\MdeModule\DEBUG_VS2019\X64\SdMmcPciHcDxe.efi</span><br><span class="line"></span><br><span class="line">copy /y C:\edk2\Build\MdeModule\DEBUG_VS2019\X64\SdMmcPciHcDxe.efi E:\</span><br></pre></td></tr></table></figure>

<p>这样编译后自动拷贝到U盘，在UEFI测试机上创建startup.sh自动运行efi驱动加载：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fs0:</span><br><span class="line">load SdMmcPciHcDxe.efi</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/08/30/UEFI%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/30/UEFI%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%8C%EF%BC%89/" class="post-title-link" itemprop="url">UEFI开发（二）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-08-30 17:52:38" itemprop="dateCreated datePublished" datetime="2024-08-30T17:52:38+08:00">2024-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-18 10:49:11" itemprop="dateModified" datetime="2025-11-18T10:49:11+08:00">2025-11-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UEFI%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">UEFI开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="UEFI开发（二）"><a href="#UEFI开发（二）" class="headerlink" title="UEFI开发（二）"></a>UEFI开发（二）</h1><h2 id="Library库"><a href="#Library库" class="headerlink" title="Library库"></a>Library库</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45279063/article/details/115324601">https://blog.csdn.net/weixin_45279063/article/details/115324601</a></p>
<p>以后面要用到的DEBUG库为例：</p>
<p>库的调用方是MdeModulePkg下的某个INF模块，被调用方是MdePkg库（这个属于基础库很常用）</p>
<ol>
<li>调用方的INF中要导入库模块的dec和要用到的LibraryClasses</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[Packages]</span><br><span class="line">  MdePkg/MdePkg.dec #这里包含了库模块MdePkg的dec声明，获取到MdePkg所有对外开放的库接口</span><br><span class="line">  MdeModulePkg/MdeModulePkg.dec #这是调用方模块</span><br><span class="line"></span><br><span class="line">[LibraryClasses]</span><br><span class="line">  DevicePathLib</span><br><span class="line">  UefiBootServicesTableLib</span><br><span class="line">  UefiRuntimeServicesTableLib</span><br><span class="line">  MemoryAllocationLib</span><br><span class="line">  BaseMemoryLib</span><br><span class="line">  UefiLib</span><br><span class="line">  BaseLib</span><br><span class="line">  UefiDriverEntryPoint</span><br><span class="line">  DebugLib #这里导入了MdePkg库的DebugLib类（头文件），类似其他语言的import或者include namespace</span><br><span class="line">  PcdLib</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>调用方的c代码中可以直接include库的头文件（不需要用相对地址包含头文件）</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;Library/DebugLib.h&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>调用方使用库的函数体DEBUG();</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DEBUG((DEBUG_INFO, &quot;Initializing XXX controller in slot %d\n&quot;, Slot));</span><br><span class="line"></span><br><span class="line">Status = InitController(PciIo, Slot);</span><br><span class="line">if (EFI_ERROR(Status))</span><br><span class="line">&#123;</span><br><span class="line">    DEBUG((DEBUG_ERROR, &quot;Failed to switch Host to PCIe mode: %r\n&quot;, Status));</span><br><span class="line">    return Status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DEBUG打印"><a href="#DEBUG打印" class="headerlink" title="DEBUG打印"></a>DEBUG打印</h2><p><a target="_blank" rel="noopener" href="https://github.com/tianocore/tianocore.github.io/wiki/EDK-II-Debugging">https://github.com/tianocore/tianocore.github.io/wiki/EDK-II-Debugging</a></p>
<p>在使用DEBUG INFO的MdeModulePkg模块的dsc中，声明DEBUG库的全局变量PcdDebugPropertyMask和PcdDebugPrintErrorLevel，指定支持INFO级别打印，否则默认只会打印DEBUG(ERROR)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[PcdsFixedAtBuild]</span><br><span class="line"># refer to https://github.com/tianocore/tianocore.github.io/wiki/EDK-II-Debugging</span><br><span class="line">  gEfiMdePkgTokenSpaceGuid.PcdDebugPropertyMask|0x0f</span><br><span class="line">  gEfiMdePkgTokenSpaceGuid.PcdDebugPrintErrorLevel|0x80000040</span><br></pre></td></tr></table></figure>

<p>再编译MdeModulePkg inf，输出的efi可见INFO级别的打印生效。</p>
<h2 id="UTF8中文报错"><a href="#UTF8中文报错" class="headerlink" title="UTF8中文报错"></a>UTF8中文报错</h2><p>问题log：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\edk2\MdeModulePkg\Bus\Pci\SdMmcPciHcDxe\BayhubHost.h(1): error C2220: the following warning is treated as an error</span><br><span class="line">C:\edk2\MdeModulePkg\Bus\Pci\SdMmcPciHcDxe\BayhubHost.h(1): warning C4819: The file contains a character that cannot be represented in the current code page (936). Save the file in Unicode format to prevent data loss</span><br></pre></td></tr></table></figure>

<p>错误信息指出：<br>警告C4819被当作错误处理<br>文件包含无法在当前代码页(936，即中文GBK编码)中表示的字符</p>
<p>解决方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">使用Notepad++重新保存文件:</span><br><span class="line">打开文件，编码选择&quot;UTF-8 with signature (UTF-8-BOM)&quot;或者&quot;UTF-8&quot;</span><br><span class="line">保存文件</span><br></pre></td></tr></table></figure>

<p>原因：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">文件有非ASCII字符（特别是在注释中）</span><br><span class="line">有时文件的首行可能有不可见的BOM（字节顺序标记）或其他特殊字符</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/08/30/Windows%20Driver%20-%20Visual%20Studio%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/30/Windows%20Driver%20-%20Visual%20Studio%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">Windows Driver - Visual Studio配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-08-30 17:52:38" itemprop="dateCreated datePublished" datetime="2024-08-30T17:52:38+08:00">2024-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-18 10:33:49" itemprop="dateModified" datetime="2025-11-18T10:33:49+08:00">2025-11-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/windows%E9%A9%B1%E5%8A%A8/" itemprop="url" rel="index"><span itemprop="name">windows驱动</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Windows-Driver-Visual-Studio配置"><a href="#Windows-Driver-Visual-Studio配置" class="headerlink" title="Windows Driver - Visual Studio配置"></a>Windows Driver - Visual Studio配置</h1><h2 id="安装VisualStudio-SDK-WDK环境"><a href="#安装VisualStudio-SDK-WDK环境" class="headerlink" title="安装VisualStudio+SDK+WDK环境"></a>安装VisualStudio+SDK+WDK环境</h2><p>全部流程：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/download-the-wdk">https://learn.microsoft.com/zh-cn/windows-hardware/drivers/download-the-wdk</a></p>
<p>注意：WDK安装前要求先安装适配版本的SDK：</p>
<p><a target="_blank" rel="noopener" href="https://developer.microsoft.com/en-us/windows/downloads/windows-sdk/">https://developer.microsoft.com/en-us/windows/downloads/windows-sdk/</a></p>
<p>推荐按以上链接在VS安装程序中安装Windows 11 SDK (10.0.26100.0)，注意默认选中的不是这个版本，需要手动选择这个版本：</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202408121640199.png" alt="image-20240812164012107"></p>
<p>正常安装完SDK和WDK后，创建一个KMDF项目是像这样：如果缺少SDK和Driver Setting这些，说明SDK版本不匹配</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202408121647174.png" alt="image-20240812164731134"></p>
<p>注意：如果在有问题的环境创建了项目编译会报错，在环境配好后该项目也不能用还是会编译报错，应该删除重新建。</p>
<h2 id="VS2019-SDK-WDK环境"><a href="#VS2019-SDK-WDK环境" class="headerlink" title="VS2019+SDK+WDK环境"></a>VS2019+SDK+WDK环境</h2><p>TODO</p>
<h2 id="搭建DVL环境（for-WHQL）"><a href="#搭建DVL环境（for-WHQL）" class="headerlink" title="搭建DVL环境（for WHQL）"></a>搭建DVL环境（for WHQL）</h2><p>前置环境：Visual Studio 2019 + SDK 22000 + WDK 22000 + 一些MSVC模块 </p>
<p>(Visual Studio 2022 + 24H2 WDK无法正常执行CodeQL(找不到x86\InfVerif.dll)，也没有自带SDV，暂时不用VS2022环境)</p>
<p>DVL：driver verification log</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/develop/creating-a-driver-verification-log">https://learn.microsoft.com/zh-cn/windows-hardware/drivers/develop/creating-a-driver-verification-log</a></p>
<p>The <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/design/compatibility/">Windows Hardware Certification Program</a> requires a driver verification log (DVL) for driver submissions. The DVL contains a summary of the results from static analysis tools, <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/static-tools-and-codeql">CodeQL</a>. The DVL doesn’t contain any source code information. Before creating a DVL for your driver, run CodeQL, the code analysis tool, and static driver verifier. </p>
<p>使用VS2019+WDK，WHQL的DVL生成依赖于三项文件：<img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202412271608916.png" alt="image-20241227160816886"></p>
<ol>
<li>Code Analysis（CA） log： VS2019 + WDK 环境可以生成</li>
<li>Static Driver Verifier（SDV） log：VS2019 + WDK 环境可以生成</li>
<li>CodeQL Sarif log：需要配置CodeQL环境</li>
</ol>
<p>根据微软的SDV文档（<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/static-driver-verifier%EF%BC%89%EF%BC%9ACodeQL">https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/static-driver-verifier）：CodeQL</a> 和SDV似乎是并列关系，都是静态代码分析，因此VS 2022直接不支持SDV，只推荐CodeQL。但不确定WHQL logo driver是不是必须要SDV，因此还是用VS2019环境以确保DVL需要的三种log都能生成。</p>
<h3 id="配置CodeQL环境"><a href="#配置CodeQL环境" class="headerlink" title="配置CodeQL环境"></a>配置CodeQL环境</h3><p>详细步骤参考：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/static-tools-and-codeql#queries-and-suites">https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/static-tools-and-codeql#queries-and-suites</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/microsoft/Windows-Driver-Developer-Supplemental-Tools">https://github.com/microsoft/Windows-Driver-Developer-Supplemental-Tools</a></p>
<p>WHQL的OS版本对CodeQL版本的兼容矩阵表：</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202412271036011.png" alt="image-20241227103629965"></p>
<p>假如要发布24H2的WHQL driver，需要选用红框的版本。按以下几步配置CodeQL环境：</p>
<p>创建CodeQL环境的home目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; mkdir C:\codeql-home</span><br></pre></td></tr></table></figure>

<ol>
<li>下载CodeQL 2.15.4 二进制包</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://github.com/github/codeql-cli-binaries/releases/tag/v2.15.4">https://github.com/github/codeql-cli-binaries/releases/tag/v2.15.4</a></p>
<ol start="2">
<li><p>下载Windows Driver Developer Supplemental Tools的WHCP_24H2分支；或者git clone，再checkout到WHCP_24H2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">（1）下载Windows Driver Developer Supplemental Tools的WHCP_24H2分支：</span><br><span class="line">git clone https://github.com/microsoft/Windows-Driver-Developer-Supplemental-Tools.git</span><br><span class="line">git branch -a</span><br><span class="line">git checkout WHCP_24H2</span><br><span class="line">也可以在github页面切换到WHCP_24H2分支后下载压缩包</span><br><span class="line"></span><br><span class="line">（2）查看分支：</span><br><span class="line">C:\codeql-home\Windows-Driver-Developer-Supplemental-Tools&gt;git branch</span><br><span class="line">* WHCP_24H2</span><br><span class="line">  main</span><br></pre></td></tr></table></figure>

<p>注意，不同的分支可能对应不同的<a target="_blank" rel="noopener" href="https://github.com/microsoft/Windows-Driver-Developer-Supplemental-Tools/blob/main/suites/windows_driver_mustfix.qls">windows_driver_mustfix.qls</a></p>
</li>
<li><p>安装CodeQL query packages</p>
<p>如果不安装CodeQL query packages，直接执行codeql analyze会报package缺失，目前我是手动安装package：VS rebuild多次执行后处理脚本RunCodeQLRebuildQuery.bat，每次报错缺什么版本package就装什么，如下图，直到不再报错。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202412271547361.png" alt="image-20241227154734283"></p>
<p>安装单个query packages方法：在C:\codeql-home\codeql目录下（包含codeql.exe），执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql pack download &lt;package&gt;@&lt;version&gt;</span><br></pre></td></tr></table></figure>

<p>安装所有依赖的query packages过程如下（仅针对CodeQL 2.15.4）：</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">Package specifications to check for download: codeql/cpp-queries@0.9.0</span><br><span class="line">Package install location: C:\Users\thomas.hu.O2\.codeql\packages</span><br><span class="line">Installed fresh codeql/cpp-queries@0.9.0</span><br><span class="line"></span><br><span class="line">C:\codeql-home\codeql&gt;</span><br><span class="line">C:\codeql-home\codeql&gt;codeql pack download microsoft/windows-drivers@1.1.0</span><br><span class="line">Package specifications to check for download: microsoft/windows-drivers@1.1.0</span><br><span class="line">Did not need to download any packs.</span><br><span class="line">Package install location: C:\Users\thomas.hu.O2\.codeql\packages</span><br><span class="line">Nothing downloaded.</span><br><span class="line"></span><br><span class="line">C:\codeql-home\codeql&gt;codeql pack download codeql/cpp-all@0.12.1</span><br><span class="line">Package specifications to check for download: codeql/cpp-all@0.12.1</span><br><span class="line">Package install location: C:\Users\thomas.hu.O2\.codeql\packages</span><br><span class="line">Installed fresh codeql/cpp-all@0.12.1 (library)</span><br><span class="line"></span><br><span class="line">C:\codeql-home\codeql&gt;</span><br><span class="line">C:\codeql-home\codeql&gt;codeql pack download codeql/dataflow@0.1.4</span><br><span class="line">Package specifications to check for download: codeql/dataflow@0.1.4</span><br><span class="line">Package install location: C:\Users\thomas.hu.O2\.codeql\packages</span><br><span class="line">Installed fresh codeql/dataflow@0.1.4 (library)</span><br><span class="line"></span><br><span class="line">C:\codeql-home\codeql&gt;codeql pack download codeql/rangeanalysis@0.0.3</span><br><span class="line">Package specifications to check for download: codeql/rangeanalysis@0.0.3</span><br><span class="line">Package install location: C:\Users\thomas.hu.O2\.codeql\packages</span><br><span class="line">Installed fresh codeql/rangeanalysis@0.0.3 (library)</span><br><span class="line"></span><br><span class="line">C:\codeql-home\codeql&gt;codeql pack download codeql/ssa@0.2.4</span><br><span class="line">Package specifications to check for download: codeql/ssa@0.2.4</span><br><span class="line">Package install location: C:\Users\thomas.hu.O2\.codeql\packages</span><br><span class="line">Installed fresh codeql/ssa@0.2.4 (library)</span><br><span class="line"></span><br><span class="line">C:\codeql-home\codeql&gt;codeql pack download codeql/tutorial@0.2.4</span><br><span class="line">Package specifications to check for download: codeql/tutorial@0.2.4</span><br><span class="line">Package install location: C:\Users\thomas.hu.O2\.codeql\packages</span><br><span class="line">Installed fresh codeql/tutorial@0.2.4 (library)</span><br><span class="line"></span><br><span class="line">C:\codeql-home\codeql&gt;codeql pack download codeql/util@0.2.4</span><br><span class="line">Package specifications to check for download: codeql/util@0.2.4</span><br><span class="line">Package install location: C:\Users\thomas.hu.O2\.codeql\packages</span><br><span class="line">Installed fresh codeql/util@0.2.4 (library)</span><br><span class="line"></span><br><span class="line">C:\codeql-home\codeql&gt;codeql pack download codeql/typetracking@0.2.4</span><br><span class="line">Package specifications to check for download: codeql/typetracking@0.2.4</span><br><span class="line">Package install location: C:\Users\thomas.hu.O2\.codeql\packages</span><br><span class="line">Installed fresh codeql/typetracking@0.2.4 (library)</span><br></pre></td></tr></table></figure>

<p>有时候网络不好下载失败，换个时间多次重试直到安装成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C:\codeql-home\codeql&gt;codeql pack download codeql/cpp-queries@0.9.0</span><br><span class="line">Package specifications to check for download: codeql/cpp-queries@0.9.0</span><br><span class="line">A fatal error occurred: Error downloading blob.</span><br><span class="line">(eventual cause: SocketTimeoutException &quot;Read timed out&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="CodeQL生成-sarif"><a href="#CodeQL生成-sarif" class="headerlink" title="CodeQL生成.sarif"></a>CodeQL生成.sarif</h3><p>(1) 使用.BAT（参考 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/static-tools-and-codeql#queries-and-suites">https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/static-tools-and-codeql#queries-and-suites</a>  7. Visual Studio Post-Build Event (Optional)）</p>
<p>(2) RunCodeQLRebuildQuery.bat内容如下：</p>
<p>​    功能：在C:\codeql-home创建空目录databases，再执行codeql create database和codeql analyze database，其中codeql analyze database依赖于前面的CodeQL query packages和Windows Driver Developer Supplemental Tools。最后输出kmdf.sarif。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ECHO &quot;&gt;&gt;&gt; Running CodeQL Security Rule V 1.0 &lt;&lt;&lt;&quot;</span><br><span class="line">ECHO &quot;Current directory:&quot; %cd%</span><br><span class="line"></span><br><span class="line">set HOME=C:\codeql-home</span><br><span class="line">set SRC=%cd%</span><br><span class="line"></span><br><span class="line">ECHO &quot;&gt;&gt;&gt; Removing previously created rules database &lt;&lt;&lt;&quot;</span><br><span class="line">if exist %HOME%\databases (</span><br><span class="line">	rmdir /s/q %HOME%\databases</span><br><span class="line">)</span><br><span class="line">mkdir %HOME%\databases</span><br><span class="line"></span><br><span class="line">ECHO &quot;&gt;&gt;&gt; codeql create database &lt;&lt;&lt;&quot;</span><br><span class="line">%HOME%\codeql\codeql database create &quot;%HOME%\databases&quot; -l=cpp -s=%SRC% -c &quot;msbuild %SRC%\bhtpcr.sln /p:Configuration=Win8.1Release /p:Platform=ARM64 /t:rebuild /p:PostBuildEventUseInBuild=false&quot;</span><br><span class="line">::ECHO &quot;&gt;&gt;&gt; codeql analyze database &lt;&lt;&lt;&quot;</span><br><span class="line">::codeql database analyze &lt;path to database&gt; &lt;path to query suite .qls file&gt;</span><br><span class="line">CALL %HOME%\codeql\codeql database analyze --download &quot;%HOME%\databases&quot; &quot;%HOME%\Windows-Driver-Developer-Supplemental-Tools\suites\windows_driver_mustfix.qls&quot; --format=sarifv2.1.0 --output=%HOME%\databases\kmdf.sarif --rerun</span><br><span class="line"></span><br><span class="line">ECHO &quot;&gt;&gt;&gt; Loading SARIF Results in Visual Studio &lt;&lt;&lt;&quot;</span><br><span class="line">CALL devenv /Edit %HOME%\databases\kmdf.sarif</span><br><span class="line">SET ERRORLEVEL = 0</span><br></pre></td></tr></table></figure>

<p>(3) 设置项目后处理脚本为RunCodeQLRebuildQuery.bat，并使能，如下图：</p>
<p>这个示例RunCodeQLRebuildQuery.bat位置是.vcxproj的上级目录，也可以放同级目录，不需要加..\</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202412271529699.png" alt="image-20241227152914648"></p>
<p>(4)运行项目rebuild，编译后会运行RunCodeQLRebuildQuery.bat，正常结果显示success，并能看到kmdf.sarif文件，如下图。如果有错一般是前面的query依赖库没装好，或者VS+WDK版本不兼容。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202412271544290.png" alt="image-20241227154401168"></p>
<p>(5) 最后将C:\codeql-home\databases\kmdf.sarif拷贝到Driver的vcproj目录，后面的DVL生成会用到。</p>
<p>(6) RunCodeQLRebuildQuery.bat的调试经验：</p>
<p>如果找不到msbuild，需要将msbuild.exe的路径加到系统PATH，例如（D:\Program Files\Microsoft Visual Studio\2019\Community\MSBuild\Current\Bin）</p>
<p>中文系统上执行msbuild可能输出乱码，CMD中设置中文编码支持：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chcp 65001</span><br></pre></td></tr></table></figure>

<h3 id="运行SDV和Code-Analysis，生成DVL"><a href="#运行SDV和Code-Analysis，生成DVL" class="headerlink" title="运行SDV和Code Analysis，生成DVL"></a>运行SDV和Code Analysis，生成DVL</h3><p>（1）生成SDV：VS2019 + WDK 22000安装后自带SDV（Static Driver Verifier）</p>
<p>VS2019 -&gt; Extension -&gt; Driver -&gt; Launch Static Driver Verifier</p>
<p>默认选择must fix项，但WHQL的HLK并不需要测所有，也不要求测试项必须通过，因此也可以选择default，或者自定义只测一项nullcheck。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202412271607797.png" alt="image-20241227160707770"></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202412271607341.png" alt="image-20241227160717317"></p>
<p>（2）生成CA：VS2019 -&gt; Analyze -&gt; Run code analysis -&gt; Run code analysis on bhtsddr</p>
<p>（3）生成kmdf.sarif：已在项目目录下</p>
<p>（4）生成DVL：VS2019 -&gt; Extension -&gt; Driver -&gt; Create driver verification log</p>
<p>显示三种依赖log都detected，Create有警告无所谓，在项目目录下有DriverName.DVL.XML文件生成</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202412271630847.png" alt="image-20241227163042814"></p>
<p>DVL示例内容如下（SDV和CA有fail，但不影响WHQL HLK）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;Data&gt;</span><br><span class="line">&lt;AssessmentScore ScoreName=&quot;bhtsdhubdr.arm64.General.XMLTimeStamp&quot; ScoreValue=&quot;0&quot; ScoreUnit=&quot;12/27/2024 15:54:26&quot;/&gt;</span><br><span class="line">&lt;AssessmentScore ScoreName=&quot;bhtsdhubdr.arm64.General.DriverBinary&quot; ScoreValue=&quot;0&quot; ScoreUnit=&quot;bhtsdhubdr.sys&quot;/&gt;</span><br><span class="line">&lt;AssessmentScore ScoreName=&quot;bhtsdhubdr.arm64.General.BinaryTimeStamp&quot; ScoreValue=&quot;0&quot; ScoreUnit=&quot;01/01/1601 08:00:00&quot;/&gt;</span><br><span class="line">&lt;AssessmentScore ScoreName=&quot;bhtsdhubdr.arm64.General.DriverType&quot; ScoreValue=&quot;0&quot; ScoreUnit=&quot;generic&quot;/&gt;</span><br><span class="line">&lt;AssessmentScore ScoreName=&quot;bhtsdhubdr.arm64.General.DriverSize&quot; ScoreValue=&quot;0&quot; ScoreUnit=&quot;LOC&quot;/&gt;</span><br><span class="line">&lt;AssessmentScore ScoreName=&quot;bhtsdhubdr.arm64.General.DriverVersion&quot; ScoreValue=&quot;0&quot; ScoreUnit=&quot;0&quot;/&gt;</span><br><span class="line">&lt;AssessmentScore ScoreName=&quot;bhtsdhubdr.arm64.General.Libs&quot; ScoreValue=&quot;0&quot; ScoreUnit=&quot;Number of external libraries used&quot;/&gt;</span><br><span class="line">&lt;AssessmentScore ScoreName=&quot;bhtsdhubdr.arm64.SDV.Version&quot; ScoreValue=&quot;0&quot; ScoreUnit=&quot;sdv-2021-03-16&quot;/&gt;</span><br><span class="line">&lt;AssessmentScore ScoreName=&quot;bhtsdhubdr.arm64.SDV.ActiveRuleTotal&quot; ScoreValue=&quot;4&quot; ScoreUnit=&quot;Total rules available&quot;/&gt;</span><br><span class="line">&lt;AssessmentScore ScoreName=&quot;bhtsdhubdr.arm64.SDV.Rule.nullcheck&quot; ScoreValue=&quot;1&quot; ScoreUnit=&quot;SDV_FAILED&quot;/&gt;</span><br><span class="line">&lt;AssessmentScore ScoreName=&quot;bhtsdhubdr.arm64.CodeAnalysis.Summary&quot; ScoreValue=&quot;2&quot; ScoreUnit=&quot;Types of defects seen&quot;/&gt;</span><br><span class="line">&lt;AssessmentScore ScoreName=&quot;bhtsdhubdr.arm64.CodeAnalysis.Defect.6385&quot; ScoreValue=&quot;1&quot; ScoreUnit=&quot;CA_FAILED&quot;/&gt;</span><br><span class="line">&lt;AssessmentScore ScoreName=&quot;bhtsdhubdr.arm64.CodeAnalysis.Defect.6001&quot; ScoreValue=&quot;1&quot; ScoreUnit=&quot;CA_MUSTFIX_FAILED&quot;/&gt;</span><br><span class="line">&lt;AssessmentScore ScoreName=&quot;bhtsdhubdr.arm64.Semmle.Summary&quot; ScoreValue=&quot;1&quot; ScoreUnit=&quot;Types of defects seen&quot;/&gt;</span><br><span class="line">&lt;AssessmentScore ScoreName=&quot;bhtsdhubdr.arm64.Semmle.Defect.cpp/comparison-with-wider-type&quot; ScoreValue=&quot;0&quot; ScoreUnit=&quot;SEMMLE_FAILED&quot;/&gt;</span><br><span class="line">&lt;AssessmentScore ScoreName=&quot;bhtsdhubdr.arm64.General.Checksum&quot; ScoreValue=&quot;4TYw1CLepWklxyssSBb7x9m/tAtAuZozCUvaOq7od2SAQZx6SRlBzEK1wIlqB34JiwSni1qyOrcXYr3C3mrXTA==&quot; ScoreUnit=&quot;DVL Checksum Value&quot;/&gt;</span><br><span class="line">&lt;/Data&gt;</span><br></pre></td></tr></table></figure>

<p>WHQL的HLK测试会用到此DVL文件。</p>
<h2 id="代码新项目相关的配置"><a href="#代码新项目相关的配置" class="headerlink" title="代码新项目相关的配置"></a>代码新项目相关的配置</h2><h3 id="VisualStudio新项目环境配置"><a href="#VisualStudio新项目环境配置" class="headerlink" title="VisualStudio新项目环境配置"></a>VisualStudio新项目环境配置</h3><h4 id="使用VSCode快捷键"><a href="#使用VSCode快捷键" class="headerlink" title="使用VSCode快捷键"></a>使用VSCode快捷键</h4><p>工具–&gt;选项-&gt;键盘-&gt;键盘映射方案选VSCode</p>
<h4 id="WDF项目找不到头文件问题"><a href="#WDF项目找不到头文件问题" class="headerlink" title="WDF项目找不到头文件问题"></a>WDF项目找不到头文件问题</h4><ol>
<li>找不到&lt;ntddk.h&gt;和&lt;wdf.h&gt;</li>
</ol>
<p>在项目配置-&gt; C&#x2F;C++ -&gt; General -&gt; Additional Include Directories -&gt; 加上WDK和WDF的include头文件路径</p>
<p>Ntddk.h contains core Windows kernel definitions for all drivers, while Wdf.h<br>contains definitions for drivers based on the Windows Driver Framework (WDF).  </p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202408121042763.png" alt="image-20240812104158672"></p>
<p>注意WDF的版本，Win11选WDF 1.33，参考：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/wdf/kmdf-version-history">https://learn.microsoft.com/zh-cn/windows-hardware/drivers/wdf/kmdf-version-history</a></p>
<ol start="2">
<li>找不到device.tmh</li>
</ol>
<p>项目设置 -&gt; WPP Tracing -&gt; 设置 “Run Wpp Tracing” 为 YES</p>
<h4 id="WDF项目找不到链接symbol"><a href="#WDF项目找不到链接symbol" class="headerlink" title="WDF项目找不到链接symbol"></a>WDF项目找不到链接symbol</h4><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/cpp/error-messages/tool-errors/linker-tools-error-lnk2019?view=msvc-170#third-party-library-issues-and-vcpkg">https://learn.microsoft.com/en-us/cpp/error-messages/tool-errors/linker-tools-error-lnk2019?view=msvc-170#third-party-library-issues-and-vcpkg</a></p>
<p>如果是调用第三方库API报此问题，基本上是项目配置没有链接这个库</p>
<p>The object file or library that contains the definition of the symbol isn’t linked</p>
<p>以SDBUS驱动为例，ntddsd.h定义的SdBusSubmitRequest只有declaration，其函数体实现其实是在SDBUS.lib里，用everything搜索此lib（WDK路径），加到项目配置的Link dependence lib（Link -&gt; Input -&gt; Additional Dependence），即可编译通过。</p>
<p>The <em>ntddsd.h</em> header file, which is provided in the Windows Driver Kit (WDK), declares the prototypes for the routines exposed by the SD bus library.</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/sd/sd-card-driver-stack">https://learn.microsoft.com/en-us/windows-hardware/drivers/sd/sd-card-driver-stack</a></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202408221950345.png" alt="image-20240822195016239"></p>
<p>另外一个示例：</p>
<p>RtlStringCbVPrintfA打印函数属于ntstrsafe.h定义，其lib同名，位于WDK的km目录；一般WDF驱动把km和kmdf的.lib都加到项目的linker路径：（Link -&gt; Input -&gt; Additional Dependence）</p>
<p>注意需要指定到.lib文件名，一般是用到哪个lib才链接哪个lib；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files (x86)\Windows Kits\10\Lib\10.0.26100.0\km\x64\ntstrsafe.lib</span><br></pre></td></tr></table></figure>

<p>也可以用*匹配所有lib：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files (x86)\Windows Kits\10\Lib\10.0.26100.0\km\x64\*.lib</span><br><span class="line">C:\Program Files (x86)\Windows Kits\10\Lib\wdf\kmdf\x64\1.33\*.lib</span><br></pre></td></tr></table></figure>

<h4 id="VS-Code配置项目包含WDF-WDM头文件"><a href="#VS-Code配置项目包含WDF-WDM头文件" class="headerlink" title="VS Code配置项目包含WDF&#x2F;WDM头文件"></a>VS Code配置项目包含WDF&#x2F;WDM头文件</h4><p>在.vscode的c_cpp_properties.json添加WDF&#x2F;WDM所在的头文件定义（即前面VisualStudio添加的Additional Include Directories），在WDK目录，用everything搜索wdf.h和wdm.h所在的目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;includePath&quot;: [</span><br><span class="line">                &quot;$&#123;workspaceFolder&#125;/**&quot;,</span><br><span class="line">                &quot;C:\\Program Files (x86)\\Windows Kits\\10\\Include\\wdf\\kmdf\\1.15&quot;,</span><br><span class="line">                &quot;C:\\Program Files (x86)\\Windows Kits\\10\\Include\\10.0.26100.0\\km&quot;,</span><br><span class="line">            ],</span><br></pre></td></tr></table></figure>

<p>注意上图windows路径需要将单斜杠全局替换成双斜杠，空格不需要加反斜杠</p>
<p>替换完毕查看是否能跳转，例如单击WdfIoQueueCreate能跳转到wdfio.h的函数体定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">_Must_inspect_result_</span><br><span class="line">_IRQL_requires_max_(DISPATCH_LEVEL)</span><br><span class="line">NTSTATUS</span><br><span class="line">FORCEINLINE</span><br><span class="line">WdfIoQueueCreate(</span><br><span class="line">    _In_</span><br><span class="line">    WDFDEVICE Device,</span><br><span class="line">    _In_</span><br><span class="line">    PWDF_IO_QUEUE_CONFIG Config,</span><br><span class="line">    _In_opt_</span><br><span class="line">    PWDF_OBJECT_ATTRIBUTES QueueAttributes,</span><br><span class="line">    _Out_opt_</span><br><span class="line">    WDFQUEUE* Queue</span><br><span class="line">    )</span><br><span class="line">&#123;</span><br><span class="line">    return ((PFN_WDFIOQUEUECREATE) WdfFunctions[WdfIoQueueCreateTableIndex])(WdfDriverGlobals, Device, Config, QueueAttributes, Queue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="代码中支持中文编码"><a href="#代码中支持中文编码" class="headerlink" title="代码中支持中文编码"></a>代码中支持中文编码</h4><p>Warning C4819 The file contains a character that cannot be represented in the current code page (936). Save the file in Unicode format to prevent data loss</p>
<p>这个警告是关于代码页(code page)编码的问题。警告 C4819 表示文件中包含无法在当前代码页(936,即GBK编码)中表示的字符。</p>
<p>解决这个问题有以下几种方法:</p>
<ol>
<li>最推荐的方法是将文件保存为 UTF-8 with BOM 格式:</li>
</ol>
<ul>
<li>在 Visual Studio 中打开文件</li>
<li>点击”文件” -&gt; “高级保存选项”</li>
<li>在编码下拉框中选择”UTF-8 with signature (Codepage 65001)”</li>
<li>点击保存</li>
</ul>
<ol start="2">
<li>如果需要保持当前编码,可以在文件开头添加编码指示:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#pragma code_page(65001)  // 使用 UTF-8 编码</span><br><span class="line">// ... 其余代码 ...</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>也可以在项目设置中修改:</li>
</ol>
<ul>
<li>右键项目 -&gt; 属性</li>
<li>C&#x2F;C++ -&gt; 命令行</li>
<li>在”其他选项”中添加 <code>/utf-8</code></li>
</ul>
<p>尝试过最有效的是方法3，但需要注意 Release和Debug的项目配置是独立的，需要配置两次&#x2F;utf-8</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/08/30/Windows%20Driver%20--%20INF%20Verifier%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/30/Windows%20Driver%20--%20INF%20Verifier%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Windows Driver -- INF Verifier使用笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-08-30 17:52:38" itemprop="dateCreated datePublished" datetime="2024-08-30T17:52:38+08:00">2024-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-18 10:34:13" itemprop="dateModified" datetime="2025-11-18T10:34:13+08:00">2025-11-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/windows%E9%A9%B1%E5%8A%A8/" itemprop="url" rel="index"><span itemprop="name">windows驱动</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Windows-Driver-–-INF-Verifier使用笔记"><a href="#Windows-Driver-–-INF-Verifier使用笔记" class="headerlink" title="Windows Driver – INF Verifier使用笔记"></a>Windows Driver – INF Verifier使用笔记</h1><p>WDK有INF verifier用于检测Driver安装包的INF信息文件的内容是否符合要求：如果INF不符合要求，可能在安装Driver报错或者Driver运行时功能报错。</p>
<h2 id="INF-verifier使用"><a href="#INF-verifier使用" class="headerlink" title="INF verifier使用"></a>INF verifier使用</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\infverif.exe /w /v C:\path\driver.inf</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/running-infverif-from-the-command-line">https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/running-infverif-from-the-command-line</a></p>
<h2 id="排错示例"><a href="#排错示例" class="headerlink" title="排错示例"></a>排错示例</h2><p>新建WDF驱动项目时产生默认的INF，但其中一些符号需要替换，否则安装driver时会直接报错安装失败</p>
<ol>
<li>DIRID 13问题</li>
</ol>
<p>driver.sys一般的路径符号 DIRID是12，较新的OS WDK要求DIRID使用13，用于实现driver package isolation：</p>
<p>参考：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/develop/porting-inf-to-windows-driver">https://learn.microsoft.com/en-us/windows-hardware/drivers/develop/porting-inf-to-windows-driver</a></p>
<p>错误信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Program Files (x86)\Windows Kits\10\Tools\10.0.26100.0\x64&gt;</span><br><span class="line">ARM64\Debug\O2SD\O2SD.inf</span><br><span class="line">ERROR(1322) in C:\Users\cursorhu\source\repos\O2SD\ARM64\Debug\O2SD\O2SD.inf, line 49: Destination file path &#x27;C:\Windows\System32\drivers&#x27; for file &#x27;O2SD.sys&#x27; is not isolated to DIRID 13.</span><br></pre></td></tr></table></figure>

<p>解决(git diff)：设置DestinationDirs &#x3D; 13，并设置SourceDisksNames的TargetOSVersion</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> [DestinationDirs]</span><br><span class="line">-DefaultDestDir = 12 ;DIRID_DRIVERS; </span><br><span class="line">+DefaultDestDir = 13 ;DIRID_DRIVERS; %13% only supported since OS build 16299</span><br><span class="line"></span><br><span class="line">[SourceDisksNames]</span><br><span class="line">...</span><br><span class="line">+%ManufacturerName% = Generic,NTarm64.10.0...26100 ; with TargetOSVersion</span><br><span class="line"></span><br><span class="line">+[Generic.NTarm64.10.0...26100]</span><br><span class="line"> ServiceType    = 1               ; SERVICE_KERNEL_DRIVER</span><br><span class="line"> StartType      = 3               ; SERVICE_DEMAND_START</span><br><span class="line"> ErrorControl   = 1               ; SERVICE_ERROR_NORMAL</span><br><span class="line">-ServiceBinary  = %12%\O2SD.sys</span><br><span class="line">+ServiceBinary  = %13%\O2SD.sys  ; DestinationDirs</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>变量未定义问题</li>
</ol>
<p>错误信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">报错1：Unresolved $ARCH$ token for section [generic.nt$arch$]. Must run stampinf tool to resolve case sensitive $ARCH$ tokens.</span><br><span class="line"></span><br><span class="line">报错2：KmdfLibraryVersion directive has invalid value &quot;$KmdfLibraryVersion&quot;</span><br></pre></td></tr></table></figure>

<p>解决(git diff)：根据平台环境指定变量值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-%ManufacturerName% = Generic,NT$ARCH$</span><br><span class="line">+%ManufacturerName% = Generic,NTarm64.10.0...26100 </span><br><span class="line"></span><br><span class="line">-[Generic.NT$ARCH$]</span><br><span class="line">+[Generic.NTarm64.10.0...26100]</span><br><span class="line"></span><br><span class="line">-KmdfLibraryVersion = $KMDFVERSION$</span><br><span class="line">+KmdfLibraryVersion = 1.33</span><br></pre></td></tr></table></figure>

<p>全部错误修复后，显示如下：INF is VALID</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.\infverif.exe /w /v C:\Users\cursorhu\source\repos\O2SD\O2SD.inf</span><br><span class="line">Running in Verbose</span><br><span class="line">Running Windows Driver INF check</span><br><span class="line"></span><br><span class="line">Validating O2SD.inf</span><br><span class="line">INF is VALID</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/08/30/Windows%20Driver%20--%20WDF%20PCIe-SD%20Host%20Controller%20Driver%20Analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/30/Windows%20Driver%20--%20WDF%20PCIe-SD%20Host%20Controller%20Driver%20Analysis/" class="post-title-link" itemprop="url">WDF PCIe-SD Host Controller Driver Analysis</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-08-30 17:52:38" itemprop="dateCreated datePublished" datetime="2024-08-30T17:52:38+08:00">2024-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-18 10:43:52" itemprop="dateModified" datetime="2025-11-18T10:43:52+08:00">2025-11-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/windows%E9%A9%B1%E5%8A%A8/" itemprop="url" rel="index"><span itemprop="name">windows驱动</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Windows-WDF-PCIe-SD-Host-Controller-Driver-Analysis"><a href="#Windows-WDF-PCIe-SD-Host-Controller-Driver-Analysis" class="headerlink" title="Windows WDF PCIe-SD Host Controller Driver Analysis"></a>Windows WDF PCIe-SD Host Controller Driver Analysis</h1><h2 id="Current-Status-Analysis"><a href="#Current-Status-Analysis" class="headerlink" title="Current Status Analysis"></a>Current Status Analysis</h2><p>Based on the dumpfile information:</p>
<h3 id="1-Driver-Stack-Structure-Correct"><a href="#1-Driver-Stack-Structure-Correct" class="headerlink" title="1. Driver Stack Structure - Correct"></a>1. Driver Stack Structure - Correct</h3><ul>
<li><p>Device stack is properly established: partmgr → disk → sdhcstor</p>
</li>
<li><p>Upper layer device (disk.sys) successfully starts and attaches to your driver</p>
</li>
<li><p>ServiceName is “disk”, DeviceInst shows correct device path</p>
</li>
</ul>
<h3 id="2-Critical-Issue-ExtensionFlags-Inconsistency"><a href="#2-Critical-Issue-ExtensionFlags-Inconsistency" class="headerlink" title="2. Critical Issue: ExtensionFlags Inconsistency"></a>2. Critical Issue: ExtensionFlags Inconsistency</h3><p>Device object ffffc701663ddc80 (Upper device):</p>
<ul>
<li><p>⚠️ ExtensionFlags &#x3D; 0x0000000000 (Highlighted in orange - THIS IS THE PROBLEM)</p>
</li>
<li><p>This device object is missing necessary extension flags</p>
</li>
</ul>
<p>Device object ffffc70162a1aa0 (Driver object):</p>
<ul>
<li><p>✓ ExtensionFlags &#x3D; 0x00000800 (DOE_DEFAULT_SD_PRESENT)</p>
</li>
<li><p>This flag indicates SD card present - this is correct</p>
</li>
</ul>
<h3 id="3-BSOD-Root-Cause-Analysis"><a href="#3-BSOD-Root-Cause-Analysis" class="headerlink" title="3. BSOD Root Cause Analysis"></a>3. BSOD Root Cause Analysis</h3><p>ExtensionFlags being 0 indicates:</p>
<ul>
<li><p>Device extension object may not be properly initialized</p>
</li>
<li><p>I&#x2F;O buffer management related extension information is missing</p>
</li>
<li><p>Likely missing proper setup during IRP_MJ_CREATE or device creation</p>
</li>
</ul>
<h2 id="Solution-Correctness-Assessment"><a href="#Solution-Correctness-Assessment" class="headerlink" title="Solution Correctness Assessment"></a>Solution Correctness Assessment</h2><h3 id="✓-Correct-Aspects"><a href="#✓-Correct-Aspects" class="headerlink" title="✓ Correct Aspects:"></a>✓ Correct Aspects:</h3><ol>
<li><p>I&#x2F;O Queue Implementation - Sequential handling of Read&#x2F;Write requests is correct</p>
</li>
<li><p>Driver Stack Architecture - Functioning as port driver below disk.sys is standard architecture</p>
</li>
<li><p>Device Attachment - Upper device successfully attaching indicates AddDevice is fundamentally correct</p>
</li>
</ol>
<h3 id="Areas-Requiring-Correction"><a href="#Areas-Requiring-Correction" class="headerlink" title="Areas Requiring Correction:"></a>Areas Requiring Correction:</h3><ol>
<li>Device Extension Object Initialization</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// Check your EvtDeviceAdd or device creation code</span><br><span class="line">// Ensure proper Device Extension setup</span><br><span class="line">WDF_OBJECT_ATTRIBUTES_INIT_CONTEXT_TYPE(&amp;attributes, DEVICE_CONTEXT);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ExtensionFlags Configuration</li>
</ol>
<ul>
<li><p>Verify proper call to WdfDeviceInitSetDeviceType()</p>
</li>
<li><p>Ensure device characteristics flags are correctly set:</p>
</li>
<li><p>FILE_AUTOGENERATED_DEVICE_NAME</p>
</li>
<li><p>FILE_DEVICE_SECURE_OPEN</p>
</li>
<li><p>FILE_PORTABLE_DEVICE</p>
</li>
</ul>
<ol start="3">
<li>I&#x2F;O Buffer Management Critical Points</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// Set correct buffer method during device initialization</span><br><span class="line">WdfDeviceInitSetIoType(DeviceInit, WdfDeviceIoDirect); // or WdfDeviceIoBuffered</span><br><span class="line"></span><br><span class="line">// Ensure proper alignment requirements are set</span><br><span class="line">WdfDeviceInitSetIoInCallerContextCallback(DeviceInit, YourPreprocessCallback);</span><br></pre></td></tr></table></figure>

<h2 id="Recommended-Debugging-Steps"><a href="#Recommended-Debugging-Steps" class="headerlink" title="Recommended Debugging Steps"></a>Recommended Debugging Steps</h2><ol>
<li>Verify Device Extension Allocation</li>
</ol>
<ul>
<li><p>Confirm DEVICE_CONTEXT structure is properly allocated and initialized</p>
</li>
<li><p>Use !wdfkd.wdfdevice command to inspect WDF device object state</p>
</li>
</ul>
<ol start="2">
<li>Add Tracing</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// Add DbgPrint or WPP tracing at critical points:</span><br><span class="line">- EvtDeviceAdd</span><br><span class="line">- EvtDevicePrepareHardware</span><br><span class="line">- I/O Queue callbacks</span><br><span class="line">- Buffer mapping/locking operations</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Validate DMA&#x2F;Buffer Operations</li>
</ol>
<ul>
<li><p>Check if DMA Enabler is properly created (if using DMA)</p>
</li>
<li><p>Verify MDL (Memory Descriptor List) handling</p>
</li>
<li><p>Ensure all buffer pointers are properly locked and mapped before use</p>
</li>
</ul>
<ol start="4">
<li>Inspect IRP Handling</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// Ensure proper handling of these IRPs during mount:</span><br><span class="line">- IRP_MJ_CREATE</span><br><span class="line">- IRP_MJ_DEVICE_CONTROL (IOCTL_MOUNTDEV_*)</span><br><span class="line">- IRP_MJ_PNP (especially IRP_MN_QUERY_CAPABILITIES)</span><br></pre></td></tr></table></figure>

<h2 id="Specific-Code-Areas-to-Review"><a href="#Specific-Code-Areas-to-Review" class="headerlink" title="Specific Code Areas to Review"></a>Specific Code Areas to Review</h2><h3 id="Device-Initialization-Priority-1"><a href="#Device-Initialization-Priority-1" class="headerlink" title="Device Initialization (Priority #1)"></a>Device Initialization (Priority #1)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS</span><br><span class="line">YourEvtDeviceAdd(</span><br><span class="line">    WDFDRIVER Driver,</span><br><span class="line">    PWDFDEVICE_INIT DeviceInit</span><br><span class="line">    )</span><br><span class="line">&#123;</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES deviceAttributes;</span><br><span class="line">    WDFDEVICE device;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    // CRITICAL: Set device type</span><br><span class="line">    WdfDeviceInitSetDeviceType(DeviceInit, FILE_DEVICE_MASS_STORAGE);</span><br><span class="line">    </span><br><span class="line">    // CRITICAL: Set I/O type</span><br><span class="line">    WdfDeviceInitSetIoType(DeviceInit, WdfDeviceIoDirect);</span><br><span class="line">    </span><br><span class="line">    // CRITICAL: Set device characteristics</span><br><span class="line">    WdfDeviceInitSetCharacteristics(DeviceInit,</span><br><span class="line">        FILE_AUTOGENERATED_DEVICE_NAME |</span><br><span class="line">        FILE_DEVICE_SECURE_OPEN |</span><br><span class="line">        FILE_PORTABLE_DEVICE,</span><br><span class="line">        FALSE);</span><br><span class="line">    </span><br><span class="line">    // Initialize device context</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES_INIT_CONTEXT_TYPE(&amp;deviceAttributes, DEVICE_CONTEXT);</span><br><span class="line">    </span><br><span class="line">    status = WdfDeviceCreate(&amp;DeviceInit, &amp;deviceAttributes, &amp;device);</span><br><span class="line">    if (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        return status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Initialize device extension here</span><br><span class="line">    PDEVICE_CONTEXT context = GetDeviceContext(device);</span><br><span class="line">    // Ensure all fields are properly initialized</span><br><span class="line">    </span><br><span class="line">    return status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Buffer-Handling-in-I-O-Queue"><a href="#Buffer-Handling-in-I-O-Queue" class="headerlink" title="Buffer Handling in I&#x2F;O Queue"></a>Buffer Handling in I&#x2F;O Queue</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">VOID</span><br><span class="line">YourEvtIoRead(</span><br><span class="line">    WDFQUEUE Queue,</span><br><span class="line">    WDFREQUEST Request,</span><br><span class="line">    size_t Length</span><br><span class="line">    )</span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDFMEMORY memory;</span><br><span class="line">    PVOID buffer;</span><br><span class="line">    </span><br><span class="line">    // CRITICAL: Proper buffer retrieval</span><br><span class="line">    status = WdfRequestRetrieveOutputMemory(Request, &amp;memory);</span><br><span class="line">    if (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        WdfRequestComplete(Request, status);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    buffer = WdfMemoryGetBuffer(memory, NULL);</span><br><span class="line">    if (buffer == NULL) &#123;</span><br><span class="line">        WdfRequestComplete(Request, STATUS_INSUFFICIENT_RESOURCES);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Ensure buffer is locked/mapped before hardware access</span><br><span class="line">    // Your DMA or PIO operation here</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Next-Steps"><a href="#Next-Steps" class="headerlink" title="Next Steps"></a>Next Steps</h2><ol>
<li><p>Immediate Action: Review Device Extension initialization code, ensure all necessary flags are set during device creation</p>
</li>
<li><p>Set Breakpoints: On all I&#x2F;O request handlers before mount operation</p>
</li>
<li><p>Verify: WdfDeviceInitSetDeviceType() and related device characteristics configuration</p>
</li>
<li><p>Analyze: Specific bugcheck code and parameters from the BSOD (if complete minidump available)</p>
</li>
</ol>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Overall Assessment: Your architecture is fundamentally correct. The issue is concentrated in device object initialization and extension flags configuration. This is a typical detail that’s easy to overlook in WDF driver development, but critical for proper I&#x2F;O buffer management.</p>
<p>The fact that:</p>
<ul>
<li><p>Device stack builds correctly</p>
</li>
<li><p>Upper device attaches successfully</p>
</li>
<li><p>Queue shows “not busy”</p>
</li>
</ul>
<p>…indicates the framework is mostly correct. The ExtensionFlags discrepancy is the smoking gun pointing to incomplete device initialization during the AddDevice routine.</p>
<p>Confidence Level: High - This is a common pattern in WDF driver issues related to mount failures and I&#x2F;O buffer management.</p>
<p>Would you like me to review your source code to provide more specific corrections?</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/08/30/Windows%20Driver%20--%20Windbg%E8%81%94%E8%B0%83%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/30/Windows%20Driver%20--%20Windbg%E8%81%94%E8%B0%83%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">Windows Driver -- Windbg联调环境配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-08-30 17:52:38" itemprop="dateCreated datePublished" datetime="2024-08-30T17:52:38+08:00">2024-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-18 10:34:16" itemprop="dateModified" datetime="2025-11-18T10:34:16+08:00">2025-11-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/windows%E9%A9%B1%E5%8A%A8/" itemprop="url" rel="index"><span itemprop="name">windows驱动</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Windows-Driver-–-Windbg联调环境配置"><a href="#Windows-Driver-–-Windbg联调环境配置" class="headerlink" title="Windows Driver – Windbg联调环境配置"></a>Windows Driver – Windbg联调环境配置</h1><p>参考：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-a-network-debugging-connection-automatically">https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-a-network-debugging-connection-automatically</a></p>
<h2 id="Target-PC配置"><a href="#Target-PC配置" class="headerlink" title="Target PC配置"></a>Target PC配置</h2><p>注意：</p>
<p>Target PC要先开测试模式，且关闭系统所有网络防火墙。</p>
<p>Target PC要能Ping通Host PC，即Host PC和Target PC可以用同一局域网的路由器(Router)或交换机(Hub)的网口相连。</p>
<p>Target PC的kdnet创建一次以后再创建也不会变。</p>
<p>Kdnet配置完成后，设备管理器的网络设备会有Kernel Debug Network设备（KDNET），且网口设备（例如下面的Intel Ethernet）会有感叹号Code53是正常的，表示此网口正作为KDNET debug端口。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\System32&gt;</span><br><span class="line">C:\Windows\System32&gt;cd c:\kdnet</span><br><span class="line"></span><br><span class="line">c:\kdnet&gt;kdnet.exe</span><br><span class="line"></span><br><span class="line">Network debugging is supported on the following NICs:</span><br><span class="line">busparams=0.31.6, Intel(R) Ethernet Connection (7) I219-V, KDNET is running on this NIC.</span><br><span class="line"></span><br><span class="line">Network debugging is supported on the following USB controllers:</span><br><span class="line">busparams=0.20.0, Intel(R) USB 3.1 eXtensible Host Controller - 1.10 (Microsoft)</span><br><span class="line"></span><br><span class="line">This Microsoft hypervisor supports using KDNET in guest VMs.</span><br><span class="line"></span><br><span class="line">c:\kdnet&gt;</span><br><span class="line">c:\kdnet&gt;kdnet.exe 10.52.4.41 50000</span><br><span class="line"></span><br><span class="line">Enabling network debugging on Intel(R) Ethernet Connection (7) I219-V.</span><br><span class="line"></span><br><span class="line">To debug this machine, run the following command on your debugger host machine.</span><br><span class="line">windbg -k net:port=50000,key=3s1m4bjm7ihi7.3b8dig9hl019g.2fyvva9v1ie3a.38mfaw4eweiuo</span><br><span class="line"></span><br><span class="line">Then reboot this machine by running shutdown -r -t 0 from this command prompt.</span><br><span class="line"></span><br><span class="line">c:\kdnet&gt;ping 10.52.4.41</span><br><span class="line"></span><br><span class="line">Pinging 10.52.4.41 with 32 bytes of data:</span><br><span class="line">Reply from 10.52.4.41: bytes=32 time=4ms TTL=128</span><br><span class="line">Reply from 10.52.4.41: bytes=32 time=1ms TTL=128</span><br><span class="line">Reply from 10.52.4.41: bytes=32 time=1ms TTL=128</span><br><span class="line">Reply from 10.52.4.41: bytes=32 time=1ms TTL=128</span><br><span class="line"></span><br><span class="line">Ping statistics for 10.52.4.41:</span><br><span class="line">    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),</span><br><span class="line">Approximate round trip times in milli-seconds:</span><br><span class="line">    Minimum = 1ms, Maximum = 4ms, Average = 1ms</span><br></pre></td></tr></table></figure>

<h2 id="Host-PC配置"><a href="#Host-PC配置" class="headerlink" title="Host PC配置"></a>Host PC配置</h2><p>Host PC也关闭系统网络防火墙。</p>
<p>用Microsoft Store安装的Windbg Preview，Attach to Kernel，填入Target PC生成的Port和Key：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">port=50000,key=3s1m4bjm7ihi7.3b8dig9hl019g.2fyvva9v1ie3a.38mfaw4eweiuo</span><br></pre></td></tr></table></figure>

<p>连接成功后显示Connected to target ….</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Using NET for debugging</span><br><span class="line">Opened WinSock 2.0</span><br><span class="line">Waiting to reconnect...</span><br><span class="line"></span><br><span class="line">Connected to target 10.52.5.0 on port 50000 on local IP 10.52.4.41.</span><br></pre></td></tr></table></figure>

<h2 id="Windbg联机观测DbgPrint"><a href="#Windbg联机观测DbgPrint" class="headerlink" title="Windbg联机观测DbgPrint"></a>Windbg联机观测DbgPrint</h2><h3 id="Windbg显示DbgPrint"><a href="#Windbg显示DbgPrint" class="headerlink" title="Windbg显示DbgPrint"></a>Windbg显示DbgPrint</h3><p>需要打开Target PC的“Enabling verbose kernel output”</p>
<p>可用方法：</p>
<p>（1）在Target PC安装DebugView( <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/debugview">Sysinternals DebugView</a>)，需要运行DebugView，选项勾选“Enable Kernel Debug”和“Enabling verbose kernel output”，才可以在DebugView和Host PC的Windbg同时观测到DbgPrint的打印。</p>
<p>（2）或者在Target PC安装DebugLogger(<a target="_blank" rel="noopener" href="https://github.com/tandasat/DebugLogger">DebugLogger</a>, open source implementation of <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/debugview">Sysinternals DebugView</a>)，安装后默认打开了“Enabling verbose kernel output”，无需运行DebugLogger就可以在Host PC的Windbg观测到DebugPrint打印。这种方式可以记录系统重启中的Kernel过程。</p>
<p>注意：以下方法只是在Target PC手动设置打开所有过滤级别，并不能在Host PC的Windbg观测到Target PC的DebugPrint打印：</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/reading-and-filtering-debugging-messages">Reading and Filtering Debugging Messages</a></p>
<h3 id="Windbg记录DbgPrint到log文件："><a href="#Windbg记录DbgPrint到log文件：" class="headerlink" title="Windbg记录DbgPrint到log文件："></a>Windbg记录DbgPrint到log文件：</h3><p>Command -&gt; Save Window to File。使用Log中的特定关键字过滤，另存为Filtered log再查看</p>
<h2 id="Windbg的联机调试方法"><a href="#Windbg的联机调试方法" class="headerlink" title="Windbg的联机调试方法"></a>Windbg的联机调试方法</h2><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/debug-universal-drivers---step-by-step-lab--echo-kernel-mode-">Debug Windows drivers step-by-step lab (echo kernel mode)</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/08/30/Windows%20Driver%20--%20%E9%80%9A%E8%BF%87IDA%E9%80%86%E5%90%91%E5%88%86%E6%9E%90.sys/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/30/Windows%20Driver%20--%20%E9%80%9A%E8%BF%87IDA%E9%80%86%E5%90%91%E5%88%86%E6%9E%90.sys/" class="post-title-link" itemprop="url">Windows Driver -- 通过IDA逆向分析.sys</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-08-30 17:52:38" itemprop="dateCreated datePublished" datetime="2024-08-30T17:52:38+08:00">2024-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-18 10:34:10" itemprop="dateModified" datetime="2025-11-18T10:34:10+08:00">2025-11-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/windows%E9%A9%B1%E5%8A%A8/" itemprop="url" rel="index"><span itemprop="name">windows驱动</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Windows-Driver-–-通过IDA逆向分析-sys"><a href="#Windows-Driver-–-通过IDA逆向分析-sys" class="headerlink" title="Windows Driver – 通过IDA逆向分析.sys"></a>Windows Driver – 通过IDA逆向分析.sys</h1><p>背景：因业务需要规划下一代PCIe SD host的Windows驱动，要支持Win11和以后的最新特性，因为现有的SD驱动是基于Storport-miniport架构，在Win11上有诸多限制严重影响业务，因此决定转型为WDF驱动。本文浅显分析Realtek的Win11 PCIe SD Card reader驱动是用什么架构，内部如何实现。</p>
<h2 id="IDA反汇编工具"><a href="#IDA反汇编工具" class="headerlink" title="IDA反汇编工具"></a>IDA反汇编工具</h2><p>IDA能将二进制文件反汇编(disassemble)成为汇编代码，还支持将汇编代码进一步显示成C代码(decompile)。</p>
<p>下载IDA free版本就够用</p>
<p><a target="_blank" rel="noopener" href="https://hex-rays.com/products/ida/support/%20download_freeware%20/">https://hex-rays.com/products/ida/support/%20download_freeware%20/</a></p>
<h2 id="IDA分析驱动-sys文件"><a href="#IDA分析驱动-sys文件" class="headerlink" title="IDA分析驱动.sys文件"></a>IDA分析驱动.sys文件</h2><h3 id="IDA常用快捷键"><a href="#IDA常用快捷键" class="headerlink" title="IDA常用快捷键"></a>IDA常用快捷键</h3><p>F5：汇编代码转C代码显示（IDA称为伪代码，因为不是纯C）</p>
<p>Shift + F12：显示所有符号的字符串。可以全览所有函数，弄清用的什么技术栈</p>
<p>x：查看函数和变量的交叉引用，即被谁调用</p>
<p>esc：返回上个页面位置</p>
<h3 id="驱动分析示例"><a href="#驱动分析示例" class="headerlink" title="驱动分析示例"></a>驱动分析示例</h3><h4 id="RtsPer-sys下载"><a href="#RtsPer-sys下载" class="headerlink" title="RtsPer.sys下载"></a>RtsPer.sys下载</h4><p><a target="_blank" rel="noopener" href="https://www.driverscloud.com/en/services/GetInformationDriver/75616-0/realtek-cardreader-win10-win11-1002262121361zip">https://www.driverscloud.com/en/services/GetInformationDriver/75616-0/realtek-cardreader-win10-win11-1002262121361zip</a></p>
<h4 id="INF分析"><a href="#INF分析" class="headerlink" title="INF分析"></a>INF分析</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[Version]</span><br><span class="line">Signature=&quot;$Windows NT$&quot;</span><br><span class="line">Class=MTD</span><br><span class="line">ClassGuid = &#123;4d36e970-e325-11ce-bfc1-08002be10318&#125;</span><br><span class="line">Provider=%RTS%</span><br><span class="line">CatalogFile = RtsPer64.cat</span><br><span class="line">DriverVer=11/14/2022,10.0.22621.21361</span><br><span class="line"></span><br><span class="line">... 以下以Rts5227CR为例</span><br><span class="line"></span><br><span class="line">[DestinationDirs]</span><br><span class="line">CopyFilesSYS = 12     ; should it be 10 to take care of 98 stuff</span><br><span class="line">CopyFilesDLL = 11     ; %SystemRoot%\system or system32 - 98 or Win2000</span><br><span class="line">CopyFilesDLL64 = 10,SysWOW64</span><br><span class="line"></span><br><span class="line">[Manufacturer]</span><br><span class="line">%VENDOR%=Vendor, NTamd64</span><br><span class="line"></span><br><span class="line">[Vendor.NTamd64]</span><br><span class="line">%Rts5227CR%=RTS5264.Inst, PCI\VEN_10EC&amp;DEV_5264&amp;CC_FF00</span><br><span class="line"></span><br><span class="line">[RTS5264.Inst.ntamd64]</span><br><span class="line">CopyFiles = CopyFilesSYS, CopyFilesDLL64</span><br><span class="line"></span><br><span class="line">[RTS5264.Inst.NTamd64.HW]</span><br><span class="line">AddReg=MsiEnable_addreg</span><br><span class="line"></span><br><span class="line">[RTS5264.Inst.ntamd64.Services]</span><br><span class="line">AddService = RTSPER, 0x00000002, RTS5264_Service_Inst</span><br><span class="line"></span><br><span class="line">[RTS5264_Service_Inst]</span><br><span class="line">DisplayName    = %Rts5227PER%</span><br><span class="line">ServiceType    = %SERVICE_KERNEL_DRIVER%</span><br><span class="line">StartType      = %SERVICE_DEMAND_START%</span><br><span class="line">ErrorControl   = %SERVICE_ERROR_IGNORE%</span><br><span class="line">ServiceBinary  = %12%\RtsPer.sys</span><br><span class="line">AddReg         = RTS5264.AddReg</span><br><span class="line"></span><br><span class="line">[RTS5264.AddReg]</span><br><span class="line">HKR,&quot;RTS5264&quot;,&quot;MSIEnable&quot;,0x10001,1</span><br><span class="line">HKR,&quot;RTS5264&quot;,&quot;FirstLoad&quot;,0x10001,1</span><br><span class="line">HKR,&quot;RTS5264&quot;,&quot;NonRemovable&quot;,0x10001,1</span><br><span class="line">HKR,&quot;RTS5264&quot;,&quot;SupportPoFx&quot;,0x10001,1</span><br><span class="line">HKR,&quot;Parameters&quot;,&quot;DmaRemappingCompatible&quot;,0x10001,1</span><br><span class="line"></span><br><span class="line">[Strings]</span><br><span class="line">;Localizable Strings needed for HBA naming in Windows UI</span><br><span class="line">;*******************************************</span><br><span class="line">;Non-Localizable strings</span><br><span class="line">RTS = &quot;Realtek Semiconductor Corp.&quot;</span><br><span class="line">VENDOR         = &quot;Realtek Semiconductor Corp.&quot;</span><br><span class="line">Rts5227CR      = &quot;Realtek PCIE CardReader&quot;</span><br><span class="line">Rts5227PER      = &quot;Realtek PCIE Card Reader - PER&quot;</span><br><span class="line">DiskDesc = &quot;Realtek PCIE Card Reader Source Disk&quot;</span><br><span class="line">DriverVersion = &quot;10.0.22621.21361&quot;</span><br><span class="line">SERVICE_ASSOCSERVICE = 0x00000002</span><br><span class="line">SERVICE_BOOT_START     = 0x0</span><br><span class="line">SERVICE_SYSTEM_START   = 0x1</span><br><span class="line">SERVICE_AUTO_START     = 0x2</span><br><span class="line">SERVICE_DEMAND_START   = 0x3</span><br><span class="line">SERVICE_DISABLED       = 0x4</span><br><span class="line">SERVICE_KERNEL_DRIVER  = 0x1</span><br><span class="line">SERVICE_ERROR_IGNORE   = 0x0</span><br><span class="line">SERVICE_ERROR_NORMAL   = 0x1</span><br><span class="line">SERVICE_ERROR_SEVERE   = 0x2</span><br><span class="line">SERVICE_ERROR_CRITICAL = 0x3</span><br><span class="line">REG_EXPAND_SZ          = 0x00020000</span><br><span class="line">REG_DWORD              = 0x00010001</span><br><span class="line">REG_MULTI_SZ           = 0x00010000</span><br><span class="line">REG_BINARY             = 0x00000001</span><br><span class="line">REG_SZ                 = 0x00000000</span><br></pre></td></tr></table></figure>

<p>设备类型是MTD：<strong>Memory Technology Driver</strong></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/install/system-defined-device-setup-classes-available-to-vendors">https://learn.microsoft.com/en-us/windows-hardware/drivers/install/system-defined-device-setup-classes-available-to-vendors</a></p>
<p>从INF可以推测：</p>
<p>（1）这是SD host设备的驱动，直连PCIe接口（没通过USB），作用是SD card的控制器。</p>
<p>（2）没有用WDF(KMDF)框架，因为KMDF的INF一般定义KmdfService字段，以上INF没有定义。</p>
<p>（3）结合Windows Driver Sample，MTD类属于SD BUS&#x2F;Device的设备驱动，但微软的SD框架不支持SD BUS只支持SD Device，因此该驱动应该是用WDM写的SD BUS驱动，不是依赖于微软的SD BUS框架。</p>
<p>INF详细WDK 文档：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/install/looking-at-an-inf-file">https://learn.microsoft.com/en-us/windows-hardware/drivers/install/looking-at-an-inf-file</a></p>
<h4 id="sys分析"><a href="#sys分析" class="headerlink" title=".sys分析"></a>.sys分析</h4><ol>
<li><p>IDA打开.sys (有pdb文件更好)，找到DriverEntry入口</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202408161541633.png" alt="image-20240816154137481"></p>
</li>
<li><p>F5显示成C伪代码，可以双击函数跳转</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202408161542515.png" alt="image-20240816154235494"></p>
</li>
<li><p>详细分析一下Driver Entry做了什么：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall sub_1400DEE88(_QWORD *a1) //DriverEntry主功能在这里实现，所有叫sub_xxx函数都是没有符号表解析不出名字的函数，看函数体即可.</span><br><span class="line">&#123;</span><br><span class="line">  __int64 CurrentThreadId; // rax</span><br><span class="line">  __int64 v3; // rax</span><br><span class="line">  __int64 v4; // rcx</span><br><span class="line">  __int64 v5; // rax</span><br><span class="line">  __int64 v7; // [rsp+30h] [rbp-148h]</span><br><span class="line">  struct _OSVERSIONINFOW VersionInformation; // [rsp+40h] [rbp-138h] BYREF</span><br><span class="line"></span><br><span class="line">  CurrentThreadId = PsGetCurrentThreadId(); //获取当前线程ID</span><br><span class="line">  sub_1400DE608( //根据函数体，这里只是个打印函数，打印当前时间和线程ID.</span><br><span class="line">    2LL,</span><br><span class="line">    &quot;%I64d (%d) %s : -&gt; DriverEntry built on %s at %s \n&quot;,</span><br><span class="line">    (MEMORY[0xFFFFF78000000008] - qword_140140278) / 0x2710uLL,</span><br><span class="line">    CurrentThreadId,</span><br><span class="line">    &quot;DriverEntry&quot;,</span><br><span class="line">    &quot;Nov 14 2022&quot;,</span><br><span class="line">    &quot;15:12:36&quot;);</span><br><span class="line">  v3 = PsGetCurrentThreadId();</span><br><span class="line">  sub_1400DE608(</span><br><span class="line">    2LL,</span><br><span class="line">    &quot;%I64d (%d) %s : -&gt; DriverEntry Driver version : %s \n&quot;,</span><br><span class="line">    (MEMORY[0xFFFFF78000000008] - qword_140140278) / 0x2710uLL,</span><br><span class="line">    v3,</span><br><span class="line">    &quot;DriverEntry&quot;,</span><br><span class="line">    &quot;10.0.22621.21361&quot;);</span><br><span class="line">  VersionInformation.dwOSVersionInfoSize = 276;</span><br><span class="line">  if ( RtlGetVersion(&amp;VersionInformation) &gt;= 0 //获取操作系统版本</span><br><span class="line">    &amp;&amp; (VersionInformation.dwMajorVersion &gt; 6</span><br><span class="line">     || VersionInformation.dwMajorVersion == 6 &amp;&amp; VersionInformation.dwMinorVersion &gt;= 2) )</span><br><span class="line">  &#123;</span><br><span class="line">    dword_140140110 = 512;</span><br><span class="line">    dword_140140114 = 0x40000000;</span><br><span class="line">  &#125;</span><br><span class="line">  qword_140140278 = MEMORY[0xFFFFF78000000008];</span><br><span class="line">  sub_1400DEC80();</span><br><span class="line">  sub_1400109EC();</span><br><span class="line">  a1[28] = sub_140003340; //sub_xxx都是函数，所以这里是注册很多回调，根据WDM开发一般是PNP回调</span><br><span class="line">  a1[29] = sub_1400057A0;</span><br><span class="line">  a1[36] = sub_1400EFA30;</span><br><span class="line">  a1[13] = sub_1400E0670;</span><br><span class="line">  v4 = a1[6];</span><br><span class="line">  a1[41] = sub_1400E5480;</span><br><span class="line">  a1[14] = sub_140003000;</span><br><span class="line">  a1[16] = sub_140002DC0;</span><br><span class="line">  a1[32] = sub_140002910;</span><br><span class="line">  a1[30] = sub_140008B40;</span><br><span class="line">  a1[37] = sub_1401071C0;</span><br><span class="line">  a1[18] = sub_140006EA0;</span><br><span class="line">  a1[17] = sub_140006EA0;</span><br><span class="line">  *(_QWORD *)(v4 + 8) = sub_1400DF0F0;</span><br><span class="line">  sub_1400011E4();</span><br><span class="line">  sub_1400E0188();</span><br><span class="line">  v5 = PsGetCurrentThreadId();</span><br><span class="line">  LODWORD(v7) = 0;</span><br><span class="line">  sub_1400DE608(</span><br><span class="line">    0x2000LL,</span><br><span class="line">    &quot;%I64d (%d) %s : &lt;- %s, ret = 0x%x\n&quot;,</span><br><span class="line">    (MEMORY[0xFFFFF78000000008] - qword_140140278) / 0x2710uLL,</span><br><span class="line">    v5,</span><br><span class="line">    &quot;DriverEntry&quot;,</span><br><span class="line">    &quot;DriverEntry&quot;,</span><br><span class="line">    v7);</span><br><span class="line">  return 0LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体看一下注册的回调函数的内容：在函数上按x找到所有引用，再F5查看C伪代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall sub_1400057A0(__int64 a1, __int64 a2)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; // rdi</span><br><span class="line">  __int64 CurrentThreadId; // rax</span><br><span class="line">  unsigned int v5; // ebx</span><br><span class="line">  __int64 v6; // rax</span><br><span class="line">  int v8; // [rsp+30h] [rbp-18h]</span><br><span class="line"></span><br><span class="line">  v2 = *(_QWORD *)(a1 + 64);</span><br><span class="line">  if ( *(_BYTE *)v2 != 1 )</span><br><span class="line">    return sub_1400058A0();</span><br><span class="line">  CurrentThreadId = PsGetCurrentThreadId();</span><br><span class="line">  sub_1400DE608(</span><br><span class="line">    0x2000,</span><br><span class="line">    &quot;%I64d (%d) %s : -&gt; %s\n&quot;,</span><br><span class="line">    (MEMORY[0xFFFFF78000000008] - qword_140140278) / 0x2710uLL,</span><br><span class="line">    CurrentThreadId,</span><br><span class="line">    &quot;rts_internalctrl&quot;,</span><br><span class="line">    &quot;rts_internalctrl&quot;);</span><br><span class="line">  ++*(_BYTE *)(a2 + 67);</span><br><span class="line">  *(_QWORD *)(a2 + 184) += 72LL;</span><br><span class="line">  </span><br><span class="line">  //注意这个IofCallDriver，用于转发IRP给设备的driver function.</span><br><span class="line">  //可以推测DriverEntry注册的那些回调函数就是注册PNP请求列表对应的处理函数</span><br><span class="line">  //这里仅转发，真正的处理逻辑还在下层函数</span><br><span class="line">  v5 = IofCallDriver(*(_QWORD *)(v2 + 16), a2);</span><br><span class="line">  v6 = PsGetCurrentThreadId();</span><br><span class="line">  v8 = v5;</span><br><span class="line">  sub_1400DE608(</span><br><span class="line">    0x2000,</span><br><span class="line">    &quot;%I64d (%d) %s : &lt;- %s, ret = 0x%x\n&quot;,</span><br><span class="line">    (MEMORY[0xFFFFF78000000008] - qword_140140278) / 0x2710uLL,</span><br><span class="line">    v6,</span><br><span class="line">    &quot;rts_internalctrl&quot;,</span><br><span class="line">    &quot;rts_internalctrl&quot;,</span><br><span class="line">    v8);</span><br><span class="line">  return v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PNP的回调函数参考：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/dispatchpnp-routines">https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/dispatchpnp-routines</a></p>
</li>
<li><p>全览.sys有哪些函数符号</p>
<p>用shift + F12打开strings页面，ctrl+F 搜索关键词，选中结果后删除搜索框去浏览上下文。</p>
<p>   以DriverEntry为例，符号字符上下文如下，符号的地址分布是连续的，不考虑跳转可视为调用顺序。</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><span class="line">.text:000000014012A550	0000000C	C	DriverEntry //入口</span><br><span class="line">.text:000000014012A560	00000033	C	%I64d (%d) %s : -&gt; DriverEntry built on %s at %s \n</span><br><span class="line">.text:000000014012A5A0	00000035	C	%I64d (%d) %s : -&gt; DriverEntry Driver version : %s \n</span><br><span class="line">.text:000000014012A5E0	0000000B	C	rts_unload</span><br><span class="line">.text:000000014012A5F0	00000031	C	%I64d (%d) %s : -&gt; Driver Unload, version : %s \n</span><br><span class="line">.text:000000014012A630	00000031	C	%I64d (%d) %s : &lt;- Driver Unload, version : %s \n</span><br><span class="line">.text:000000014012A670	0000000E	C	rts_adddevice</span><br><span class="line">.text:000000014012A6C0	00000031	C	%I64d (%d) %s : Failed to create device object \n</span><br><span class="line">.text:000000014012A700	00000031	C	%I64d (%d) %s : fdx is 0x%p, PAGE_SIZE is 0x%x \n</span><br><span class="line">.text:000000014012A740	00000035	C	%I64d (%d) %s : IoAttachDeviceToDeviceStack failed \n</span><br><span class="line"></span><br><span class="line">//操作系统判断，为了后面差异化配置</span><br><span class="line"></span><br><span class="line">.text:000000014012A780	0000001E	C	%I64d (%d) %s : OS is Win10 \n</span><br><span class="line">.text:000000014012A7A0	00000020	C	%I64d (%d) %s : OS is WinBlue \n</span><br><span class="line">.text:000000014012A7C0	0000001D	C	%I64d (%d) %s : OS is Win8 \n</span><br><span class="line">.text:000000014012A7E0	0000001D	C	%I64d (%d) %s : OS is Win7 \n</span><br><span class="line">.text:000000014012A800	00000024	C	%I64d (%d) %s : OS is Server 2008 \n</span><br><span class="line">.text:000000014012A830	0000001E	C	%I64d (%d) %s : OS is VISTA \n</span><br><span class="line">.text:000000014012A850	00000024	C	%I64d (%d) %s : OS is Server 2003 \n</span><br><span class="line">.text:000000014012A880	0000001E	C	%I64d (%d) %s : OS is WinXp \n</span><br><span class="line">.text:000000014012A8A0	0000001E	C	%I64d (%d) %s : OS is Win2k \n</span><br><span class="line">.text:000000014012A8C0	00000023	C	%I64d (%d) %s : OS is NotDefined \n</span><br><span class="line">.text:000000014012A8F0	0000001E	C	%I64d (%d) %s : OS is 64bit \n</span><br><span class="line">.text:000000014012A910	0000003A	C	%I64d (%d) %s : rts_pcie_init_bus_interface failed (%x) \n</span><br><span class="line">.text:000000014012A950	00000035	C	%I64d (%d) %s : rts_pcie_get_dev_info failed: 0x%x \n</span><br><span class="line">.text:000000014012A990	0000003B	C	%I64d (%d) %s : IoRegisterDeviceInterface failed with %x \n</span><br><span class="line">.text:000000014012A9D0	00000032	C	%I64d (%d) %s : GetMcfgEntryFromAuxKlib success \n</span><br><span class="line">.text:000000014012AA10	00000031	C	%I64d (%d) %s : GetMcfgEntryFromAuxKlib failed \n</span><br><span class="line">.text:000000014012AA50	0000002E	C	%I64d (%d) %s : GetMcfgEntryFromReg success \n</span><br><span class="line">.text:000000014012AA80	0000002D	C	%I64d (%d) %s : GetMcfgEntryFromReg failed \n</span><br><span class="line">.text:000000014012AAB0	00000027	C	%I64d (%d) %s : host_cfg_disable: %d \n</span><br><span class="line">.text:000000014012AAE0	00000034	C	%I64d (%d) %s : bMcfgEntry %d, BaseAddr is 0x%llx \n</span><br><span class="line"></span><br><span class="line">//初始化DPC，PDO; Rts自定义的PNP/POFX回调函数也初始化（估计是绑定到函数指针数组）</span><br><span class="line"></span><br><span class="line">.text:000000014012AB20	00000041	C	%I64d (%d) %s : initialize the DPC NoSSDpcWorkItemPendingEvent \n</span><br><span class="line">.text:000000014012AB70	00000039	C	%I64d (%d) %s : IoRegisterShutdownNotification success \n</span><br><span class="line">.text:000000014012ABB0	0000003B	C	%I64d (%d) %s : IoRegisterShutdownNotification fail 0x%x \n</span><br><span class="line">.text:000000014012ABF0	00000015	C	rts_create_child_pdo</span><br><span class="line">.text:000000014012AC10	0000005A	C	%I64d (%d) %s : Create Pdo %i successfully, status is 0x%x, Child-&gt;ReferenceCount is %i \n</span><br><span class="line">.text:000000014012AC70	00000035	C	%I64d (%d) %s : Create Pdo %i fail with status 0x%x\n</span><br><span class="line">.text:000000014012ACE0	00000017	C	rts_init_pofx_routines</span><br><span class="line">.text:000000014012AD00	0000002D	C	%I64d (%d) %s : pPoFxActivateComponent=0x%p\n</span><br><span class="line">.text:000000014012AD60	00000029	C	%I64d (%d) %s : pPoFxIdleComponent=0x%p\n</span><br><span class="line">.text:000000014012ADC0	0000002C	C	%I64d (%d) %s : pPoFxSetComponentWake=0x%p\n</span><br><span class="line">.text:000000014012AE20	0000002D	C	%I64d (%d) %s : pPoFxCompleteIdleState=0x%p\n</span><br><span class="line">.text:000000014012AE90	00000031	C	%I64d (%d) %s : pPoFxCompleteIdleCondition=0x%p\n</span><br><span class="line">.text:000000014012AF10	00000031	C	%I64d (%d) %s : pPoFxReportDevicePoweredOn=0x%p\n</span><br><span class="line">.text:000000014012AFA0	0000003A	C	%I64d (%d) %s : pPoFxCompleteDevicePowerNotRequired=0x%p\n</span><br><span class="line">.text:000000014012B010	0000002A	C	%I64d (%d) %s : pPoFxRegisterDevice=0x%p\n</span><br><span class="line">.text:000000014012B070	0000002C	C	%I64d (%d) %s : pPoFxUnregisterDevice=0x%p\n</span><br><span class="line">.text:000000014012B0E0	00000036	C	%I64d (%d) %s : pPoFxStartDevicePowerManagement=0x%p\n</span><br><span class="line">.text:000000014012B160	00000035	C	%I64d (%d) %s : pPoFxCompleteDirectedPowerDown=0x%p\n</span><br><span class="line"></span><br><span class="line">//从注册表拿到用户自定义的功能配置信息</span><br><span class="line"></span><br><span class="line">.text:000000014012B1B0	00000014	C	GetMcfgEntryFromReg</span><br><span class="line">.text:000000014012B220	00000028	C	%s : Get SubKey %ws, Update Key to %ws\n</span><br><span class="line">.text:000000014012B250	0000003F	C	%I64d (%d) %s : EnumOneSubValue return %d, pMcfgSdtTabke 0x%x\n</span><br><span class="line">.text:000000014012B290	00000023	C	%I64d (%d) %s : NULL == pMcfgAddr\n</span><br><span class="line">.text:000000014012B2C0	00000018	C	GetMcfgEntryFromAuxKlib</span><br><span class="line">.text:000000014012B2E0	00000030	C	%I64d (%d) %s : Enum firmware table return %#x\n</span><br><span class="line">.text:000000014012B310	00000041	C	%I64d (%d) %s : AuxKlibEnumerateSystemFirmwareTables return %#x\n</span><br><span class="line">.text:000000014012B360	00000023	C	%I64d (%d) %s : cannot find MCFG \n</span><br><span class="line">.text:000000014012B390	0000002C	C	%I64d (%d) %s : Get MCFG Table as follow: \n</span><br><span class="line">.text:000000014012B3C0	00000031	C	%I64d (%d) %s : Allocate for MCFG table failed \n</span><br><span class="line">.text:000000014012B400	0000000E	C	EnumOneSubKey</span><br><span class="line">.text:000000014012B410	00000029	C	%s : Open register key %ws failed, 0x%x\n</span><br><span class="line">.text:000000014012B440	00000010	C	EnumOneSubValue</span><br><span class="line">.text:000000014012B450	00000026	C	%I64d (%d) %s : Allocate pfi failed \n</span><br><span class="line">.text:000000014012B480	00000027	C	%I64d (%d) %s : Allocate pvfi failed \n</span><br><span class="line">.text:000000014012B4B0	00000024	C	%I64d (%d) %s : DataLength is 0x%x\n</span><br><span class="line">.text:000000014012B4E0	0000000E	C	ParseSdtTable</span><br><span class="line">.text:000000014012B4F0	0000002F	C	%I64d (%d) %s : Check physical address %#llx \n</span><br><span class="line">.text:000000014012B520	0000002D	C	%I64d (%d) %s : Check physical address %#x \n</span><br><span class="line"></span><br><span class="line">//从PCIe bridge拿到SD host设备信息，包括能力寄存器，电源ASPM等</span><br><span class="line"></span><br><span class="line">.text:000000014012B550	00000018	C	rts_get_pci_bridge_info</span><br><span class="line">.text:000000014012B570	00000048	C	%I64d (%d) %s : Single Function Device: bus = %#x, dev = %#x, func=%#x\n</span><br><span class="line">.text:000000014012B5C0	0000003C	C	%I64d (%d) %s : Find Device(%X:%X)  bus=%d dev=%d, func=%d\n</span><br><span class="line">.text:000000014012B600	00000031	C	%I64d (%d) %s : Save host configure space 0x%p \n</span><br><span class="line">.text:000000014012B640	00000033	C	%I64d (%d) %s : Cannot Find PciBridge for Device \n</span><br><span class="line">.text:000000014012B680	0000001B	C	rts_get_dev_link_ctl_field</span><br><span class="line">.text:000000014012B6A0	00000039	C	%I64d (%d) %s : Get PCI_COMMON_CONFIG fail, ulResult=%d\n</span><br><span class="line">.text:000000014012B6E0	00000033	C	%I64d (%d) %s : Get linkCtrlReg fail, ulResult=%d\n</span><br><span class="line">.text:000000014012B720	00000022	C	%I64d (%d) %s : linkCtrlReg 0x%x\n</span><br><span class="line">.text:000000014012B750	00000022	C	rts_get_bridge_link_control_field</span><br><span class="line">.text:000000014012B780	0000002E	C	%I64d (%d) %s : fail to find PCIe Capability\n</span><br><span class="line">.text:000000014012B7B0	0000003B	C	%I64d (%d) %s : CapabilityOffset - Config from MMCFG 0x%x\n</span><br><span class="line">.text:000000014012B7F0	00000038	C	%I64d (%d) %s : CapabilityOffset - Config from IO 0x%x\n</span><br><span class="line">.text:000000014012B830	00000038	C	%I64d (%d) %s : CapabilityHdr - Config from MMCFG 0x%x\n</span><br><span class="line">.text:000000014012B870	00000035	C	%I64d (%d) %s : CapabilityHdr - Config from IO 0x%x\n</span><br><span class="line">.text:000000014012B8B0	00000036	C	%I64d (%d) %s : LinkCtrlReg - Config from MMCFG 0x%x\n</span><br><span class="line">.text:000000014012B8F0	00000033	C	%I64d (%d) %s : LinkCtrlReg - Config from IO 0x%x\n</span><br><span class="line">.text:000000014012B930	00000048	C	%I64d (%d) %s : pciBridgePCIeHdrOffset 0x%x, pciBridgeLinkCtrlReg 0x%x\n</span><br><span class="line">.text:000000014012B980	0000002D	C	%I64d (%d) %s : Cannot Find PCIe Capability\n</span><br><span class="line">.text:000000014012B9B0	00000038	C	%I64d (%d) %s : cannot find the Bus of PCI,do nothing \n</span><br><span class="line">.text:000000014012B9F0	00000023	C	%I64d (%d) %s : MapPhyMem failed \n</span><br><span class="line">.text:000000014012BA20	0000005F	C	%I64d (%d) %s : PciBridge BusNumber[%x], DevNumbe[%x], FuncNumber[%x], Write reg[0x%x] = 0x%x\n</span><br><span class="line">.text:000000014012BA80	00000016	C	rts_disable_host_aspm</span><br><span class="line">.text:000000014012BAA0	0000004A	C	%I64d (%d) %s : recognize the Bus of PCI(Bridge) as UNKNOWN, do nothing \n</span><br><span class="line">.text:000000014012BAF0	0000001F	C	%I64d (%d) %s : PhyAddr 0x%x \n</span><br><span class="line">.text:000000014012BB10	0000002A	C	%I64d (%d) %s : Offset 0x%x, Value 0x%x \n</span><br><span class="line">.text:000000014012BB40	00000012	C	rts_set_host_aspm</span><br><span class="line">.text:000000014012BB60	0000002A	C	%I64d (%d) %s : Offset 0x%x, value 0x%x \n</span><br><span class="line">.text:000000014012BB90	00000012	C	rts_get_host_aspm</span><br><span class="line">.text:000000014012BBB0	0000001D	C	rts_pci_find_host_capability</span><br><span class="line">.text:000000014012BBD0	00000019	C	cr_read_host_config_byte</span><br><span class="line">.text:000000014012BBF0	0000001A	C	cr_write_host_config_byte</span><br><span class="line">.text:000000014012BC10	0000002F	C	%I64d (%d) %s : Write configure through MMIO \n</span><br><span class="line">.text:000000014012BC40	00000007	C	UNKNOW</span><br><span class="line"></span><br><span class="line">//以下是PNP的回调函数的注册（函数指针绑定），具体函数体实现在rts_pnp_fdo</span><br><span class="line"></span><br><span class="line">.text:000000014012BC70	00000011	C	DispatchPnP_Fdo </span><br><span class="line">.text:000000014012BC90	0000000C	C	rts_pnp_fdo</span><br><span class="line">.text:000000014012BCA0	0000001E	C	%I64d (%d) %s : -&gt; %s %s %s \n</span><br><span class="line">.text:000000014012BCC0	00000032	C	%I64d (%d) %s : rts_pnp_fdo: fdx DeviceState %i \n</span><br><span class="line">.text:000000014012BD00	00000052	C	%I64d (%d) %s : IRP_MN_REMOVE_DEVICE, NotStarted == fdx-&gt;DeviceState, do nothing\n</span><br><span class="line">.text:000000014012BD60	0000002D	C	%I64d (%d) %s : Removed == fdx-&gt;DeviceState\n</span><br><span class="line">.text:000000014012BD90	00000028	C	%I64d (%d) %s : call rts_ss_cancel_ss \n</span><br><span class="line">.text:000000014012BDD0	0000004F	C	%I64d (%d) %s : MSI not enable,IRP_MN_FILTER_RESOURCE_REQUIREMENTS to default\n</span><br><span class="line">.text:000000014012BE20	00000035	C	%I64d (%d) %s : Unprocessed pnp,to default process \n</span><br><span class="line">.text:000000014012BE60	00000011	C	DispatchPnP_Pdo </span><br><span class="line">.text:000000014012BE80	0000000C	C	rts_pnp_pdo</span><br><span class="line">.text:000000014012BE90	00000061	C	%I64d (%d) %s : NULL == Fdo, not IRP_MN_REMOVE_DEVICE,so return fail with STATUS_DELETE_PENDING\n</span><br><span class="line">.text:000000014012BF00	00000037	C	%I64d (%d) %s : Removed == fdx-&gt;DeviceState, so quit \n</span><br><span class="line">.text:000000014012BF40	00000027	C	%I64d (%d) %s : NULL == fdx, so quit \n</span><br><span class="line">.text:000000014012BF70	0000001F	C	%I64d (%d) %s : BusRelations \n</span><br><span class="line">.text:000000014012BF90	00000024	C	%I64d (%d) %s : EjectionRelations \n</span><br><span class="line">.text:000000014012BFC0	00000021	C	%I64d (%d) %s : PowerRelations \n</span><br><span class="line">.text:000000014012BFF0	00000023	C	%I64d (%d) %s : RemovalRelations \n</span><br><span class="line">.text:000000014012C020	00000027	C	%I64d (%d) %s : TargetDeviceRelation \n</span><br><span class="line">.text:000000014012C050	00000097	C	%I64d (%d) %s : deviceCapabilities-&gt;Removable is %i,deviceCapabilities-&gt;SurpriseRemovalOK is %i,deviceCapabilities-&gt;UniqueID is %i, ntStatus is 0x%x \n</span><br><span class="line">.text:000000014012C0F0	00000017	C	rts_tr_pcie_option_set</span><br><span class="line">.text:000000014012C110	00000024	C	%I64d (%d) %s : sd_capability=%#x \n</span><br><span class="line">.text:000000014012C140	00000023	C	%I64d (%d) %s : card_spt_map=%#x \n</span><br><span class="line">.text:000000014012C170	0000002D	C	%I64d (%d) %s : cr-&gt;option.dev_flags = %#x \n</span><br><span class="line">.text:000000014012C1A0	0000002F	C	%I64d (%d) %s : cr-&gt;option.patch_flags = %#x \n</span><br><span class="line"></span><br><span class="line">//以下是设备资源分配（xxx_alloc）和硬件寄存器值初始化（bios_setting/init_hw），由于是PCIe的SD host设备，主要分配SD host设备空间到PCIe bar地址</span><br><span class="line"></span><br><span class="line">.text:000000014012C1D0	00000045	C	%I64d (%d) %s : DriverFirstLoad, set delink_delay_max_cnt to %d ms \n</span><br><span class="line">.text:000000014012C220	00000026	C	%I64d (%d) %s : Clar firstload flag \n</span><br><span class="line">.text:000000014012C250	00000036	C	%I64d (%d) %s : fdx-&gt;cr-&gt;option.remote_wakeup_en=%#x\n</span><br><span class="line">.text:000000014012C290	00000038	C	%I64d (%d) %s : fdx-&gt;CurrentPara-&gt;remote_wakeup_en=%#x\n</span><br><span class="line">.text:000000014012C2D0	00000036	C	%I64d (%d) %s : fdx-&gt;cr-&gt;option.host_cfg_disable=%#x\n</span><br><span class="line">.text:000000014012C310	00000020	C	rts_tr_pcie_backup_bios_setting</span><br><span class="line">.text:000000014012C330	00000015	C	rts_cr_bind_together</span><br><span class="line">.text:000000014012C350	0000002F	C	%I64d (%d) %s : cr=%p, cm =%p, tr=%p, scsi=%p\n</span><br><span class="line">.text:000000014012C380	00000033	C	%I64d (%d) %s : cr-&gt;cm=%p, cr-&gt;tr=%p, cr-&gt;scsi=%p\n</span><br><span class="line">.text:000000014012C3C0	00000033	C	%I64d (%d) %s : cm-&gt;cr=%p, cm-&gt;tr=%p, scsi-&gt;cr=%p\n</span><br><span class="line">.text:000000014012C400	0000000B	C	scsi_alloc</span><br><span class="line">.text:000000014012C410	0000002E	C	%I64d (%d) %s : Unable to allocate the scsi \n</span><br><span class="line">.text:000000014012C440	0000000D	C	scsi_release</span><br><span class="line">.text:000000014012C450	0000001B	C	rts_option_set_bef_init_hw</span><br><span class="line">.text:000000014012C470	00000059	C	%I64d (%d) %s : read config addr 0x0E to judge multi function fail, bytesread(%i) != 1 \n</span><br><span class="line">.text:000000014012C4D0	00000036	C	%I64d (%d) %s : read config addr 0x0E success(0x%x) \n</span><br><span class="line">.text:000000014012C510	00000006	C	multi</span><br><span class="line">.text:000000014012C520	00000007	C	single</span><br><span class="line">.text:000000014012C530	00000029	C	%I64d (%d) %s : Device is %s-functioned\n</span><br><span class="line">.text:000000014012C560	0000002F	C	%I64d (%d) %s : fdx-&gt;cr-&gt;option.adma_mode %d \n</span><br><span class="line">.text:000000014012C590	0000001D	C	rts_option_set_after_init_hw</span><br><span class="line">.text:000000014012C5B0	0000002C	C	%I64d (%d) %s : option.cq_rand_enable = %d\n</span><br><span class="line">.text:000000014012C5E0	0000002B	C	%I64d (%d) %s : option.cq_seq_enable = %d\n</span><br><span class="line">.text:000000014012C610	00000030	C	%I64d (%d) %s : option.cq_ban_card_enable = %d\n</span><br><span class="line">.text:000000014012C640	00000020	C	Realtek PCIE Card Reader Driver</span><br><span class="line">.text:000000014012C660	00000011	C	rts_cr_init_comm</span><br><span class="line">.text:000000014012C680	0000001E	C	%I64d (%d) %s : %s detected \n</span><br><span class="line">.text:000000014012C6A0	00000023	C	%I64d (%d) %s : option-&gt;ss_en %d \n</span><br><span class="line">.text:000000014012C6D0	00000013	C	rts_cr_uninit_comm</span><br><span class="line"></span><br><span class="line">//以下是电源管理POFX的回调函数的注册（函数指针绑定），具体实现在rts_pofx/dfx</span><br><span class="line"></span><br><span class="line">.text:000000014012C6F0	00000018	C	ActiveConditionCallback</span><br><span class="line">.text:000000014012C710	0000003A	C	%I64d (%d) %s : ===&gt;&lt;=== -&gt; PoFx ActiveConditionCallback\n</span><br><span class="line">.text:000000014012C750	0000003A	C	%I64d (%d) %s : ===&gt;&lt;=== &lt;- PoFx ActiveConditionCallback\n</span><br><span class="line"></span><br><span class="line">.text:000000014012C790	00000016	C	IdleConditionCallback</span><br><span class="line">.text:000000014012C7B0	00000038	C	%I64d (%d) %s : ===&gt;&lt;=== -&gt; PoFx IdleConditionCallback\n</span><br><span class="line">.text:000000014012C7F0	00000038	C	%I64d (%d) %s : ===&gt;&lt;=== &lt;- PoFx IdleConditionCallback\n</span><br><span class="line">.text:000000014012C830	00000012	C	IdleStateCallback</span><br><span class="line">.text:000000014012C850	0000003E	C	%I64d (%d) %s : ===&gt;&lt;=== -&gt; PoFx IdleStateCallback, State=%d\n</span><br><span class="line">.text:000000014012C890	00000034	C	%I64d (%d) %s : ===&gt;&lt;=== &lt;- PoFx IdleStateCallback\n</span><br><span class="line"></span><br><span class="line">.text:000000014012C8D0	0000001C	C	DevicePowerRequiredCallback</span><br><span class="line">.text:000000014012C8F0	00000037	C	%I64d (%d) %s : ===&gt; PoFx DevicePowerRequiredCallback\n</span><br><span class="line">.text:000000014012C930	00000041	C	%I64d (%d) %s : PoFx DeviePowerRequiredCallback:queue work item\n</span><br><span class="line">.text:000000014012C980	00000053	C	%I64d (%d) %s : PoFx DeviePowerRequiredCallback:Cannot alloc memory for work item\n</span><br><span class="line">.text:000000014012C9E0	0000002A	C	%I64d (%d) %s :  fdx-&gt;PoFxActive = TRUE \n</span><br><span class="line">.text:000000014012CA10	0000003E	C	%I64d (%d) %s : ===&gt;&lt;=== &lt;- PoFx DevicePowerRequiredCallback\n</span><br><span class="line"></span><br><span class="line">.text:000000014012CA50	0000001F	C	DevicePowerNotRequiredCallback</span><br><span class="line">.text:000000014012CA70	0000003A	C	%I64d (%d) %s : ===&gt; PoFx DevicePowerNotRequiredCallback\n</span><br><span class="line">.text:000000014012CAB0	00000043	C	%I64d (%d) %s : ===&gt;&lt;=== PoFx pPoFxCompleteDevicePowerNotRequired\n</span><br><span class="line">.text:000000014012CB00	0000002B	C	%I64d (%d) %s :  fdx-&gt;PoFxActive = FALSE \n</span><br><span class="line">.text:000000014012CB30	0000003A	C	%I64d (%d) %s : &lt;=== PoFx DevicePowerNotRequiredCallback\n</span><br><span class="line"></span><br><span class="line">//以下是电源管理POFX的回调函数体实现，rts_xxx_pofx</span><br><span class="line"></span><br><span class="line">.text:000000014012CB70	00000025	C	rts_dev_pwr_completion_for_DFx_child</span><br><span class="line">.text:000000014012CBA0	0000004A	C	%I64d (%d) %s : powerContext-&gt;DeviceObject is 0x%p, DeviceObject is 0x%p\n</span><br><span class="line">.text:000000014012CBF0	00000027	C	%I64d (%d) %s : IoStatus-&gt;Status=%#x \n</span><br><span class="line"></span><br><span class="line">.text:000000014012CC20	0000001F	C	rts_dev_pwr_completion_for_DFx</span><br><span class="line">.text:000000014012CC40	00000079	C	%I64d (%d) %s : powerContext-&gt;DeviceObject is 0x%p, DeviceObject is 0x%p,deviceExtension-&gt;PhysicalDeviceObject is 0x%p \n</span><br><span class="line">.text:000000014012CCC0	00000030	C	%I64d (%d) %s : For power up, queue work item \n</span><br><span class="line">.text:000000014012CCF0	00000041	C	%I64d (%d) %s : For power up, cannot alloc memory for work item\n</span><br><span class="line">.text:000000014012CD40	00000038	C	%I64d (%d) %s : ===&gt;&lt;=== PoFxCompleteDirectedPowerDown\n</span><br><span class="line">.text:000000014012CD80	0000002D	C	%I64d (%d) %s : Set Power Failed, resume IO\n</span><br><span class="line"></span><br><span class="line">.text:000000014012CDB0	00000018	C	DirectedPowerUpCallback</span><br><span class="line">.text:000000014012CDD0	0000003A	C	%I64d (%d) %s : ===&gt;&lt;=== -&gt; PoFx DirectedPowerUpCallback\n</span><br><span class="line">.text:000000014012CE10	0000003A	C	%I64d (%d) %s : Failed to alloc memory for powerContext \n</span><br><span class="line">.text:000000014012CE50	0000003E	C	%I64d (%d) %s : DirectedPowerUpCallback SetPower to D0 fail \n</span><br><span class="line"></span><br><span class="line">.text:000000014012CE90	0000001A	C	DirectedPowerDownCallback</span><br><span class="line">.text:000000014012CEB0	0000003C	C	%I64d (%d) %s : ===&gt;&lt;=== -&gt; PoFx DirectedPowerDownCallback\n</span><br><span class="line">.text:000000014012CEF0	0000002E	C	%I64d (%d) %s : Set enter_rtd3 to 1 for DFx \n</span><br><span class="line">.text:000000014012CF20	00000040	C	%I64d (%d) %s : DirectedPowerDownCallback SetPower to D3 fail \n</span><br><span class="line"></span><br><span class="line">.text:000000014012CF60	00000012	C	rts_register_pofx</span><br><span class="line">.text:000000014012CF80	00000035	C	%I64d (%d) %s : supportPoFx=0, do not register PoFx\n</span><br><span class="line">.text:000000014012CFC0	00000033	C	%I64d (%d) %s : ===&gt;&lt;=== PoFx already registered!\n</span><br><span class="line">.text:000000014012D000	00000042	C	%I64d (%d) %s : ===&gt;&lt;=== Invalid PoFx routines, pls check again!\n</span><br><span class="line">.text:000000014012D050	00000037	C	%I64d (%d) %s : ===&gt;&lt;=== OS Ver: size %d, %d.%d.%d.%d\n</span><br><span class="line">.text:000000014012D090	00000033	C	%I64d (%d) %s : ===&gt;&lt;=== Register PO_FX_DEVICE_V3\n</span><br><span class="line">.text:000000014012D0D0	00000033	C	%I64d (%d) %s : ===&gt;&lt;=== Register PO_FX_DEVICE_V2\n</span><br><span class="line">.text:000000014012D110	00000038	C	%I64d (%d) %s : ===&gt;&lt;=== PoFxRegisterDevice return %#x\n</span><br><span class="line"></span><br><span class="line">.text:000000014012D150	00000014	C	rts_unregister_pofx</span><br><span class="line">.text:000000014012D170	0000002F	C	%I64d (%d) %s : ===&gt;&lt;=== PoFxUnregisterDevice\n</span><br><span class="line">.text:000000014012D1A0	00000020	C	rts_pnp_fdo_start_dev_delaywork</span><br><span class="line">.text:000000014012D1C0	0000002E	C	%I64d (%d) %s : rts_create_childen_pdos fail\n</span><br><span class="line">.text:000000014012D1F0	00000039	C	%I64d (%d) %s : Start after stop,so no need create pdos\n</span><br><span class="line">.text:000000014012D230	00000039	C	%I64d (%d) %s : IoSetDeviceInterfaceState:enable:failed\n</span><br><span class="line">.text:000000014012D270	00000039	C	%I64d (%d) %s : ===&gt;&lt;=== PoFxStartDevicePowerManagement\n</span><br><span class="line"></span><br><span class="line">//以下是PNP回调的函数体实现，rts_pnp_fdo_xxx</span><br><span class="line"></span><br><span class="line">//对应PNP: IRP_MN_START_DEVICE</span><br><span class="line">.text:000000014012D3E0	00000016	C	rts_pnp_fdo_start_dev</span><br><span class="line">.text:000000014012D400	0000001C	C	rts_pnp_fdo_cancel_stop_dev</span><br><span class="line">.text:000000014012D420	0000002F	C	%I64d (%d) %s : Cancel stop after query stop \n</span><br><span class="line">.text:000000014012D450	00000073	C	%I64d (%d) %s : spurious cancel-stop without query stop first,we still pass it down,Irp-&gt;IoStatus.Status is 0x%x \n</span><br><span class="line"></span><br><span class="line">//对应PNP: IRP_MN_WAIT_WAKE?</span><br><span class="line">.text:000000014012D4D0	00000019	C	rts_pnp_wait_d0_complete</span><br><span class="line">.text:000000014012D4F0	0000003F	C	%I64d (%d) %s : 0 == fdx-&gt;CancelSSIsCalling, return directly \n</span><br><span class="line">.text:000000014012D530	00000037	C	%I64d (%d) %s : Wait cancel ss finished for the %ith \n</span><br><span class="line"></span><br><span class="line">//对应PNP: IRP_MN_STOP_DEVICE</span><br><span class="line">.text:000000014012D570	00000015	C	rts_pnp_fdo_stop_dev</span><br><span class="line">.text:000000014012D590	00000044	C	%I64d (%d) %s : KeWaitForSingleObject NoSSDpcWorkItemPendingEvent \n</span><br><span class="line">.text:000000014012D5E0	0000003B	C	%I64d (%d) %s : IoSetDeviceInterfaceState::disable:failed\n</span><br><span class="line"></span><br><span class="line">.... //略</span><br></pre></td></tr></table></figure>

<p>Import页面查看导入的符号，都是WDM （NTOS kernel）的符号链接：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">Address	Ordinal	Name	Library</span><br><span class="line">			</span><br><span class="line">cng			</span><br><span class="line">0000000140138010		BCryptSetProperty	cng</span><br><span class="line">0000000140138018		BCryptCloseAlgorithmProvider	cng</span><br><span class="line">0000000140138020		BCryptGenerateSymmetricKey	cng</span><br><span class="line">0000000140138028		BCryptGenerateKeyPair	cng</span><br><span class="line">0000000140138030		BCryptEncrypt	cng</span><br><span class="line">0000000140138038		BCryptExportKey	cng</span><br><span class="line">0000000140138040		BCryptGetProperty	cng</span><br><span class="line">0000000140138048		BCryptFinalizeKeyPair	cng</span><br><span class="line">0000000140138050		BCryptDestroyKey	cng</span><br><span class="line">0000000140138058		BCryptDestroySecret	cng</span><br><span class="line">0000000140138060		BCryptSecretAgreement	cng</span><br><span class="line">0000000140138068		BCryptDeriveKey	cng</span><br><span class="line">0000000140138070		BCryptGenRandom	cng</span><br><span class="line">0000000140138078		BCryptImportKeyPair	cng</span><br><span class="line">0000000140138080		BCryptOpenAlgorithmProvider	cng</span><br><span class="line"></span><br><span class="line">ntoskrnl			</span><br><span class="line">0000000140138090		KeReadStateEvent	ntoskrnl</span><br><span class="line">0000000140138098		KeReleaseSemaphore	ntoskrnl</span><br><span class="line">00000001401380A0		KeWaitForMultipleObjects	ntoskrnl</span><br><span class="line">00000001401380A8		KeWaitForSingleObject	ntoskrnl</span><br><span class="line">00000001401380B0		ExAllocatePoolWithTag	ntoskrnl</span><br><span class="line">00000001401380B8		ExRaiseStatus	ntoskrnl</span><br><span class="line">00000001401380C0		ProbeForWrite	ntoskrnl</span><br><span class="line">00000001401380C8		MmProbeAndLockPages	ntoskrnl</span><br><span class="line">00000001401380D0		MmMapLockedPagesSpecifyCache	ntoskrnl</span><br><span class="line">00000001401380D8		IoAllocateMdl	ntoskrnl</span><br><span class="line">00000001401380E0		IofCallDriver	ntoskrnl</span><br><span class="line">00000001401380E8		IofCompleteRequest	ntoskrnl</span><br><span class="line">00000001401380F0		IoFreeMdl	ntoskrnl</span><br><span class="line">00000001401380F8		IoIs32bitProcess	ntoskrnl</span><br><span class="line">0000000140138100		IoCsqInsertIrp	ntoskrnl</span><br><span class="line">0000000140138108		IoCsqRemoveNextIrp	ntoskrnl</span><br><span class="line">0000000140138110		__C_specific_handler	ntoskrnl</span><br><span class="line">0000000140138118		wcscat_s	ntoskrnl</span><br><span class="line">0000000140138120		wcscpy_s	ntoskrnl</span><br><span class="line">0000000140138128		wcsncpy_s	ntoskrnl</span><br><span class="line">0000000140138130		RtlInitAnsiString	ntoskrnl</span><br><span class="line">0000000140138138		RtlInitUnicodeString	ntoskrnl</span><br><span class="line">0000000140138140		RtlQueryRegistryValues	ntoskrnl</span><br><span class="line">0000000140138148		MmGetSystemRoutineAddress	ntoskrnl</span><br><span class="line">0000000140138150		RtlAnsiStringToUnicodeString	ntoskrnl</span><br><span class="line">0000000140138158		RtlFreeUnicodeString	ntoskrnl</span><br><span class="line">0000000140138160		RtlCompareMemory	ntoskrnl</span><br><span class="line">0000000140138168		KeInsertQueueDpc	ntoskrnl</span><br><span class="line">0000000140138170		KeSetEvent	ntoskrnl</span><br><span class="line">0000000140138178		KeDelayExecutionThread	ntoskrnl</span><br><span class="line">0000000140138180		KeAcquireSpinLockRaiseToDpc	ntoskrnl</span><br><span class="line">0000000140138188		KeReleaseSpinLock	ntoskrnl</span><br><span class="line">0000000140138190		ExFreePoolWithTag	ntoskrnl</span><br><span class="line">0000000140138198		MmBuildMdlForNonPagedPool	ntoskrnl</span><br><span class="line">00000001401381A0		IoDeleteDevice	ntoskrnl</span><br><span class="line">00000001401381A8		IoAllocateWorkItem	ntoskrnl</span><br><span class="line">00000001401381B0		IoFreeWorkItem	ntoskrnl</span><br><span class="line">00000001401381B8		IoQueueWorkItem	ntoskrnl</span><br><span class="line">00000001401381C0		IoInvalidateDeviceRelations	ntoskrnl</span><br><span class="line">00000001401381C8		IoOpenDeviceRegistryKey	ntoskrnl</span><br><span class="line">00000001401381D0		ObReferenceObjectByHandle	ntoskrnl</span><br><span class="line">00000001401381D8		ObfDereferenceObject	ntoskrnl</span><br><span class="line">00000001401381E0		ZwCreateFile	ntoskrnl</span><br><span class="line">00000001401381E8		ZwClose	ntoskrnl</span><br><span class="line">00000001401381F0		ZwCreateKey	ntoskrnl</span><br><span class="line">00000001401381F8		ZwOpenKey	ntoskrnl</span><br><span class="line">0000000140138200		ZwDeleteKey	ntoskrnl</span><br><span class="line">0000000140138208		ZwEnumerateKey	ntoskrnl</span><br><span class="line">0000000140138210		ZwFlushKey	ntoskrnl</span><br><span class="line">0000000140138218		ZwQueryKey	ntoskrnl</span><br><span class="line">0000000140138220		ZwQueryValueKey	ntoskrnl</span><br><span class="line">0000000140138228		ZwSetValueKey	ntoskrnl</span><br><span class="line">0000000140138230		ZwPowerInformation	ntoskrnl</span><br><span class="line">0000000140138238		ObQueryNameString	ntoskrnl</span><br><span class="line">0000000140138240		swprintf_s	ntoskrnl</span><br><span class="line">0000000140138248		strncpy_s	ntoskrnl</span><br><span class="line">0000000140138250		DbgPrint	ntoskrnl</span><br><span class="line">0000000140138258		PsGetCurrentThreadId	ntoskrnl</span><br><span class="line">0000000140138260		KfRaiseIrql	ntoskrnl</span><br><span class="line">0000000140138268		IoBuildPartialMdl	ntoskrnl</span><br><span class="line">0000000140138270		RtlGetVersion	ntoskrnl</span><br><span class="line">0000000140138278		RtlIsNtDdiVersionAvailable	ntoskrnl</span><br><span class="line">0000000140138280		KeInitializeDpc	ntoskrnl</span><br><span class="line">0000000140138288		KeInitializeEvent	ntoskrnl</span><br><span class="line">0000000140138290		KeInitializeSemaphore	ntoskrnl</span><br><span class="line">0000000140138298		KeInitializeTimerEx	ntoskrnl</span><br><span class="line">00000001401382A0		IoAttachDeviceToDeviceStack	ntoskrnl</span><br><span class="line">00000001401382A8		IoDetachDevice	ntoskrnl</span><br><span class="line">00000001401382B0		IoRegisterShutdownNotification	ntoskrnl</span><br><span class="line">00000001401382B8		IoCsqInitialize	ntoskrnl</span><br><span class="line">00000001401382C0		IoRegisterDeviceInterface	ntoskrnl</span><br><span class="line">00000001401382C8		ExFreePool	ntoskrnl</span><br><span class="line">00000001401382D0		MmMapIoSpace	ntoskrnl</span><br><span class="line">00000001401382D8		MmUnmapIoSpace	ntoskrnl</span><br><span class="line">00000001401382E0		ZwEnumerateValueKey	ntoskrnl</span><br><span class="line">00000001401382E8		KeCancelTimer	ntoskrnl</span><br><span class="line">00000001401382F0		IoBuildDeviceIoControlRequest	ntoskrnl</span><br><span class="line">00000001401382F8		IoDisconnectInterrupt	ntoskrnl</span><br><span class="line">0000000140138300		IoGetAttachedDeviceReference	ntoskrnl</span><br><span class="line">0000000140138308		IoUnregisterShutdownNotification	ntoskrnl</span><br><span class="line">0000000140138310		IoSetDeviceInterfaceState	ntoskrnl</span><br><span class="line">0000000140138318		PoRequestPowerIrp	ntoskrnl</span><br><span class="line">0000000140138320		PoSetPowerState	ntoskrnl</span><br><span class="line">0000000140138328		ObfReferenceObject	ntoskrnl</span><br><span class="line">0000000140138330		ExUuidCreate	ntoskrnl</span><br><span class="line">0000000140138338		KeSetTimerEx	ntoskrnl</span><br><span class="line">0000000140138340		IoCancelIrp	ntoskrnl</span><br><span class="line">0000000140138348		PoCallDriver	ntoskrnl</span><br><span class="line">0000000140138350		PoStartNextPowerIrp	ntoskrnl</span><br><span class="line">0000000140138358		PsCreateSystemThread	ntoskrnl</span><br><span class="line">0000000140138360		PsTerminateSystemThread	ntoskrnl</span><br><span class="line">0000000140138368		KeAcquireSpinLockAtDpcLevel	ntoskrnl</span><br><span class="line">0000000140138370		KeReleaseSpinLockFromDpcLevel	ntoskrnl</span><br><span class="line">0000000140138378		MmUnlockPages	ntoskrnl</span><br><span class="line">0000000140138380		MmAllocateContiguousMemory	ntoskrnl</span><br><span class="line">0000000140138388		MmFreeContiguousMemory	ntoskrnl</span><br><span class="line">0000000140138390		IoAllocateIrp	ntoskrnl</span><br><span class="line">0000000140138398		IoBuildSynchronousFsdRequest	ntoskrnl</span><br><span class="line">00000001401383A0		IoConnectInterrupt	ntoskrnl</span><br><span class="line">00000001401383A8		IoFreeIrp	ntoskrnl</span><br><span class="line">00000001401383B0		IoGetDmaAdapter	ntoskrnl</span><br><span class="line">00000001401383B8		IoGetDeviceProperty	ntoskrnl</span><br><span class="line">00000001401383C0		MmGetPhysicalAddress	ntoskrnl</span><br><span class="line">00000001401383C8		RtlUnicodeToMultiByteN	ntoskrnl</span><br><span class="line">00000001401383D0		KeClearEvent	ntoskrnl</span><br><span class="line">00000001401383D8		KeQueryActiveProcessors	ntoskrnl</span><br><span class="line">00000001401383E0		KeBugCheckEx	ntoskrnl</span><br><span class="line">00000001401383E8		ZwSetSecurityObject	ntoskrnl</span><br><span class="line">00000001401383F0		IoDeviceObjectType	ntoskrnl</span><br><span class="line">00000001401383F8		IoCreateDevice	ntoskrnl</span><br><span class="line">0000000140138400		ObOpenObjectByPointer	ntoskrnl</span><br><span class="line">0000000140138408		RtlGetDaclSecurityDescriptor	ntoskrnl</span><br><span class="line">0000000140138410		RtlGetGroupSecurityDescriptor	ntoskrnl</span><br><span class="line">0000000140138418		RtlGetOwnerSecurityDescriptor	ntoskrnl</span><br><span class="line">0000000140138420		RtlGetSaclSecurityDescriptor	ntoskrnl</span><br><span class="line">0000000140138428		SeCaptureSecurityDescriptor	ntoskrnl</span><br><span class="line">0000000140138430		_snwprintf	ntoskrnl</span><br><span class="line">0000000140138438		RtlLengthSecurityDescriptor	ntoskrnl</span><br><span class="line">0000000140138440		SeExports	ntoskrnl</span><br><span class="line">0000000140138448		RtlCreateSecurityDescriptor	ntoskrnl</span><br><span class="line">0000000140138450		_wcsnicmp	ntoskrnl</span><br><span class="line">0000000140138458		wcschr	ntoskrnl</span><br><span class="line">0000000140138460		RtlAbsoluteToSelfRelativeSD	ntoskrnl</span><br><span class="line">0000000140138468		RtlAddAccessAllowedAce	ntoskrnl</span><br><span class="line">0000000140138470		RtlLengthSid	ntoskrnl</span><br><span class="line">0000000140138478		IoIsWdmVersionAvailable	ntoskrnl</span><br><span class="line">0000000140138480		RtlSetDaclSecurityDescriptor	ntoskrnl</span><br><span class="line">0000000140138488		ExAllocatePoolWithQuotaTag	ntoskrnl</span><br><span class="line">0000000140138490		PsGetVersion	ntoskrnl</span><br><span class="line">0000000140138498		ZwQuerySystemInformation	ntoskrnl</span><br><span class="line">00000001401384A0		KeLowerIrql	ntoskrnl</span><br><span class="line"></span><br><span class="line">HAL			</span><br><span class="line">0000000140138000		KeStallExecutionProcessor	HAL</span><br></pre></td></tr></table></figure>

<p>结论：根据.sys的分析，此驱动是纯WDM实现的。因为内核接口全部调用WDM&#x2F;NT kernel接口， 完全没有调用微软的miniport框架例如Storport, SDHC，SDBUS框架封装后的接口。</p>
<p>但微软已不推荐WDM驱动开发，参考：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/introduction-to-wdm">Introduction to WDM</a> 。新驱动优先使用KMDF框架。</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://voidsec.com/windows-drivers-reverse-engineering-methodology/#remote-kernel-debugging">https://voidsec.com/windows-drivers-reverse-engineering-methodology/#remote-kernel-debugging</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_24481913/article/details/131643283">https://blog.csdn.net/qq_24481913/article/details/131643283</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/">https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/08/30/Windows%20Driver%20Model%20Architecture%20for%20SD%20Host%20projects/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/30/Windows%20Driver%20Model%20Architecture%20for%20SD%20Host%20projects/" class="post-title-link" itemprop="url">Windows Driver Model Architecture for SD Host projects</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-08-30 17:52:38" itemprop="dateCreated datePublished" datetime="2024-08-30T17:52:38+08:00">2024-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-18 10:33:54" itemprop="dateModified" datetime="2025-11-18T10:33:54+08:00">2025-11-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/windows%E9%A9%B1%E5%8A%A8/" itemprop="url" rel="index"><span itemprop="name">windows驱动</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Windows-Driver-Model-Architecture-for-SD-Host-projects"><a href="#Windows-Driver-Model-Architecture-for-SD-Host-projects" class="headerlink" title="Windows Driver Model Architecture for SD Host projects"></a>Windows Driver Model Architecture for SD Host projects</h1><h2 id="Driver-Pair-Model和Device-Driver-Interface-DDI-的概念"><a href="#Driver-Pair-Model和Device-Driver-Interface-DDI-的概念" class="headerlink" title="Driver Pair Model和Device Driver Interface(DDI)的概念"></a>Driver Pair Model和Device Driver Interface(DDI)的概念</h2><h3 id="Driver-Pair-Model"><a href="#Driver-Pair-Model" class="headerlink" title="Driver Pair Model"></a>Driver Pair Model</h3><p>Microsoft provides the general driver, and typically an independent hardware vendor provides the specific driver.</p>
<p>Driver Pair Model有两种不同层次的实现方式：</p>
<p>(1) Microsoft定义的某类设备的driver pair model: Microsoft实现XX device port driver + 设备厂商实现XX device miniport driver。这类driver pair model包括：</p>
<ul>
<li>(display miniport driver, display port driver)</li>
<li>(audio miniport driver, audio port driver)</li>
<li>(storage miniport driver, storage port driver)</li>
<li>(battery miniclass driver, battery class driver)</li>
<li>(HID minidriver, HID class driver)</li>
<li>(changer miniclass driver, changer port driver)</li>
<li>(NDIS miniport driver, NDIS library)</li>
</ul>
<p>Miniport Driver Pair Model：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/gettingstarted/minidrivers-and-driver-pairs">https://learn.microsoft.com/en-us/windows-hardware/drivers/gettingstarted/minidrivers-and-driver-pairs</a></p>
<p>(2) Microsoft定义的general driver pair model：Microsoft实现WDF框架 + 设备厂商实现KMDF(Kernel Mode WDF)驱动。</p>
<ul>
<li>The driver is split into two pieces: one that handles general processing and one that handles processing that is specific to a particular device.</li>
<li>The general piece, called the Framework, is written by Microsoft.</li>
<li>The specific piece, called the KMDF driver, may be written by Microsoft or an independent hardware vendor.</li>
</ul>
<p> KMDF as a generic driver pair model: <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/gettingstarted/kmdf-as-a-generic-pair-model">https://learn.microsoft.com/en-us/windows-hardware/drivers/gettingstarted/kmdf-as-a-generic-pair-model</a></p>
<h3 id="Device-Driver-Interface-DDI"><a href="#Device-Driver-Interface-DDI" class="headerlink" title="Device Driver Interface(DDI)"></a>Device Driver Interface(DDI)</h3><p>The DDI Compliance rules define requirements for the proper interaction between a driver and the kernel interface of the operating system</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/static-driver-verifier-rules">https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/static-driver-verifier-rules</a></p>
<p>DDI相当于应用层的API规范，对于每种类型的Driver Pair Mode，都有对应的DDI要求：</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/rules-for-audio-drivers">Rules for Audio Drivers</a><br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/rules-for-avstream-drivers">Rules for AVStream Drivers</a><br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/sdv-rules-for-wdm-drivers">Rules for WDM Drivers</a><br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/sdv-rules-for-kmdf-drivers">Rules for KMDF Drivers</a><br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/sdv-rules-for-ndis-drivers">Rules for NDIS Drivers</a><br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/sdv-rules-for-storport-drivers">Rules for Storport Drivers</a></p>
<p>重点对比以下KMDF（Kernel Mode WDF）的DDI和Storport的DDI：</p>
<p>KMDF DDI rules：只说明了一些WDF函数接口的调用条件和先后顺序要求，没有禁用任何WDF函数接口。</p>
<p>Storport DDI rules: 专门定义了禁用的WDM函数列表HwStorPortProhibitedDDIs: a list of WDM DDIs that should not be called in physical StorPort miniport drivers</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/ddi-usage-rule-set--storport-">https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/ddi-usage-rule-set--storport-</a></p>
<h3 id="几个关键问题"><a href="#几个关键问题" class="headerlink" title="几个关键问题"></a>几个关键问题</h3><p>（1）Driver Pair Model和Dirver接口函数DDI是什么关系？</p>
<p>Driver Pair Model是Diver接口函数DDI的集合，独立的功能例如创建设备，处理中断，处理IO请求，这些都是Diver接口函数去实现；这些Diver接口函数的集合使用分层设计（部分是Microsoft实现，部分是设备厂商实现）就是Driver Pair Model。</p>
<p>举个例子：Storport-miniport的Driver Pair Model中，默认使用WDM DDI去实现port driver部分和miniport driver部分。</p>
<p>（2）为什么Storport Driver Pair Model会禁用很多WDM接口函数(WDM DDI)，尤其是从Win11开始？</p>
<p>原因：微软定义的Storport driver pair model本身也是基于WDM和WDF函数(DDI)上实现，即用WDM或者WDF Model去实现Storage设备（例如SCSI, NVMe）的数据结构和特殊流程函数，封装成Storport的DDI。而微软的Driver开发趋势是弃用WDM逐步过渡到WDF，因此Storport为了适配Win11系统，可能有很多Storport DDI用WDF DDI重写了，因此Storport禁用了设备厂商去直接调用很多WDM DDI，避免造成同一个功能用WDM和WDF都去实现了而产生冲突。</p>
<h2 id="SD-host的Driver-Model选型"><a href="#SD-host的Driver-Model选型" class="headerlink" title="SD host的Driver Model选型"></a>SD host的Driver Model选型</h2><h3 id="支持SD-host驱动开发的Driver-Model"><a href="#支持SD-host驱动开发的Driver-Model" class="headerlink" title="支持SD host驱动开发的Driver Model"></a>支持SD host驱动开发的Driver Model</h3><p>对于SD设备生态可用的Driver Pair Model有：</p>
<ul>
<li><p>KMDF Framework + KMDF driver：通用框架，任意厂商可用KMDF去实现任意类型设备的host&#x2F;slave驱动；微软也在KMDF去升级已有的特定设备框架，例如微软定义的usbport驱动框架：USB 1.0&#x2F;2.0使用WDM（usbport.sys），USB 3.0使用WDF（Wdf01000.sys）</p>
</li>
<li><p>Storport + storage miniport：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/storage/storport-miniport-drivers">https://learn.microsoft.com/en-us/windows-hardware/drivers/storage/storport-miniport-drivers</a></p>
<p>这个Driver Model支持厂商实现SD host驱动，但其数据和流程定义很多是针对SCSI&#x2F;NVMe等大容量Disk设备，对于SD host&#x2F;device没有专门的定义；此外Storport从Win11开始禁用了很多WDM DDI，代码开发限制多。</p>
</li>
<li><p>sdport + sdhci-miniport：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/samples/microsoft/windows-driver-samples/standard-sd-host-controller-miniport/">https://learn.microsoft.com/en-us/samples/microsoft/windows-driver-samples/standard-sd-host-controller-miniport/</a></p>
<p>实现SD protocol的port driver框架，支持厂商实现vendor SD host驱动，但API文档已停止维护, sample code有维护（win11）。</p>
</li>
<li><p>sdbus + sddisk: <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/sd/sd-card-driver-stack">https://learn.microsoft.com/en-us/windows-hardware/drivers/sd/sd-card-driver-stack</a></p>
<p>微软的Inbox SD驱动使用此框架；只支持SD&#x2F;SDIO device厂商去写device driver，不支持厂商实现SD host驱动。</p>
</li>
</ul>
<h3 id="微软的Driver-Model选型的参考文档"><a href="#微软的Driver-Model选型的参考文档" class="headerlink" title="微软的Driver Model选型的参考文档"></a>微软的Driver Model选型的参考文档</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/develop/creating-a-new-driver">https://learn.microsoft.com/en-us/windows-hardware/drivers/develop/creating-a-new-driver</a></p>
<p>其中分为两种选项：</p>
<p>（1）KMDF框架</p>
<p>（2）miniport框架</p>
<p>微软推荐miniport框架都用WDM DDI开发；不推荐miniport + WDF DDI的混合开发方式（尽管可行），参考：</p>
<p>If your device technology has a minidriver model, and you aren’t able to find a specific template for your type of minidriver, the Windows Driver Model (WDM) template is most likely going to be your starting point. Refer to your technology-specific documentation for guidance. In rare cases, you can use KMDF to write a minidriver, but usually the starting point is WDM.</p>
<p>微软开发论坛（OSR）也提出过storport的WDM不够灵活，又不能兼容WDF DDI的问题：</p>
<p><a target="_blank" rel="noopener" href="https://www.osr.com/nt-insider/2014-issue4/win7-vs-win8-storport-miniports/">https://www.osr.com/nt-insider/2014-issue4/win7-vs-win8-storport-miniports/</a></p>
<p><a target="_blank" rel="noopener" href="https://community.osr.com/t/wdfdeviceminiportcreate-and-virtual-storport/46617/8">https://community.osr.com/t/wdfdeviceminiportcreate-and-virtual-storport/46617/8</a></p>
<p>结论：KMDF框架是万能方案</p>
<h2 id="从Storport-miniport框架过渡到KMDF框架"><a href="#从Storport-miniport框架过渡到KMDF框架" class="headerlink" title="从Storport-miniport框架过渡到KMDF框架"></a>从Storport-miniport框架过渡到KMDF框架</h2><p>（1）问题：Storport-miniport框架一定能porting到KMDF框架吗？</p>
<p>参考：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/wdf/which-drivers-can-be-ported">https://learn.microsoft.com/en-us/windows-hardware/drivers/wdf/which-drivers-can-be-ported</a></p>
<p>Which WDM drivers can I port to WDF?</p>
<p>For some device types, system-supplied device class and port drivers provide driver dispatch functions and call a vendor-supplied miniport driver to handle specific I&#x2F;O details. These miniport drivers are essentially callback libraries and are not supported by WDF.</p>
<p>结论1：如果该Storage设备驱动依赖于Storport框架定义的流程，例如SCSI， NVMe设备依赖于Storport定义的SCSI和NVMe初始化和I&#x2F;O流程。那么就不能直接porting到WDF，因为WDF没有定义特定设备的请求流程。</p>
<p>结论2：对于SD设备，Storport框架本身就没有实现SD协议的初始化和I&#x2F;O流程。SD host设备的Storport-miniport驱动完全可以porting到WDF框架，<strong>唯一可能有问题的是SD disk相关的Storport请求对应WDF的哪些请求？移植到WDF必须要求SD host和Disk整个生态都能顺利过渡</strong>。</p>
<p>（2）问题：Storport代码如何porting到KMDF</p>
<p>主要工作是将Storport-miniport中的DDI函数，映射到KMDF的DDI函数。</p>
<p>Storport-miniport的DDI列表：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/storage/storport-driver-support-routines">https://learn.microsoft.com/en-us/windows-hardware/drivers/storage/storport-driver-support-routines</a></p>
<p>KMDF的DDI列表：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/_wdf/">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/_wdf/</a></p>
<p>基于此方法，后面两章分为两部分：</p>
<ul>
<li><p>Storport DDI在SD host miniport driver中的使用（第4章）：SD host miniport driver用到了哪些DDI，实现什么功能。</p>
</li>
<li><p>从Storport DDI到KMDF DDI（第5章）：SD host miniport driver用到的Storport DDI应该用哪些KMDF DDI去重写功能。</p>
</li>
</ul>
<h2 id="Storport-DDI在SD-host-miniport-driver中的使用"><a href="#Storport-DDI在SD-host-miniport-driver中的使用" class="headerlink" title="Storport DDI在SD host miniport driver中的使用"></a>Storport DDI在SD host miniport driver中的使用</h2><p>Storport DDI routine分为两大类：</p>
<p>（1）callback routine：是Storport定义函数形式，miniport实现函数内容</p>
<p>（2）normal routine：是Storport定义函数形式和内容，miniport只调用</p>
<table>
<thead>
<tr>
<th>Storport Callback Routine</th>
<th>sub-function parameter</th>
<th>Function Description</th>
<th>SD miniport driver’s implementation for this callback</th>
</tr>
</thead>
<tbody><tr>
<td><strong>HwStorInitialize</strong></td>
<td><strong>HwStorPassiveInitializeRoutine</strong></td>
<td>The <strong>HwStorInitialize</strong> routine initializes the miniport driver after a system reboot or power failure occurs. It is called by StorPort after <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_find_adapter"><strong>HwStorFindAdapter</strong></a> successfully returns. <strong>HwStorInitialize</strong> initializes the HBA and finds all devices that are of interest to the miniport driver.<br/>The following responsibilities are shared between HwStorInitialize and HwStorPassiveInitializeRoutine:<br/>Initialize hardware for the HBA registers and buffers.<br/>Initialize and allocate all DeviceExtension fields.<br/>Set up and initialize all events and DPCs that are used by the miniport driver.<br/><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_initialize">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_initialize</a>  <br/> <br/><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_passive_initialize_routine">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_passive_initialize_routine</a></td>
<td>Support. <br/>HwStorPassiveInitializeRoutine中注册了Adapter的POFX数据（StorPortInitializePoFxPower）</td>
</tr>
<tr>
<td><strong>HwStorInterrupt</strong></td>
<td>N&#x2F;A</td>
<td>The Storport driver calls the <strong>HwStorInterrupt</strong> routine after the HBA generates an interrupt request. The <strong>HwStorInterrupt</strong> routine should return within 50 microseconds, ideally as short a time as possible. Therefore, all activity does not have to occur at high IRQL should be deferred to the [<strong>HwStorDpcRoutine</strong>]</td>
<td>Support. <br/>用于SD card的插拔卡中断和数据传输完成或错误中断的处理入口</td>
</tr>
<tr>
<td><strong>HwStorFindAdapter</strong></td>
<td><strong>PORT_CONFIGURATION_INFORMATION</strong> contains configuration information for a host bus adapter (HBA). <br/><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/storport/ns-storport-_port_configuration_information">https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/storport/ns-storport-_port_configuration_information</a></td>
<td>The <strong>HwStorFindAdapter</strong> routine uses the supplied configuration to determine whether a specific HBA is supported and, if it is, to return configuration information about that adapter.<br/><br/><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_find_adapter">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_find_adapter</a><br/><br/><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-_port_configuration_information">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-_port_configuration_information</a></td>
<td>Support. <br/>Main tasks:<br/>1. Zero the device extention<br/>2. Get the memory base, the vendor ID and the device ID<br/>3. Port Configuration Information initialization<br/>4. Driver used memory allocation<br/>5. Initialize the timer, tag queue, host capability, vendor register settings, host software structure<br/></td>
</tr>
<tr>
<td><strong>HwStorAdapterControl</strong></td>
<td><strong>SCSI_ADAPTER_CONTROL_TYPE</strong> <br/> <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ne-storport-scsi_adapter_control_type">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ne-storport-scsi_adapter_control_type</a></td>
<td>A miniport driver’s <strong>HwStorAdapterControl</strong> routine is called to perform synchronous operations to control the state or behavior of an adapter, such as stopping or restarting the host bus adapter (HBA) for power management. <br/><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_adapter_control">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_adapter_control</a></td>
<td>支持部分ControlTypes：<br/>ScsiQuerySupportedControlTypes, ScsiStopAdapter, ScsiRestartAdapter, ScsiSetBootConfig, ScsiSetRunningConfig, ScsiPowerSettingNotification, ScsiAdapterPoFxPowerActive, ScsiAdapterPower, ScsiAdapterPrepareForBusReScan, ScsiAdapterSystemPowerHints,</td>
</tr>
<tr>
<td></td>
<td>ScsiQuerySupportedControlTypes</td>
<td>Reports the adapter-control operations implemented by the miniport driver. A miniport must support this control type. Using <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-scsi_supported_control_type_list"><strong>SCSI_SUPPORTED_CONTROL_TYPE_LIST</strong></a> structure</td>
<td>support.</td>
</tr>
<tr>
<td></td>
<td>ScsiStopAdapter</td>
<td>Shuts down the HBA. A miniport must support this control type.</td>
<td>support. <br/>但什么都没干</td>
</tr>
<tr>
<td></td>
<td>ScsiRestartAdapter</td>
<td>Reinitializes an HBA. A miniport must support this control type.</td>
<td>support. <br/>调用req_enter_d0()函数，做host reset &amp; init，然后判断卡在位，发起card-change event去处理Adapter Stop期间的card insert or card remove操作。</td>
</tr>
<tr>
<td></td>
<td>ScsiSetBootConfig</td>
<td>Restores any settings on an HBA that the BIOS might need to reboot. A miniport driver must implement <strong>ScsiSetBootConfig</strong> if it must call <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportgetbusdata"><strong>StorPortGetBusData</strong></a> or <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportsetbusdatabyoffset"><strong>StorPortSetBusDataByOffset</strong></a> before the system will be able to reboot.</td>
<td>support. <br/>但什么都没干</td>
</tr>
<tr>
<td></td>
<td>ScsiSetRunningConfig</td>
<td>Restores any settings on an HBA that the miniport driver might need to control the HBA while the system is running. A miniport driver must implement <strong>ScsiSetRunningConfig</strong> if it must call <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportgetbusdata"><strong>StorPortGetBusData</strong></a> or <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportsetbusdatabyoffset"><strong>StorPortSetBusDataByOffset</strong></a> to restore the appropriate running configuration to the HBA before it can be restarted.</td>
<td>support. <br/>调用pcr_part_a_restore和pcr_part_b_restore函数去配置SD host PCR register的一些默认值</td>
</tr>
<tr>
<td></td>
<td>ScsiPowerSettingNotification</td>
<td>Notification for a registered power setting change. Using <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-stor_power_setting_info"><strong>STOR_POWER_SETTING_INFO</strong></a> structure</td>
<td>support. <br/>但什么都没干</td>
</tr>
<tr>
<td></td>
<td>ScsiAdapterPower</td>
<td>Reports the adapter power on or power off states. Using <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-stor_adapter_control_power"><strong>STOR_ADAPTER_CONTROL_POWER</strong></a> structure. 其中包括<strong>STOR_POWER_ACTION</strong>和<strong>STOR_DEVICE_POWER_STATE</strong> 两个子参数</td>
<td>support. <br/>实现STOR_DEVICE_POWER_STATE &#x3D; D0~D3和STOR_POWER_ACTION &#x3D; Sleep&#x2F;Hibernate&#x2F;Shutdown&#x2F;ShutdownReset&#x2F;ShutdownOff&#x2F;StorPowerActionNone的设备、系统的电源状态请求</td>
</tr>
<tr>
<td></td>
<td>ScsiAdapterPoFxPowerRequired</td>
<td>Notifies the miniport whether power is required or not for the adapter component.</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>ScsiAdapterPoFxPowerActive</td>
<td>Notifies the miniport whether the adapter component is active or idle.using <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-stor_pofx_active_context"><strong>STOR_POFX_ACTIVE_CONTEXT</strong></a> structure</td>
<td>support<br/>只读了Storport下发的STOR_POFX_ACTIVE_CONTEXT，而没使用。相当于什么都没干</td>
</tr>
<tr>
<td></td>
<td>ScsiAdapterPoFxPowerSetFState</td>
<td>Notifies the miniport to set the adapter component to the given F-state. using <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-stor_pofx_fstate_context"><strong>STOR_POFX_FSTATE_CONTEXT</strong></a> structure</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>ScsiAdapterPoFxPowerControl</td>
<td>Requests that the miniport execute a private power control operation that was initiated for the adapter by a power engine plug-in (PEP). using <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-stor_pofx_power_control"><strong>STOR_POFX_POWER_CONTROL</strong></a> structure.</td>
<td>support. <br/>但什么都没干</td>
</tr>
<tr>
<td></td>
<td>ScsiAdapterPrepareForBusReScan</td>
<td>Notifies the miniport to prepare the adapter for bus enumeration.</td>
<td>support. <br/>但什么都没干</td>
</tr>
<tr>
<td></td>
<td>ScsiAdapterSystemPowerHints</td>
<td>Provides system power hints to the miniport. using <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-stor_system_power_hints"><strong>STOR_SYSTEM_POWER_HINTS</strong></a> structure</td>
<td>support. <br/>但什么都没干</td>
</tr>
<tr>
<td></td>
<td>ScsiAdapterFilterResourceRequirements</td>
<td>Filters the required resources for the adapter. Using <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-stor_filter_resource_requirements"><strong>STOR_FILTER_RESOURCE_REQUIREMENTS</strong></a> structure.</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>ScsiAdapterPoFxMaxOperationalPower</td>
<td>Communicates a maximum operational power value to the miniport. Using <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-stor_max_operational_power"><strong>STOR_MAX_OPERATIONAL_POWER</strong></a> structure</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>ScsiAdapterPoFxSetPerfState</td>
<td>Informs the miniport of the status of a P-State transition requested by a call to <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportpofxsetperfstate"><strong>StorPortPoFxSetPerfState</strong></a>. Using STOR_POFX_PERF_STATE_CONTEXT**](<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-stor_pofx_perf_state_context">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-stor_pofx_perf_state_context</a>) structure</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>ScsiAdapterSurpriseRemoval</td>
<td>Notifies the miniport that the unit has been surprise-removed.</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>ScsiAdapterSerialNumber</td>
<td>Requests that the miniport retrieve the adapter’s serial number.</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>ScsiAdapterQueryFruId</td>
<td>Available starting in Windows 10 version 21H1. Queries the ID of a fault replacement unit (FRU) of the adapter. Storport sends this control only if a miniport has also previously called <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportsetfeaturelist"><strong>StorPortSetFeatureList</strong></a> in its <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_find_adapter"><strong>HwFindAdapter</strong></a> routine with <strong>StorportFeatureFruIdAdapterControl</strong> specified.</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>ScsiAdapterSetEventLogging</td>
<td>Available starting in Windows 10 version 21H1. Notifies the miniport about whether a specific event channel is enabled or disabled for an adapter. Storport sends this control only if a miniport has also previously called <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportsetfeaturelist"><strong>StorPortSetFeatureList</strong></a> in its <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_find_adapter"><strong>HwFindAdapter</strong></a> routine with <strong>StorportFeatureFruIdAdapterControl</strong> specified.</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>ScsiAdapterResetBusSynchronous</td>
<td>Available starting in Windows 11, version 22H2. Storport sends this control during the handling of an IOCTL_STORAGE_DEVICE_RESET. The miniport driver should handle this control similar to what it does in its <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_reset_bus"><strong>HwResetBus</strong></a> callback routine. Storport sends this control only if a miniport has also previously called <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportsetfeaturelist"><strong>StorPortSetFeatureList</strong></a> in its <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_find_adapter"><strong>HwFindAdapter</strong></a> routine with <strong>StorportFeatureResetBusSynchronous</strong> specified.</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>ScsiAdapterPreparePLDR</td>
<td>Storport sends this control to notify miniport to do necessary work before invoking PLDR. Available starting in Windows 11, version 24H2</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>ScsiNvmeofAdapterOperation</td>
<td>Indicates whether ScsiNvmeofAdapterOperation is supported. Available starting in Windows 11, version 24H2.</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>HwStorStartIo</strong> and <strong>HwStorBuildIo</strong></td>
<td><strong>HwStorBuildIo</strong> and <strong>HwStorStartIo</strong> receive the following Srb function types:</td>
<td>The Storport driver calls the <strong>HwStorStartIo</strong> routine one time for each incoming I&#x2F;O request.<br/><strong>HwStorStartIo</strong> initiates an I&#x2F;O operation. StorPort is designed to use a miniport’s private data that is prepared in <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_buildio"><strong>HwStorBuildIo</strong></a> and stored in either <strong>DeviceExtension</strong> or <strong>Srb-&gt;SrbExtension</strong>. Because <strong>HwStorBuildIo</strong> is called without spin locks, the best driver performance is achieved by preparing as much data as possible in <strong>HwStorBuildIo</strong>. <br/><br/><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_startio">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_startio</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>The <strong>HwStorBuildIo</strong> routine processes the SRB with unsynchronized access to shared system data structures before passing it to <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_startio"><strong>HwStorStartIo</strong></a>.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>SRB_FUNCTION_EXECUTE_SCSI</td>
<td>Sends a CDB to the specified bus&#x2F;target&#x2F;lun.</td>
<td>根据如下SCSI operation code分别处理：<br/>SCSIOP_TEST_UNIT_READY, SCSIOP_REQUEST_SENSE, SCSIOP_INQUIRY, SCSIOP_READ_CAPACITY, SCSIOP_READ, SCSIOP_WRITE, SCSIOP_MODE_SENSE, SCSIOP_VERIFY, SCSIOP_LOAD_UNLOAD, SCSIOP_MEDIUM_REMOVAL<br/>注：这部分代码有多存疑的地方，代码本身是从老的SCSI驱动移植过来，SD设备不属于SCSI disk类型，这些SCSI请求哪些应该在SD disk上用哪些不该用，没有微软文档说明</td>
</tr>
<tr>
<td></td>
<td>SRB_FUNCTION_IO_CONTROL</td>
<td>Miniport defined.</td>
<td>直接返回SRB_STATUS_SUCCESS</td>
</tr>
<tr>
<td></td>
<td>SRB_FUNCTION_RESET_LOGICAL_UNIT</td>
<td>Reset the specified logical unit (if the device is capable).</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>SRB_FUNCTION_RESET_DEVICE</td>
<td>Reset the specified Scsi Target.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>SRB_FUNCTION_RESET_BUS</td>
<td>Reset all of the targets on the specified SCSI bus.</td>
<td>直接返回SRB_STATUS_SUCCESS</td>
</tr>
<tr>
<td></td>
<td>SRB_FUNCTION_FLUSH</td>
<td>Instructs the miniport driver to flush all cached data.</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>SRB_FUNCTION_SHUTDOWN</td>
<td>Instructs the miniport driver to flush all cached data preparatory to shut down.</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>SRB_FUNCTION_DUMP_POINTERS</td>
<td>Supplies information needed for the miniport driver to support crash dump and hibernation. This request is sent to a Storport virtual miniport driver that is used to control the disk that holds the crash dump data. Starting with Windows 8, non-virtual miniport drivers can optionally receive this request.</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>SRB_FUNCTION_FREE_DUMP_POINTERS</td>
<td>Starting with Windows 8, this request is sent to the miniport to free resources allocated during the SRB_FUNCTION_DUMP_POINTERS request.</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>SRB_FUNCTION_PNP</td>
<td><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/srb/ns-srb-_stor_device_capabilities_ex">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/srb/ns-srb-_stor_device_capabilities_ex</a></td>
<td>只处理STOR_DEVICE_CAPABILITIES_EX定义的StorQueryCapability请求类型去上报Removable，EjectSupported等能力<br/>The <strong>STOR_DEVICE_CAPABILITIES_EX</strong> structure reports device capabilities to the SCSI port driver in response to a capabilities query in a SCSI request block (SRB) with a function of SRB_FUNCTION_PNP<br/>注：此请求是否兼容Storport存疑，因为是作为SCSI port driver定义的结构</td>
</tr>
<tr>
<td><strong>HwStorResetBus</strong></td>
<td>N&#x2F;A</td>
<td>The <strong>HwStorResetBus</strong> routine is called by the port driver to clear error conditions.</td>
<td>support. <br/>其中实现card关电，host reset，cancel所有IO的操作</td>
</tr>
<tr>
<td><strong>HwStorUnitControl</strong></td>
<td><strong>SCSI_UNIT_CONTROL_TYPE</strong> enumeration contains unit control operations, where each control type initiates an action on a unit by the miniport driver. <br/><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ne-storport-scsi_unit_control_type">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ne-storport-scsi_unit_control_type</a></td>
<td>A miniport driver’s <strong>HwStorUnitControl</strong> routine is called to perform synchronous operations to control the state of storage unit device. <br/><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_unit_control">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_unit_control</a></td>
<td>Support.</td>
</tr>
<tr>
<td></td>
<td>ScsiQuerySupportedUnitControlTypes</td>
<td>Reports the unit-control operations implemented by the miniport driver. A miniport must support this control type.</td>
<td>Support ScsiQuerySupportedUnitControlTypes, ScsiUnitStart, ScsiUnitPower, ScsiUnitPoFxPowerInfo, ScsiUnitPoFxPowerActive, ScsiUnitPoFxPowerSetFState</td>
</tr>
<tr>
<td></td>
<td>ScsiUnitUsage</td>
<td>Notifies the miniport whether the logical unit is used for any supported usage types.</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>ScsiUnitStart</td>
<td>Notifies the miniport to start a unit device.</td>
<td>support. 但实际什么都没干</td>
</tr>
<tr>
<td></td>
<td>ScsiUnitPower</td>
<td>Reports the unit power on or power off states.If the miniport supports this control type, it will not receive a storage request block with SRB_FUNCTION_POWER.</td>
<td>support. 但实际什么都没干</td>
</tr>
<tr>
<td></td>
<td>ScsiUnitPoFxPowerInfo</td>
<td>Notifies the miniport if idle power management is enabled or disabled on the unit component. The miniport should call <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportinitializepofxpower"><strong>StorPortInitializePoFxPower</strong></a> within this unit control if idle power management was enabled and if it supports runtime power management for the unit device.</td>
<td>support. 对Disk注册了Pofx(StorPortInitializePoFxPower). <br/>注：这里合理性存疑：Host Driver需要给Disk注册Pofx吗？</td>
</tr>
<tr>
<td></td>
<td>ScsiUnitPoFxPowerRequired</td>
<td>Notifies the miniport whether power is required for the unit component. Using <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-stor_pofx_power_required_context"><strong>STOR_POFX_POWER_REQUIRED_CONTEXT</strong></a> structure</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>ScsiUnitPoFxPowerActive</td>
<td>Notifies the miniport that the unit component is either active or idle. Using <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-stor_pofx_active_context"><strong>STOR_POFX_ACTIVE_CONTEXT</strong></a> structure</td>
<td>support. 但实际什么都没干</td>
</tr>
<tr>
<td></td>
<td>ScsiUnitPoFxPowerSetFState</td>
<td>Notifies the miniport to set the unit component to the given functional power state (F-state). Using <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-stor_pofx_fstate_context"><strong>STOR_POFX_FSTATE_CONTEXT</strong></a> structure</td>
<td>support. 但实际什么都没干</td>
</tr>
<tr>
<td></td>
<td>ScsiUnitPoFxPowerControl</td>
<td>Requests that the miniport execute a private power control operation that was initiated for the unit by a power engine plug-in (PEP). Using <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-stor_pofx_power_control"><strong>STOR_POFX_POWER_CONTROL</strong></a> structure</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>ScsiUnitRemove</td>
<td>Notifies the miniport that the unit has been removed.</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>ScsiUnitSurpriseRemoval</td>
<td>Notifies the miniport that the unit has been surprise-removed.</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>ScsiUnitRichDescription</td>
<td>The miniport can choose to support this if the device reports a longer vendor ID, model number, or firmware revision than is defined in the SCSI spec</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>ScsiUnitQueryBusType</td>
<td>Queries whether the miniport wants to specify a bus type for a given logical unit (LUN). Using <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-stor_unit_control_query_bus_type"><strong>STOR_UNIT_CONTROL_QUERY_BUS_TYPE</strong></a> structure. In Windows 10 version 21H1 and later, Storport sends this control only if a miniport has also previously called <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportsetfeaturelist"><strong>StorPortSetFeatureList</strong></a> in its <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_find_adapter"><strong>HwFindAdapter</strong></a> routine with <strong>StorportFeatureBusTypeUnitControl</strong> specified.</td>
<td>Not support</td>
</tr>
<tr>
<td></td>
<td>ScsiUnitQueryFruId</td>
<td>Queries the ID of a fault replacement unit (FRU). Available in Windows 10 version 21H1 and later.</td>
<td></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>Storport Normal Routine that used by SD miniport driver.</th>
<th>Function Description</th>
<th>SD miniport driver’s purpose to use the routine</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>StorPortWaitForSingleObject</td>
<td>A miniport can call <strong>StorPortWaitForSingleObject</strong> function to put the current thread into a wait state until the given dispatcher object is set to signaled state or optionally times out. dispatcher object (event, mutex, semaphore, thread, or timer)<br/><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportwaitforsingleobject">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportwaitforsingleobject</a></td>
<td>用于Storport routine和miniport thread的同步：storport routine发起dispatcher object(event), miniport thread使用StorPortWaitForSingleObject等待event信号产生后进入处理流程此时开始占用CPU；如果没有event，miniport thread将sleep，不会占用CPU.</td>
</tr>
<tr>
<td>StorPortInitializeEvent</td>
<td><strong>StorPortInitializeEvent</strong> initializes an event object as a synchronization or notification type event, and sets it to a signaled or not-signaled state.<br/><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportinitializeevent">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportinitializeevent</a></td>
<td>初始化event事件对象，但不设置事件产生的信号。注意：如果没有初始化event就使用会产生空指针访问，系统会BSOD.</td>
</tr>
<tr>
<td>StorPortSetEvent</td>
<td>A miniport can call <strong>StorPortSetEvent</strong> to set an event object to the signaled state.<br/><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportsetevent">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportsetevent</a></td>
<td>设置事件产生的信号</td>
</tr>
<tr>
<td>StorPortInitializeDpc</td>
<td>The <strong>StorPortInitializeDpc</strong> routine initializes a StorPort DPC.<br/><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportinitializedpc">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportinitializedpc</a></td>
<td>创建DPC对象：用于在高IRQL的Storport routine(IRQL &gt;&#x3D;中断级别)中设置延迟处理任务，目的是减少CPU处在高IRQL的时间，将不紧急的任务放到低IRQL(IRQL &lt;&#x3D; DPC)执行。这是Driver设计的基本要求。</td>
</tr>
<tr>
<td>StorPortIssueDpc</td>
<td>The <strong>StorPortIssueDpc</strong> routine issues a deferred procedure call (DPC).<br/><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportissuedpc">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportissuedpc</a></td>
<td>发起DPC任务：将延迟处理的任务加到DPC队列</td>
</tr>
<tr>
<td>StorPortCancelDpc</td>
<td><strong>StorPortCancelDpc</strong> attempts to cancel the execution of a StorPort deferred procedure call (DPC).</td>
<td>销毁DPC对象：Driver卸载时清理资源</td>
</tr>
<tr>
<td>StorPortRequestTimer</td>
<td>Schedules a callback event for a Storport timer context object.</td>
<td>启动Timer：OS提供的定时器模块，miniport driver用于定时任务，例如设置指定disk idle时间后进入runtime D3.</td>
</tr>
<tr>
<td>StorPortFreeTimer</td>
<td>Frees a Storport timer context object previously created by the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportinitializetimer">StorPortInitializeTimer</a> routine.</td>
<td>销毁Timer：Driver卸载时清理资源</td>
</tr>
<tr>
<td>StorPortStallExecution</td>
<td>The <strong>StorPortStallExecution</strong> routine stalls the miniport driver. This call ties up a processor, doing no useful work while stalling in the driver. <br/> 参考：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/srb/nf-srb-scsiportstallexecution">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/srb/nf-srb-scsiportstallexecution</a></td>
<td>使当前storport routine忙等待：miniport driver用于卸载driver时，等待miniport thread退出；如果不等待miniport thread退出就完成storport卸载routine，miniport创建的thread将会在卸载后继续运行，应用层会卸载报错。</td>
</tr>
<tr>
<td>StorPortDelayExecution</td>
<td>The <strong>StorPortDelayExecution</strong> function delays the current thread by the given amount of time, in microseconds. If the current IRQL is lower than DISPATCH_LEVEL then the current thread is simply put in the wait state and other threads are allowed to run. Otherwise, this routine performs a busy-wait.</td>
<td>miniport driver用于将当前miniport thread放到Sleep状态，释放CPU的占用，使其它thread（不管是storport还是miniport）可以运行。</td>
</tr>
<tr>
<td>StorPortGetCurrentIrql</td>
<td><strong>StorPortGetCurrentIrql</strong> retrieves the current interrupt request level (IRQL).</td>
<td>miniport driver用于配合StorPortDelayExecution使用：如果当前IRQL高，Sleep实际是忙等.</td>
</tr>
<tr>
<td>StorPortAllocateRegistryBuffer</td>
<td>The <strong>StorPortAllocateRegistryBuffer</strong> routine is called by the miniport driver to allocate a buffer that can be used to read and write registry data.</td>
<td>以下几个Registry Routine都是Windows Registry的访问操作，INF里面配置的Registry默认值通过这些Registry Routine去写入注册表，Driver动态功能开关是通过Registry Routine去读取注册表</td>
</tr>
<tr>
<td>StorPortRegistryRead</td>
<td>The <strong>StorPortRegistryRead</strong> routine reads the registry data for the indicated device and value.</td>
<td></td>
</tr>
<tr>
<td>StorPortRegistryWrite</td>
<td>The <strong>StorPortRegistryWrite</strong> routine is called by the miniport driver to convert the registry data contained in a specified buffer from ASCII to Unicode and to then write the data to the miniport driver’s per-HBA storage area.</td>
<td></td>
</tr>
<tr>
<td>StorPortFreeRegistryBuffer</td>
<td>The <strong>StorPortFreeRegistryBuffer</strong> routine frees the buffer that was allocated for storing registry data.</td>
<td></td>
</tr>
<tr>
<td>StorPortNotification</td>
<td>The miniport driver uses the <strong>StorPortNotification</strong> routine to notify the Storport driver of certain events and conditions. <strong>StorPortNotification</strong> takes a variable number of parameters depending on the notification type specified. <br/>NotificationType：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportnotification">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportnotification</a></td>
<td>miniport对storport的反向通知机制</td>
</tr>
<tr>
<td></td>
<td>BusChangeDetected: Indicates that a target device might have been added or removed from a dynamic bus.</td>
<td>miniport driver用于：当disk有插拔或者card模式切换，都会发BusChangeDetected去通知OS</td>
</tr>
<tr>
<td></td>
<td>RequestComplete: Indicates that the given SRB has finished. After this notification is sent, the port driver owns the request.</td>
<td>miniport driver用于返回Storport的每一个SRB请求，包括inquiry查询和i&#x2F;O读写等各类收到的SRB请求。</td>
</tr>
<tr>
<td></td>
<td>ResetDetected: Indicates that the HBA has detected a reset on the bus. After this notification is sent, the miniport driver is still responsible for completing any active requests. The port driver will manage all required bus-reset delays.</td>
<td>miniport driver没使用此notification类型</td>
</tr>
<tr>
<td></td>
<td>RequestTimerCall: Indicates that the miniport driver requires the port driver to call the miniport driver’s <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nc-storport-hw_timer">HwStorTimer</a> routine in the requested number of microseconds.</td>
<td>miniport driver用于在Storport routine里面，将一部分任务放到指定时间后开始执行，相当于一种不精确的DPC.</td>
</tr>
<tr>
<td></td>
<td>IoTargetRequestServiceTime: Indicates to Storport the amount of time that was required to process a specified request.</td>
<td>miniport driver用于指定tagIO任务的完成时间，让Storport driver有个预期不要误判请求完成超时。</td>
</tr>
<tr>
<td>StorPortGetBusData</td>
<td>The <strong>StorPortGetBusData</strong> routine retrieves the bus-specific configuration information necessary to initialize the HBA.</td>
<td>miniport driver用于获取Bus(PCIe Bus)的数据，拿到SD host device在PCIe Bus的信息。例如VendorID，DeviceID，区分SD host类型。</td>
</tr>
<tr>
<td>StorPortGetUncachedExtension</td>
<td>The <strong>StorPortGetUncachedExtension</strong> routine allocates an uncached common buffer to be shared by the CPU and the device.</td>
<td>在HwStorFindAdapter Callback创建DMA Buffer时使用</td>
</tr>
<tr>
<td>StorPortGetPhysicalAddress</td>
<td>The <strong>StorPortGetPhysicalAddress</strong> routine converts a given virtual address range to a physical address range for a DMA operation.</td>
<td>在HwStorFindAdapter Callback创建DMA Buffer时使用</td>
</tr>
<tr>
<td>StorPortInitialize</td>
<td>The <strong>StorPortInitialize</strong> routine initializes the port driver parameters and extension data. <strong>StorPortInitialize</strong> also saves the adapter information provided from the <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/storage/storage-miniport-drivers">miniport driver</a> <strong>DriverEntry</strong> routine.</td>
<td>miniport driver将Storport指定的HW_INITIALIZATION_DATA全部初始化完成后调用，上报miniport的所有能力配置和回调函数。</td>
</tr>
<tr>
<td>StorPortReadRegisterBuffer</td>
<td>reads a value from a specified register address.</td>
<td>miniport driver用于register读（包括SD host register和PCIe Config register，register address由PCIe bar address + offset指定）</td>
</tr>
<tr>
<td>StorPortWriteRegisterBuffer</td>
<td>transfers a given number of unsigned bytes from a buffer to the HBA.</td>
<td>miniport driver用于register写（包括SD host register和PCIe Config register，register address由PCIe bar address + offset指定）</td>
</tr>
<tr>
<td>StorPortWritePort</td>
<td>transfers an unsigned byte to the HBA</td>
<td>miniport driver没有使用，只遗留历史代码</td>
</tr>
<tr>
<td>StorPortReadPort</td>
<td>reads a value from a specified port address</td>
<td>miniport driver没有使用，只遗留历史代码</td>
</tr>
<tr>
<td>StorPortInitializePoFxPower</td>
<td>A miniport driver calls <strong>StorPortInitializePoFxPower</strong> to register a storage device with the power management framework (PoFx). Using <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-_stor_pofx_device">STOR_POFX_DEVICE</a>, <strong>STOR_POFX_DEVICE_V2</strong>, or <strong>STOR_POFX_DEVICE_V3</strong></td>
<td>miniport driver用于注册Adapter和Disk Unit的pofx</td>
</tr>
<tr>
<td>StorPortPoFxIdleComponent</td>
<td>The <strong>StorPortPoFxIdleComponent</strong> routine decrements the activation reference count of a specified component of a storage device.</td>
<td>在remove card， auto power off时调用</td>
</tr>
<tr>
<td>StorPortPoFxActivateComponent</td>
<td>The <strong>StorPortPoFxActivateComponent</strong> routine increments the activation reference count on the specified component of a storage device.</td>
<td>在insert card调用</td>
</tr>
<tr>
<td>StorPortGetD3ColdSupport</td>
<td>Get D3Cold support or not by this HBA</td>
<td>StorPortInitializePoFxPower其中一个参数是D3Cold enable or not</td>
</tr>
<tr>
<td>StorPortGetDeviceObjects</td>
<td>Returns the device objects that are associated with the adapter device stack</td>
<td>处理PNP请求用到，根据SD host extension获取<em>AdapterDeviceObject</em>和<em>PhysicalDeviceObject</em>和LowerDeviceObject</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/08/30/Windows%20Hardware%20driver%20submission%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/30/Windows%20Hardware%20driver%20submission%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">Windows Hardware driver submission问题记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-08-30 17:52:38" itemprop="dateCreated datePublished" datetime="2024-08-30T17:52:38+08:00">2024-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-18 10:43:16" itemprop="dateModified" datetime="2025-11-18T10:43:16+08:00">2025-11-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/windows%E9%A9%B1%E5%8A%A8/" itemprop="url" rel="index"><span itemprop="name">windows驱动</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Windows-Hardware-driver-submission问题记录"><a href="#Windows-Hardware-driver-submission问题记录" class="headerlink" title="Windows Hardware driver submission问题记录"></a>Windows Hardware driver submission问题记录</h1><h2 id="Driver-Update-failure-rejected-问题分析"><a href="#Driver-Update-failure-rejected-问题分析" class="headerlink" title="Driver Update failure (rejected) 问题分析"></a>Driver Update failure (rejected) 问题分析</h2><h3 id="背景描述："><a href="#背景描述：" class="headerlink" title="背景描述："></a>背景描述：</h3><p>V10700 + Hardware ID：PCI\VEN_1217&amp;DEV_8621&amp;SUBSYS_389517aa</p>
<p>在windows hardware driver submission被reject，提交单和关键信息如下：</p>
<p><a target="_blank" rel="noopener" href="https://partner.microsoft.com/en-us/dashboard/hardware/driver/14391505706251263/submission/1152921505697924694/ShippingLabel/401531646">https://partner.microsoft.com/en-us/dashboard/hardware/driver/14391505706251263/submission/1152921505697924694/ShippingLabel/401531646</a></p>
<p>Rejection Theme: Measure Failure Rejection Reason: Systemic Measure Failure Provide Measure ID(s): 26387215 ADO bugId: 55312863: Bug ID(s) and Partner ID(s): Link to documentation: Link to reliability report (if applicable): Details: Rejected because Measure ID 26387215 (Percent of machines where the driver install process completes successfully) is failing. Please read more on “<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/dashboard/pct-machines-where-driver-install-completes-successfully">https://docs.microsoft.com/en-us/windows-hardware/drivers/dashboard/pct-machines-where-driver-install-completes-successfully</a>“ See the Plug and Play Extended Flight Report document for additional information on the failures. The “driver flight report” bug can be found by searching on Collaborate with the Submission ID. More info: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/dashboard/pnp-failure-report">https://docs.microsoft.com/en-us/windows-hardware/drivers/dashboard/pnp-failure-report</a> and <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/collaborate/feedback-items-search#search">https://docs.microsoft.com/en-us/collaborate/feedback-items-search#search</a></p>
<h3 id="报告分析"><a href="#报告分析" class="headerlink" title="报告分析"></a>报告分析</h3><p>根据以上信息，在Microsoft partner center的feedback&#x2F;bugs页面找到提交单对应的failure报告：</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202501031506203.png" alt="image-20250103150628028"></p>
<p>（1）RejectionReport中的关键信息：</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202501031520135.png" alt="image-20250103152056064"></p>
<p>小结：微软测试了118个machine，其中在10台硬件平台ID PCI\VEN_1217&amp;DEV_8621&amp;SUBSYS_38DF17AA的机器上发生install failure. </p>
<p>错误码是ERROR_ACCESS_DENIED, 可能是微软环境问题或者硬件访问异常导致。</p>
<p>（2）report.html中的关键信息：</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202501031513121.png" alt="image-20250103151330025"></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202501031514877.png" alt="image-20250103151409828"></p>
<p>小结：Driver install failure基本都发生在硬件平台ID PCI\VEN_1217&amp;DEV_8621&amp;SUBSYS_38DF17AA上，而且是不带Problem Code Description &amp; Problem Status 类型的安装错误，也就是说不是PNP error引起的install failure。</p>
<h3 id="Driver分析"><a href="#Driver分析" class="headerlink" title="Driver分析"></a>Driver分析</h3><p>为了确认此install error是driver相关还是硬件平台相关（PCI\VEN_1217&amp;DEV_8621&amp;SUBSYS_38DF17AA），做如下对比：</p>
<p>1.找到相同Driver installer V10700的其他提交单，和当前failure提交单的区别只在于支持的硬件平台ID不一样：</p>
<p><a target="_blank" rel="noopener" href="https://partner.microsoft.com/en-us/dashboard/hardware/driver/14391505706251263">https://partner.microsoft.com/en-us/dashboard/hardware/driver/14391505706251263</a></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202501031536917.png" alt="image-20250103153612882"></p>
<p>2.两个提交单只有Hardware ID有区别，系统都是Win11 24H2：</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202501031534126.png" alt="image-20250103153449036"></p>
<p>3.两个提交单的微软反馈报告的区别：一个pass，一个failure（failure install发生在Bad hardware ID上）</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202501031538765.png" alt="image-20250103153815661"></p>
<p><a target="_blank" rel="noopener" href="https://partner.microsoft.com/en-us/dashboard/collaborate/engagements/5133/feedback/wits/Bugs/1056149">https://partner.microsoft.com/en-us/dashboard/collaborate/engagements/5133/feedback/wits/Bugs/1056149</a></p>
<p><a target="_blank" rel="noopener" href="https://partner.microsoft.com/en-us/dashboard/collaborate/engagements/5133/feedback/wits/Bugs/1069371">https://partner.microsoft.com/en-us/dashboard/collaborate/engagements/5133/feedback/wits/Bugs/1069371</a></p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p><strong>分析小结：</strong></p>
<p>微软的自动化测试流程发现V10700 installer在平台PCI\VEN_1217&amp;DEV_8621&amp;SUBSYS_38DF17AA上有install failure，超出了允许的failure rate（&lt;5%）,所以reject driver提交单。</p>
<p>根据Driver提交单对比分析，这不是Driver installer的问题，因为相同的driver在其他平台的提交单是100% pass，此问题只发生在平台PCI\VEN_1217&amp;DEV_8621&amp;SUBSYS_38DF17AA上。</p>
<p><strong>Debug方向：</strong></p>
<p>不确定微软是如何在平台PCI\VEN_1217&amp;DEV_8621&amp;SUBSYS_38DF17AA上测试此driver install，有可能是物理机器或者虚拟机器上测试，也就是说，不排除是微软软件环境问题引起。</p>
<p>另外一方面，如果是物理机器确实有此问题，建议检查平台PCI\VEN_1217&amp;DEV_8621&amp;SUBSYS_38DF17AA上是否有特殊系统设置，或者PCIe bug，导致Bayhub SD Host硬件有时无法访问？</p>
<p><strong>当前解决办法：</strong></p>
<p>重新提交此driver，不需要做修改，以排除是微软软件环境引起的偶然性问题。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/08/30/Windows%20PC%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/30/Windows%20PC%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">windows PC开发环境配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-08-30 17:52:38" itemprop="dateCreated datePublished" datetime="2024-08-30T17:52:38+08:00">2024-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-18 10:36:07" itemprop="dateModified" datetime="2025-11-18T10:36:07+08:00">2025-11-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/windows%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">windows系统</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="windows-PC开发环境配置"><a href="#windows-PC开发环境配置" class="headerlink" title="windows PC开发环境配置"></a>windows PC开发环境配置</h1><h2 id="多桌面和分屏"><a href="#多桌面和分屏" class="headerlink" title="多桌面和分屏"></a>多桌面和分屏</h2><p>Win+Ctrl+D， 新建桌面窗口</p>
<p>Win+Ctrl + ←&#x2F;→，切换桌面窗口</p>
<p>win+Tab， 任务视图，常用操作：拖动程序到指定窗口</p>
<p>win键+←&#x2F;→，快速分屏成两列</p>
<p>win键 + ←&#x2F;→ + ↑&#x2F;↓，快速4分屏</p>
<p>注意：多个桌面的相同应用是独立的，例如某桌面打开chrome很多页面，其他桌面打开chrome会是新网页</p>
<h2 id="区分Linux文件大小写"><a href="#区分Linux文件大小写" class="headerlink" title="区分Linux文件大小写"></a>区分Linux文件大小写</h2><p>需要4个条件：</p>
<p>Windows 10 1803以上版本<br>启用 Linux 子系统，即 Windows Subsystem for Linux<br>所在分区为 NTFS 格式<br>以管理员权限运行 PowerShell</p>
<p>必须启用WSL环境。powershell管理员运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux</span><br></pre></td></tr></table></figure>

<p>再将指定目录启用大小写 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt; fsutil.exe file setCaseSensitiveInfo C:\github enable</span><br><span class="line">已启用目录 C:\github 的区分大小写属性。</span><br></pre></td></tr></table></figure>

<p>之后解压linux kernel就不会报错同名大小写文件重复。</p>
<h2 id="未激活Windows去水印和关闭WindowsUpdate和桌面壁纸"><a href="#未激活Windows去水印和关闭WindowsUpdate和桌面壁纸" class="headerlink" title="未激活Windows去水印和关闭WindowsUpdate和桌面壁纸"></a>未激活Windows去水印和关闭WindowsUpdate和桌面壁纸</h2><p>win+R regedit设置Start值为4，去桌面水印</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\sppsvc -&gt; Start -&gt; 4</span><br></pre></td></tr></table></figure>

<p>永久关闭WindowsUpdate，否则下次Update之后又有水印</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">services.msc -&gt; Windows Update -&gt; </span><br><span class="line">(1)常规 -&gt; 禁用</span><br><span class="line">(2)恢复 -&gt; 第一次失败 -&gt; 无操作, 重置计数 -&gt; 9999</span><br></pre></td></tr></table></figure>

<p>更换壁纸：下载图片直接右键设置为壁纸</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="cursorhu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">cursorhu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">110</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">54</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/cursorhu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cursorhu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:2449055512@qq.com" title="E-Mail → mailto:2449055512@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cursorhu</span>
</div>



        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
