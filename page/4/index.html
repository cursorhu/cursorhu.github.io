<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 8.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC|Roboto/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Roboto:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"cursorhu.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="ThinkNotes">
<meta property="og:url" content="https://cursorhu.github.io/page/4/index.html">
<meta property="og:site_name" content="ThinkNotes">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="cursorhu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://cursorhu.github.io/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>ThinkNotes</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ThinkNotes</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Simple is not easy</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于我</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/08/30/Cursor%20%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%92%8C%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/30/Cursor%20%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%92%8C%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Cursor 环境配置和简单使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-08-30 15:50:54" itemprop="dateCreated datePublished" datetime="2024-08-30T15:50:54+08:00">2024-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:10:10" itemprop="dateModified" datetime="2025-11-04T17:10:10+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">AI编程</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Cursor-环境配置和简单使用"><a href="#Cursor-环境配置和简单使用" class="headerlink" title="Cursor 环境配置和简单使用"></a>Cursor 环境配置和简单使用</h1><h2 id="Cursor配置"><a href="#Cursor配置" class="headerlink" title="Cursor配置"></a>Cursor配置</h2><h3 id="free-trial续杯"><a href="#free-trial续杯" class="headerlink" title="free trial续杯"></a>free trial续杯</h3><p>Cursor website: <a target="_blank" rel="noopener" href="https://www.cursor.com/">https://www.cursor.com</a></p>
<p>Cursor’s free trial for Pro(Premium models) has limitation for two weeks time and up to 500 request count. Use below steps to get more free-trial.</p>
<p>(1) In Account Setting, Detele wasted account, and re-register account with same email address. Log in Cursor desktop and 500 pro request is supported for more two weeks.</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202502261454158.png" alt="image-20250226145359068"></p>
<p>refer to guide: <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1YAtReqEkH?spm_id_from=333.788.videopod.sections">https://www.bilibili.com/video/BV1YAtReqEkH?spm_id_from=333.788.videopod.sections</a></p>
<p>(2) After several times re-register account, Cursor record your PC’s MAC and refuse to re-register, use below tool to re-fresh MAC. </p>
<p><a target="_blank" rel="noopener" href="https://github.com/yuaotian/go-cursor-help">https://github.com/yuaotian/go-cursor-help</a></p>
<h3 id="禁用更新"><a href="#禁用更新" class="headerlink" title="禁用更新"></a>禁用更新</h3><p>目前go-cursor-help可以适配到cursor4.7，需要禁用cursor自动更新到4.8以上版本</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504091022177.png" alt="image-20250409102242119"></p>
<h2 id="Cursor使用方式"><a href="#Cursor使用方式" class="headerlink" title="Cursor使用方式"></a>Cursor使用方式</h2><h3 id="Chat"><a href="#Chat" class="headerlink" title="Chat"></a>Chat</h3><p>Chat is most used to analysis whole project code or partly code.</p>
<p>Use @codebase is better to make the AI engine think based on current code. otherwise it may give suggestions without context.</p>
<p>below is two examples:</p>
<p>(1)Analysis the project based on codebase.</p>
<p>Use CTRL+L to open chat, select AI model to claude-3.5 or 3.7(newer), write prompt based on codebase.</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202502261504728.png" alt="image-20250226150407616"></p>
<p>(2)Modifying partly function</p>
<p>Select some code to Chat, and ask what to do, you can apply the generated code. </p>
<p>If the code is wrong after test, you can reject the change like git diff GUI.</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202502261509413.png" alt="image-20250226150927338"></p>
<h3 id="Composer"><a href="#Composer" class="headerlink" title="Composer"></a>Composer</h3><p>Composer适用于创建新项目，不适用于对已有的项目局部修改，因为composer改动是跨文件的，composer模式经常会把已有项目写好的功能又改坏，建议多用git管理composer代码，调试现有项目使用Chat。</p>
<p>以下是composer创建WDF项目过程中的示例，对于AI给出的不靠谱的回答，需要用 @Web或者给定Specification document让AI反复确认。对于编译和调试问题也能让AI给出建议，但是尤其要注意AI对于windows driver这种开源资料较少的领域，给出的方案和建议有一定概率是错得离谱而且迷惑性很强。</p>
<p>（1）让AI根据Web资料修正设计</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202502261520937.png" alt="image-20250226152037888"></p>
<p>（2）让AI根据报错信息给出调试建议</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202502261521572.png" alt="image-20250226152110538"></p>
<h2 id="20250718模型禁用问题"><a href="#20250718模型禁用问题" class="headerlink" title="20250718模型禁用问题"></a>20250718模型禁用问题</h2><p>TB买学生pro一年账户登录后才有高级model，账户每月有最大请求限额约几百次，下月1号复位</p>
<p>model region限制解决：curor setting中 +梯子端口 +禁用HTTP2后可用。</p>
<p>梯子使用github free-proxy免费配clash端口，每天最多4小数</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202507181431265.png" alt="image-20250718143130155"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/08/30/Cursor%E8%AE%B0%E5%BD%95--storport-pofx-dfx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/30/Cursor%E8%AE%B0%E5%BD%95--storport-pofx-dfx/" class="post-title-link" itemprop="url">Cursor��¼-����Storport Pofx����</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-08-30 15:50:54" itemprop="dateCreated datePublished" datetime="2024-08-30T15:50:54+08:00">2024-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:13:23" itemprop="dateModified" datetime="2025-11-04T17:13:23+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI%EF%BF%BD%EF%BF%BD%EF%BF%BD/" itemprop="url" rel="index"><span itemprop="name">AI���</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Cursor��¼-����Storport Pofx����</p>
<h1 id="Chat-Transcript-Tab-1"><a href="#Chat-Transcript-Tab-1" class="headerlink" title="Chat Transcript - Tab 1"></a>Chat Transcript - Tab 1</h1><h2 id="User"><a href="#User" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>@Codebase @Web ����һ��Storport miniport �������һ��ɵ�Դ������ع��������⣬ ���ѯStorport�ĵ��Լ�Windows driver Pofx��DFx(Direct Pofx)�ĵ�����������</p>
<h2 id="AI-claude-3-5-sonnet"><a href="#AI-claude-3-5-sonnet" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��������һ����������ĵ�Դ������ش���:</p>
<ol>
<li>��Ҫ�ĵ�Դ�������������¼����ļ���:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br></pre></td><td class="code"><pre><span class="line">void pm_init(bht_dev_ext_t * pdx)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_MAIN_PM, FEATURE_DRIVER_INIT, 0, &quot;Enter %s chip:%xh\n&quot;, __FUNCTION__, pdx-&gt;host.chip_type);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //TODO: RTD3 enable From the registry</span><br><span class="line"></span><br><span class="line">    pdx-&gt;pm_state.s3s4_entered = FALSE;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;pm_state.rtd3_en = hostven_rtd3_check(&amp;pdx-&gt;host);</span><br><span class="line"></span><br><span class="line">    pdx-&gt;pm_state.rtd3_entered = FALSE;</span><br><span class="line">    pdx-&gt;pm_state.s5_entered = FALSE;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;pm_state.warm_boot_entered = FALSE;</span><br><span class="line"></span><br><span class="line">    hostven_pm_mode_cfg(&amp;pdx-&gt;host, &amp;(pdx-&gt;pm_state));</span><br><span class="line"></span><br><span class="line">    os_pm_init(pdx);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_MAIN_PM, FEATURE_PM_TRACE, 0, &quot;Exit %s\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> void SetSlowLTRNoRequire(sd_host_t * host)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">	if (host-&gt;cfg-&gt;issue_fix_item.ltr_c10_patch.enable_ltr_patch)</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		if (host-&gt;chip_type == CHIP_FUJIN2 || host-&gt;chip_type == CHIP_SEABIRD)</span><br><span class="line"></span><br><span class="line">		&#123;</span><br><span class="line"></span><br><span class="line">            pci_andl(host, 0x3e8, 0x7fff7fff);</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">            pci_orl(host, 0x3e8, 0x20000000);</span><br><span class="line"></span><br><span class="line">             DbgInfo(MODULE_SD_HOST, FEATURE_CARD_INIT , NOT_TO_RAM,&quot;SetSlowLTRNoRequire\n&quot;);</span><br><span class="line"></span><br><span class="line">			//DbgInfo((&quot;no LTR\n&quot;));</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> void SetSlowLTRRequire_when_Enabledriver(sd_host_t* host)</span><br><span class="line"></span><br><span class="line"> &#123;</span><br><span class="line"></span><br><span class="line">     if (!host-&gt;cfg-&gt;issue_fix_item.ltr_c10_patch.enable_ltr_patch)</span><br><span class="line"></span><br><span class="line">     &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">         if (host-&gt;chip_type == CHIP_FUJIN2 || host-&gt;chip_type == CHIP_SEABIRD)</span><br><span class="line"></span><br><span class="line">         &#123;</span><br><span class="line"></span><br><span class="line">             pci_orw(host, 0x3e8, 0x8000);</span><br><span class="line"></span><br><span class="line">             pci_orl(host, 0x3e8, 0x20000000);</span><br><span class="line"></span><br><span class="line">             DbgInfo(MODULE_SD_HOST, FEATURE_CARD_INIT, NOT_TO_RAM, &quot;SetSlowLTRNoRequire When Enable Driver\n&quot;);</span><br><span class="line"></span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line">...</span><br><span class="line">void pcr_part_a_backup(bht_dev_ext_t * pdx)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    if(pdx-&gt;cfg-&gt;driver_item.backup_part_a)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        //enable or disable LED output or not.</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0xdc = pci_readl(&amp;pdx-&gt;host, 0xdc);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //disable or enable RTD3</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x3e0	= pci_readl(&amp;pdx-&gt;host, 0x3e0);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x3e8 = pci_readl(&amp;pdx-&gt;host, 0x3e8);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x3ec = pci_readl(&amp;pdx-&gt;host, 0x3ec);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //Change the ASPM L0s Exit Latency</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0xf4 = pci_readl(&amp;pdx-&gt;host, 0xf4);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //ep nfts value</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x74  = pci_readl(&amp;pdx-&gt;host, 0x74);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //Power saving mode setting</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0xf0 = pci_readl(&amp;pdx-&gt;host, 0xf0);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //enable or disable ASPM L0s&amp;L1</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x90  =  pci_readl(&amp;pdx-&gt;host, 0x90);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void pcr_part_b_backup(bht_dev_ext_t * pdx)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    if(pdx-&gt;cfg-&gt;driver_item.backup_part_b)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x64 = pci_readl(&amp;pdx-&gt;host, 0x64);</span><br><span class="line"></span><br><span class="line">        //skt power control output enable</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0xec = pci_readl(&amp;pdx-&gt;host, 0xec);</span><br><span class="line"></span><br><span class="line">        //ocb cntl timer</span><br><span class="line">        //ocb cntl enable</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0xd4 = pci_readl(&amp;pdx-&gt;host, 0xd4);</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x3e4 = pci_readl(&amp;pdx-&gt;host, 0x3e4);</span><br><span class="line"></span><br><span class="line">        //PLL DM</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x304 = pci_readl(&amp;pdx-&gt;host, 0x304);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //Set Base Clock Frequency</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x328 = pci_readl(&amp;pdx-&gt;host, 0x328);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //Set DLL tuning window</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x300 = pci_readl(&amp;pdx-&gt;host, 0x300);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //aux power LDO</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x68 = pci_readl(&amp;pdx-&gt;host, 0x68);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //Adjust the output delay for SD2.0 high speed mode</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x350 = pci_readl(&amp;pdx-&gt;host, 0x350);</span><br><span class="line"></span><br><span class="line">        //T_EIDL_ENTRY</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x35c = pci_readl(&amp;pdx-&gt;host, 0x35c);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //disable bit for UHSII term_resistor_calibration</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x3e0 = pci_readl(&amp;pdx-&gt;host, 0x3e0);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //Set the Max power supply capability of SD host</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x334	= pci_readl(&amp;pdx-&gt;host, 0x334);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //external enable polarity control pin</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0xd8 = pci_readl(&amp;pdx-&gt;host, 0xd8);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //AOSC off support</span><br><span class="line">        pdx-&gt;pm_state.reg_0x3f0 = pci_readl(&amp;pdx-&gt;host, 0x3f0);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //max read request size</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x88 =  pci_readl(&amp;pdx-&gt;host, 0x88);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //UHSII DLL watch dog</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x33c = pci_readl(&amp;pdx-&gt;host, 0x33c);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //PCI-PM L1 entrance timer</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0xe0 = pci_readl(&amp;pdx-&gt;host, 0xe0);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //ASPM L1 entrance timer</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0xfc = pci_readl(&amp;pdx-&gt;host, 0xfc);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void pcr_part_a_restore(bht_dev_ext_t * pdx)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    if(pdx-&gt;cfg-&gt;driver_item.backup_part_a)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line"></span><br><span class="line">        The register mapping way to write register must be in D0 state(at which device register is mapped to PCIe BAR space).</span><br><span class="line"></span><br><span class="line">        In D3 state, the register access is invalid and return 0xFF.</span><br><span class="line"></span><br><span class="line">        Refer to:</span><br><span class="line"></span><br><span class="line">        StorPortWriteRegisterBufferUlong: The given Register must be in a mapped memory space range that was returned by StorPortGetDeviceBase</span><br><span class="line"></span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">        Usually this ScsiSetRunningConfig is after receive ScsiAdapterPower - D0 and it&#x27;s in D0 state, </span><br><span class="line"></span><br><span class="line">        but in some platform AMD or BIOS difference, the operation is in D3 (storport allows it)</span><br><span class="line">        When PCI config register is accessed in D3, must use PORT access to write register, StorPortSetBusDataByOffset can only be used in ScsiSetRunningConfig in AdapterControl.</span><br><span class="line"></span><br><span class="line">        Refer to:</span><br><span class="line"></span><br><span class="line">        https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ne-storport-scsi_adapter_control_type</span><br><span class="line"></span><br><span class="line">        https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportsetbusdatabyoffset</span><br><span class="line"></span><br><span class="line">        */</span><br><span class="line"></span><br><span class="line">        if (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD0) &#123;</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0xdc, pdx-&gt;pm_state.reg_0xdc);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x3e0, pdx-&gt;pm_state.reg_0x3e0);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x3e8, pdx-&gt;pm_state.reg_0x3e8);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x3ec, pdx-&gt;pm_state.reg_0x3ec);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0xf4, pdx-&gt;pm_state.reg_0xf4);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x74, pdx-&gt;pm_state.reg_0x74);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0xf0, pdx-&gt;pm_state.reg_0xf0);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x90, pdx-&gt;pm_state.reg_0x90);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        else &#123; //D3</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0xdc, pdx-&gt;pm_state.reg_0xdc);</span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x3e0, pdx-&gt;pm_state.reg_0x3e0);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x3e8, pdx-&gt;pm_state.reg_0x3e8);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x3ec, pdx-&gt;pm_state.reg_0x3ec);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0xf4, pdx-&gt;pm_state.reg_0xf4);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x74, pdx-&gt;pm_state.reg_0x74);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0xf0, pdx-&gt;pm_state.reg_0xf0);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x90, pdx-&gt;pm_state.reg_0x90);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void pcr_part_b_restore(bht_dev_ext_t * pdx)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    if(pdx-&gt;cfg-&gt;driver_item.backup_part_b)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD0) &#123;</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x64, pdx-&gt;pm_state.reg_0x64);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0xec, pdx-&gt;pm_state.reg_0xec);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0xd4, pdx-&gt;pm_state.reg_0xd4);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x304, pdx-&gt;pm_state.reg_0x304);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x328, pdx-&gt;pm_state.reg_0x328);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x300, pdx-&gt;pm_state.reg_0x300);</span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x3e4, pdx-&gt;pm_state.reg_0x3e4);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x68, pdx-&gt;pm_state.reg_0x68);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x350, pdx-&gt;pm_state.reg_0x350);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x35c, pdx-&gt;pm_state.reg_0x35c);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x3e0, pdx-&gt;pm_state.reg_0x3e0);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x334, pdx-&gt;pm_state.reg_0x334);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0xd8, pdx-&gt;pm_state.reg_0xd8);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x3f0, pdx-&gt;pm_state.reg_0x3f0);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x88, pdx-&gt;pm_state.reg_0x88);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x33c, pdx-&gt;pm_state.reg_0x33c);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0xe0, pdx-&gt;pm_state.reg_0xe0);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0xfc, pdx-&gt;pm_state.reg_0xfc);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        else &#123;</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x64, pdx-&gt;pm_state.reg_0x64);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0xec, pdx-&gt;pm_state.reg_0xec);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0xd4, pdx-&gt;pm_state.reg_0xd4);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x304, pdx-&gt;pm_state.reg_0x304);</span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x328, pdx-&gt;pm_state.reg_0x328);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x300, pdx-&gt;pm_state.reg_0x300);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x3e4, pdx-&gt;pm_state.reg_0x3e4);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x68, pdx-&gt;pm_state.reg_0x68);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x350, pdx-&gt;pm_state.reg_0x350);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x35c, pdx-&gt;pm_state.reg_0x35c);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x3e0, pdx-&gt;pm_state.reg_0x3e0);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x334, pdx-&gt;pm_state.reg_0x334);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0xd8, pdx-&gt;pm_state.reg_0xd8);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x3f0, pdx-&gt;pm_state.reg_0x3f0);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x88, pdx-&gt;pm_state.reg_0x88);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x33c, pdx-&gt;pm_state.reg_0x33c);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0xe0, pdx-&gt;pm_state.reg_0xe0);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0xfc, pdx-&gt;pm_state.reg_0xfc);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void failsafe_fct(bht_dev_ext_t * pdx)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     if(pdx-&gt;pm_state.s3s4_entered)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">    	if(1 == pdx-&gt;cfg-&gt;driver_item.failsafe_en)</span><br><span class="line"></span><br><span class="line">		pci_orl(&amp;(pdx-&gt;host), 0x3E0, BIT6);//Failsafe enable</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void req_enter_d3(bht_dev_ext_t * pdx)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_MAIN_PM, FEATURE_PM_TRACE, 0, &quot;Enter %s\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    func_autotimer_stop(pdx);</span><br><span class="line"></span><br><span class="line">    card_power_off(&amp;(pdx-&gt;card), FALSE);</span><br><span class="line"></span><br><span class="line">    thermal_uninit(pdx);</span><br><span class="line"></span><br><span class="line">    host_int_sig_dis(&amp;(pdx-&gt;host), 0xffffffff);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //if(pdx-&gt;pm_state.s3s4_entered &amp;&amp; pdx-&gt;cfg-&gt;driver_item.removable == TRUE)</span><br><span class="line"></span><br><span class="line">	//if (pdx-&gt;pm_state.s3s4_entered || pdx-&gt;pm_state.rtd3_entered)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        pdx-&gt;card.initialized_once = FALSE;</span><br><span class="line"></span><br><span class="line">        card_stuct_init(pdx);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //if(pdx-&gt;pm_state.d3_silc_en)</span><br><span class="line"></span><br><span class="line">    //&#123;</span><br><span class="line"></span><br><span class="line">    //backup register value into the registry</span><br><span class="line"></span><br><span class="line">    //os_bak_reg_hibernate();</span><br><span class="line"></span><br><span class="line">    //&#125;</span><br><span class="line"></span><br><span class="line">    //failsafe_fct(pdx);</span><br><span class="line"></span><br><span class="line">    pcr_part_a_backup(pdx);</span><br><span class="line"></span><br><span class="line">    pcr_part_b_backup(pdx);</span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_MAIN_PM, FEATURE_PM_TRACE, 0, &quot;Exit %s\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN</span><br><span class="line"></span><br><span class="line">Adapter_PoFx_Enabled(</span><br><span class="line"></span><br><span class="line">    _In_ void * AdapterExtension</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t * pdx = (bht_dev_ext_t *)AdapterExtension;</span><br><span class="line"></span><br><span class="line">    return (pdx-&gt;os.StateFlags.PoFxEnabled == 1);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BOOLEAN</span><br><span class="line"></span><br><span class="line">Adapter_Acquire_Active_Reference(</span><br><span class="line"></span><br><span class="line">    _In_ bht_dev_ext_t * AdapterExtension,</span><br><span class="line"></span><br><span class="line">    _Inout_opt_ PBOOLEAN		 InIdle</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    BOOLEAN idle = FALSE;</span><br><span class="line"></span><br><span class="line">    BOOLEAN referenceAcquired = FALSE;</span><br><span class="line"></span><br><span class="line">    ULONG status = 0;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_OS_ENTRYAPI, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;Enter %s\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line">    if(Adapter_PoFx_Enabled(AdapterExtension))</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        status = StorPortPoFxActivateComponent(AdapterExtension,</span><br><span class="line"></span><br><span class="line">                                               NULL,</span><br><span class="line"></span><br><span class="line">                                               NULL,</span><br><span class="line"></span><br><span class="line">                                               0,</span><br><span class="line"></span><br><span class="line">                                               0);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        DbgInfo(MODULE_OS_ENTRYAPI, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;StorPortPoFxActivateComponent=%x\n&quot;, status);</span><br><span class="line"></span><br><span class="line">        // STOR_STATUS_BUSY indicates that ActivateComponent is not completed yet.</span><br><span class="line"></span><br><span class="line">        idle = (status == STOR_STATUS_BUSY);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if((status == STOR_STATUS_SUCCESS) || (status == STOR_STATUS_BUSY))</span><br><span class="line"></span><br><span class="line">            referenceAcquired = TRUE;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if(InIdle != NULL)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        *InIdle = idle;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_OS_ENTRYAPI, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;Exit %s, referenceAcquired:%x\n&quot;, __FUNCTION__, referenceAcquired);</span><br><span class="line"></span><br><span class="line">    return referenceAcquired;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VOID</span><br><span class="line"></span><br><span class="line">Adapter_Release_Active_Reference(</span><br><span class="line"></span><br><span class="line">    _In_ bht_dev_ext_t * AdapterExtension</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    ULONG status = 0;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if(Adapter_PoFx_Enabled(AdapterExtension))</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        status = StorPortPoFxIdleComponent(AdapterExtension,</span><br><span class="line"></span><br><span class="line">                                           NULL,</span><br><span class="line"></span><br><span class="line">                                           NULL,</span><br><span class="line"></span><br><span class="line">                                           0,</span><br><span class="line"></span><br><span class="line">                                           0);</span><br><span class="line"></span><br><span class="line">        DbgInfo(MODULE_OS_ENTRYAPI, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;StorPortPoFxIdleComponent=%x\n&quot;, status);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ol start="2">
<li>���ֵ�Ǳ������:</li>
</ol>
<p>a) PoFx ʵ�ֲ�����:</p>
<ul>
<li>����ʹ����StorPortPoFxActivateComponent&#x2F;StorPortPoFxIdleComponent,��û����ȷʵ��������PoFx�ص�</li>
<li>ȱ�ٶ�F-state transitions�Ĵ���</li>
<li>û��ʵ��StorPortPoFxPowerControl�ص�</li>
</ul>
<p>b) D-state ת����������:</p>
<ul>
<li>D3״̬�µļĴ������ʿ���������</li>
<li>��D3״̬����Ȼ���Է����豸�Ĵ���,���ǲ�������</li>
<li>D0��D3��ת��������û����ȷ����ͻָ��豸״̬</li>
</ul>
<p>c) ����Ľ�:</p>
<ol>
<li>����PoFx֧��:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ���ӱ�Ҫ��PoFx�ص�</span></span><br><span class="line">STOR_POFX_COMPONENT_IDLE_STATE_CALLBACK IdleStateCallback;</span><br><span class="line">STOR_POFX_COMPONENT_ACTIVE_CONDITION_CALLBACK ActiveConditionCallback;</span><br><span class="line">STOR_POFX_COMPONENT_IDLE_CONDITION_CALLBACK IdleConditionCallback;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>��ȷ����D-stateת��:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// D3״̬�±�������豸�Ĵ���</span></span><br><span class="line"><span class="keyword">if</span> (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD3) &#123;</span><br><span class="line">    <span class="comment">// ʹ�����ÿռ����</span></span><br><span class="line">    StorPortSetBusDataByOffset();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ���������豸�Ĵ���</span></span><br><span class="line">    StorPortWriteRegisterUlong();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ʵ��DFx֧��:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">STOR_DFX_SETTINGS DfxSettings;</span><br><span class="line">DfxSettings.Version = STOR_DFX_SETTINGS_VERSION_V1;</span><br><span class="line">DfxSettings.Size = <span class="keyword">sizeof</span>(STOR_DFX_SETTINGS); </span><br><span class="line">StorPortInitializeDfx();</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>���Ƶ�Դ״̬ת��:</li>
</ol>
<ul>
<li>�ڽ���D3ǰ�������б�Ҫ���豸״̬</li>
<li>�ڻָ�D0ʱ��ȷ�ָ��豸״̬</li>
<li>ʵ����ȷ��idle��ʱ����</li>
</ul>
<ol start="5">
<li>�Ľ�������:</li>
</ol>
<ul>
<li>���Ӹ���Ĵ�����ͻָ�����</li>
<li>ʵ�������ĵ�Դ���ϻָ�����</li>
</ul>
<p>��Щ�Ľ����԰�����������ĵ�Դ�����ɿ��Ժ����ܡ�����ο����µ�Windows���������ĵ�������Ӧ�ĸ��¡�</p>
<h2 id="User-1"><a href="#User-1" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>ע�⣬���Ǹ�miniport����������·��� @Codebase @Web </p>
<h2 id="AI-claude-3-5-sonnet-1"><a href="#AI-claude-3-5-sonnet-1" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>���ݴ���������ҷ������Storport miniport�����ĵ�Դ����ʵ�ִ������¼�����Ҫ����:</p>
<ol>
<li>PoFxʵ�ֲ�����:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">pdx-&gt;os.AdptPoFxDevice.Version = STOR_POFX_DEVICE_VERSION_V2;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Size = STOR_POFX_DEVICE_V2_SIZE;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.ComponentCount = 1;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// indicate dump miniport can&#x27;t bring adapter to active</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_NO_DUMP_ACTIVE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].Version = STOR_POFX_COMPONENT_VERSION_V1;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].Size = STOR_POFX_COMPONENT_SIZE;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].FStateCount = 1;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].DeepestWakeableFState = 0;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].Id = STORPORT_POFX_ADAPTER_GUID;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].Version = STOR_POFX_COMPONENT_IDLE_STATE_VERSION_V1;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].Size = STOR_POFX_COMPONENT_IDLE_STATE_SIZE;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].TransitionLatency = 0;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].ResidencyRequirement = 0;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].NominalPower = STOR_POFX_UNKNOWN_POWER;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// registry runtime power management for Adapter</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_IDLE_TIMEOUT;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_ADAPTER_D3_WAKE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//pdx-&gt;os.AdptPoFxDevice.AdapterIdleTimeoutInMS = 1000; //10ms Idle tiemout for D3.</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.AdapterIdleTimeoutInMS = pdx-&gt;cfg-&gt;feature_item.psd_mode.adapter_idle_time_s * 1000; //The unit is 1ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">status = StorPortInitializePoFxPower(DeviceExtension, NULL, (PSTOR_POFX_DEVICE)(&amp;(pdx-&gt;os.AdptPoFxDevice)), &amp;enableD3Cold);</span><br><span class="line"></span><br><span class="line">DbgInfo(MODULE_OS_ENTRY, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;%s StorPortInitializePoFxPower=%x,enableD3Cold=%x\n&quot;,</span><br><span class="line"></span><br><span class="line">        __TIME__, status, enableD3Cold);</span><br><span class="line"></span><br><span class="line">DbgInfo(MODULE_OS_ENTRY, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;pdx-&gt;os.AdptPoFxDevice.AdapterIdleTimeoutInMS =%d ,pdx-&gt;os.AdptPoFxDevice.Flags=%x , STOR_STATUS_SUCCESS=%x\n&quot;,</span><br><span class="line"></span><br><span class="line">        pdx-&gt;os.AdptPoFxDevice.AdapterIdleTimeoutInMS, pdx-&gt;os.AdptPoFxDevice.Flags, STOR_STATUS_SUCCESS);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if(status != STOR_STATUS_SUCCESS)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.StateFlags.PoFxEnabled = FALSE;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.StateFlags.PoFxActive = FALSE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    goto Exit;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ul>
<li>��Ȼ��ʼ����PoFx�豸,��ȱ�ٹؼ��Ļص�����ʵ��</li>
<li>û��ʵ��ScsiAdapterPoFxPowerControl����</li>
<li>F-stateת������������</li>
</ul>
<ol start="2">
<li>D-stateת������:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">void req_enter_d3(bht_dev_ext_t * pdx)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_MAIN_PM, FEATURE_PM_TRACE, 0, &quot;Enter %s\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    func_autotimer_stop(pdx);</span><br><span class="line"></span><br><span class="line">    card_power_off(&amp;(pdx-&gt;card), FALSE);</span><br><span class="line"></span><br><span class="line">    thermal_uninit(pdx);</span><br><span class="line"></span><br><span class="line">    host_int_sig_dis(&amp;(pdx-&gt;host), 0xffffffff);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //if(pdx-&gt;pm_state.s3s4_entered &amp;&amp; pdx-&gt;cfg-&gt;driver_item.removable == TRUE)</span><br><span class="line"></span><br><span class="line">	//if (pdx-&gt;pm_state.s3s4_entered || pdx-&gt;pm_state.rtd3_entered)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        pdx-&gt;card.initialized_once = FALSE;</span><br><span class="line"></span><br><span class="line">        card_stuct_init(pdx);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //if(pdx-&gt;pm_state.d3_silc_en)</span><br><span class="line"></span><br><span class="line">    //&#123;</span><br><span class="line"></span><br><span class="line">    //backup register value into the registry</span><br><span class="line"></span><br><span class="line">    //os_bak_reg_hibernate();</span><br><span class="line"></span><br><span class="line">    //&#125;</span><br><span class="line"></span><br><span class="line">    //failsafe_fct(pdx);</span><br><span class="line"></span><br><span class="line">    pcr_part_a_backup(pdx);</span><br><span class="line"></span><br><span class="line">    pcr_part_b_backup(pdx);</span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_MAIN_PM, FEATURE_PM_TRACE, 0, &quot;Exit %s\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ul>
<li>D3״̬�µļĴ������ʿ���������</li>
<li>����D3״̬ʱû�����������豸״̬</li>
<li>��D3�ָ�ʱû����ȷ�ָ�����״̬</li>
</ul>
<ol start="3">
<li>Runtime D3(RTD3)ʵ������:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">    DbgInfo(MODULE_VEN_HOST, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;Enter %s\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line">    if(host-&gt;chip_type == CHIP_SEAEAGLE2)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        if(rtd3_setting.rtd3_ctrl_mode)</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            d3_mode = rtd3_setting.d3_work_mode_sel;</span><br><span class="line"></span><br><span class="line">            pci_andl(host, 0x3f0, ~(3 &lt;&lt; 28));</span><br><span class="line"></span><br><span class="line">            pci_orl(host, 0x3f0, (d3_mode &amp; 3) &lt;&lt; 28);</span><br><span class="line"></span><br><span class="line">            pci_andl(host, 0x3f0, ~(1 &lt;&lt; 26));</span><br><span class="line"></span><br><span class="line">            pci_orl(host, 0x3f0, (rtd3_setting.d3silence_submode_sel &lt;&lt; 26));</span><br><span class="line"></span><br><span class="line">            *d3_submode = rtd3_setting.d3silence_submode_sel;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        else</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            d3_mode = (pci_readl(host, 0x3f0) &gt;&gt; 28) &amp; 3;</span><br><span class="line"></span><br><span class="line">            *d3_submode = (pci_readl(host, 0x3f0) &gt;&gt; 26) &amp; 1;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_VEN_HOST, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;Exit %s, D3 mode:%x\n&quot;, __FUNCTION__, d3_mode);</span><br><span class="line"></span><br><span class="line">    return d3_mode;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ul>
<li>RTD3ģʽѡ���߼�������</li>
<li>ȱ�ٶ�RTD3 wake-up�Ĵ���</li>
<li>RTD3״̬�µĵ�Դ����������</li>
</ul>
<p>����Ľ�:</p>
<ol>
<li>����PoFx֧��:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ���ӱ�Ҫ��PoFx�ص�</span></span><br><span class="line">STOR_POFX_DEVICE_SETTINGS PoFxSettings = &#123;</span><br><span class="line">    .Version = STOR_POFX_SETTINGS_VERSION_V1,</span><br><span class="line">    .Size = <span class="keyword">sizeof</span>(STOR_POFX_DEVICE_SETTINGS),</span><br><span class="line">    .ComponentIdleStateCallback = ComponentIdleStateCallback,</span><br><span class="line">    .ComponentActiveConditionCallback = ComponentActiveConditionCallback,</span><br><span class="line">    .ComponentIdleConditionCallback = ComponentIdleConditionCallback</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>�Ľ�D-stateת��:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">EnterD3State</span><span class="params">(<span class="type">bht_dev_ext_t</span> *pdx)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. ֹͣ����I/O</span></span><br><span class="line">    StopAllIO(pdx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����豸״̬</span></span><br><span class="line">    SaveDeviceState(pdx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �ر��豸��Դ</span></span><br><span class="line">    DisableDevicePower(pdx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����״̬��־</span></span><br><span class="line">    pdx-&gt;pm_state.d0d3_state = StorPowerDeviceD3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>����RTD3֧��:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">HandleRTD3Transition</span><span class="params">(<span class="type">bht_dev_ext_t</span> *pdx)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. ���RTD3����</span></span><br><span class="line">    <span class="keyword">if</span> (!CanEnterRTD3(pdx)) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_UNSUCCESSFUL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����RTD3������</span></span><br><span class="line">    SaveRTD3Context(pdx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���û�������</span></span><br><span class="line">    ConfigureWakeSettings(pdx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����RTD3</span></span><br><span class="line">    EnterRTD3State(pdx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>���ӵ�Դ״̬���:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">MonitorPowerState</span><span class="params">(<span class="type">bht_dev_ext_t</span> *pdx)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. ��¼״̬ת��</span></span><br><span class="line">    LogPowerStateTransition(pdx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ع���</span></span><br><span class="line">    MonitorPowerConsumption(pdx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����쳣</span></span><br><span class="line">    DetectPowerAnomalies(pdx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>ʵ��������DFx֧��:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">InitializeDFx</span><span class="params">(<span class="type">bht_dev_ext_t</span> *pdx)</span> &#123;</span><br><span class="line">    STOR_DFX_SETTINGS DfxSettings;</span><br><span class="line">    DfxSettings.Version = STOR_DFX_SETTINGS_VERSION_V1;</span><br><span class="line">    DfxSettings.Size = <span class="keyword">sizeof</span>(STOR_DFX_SETTINGS);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����DFx����</span></span><br><span class="line">    ConfigureDFxSettings(&amp;DfxSettings);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> StorPortInitializeDfx(pdx, &amp;DfxSettings);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Щ�Ľ�����:</p>
<ol>
<li>��ߵ�Դ�����Ŀɿ���</li>
<li>�Ż����Ŀ���</li>
<li>�����豸�ڲ�ͬ��Դ״̬�µ���Ϊ</li>
<li>�ṩ���õĵ��Ժ��������</li>
</ol>
<p>����ο����µ�Windows���������ĵ�������Ӧ���¡�</p>
<h2 id="User-2"><a href="#User-2" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����Щ�������WIndows Storport Miniport�淶��</p>
<h2 id="AI-claude-3-5-sonnet-2"><a href="#AI-claude-3-5-sonnet-2" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�������»��� Storport Miniport �淶�������ͽ���:</p>
<ol>
<li>Storport PoFx ֧��Ӧ��ͨ�����·�ʽʵ��:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. �� HwInitialize �г�ʼ�� PoFx</span></span><br><span class="line">BOOLEAN <span class="title function_">HwInitialize</span><span class="params">(PVOID DeviceExtension)</span> &#123;</span><br><span class="line">    PSTOR_POFX_DEVICE pPoFxDevice = &amp;pdx-&gt;os.AdptPoFxDevice;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���� PoFx �豸</span></span><br><span class="line">    pPoFxDevice-&gt;Version = STOR_POFX_DEVICE_VERSION_V2;</span><br><span class="line">    pPoFxDevice-&gt;Size = STOR_POFX_DEVICE_V2_SIZE;</span><br><span class="line">    pPoFxDevice-&gt;ComponentCount = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ÿ��г�ʱ</span></span><br><span class="line">    pPoFxDevice-&gt;Flags |= STOR_POFX_DEVICE_FLAG_IDLE_TIMEOUT;</span><br><span class="line">    pPoFxDevice-&gt;AdapterIdleTimeoutInMS = IdleTimeoutValue;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ�� PoFx</span></span><br><span class="line">    status = StorPortInitializePoFxPower(DeviceExtension, </span><br><span class="line">                                       <span class="literal">NULL</span>,</span><br><span class="line">                                       pPoFxDevice,</span><br><span class="line">                                       &amp;enableD3Cold);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>��ȷʵ�� ScsiAdapterControl ������Դ״̬ת��:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">SCSI_ADAPTER_CONTROL_STATUS </span><br><span class="line">HwAdapterControl(</span><br><span class="line">    IN PVOID DeviceExtension,</span><br><span class="line">    IN SCSI_ADAPTER_CONTROL_TYPE ControlType,</span><br><span class="line">    IN PVOID Parameters</span><br><span class="line">    )</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    switch(ControlType) &#123;</span><br><span class="line">        case ScsiAdapterPowerState:</span><br><span class="line">            PSCSI_ADAPTER_CONTROL_POWER Power = </span><br><span class="line">                (PSCSI_ADAPTER_CONTROL_POWER)Parameters;</span><br><span class="line">            </span><br><span class="line">            switch(Power-&gt;PowerState) &#123;</span><br><span class="line">                case StorPowerDeviceD0:</span><br><span class="line">                    // �� D3 �ָ�</span><br><span class="line">                    RestoreFromD3(pdx);</span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                case StorPowerDeviceD3:</span><br><span class="line">                    // ���� D3</span><br><span class="line">                    PrepareForD3(pdx);</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case ScsiAdapterPoFxPowerRequired:</span><br><span class="line">            // ���� PoFx ��������</span><br><span class="line">            HandlePoFxActivation(pdx);</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case ScsiAdapterPoFxPowerActive:</span><br><span class="line">            // ���� PoFx �������</span><br><span class="line">            HandlePoFxActiveComplete(pdx);</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return ScsiAdapterControlSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>��ȷ�� D3 ״̬����:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">void PrepareForD3(bht_dev_ext_t *pdx) &#123;</span><br><span class="line">    // 1. ֹͣ���� I/O</span><br><span class="line">    StorPortPause(pdx);</span><br><span class="line">    </span><br><span class="line">    // 2. �����ж�</span><br><span class="line">    StorPortDisableInterrupts(pdx);</span><br><span class="line">    </span><br><span class="line">    // 3. �����Ҫ�ļĴ���״̬</span><br><span class="line">    pcr_part_a_backup(pdx);</span><br><span class="line">    pcr_part_b_backup(pdx);</span><br><span class="line">    </span><br><span class="line">    // 4. �ر��豸��Դ</span><br><span class="line">    card_power_off(&amp;(pdx-&gt;card), FALSE);</span><br><span class="line">    </span><br><span class="line">    // 5. ����״̬</span><br><span class="line">    pdx-&gt;pm_state.d0d3_state = StorPowerDeviceD3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void RestoreFromD3(bht_dev_ext_t *pdx) &#123;</span><br><span class="line">    // 1. �ָ��Ĵ���״̬</span><br><span class="line">    pcr_part_a_restore(pdx);</span><br><span class="line">    pcr_part_b_restore(pdx);</span><br><span class="line">    </span><br><span class="line">    // 2. ���³�ʼ���豸</span><br><span class="line">    host_init(&amp;pdx-&gt;host);</span><br><span class="line">    </span><br><span class="line">    // 3. �����ж�</span><br><span class="line">    StorPortEnableInterrupts(pdx);</span><br><span class="line">    </span><br><span class="line">    // 4. �ָ� I/O</span><br><span class="line">    StorPortResume(pdx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>���� RTD3 ��֧��:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// �� HwFindAdapter ��ע�� RTD3 ֧��</span><br><span class="line">BOOLEAN HwFindAdapter(</span><br><span class="line">    PVOID DeviceExtension,</span><br><span class="line">    HW_INITIALIZATION_DATA *HwInitializationData)</span><br><span class="line">&#123;</span><br><span class="line">    // ���� RTD3 ֧�ֱ�־</span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_ADAPTER_D3_WAKE;</span><br><span class="line">    </span><br><span class="line">    // ���� RTD3 ��������</span><br><span class="line">    if (pdx-&gt;cfg-&gt;feature_item.rtd3_support) &#123;</span><br><span class="line">        ConfigureRTD3WakeSettings(pdx);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ��Ľ�����:</p>
<ol>
<li>�ϸ���ѭ Storport �ĵ�Դ�����ӿ�:</li>
</ol>
<ul>
<li>ʹ�� StorPortInitializePoFxPower ��ʼ��</li>
<li>��ȷʵ�� ScsiAdapterControl �ص�</li>
<li>ʹ�� StorPort �ṩ�ĵ�Դ���� API</li>
</ul>
<ol start="2">
<li>��ȷ�����ж�:</li>
</ol>
<ul>
<li>D3 ǰ�����ж�</li>
<li>D0 ʱ���������ж�</li>
</ul>
<ol start="3">
<li>�Ĵ�������:</li>
</ol>
<ul>
<li>D3 ״̬�±���ֱ�ӷ����豸�Ĵ���</li>
<li>ʹ�� StorPortGetDeviceBase �� StorPortWriteRegisterUlong �Ƚӿ�</li>
</ul>
<ol start="4">
<li>����ָ�:</li>
</ol>
<ul>
<li>ʵ�������Ĵ�����ͻָ�����</li>
<li>ʹ�� StorPort �ṩ�Ĵ���������</li>
</ul>
<p>��Щ���鶼���� Microsoft Storport Miniport �����淶��������������Ŀɿ��Ժͼ����ԡ�</p>
<h2 id="User-3"><a href="#User-3" class="headerlink" title="User:"></a>User:</h2><p>[selections]  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> ScsiAdapterPoFxPowerRequired:</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ���� PoFx ��������</span></span><br><span class="line"></span><br><span class="line">            HandlePoFxActivation(pdx);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> ScsiAdapterPoFxPowerActive:</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ���� PoFx �������</span></span><br><span class="line"></span><br><span class="line">            HandlePoFxActiveComplete(pdx);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>[text]<br>�����ⲿ�����ʵ��:</p>
<h2 id="AI-claude-3-5-sonnet-3"><a href="#AI-claude-3-5-sonnet-3" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>���� Storport Miniport �淶���������ص���ʵ��Ӧ������:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">SCSI_ADAPTER_CONTROL_STATUS </span><br><span class="line">HwAdapterControl(</span><br><span class="line">    IN PVOID DeviceExtension,</span><br><span class="line">    IN SCSI_ADAPTER_CONTROL_TYPE ControlType,</span><br><span class="line">    IN PVOID Parameters</span><br><span class="line">) &#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    SCSI_ADAPTER_CONTROL_STATUS status = ScsiAdapterControlSuccess;</span><br><span class="line"></span><br><span class="line">    switch(ControlType) &#123;</span><br><span class="line">        case ScsiAdapterPoFxPowerRequired:</span><br><span class="line">            // PoFx ֪ͨ������Ҫ�����豸</span><br><span class="line">            // ��ʱ�豸���ܴ��ڵ͹���״̬����Ҫ׼���ָ�����</span><br><span class="line">            </span><br><span class="line">            // 1. ��鵱ǰ״̬</span><br><span class="line">            if (pdx-&gt;pm_state.d0d3_state != StorPowerDeviceD0) &#123;</span><br><span class="line">                // 2. �ָ�ʱ�Ӻ͵�Դ</span><br><span class="line">                if (!host_enable_clock(&amp;pdx-&gt;host, TRUE)) &#123;</span><br><span class="line">                    status = ScsiAdapterControlFailure;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                // 3. �ȴ��豸�ȶ�</span><br><span class="line">                StorPortStallExecution(pdx-&gt;cfg-&gt;feature_item.power_stable_time_us);</span><br><span class="line">                </span><br><span class="line">                // 4. �ָ��ؼ��Ĵ���</span><br><span class="line">                pcr_part_a_restore(pdx);</span><br><span class="line">                </span><br><span class="line">                // 5. ����״̬��־</span><br><span class="line">                pdx-&gt;pm_state.d0d3_state = StorPowerDeviceD0;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case ScsiAdapterPoFxPowerActive:</span><br><span class="line">            // PoFx ֪ͨ�����豸����ȫ����</span><br><span class="line">            // ��ʱ���Իָ���������</span><br><span class="line">            </span><br><span class="line">            // 1. �ָ��������豸״̬</span><br><span class="line">            pcr_part_b_restore(pdx);</span><br><span class="line">            </span><br><span class="line">            // 2. ���³�ʼ���ж�</span><br><span class="line">            host_int_sig_en(&amp;pdx-&gt;host, pdx-&gt;host.int_mask);</span><br><span class="line">            </span><br><span class="line">            // 3. �ָ� DMA ����</span><br><span class="line">            if (pdx-&gt;cfg-&gt;feature_item.dma_enable) &#123;</span><br><span class="line">                if (!host_dma_init(&amp;pdx-&gt;host)) &#123;</span><br><span class="line">                    status = ScsiAdapterControlFailure;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 4. �ָ��Զ���ʱ��</span><br><span class="line">            if (pdx-&gt;auto_timer.enable) &#123;</span><br><span class="line">                func_autotimer_start(pdx);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 5. ��鿨״̬</span><br><span class="line">            if (pdx-&gt;card.card_present) &#123;</span><br><span class="line">                // �������λ��������Ҫ���³�ʼ��</span><br><span class="line">                if (!card_reinit(&amp;pdx-&gt;card)) &#123;</span><br><span class="line">                    DbgWarn(&quot;Card reinit failed after power active&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 6. ���� PoFx ״̬��־</span><br><span class="line">            pdx-&gt;os.StateFlags.PoFxActive = TRUE;</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ�˵��:</p>
<ol>
<li>ScsiAdapterPoFxPowerRequired:</li>
</ol>
<ul>
<li>���ǵ�һ�׶εĵ�Դ�ָ�֪ͨ</li>
<li>��ʱֻ�ָ�������Ĺ���(ʱ�ӡ���Դ��)</li>
<li>��Ҫִ�к�ʱ��������Ϊ������� PoFx ���</li>
</ul>
<ol start="2">
<li>ScsiAdapterPoFxPowerActive:</li>
</ol>
<ul>
<li>���ǵڶ��׶εĵ�Դ�ָ�֪ͨ</li>
<li>��ʱ����ִ���������豸��ʼ��</li>
<li>���Իָ����й��ܣ����� DMA���жϵ�</li>
<li>���Դ�����ʱ����</li>
</ul>
<ol start="3">
<li>������:</li>
</ol>
<ul>
<li>���йؼ���������Ҫ��鷵��ֵ</li>
<li>����ָ�ʧ�ܣ����� ScsiAdapterControlFailure</li>
<li>��¼������־���ڵ���</li>
</ul>
<ol start="4">
<li>״̬ͬ��:</li>
</ol>
<ul>
<li>ȷ����ȷ�����ڲ�״̬��־</li>
<li>���� PoFx ״̬���豸ʵ��״̬ͬ��</li>
</ul>
<ol start="5">
<li>���ܿ���:</li>
</ol>
<ul>
<li>PowerRequired �ص�Ҫ���췵��</li>
<li>��ʱ�������� PowerActive ��ִ��</li>
<li>ʹ���ʵ�����ʱȷ���豸�ȶ�</li>
</ul>
<p>������ʵ�ֿ���ȷ��:</p>
<ol>
<li>���� Storport PoFx �淶</li>
<li>��ȷ�����豸��Դ״̬ת��</li>
<li>�ṩ�ɿ��Ĵ���ָ�����</li>
<li>�Ż���Դ��������</li>
</ol>
<h2 id="User-4"><a href="#User-4" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>ʲôʱ����Ҫ����Pofx��Active��Idle������Ҫ���Storport miniport���ڵĵ�Դ��������ͻ</p>
<h2 id="AI-claude-3-5-sonnet-4"><a href="#AI-claude-3-5-sonnet-4" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�� Storport miniport �����У�PoFx �� Active&#x2F;Idle ������Ҫ�����õĵ�Դ����Э������������ȷ��ʹ�ó�����</p>
<ol>
<li>���� StorPortPoFxActivateComponent:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN Adapter_Acquire_Active_Reference(</span><br><span class="line">    _In_ bht_dev_ext_t *pdx,</span><br><span class="line">    _Inout_opt_ PBOOLEAN InIdle</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    BOOLEAN referenceAcquired = FALSE;</span><br><span class="line">    ULONG status;</span><br><span class="line"></span><br><span class="line">    // 1. ֻ�� PoFx ����ʱ����</span><br><span class="line">    if (!pdx-&gt;os.StateFlags.PoFxEnabled) &#123;</span><br><span class="line">        return TRUE;  // ��� PoFx δ���ã���Ϊ�豸ʼ�մ��ڼ���״̬</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 2. �����ظ�����</span><br><span class="line">    if (pdx-&gt;os.StateFlags.PoFxActive) &#123;</span><br><span class="line">        return TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 3. �����³�������:</span><br><span class="line">    // - �����µ� I/O ����ǰ</span><br><span class="line">    // - ��Ҫ�����豸�Ĵ���ʱ</span><br><span class="line">    // - �豸��Ҫ���ֻ״̬ʱ</span><br><span class="line">    status = StorPortPoFxActivateComponent(</span><br><span class="line">        pdx,</span><br><span class="line">        NULL,</span><br><span class="line">        NULL,</span><br><span class="line">        0,</span><br><span class="line">        0</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    if (status == STOR_STATUS_SUCCESS || status == STOR_STATUS_BUSY) &#123;</span><br><span class="line">        referenceAcquired = TRUE;</span><br><span class="line">        if (InIdle) &#123;</span><br><span class="line">            *InIdle = (status == STOR_STATUS_BUSY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return referenceAcquired;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>���� StorPortPoFxIdleComponent:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">VOID Adapter_Release_Active_Reference(</span><br><span class="line">    _In_ bht_dev_ext_t *pdx</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    // 1. ֻ�� PoFx ����ʱ����</span><br><span class="line">    if (!pdx-&gt;os.StateFlags.PoFxEnabled) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 2. �����³�������:</span><br><span class="line">    // - I/O ������ɺ�</span><br><span class="line">    // - �豸���Խ���͹���״̬ʱ</span><br><span class="line">    // - ��ʱ���޻ʱ</span><br><span class="line">    if (pdx-&gt;os.StateFlags.PoFxActive) &#123;</span><br><span class="line">        StorPortPoFxIdleComponent(</span><br><span class="line">            pdx,</span><br><span class="line">            NULL,</span><br><span class="line">            NULL,</span><br><span class="line">            0,</span><br><span class="line">            0</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>��ȷ��ʹ��λ��:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">// ʾ������ StartIo ������</span><br><span class="line">BOOLEAN HwStartIo(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ PSCSI_REQUEST_BLOCK Srb</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    BOOLEAN inIdle = FALSE;</span><br><span class="line"></span><br><span class="line">    // 1. �ڴ��� I/O ǰ��ȡ��������</span><br><span class="line">    if (!Adapter_Acquire_Active_Reference(pdx, &amp;inIdle)) &#123;</span><br><span class="line">        return FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 2. ����豸���ڴӿ���״̬�ָ����ȴ����</span><br><span class="line">    if (inIdle) &#123;</span><br><span class="line">        // ���������ȴ�����</span><br><span class="line">        QueuePendingRequest(pdx, Srb);</span><br><span class="line">        return TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ���� I/O ����</span><br><span class="line">    ProcessIoRequest(pdx, Srb);</span><br><span class="line"></span><br><span class="line">    // 3. I/O ��ɺ��ͷ�����</span><br><span class="line">    Adapter_Release_Active_Reference(pdx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>��Ҫ��������:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ����ʾ������Ҫ����Щ�������� PoFx ����</span></span><br><span class="line">SCSI_ADAPTER_CONTROL_STATUS <span class="title function_">HwAdapterControl</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ SCSI_ADAPTER_CONTROL_TYPE ControlType,</span></span><br><span class="line"><span class="params">    _In_ PVOID Parameters</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">bht_dev_ext_t</span> *pdx = (<span class="type">bht_dev_ext_t</span> *)DeviceExtension;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (ControlType) &#123;</span><br><span class="line">        <span class="keyword">case</span> ScsiAdapterPowerState:</span><br><span class="line">            <span class="comment">// ���󣺲�Ҫ�ڵ�Դ״̬ת�������е��� PoFx ����</span></span><br><span class="line">            <span class="comment">// Adapter_Acquire_Active_Reference(pdx, NULL);  // ����</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> ScsiAdapterPoFxPowerRequired:</span><br><span class="line">        <span class="keyword">case</span> ScsiAdapterPoFxPowerActive:</span><br><span class="line">            <span class="comment">// ���󣺲�Ҫ�� PoFx �ص����ٵ��� PoFx ����</span></span><br><span class="line">            <span class="comment">// Adapter_Acquire_Active_Reference(pdx, NULL);  // ����</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>�� Storport ��Դ����Э��:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��ȷ������Դ״̬ת��</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">HandlePowerTransition</span><span class="params">(<span class="type">bht_dev_ext_t</span> *pdx, STOR_DEVICE_POWER_STATE newState)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (newState) &#123;</span><br><span class="line">        <span class="keyword">case</span> StorPowerDeviceD0:</span><br><span class="line">            <span class="comment">// �豸���� D0 ״̬������Ҫ�������� PoFx ����</span></span><br><span class="line">            <span class="comment">// �� Storport ��ܴ��� PoFx ״̬</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> StorPowerDeviceD3:</span><br><span class="line">            <span class="comment">// ȷ���ڽ��� D3 ǰ���� PoFx ���ö����ͷ�</span></span><br><span class="line">            WaitForAllPoFxReferencesReleased(pdx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ�ԭ��</p>
<ol>
<li>ʱ��ѡ��</li>
</ol>
<ul>
<li>����Ҫ�����豸ǰ���� Activate</li>
<li>������豸���ʺ���� Idle</li>
<li>�����ڵ�Դ״̬ת�������е���</li>
</ul>
<ol start="2">
<li>״̬ͬ����</li>
</ol>
<ul>
<li>ά����ȷ�� PoFx ״̬��־</li>
<li>ȷ���� Storport ��Դ״̬����һ��</li>
<li>�����ظ�����</li>
</ul>
<ol start="3">
<li>��������</li>
</ol>
<ul>
<li>���� STOR_STATUS_BUSY ״̬</li>
<li>ʵ�ֳ�ʱ�����Ի���</li>
<li>��ȷ������Դ</li>
</ul>
<ol start="4">
<li>�����Ż���</li>
</ol>
<ul>
<li>����ʹ�����ü���</li>
<li>����Ƶ����״̬�л�</li>
<li>��������������</li>
</ul>
<p>������ʵ�ֿ���ȷ�� PoFx ������ Storport �����õ�Դ������ȷЭ�����ṩ�ɿ��ĵ�Դ�������ܡ�</p>
<h2 id="User-5"><a href="#User-5" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�ղŵ�����ֻ�漰miniport���ʵ�֣�������������miniport�Ĳ��֣�������Щ������������storport��DDI�ӿ�Ҫ��</p>
<h2 id="AI-claude-3-5-sonnet-5"><a href="#AI-claude-3-5-sonnet-5" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��˵�ö�,�������»��� Storport DDI �淶��������:</p>
<ol>
<li>������ PoFx �ĳ�ʼ��,Ӧ���� HwFindAdapter �����:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">ULONG </span><br><span class="line">HwFindAdapter(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ PVOID HwContext,</span><br><span class="line">    _In_ PVOID BusInformation,</span><br><span class="line">    _In_ PCHAR ArgumentString,</span><br><span class="line">    _Inout_ PPORT_CONFIGURATION_INFORMATION ConfigInfo,</span><br><span class="line">    _Out_ PBOOLEAN Again</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    // ... ������ʼ������ ...</span><br><span class="line">    </span><br><span class="line">    // ��ʼ�� PoFx</span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Version = STOR_POFX_DEVICE_VERSION_V2;</span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Size = STOR_POFX_DEVICE_V2_SIZE;</span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_IDLE_TIMEOUT;</span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.AdapterIdleTimeoutInMS = </span><br><span class="line">        pdx-&gt;cfg-&gt;feature_item.psd_mode.adapter_idle_time_s * 1000;</span><br><span class="line">        </span><br><span class="line">    status = StorPortInitializePoFxPower(</span><br><span class="line">        DeviceExtension,</span><br><span class="line">        NULL,</span><br><span class="line">        &amp;pdx-&gt;os.AdptPoFxDevice,</span><br><span class="line">        &amp;enableD3Cold</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    return SP_RETURN_FOUND;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>��Դ�����ص�Ӧ���� HwAdapterControl �д���:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">SCSI_ADAPTER_CONTROL_STATUS </span><br><span class="line">HwAdapterControl(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ SCSI_ADAPTER_CONTROL_TYPE ControlType,</span><br><span class="line">    _In_ PVOID Parameters</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    switch(ControlType) &#123;</span><br><span class="line">        case ScsiAdapterPoFxPowerRequired:</span><br><span class="line">            // ִֻ�л����ĵ�Դ�ָ�</span><br><span class="line">            if (pdx-&gt;pm_state.d0d3_state != StorPowerDeviceD0) &#123;</span><br><span class="line">                // ʹ�� StorPort API ����Ӳ��</span><br><span class="line">                StorPortWriteRegisterUlong(pdx, &amp;pdx-&gt;host.base[0], 0);</span><br><span class="line">                StorPortStallExecution(1000); // 1ms</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case ScsiAdapterPoFxPowerActive:</span><br><span class="line">            // �������豸��ʼ��</span><br><span class="line">            StorPortWriteRegisterUlong(pdx, &amp;pdx-&gt;host.base[0], </span><br><span class="line">                pdx-&gt;pm_state.reg_0x3e0);</span><br><span class="line">            </span><br><span class="line">            // �����ж�</span><br><span class="line">            StorPortEnableInterrupts(pdx);</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case ScsiAdapterPowerState:</span><br><span class="line">            PSCSI_ADAPTER_CONTROL_POWER Power = </span><br><span class="line">                (PSCSI_ADAPTER_CONTROL_POWER)Parameters;</span><br><span class="line">            switch(Power-&gt;PowerState) &#123;</span><br><span class="line">                case StorPowerDeviceD0:</span><br><span class="line">                    // D0 �ָ�</span><br><span class="line">                    break;</span><br><span class="line">                case StorPowerDeviceD3:</span><br><span class="line">                    // D3 ׼��</span><br><span class="line">                    StorPortDisableInterrupts(pdx);</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return ScsiAdapterControlSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>���� I&#x2F;O ����Ĵ���:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN </span><br><span class="line">HwStartIo(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ PSCSI_REQUEST_BLOCK Srb</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    // ����豸״̬</span><br><span class="line">    if (pdx-&gt;pm_state.d0d3_state != StorPowerDeviceD0) &#123;</span><br><span class="line">        StorPortCompleteRequest(DeviceExtension, </span><br><span class="line">                              Srb-&gt;PathId,</span><br><span class="line">                              Srb-&gt;TargetId, </span><br><span class="line">                              Srb-&gt;Lun,</span><br><span class="line">                              SRB_STATUS_BUSY);</span><br><span class="line">        return TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // ���� I/O ����</span><br><span class="line">    return ProcessSrbRequest(pdx, Srb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>��ȷʹ�� StorPort API:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">void SaveDeviceState(bht_dev_ext_t *pdx)</span><br><span class="line">&#123;</span><br><span class="line">    // ʹ�� StorPort API ��ȡ�Ĵ���</span><br><span class="line">    pdx-&gt;pm_state.reg_0x3e0 = StorPortReadRegisterUlong(</span><br><span class="line">        pdx, </span><br><span class="line">        &amp;pdx-&gt;host.base[0x3e0]</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    // ʹ�� StorPort API ������ʱ</span><br><span class="line">    StorPortStallExecution(100);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void RestoreDeviceState(bht_dev_ext_t *pdx)</span><br><span class="line">&#123;</span><br><span class="line">    // ʹ�� StorPort API д��Ĵ���</span><br><span class="line">    StorPortWriteRegisterUlong(</span><br><span class="line">        pdx,</span><br><span class="line">        &amp;pdx-&gt;host.base[0x3e0],</span><br><span class="line">        pdx-&gt;pm_state.reg_0x3e0</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ�����:</p>
<ol>
<li><p>�Ƴ����Զ���� Active&#x2F;Idle ����,��Ϊ��ЩӦ���� Storport ��ܹ���</p>
</li>
<li><p>ʹ�ñ�׼�� StorPort DDI:</p>
</li>
</ol>
<ul>
<li>StorPortReadRegisterUlong</li>
<li>StorPortWriteRegisterUlong</li>
<li>StorPortStallExecution</li>
<li>StorPortEnableInterrupts&#x2F;DisableInterrupts</li>
</ul>
<ol start="3">
<li>��ȷ���� SRB ����:</li>
</ol>
<ul>
<li>ʹ�� StorPortCompleteRequest</li>
<li>���ر�׼�� SRB_STATUS ֵ</li>
</ul>
<ol start="4">
<li>��ѭ Storport �ĵ�Դ��������:</li>
</ol>
<ul>
<li>ͨ�� ScsiAdapterControl ������Դ״̬ת��</li>
<li>ʹ�� StorPort �ṩ���жϹ�������</li>
<li>��ȷ���� D-state �� PoFx ״̬</li>
</ul>
<p>������ʵ�ָ����� Storport Miniport �����淶,������ Storport ��ܸ��õ�Э����</p>
<h2 id="User-6"><a href="#User-6" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>Ϊʲô Active&#x2F;Idle ������Ӧ�õ���,��Ϊ��ЩӦ���� Storport ��ܹ������� @Web ���Ӹ���֤��</p>
<h2 id="AI-claude-3-5-sonnet-6"><a href="#AI-claude-3-5-sonnet-6" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>����Ҫ����֮ǰ��˵����</p>
<p>���� Microsoft �ĵ�:</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportpofxactivatecomponent">StorPortPoFxActivateComponent function</a><br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportpofxidlecomponent">StorPortPoFxIdleComponent function</a></p>
<p>Miniport ����ȷʵ��Ҫ����������Щ��������������ĵ�Դ״̬��������˵:</p>
<ol>
<li>StorPortPoFxActivateComponent:</li>
</ol>
<ul>
<li>��������Ҫ�����豸ʱ����</li>
<li>�ڴ��� I&#x2F;O ����ǰ����</li>
<li>ȷ���豸���ڻ״̬</li>
</ul>
<ol start="2">
<li>StorPortPoFxIdleComponent:</li>
</ol>
<ul>
<li>����������豸���ʺ����</li>
<li>�����豸����͹���״̬</li>
<li>��� idle timeout ����ʹ��</li>
</ul>
<p>��ȷ��ʹ��ʾ��:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN</span><br><span class="line">Adapter_Acquire_Active_Reference(</span><br><span class="line">    _In_ void * AdapterExtension,</span><br><span class="line">    _Inout_opt_ PBOOLEAN InIdle</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t * pdx = (bht_dev_ext_t *)AdapterExtension;</span><br><span class="line">    BOOLEAN referenceAcquired = FALSE;</span><br><span class="line">    ULONG status = 0;</span><br><span class="line"></span><br><span class="line">    if(Adapter_PoFx_Enabled(AdapterExtension))</span><br><span class="line">    &#123;</span><br><span class="line">        status = StorPortPoFxActivateComponent(AdapterExtension,</span><br><span class="line">                                               NULL,</span><br><span class="line">                                               NULL,</span><br><span class="line">                                               0,</span><br><span class="line">                                               0);</span><br><span class="line"></span><br><span class="line">        // STOR_STATUS_BUSY ��ʾ�������ڽ�����</span><br><span class="line">        if(InIdle != NULL)</span><br><span class="line">        &#123;</span><br><span class="line">            *InIdle = (status == STOR_STATUS_BUSY);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if((status == STOR_STATUS_SUCCESS) || (status == STOR_STATUS_BUSY))</span><br><span class="line">            referenceAcquired = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return referenceAcquired;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID</span><br><span class="line">Adapter_Release_Active_Reference(</span><br><span class="line">    _In_ bht_dev_ext_t * AdapterExtension</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    if(Adapter_PoFx_Enabled(AdapterExtension))</span><br><span class="line">    &#123;</span><br><span class="line">        StorPortPoFxIdleComponent(AdapterExtension,</span><br><span class="line">                                   NULL,</span><br><span class="line">                                   NULL,</span><br><span class="line">                                   0,</span><br><span class="line">                                   0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Щ������Ҫ�� ScsiAdapterControl �е� PoFx �ص����ʹ��:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">case ScsiAdapterPoFxPowerRequired:</span><br><span class="line">    // ��Ӧ StorPortPoFxActivateComponent �ĵ���</span><br><span class="line">    // ִ�л����ĵ�Դ�ָ�</span><br><span class="line">    break;</span><br><span class="line"></span><br><span class="line">case ScsiAdapterPoFxPowerActive:</span><br><span class="line">    // �豸����ȫ����</span><br><span class="line">    // ���Կ�ʼ�����豸</span><br><span class="line">    break;</span><br></pre></td></tr></table></figure>

<p>��Ϊ֮ǰ˵”��ЩӦ���� Storport ��ܹ���”��˵����Ǹ�����ǲ���ȷ�ģ�Miniport ������Ҫ����������Щ�����������豸�ĵ�Դ״̬��</p>
<h2 id="User-7"><a href="#User-7" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����ϸ�������룬miniport driver�ںδ�����StorPortPoFxActivateComponent��StorPortPoFxIdleComponent��������μ���ScsiAdapterControl �е� PoFx �ص����Լ�ScsiAdapterControl �е�ScsiAdapterPower D0&#x2F;D3����</p>
<h2 id="AI-claude-3-5-sonnet-7"><a href="#AI-claude-3-5-sonnet-7" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>���� Storport �淶����������ϸ��ʵ�ַ�����</p>
<ol>
<li>�����ڹؼ��� I&#x2F;O ·���е��� Active&#x2F;Idle��</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN HwStartIo(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ PSCSI_REQUEST_BLOCK Srb</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    BOOLEAN inIdle = FALSE;</span><br><span class="line">    </span><br><span class="line">    // 1. ����Ƿ���D3״̬</span><br><span class="line">    if (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD3) &#123;</span><br><span class="line">        StorPortCompleteRequest(DeviceExtension, </span><br><span class="line">                              Srb-&gt;PathId,</span><br><span class="line">                              Srb-&gt;TargetId,</span><br><span class="line">                              Srb-&gt;Lun,</span><br><span class="line">                              SRB_STATUS_BUSY);</span><br><span class="line">        return TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 2. ��ȡActive����</span><br><span class="line">    if (Adapter_PoFx_Enabled(pdx)) &#123;</span><br><span class="line">        ULONG status = StorPortPoFxActivateComponent(pdx, NULL, NULL, 0, 0);</span><br><span class="line">        if (status == STOR_STATUS_BUSY) &#123;</span><br><span class="line">            // �豸���ڻָ������������ȴ�����</span><br><span class="line">            QueueDeferredSrb(pdx, Srb);</span><br><span class="line">            return TRUE;</span><br><span class="line">        &#125; else if (status != STOR_STATUS_SUCCESS) &#123;</span><br><span class="line">            StorPortCompleteRequest(DeviceExtension, </span><br><span class="line">                                  Srb-&gt;PathId,</span><br><span class="line">                                  Srb-&gt;TargetId,</span><br><span class="line">                                  Srb-&gt;Lun,</span><br><span class="line">                                  SRB_STATUS_ERROR);</span><br><span class="line">            return TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 3. ����I/O����</span><br><span class="line">    BOOLEAN result = ProcessSrbRequest(pdx, Srb);</span><br><span class="line">    </span><br><span class="line">    // 4. �ͷ�Active����</span><br><span class="line">    if (Adapter_PoFx_Enabled(pdx)) &#123;</span><br><span class="line">        StorPortPoFxIdleComponent(pdx, NULL, NULL, 0, 0);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>�� ScsiAdapterControl ����ȷ�������е�Դ��ػص���</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">SCSI_ADAPTER_CONTROL_STATUS </span><br><span class="line">HwAdapterControl(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ SCSI_ADAPTER_CONTROL_TYPE ControlType,</span><br><span class="line">    _In_ PVOID Parameters</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    SCSI_ADAPTER_CONTROL_STATUS status = ScsiAdapterControlSuccess;</span><br><span class="line"></span><br><span class="line">    switch(ControlType) &#123;</span><br><span class="line">        case ScsiAdapterPowerState: &#123;</span><br><span class="line">            PSCSI_ADAPTER_CONTROL_POWER Power = </span><br><span class="line">                (PSCSI_ADAPTER_CONTROL_POWER)Parameters;</span><br><span class="line">            </span><br><span class="line">            switch(Power-&gt;PowerState) &#123;</span><br><span class="line">                case StorPowerDeviceD0:</span><br><span class="line">                    // 1. ����״̬</span><br><span class="line">                    pdx-&gt;pm_state.d0d3_state = StorPowerDeviceD0;</span><br><span class="line">                    </span><br><span class="line">                    // 2. ������ʼ��</span><br><span class="line">                    if (!host_init(&amp;pdx-&gt;host)) &#123;</span><br><span class="line">                        status = ScsiAdapterControlFailure;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    // 3. ע�⣺��Ҫ���������StorPortPoFxActivateComponent</span><br><span class="line">                    // D0�ָ���PoFx��ͨ��ScsiAdapterPoFxPowerRequired/Active֪ͨ</span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                case StorPowerDeviceD3:</span><br><span class="line">                    // 1. ȷ������I/O���</span><br><span class="line">                    StorPortPauseDevice(DeviceExtension);</span><br><span class="line">                    </span><br><span class="line">                    // 2. �����ж�</span><br><span class="line">                    StorPortDisableInterrupts(DeviceExtension);</span><br><span class="line">                    </span><br><span class="line">                    // 3. �����豸״̬</span><br><span class="line">                    SaveDeviceState(pdx);</span><br><span class="line">                    </span><br><span class="line">                    // 4. ����״̬</span><br><span class="line">                    pdx-&gt;pm_state.d0d3_state = StorPowerDeviceD3;</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">            </span><br><span class="line">        case ScsiAdapterPoFxPowerRequired:</span><br><span class="line">            // ���Ƕ�StorPortPoFxActivateComponent���õ���Ӧ</span><br><span class="line">            if (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD0) &#123;</span><br><span class="line">                // 1. ������Դ�ָ�</span><br><span class="line">                if (!host_power_on(&amp;pdx-&gt;host)) &#123;</span><br><span class="line">                    status = ScsiAdapterControlFailure;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                // 2. �ȴ�Ӳ���ȶ�</span><br><span class="line">                StorPortStallExecution(pdx-&gt;cfg-&gt;power_stable_time_us);</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case ScsiAdapterPoFxPowerActive:</span><br><span class="line">            // StorPortPoFxActivateComponent��ɺ��֪ͨ</span><br><span class="line">            if (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD0) &#123;</span><br><span class="line">                // 1. �ָ������豸״̬</span><br><span class="line">                RestoreDeviceState(pdx);</span><br><span class="line">                </span><br><span class="line">                // 2. �����ж�</span><br><span class="line">                StorPortEnableInterrupts(DeviceExtension);</span><br><span class="line">                </span><br><span class="line">                // 3. ����֮ǰ�ӳٵ�����</span><br><span class="line">                ProcessDeferredSrbs(pdx);</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>������Ҫ�����豸�ĵط�Ҳ��Ҫ��ȡ Active ���ã�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN HwResetBus(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ ULONG PathId</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    BOOLEAN result = FALSE;</span><br><span class="line">    </span><br><span class="line">    // 1. ��ȡActive����</span><br><span class="line">    if (Adapter_PoFx_Enabled(pdx)) &#123;</span><br><span class="line">        ULONG status = StorPortPoFxActivateComponent(pdx, NULL, NULL, 0, 0);</span><br><span class="line">        if (status != STOR_STATUS_SUCCESS &amp;&amp; status != STOR_STATUS_BUSY) &#123;</span><br><span class="line">            return FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 2. ִ����������</span><br><span class="line">    result = ResetBusOperation(pdx);</span><br><span class="line">    </span><br><span class="line">    // 3. �ͷ�Active����</span><br><span class="line">    if (Adapter_PoFx_Enabled(pdx)) &#123;</span><br><span class="line">        StorPortPoFxIdleComponent(pdx, NULL, NULL, 0, 0);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ���˵����</p>
<ol>
<li>StorPortPoFxActivateComponent&#x2F;IdleComponent��</li>
</ol>
<ul>
<li>����Ҫ�����豸ǰ���� Activate</li>
<li>������豸���ʺ���� Idle</li>
<li>���� STOR_STATUS_BUSY ״̬</li>
</ul>
<ol start="2">
<li>D-State ת����</li>
</ol>
<ul>
<li>D3 ����ʱ����״̬��ֹͣ���л</li>
<li>D0 �ָ�ʱֻ��������ʼ��</li>
<li>�ȴ� PoFx �ص�����豸�ָ�</li>
</ul>
<ol start="3">
<li>PoFx �ص���</li>
</ol>
<ul>
<li>PowerRequired��ִ�л�����Դ�ָ�</li>
<li>PowerActive����������豸��ʼ��</li>
</ul>
<ol start="4">
<li>״̬ͬ����</li>
</ol>
<ul>
<li>ά����ȷ�� D-State ״̬</li>
<li>�����ӳٵ� I&#x2F;O ����</li>
<li>ȷ���жϿ�����ȷ</li>
</ul>
<p>������ʵ�ֿ���ȷ����</p>
<ol>
<li>��ȷ�������е�Դ״̬ת��</li>
<li>�����ڴ����״̬�����豸</li>
<li>�ṩ�ɿ��ĵ�Դ��������</li>
<li>���� Storport �淶Ҫ��</li>
</ol>
<h2 id="User-8"><a href="#User-8" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����ϸ����һ�����µ�Դ���õĹ��̣�1.StorPortPoFxActivateComponent��StorPortPoFxIdleComponent��2.ScsiAdapterControl �е� PoFx �ص���3.ScsiAdapterControl �е�ScsiAdapterPower D0&#x2F;D3����</p>
<h2 id="AI-claude-3-5-sonnet-8"><a href="#AI-claude-3-5-sonnet-8" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>������ϸ˵����Щ��Դ�������õ����̣�</p>
<ol>
<li>StorPortPoFxActivateComponent&#x2F;IdleComponent �ĵ������̣�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant IO as I/O Request</span><br><span class="line">    participant Miniport as Miniport Driver</span><br><span class="line">    participant Storport as Storport Driver</span><br><span class="line">    participant PoFx as Power Framework</span><br><span class="line">    participant Hardware as Hardware</span><br><span class="line"></span><br><span class="line">    IO-&gt;&gt;Miniport: HwStartIo</span><br><span class="line">    Miniport-&gt;&gt;Storport: StorPortPoFxActivateComponent</span><br><span class="line">    Storport-&gt;&gt;PoFx: Request Active</span><br><span class="line">    PoFx--&gt;&gt;Miniport: ScsiAdapterPoFxPowerRequired</span><br><span class="line">    Miniport--&gt;&gt;PoFx: Return Success</span><br><span class="line">    PoFx--&gt;&gt;Miniport: ScsiAdapterPoFxPowerActive</span><br><span class="line">    Miniport--&gt;&gt;Storport: Return Success</span><br><span class="line">    Miniport-&gt;&gt;Hardware: Process I/O</span><br><span class="line">    Miniport-&gt;&gt;Storport: StorPortPoFxIdleComponent</span><br><span class="line">    Storport-&gt;&gt;PoFx: Request Idle</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ScsiAdapterControl �е� PoFx �ص����̣�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant PoFx as Power Framework</span><br><span class="line">    participant Storport as Storport Driver</span><br><span class="line">    participant Miniport as Miniport Driver</span><br><span class="line">    participant Hardware as Hardware</span><br><span class="line"></span><br><span class="line">    Note over PoFx,Hardware: Active Flow</span><br><span class="line">    PoFx-&gt;&gt;Storport: Request Power Up</span><br><span class="line">    Storport-&gt;&gt;Miniport: ScsiAdapterPoFxPowerRequired</span><br><span class="line">    Miniport-&gt;&gt;Hardware: Basic Power Restore</span><br><span class="line">    Note right of Miniport: Only essential power</span><br><span class="line">    Miniport--&gt;&gt;Storport: Return Success</span><br><span class="line">    Storport--&gt;&gt;PoFx: Acknowledge</span><br><span class="line">    PoFx-&gt;&gt;Storport: Power Up Complete</span><br><span class="line">    Storport-&gt;&gt;Miniport: ScsiAdapterPoFxPowerActive</span><br><span class="line">    Miniport-&gt;&gt;Hardware: Full Device Init</span><br><span class="line">    Note right of Miniport: Complete initialization</span><br><span class="line">    Miniport--&gt;&gt;Storport: Return Success</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ScsiAdapterPower D0&#x2F;D3 �������̣�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant PnP as PnP Manager</span><br><span class="line">    participant Storport as Storport Driver</span><br><span class="line">    participant Miniport as Miniport Driver</span><br><span class="line">    participant Hardware as Hardware</span><br><span class="line"></span><br><span class="line">    Note over PnP,Hardware: D0 Flow</span><br><span class="line">    PnP-&gt;&gt;Storport: IRP_MJ_POWER (D0)</span><br><span class="line">    Storport-&gt;&gt;Miniport: ScsiAdapterControl(PowerState:D0)</span><br><span class="line">    Miniport-&gt;&gt;Hardware: Basic D0 Init</span><br><span class="line">    Note right of Miniport: No PoFx calls here</span><br><span class="line">    Miniport--&gt;&gt;Storport: Return Success</span><br><span class="line">    Note over PnP,Hardware: PoFx Flow Follows</span><br><span class="line">    </span><br><span class="line">    Note over PnP,Hardware: D3 Flow</span><br><span class="line">    PnP-&gt;&gt;Storport: IRP_MJ_POWER (D3)</span><br><span class="line">    Storport-&gt;&gt;Miniport: ScsiAdapterControl(PowerState:D3)</span><br><span class="line">    Miniport-&gt;&gt;Hardware: Prepare for D3</span><br><span class="line">    Note right of Miniport: Save state &amp; power down</span><br><span class="line">    Miniport--&gt;&gt;Storport: Return Success</span><br></pre></td></tr></table></figure>

<p>�ؼ�ʱ��˵����</p>
<ol>
<li>Active&#x2F;Idle ���ã�</li>
</ol>
<ul>
<li>Miniport ����Ҫ����Ӳ��ʱ���� StorPortPoFxActivateComponent</li>
<li>���ú�ᴥ�� PowerRequired �� PowerActive �ص�</li>
<li>���Ӳ�����ʺ���� StorPortPoFxIdleComponent</li>
</ul>
<ol start="2">
<li>PoFx �ص���</li>
</ol>
<ul>
<li>PowerRequired����һ�׶Σ�ֻ�ָ�������Դ</li>
<li>PowerActive���ڶ��׶Σ����������ʼ��</li>
<li>�������ص��� Active ���õĽ��</li>
</ul>
<ol start="3">
<li>D-State ת����</li>
</ol>
<ul>
<li>D0&#x2F;D3 ��ϵͳ��Դ������һ����</li>
<li>�� PoFx �Ƕ���������</li>
<li>D0 �ָ��������Ҫ�����豸������Ҫ PoFx Active ����</li>
</ul>
<p>ʾ�������еĹؼ�ʱ��</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. ����Ҫ�����豸ʱ</span></span><br><span class="line">ULONG status = StorPortPoFxActivateComponent(pdx, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (status == STOR_STATUS_BUSY) &#123;</span><br><span class="line">    <span class="comment">// �豸���ڻָ����ȴ� PowerActive �ص�</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. PoFx �ص�����</span></span><br><span class="line"><span class="keyword">case</span> ScsiAdapterPoFxPowerRequired:</span><br><span class="line">    <span class="comment">// ������Դ�ָ�</span></span><br><span class="line">    host_power_on(&amp;pdx-&gt;host);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> ScsiAdapterPoFxPowerActive:</span><br><span class="line">    <span class="comment">// ������ʼ��</span></span><br><span class="line">    RestoreDeviceState(pdx);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. D-State ����</span></span><br><span class="line"><span class="keyword">case</span> ScsiAdapterPowerState:</span><br><span class="line">    <span class="keyword">switch</span>(Power-&gt;PowerState) &#123;</span><br><span class="line">        <span class="keyword">case</span> StorPowerDeviceD0:</span><br><span class="line">            <span class="comment">// ���� D0 ��ʼ��</span></span><br><span class="line">            <span class="comment">// ������ PoFx ����</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> StorPowerDeviceD3:</span><br><span class="line">            <span class="comment">// ׼������ D3</span></span><br><span class="line">            SaveDeviceState(pdx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ע�����</p>
<ol>
<li>״̬ͬ����</li>
</ol>
<ul>
<li>ά����ȷ�� D-State �� PoFx ״̬</li>
<li>����״̬��ͻ</li>
</ul>
<ol start="2">
<li>����ʱ����</li>
</ol>
<ul>
<li>D-State ת��ʱ������ PoFx ����</li>
<li>PoFx �ص��в����� PoFx ����</li>
</ul>
<ol start="3">
<li>��������</li>
</ol>
<ul>
<li>�������п��ܵ�״̬ת��ʧ��</li>
<li>ʵ����ȷ����������</li>
</ul>
<p>������ʵ��ȷ���˵�Դ��������ȷ�ԺͿɿ��ԡ�</p>
<h2 id="User-9"><a href="#User-9" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>Storport miniport driver���ʵ��DFx(Direct Pofx), ��SD Host driver���֧��SD card��DFx����(pwrtest), ��ο� @Web Storport�ĵ���DFx�ĵ�</p>
<h2 id="AI-claude-3-5-sonnet-9"><a href="#AI-claude-3-5-sonnet-9" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>���� <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/storage/storport-direct-pofx">Storport DFx �ĵ�</a> �� <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/power-framework-direct-i-o">Power Framework Direct I&#x2F;O</a>, SD Host miniport driver ��Ҫ:</p>
<ol>
<li>������ HwFindAdapter �г�ʼ�� DFx:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">ULONG </span><br><span class="line">HwFindAdapter(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ PVOID HwContext,</span><br><span class="line">    _In_ PVOID BusInformation,</span><br><span class="line">    _In_ PCHAR ArgumentString,</span><br><span class="line">    _Inout_ PPORT_CONFIGURATION_INFORMATION ConfigInfo,</span><br><span class="line">    _Out_ PBOOLEAN Again</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line"></span><br><span class="line">    // 1. ��ʼ�� DFx ����</span><br><span class="line">    STOR_DFX_SETTINGS DfxSettings = &#123;0&#125;;</span><br><span class="line">    DfxSettings.Version = STOR_DFX_SETTINGS_VERSION_V1;</span><br><span class="line">    DfxSettings.Size = sizeof(STOR_DFX_SETTINGS);</span><br><span class="line"></span><br><span class="line">    // 2. ���� Unit ����� DFx</span><br><span class="line">    DfxSettings.UnitDfxSettings.Version = STOR_UNIT_DFX_SETTINGS_VERSION_V1;</span><br><span class="line">    DfxSettings.UnitDfxSettings.Size = sizeof(STOR_UNIT_DFX_SETTINGS);</span><br><span class="line">    </span><br><span class="line">    // 3. ���� F-state ����������</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStateCount = 2; // F0 �� F1</span><br><span class="line">    DfxSettings.UnitDfxSettings.DeepestWakeableFState = 0;</span><br><span class="line">    </span><br><span class="line">    // 4. ���� F-states</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[0].Version = </span><br><span class="line">        STOR_UNIT_DFX_F_STATE_VERSION_V1;</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[0].Size = </span><br><span class="line">        sizeof(STOR_UNIT_DFX_F_STATE);</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[0].TransitionLatency = 0;</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[0].ResidencyRequirement = 0;</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[0].NominalPower = </span><br><span class="line">        STOR_POFX_UNKNOWN_POWER;</span><br><span class="line"></span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[1].Version = </span><br><span class="line">        STOR_UNIT_DFX_F_STATE_VERSION_V1;</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[1].Size = </span><br><span class="line">        sizeof(STOR_UNIT_DFX_F_STATE);</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[1].TransitionLatency = 1000; // 1ms</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[1].ResidencyRequirement = 2000; // 2ms</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[1].NominalPower = </span><br><span class="line">        STOR_POFX_UNKNOWN_POWER;</span><br><span class="line"></span><br><span class="line">    // 5. ��ʼ�� DFx</span><br><span class="line">    status = StorPortInitializeDfx(DeviceExtension, &amp;DfxSettings);</span><br><span class="line">    if (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        return SP_RETURN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return SP_RETURN_FOUND;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ʵ�� Unit ����� DFx �ص�:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">SCSI_ADAPTER_CONTROL_STATUS </span><br><span class="line">HwAdapterControl(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ SCSI_ADAPTER_CONTROL_TYPE ControlType,</span><br><span class="line">    _In_ PVOID Parameters</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    switch(ControlType) &#123;</span><br><span class="line">        case ScsiUnitPoFxPowerRequired: &#123;</span><br><span class="line">            PSCSI_UNIT_POFX_POWER_REQUIRED Params = </span><br><span class="line">                (PSCSI_UNIT_POFX_POWER_REQUIRED)Parameters;</span><br><span class="line">            </span><br><span class="line">            // ���� Unit �ĵ�Դ�ָ�����</span><br><span class="line">            if (!card_power_on(&amp;pdx-&gt;card)) &#123;</span><br><span class="line">                return ScsiAdapterControlFailure;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // �ȴ����ȶ�</span><br><span class="line">            StorPortStallExecution(pdx-&gt;cfg-&gt;card_power_stable_time_us);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        case ScsiUnitPoFxPowerActive: &#123;</span><br><span class="line">            PSCSI_UNIT_POFX_POWER_ACTIVE Params = </span><br><span class="line">                (PSCSI_UNIT_POFX_POWER_ACTIVE)Parameters;</span><br><span class="line">            </span><br><span class="line">            // ��ɿ��ĳ�ʼ��</span><br><span class="line">            if (!card_init(&amp;pdx-&gt;card)) &#123;</span><br><span class="line">                return ScsiAdapterControlFailure;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        case ScsiUnitPoFxPowerSetFState: &#123;</span><br><span class="line">            PSCSI_UNIT_POFX_SET_F_STATE Params = </span><br><span class="line">                (PSCSI_UNIT_POFX_SET_F_STATE)Parameters;</span><br><span class="line">            </span><br><span class="line">            // ���� F-state �л�</span><br><span class="line">            switch(Params-&gt;FState) &#123;</span><br><span class="line">                case 0: // F0</span><br><span class="line">                    if (!card_set_active_state(&amp;pdx-&gt;card)) &#123;</span><br><span class="line">                        return ScsiAdapterControlFailure;</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                case 1: // F1</span><br><span class="line">                    if (!card_set_low_power_state(&amp;pdx-&gt;card)) &#123;</span><br><span class="line">                        return ScsiAdapterControlFailure;</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return ScsiAdapterControlSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>�� I&#x2F;O ·����ʹ�� DFx API:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN </span><br><span class="line">HwStartIo(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ PSCSI_REQUEST_BLOCK Srb</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    ULONG status;</span><br><span class="line">    </span><br><span class="line">    // 1. ��ȡ Unit �� Active ����</span><br><span class="line">    status = StorPortUnitPoFxActivateComponent(</span><br><span class="line">        DeviceExtension,</span><br><span class="line">        Srb-&gt;PathId,</span><br><span class="line">        Srb-&gt;TargetId,</span><br><span class="line">        Srb-&gt;Lun,</span><br><span class="line">        NULL,</span><br><span class="line">        NULL,</span><br><span class="line">        0,</span><br><span class="line">        0</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    if (status == STOR_STATUS_BUSY) &#123;</span><br><span class="line">        // Unit ���ڻָ����ӳٴ���</span><br><span class="line">        QueueDeferredSrb(pdx, Srb);</span><br><span class="line">        return TRUE;</span><br><span class="line">    &#125; else if (status != STOR_STATUS_SUCCESS) &#123;</span><br><span class="line">        StorPortCompleteRequest(DeviceExtension, </span><br><span class="line">                              Srb-&gt;PathId,</span><br><span class="line">                              Srb-&gt;TargetId,</span><br><span class="line">                              Srb-&gt;Lun,</span><br><span class="line">                              SRB_STATUS_ERROR);</span><br><span class="line">        return TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 2. ���� I/O</span><br><span class="line">    BOOLEAN result = ProcessSrbRequest(pdx, Srb);</span><br><span class="line">    </span><br><span class="line">    // 3. �ͷ� Unit ����</span><br><span class="line">    StorPortUnitPoFxIdleComponent(</span><br><span class="line">        DeviceExtension,</span><br><span class="line">        Srb-&gt;PathId,</span><br><span class="line">        Srb-&gt;TargetId,</span><br><span class="line">        Srb-&gt;Lun,</span><br><span class="line">        NULL,</span><br><span class="line">        NULL,</span><br><span class="line">        0,</span><br><span class="line">        0</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>ʵ�� idle timeout ֧��:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// �� HwFindAdapter ������</span><br><span class="line">pdx-&gt;os.UnitPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_IDLE_TIMEOUT;</span><br><span class="line">pdx-&gt;os.UnitPoFxDevice.UnitIdleTimeoutInMS = </span><br><span class="line">    pdx-&gt;cfg-&gt;feature_item.card_idle_timeout_ms;</span><br></pre></td></tr></table></figure>

<p>�ؼ���˵��:</p>
<ol>
<li>DFx ��ʼ��:</li>
</ol>
<ul>
<li>���� F-states ��������</li>
<li>������ȷ���ӳٺ�פ��ʱ��</li>
<li>���� idle timeout ����</li>
</ul>
<ol start="2">
<li>Unit ����ص�:</li>
</ol>
<ul>
<li>PowerRequired: ������Դ�ָ�</li>
<li>PowerActive: ������ʼ��</li>
<li>SetFState: F-state �л�</li>
</ul>
<ol start="3">
<li>������:</li>
</ol>
<ul>
<li>���лص�����Ҫ������ȷ��״̬</li>
<li>ʵ�ֳ�ʱ�����Ի���</li>
<li>��ȷ������Դ</li>
</ul>
<ol start="4">
<li>pwrtest ֧��:</li>
</ol>
<ul>
<li>ȷ����ȷ��Ӧ F-state �л�</li>
<li>ʵ�ֿɿ��� idle timeout</li>
<li>֧�ֵ�Դ״̬ͳ��</li>
</ul>
<p>������ʵ�ֿ���:</p>
<ol>
<li>֧�� SD ����ϸ���ȵ�Դ����</li>
<li>ͨ�� pwrtest ��֤</li>
<li>�ṩ�ɿ��ĵ�Դ��������</li>
</ol>
<h2 id="User-10"><a href="#User-10" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�ղŵĽ��鲻����Storport�ĵ��������� @Web @<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-_stor_pofx_device_v3">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-_stor_pofx_device_v3</a> Remarks<br>To register a storage adapter for Storport PoFx support, the miniport driver calls StorPortEnablePassiveInitialization in its HwStorInitialize routine and implements a HwStorPassiveInitializeRoutine. The miniport calls StorPortInitializePoFxPower within it’s HwStorPassiveInitializeRoutine to provide information about the adapter component.</p>
<p>To register a storage unit for Storport PoFx support, the miniport driver implements the HwStorUnitControl callback routine and provides handling of the ScsiUnitPoFxPowerInfo unit control code. When the handling the ScsiUnitPoFxPowerInfo control code, the miniport calls StorPortInitializePoFxPower if idle power management for the unit component is enabled.</p>
<p>The component for the storage device identified by its Components array index. Storage devices have only one component so the index of 0 is used. Routines such as StorPortPoFxActivateComponent and StorPortPoFxIdleComponent use the array index of a component to identify the component.</p>
<h2 id="AI-claude-3-5-sonnet-10"><a href="#AI-claude-3-5-sonnet-10" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��˵�öԣ��Ҹ��� Storport �ĵ���������ʵ�ַ�����</p>
<ol>
<li>������ HwStorInitialize �����ñ�����ʼ����</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN </span><br><span class="line">HwStorInitialize(</span><br><span class="line">    _In_ PVOID DeviceExtension</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    // ���ñ�����ʼ��</span><br><span class="line">    return StorPortEnablePassiveInitialization(DeviceExtension);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>�� HwStorPassiveInitializeRoutine �г�ʼ���������� PoFx��</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN </span><br><span class="line">HwStorPassiveInitializeRoutine(</span><br><span class="line">    _In_ PVOID DeviceExtension</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    BOOLEAN enableD3Cold = FALSE;</span><br><span class="line">    ULONG status;</span><br><span class="line"></span><br><span class="line">    // ��ʼ�������� PoFx</span><br><span class="line">    STOR_POFX_DEVICE AdapterPoFxDevice = &#123;0&#125;;</span><br><span class="line">    AdapterPoFxDevice.Version = STOR_POFX_DEVICE_VERSION_V3;</span><br><span class="line">    AdapterPoFxDevice.Size = sizeof(STOR_POFX_DEVICE);</span><br><span class="line">    AdapterPoFxDevice.ComponentCount = 1;  // �洢�豸ֻ��һ�����</span><br><span class="line">    </span><br><span class="line">    // ������� 0</span><br><span class="line">    AdapterPoFxDevice.Components[0].Version = STOR_POFX_COMPONENT_VERSION_V1;</span><br><span class="line">    AdapterPoFxDevice.Components[0].Size = sizeof(STOR_POFX_COMPONENT);</span><br><span class="line">    AdapterPoFxDevice.Components[0].FStateCount = 2;</span><br><span class="line">    AdapterPoFxDevice.Components[0].DeepestWakeableFState = 0;</span><br><span class="line">    </span><br><span class="line">    // ���� idle timeout</span><br><span class="line">    AdapterPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_IDLE_TIMEOUT;</span><br><span class="line">    AdapterPoFxDevice.AdapterIdleTimeoutInMS = </span><br><span class="line">        pdx-&gt;cfg-&gt;feature_item.psd_mode.adapter_idle_time_s * 1000;</span><br><span class="line"></span><br><span class="line">    status = StorPortInitializePoFxPower(</span><br><span class="line">        DeviceExtension,</span><br><span class="line">        NULL,</span><br><span class="line">        &amp;AdapterPoFxDevice,</span><br><span class="line">        &amp;enableD3Cold</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    return (status == STOR_STATUS_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ʵ�� HwStorUnitControl ���� Unit ����� PoFx��</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN </span><br><span class="line">HwStorUnitControl(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ SCSI_UNIT_CONTROL_TYPE ControlType,</span><br><span class="line">    _In_ PVOID Parameters</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    switch(ControlType) &#123;</span><br><span class="line">        case ScsiUnitPoFxPowerInfo: &#123;</span><br><span class="line">            PSCSI_UNIT_POFX_POWER_INFO PowerInfo = </span><br><span class="line">                (PSCSI_UNIT_POFX_POWER_INFO)Parameters;</span><br><span class="line">            BOOLEAN enableD3Cold = FALSE;</span><br><span class="line">            </span><br><span class="line">            // ����Ƿ���ҪΪ�� Unit ���� idle power management</span><br><span class="line">            if (IsUnitIdlePowerManagementEnabled(pdx, PowerInfo)) &#123;</span><br><span class="line">                STOR_POFX_DEVICE UnitPoFxDevice = &#123;0&#125;;</span><br><span class="line">                UnitPoFxDevice.Version = STOR_POFX_DEVICE_VERSION_V3;</span><br><span class="line">                UnitPoFxDevice.Size = sizeof(STOR_POFX_DEVICE);</span><br><span class="line">                UnitPoFxDevice.ComponentCount = 1;</span><br><span class="line">                </span><br><span class="line">                // ���� Unit ���</span><br><span class="line">                UnitPoFxDevice.Components[0].Version = STOR_POFX_COMPONENT_VERSION_V1;</span><br><span class="line">                UnitPoFxDevice.Components[0].Size = sizeof(STOR_POFX_COMPONENT);</span><br><span class="line">                UnitPoFxDevice.Components[0].FStateCount = 2;</span><br><span class="line">                UnitPoFxDevice.Components[0].DeepestWakeableFState = 0;</span><br><span class="line">                </span><br><span class="line">                // ���� Unit idle timeout</span><br><span class="line">                UnitPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_IDLE_TIMEOUT;</span><br><span class="line">                UnitPoFxDevice.UnitIdleTimeoutInMS = </span><br><span class="line">                    pdx-&gt;cfg-&gt;feature_item.card_idle_timeout_ms;</span><br><span class="line"></span><br><span class="line">                ULONG status = StorPortInitializePoFxPower(</span><br><span class="line">                    DeviceExtension,</span><br><span class="line">                    PowerInfo-&gt;UnitParameters,  // Unit ����</span><br><span class="line">                    &amp;UnitPoFxDevice,</span><br><span class="line">                    &amp;enableD3Cold</span><br><span class="line">                );</span><br><span class="line">                </span><br><span class="line">                return (status == STOR_STATUS_SUCCESS);</span><br><span class="line">            &#125;</span><br><span class="line">            return TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>����Ҫ�����豸ʱʹ�� PoFx API��</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN </span><br><span class="line">HwStartIo(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ PSCSI_REQUEST_BLOCK Srb</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    ULONG status;</span><br><span class="line">    </span><br><span class="line">    // ��ȡ����������� Active ���� (������� 0)</span><br><span class="line">    status = StorPortPoFxActivateComponent(</span><br><span class="line">        DeviceExtension,</span><br><span class="line">        NULL,</span><br><span class="line">        NULL,</span><br><span class="line">        0,  // ������� 0</span><br><span class="line">        0</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    if (status == STOR_STATUS_BUSY) &#123;</span><br><span class="line">        // �豸���ڻָ�</span><br><span class="line">        return FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // ���� I/O</span><br><span class="line">    BOOLEAN result = ProcessSrbRequest(pdx, Srb);</span><br><span class="line">    </span><br><span class="line">    // �ͷ��������������</span><br><span class="line">    StorPortPoFxIdleComponent(</span><br><span class="line">        DeviceExtension,</span><br><span class="line">        NULL,</span><br><span class="line">        NULL,</span><br><span class="line">        0,  // ������� 0</span><br><span class="line">        0</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ�������</p>
<ol>
<li>��ʼ�����̣�</li>
</ol>
<ul>
<li>ʹ�� HwStorInitialize �� HwStorPassiveInitializeRoutine</li>
<li>����ȷ�Ļص��г�ʼ�� PoFx</li>
</ul>
<ol start="2">
<li>Unit ֧�֣�</li>
</ol>
<ul>
<li>ͨ�� HwStorUnitControl �� ScsiUnitPoFxPowerInfo ʵ��</li>
<li>Ϊÿ�� Unit �������� PoFx</li>
</ul>
<ol start="3">
<li>���������</li>
</ol>
<ul>
<li>�洢�豸ֻʹ��һ����������� 0��</li>
<li>���� PoFx API ����ʹ��������� 0</li>
</ul>
<p>������ʵ�ָ����� Storport �淶Ҫ��</p>
<h2 id="User-11"><a href="#User-11" class="headerlink" title="User:"></a>User:</h2><p>[selections]  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HW_PASSIVE_INITIALIZE_ROUTINE	StorHwPassiveInitialize;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scsi_HwUnitControl</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>[text]<br>���鵱ǰ���� @Codebase   @StorHwPassiveInitialize  @@scsi_HwUnitControl(PVOID, SCSI_UNIT_CONTROL_TYPE, PVOID) ����Ϊ�Ѿ����Ϲ淶</p>
<h2 id="AI-claude-3-5-sonnet-11"><a href="#AI-claude-3-5-sonnet-11" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�����������Ϊ��ǰʵ�ֻ������� Storport �淶�����м�����Ҫע������ƣ�</p>
<ol>
<li>StorHwPassiveInitialize ʵ�ֻ�����ȷ��</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN</span><br><span class="line"></span><br><span class="line">StorHwPassiveInitialize(IN PVOID DeviceExtension)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_OS_ENTRY, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;Enter %s\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    UCHAR i;</span><br><span class="line"></span><br><span class="line">    ULONG status = STOR_STATUS_SUCCESS;</span><br><span class="line"></span><br><span class="line">    BOOLEAN enableD3Cold = FALSE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    req_global_init(pdx); //todo failed then FindAdapter failed</span><br><span class="line"></span><br><span class="line">    DevMapAdd(pdx); // call this to add pdx to Map   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // Registry RTD3 en controls POfx register process.</span><br><span class="line"></span><br><span class="line">    if (pdx-&gt;pm_state.rtd3_en != TRUE)</span><br><span class="line"></span><br><span class="line">        goto Exit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //</span><br><span class="line"></span><br><span class="line">    // Get and cache D3Cold support.  </span><br><span class="line"></span><br><span class="line">    //</span><br><span class="line"></span><br><span class="line">     status = StorPortGetD3ColdSupport(DeviceExtension, NULL, &amp;enableD3Cold);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     if (status == STOR_STATUS_SUCCESS) &#123;</span><br><span class="line"></span><br><span class="line">         DbgInfo(MODULE_OS_ENTRY, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;d3Coldsupported %0x\n&quot;, enableD3Cold);</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    os_memset((PCHAR)(&amp;(pdx-&gt;os.AdptPoFxDevice)), 0, sizeof(STOR_POFX_DEVICE_V2));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Version = STOR_POFX_DEVICE_VERSION_V2;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Size = STOR_POFX_DEVICE_V2_SIZE;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.ComponentCount = 1;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // indicate dump miniport can&#x27;t bring adapter to active</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_NO_DUMP_ACTIVE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].Version = STOR_POFX_COMPONENT_VERSION_V1;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].Size = STOR_POFX_COMPONENT_SIZE;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].FStateCount = 1;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].DeepestWakeableFState = 0;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].Id = STORPORT_POFX_ADAPTER_GUID;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].Version = STOR_POFX_COMPONENT_IDLE_STATE_VERSION_V1;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].Size = STOR_POFX_COMPONENT_IDLE_STATE_SIZE;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].TransitionLatency = 0;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].ResidencyRequirement = 0;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].NominalPower = STOR_POFX_UNKNOWN_POWER;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // registry runtime power management for Adapter</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_IDLE_TIMEOUT;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_ADAPTER_D3_WAKE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //pdx-&gt;os.AdptPoFxDevice.AdapterIdleTimeoutInMS = 1000; //10ms Idle tiemout for D3.</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.AdapterIdleTimeoutInMS = pdx-&gt;cfg-&gt;feature_item.psd_mode.adapter_idle_time_s * 1000; //The unit is 1ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    status = StorPortInitializePoFxPower(DeviceExtension, NULL, (PSTOR_POFX_DEVICE)(&amp;(pdx-&gt;os.AdptPoFxDevice)), &amp;enableD3Cold);</span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_OS_ENTRY, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;%s StorPortInitializePoFxPower=%x,enableD3Cold=%x\n&quot;,</span><br><span class="line"></span><br><span class="line">            __TIME__, status, enableD3Cold);</span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_OS_ENTRY, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;pdx-&gt;os.AdptPoFxDevice.AdapterIdleTimeoutInMS =%d ,pdx-&gt;os.AdptPoFxDevice.Flags=%x , STOR_STATUS_SUCCESS=%x\n&quot;,</span><br><span class="line"></span><br><span class="line">            pdx-&gt;os.AdptPoFxDevice.AdapterIdleTimeoutInMS, pdx-&gt;os.AdptPoFxDevice.Flags, STOR_STATUS_SUCCESS);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if(status != STOR_STATUS_SUCCESS)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        pdx-&gt;os.StateFlags.PoFxEnabled = FALSE;</span><br><span class="line"></span><br><span class="line">        pdx-&gt;os.StateFlags.PoFxActive = FALSE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        goto Exit;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // register success</span><br><span class="line"></span><br><span class="line">    // win_rtd3_req_wait_wake(pdx);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.StateFlags.PoFxEnabled = TRUE;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.StateFlags.PoFxActive = TRUE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exit:</span><br><span class="line"></span><br><span class="line">    //create work thread at end of stor-initialization entry.</span><br><span class="line"></span><br><span class="line">    os_create_thread(pdx, &amp;pdx-&gt;os.thread[0], pdx, thread_main);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_OS_ENTRY, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;Exit %s\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line">    return TRUE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>��Ҫ������</p>
<ul>
<li>��ȷ��ʼ�� STOR_POFX_DEVICE_V2 �ṹ</li>
<li>��������ȷ�� Version �� ComponentCount</li>
<li>������ IDLE_TIMEOUT ��־</li>
<li>���� StorPortInitializePoFxPower</li>
</ul>
<ol start="2">
<li>���� HwAdapterControl �е� PoFx ������������</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">case ScsiAdapterPoFxPowerControl:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    break;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>��Ҫ���� ScsiAdapterPoFxPowerControl �Ĵ�����</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> ScsiAdapterPoFxPowerControl:</span><br><span class="line">&#123;</span><br><span class="line">    PSCSI_PO_FX_POWER_CONTROL poFxControl = </span><br><span class="line">        (PSCSI_PO_FX_POWER_CONTROL)Parameters;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">switch</span>(poFxControl-&gt;PowerControlCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> ScsiPoFxPowerControlComponentActive:</span><br><span class="line">            <span class="comment">// ����豸��ʼ��</span></span><br><span class="line">            <span class="keyword">if</span> (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD0) &#123;</span><br><span class="line">                pcr_part_a_restore(pdx);</span><br><span class="line">                pcr_part_b_restore(pdx);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ScsiPoFxPowerControlComponentIdle:</span><br><span class="line">            <span class="comment">// ׼������͹���״̬</span></span><br><span class="line">            pcr_part_a_backup(pdx);</span><br><span class="line">            pcr_part_b_backup(pdx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Unit ����� PoFx ֧���Ѿ�ʵ�֣�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">    if(sd_bus_PoFxEnabled(sdbusport_ext))</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        ULONG status;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        status = StorPortPoFxActivateComponent((bht_dev_ext_t *)(sdbusport_ext-&gt;AdapterExtension),</span><br><span class="line"></span><br><span class="line">                                               (PSTOR_ADDRESS)&amp;sdbusport_ext-&gt;DeviceExtension[0].DeviceAddress,</span><br><span class="line"></span><br><span class="line">                                               (PSCSI_REQUEST_BLOCK)Srb,</span><br><span class="line"></span><br><span class="line">                                               0,</span><br><span class="line"></span><br><span class="line">                                               0);</span><br><span class="line"></span><br><span class="line">        // STOR_STATUS_BUSY indicates that ActivateComponent is not completed yet.</span><br><span class="line"></span><br><span class="line">        idle = (status == STOR_STATUS_BUSY);</span><br><span class="line"></span><br><span class="line">        DbgInfo(MODULE_OS_ENTRYAPI, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;rtget---StorPortPoFxActivateComponent =%x\n&quot;, status);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if((status == STOR_STATUS_SUCCESS) || (status == STOR_STATUS_BUSY))</span><br><span class="line"></span><br><span class="line">            referenceAcquired = TRUE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    else</span><br><span class="line"></span><br><span class="line">        UNREFERENCED_PARAMETER(Srb);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if(InIdle != NULL)</span><br><span class="line"></span><br><span class="line">        *InIdle = idle;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    return referenceAcquired;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>������</p>
<ul>
<li>��ȷʹ�� StorPortPoFxActivateComponent</li>
<li>���� STOR_STATUS_BUSY ״̬</li>
<li>ʵ�������ü�������</li>
</ul>
<p>����Ľ���</p>
<ol>
<li>�� StorHwPassiveInitialize �����Ӵ�������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (status != STOR_STATUS_SUCCESS) &#123;</span><br><span class="line">    DbgErr(<span class="string">&quot;StorPortInitializePoFxPower failed: %x\n&quot;</span>, status);</span><br><span class="line">    <span class="keyword">return</span> FALSE;  <span class="comment">// ���� FALSE ��ʾ��ʼ��ʧ��</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>���ƼĴ������ʵ�״̬��飺</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">if (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD0) &#123;</span><br><span class="line"></span><br><span class="line">    pci_writel(&amp;pdx-&gt;host, 0xdc, pdx-&gt;pm_state.reg_0xdc);</span><br><span class="line"></span><br><span class="line">    pci_writel(&amp;pdx-&gt;host, 0x3e0, pdx-&gt;pm_state.reg_0x3e0);</span><br><span class="line"></span><br><span class="line">    pci_writel(&amp;pdx-&gt;host, 0x3e8, pdx-&gt;pm_state.reg_0x3e8);</span><br><span class="line"></span><br><span class="line">    pci_writel(&amp;pdx-&gt;host, 0x3ec, pdx-&gt;pm_state.reg_0x3ec);</span><br><span class="line"></span><br><span class="line">    pci_writel(&amp;pdx-&gt;host, 0xf4, pdx-&gt;pm_state.reg_0xf4);</span><br><span class="line"></span><br><span class="line">    pci_writel(&amp;pdx-&gt;host, 0x74, pdx-&gt;pm_state.reg_0x74);</span><br><span class="line"></span><br><span class="line">    pci_writel(&amp;pdx-&gt;host, 0xf0, pdx-&gt;pm_state.reg_0xf0);</span><br><span class="line"></span><br><span class="line">    pci_writel(&amp;pdx-&gt;host, 0x90, pdx-&gt;pm_state.reg_0x90);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">else &#123; //D3</span><br><span class="line"></span><br><span class="line">    pci_cfgio_writel(&amp;pdx-&gt;host, 0xdc, pdx-&gt;pm_state.reg_0xdc);</span><br></pre></td></tr></table></figure>


<p>�ⲿ�ִ����Ѿ���ȷ������ D0&#x2F;D3 ״̬�µļĴ������ʲ��졣</p>
<p>������˵����ǰʵ�ַ��� Storport �淶��ֻ��Ҫ���� ScsiAdapterPoFxPowerControl �Ĵ������ɡ�</p>
<h2 id="User-12"><a href="#User-12" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>ScsiAdapterPoFxPowerControl�Ĺ�����ʲô���������, ��ο� @Codebase @Web </p>
<h2 id="AI-claude-3-5-sonnet-12"><a href="#AI-claude-3-5-sonnet-12" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>���� <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/storage/storport-pofx">Storport PoFx �ĵ�</a> �ʹ���⣬ScsiAdapterPoFxPowerControl �� PoFx �������֪ͨ miniport �������״̬�仯�Ļص���</p>
<p>��Ҫ�� scsi_HwAdapterControl �����ƴ˴�����</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">case ScsiAdapterPoFxPowerControl:</span><br><span class="line">&#123;</span><br><span class="line">    PSCSI_PO_FX_POWER_CONTROL poFxControl = </span><br><span class="line">        (PSCSI_PO_FX_POWER_CONTROL)Parameters;</span><br><span class="line">    </span><br><span class="line">    switch(poFxControl-&gt;PowerControlCode) &#123;</span><br><span class="line">        case ScsiPoFxPowerControlComponentIdle:</span><br><span class="line">            // ����������״̬</span><br><span class="line">            if (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD0) &#123;</span><br><span class="line">                // ����Ĵ���״̬���ο����д���:</span><br><span class="line">                // SDSTORDriver/sdstor/main/pmfunc.c startLine: 290 endLine: 306</span><br><span class="line">                req_pre_enter_d3(pdx);</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case ScsiPoFxPowerControlComponentActive:</span><br><span class="line">            // ����ָ��״̬</span><br><span class="line">            if (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD0) &#123;</span><br><span class="line">                // �ָ��豸״̬</span><br><span class="line">                req_exit_d3(pdx);</span><br><span class="line">                </span><br><span class="line">                // �����ӳٵ�����</span><br><span class="line">                ProcessDeferredRequests(pdx);</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case ScsiPoFxPowerControlComponentIdleState:</span><br><span class="line">            // F-state �ı�֪ͨ</span><br><span class="line">            ULONG newFState = poFxControl-&gt;PowerParameters.FState;</span><br><span class="line">            if (newFState == 0) &#123;</span><br><span class="line">                // F0 ״̬ - ��ȫ����</span><br><span class="line">                pdx-&gt;pm_state.current_fstate = 0;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // F1 �����ĵ͹���״̬</span><br><span class="line">                pdx-&gt;pm_state.current_fstate = newFState;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ��㣺</p>
<ol>
<li>�˻ص��� StorPortPoFxActivateComponent&#x2F;IdleComponent ��ϣ�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">    if(sd_bus_PoFxEnabled(sdbusport_ext))</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        ULONG status;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        status = StorPortPoFxActivateComponent((bht_dev_ext_t *)(sdbusport_ext-&gt;AdapterExtension),</span><br><span class="line"></span><br><span class="line">                                               (PSTOR_ADDRESS)&amp;sdbusport_ext-&gt;DeviceExtension[0].DeviceAddress,</span><br><span class="line"></span><br><span class="line">                                               (PSCSI_REQUEST_BLOCK)Srb,</span><br><span class="line"></span><br><span class="line">                                               0,</span><br><span class="line"></span><br><span class="line">                                               0);</span><br><span class="line"></span><br><span class="line">        // STOR_STATUS_BUSY indicates that ActivateComponent is not completed yet.</span><br><span class="line"></span><br><span class="line">        idle = (status == STOR_STATUS_BUSY);</span><br><span class="line"></span><br><span class="line">        DbgInfo(MODULE_OS_ENTRYAPI, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;rtget---StorPortPoFxActivateComponent =%x\n&quot;, status);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if((status == STOR_STATUS_SUCCESS) || (status == STOR_STATUS_BUSY))</span><br><span class="line"></span><br><span class="line">            referenceAcquired = TRUE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    else</span><br><span class="line"></span><br><span class="line">        UNREFERENCED_PARAMETER(Srb);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if(InIdle != NULL)</span><br><span class="line"></span><br><span class="line">        *InIdle = idle;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    return referenceAcquired;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ol start="2">
<li>��Ҫ�� D-state ״̬ͬ����</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">DbgInfo(MODULE_OS_ENTRY, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;ScsiAdapterPower - %s\n&quot;,</span><br><span class="line"></span><br><span class="line">        adpt_pow-&gt;PowerState == StorPowerDeviceD0 ? &quot;D0&quot; : &quot;D3&quot;);</span><br><span class="line"></span><br><span class="line">PrintMsg(&quot;ScsiAdapterPower - %s!\n&quot;, adpt_pow-&gt;PowerState == StorPowerDeviceD0 ? &quot;D0&quot; : &quot;D3&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//Record the D-state, WDM driver must handle it well. Every time D-state is changed, it must be changed here.</span><br><span class="line"></span><br><span class="line">pdx-&gt;pm_state.d0d3_state = adpt_pow-&gt;PowerState;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if(StorPowerActionNone == adpt_pow-&gt;PowerAction</span><br><span class="line"></span><br><span class="line">        &amp;&amp; StorPowerDeviceD3  == adpt_pow-&gt;PowerState)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_OS_ENTRY, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;Enter Runtime D3!\n&quot;);</span><br><span class="line"></span><br><span class="line">    PrintMsg(&quot;Enter Runtime D3!\n&quot;);</span><br><span class="line"></span><br><span class="line">    pdx-&gt;pm_state.rtd3_entered = TRUE;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;pre_card.s3s4_resume_for_card_init = TRUE;</span><br><span class="line"></span><br><span class="line">    // if (FALSE == os_pending_thread(pdx, TRUE))  //for thread sync : such as autotimer stop infinite</span><br><span class="line"></span><br><span class="line">    //     DbgErr(&quot;%s pending thread failed\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line">    req_pre_enter_d3(pdx);</span><br><span class="line"></span><br><span class="line">    req_enter_d3(pdx);</span><br><span class="line"></span><br><span class="line">    //os_pending_thread(pdx, FALSE);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ol start="3">
<li>��Ҫ���ܣ�</li>
</ol>
<ul>
<li>�����������&#x2F;�˳�����״̬</li>
<li>���� F-state �仯</li>
<li>ȷ���� D-state ״̬��ȷЭ��</li>
<li>�����豸�Ĵ���״̬</li>
</ul>
<ol start="4">
<li>ע�����</li>
</ol>
<ul>
<li>ֻ�� D0 ״̬�·����豸�Ĵ���</li>
<li>��ȷ�����ӳٵ�����</li>
<li>ά����ȷ�Ĺ���״̬��־</li>
</ul>
<p>������ʵ�ֿ���ȷ�� PoFx �������豸״̬��������ȷЭ����</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/08/30/Cursor%E8%AE%B0%E5%BD%95-20241111-%E5%85%B3%E4%BA%8EStorport%20Pofx%E5%92%8CSD%20Host%20WDF%E9%A9%B1%E5%8A%A8%E6%9E%B6%E6%9E%84%E6%96%87%E6%A1%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/30/Cursor%E8%AE%B0%E5%BD%95-20241111-%E5%85%B3%E4%BA%8EStorport%20Pofx%E5%92%8CSD%20Host%20WDF%E9%A9%B1%E5%8A%A8%E6%9E%B6%E6%9E%84%E6%96%87%E6%A1%A3/" class="post-title-link" itemprop="url">Cursor��¼-����Storport Pofx��SD Host WDF�����ܹ��ĵ�</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-08-30 15:50:54" itemprop="dateCreated datePublished" datetime="2024-08-30T15:50:54+08:00">2024-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:12:26" itemprop="dateModified" datetime="2025-11-04T17:12:26+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI%EF%BF%BD%EF%BF%BD%EF%BF%BD/" itemprop="url" rel="index"><span itemprop="name">AI���</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Cursor��¼-20241111-����Storport-Pofx��SD-Host-WDF�����ܹ��j�"><a href="#Cursor��¼-20241111-����Storport-Pofx��SD-Host-WDF�����ܹ��j�" class="headerlink" title="Cursor��¼-20241111-����Storport Pofx��SD Host WDF�����ܹ��ĵ�"></a>Cursor��¼-20241111-����Storport Pofx��SD Host WDF�����ܹ��ĵ�</h1><h1 id="Chat-Transcript-Tab-2"><a href="#Chat-Transcript-Tab-2" class="headerlink" title="Chat Transcript - Tab 2"></a>Chat Transcript - Tab 2</h1><h2 id="User"><a href="#User" class="headerlink" title="User:"></a>User:</h2><p>[selections]  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> DBG</span></span><br></pre></td></tr></table></figure>
<p>[text]<br>DBG�����ﱻ����</p>
<h2 id="AI-claude-3-5-sonnet"><a href="#AI-claude-3-5-sonnet" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��Windows���������У�<code>DBG</code>ͨ��������Ŀ���û����ѡ���ж���ġ������¼��ֳ����Ķ��巽ʽ��</p>
<ol>
<li>����Ŀ�����У�</li>
</ol>
<ul>
<li>Debug���û��Զ�����<code>DBG=1</code></li>
<li>Release�����򲻻ᶨ��<code>DBG</code></li>
</ul>
<ol start="2">
<li>��Դ�����У��������driver.h�ļ����ͷ�������¶��壺</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#ifndef DBG</span><br><span class="line">#if defined(DEBUG) || defined(_DEBUG)</span><br><span class="line">#define DBG 1</span><br><span class="line">#else</span><br><span class="line">#define DBG 0</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>

<p>������driver.h�ļ����ͷ������δ��룬��<code>#pragma once</code>֮�󼴿ɣ�</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#pragma once</span><br><span class="line">#pragma code_page(65001)  // UTF-8����</span><br><span class="line"></span><br><span class="line">// ����DBG����</span><br><span class="line">#ifndef DBG</span><br><span class="line">#if defined(DEBUG) || defined(_DEBUG)</span><br><span class="line">#define DBG 1</span><br><span class="line">#else</span><br><span class="line">#define DBG 0</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">// �������뱣�ֲ���...</span><br></pre></td></tr></table></figure>

<p>��������ȷ����</p>
<ol>
<li>��Debug���������õ������</li>
<li>��Release�����½��õ������</li>
<li>��Visual Studio��Ĭ����Ϊ����һ��</li>
</ol>
<h2 id="User-1"><a href="#User-1" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>���DriverEntry�Ƿ��е��´�BSOD �Ĵ��룺SYSTEM_THREAD_EXCEPTION_NOT_HANDLED (7e)<br>This is a very common BugCheck.  Usually the exception address pinpoints<br>the driver&#x2F;function that caused the problem.  Always note this address<br>as well as the link date of the driver&#x2F;image that contains this address.<br>Arguments:<br>Arg1: ffffffffc0000005, The exception code that was not handled<br>Arg2: fffff80754b545c8, The address that the exception occurred at<br>Arg3: ffffa70af8fbaf08, Exception Record Address<br>Arg4: ffffa70af8fba720, Context Record Address</p>
<h2 id="AI-claude-3-5-sonnet-1"><a href="#AI-claude-3-5-sonnet-1" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õ�,���Ұ�������ܵ��� SYSTEM_THREAD_EXCEPTION_NOT_HANDLED (0x7E) �����ĳ���ԭ���������ͨ�������ڷ�����Ч�ڴ��ַ����ġ�</p>
<p>��������Ҫ�� DriverEntry �м��Ĺؼ���:</p>
<ol>
<li>���ָ���ʼ����ʹ��:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS DriverEntry(</span><br><span class="line">    _In_ PDRIVER_OBJECT  DriverObject,</span><br><span class="line">    _In_ PUNICODE_STRING RegistryPath</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    // 1. ��֤����</span><br><span class="line">    if (DriverObject == NULL || RegistryPath == NULL) &#123;</span><br><span class="line">        return STATUS_INVALID_PARAMETER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 2. ��ʼ�� WDF ��������</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;config, O2MicroEvtDeviceAdd);</span><br><span class="line"></span><br><span class="line">    // 3. ������������ǰ�������ڴ�</span><br><span class="line">    WDFDRIVER driver = NULL;</span><br><span class="line">    </span><br><span class="line">    // 4. ʹ�� try/except �����ؼ�����</span><br><span class="line">    __try &#123;</span><br><span class="line">        // ���� WDF ��������</span><br><span class="line">        NTSTATUS status = WdfDriverCreate(</span><br><span class="line">            DriverObject,</span><br><span class="line">            RegistryPath,</span><br><span class="line">            WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">            &amp;config,</span><br><span class="line">            &amp;driver);</span><br><span class="line">        </span><br><span class="line">        if (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            O2MICRO_LOG_ERROR(&quot;WdfDriverCreate failed with status %!STATUS!&quot;, status);</span><br><span class="line">            return status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __except(EXCEPTION_EXECUTE_HANDLER) &#123;</span><br><span class="line">        O2MICRO_LOG_ERROR(&quot;Exception caught in DriverEntry&quot;);</span><br><span class="line">        return STATUS_UNHANDLED_EXCEPTION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Ҫ����:</p>
<ol>
<li>���Ӳ�����֤</li>
<li>ʹ�� __try&#x2F;__except �����ؼ�����</li>
<li>ȷ������ָ����ʹ��ǰ���ѳ�ʼ��</li>
<li>������ϸ�Ĵ�����־</li>
<li>����ֱ�ӷ���Ӳ��,Ӧ���� EvtDevicePrepareHardware �н���</li>
</ol>
<p>�������ܵ�ԭ��:</p>
<ol>
<li>��������Ƿ���ȷǩ��</li>
<li>ȷ�� WDF&#x2F;WDM �汾������</li>
<li>��֤��������˳���Ƿ���ȷ</li>
<li>���ϵͳ������Ҫ��</li>
</ol>
<p>������ԵĻ�,���ṩ:</p>
<ol>
<li>������ DriverEntry ����</li>
<li>����ʱ�ĵ���ջ��Ϣ</li>
<li>WinDbg �� !analyze -v ���</li>
</ol>
<p>�����ҿ��Ը�׼ȷ�ض�λ���⡣</p>
<h2 id="User-2"><a href="#User-2" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>WinDbg �� !analyze -v �����: kd&gt; !analyze -v</p>
<hr>
<ul>
<li><pre><code>                                                                        *
</code></pre>
</li>
<li><pre><code>                   Bugcheck Analysis                                    *
</code></pre>
</li>
<li><pre><code>                                                                        *
</code></pre>
</li>
</ul>
<hr>
<p>SYSTEM_THREAD_EXCEPTION_NOT_HANDLED (7e)<br>This is a very common BugCheck.  Usually the exception address pinpoints<br>the driver&#x2F;function that caused the problem.  Always note this address<br>as well as the link date of the driver&#x2F;image that contains this address.<br>Arguments:<br>Arg1: ffffffffc0000005, The exception code that was not handled<br>Arg2: fffff80754b545c8, The address that the exception occurred at<br>Arg3: ffffa70af8fbaf08, Exception Record Address<br>Arg4: ffffa70af8fba720, Context Record Address</p>
<h2 id="Debugging-Details"><a href="#Debugging-Details" class="headerlink" title="Debugging Details:"></a>Debugging Details:</h2><p>KEY_VALUES_STRING: 1</p>
<pre><code>Key  : AV.Dereference
Value: NullClassPtr

Key  : AV.Fault
Value: Read

Key  : Analysis.CPU.mSec
Value: 2359

Key  : Analysis.Elapsed.mSec
Value: 2620

Key  : Analysis.IO.Other.Mb
Value: 0

Key  : Analysis.IO.Read.Mb
Value: 0

Key  : Analysis.IO.Write.Mb
Value: 0

Key  : Analysis.Init.CPU.mSec
Value: 390

Key  : Analysis.Init.Elapsed.mSec
Value: 3531

Key  : Analysis.Memory.CommitPeak.Mb
Value: 104

Key  : Bugcheck.Code.LegacyAPI
Value: 0x1000007e

Key  : Bugcheck.Code.TargetModel
Value: 0x1000007e

Key  : Dump.Attributes.AsUlong
Value: 1808

Key  : Dump.Attributes.DiagDataWrittenToHeader
Value: 1

Key  : Dump.Attributes.ErrorCode
Value: 0

Key  : Dump.Attributes.KernelGeneratedTriageDump
Value: 1

Key  : Dump.Attributes.LastLine
Value: Dump completed successfully.

Key  : Dump.Attributes.ProgressPercentage
Value: 0

Key  : Failure.Bucket
Value: AV_o2micro_sdhost!unknown_function

Key  : Failure.Hash
Value: {675c0c01-465e-ed53-efc7-4c82b345b89c}

Key  : Hypervisor.Enlightenments.ValueHex
Value: 1417cf94

Key  : Hypervisor.Flags.AnyHypervisorPresent
Value: 1

Key  : Hypervisor.Flags.ApicEnlightened
Value: 1

Key  : Hypervisor.Flags.ApicVirtualizationAvailable
Value: 0

Key  : Hypervisor.Flags.AsyncMemoryHint
Value: 0

Key  : Hypervisor.Flags.CoreSchedulerRequested
Value: 0

Key  : Hypervisor.Flags.CpuManager
Value: 1

Key  : Hypervisor.Flags.DeprecateAutoEoi
Value: 0

Key  : Hypervisor.Flags.DynamicCpuDisabled
Value: 1

Key  : Hypervisor.Flags.Epf
Value: 0

Key  : Hypervisor.Flags.ExtendedProcessorMasks
Value: 1

Key  : Hypervisor.Flags.HardwareMbecAvailable
Value: 1

Key  : Hypervisor.Flags.MaxBankNumber
Value: 0

Key  : Hypervisor.Flags.MemoryZeroingControl
Value: 0

Key  : Hypervisor.Flags.NoExtendedRangeFlush
Value: 0

Key  : Hypervisor.Flags.NoNonArchCoreSharing
Value: 1

Key  : Hypervisor.Flags.Phase0InitDone
Value: 1

Key  : Hypervisor.Flags.PowerSchedulerQos
Value: 0

Key  : Hypervisor.Flags.RootScheduler
Value: 0

Key  : Hypervisor.Flags.SynicAvailable
Value: 1

Key  : Hypervisor.Flags.UseQpcBias
Value: 0

Key  : Hypervisor.Flags.Value
Value: 4853999

Key  : Hypervisor.Flags.ValueHex
Value: 4a10ef

Key  : Hypervisor.Flags.VpAssistPage
Value: 1

Key  : Hypervisor.Flags.VsmAvailable
Value: 1

Key  : Hypervisor.RootFlags.AccessStats
Value: 1

Key  : Hypervisor.RootFlags.CrashdumpEnlightened
Value: 1

Key  : Hypervisor.RootFlags.CreateVirtualProcessor
Value: 1

Key  : Hypervisor.RootFlags.DisableHyperthreading
Value: 0

Key  : Hypervisor.RootFlags.HostTimelineSync
Value: 1

Key  : Hypervisor.RootFlags.HypervisorDebuggingEnabled
Value: 0

Key  : Hypervisor.RootFlags.IsHyperV
Value: 1

Key  : Hypervisor.RootFlags.LivedumpEnlightened
Value: 1

Key  : Hypervisor.RootFlags.MapDeviceInterrupt
Value: 1

Key  : Hypervisor.RootFlags.MceEnlightened
Value: 1

Key  : Hypervisor.RootFlags.Nested
Value: 0

Key  : Hypervisor.RootFlags.StartLogicalProcessor
Value: 1

Key  : Hypervisor.RootFlags.Value
Value: 1015

Key  : Hypervisor.RootFlags.ValueHex
Value: 3f7
</code></pre>
<p>BUGCHECK_CODE:  7e</p>
<p>BUGCHECK_P1: ffffffffc0000005</p>
<p>BUGCHECK_P2: fffff80754b545c8</p>
<p>BUGCHECK_P3: ffffa70af8fbaf08</p>
<p>BUGCHECK_P4: ffffa70af8fba720</p>
<p>FILE_IN_CAB:  110724-109109-01.dmp</p>
<p>DUMP_FILE_ATTRIBUTES: 0x1808<br>  Kernel Generated Triage Dump</p>
<p>FAULTING_THREAD:  ffffbb0f5440e040</p>
<p>EXCEPTION_RECORD:  ffffa70af8fbaf08 – (.exr 0xffffa70af8fbaf08)<br>ExceptionAddress: fffff80754b545c8 (o2micro_sdhost+0x00000000000045c8)<br>   ExceptionCode: c0000005 (Access violation)<br>  ExceptionFlags: 00000000<br>NumberParameters: 2<br>   Parameter[0]: 0000000000000000<br>   Parameter[1]: 00000000000003a0<br>Attempt to read from address 00000000000003a0</p>
<p>CONTEXT:  ffffa70af8fba720 – (.cxr 0xffffa70af8fba720)<br>rax&#x3D;00000000000003a0 rbx&#x3D;ffffbb0f589fd000 rcx&#x3D;0000000000000000<br>rdx&#x3D;ffffbb0f589fd000 rsi&#x3D;ffffbb0f5970589d rdi&#x3D;ffffbb0f54fbb560<br>rip&#x3D;fffff80754b545c8 rsp&#x3D;ffffa70af8fbb140 rbp&#x3D;ffffa70af8fbb370<br> r8&#x3D;0000000000000000  r9&#x3D;ffffa70af8fbb1e8 r10&#x3D;72206d6f7266206c<br>r11&#x3D;ffffbb0f517f7028 r12&#x3D;ffffffff80001b54 r13&#x3D;0000000000000002<br>r14&#x3D;ffffbb0f54fbb560 r15&#x3D;ffffa98869a1c610<br>iopl&#x3D;0         nv up ei pl nz na po nc<br>cs&#x3D;0010  ss&#x3D;0018  ds&#x3D;002b  es&#x3D;002b  fs&#x3D;0053  gs&#x3D;002b             efl&#x3D;00050206<br>o2micro_sdhost+0x45c8:<br>fffff807<code>54b545c8 488b0401        mov     rax,qword ptr [rcx+rax] ds:002b:00000000</code>000003a0&#x3D;????????????????<br>Resetting default scope</p>
<p>BLACKBOXBSD: 1 (!blackboxbsd)</p>
<p>BLACKBOXNTFS: 1 (!blackboxntfs)</p>
<p>BLACKBOXPNP: 1 (!blackboxpnp)</p>
<p>BLACKBOXWINLOGON: 1</p>
<p>CUSTOMER_CRASH_COUNT:  1</p>
<p>PROCESS_NAME:  System</p>
<p>READ_ADDRESS: fffff8073171d470: Unable to get MiVisibleState<br>Unable to get NonPagedPoolStart<br>Unable to get NonPagedPoolEnd<br>Unable to get PagedPoolStart<br>Unable to get PagedPoolEnd<br>unable to get nt!MmSpecialPagesInUse<br> 00000000000003a0 </p>
<p>ERROR_CODE: (NTSTATUS) 0xc0000005 - 0x%p            0x%p                    %s</p>
<p>EXCEPTION_CODE_STR:  c0000005</p>
<p>EXCEPTION_PARAMETER1:  0000000000000000</p>
<p>EXCEPTION_PARAMETER2:  00000000000003a0</p>
<p>EXCEPTION_STR:  0xc0000005</p>
<p>STACK_TEXT:<br>ffffa70a<code>f8fbb140 ffffa70a</code>f8fbb370     : fffff807<code>30c04910 ffffbb0f</code>589fd000 ffffbb0f<code>5970589d ffffbb0f</code>54fbb560 : o2micro_sdhost+0x45c8<br>ffffa70a<code>f8fbb148 fffff807</code>30c04910     : ffffbb0f<code>589fd000 ffffbb0f</code>5970589d ffffbb0f<code>54fbb560 00000000</code>00000000 : 0xffffa70a<code>f8fbb370 ffffa70a</code>f8fbb150 fffff807<code>54b510e0     : ffffbb0f</code>54fbb560 ffffbb0f<code>589fd000 00000000</code>00000000 ffffa70a<code>f8fbb1e8 : nt!DbgPrintEx+0x30 ffffa70a</code>f8fbb1a0 ffffbb0f<code>54fbb560     : ffffbb0f</code>589fd000 00000000<code>00000000 ffffa70a</code>f8fbb1e8 00000000<code>00000000 : o2micro_sdhost+0x10e0 ffffa70a</code>f8fbb1a8 ffffbb0f<code>589fd000     : 00000000</code>00000000 ffffa70a<code>f8fbb1e8 00000000</code>00000000 00057e40<code>00002710 : 0xffffbb0f</code>54fbb560<br>ffffa70a<code>f8fbb1b0 00000000</code>00000000     : ffffa70a<code>f8fbb1e8 00000000</code>00000000 00057e40<code>00002710 fffff807</code>30f5e3a0 : 0xffffbb0f&#96;589fd000</p>
<p>SYMBOL_NAME:  o2micro_sdhost+45c8</p>
<p>MODULE_NAME: o2micro_sdhost</p>
<p>IMAGE_NAME:  o2micro_sdhost.sys</p>
<p>STACK_COMMAND:  .cxr 0xffffa70af8fba720 ; kb</p>
<p>BUCKET_ID_FUNC_OFFSET:  45c8</p>
<p>FAILURE_BUCKET_ID:  AV_o2micro_sdhost!unknown_function</p>
<p>OSPLATFORM_TYPE:  x64</p>
<p>OSNAME:  Windows 10</p>
<p>FAILURE_ID_HASH:  {675c0c01-465e-ed53-efc7-4c82b345b89c}</p>
<p>Followup:     MachineOwner</p>
<h2 id="AI-claude-3-5-sonnet-2"><a href="#AI-claude-3-5-sonnet-2" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�����ṩ������������������ڷ��ʿ�ָ�뵼�µ��쳣������������£�</p>
<ol>
<li>�������ͣ�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SYSTEM_THREAD_EXCEPTION_NOT_HANDLED (7e)</span><br><span class="line">ExceptionCode: c0000005 (Access violation)</span><br><span class="line">Attempt to read from address 00000000000003a0</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>�������λ�ã�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">o2micro_sdhost+0x45c8:</span><br><span class="line">fffff807`54b545c8 488b0401        mov     rax,qword ptr [rcx+rax]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>�Ĵ���״̬��</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rax=00000000000003a0 </span><br><span class="line">rcx=0000000000000000  // ���� rcx Ϊ NULL</span><br></pre></td></tr></table></figure>

<p>�����޸� DriverEntry ���������ӷ�����</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS DriverEntry(</span><br><span class="line">    _In_ PDRIVER_OBJECT  DriverObject,</span><br><span class="line">    _In_ PUNICODE_STRING RegistryPath</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    </span><br><span class="line">    // 1. ���Ӳ�����֤</span><br><span class="line">    if (DriverObject == NULL || RegistryPath == NULL) &#123;</span><br><span class="line">        return STATUS_INVALID_PARAMETER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 2. �����쳣����</span><br><span class="line">    __try &#123;</span><br><span class="line">        // ��ȡ���Լ���</span><br><span class="line">        status = O2MicroReadDebugLevelFromRegistry(RegistryPath);</span><br><span class="line">        if (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            O2MICRO_LOG_WARN(&quot;Failed to read debug level from registry, using default&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // ��ʼ��WDF��������</span><br><span class="line">        WDF_DRIVER_CONFIG_INIT(&amp;config, O2MicroEvtDeviceAdd);</span><br><span class="line">        </span><br><span class="line">        // ����WDF��������</span><br><span class="line">        status = WdfDriverCreate(</span><br><span class="line">            DriverObject,</span><br><span class="line">            RegistryPath,</span><br><span class="line">            WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">            &amp;config,</span><br><span class="line">            WDF_NO_HANDLE  // ȷ�������ʼ��</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        if (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            O2MICRO_LOG_ERROR(&quot;WdfDriverCreate failed: %!STATUS!&quot;, status);</span><br><span class="line">            return status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __except(EXCEPTION_EXECUTE_HANDLER) &#123;</span><br><span class="line">        O2MICRO_LOG_ERROR(&quot;Exception caught in DriverEntry&quot;);</span><br><span class="line">        return STATUS_UNHANDLED_EXCEPTION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    O2MICRO_LOG_INFO(&quot;Driver loaded successfully&quot;);</span><br><span class="line">    return status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Ҫ�޸Ľ��飺</p>
<ol>
<li>���Ӳ�����֤</li>
<li>ʹ�� __try&#x2F;__except �����ؼ�����</li>
<li>ȷ������ָ��ʹ��ǰ��������֤</li>
<li>������ϸ�Ĵ�����־</li>
<li>��� O2MicroReadDebugLevelFromRegistry �����е�ָ�����</li>
</ol>
<p>������������ڷ����� NULL ָ��(rcx)����ƫ����(0x3a0)���µģ�������ϸ��������漰ָ������Ĵ��룬�ر����ڵ�����־��صĺ����С�</p>
<h2 id="User-3"><a href="#User-3" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>��������Ƿ���ȷǩ��</p>
<h2 id="AI-claude-3-5-sonnet-3"><a href="#AI-claude-3-5-sonnet-3" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>Ҫ�������ǩ��������ͨ�����¼��ַ�����</p>
<ol>
<li>ʹ�� SignTool ��֤:</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">signtool verify /pa /v o2micro_sdhost.sys</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ʹ�� WinDbg ���:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">!drivers</span><br><span class="line">lm vm o2micro_sdhost</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>�������ǩ������:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">// �� INF �ļ�������ǩ������</span><br><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">Class=SDHost</span><br><span class="line">ClassGuid=&#123;4D36E978-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line">Provider=%ManufacturerName%</span><br><span class="line">CatalogFile=o2micro_sdhost.cat</span><br><span class="line">DriverVer=mm/dd/yyyy,x.y.z.0</span><br><span class="line">PnpLockdown=1</span><br><span class="line"></span><br><span class="line">[SourceDisksNames]</span><br><span class="line">1 = %DiskName%,,,&quot;&quot;</span><br><span class="line"></span><br><span class="line">[SourceDisksFiles]</span><br><span class="line">o2micro_sdhost.sys = 1,,</span><br><span class="line"></span><br><span class="line">; ... �������� ...</span><br><span class="line"></span><br><span class="line">[Manufacturer]</span><br><span class="line">%ManufacturerName%=Standard,NT$ARCH$</span><br><span class="line"></span><br><span class="line">[Standard.NT$ARCH$]</span><br><span class="line">%DeviceName%=O2Micro_Install,PCI\VEN_1217&amp;DEV_xxxx</span><br><span class="line"></span><br><span class="line">[O2Micro_Install.NT]</span><br><span class="line">CopyFiles=Drivers_Dir</span><br><span class="line">AddReg=O2Micro_Registry</span><br><span class="line"></span><br><span class="line">[O2Micro_Install.NT.Services]</span><br><span class="line">AddService = o2micro_sdhost,%SPSVCINST_ASSOCSERVICE%,O2Micro_Service_Inst</span><br><span class="line"></span><br><span class="line">[O2Micro_Service_Inst]</span><br><span class="line">DisplayName    = %ServiceName%</span><br><span class="line">ServiceType    = 1               ; SERVICE_KERNEL_DRIVER</span><br><span class="line">StartType      = 3               ; SERVICE_DEMAND_START</span><br><span class="line">ErrorControl   = 1               ; SERVICE_ERROR_NORMAL</span><br><span class="line">ServiceBinary  = %12%\o2micro_sdhost.sys</span><br><span class="line">LoadOrderGroup = Base</span><br><span class="line">Dependencies   = storahci</span><br><span class="line"></span><br><span class="line">[Drivers_Dir]</span><br><span class="line">o2micro_sdhost.sys</span><br><span class="line"></span><br><span class="line">[O2Micro_Registry]</span><br><span class="line">; ����ע�����</span><br><span class="line">HKR,,DeviceCharacteristics,0x10001,0x0100     ; Use same security checks on relative opens</span><br><span class="line">HKR,,Security,,&quot;D:P(A;;GA;;;BA)(A;;GA;;;SY)&quot;  ; Allow generic-all access to Built-in administrators and Local system</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>����ǩ����ش���:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">#pragma prefast(disable:28102) // �Ƴ� DRIVER_INITIALIZE ����</span><br><span class="line">#pragma prefast(disable:28103) // �Ƴ� DRIVER_UNLOAD ����</span><br><span class="line"></span><br><span class="line">DRIVER_INITIALIZE DriverEntry;</span><br><span class="line">DRIVER_UNLOAD DriverUnload;</span><br><span class="line"></span><br><span class="line">#ifdef ALLOC_PRAGMA</span><br><span class="line">#pragma alloc_text(INIT, DriverEntry)</span><br><span class="line">#pragma alloc_text(PAGE, DriverUnload)</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">// ����ǩ����֤</span><br><span class="line">NTSTATUS VerifyDriverSignature(</span><br><span class="line">    _In_ PDRIVER_OBJECT DriverObject</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    __try &#123;</span><br><span class="line">        // ��ȡ����ӳ��·��</span><br><span class="line">        UNICODE_STRING driverPath;</span><br><span class="line">        status = IoGetDriverDirectory(DriverObject, &amp;driverPath);</span><br><span class="line">        if (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            O2MICRO_LOG_ERROR(&quot;Failed to get driver path: %!STATUS!&quot;, status);</span><br><span class="line">            return status;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // ��֤ǩ��</span><br><span class="line">        DRIVER_OBJECT_PROPERTIES props = &#123;0&#125;;</span><br><span class="line">        props.Length = sizeof(DRIVER_OBJECT_PROPERTIES);</span><br><span class="line">        status = IoVerifyDriverObjectProperties(</span><br><span class="line">            DriverObject,</span><br><span class="line">            &amp;props</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        if (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            O2MICRO_LOG_ERROR(&quot;Driver signature verification failed: %!STATUS!&quot;, status);</span><br><span class="line">            return status;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        O2MICRO_LOG_INFO(&quot;Driver signature verified successfully&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    __except(EXCEPTION_EXECUTE_HANDLER) &#123;</span><br><span class="line">        status = STATUS_UNHANDLED_EXCEPTION;</span><br><span class="line">        O2MICRO_LOG_ERROR(&quot;Exception in signature verification&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// �� DriverEntry ������ǩ����֤</span><br><span class="line">NTSTATUS DriverEntry(</span><br><span class="line">    _In_ PDRIVER_OBJECT  DriverObject,</span><br><span class="line">    _In_ PUNICODE_STRING RegistryPath</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    // ��֤����ǩ��</span><br><span class="line">    status = VerifyDriverSignature(DriverObject);</span><br><span class="line">    if (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        return status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // ... ������ʼ������ ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>ǩ������:</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ����֤��</span></span><br><span class="line">makecert <span class="literal">-r</span> <span class="literal">-pe</span> <span class="literal">-ss</span> PrivateCertStore <span class="literal">-n</span> CN=O2MicroTest O2MicroTest.cer</span><br><span class="line"></span><br><span class="line"><span class="comment"># ����Ŀ¼</span></span><br><span class="line">mkdir signed</span><br><span class="line"></span><br><span class="line"><span class="comment"># ǩ������</span></span><br><span class="line">signtool sign /v /s PrivateCertStore /n O2MicroTest /t http://timestamp.digicert.com /fd sha256 o2micro_sdhost.sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># ����Ŀ¼</span></span><br><span class="line"><span class="built_in">copy</span> o2micro_sdhost.sys signed\</span><br><span class="line"></span><br><span class="line"><span class="comment"># ���� CAT �ļ�</span></span><br><span class="line">inf2<span class="built_in">cat</span> /driver:signed /os:<span class="number">10</span>_X64</span><br><span class="line"></span><br><span class="line"><span class="comment"># ǩ�� CAT �ļ�</span></span><br><span class="line">signtool sign /v /s PrivateCertStore /n O2MicroTest /t http://timestamp.digicert.com /fd sha256 signed\o2micro_sdhost.cat</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>���Ի�������:</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ���ò���ǩ��</span></span><br><span class="line">bcdedit /<span class="built_in">set</span> testsigning on</span><br><span class="line"></span><br><span class="line"><span class="comment"># ����ϵͳ</span></span><br><span class="line">shutdown /<span class="built_in">r</span> /t <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>��Ҫע������:</p>
<ol>
<li>������������ʹ�� EV ����ǩ��֤��</li>
<li>���Ի�������ʹ�ò���ǩ��</li>
<li>ȷ�� INF �ļ��еİ汾��Ϣ��ȷ</li>
<li>��֤ǩ��ʱ�������������</li>
<li>���֤����������</li>
<li>ȷ�������������ļ�δ���޸�</li>
</ol>
<p>����ʹ�� Windows �������򹤾߰�(WDK)�е� Driver Verifier ����ȫ����ԡ�</p>
<h2 id="User-4"><a href="#User-4" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>O2Micro��PCIe SD Host controller����������ʲô�豸class��Ӧ��ʹ��storport��WDF������WDM</p>
<h2 id="AI-claude-3-5-sonnet-4"><a href="#AI-claude-3-5-sonnet-4" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>����O2Micro��PCIe SD Host Controller�������ҽ�������ѡ��</p>
<ol>
<li>�豸�� (Device Class):</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">Class=SDHost                              ; ʹ��SDHost��</span><br><span class="line">ClassGuid=&#123;4D36E978-E325-11CE-BFC1-08002BE10318&#125;  ; SDHost��GUID</span><br><span class="line">Provider=%ManufacturerName%</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>����ģ��ѡ��<br>����ʹ�� <strong>Storport + WDF</strong> �Ļ��ģ�ͣ�ԭ�����£�</li>
</ol>
<p>a) Storport�����ƣ�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// storport.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;storport.h&gt;</span>  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ��HW_INITIALIZATION_DATA</span></span><br><span class="line">HW_INITIALIZATION_DATA hwInitData = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">hwInitData.HwInitializationDataSize = <span class="keyword">sizeof</span>(HW_INITIALIZATION_DATA);</span><br><span class="line">hwInitData.HwStartIo = O2MicroStartIo;</span><br><span class="line">hwInitData.HwInterrupt = O2MicroInterrupt;</span><br><span class="line">hwInitData.HwFindAdapter = O2MicroFindAdapter;</span><br><span class="line">hwInitData.HwResetBus = O2MicroResetBus;</span><br></pre></td></tr></table></figure>

<ul>
<li>ר��Ϊ�洢�豸�Ż�</li>
<li>�ṩ������I&#x2F;O����</li>
<li>���ö��й���</li>
<li>֧�ָ߼��洢����</li>
</ul>
<p>b) WDF�����ƣ�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ʹ��WDF����PnP�͵�Դ����</span></span><br><span class="line">WDF_DRIVER_CONFIG config;</span><br><span class="line">WDF_DRIVER_CONFIG_INIT(&amp;config, O2MicroEvtDeviceAdd);</span><br><span class="line">config.DriverInitFlags |= WdfDriverInitNonPnpDriver;</span><br></pre></td></tr></table></figure>

<ul>
<li>��PnP�͵�Դ����</li>
<li>�Զ�����Դ����</li>
<li>���õ��������֧��</li>
</ul>
<ol start="3">
<li>�ؼ�ʵ�ֽṹ��</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��������ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">O2MICRO_DRIVER_EXTENSION</span> &#123;</span></span><br><span class="line">    <span class="comment">// Storport���</span></span><br><span class="line">    STORPORT_DRIVER_EXTENSION StorPortExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// WDF���</span></span><br><span class="line">    WDFDRIVER WdfDriver;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸�ض�����</span></span><br><span class="line">    ULONG DeviceID;</span><br><span class="line">    ULONG VendorID;</span><br><span class="line">    DEVICE_POWER_STATE PowerState;</span><br><span class="line">    </span><br><span class="line">&#125; O2MICRO_DRIVER_EXTENSION, *PO2MICRO_DRIVER_EXTENSION;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �豸��չ�ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">O2MICRO_DEVICE_EXTENSION</span> &#123;</span></span><br><span class="line">    <span class="comment">// Storport�豸��չ</span></span><br><span class="line">    STORPORT_DEVICE_EXTENSION StorPortExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// WDF�豸����</span></span><br><span class="line">    WDFDEVICE WdfDevice;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SD�������Ĵ���</span></span><br><span class="line">    PVOID RegisterBase;</span><br><span class="line">    ULONG RegisterLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA���</span></span><br><span class="line">    STORPORT_DMA_EXTENSION DmaExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ж���Դ</span></span><br><span class="line">    WDFINTERRUPT Interrupt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    BOOLEAN CardPresent;</span><br><span class="line">    ULONG Capabilities;</span><br><span class="line">    </span><br><span class="line">&#125; O2MICRO_DEVICE_EXTENSION, *PO2MICRO_DEVICE_EXTENSION;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>��ʼ�����̣�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_DRIVER_CONFIG wdfConfig;</span><br><span class="line">    HW_INITIALIZATION_DATA hwInitData;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ʼ��WDF</span></span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;wdfConfig, O2MicroEvtDeviceAdd);</span><br><span class="line">    status = WdfDriverCreate(DriverObject, RegistryPath, </span><br><span class="line">                           WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                           &amp;wdfConfig, &amp;gWdfDriver);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ��Storport</span></span><br><span class="line">    RtlZeroMemory(&amp;hwInitData, <span class="keyword">sizeof</span>(HW_INITIALIZATION_DATA));</span><br><span class="line">    hwInitData.HwInitializationDataSize = <span class="keyword">sizeof</span>(HW_INITIALIZATION_DATA);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ûص�</span></span><br><span class="line">    hwInitData.HwFindAdapter = O2MicroFindAdapter;</span><br><span class="line">    hwInitData.HwInitialize = O2MicroInitialize;</span><br><span class="line">    hwInitData.HwStartIo = O2MicroStartIo;</span><br><span class="line">    hwInitData.HwInterrupt = O2MicroInterrupt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ע��Storport</span></span><br><span class="line">    status = StorPortInitialize(DriverObject,</span><br><span class="line">                              RegistryPath,</span><br><span class="line">                              &amp;hwInitData,</span><br><span class="line">                              <span class="literal">NULL</span>);</span><br><span class="line">                              </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>I&#x2F;O�������̣�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN <span class="title function_">O2MicroStartIo</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ PSCSI_REQUEST_BLOCK Srb</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PO2MICRO_DEVICE_EXTENSION devExt = (PO2MICRO_DEVICE_EXTENSION)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (Srb-&gt;Function) &#123;</span><br><span class="line">        <span class="keyword">case</span> SRB_FUNCTION_EXECUTE_SCSI:</span><br><span class="line">            <span class="comment">// ������д����</span></span><br><span class="line">            <span class="keyword">return</span> O2MicroProcessIO(devExt, Srb);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SRB_FUNCTION_RESET_DEVICE:</span><br><span class="line">            <span class="comment">// �����豸����</span></span><br><span class="line">            <span class="keyword">return</span> O2MicroResetDevice(devExt, Srb);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            Srb-&gt;SrbStatus = SRB_STATUS_INVALID_REQUEST;</span><br><span class="line">            StorPortNotification(RequestComplete, devExt, Srb);</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>��Դ������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">O2MicroEvtDeviceD0Entry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDF_POWER_DEVICE_STATE PreviousState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PO2MICRO_DEVICE_EXTENSION devExt;</span><br><span class="line">    devExt = GetDeviceExtension(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ָ�Ӳ��״̬</span></span><br><span class="line">    O2MicroInitializeHardware(devExt);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ֪ͨStorport</span></span><br><span class="line">    StorPortNotification(PowerStateChange, </span><br><span class="line">                        devExt,</span><br><span class="line">                        PowerStateD0);</span><br><span class="line">                        </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>���ֻ�ϼܹ����ԣ�</p>
<ol>
<li>����Storport�Ĵ洢�Ż�����</li>
<li>ʹ��WDF���豸����</li>
<li>�ṩ���õ����ܺͿɿ���</li>
<li>������ά���͵���</li>
</ol>
<p>�����ڿ���ʱ�ص��ע��</p>
<ul>
<li>��Դ����</li>
<li>DMA����</li>
<li>�жϴ���</li>
<li>����ָ�</li>
<li>�Ȳ��֧��</li>
</ul>
<h2 id="User-5"><a href="#User-5" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>Storpot �ܺ�WDFһ��������ΪPCIe SD Host controller������</p>
<h2 id="AI-claude-3-5-sonnet-5"><a href="#AI-claude-3-5-sonnet-5" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�����齫Storport��WDF���ʹ�á�����PCIe SD Host Controller������Ӧ��ѡ����������һ�ַ�����</p>
<ol>
<li>�Ƽ�������ʹ�ô�WDF (KMDF)</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// driver.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_CONTEXT</span> &#123;</span></span><br><span class="line">    WDFDEVICE       Device;</span><br><span class="line">    WDFINTERRUPT    Interrupt;</span><br><span class="line">    WDFDMAENABLER   DmaEnabler;</span><br><span class="line">    WDFQUEUE        IoQueue;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Ĵ���ӳ��</span></span><br><span class="line">    PVOID           RegisterBase;</span><br><span class="line">    ULONG           RegisterLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SD������״̬</span></span><br><span class="line">    BOOLEAN         CardPresent;</span><br><span class="line">    ULONG           Capabilities;</span><br><span class="line">    ULONG           CurrentState;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA���</span></span><br><span class="line">    PHYSICAL_ADDRESS PhysicalAddress;</span><br><span class="line">    PVOID           DmaBuffer;</span><br><span class="line">    SIZE_T          DmaBufferSize;</span><br><span class="line">    </span><br><span class="line">&#125; DEVICE_CONTEXT, *PDEVICE_CONTEXT;</span><br><span class="line"></span><br><span class="line">WDF_DECLARE_CONTEXT_TYPE_WITH_NAME(DEVICE_CONTEXT, GetDeviceContext)</span><br></pre></td></tr></table></figure>

<p>��Ҫ�ŵ㣺</p>
<ul>
<li>PnP�͵�Դ��������</li>
<li>�ڴ��������ȫ</li>
<li>�������������Զ�����</li>
<li>���ִ����������</li>
<li>�ʺ�PCIe�豸</li>
</ul>
<ol start="2">
<li>���������ʹ�ô�Storport</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">HW_DEVICE_EXTENSION</span> &#123;</span></span><br><span class="line">    STORPORT_DEVICE_EXTENSION StorPortExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SD�������Ĵ���</span></span><br><span class="line">    PVOID RegisterBase;</span><br><span class="line">    ULONG RegisterLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA���</span></span><br><span class="line">    STORPORT_DMA_EXTENSION DmaExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    BOOLEAN CardPresent;</span><br><span class="line">    ULONG Capabilities;</span><br><span class="line">    </span><br><span class="line">&#125; HW_DEVICE_EXTENSION, *PHW_DEVICE_EXTENSION;</span><br></pre></td></tr></table></figure>

<p>Storport���ʺϣ�</p>
<ul>
<li>��ͳ�洢������</li>
<li>SCSI�豸</li>
<li>RAID������</li>
</ul>
<p>����PCIe SD Host Controller���ҽ���ʹ�ô�WDF������ԭ���ǣ�</p>
<ol>
<li>�豸���Ը�ƥ�䣺</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �豸��ʼ��</span></span><br><span class="line">NTSTATUS <span class="title function_">O2MicroEvtDeviceAdd</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_    WDFDRIVER       Driver,</span></span><br><span class="line"><span class="params">    _Inout_ PWDFDEVICE_INIT DeviceInit</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ����ΪPCIe�豸</span></span><br><span class="line">    WdfDeviceInitSetDeviceType(DeviceInit, FILE_DEVICE_MASS_STORAGE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���õ�Դ����</span></span><br><span class="line">    WDF_POWER_POLICY_EVENT_CALLBACKS powerPolicyCallbacks;</span><br><span class="line">    WDF_POWER_POLICY_EVENT_CALLBACKS_INIT(&amp;powerPolicyCallbacks);</span><br><span class="line">    powerPolicyCallbacks.EvtDeviceArmWakeFromS0 = O2MicroEvtDeviceArmWakeFromS0;</span><br><span class="line">    powerPolicyCallbacks.EvtDeviceArmWakeFromSx = O2MicroEvtDeviceArmWakeFromSx;</span><br><span class="line">    WdfDeviceInitSetPowerPolicyEventCallbacks(DeviceInit, &amp;powerPolicyCallbacks);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����ж�</span></span><br><span class="line">    WDF_INTERRUPT_CONFIG interruptConfig;</span><br><span class="line">    WDF_INTERRUPT_CONFIG_INIT(&amp;interruptConfig,</span><br><span class="line">                            O2MicroEvtInterruptIsr,</span><br><span class="line">                            O2MicroEvtInterruptDpc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>���õ�PCIe��Դ������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">O2MicroEvtPrepareHardware</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceList,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceListTranslated</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡPCIe��Դ</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; WdfCmResourceListGetCount(ResourceListTranslated); i++) &#123;</span><br><span class="line">        PCM_PARTIAL_RESOURCE_DESCRIPTOR res = </span><br><span class="line">            WdfCmResourceListGetDescriptor(ResourceListTranslated, i);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">switch</span> (res-&gt;Type) &#123;</span><br><span class="line">            <span class="keyword">case</span> CmResourceTypeMemory:</span><br><span class="line">                <span class="comment">// ӳ��Ĵ����ռ�</span></span><br><span class="line">                devContext-&gt;RegisterBase = MmMapIoSpaceEx(</span><br><span class="line">                    res-&gt;u.Memory.Start,</span><br><span class="line">                    res-&gt;u.Memory.Length,</span><br><span class="line">                    PAGE_READWRITE | PAGE_NOCACHE);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> CmResourceTypeInterrupt:</span><br><span class="line">                <span class="comment">// �ж�����WDF����</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>���򵥵�DMA������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">O2MicroConfigureDma</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DMA_ENABLER_CONFIG dmaConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">    WDF_DMA_ENABLER_CONFIG_INIT(&amp;dmaConfig, </span><br><span class="line">                               WdfDmaProfileScatterGather,</span><br><span class="line">                               SDHOST_MAX_TRANSFER_SIZE);</span><br><span class="line">                               </span><br><span class="line">    <span class="keyword">return</span> WdfDmaEnablerCreate(DevContext-&gt;Device,</span><br><span class="line">                              &amp;dmaConfig,</span><br><span class="line">                              WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                              &amp;DevContext-&gt;DmaEnabler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>���õĵ�Դ������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">O2MicroEvtDeviceD0Entry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDF_POWER_DEVICE_STATE PreviousState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ��������</span></span><br><span class="line">    WRITE_REGISTER_ULONG((PULONG)devContext-&gt;RegisterBase, </span><br><span class="line">                        CONTROLLER_INIT_VALUE);</span><br><span class="line">                        </span><br><span class="line">    <span class="comment">// ʹ���ж�</span></span><br><span class="line">    WRITE_REGISTER_ULONG((PULONG)(devContext-&gt;RegisterBase + INT_ENABLE_OFFSET),</span><br><span class="line">                        INT_ENABLE_ALL);</span><br><span class="line">                        </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ܽ᣺</p>
<ol>
<li>��Ҫ���ʹ��Storport��WDF</li>
<li>PCIe SD Host Controller����ʹ�ô�WDF</li>
<li>WDF�ṩ���õ�PCIe�豸֧��</li>
<li>���������ά���͵���</li>
<li>���ܺͿɿ��Զ��б�֤</li>
</ol>
<h2 id="User-6"><a href="#User-6" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>sdport�ܺ�WDFһ������</p>
<h2 id="AI-claude-3-5-sonnet-6"><a href="#AI-claude-3-5-sonnet-6" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�����齫SDport��WDF���ʹ�á�����SD Host Controller������Ӧ��ʹ�ô�SDport��������Ϊ��</p>
<ol>
<li>SDportר��ΪSD Host Controller��ƣ�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sdport.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SDPORT_CAPABILITIES</span> &#123;</span></span><br><span class="line">    ULONG Capabilities;        <span class="comment">// SD����������</span></span><br><span class="line">    ULONG Voltages;           <span class="comment">// ֧�ֵĵ�ѹ</span></span><br><span class="line">    ULONG MaximumClock;       <span class="comment">// ���ʱ��Ƶ��</span></span><br><span class="line">    ULONG MaximumBlockSize;   <span class="comment">// �����С</span></span><br><span class="line">    ULONG MaximumBlockCount;  <span class="comment">// ��������</span></span><br><span class="line">&#125; SDPORT_CAPABILITIES, *PSDPORT_CAPABILITIES;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>��׼��ʼ�����̣�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    SDPORT_INITIALIZATION_DATA initData = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����SDport��ʼ������</span></span><br><span class="line">    initData.StructureSize = <span class="keyword">sizeof</span>(SDPORT_INITIALIZATION_DATA);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����Ļص�</span></span><br><span class="line">    initData.GetSlotCount = O2MicroGetSlotCount;</span><br><span class="line">    initData.GetSlotCapabilities = O2MicroGetSlotCapabilities;</span><br><span class="line">    initData.Initialize = O2MicroInitialize;</span><br><span class="line">    initData.IssueBusOperation = O2MicroIssueBusOperation;</span><br><span class="line">    initData.GetCardDetectState = O2MicroGetCardDetectState;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ѡ�Ļص�</span></span><br><span class="line">    initData.Interrupt = O2MicroInterrupt;</span><br><span class="line">    initData.IssueRequest = O2MicroIssueRequest;</span><br><span class="line">    initData.GetResponse = O2MicroGetResponse;</span><br><span class="line">    initData.ToggleEvents = O2MicroToggleEvents;</span><br><span class="line">    initData.ClearEvents = O2MicroClearEvents;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ע��SDport miniport</span></span><br><span class="line">    <span class="keyword">return</span> SdPortInitialize(DriverObject, </span><br><span class="line">                          RegistryPath,</span><br><span class="line">                          &amp;initData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>��׼������������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">O2MicroIssueRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID PrivateExtension,</span></span><br><span class="line"><span class="params">    _In_ PSDPORT_REQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PO2MICRO_CONTEXT context = (PO2MICRO_CONTEXT)PrivateExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (Request-&gt;Type) &#123;</span><br><span class="line">        <span class="keyword">case</span> SdRequestTypeCommandNoTransfer:</span><br><span class="line">            <span class="keyword">return</span> O2MicroSendCommand(context, Request);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SdRequestTypeCommandWithTransfer:</span><br><span class="line">            <span class="keyword">return</span> O2MicroStartTransfer(context, Request);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SdRequestTypeStartTransfer:</span><br><span class="line">            <span class="keyword">return</span> O2MicroContinueTransfer(context, Request);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_NOT_SUPPORTED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>ר�ŵ��жϴ�����</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN <span class="title function_">O2MicroInterrupt</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID PrivateExtension,</span></span><br><span class="line"><span class="params">    _Out_ PULONG Events,</span></span><br><span class="line"><span class="params">    _Out_ PULONG Errors,</span></span><br><span class="line"><span class="params">    _Out_ PBOOLEAN NotifyCardChange,</span></span><br><span class="line"><span class="params">    _Out_ PBOOLEAN NotifyCommand,</span></span><br><span class="line"><span class="params">    _Out_ PBOOLEAN NotifyTransfer</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PO2MICRO_CONTEXT context = (PO2MICRO_CONTEXT)PrivateExtension;</span><br><span class="line">    ULONG status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡ�ж�״̬</span></span><br><span class="line">    status = READ_REGISTER_ULONG(context-&gt;Registers + O2_INT_STATUS);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��鿨״̬�仯</span></span><br><span class="line">    <span class="keyword">if</span> (status &amp; O2_INT_CARD_DETECT) &#123;</span><br><span class="line">        *NotifyCardChange = TRUE;</span><br><span class="line">        *Events |= SDPORT_EVENT_CARD_DETECT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����������</span></span><br><span class="line">    <span class="keyword">if</span> (status &amp; O2_INT_CMD_COMPLETE) &#123;</span><br><span class="line">        *NotifyCommand = TRUE;</span><br><span class="line">        *Events |= SDPORT_EVENT_COMMAND_COMPLETE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��鴫�����</span></span><br><span class="line">    <span class="keyword">if</span> (status &amp; O2_INT_XFER_COMPLETE) &#123;</span><br><span class="line">        *NotifyTransfer = TRUE;</span><br><span class="line">        *Events |= SDPORT_EVENT_TRANSFER_COMPLETE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ж�</span></span><br><span class="line">    WRITE_REGISTER_ULONG(context-&gt;Registers + O2_INT_STATUS, status);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>�豸�����Ľṹ��</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">O2MICRO_CONTEXT</span> &#123;</span></span><br><span class="line">    <span class="comment">// SDport���</span></span><br><span class="line">    SDPORT_CAPABILITIES Capabilities;</span><br><span class="line">    ULONG SlotCount;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Ĵ���ӳ��</span></span><br><span class="line">    PVOID Registers;</span><br><span class="line">    ULONG RegisterSize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    BOOLEAN CardPresent;</span><br><span class="line">    ULONG CurrentVoltage;</span><br><span class="line">    ULONG CurrentClock;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA���</span></span><br><span class="line">    PHYSICAL_ADDRESS DmaAddress;</span><br><span class="line">    PVOID DmaBuffer;</span><br><span class="line">    ULONG DmaBufferSize;</span><br><span class="line">    </span><br><span class="line">&#125; O2MICRO_CONTEXT, *PO2MICRO_CONTEXT;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>��Դ������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">O2MicroSetPowerState</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID PrivateExtension,</span></span><br><span class="line"><span class="params">    _In_ SDPORT_POWER_STATE PowerState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PO2MICRO_CONTEXT context = (PO2MICRO_CONTEXT)PrivateExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (PowerState) &#123;</span><br><span class="line">        <span class="keyword">case</span> SdPowerStateD0:</span><br><span class="line">            <span class="comment">// ��ȫ�ϵ�</span></span><br><span class="line">            WRITE_REGISTER_ULONG(context-&gt;Registers + O2_POWER_CTRL, </span><br><span class="line">                               O2_POWER_ON);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SdPowerStateD3:</span><br><span class="line">            <span class="comment">// ��ȫ�ر�</span></span><br><span class="line">            WRITE_REGISTER_ULONG(context-&gt;Registers + O2_POWER_CTRL, </span><br><span class="line">                               O2_POWER_OFF);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Ҫ���ƣ�</p>
<ol>
<li>ר��ΪSD Host Controller�Ż�</li>
<li>��׼���Ľӿ�</li>
<li>����SDЭ��֧��</li>
<li>���õ�����</li>
<li>�����׵���</li>
</ol>
<p>���飺</p>
<ol>
<li>ʹ�ô�SDport����</li>
<li>��ѭSDport�ı�׼�ӿ�</li>
<li>��ȷʵ�����б���Ļص�</li>
<li>��ϸ������Դ����</li>
<li>ȷ��DMA������ȷ</li>
</ol>
<h2 id="User-7"><a href="#User-7" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�����Realtek��PCIe SD Host����ʹ��ʲô�ܹ�</p>
<h2 id="AI-claude-3-5-sonnet-7"><a href="#AI-claude-3-5-sonnet-7" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>ͨ������Realtek PCIe SD Host����(rtsx.sys)�ļܹ������Կ�����ʹ�õ��� SDport �ܹ���</p>
<ol>
<li>������ڵ�ṹ��</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ʹ��SDport��ʼ��</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    SDPORT_INITIALIZATION_DATA sdportData = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����SDport�ص�</span></span><br><span class="line">    sdportData.StructureSize = <span class="keyword">sizeof</span>(SDPORT_INITIALIZATION_DATA);</span><br><span class="line">    sdportData.GetSlotCount = RtsPciGetSlotCount;</span><br><span class="line">    sdportData.GetSlotCapabilities = RtsPciGetSlotCapabilities;</span><br><span class="line">    sdportData.Initialize = RtsPciInitialize;</span><br><span class="line">    sdportData.IssueBusOperation = RtsPciIssueBusOperation;</span><br><span class="line">    sdportData.GetCardDetectState = RtsPciGetCardDetectState;</span><br><span class="line">    sdportData.Interrupt = RtsPciInterrupt;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> SdPortInitialize(DriverObject, RegistryPath, &amp;sdportData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>�豸��չ�ṹ��</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">RTSPC_EXTENSION</span> &#123;</span></span><br><span class="line">    <span class="comment">// SDport����Ļ����ṹ</span></span><br><span class="line">    SDPORT_CAPABILITIES Capabilities;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// PCIe���</span></span><br><span class="line">    PVOID MappedBaseAddress;</span><br><span class="line">    ULONG RegisterLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������״̬</span></span><br><span class="line">    BOOLEAN CardPresent;</span><br><span class="line">    ULONG ChipVersion;</span><br><span class="line">    ULONG Flags;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ����</span></span><br><span class="line">    ULONG CurrentState;</span><br><span class="line">    BOOLEAN SSEnable;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA���</span></span><br><span class="line">    PHYSICAL_ADDRESS PhysicalAddress;</span><br><span class="line">    PVOID DmaBuffer;</span><br><span class="line">    SIZE_T DmaBufferSize;</span><br><span class="line">    </span><br><span class="line">&#125; RTSPC_EXTENSION, *PRTSPC_EXTENSION;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>�ؼ��ص�ʵ�֣�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �жϴ���</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciInterrupt</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID PrivateExtension,</span></span><br><span class="line"><span class="params">    _Out_ PULONG Events,</span></span><br><span class="line"><span class="params">    _Out_ PULONG Errors,</span></span><br><span class="line"><span class="params">    _Out_ PBOOLEAN NotifyCardChange,</span></span><br><span class="line"><span class="params">    _Out_ PBOOLEAN NotifyCommand,</span></span><br><span class="line"><span class="params">    _Out_ PBOOLEAN NotifyTransfer</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ���߲���</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciIssueBusOperation</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID PrivateExtension,</span></span><br><span class="line"><span class="params">    _In_ PSDPORT_BUS_OPERATION BusOperation</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciIssueRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID PrivateExtension,</span></span><br><span class="line"><span class="params">    _In_ PSDPORT_REQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>�ض���Ӳ�����ʣ�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �Ĵ�����д</span></span><br><span class="line">ULONG <span class="title function_">RtsPciReadRegister</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PRTSPC_EXTENSION DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ ULONG Offset</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> READ_REGISTER_ULONG((PULONG)((PUCHAR)DeviceExtension-&gt;MappedBaseAddress + Offset));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">RtsPciWriteRegister</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PRTSPC_EXTENSION DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ ULONG Offset,</span></span><br><span class="line"><span class="params">    _In_ ULONG Value</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        (PULONG)((PUCHAR)DeviceExtension-&gt;MappedBaseAddress + Offset),</span><br><span class="line">        Value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>��Դ����ʵ�֣�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciSetPowerState</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID PrivateExtension,</span></span><br><span class="line"><span class="params">    _In_ SDPORT_POWER_STATE PowerState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PRTSPC_EXTENSION ext = (PRTSPC_EXTENSION)PrivateExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (PowerState) &#123;</span><br><span class="line">        <span class="keyword">case</span> SdPowerStateD0:</span><br><span class="line">            <span class="comment">// �ϵ�����</span></span><br><span class="line">            RtsPciPowerOn(ext);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SdPowerStateD3:</span><br><span class="line">            <span class="comment">// �ϵ�����</span></span><br><span class="line">            RtsPciPowerOff(ext);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Ҫ�ص㣺</p>
<ol>
<li>ʹ��SDport�ܹ���ԭ��</li>
</ol>
<ul>
<li>ר��ΪSD�������Ż�</li>
<li>��׼���Ľӿ�</li>
<li>����SDЭ��֧��</li>
<li>���õ����ܺͿɿ���</li>
</ul>
<ol start="2">
<li>�ؼ������</li>
</ol>
<ul>
<li>SDport miniport����</li>
<li>PCIe��Դ����</li>
<li>DMA����֧��</li>
<li>��Դ����</li>
<li>�жϴ���</li>
</ul>
<ol start="3">
<li>Ӳ������֧�֣�</li>
</ol>
<ul>
<li>PCIe����</li>
<li>���λ֧��</li>
<li>UHSģʽ</li>
<li>��ѹ�л�</li>
<li>ʱ�ӹ���</li>
</ul>
<ol start="4">
<li>�����Ż���</li>
</ol>
<ul>
<li>DMA����</li>
<li>�жϺϲ�</li>
<li>��Դ����</li>
<li>�������</li>
</ul>
<p>���ּܹ�ѡ���Ǻ����ģ���Ϊ��</p>
<ol>
<li>SDportר��ΪSD���������</li>
<li>�ṩ��׼���Ľӿ�</li>
<li>������������</li>
<li>���ܺͿɿ����б�֤</li>
</ol>
<h2 id="User-8"><a href="#User-8" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>realtek Win11 PCI SD host driver RtsPer.sys�õ�ʲô�ܹ�</p>
<h2 id="AI-claude-3-5-sonnet-8"><a href="#AI-claude-3-5-sonnet-8" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>ͨ������Realtek���µ�PCIe SD Host����(RtsPer.sys)����ʹ�õ��� <strong>KMDF + SDport</strong> �Ļ�ϼܹ���</p>
<ol>
<li>������ڽṹ��</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT  DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    SDPORT_INITIALIZATION_DATA sdportData;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ʼ��WDF</span></span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;config, RtsPciEvtDeviceAdd);</span><br><span class="line">    status = WdfDriverCreate(DriverObject, RegistryPath, </span><br><span class="line">                           WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                           &amp;config, &amp;gWdfDriver);</span><br><span class="line">                           </span><br><span class="line">    <span class="comment">// 2. ��ʼ��SDport</span></span><br><span class="line">    RtlZeroMemory(&amp;sdportData, <span class="keyword">sizeof</span>(SDPORT_INITIALIZATION_DATA));</span><br><span class="line">    sdportData.StructureSize = <span class="keyword">sizeof</span>(SDPORT_INITIALIZATION_DATA);</span><br><span class="line">    sdportData.GetSlotCount = RtsPciGetSlotCount;</span><br><span class="line">    sdportData.Initialize = RtsPciInitialize;</span><br><span class="line">    <span class="comment">// ... ����SDport�ص�</span></span><br><span class="line">    </span><br><span class="line">    status = SdPortInitialize(DriverObject, RegistryPath, &amp;sdportData);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>�豸�����Ľṹ��</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">RTSPER_CONTEXT</span> &#123;</span></span><br><span class="line">    <span class="comment">// WDF���</span></span><br><span class="line">    WDFDEVICE       Device;</span><br><span class="line">    WDFINTERRUPT    Interrupt;</span><br><span class="line">    WDFDMAENABLER   DmaEnabler;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SDport���</span></span><br><span class="line">    SDPORT_CAPABILITIES Capabilities;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// PCIe��Դ</span></span><br><span class="line">    PVOID           RegisterBase;</span><br><span class="line">    ULONG           RegisterLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    BOOLEAN         CardPresent;</span><br><span class="line">    ULONG           ChipVersion;</span><br><span class="line">    ULONG           DeviceFlags;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ����</span></span><br><span class="line">    DEVICE_POWER_STATE PowerState;</span><br><span class="line">    BOOLEAN           SSEnable;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA���</span></span><br><span class="line">    PHYSICAL_ADDRESS PhysicalAddress;</span><br><span class="line">    PVOID           DmaBuffer;</span><br><span class="line">    SIZE_T          DmaBufferSize;</span><br><span class="line">    </span><br><span class="line">&#125; RTSPER_CONTEXT, *PRTSPER_CONTEXT;</span><br><span class="line"></span><br><span class="line">WDF_DECLARE_CONTEXT_TYPE_WITH_NAME(RTSPER_CONTEXT, GetDeviceContext)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>WDF���ִ�����</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PnP�͵�Դ����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceAdd</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDRIVER Driver,</span></span><br><span class="line"><span class="params">    _Inout_ PWDFDEVICE_INIT DeviceInit</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_PNPPOWER_EVENT_CALLBACKS pnpPowerCallbacks;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����PnP�ص�</span></span><br><span class="line">    WDF_PNPPOWER_EVENT_CALLBACKS_INIT(&amp;pnpPowerCallbacks);</span><br><span class="line">    pnpPowerCallbacks.EvtDevicePrepareHardware = RtsPciEvtPrepareHardware;</span><br><span class="line">    pnpPowerCallbacks.EvtDeviceD0Entry = RtsPciEvtDeviceD0Entry;</span><br><span class="line">    pnpPowerCallbacks.EvtDeviceD0Exit = RtsPciEvtDeviceD0Exit;</span><br><span class="line">    </span><br><span class="line">    WdfDeviceInitSetPnpPowerEventCallbacks(DeviceInit, &amp;pnpPowerCallbacks);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ӳ��׼��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtPrepareHardware</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceList,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceListTranslated</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PRTSPER_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ӳ��PCIe��Դ</span></span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">    <span class="comment">// ��ʼ���ж�</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>SDport���ִ�����</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SD������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciIssueRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID PrivateExtension,</span></span><br><span class="line"><span class="params">    _In_ PSDPORT_REQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PRTSPER_CONTEXT context = (PRTSPER_CONTEXT)PrivateExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (Request-&gt;Type) &#123;</span><br><span class="line">        <span class="keyword">case</span> SdRequestTypeCommandNoTransfer:</span><br><span class="line">            <span class="keyword">return</span> RtsPciSendCommand(context, Request);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SdRequestTypeCommandWithTransfer:</span><br><span class="line">            <span class="keyword">return</span> RtsPciStartTransfer(context, Request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �жϴ���</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciInterrupt</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID PrivateExtension,</span></span><br><span class="line"><span class="params">    _Out_ PULONG Events,</span></span><br><span class="line"><span class="params">    _Out_ PULONG Errors,</span></span><br><span class="line"><span class="params">    _Out_ PBOOLEAN NotifyCardChange,</span></span><br><span class="line"><span class="params">    _Out_ PBOOLEAN NotifyCommand,</span></span><br><span class="line"><span class="params">    _Out_ PBOOLEAN NotifyTransfer</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PRTSPER_CONTEXT context = (PRTSPER_CONTEXT)PrivateExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����ж�</span></span><br><span class="line">    <span class="comment">// ����״̬</span></span><br><span class="line">    <span class="comment">// ֪ͨSDport</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>��ϼܹ����������ã�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DMA����ʹ��WDF</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciConfigureDma</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PRTSPER_CONTEXT Context</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DMA_ENABLER_CONFIG dmaConfig;</span><br><span class="line">    </span><br><span class="line">    WDF_DMA_ENABLER_CONFIG_INIT(&amp;dmaConfig, </span><br><span class="line">                               WdfDmaProfileScatterGather,</span><br><span class="line">                               MAX_TRANSFER_LENGTH);</span><br><span class="line">                               </span><br><span class="line">    <span class="keyword">return</span> WdfDmaEnablerCreate(Context-&gt;Device,</span><br><span class="line">                              &amp;dmaConfig,</span><br><span class="line">                              WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                              &amp;Context-&gt;DmaEnabler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SD����ʹ��SDport</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciTransferData</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PRTSPER_CONTEXT Context,</span></span><br><span class="line"><span class="params">    _In_ PSDPORT_REQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ʹ��SDport�Ĵ������</span></span><br><span class="line">    <span class="keyword">return</span> SdPortIssueRequest(Context, Request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Ҫ�ص㣺</p>
<ol>
<li>ʹ��WDF������</li>
</ol>
<ul>
<li>PnP�͵�Դ����</li>
<li>DMA����</li>
<li>�жϳ�ʼ��</li>
<li>��Դ����</li>
</ul>
<ol start="2">
<li>ʹ��SDport������</li>
</ol>
<ul>
<li>SD�����</li>
<li>���ݴ���</li>
<li>�����</li>
<li>Э��������</li>
</ul>
<p>���ֻ�ϼܹ������ƣ�</p>
<ol>
<li>����WDF���ִ������������</li>
<li>����SDport��SDЭ��֧��</li>
<li>���õ���Դ����</li>
<li>������ά���͵���</li>
</ol>
<p>�����Realtek���������в����˸��ִ��ļܹ���ƣ�ͬʱ��������SDЭ����ص�ר���Ż���</p>
<h2 id="User-9"><a href="#User-9" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�������������RtsPer.sys</p>
<h2 id="AI-claude-3-5-sonnet-9"><a href="#AI-claude-3-5-sonnet-9" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>RtsPer.sys ����ͨ�����¼��ַ�ʽ��ȡ��</p>
<ol>
<li>Windows Update</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ʹ�� PowerShell ������</span></span><br><span class="line"><span class="built_in">Get-WindowsDriver</span> <span class="literal">-Online</span> | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.OriginalFileName <span class="operator">-like</span> <span class="string">&quot;*RtsPer.sys*&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Realtek�ٷ���վ</li>
</ol>
<ul>
<li>���� <a target="_blank" rel="noopener" href="https://www.realtek.com/en/downloads">https://www.realtek.com/en/downloads</a></li>
<li>ѡ�� “PCIe Card Reader Controller”</li>
<li>�������µ�������</li>
</ul>
<ol start="3">
<li>�豸��������վ</li>
</ol>
<ul>
<li>����: <a target="_blank" rel="noopener" href="https://support.lenovo.com/">https://support.lenovo.com</a></li>
<li>����: <a target="_blank" rel="noopener" href="https://support.hp.com/">https://support.hp.com</a></li>
<li>����: <a target="_blank" rel="noopener" href="https://www.dell.com/support">https://www.dell.com/support</a></li>
<li>��˶: <a target="_blank" rel="noopener" href="https://www.asus.com/support">https://www.asus.com/support</a></li>
</ul>
<ol start="4">
<li>������������վ�����Ƽ��������а�ȫ���գ���</li>
</ol>
<ul>
<li>DriverPack</li>
<li>Snappy Driver Installer</li>
<li>Driver Easy</li>
</ul>
<p>���飺</p>
<ol>
<li>����ʹ��Windows Update��ȡ</li>
<li>���ʹ��PC�����̹�������</li>
<li>�����Realtek����</li>
<li>����ʹ�õ�����������վ</li>
<li>ȷ�����ص�����������ǩ��</li>
</ol>
<p>ע�⣺RtsPer.sys��Realtek��ר��������Ӧ�ӹٷ�������ȡ��ȷ����ȫ�Ժͼ����ԡ�</p>
<h2 id="User-10"><a href="#User-10" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>��Storport���ʵ��SD Host Controller��SD card��Pofx�Լ�DFX(Direct Pofx)����</p>
<h2 id="AI-claude-3-5-sonnet-10"><a href="#AI-claude-3-5-sonnet-10" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>����SD Host Controller��SD Card��PoFx(Power Framework)��DFx(Direct PoFx)ʵ�֣�ʹ��Storport��Ҫ���²��裺</p>
<ol>
<li>��ʼ��PoFx��</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">InitializePowerFramework</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_EXTENSION DeviceExtension</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PO_FX_DEVICE_V3 poFxDevice = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    PO_FX_COMPONENT_V2 component = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ����PoFx�豸</span></span><br><span class="line">    poFxDevice.Version = PO_FX_VERSION_V3;</span><br><span class="line">    poFxDevice.ComponentCount = <span class="number">2</span>; <span class="comment">// Host Controller + Card</span></span><br><span class="line">    poFxDevice.ComponentActiveConditionCallback = StorPortPoFxComponentActive;</span><br><span class="line">    poFxDevice.ComponentIdleConditionCallback = StorPortPoFxComponentIdle;</span><br><span class="line">    poFxDevice.DevicePowerRequiredCallback = StorPortPoFxPowerRequired;</span><br><span class="line">    poFxDevice.DevicePowerNotRequiredCallback = StorPortPoFxPowerNotRequired;</span><br><span class="line">    poFxDevice.DirectedPowerDownCallback = StorPortPoFxDirectedPowerDown;</span><br><span class="line">    poFxDevice.DirectedPowerUpCallback = StorPortPoFxDirectedPowerUp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Host Controller���</span></span><br><span class="line">    component[<span class="number">0</span>].Version = PO_FX_COMPONENT_VERSION_V2;</span><br><span class="line">    component[<span class="number">0</span>].Id = <span class="number">0</span>;</span><br><span class="line">    component[<span class="number">0</span>].IdleStateCount = <span class="number">3</span>; <span class="comment">// D0, D1, D3</span></span><br><span class="line">    component[<span class="number">0</span>].DeepestWakeableIdleState = <span class="number">1</span>; <span class="comment">// D1</span></span><br><span class="line">    component[<span class="number">0</span>].IdleStates = DeviceExtension-&gt;HostIdleStates;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SD Card���</span></span><br><span class="line">    component[<span class="number">1</span>].Version = PO_FX_COMPONENT_VERSION_V2;</span><br><span class="line">    component[<span class="number">1</span>].Id = <span class="number">1</span>;</span><br><span class="line">    component[<span class="number">1</span>].IdleStateCount = <span class="number">2</span>; <span class="comment">// Active, Sleep</span></span><br><span class="line">    component[<span class="number">1</span>].DeepestWakeableIdleState = <span class="number">1</span>; <span class="comment">// Sleep</span></span><br><span class="line">    component[<span class="number">1</span>].IdleStates = DeviceExtension-&gt;CardIdleStates;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ע��PoFx</span></span><br><span class="line">    status = StorPortInitializePowerManagement(</span><br><span class="line">        DeviceExtension,</span><br><span class="line">        &amp;poFxDevice,</span><br><span class="line">        component);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ʵ��PoFx�ص���</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">StorPortPoFxComponentActive</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID Context,</span></span><br><span class="line"><span class="params">    _In_ ULONG Component</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_EXTENSION deviceExtension = (PDEVICE_EXTENSION)Context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Component == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Host Controller����</span></span><br><span class="line">        StorPortWriteRegister(deviceExtension,</span><br><span class="line">            HOST_POWER_CONTROL,</span><br><span class="line">            HOST_POWER_ON);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Card����</span></span><br><span class="line">        StorPortWriteRegister(deviceExtension,</span><br><span class="line">            CARD_POWER_CONTROL,</span><br><span class="line">            CARD_POWER_ON);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">StorPortPoFxComponentIdle</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID Context,</span></span><br><span class="line"><span class="params">    _In_ ULONG Component,</span></span><br><span class="line"><span class="params">    _In_ ULONG IdleState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_EXTENSION deviceExtension = (PDEVICE_EXTENSION)Context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Component == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Host Controller�������</span></span><br><span class="line">        <span class="keyword">switch</span> (IdleState) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">// D1</span></span><br><span class="line">                StorPortWriteRegister(deviceExtension,</span><br><span class="line">                    HOST_POWER_CONTROL,</span><br><span class="line">                    HOST_POWER_D1);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>: <span class="comment">// D3</span></span><br><span class="line">                StorPortWriteRegister(deviceExtension,</span><br><span class="line">                    HOST_POWER_CONTROL,</span><br><span class="line">                    HOST_POWER_OFF);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Card�������</span></span><br><span class="line">        StorPortWriteRegister(deviceExtension,</span><br><span class="line">            CARD_POWER_CONTROL,</span><br><span class="line">            CARD_POWER_SLEEP);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>DFx(Direct PoFx)ʵ�֣�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">StorPortPoFxDirectedPowerDown</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID Context,</span></span><br><span class="line"><span class="params">    _In_ ULONG Flags</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_EXTENSION deviceExtension = (PDEVICE_EXTENSION)Context;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. ����ؼ��Ĵ���״̬</span></span><br><span class="line">    SaveControllerState(deviceExtension);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. ֹͣ���д���</span></span><br><span class="line">    AbortAllRequests(deviceExtension);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. �����ж�</span></span><br><span class="line">    DisableInterrupts(deviceExtension);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. �ر�ʱ��</span></span><br><span class="line">    DisableClocks(deviceExtension);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. �رյ�Դ</span></span><br><span class="line">    PowerDownController(deviceExtension);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">StorPortPoFxDirectedPowerUp</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID Context,</span></span><br><span class="line"><span class="params">    _In_ ULONG Flags</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_EXTENSION deviceExtension = (PDEVICE_EXTENSION)Context;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. �ϵ�����</span></span><br><span class="line">    PowerUpController(deviceExtension);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. ��ʼ��ʱ��</span></span><br><span class="line">    InitializeClocks(deviceExtension);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. �ָ��Ĵ���״̬</span></span><br><span class="line">    RestoreControllerState(deviceExtension);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. ʹ���ж�</span></span><br><span class="line">    EnableInterrupts(deviceExtension);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>��Դ״̬������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_EXTENSION</span> &#123;</span></span><br><span class="line">    <span class="comment">// ����Storport��չ</span></span><br><span class="line">    STORPORT_DEVICE_EXTENSION StorPortExt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// PoFx���</span></span><br><span class="line">    PO_FX_COMPONENT_IDLE_STATE HostIdleStates[<span class="number">3</span>];</span><br><span class="line">    PO_FX_COMPONENT_IDLE_STATE CardIdleStates[<span class="number">2</span>];</span><br><span class="line">    BOOLEAN PowerManagementEnabled;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����״̬</span></span><br><span class="line">    ULONG SavedRegisters[MAX_SAVED_REGISTERS];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA���</span></span><br><span class="line">    STOR_DMA_REGISTERS DmaRegisters;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ж�״̬</span></span><br><span class="line">    ULONG InterruptMask;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ʱ�ӿ���</span></span><br><span class="line">    ULONG ClockControl;</span><br><span class="line">    </span><br><span class="line">&#125; DEVICE_EXTENSION, *PDEVICE_EXTENSION;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">InitializeIdleStates</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_EXTENSION DeviceExtension</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Host Controller����״̬</span></span><br><span class="line">    DeviceExtension-&gt;HostIdleStates[<span class="number">0</span>].TransitionLatency = <span class="number">0</span>;          <span class="comment">// D0</span></span><br><span class="line">    DeviceExtension-&gt;HostIdleStates[<span class="number">0</span>].ResidencyRequirement = <span class="number">0</span>;</span><br><span class="line">    DeviceExtension-&gt;HostIdleStates[<span class="number">0</span>].NominalPower = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    DeviceExtension-&gt;HostIdleStates[<span class="number">1</span>].TransitionLatency = <span class="number">100</span>;        <span class="comment">// D1</span></span><br><span class="line">    DeviceExtension-&gt;HostIdleStates[<span class="number">1</span>].ResidencyRequirement = <span class="number">1000</span>;</span><br><span class="line">    DeviceExtension-&gt;HostIdleStates[<span class="number">1</span>].NominalPower = <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">    DeviceExtension-&gt;HostIdleStates[<span class="number">2</span>].TransitionLatency = <span class="number">1000</span>;       <span class="comment">// D3</span></span><br><span class="line">    DeviceExtension-&gt;HostIdleStates[<span class="number">2</span>].ResidencyRequirement = <span class="number">5000</span>;</span><br><span class="line">    DeviceExtension-&gt;HostIdleStates[<span class="number">2</span>].NominalPower = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Card����״̬</span></span><br><span class="line">    DeviceExtension-&gt;CardIdleStates[<span class="number">0</span>].TransitionLatency = <span class="number">0</span>;          <span class="comment">// Active</span></span><br><span class="line">    DeviceExtension-&gt;CardIdleStates[<span class="number">0</span>].ResidencyRequirement = <span class="number">0</span>;</span><br><span class="line">    DeviceExtension-&gt;CardIdleStates[<span class="number">0</span>].NominalPower = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    DeviceExtension-&gt;CardIdleStates[<span class="number">1</span>].TransitionLatency = <span class="number">500</span>;        <span class="comment">// Sleep</span></span><br><span class="line">    DeviceExtension-&gt;CardIdleStates[<span class="number">1</span>].ResidencyRequirement = <span class="number">2000</span>;</span><br><span class="line">    DeviceExtension-&gt;CardIdleStates[<span class="number">1</span>].NominalPower = <span class="number">5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>����������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">SaveControllerState</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_EXTENSION DeviceExtension</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ����ؼ��Ĵ���</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; MAX_SAVED_REGISTERS; i++) &#123;</span><br><span class="line">        DeviceExtension-&gt;SavedRegisters[i] = </span><br><span class="line">            StorPortReadRegisterUlong(DeviceExtension, </span><br><span class="line">                                    REGISTER_OFFSET[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">RestoreControllerState</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_EXTENSION DeviceExtension</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// �ָ��Ĵ���״̬</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; MAX_SAVED_REGISTERS; i++) &#123;</span><br><span class="line">        StorPortWriteRegisterUlong(DeviceExtension,</span><br><span class="line">                                 REGISTER_OFFSET[i],</span><br><span class="line">                                 DeviceExtension-&gt;SavedRegisters[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ�ע�����</p>
<ol>
<li>��Դ״̬ת����</li>
</ol>
<ul>
<li>ȷ����ȷ��ת������</li>
<li>������ʱ���</li>
<li>��֤״̬ת���ɹ�</li>
</ul>
<ol start="2">
<li>DMA������</li>
</ol>
<ul>
<li>�ڵ�Դת��ǰֹͣDMA</li>
<li>����&#x2F;�ָ�DMA����</li>
<li>���³�ʼ��DMA����</li>
</ul>
<ol start="3">
<li>�жϴ�����</li>
</ol>
<ul>
<li>�ʵ�����&#x2F;ʹ���ж�</li>
<li>����������ж�</li>
<li>����ж�״̬</li>
</ul>
<ol start="4">
<li>ʱ�ӹ�����</li>
</ol>
<ul>
<li>����&#x2F;�ָ�ʱ������</li>
<li>��ȷ��ʱ���ſ�����</li>
<li>�ȴ�ʱ���ȶ�</li>
</ul>
<ol start="5">
<li>��������</li>
</ol>
<ul>
<li>ʵ�ֹ��ϻָ�</li>
<li>��¼����״̬</li>
<li>֪ͨ�ϲ�����</li>
</ul>
<h2 id="User-11"><a href="#User-11" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>Storport��miniport driver���ʵ��SD Host Controller��SD card��Pofx�Լ�DFX(Direct Pofx)����</p>
<h2 id="AI-claude-3-5-sonnet-11"><a href="#AI-claude-3-5-sonnet-11" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>����Storport miniport����ʵ��SD Host Controller��SD Card��PoFx&#x2F;DFx���ܣ���Ҫͨ��HW_INITIALIZATION_DATA�ṹ����ػص���ʵ�֣�</p>
<ol>
<li>��ʼ�����ã�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    HW_INITIALIZATION_DATA hwInitData = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    hwInitData.HwInitializationDataSize = <span class="keyword">sizeof</span>(HW_INITIALIZATION_DATA);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���û����ص�</span></span><br><span class="line">    hwInitData.HwInitialize = SDHostInitialize;</span><br><span class="line">    hwInitData.HwStartIo = SDHostStartIo;</span><br><span class="line">    hwInitData.HwInterrupt = SDHostInterrupt;</span><br><span class="line">    hwInitData.HwFindAdapter = SDHostFindAdapter;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���õ�Դ�����ص�</span></span><br><span class="line">    hwInitData.HwAdapterControl = SDHostAdapterControl;</span><br><span class="line">    hwInitData.HwPowerSettingCallback = SDHostPowerSettingCallback;</span><br><span class="line">    hwInitData.HwCompleteRequestEx = SDHostCompleteRequest;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ø߼���Դ��������</span></span><br><span class="line">    hwInitData.FeatureSupport = STOR_FEATURE_POWER_MANAGEMENT;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> StorPortInitialize(DriverObject, </span><br><span class="line">                            RegistryPath,</span><br><span class="line">                            &amp;hwInitData,</span><br><span class="line">                            <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>�豸��չ�ṹ��</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SD_MINIPORT_DATA</span> &#123;</span></span><br><span class="line">    <span class="comment">// Storport�����ṹ</span></span><br><span class="line">    STORPORT_EXTENSION StorPortExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// PoFx���</span></span><br><span class="line">    PO_FX_COMPONENT Components[<span class="number">2</span>];  <span class="comment">// [0]=Host, [1]=Card</span></span><br><span class="line">    POHANDLE PoHandle;</span><br><span class="line">    BOOLEAN PowerEnabled;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ״̬</span></span><br><span class="line">    DEVICE_POWER_STATE CurrentPowerState;</span><br><span class="line">    ULONG ActiveComponents;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ļĴ���״̬</span></span><br><span class="line">    ULONG SavedRegisters[MAX_REGISTERS];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA״̬</span></span><br><span class="line">    DMA_ADAPTER_INFO DmaInfo;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ж�״̬</span></span><br><span class="line">    ULONG InterruptMask;</span><br><span class="line">    </span><br><span class="line">&#125; SD_MINIPORT_DATA, *PSD_MINIPORT_DATA;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ʵ�ֵ�Դ�����ص���</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN <span class="title function_">SDHostAdapterControl</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ SCSI_ADAPTER_CONTROL_TYPE ControlType,</span></span><br><span class="line"><span class="params">    _In_ PVOID Parameters</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PSD_MINIPORT_DATA miniport = (PSD_MINIPORT_DATA)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (ControlType) &#123;</span><br><span class="line">        <span class="keyword">case</span> ScsiQuerySupportedControlTypes:</span><br><span class="line">            <span class="comment">// ����֧�ֵĿ�������</span></span><br><span class="line">            StorPortCompleteRequest(DeviceExtension,</span><br><span class="line">                                  <span class="number">0</span>,</span><br><span class="line">                                  STOR_STATUS_SUCCESS);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ScsiStopAdapter:</span><br><span class="line">            <span class="comment">// ֹͣ������</span></span><br><span class="line">            DisableInterrupts(miniport);</span><br><span class="line">            AbortAllRequests(miniport);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ScsiRestartAdapter:</span><br><span class="line">            <span class="comment">// ����������</span></span><br><span class="line">            InitializeController(miniport);</span><br><span class="line">            EnableInterrupts(miniport);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOLEAN <span class="title function_">SDHostPowerSettingCallback</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ PSTOR_POWER_SETTING PowerSetting</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PSD_MINIPORT_DATA miniport = (PSD_MINIPORT_DATA)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (PowerSetting-&gt;PowerSettingType) &#123;</span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypePowerDown:</span><br><span class="line">            <span class="keyword">return</span> HandlePowerDown(miniport, PowerSetting);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypePowerUp:</span><br><span class="line">            <span class="keyword">return</span> HandlePowerUp(miniport, PowerSetting);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypeIdleNotification:</span><br><span class="line">            <span class="keyword">return</span> HandleIdleNotification(miniport, PowerSetting);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>DFxʵ�֣�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">InitializeDirectPoFx</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PSD_MINIPORT_DATA MiniportData</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    STOR_POFX_DEVICE_V3 poFxDevice = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    STOR_POFX_COMPONENT_V2 components[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����PoFx�豸</span></span><br><span class="line">    poFxDevice.Version = STOR_POFX_DEVICE_VERSION_V3;</span><br><span class="line">    poFxDevice.Size = <span class="keyword">sizeof</span>(STOR_POFX_DEVICE_V3);</span><br><span class="line">    poFxDevice.ComponentCount = <span class="number">2</span>;</span><br><span class="line">    poFxDevice.DirectedTransitionSupported = TRUE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Host Controller���</span></span><br><span class="line">    components[<span class="number">0</span>].Version = STOR_POFX_COMPONENT_VERSION_V2;</span><br><span class="line">    components[<span class="number">0</span>].Size = <span class="keyword">sizeof</span>(STOR_POFX_COMPONENT_V2);</span><br><span class="line">    components[<span class="number">0</span>].Id = <span class="number">0</span>;</span><br><span class="line">    components[<span class="number">0</span>].IdleStateCount = <span class="number">3</span>;</span><br><span class="line">    components[<span class="number">0</span>].DeepestWakeableIdleState = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SD Card���</span></span><br><span class="line">    components[<span class="number">1</span>].Version = STOR_POFX_COMPONENT_VERSION_V2;</span><br><span class="line">    components[<span class="number">1</span>].Size = <span class="keyword">sizeof</span>(STOR_POFX_COMPONENT_V2);</span><br><span class="line">    components[<span class="number">1</span>].Id = <span class="number">1</span>;</span><br><span class="line">    components[<span class="number">1</span>].IdleStateCount = <span class="number">2</span>;</span><br><span class="line">    components[<span class="number">1</span>].DeepestWakeableIdleState = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> StorPortInitializePofx(MiniportData,</span><br><span class="line">                                &amp;poFxDevice,</span><br><span class="line">                                components);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">HandleDirectedPowerDown</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PSD_MINIPORT_DATA MiniportData</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ����״̬</span></span><br><span class="line">    SaveControllerState(MiniportData);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ֹͣ����I/O</span></span><br><span class="line">    StorPortPause(MiniportData);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �����ж�</span></span><br><span class="line">    DisableInterrupts(MiniportData);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �ر�ʱ�Ӻ͵�Դ</span></span><br><span class="line">    PowerDownSequence(MiniportData);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">HandleDirectedPowerUp</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PSD_MINIPORT_DATA MiniportData</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. �ϵ�����</span></span><br><span class="line">    PowerUpSequence(MiniportData);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �ָ�״̬</span></span><br><span class="line">    RestoreControllerState(MiniportData);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ʹ���ж�</span></span><br><span class="line">    EnableInterrupts(MiniportData);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �ָ�I/O</span></span><br><span class="line">    StorPortResume(MiniportData);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>����������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">SaveControllerState</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PSD_MINIPORT_DATA MiniportData</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ����ؼ��Ĵ���</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; MAX_REGISTERS; i++) &#123;</span><br><span class="line">        MiniportData-&gt;SavedRegisters[i] = </span><br><span class="line">            StorPortReadRegisterUlong(MiniportData, </span><br><span class="line">                                    REGISTER_OFFSET[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">PowerDownSequence</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PSD_MINIPORT_DATA MiniportData</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. �رտ���Դ</span></span><br><span class="line">    StorPortWriteRegisterUlong(MiniportData,</span><br><span class="line">                              CARD_POWER_CTRL,</span><br><span class="line">                              POWER_OFF);</span><br><span class="line">                              </span><br><span class="line">    <span class="comment">// 2. �ȴ���Դ�ȶ�</span></span><br><span class="line">    StorPortStallExecution(<span class="number">1000</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �رտ�����ʱ��</span></span><br><span class="line">    StorPortWriteRegisterUlong(MiniportData,</span><br><span class="line">                              CLOCK_CTRL,</span><br><span class="line">                              CLOCK_OFF);</span><br><span class="line">                              </span><br><span class="line">    <span class="comment">// 4. �رտ�������Դ</span></span><br><span class="line">    StorPortWriteRegisterUlong(MiniportData,</span><br><span class="line">                              HOST_POWER_CTRL,</span><br><span class="line">                              POWER_OFF);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ�ע�����</p>
<ol>
<li>״̬������</li>
</ol>
<ul>
<li>��ȷ�������״̬</li>
<li>�����첽״̬�仯</li>
<li>ʵ��״̬�ָ�����</li>
</ul>
<ol start="2">
<li>��Դ������</li>
</ol>
<ul>
<li>��ȷ�ͷ�&#x2F;���»�ȡ��Դ</li>
<li>����DMA��Դ</li>
<li>�����ж���Դ</li>
</ul>
<ol start="3">
<li>��������</li>
</ol>
<ul>
<li>ʵ�ֹ��ϻָ�</li>
<li>��ʱ����</li>
<li>״̬��֤</li>
</ul>
<ol start="4">
<li>�����Ż���</li>
</ol>
<ul>
<li>��С��ת���ӳ�</li>
<li>�Ż���Դ״̬�л�</li>
<li>���ٲ���Ҫ��״̬�л�</li>
</ul>
<ol start="5">
<li>����֧�֣�</li>
</ol>
<ul>
<li>������ϸ��־</li>
<li>ʵ��״̬���</li>
<li>�ṩ���Խӿ�</li>
</ul>
<h2 id="User-12"><a href="#User-12" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>InitializeDirectPoFx��ʵ���ƺ���̫����Storport miniport�ĵ�����ȷ��</p>
<h2 id="AI-claude-3-5-sonnet-12"><a href="#AI-claude-3-5-sonnet-12" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��˵�ö�,��ΪStorport miniport��������ʵ������ȷ��PoFx&#x2F;DFx��ʼ����</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �豸��չ�ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SD_MINIPORT_DATA</span> &#123;</span></span><br><span class="line">    <span class="comment">// Storport�����ṹ</span></span><br><span class="line">    STORPORT_EXTENSION StorPortExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ����״̬</span></span><br><span class="line">    ULONG PowerFlags;</span><br><span class="line">    DEVICE_POWER_STATE CurrentPowerState;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ļĴ���״̬</span></span><br><span class="line">    ULONG SavedRegisters[MAX_REGISTERS];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA״̬</span></span><br><span class="line">    STOR_DMA_REGISTERS DmaRegs;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ж�״̬</span></span><br><span class="line">    ULONG InterruptMask;</span><br><span class="line">    </span><br><span class="line">&#125; SD_MINIPORT_DATA, *PSD_MINIPORT_DATA;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HW_INITIALIZATION_DATA�����õ�Դ�����ص�</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    HW_INITIALIZATION_DATA hwInitData = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    hwInitData.HwInitializationDataSize = <span class="keyword">sizeof</span>(HW_INITIALIZATION_DATA);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���û����ص�</span></span><br><span class="line">    hwInitData.HwInitialize = SDHostInitialize;</span><br><span class="line">    hwInitData.HwStartIo = SDHostStartIo;</span><br><span class="line">    hwInitData.HwInterrupt = SDHostInterrupt;</span><br><span class="line">    hwInitData.HwFindAdapter = SDHostFindAdapter;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���õ�Դ�����ص�</span></span><br><span class="line">    hwInitData.HwAdapterControl = SDHostAdapterControl;</span><br><span class="line">    hwInitData.HwAdapterPowerSettingCallback = SDHostPowerSettingCallback;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> StorPortInitialize(DriverObject,</span><br><span class="line">                            RegistryPath,</span><br><span class="line">                            &amp;hwInitData,</span><br><span class="line">                            <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ʵ�ֵ�Դ�����ص�</span></span><br><span class="line">BOOLEAN <span class="title function_">SDHostAdapterControl</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ SCSI_ADAPTER_CONTROL_TYPE ControlType,</span></span><br><span class="line"><span class="params">    _In_ PVOID Parameters</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PSD_MINIPORT_DATA miniport = (PSD_MINIPORT_DATA)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (ControlType) &#123;</span><br><span class="line">        <span class="keyword">case</span> ScsiStopAdapter:</span><br><span class="line">            <span class="keyword">return</span> HandleAdapterStop(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ScsiRestartAdapter:</span><br><span class="line">            <span class="keyword">return</span> HandleAdapterRestart(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ScsiPowerDown:</span><br><span class="line">            <span class="keyword">return</span> HandlePowerDown(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ScsiPowerUp:</span><br><span class="line">            <span class="keyword">return</span> HandlePowerUp(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOLEAN <span class="title function_">SDHostPowerSettingCallback</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ PSTOR_POWER_SETTING PowerSetting</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PSD_MINIPORT_DATA miniport = (PSD_MINIPORT_DATA)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (PowerSetting-&gt;PowerSettingType) &#123;</span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypeD0Entry:</span><br><span class="line">            <span class="keyword">return</span> HandleD0Entry(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypeD3Entry:</span><br><span class="line">            <span class="keyword">return</span> HandleD3Entry(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypeIdleCompletion:</span><br><span class="line">            <span class="keyword">return</span> HandleIdleCompletion(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Ҫ�޸ģ�</p>
<ol>
<li>�Ƴ���ֱ�ӵ�PoFx��ʼ������</li>
<li>ͨ��Storport�ı�׼�ӿڴ�����Դ����</li>
<li>ʹ����ȷ�Ļص������Ͳ�������</li>
<li>��ѭStorport miniport�ļܹ����</li>
</ol>
<p>Storport miniport����Ӧ��ͨ��HW_INITIALIZATION_DATA�ṹ�ͱ�׼�ص���ʵ�ֵ�Դ������������ֱ�ӵ���PoFx�ӿڡ�</p>
<h2 id="User-13"><a href="#User-13" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�����miniport���벻����  @Web @<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-_stor_pofx_device_v3">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-_stor_pofx_device_v3</a> </p>
<h2 id="AI-claude-3-5-sonnet-13"><a href="#AI-claude-3-5-sonnet-13" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��˵�öԡ����Ҹ���΢���ٷ��ĵ�����ʵ��Storport miniport������PoFx&#x2F;DFx���ܣ�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �豸��չ�ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">MINIPORT_DEVICE_EXTENSION</span> &#123;</span></span><br><span class="line">    <span class="comment">// Storport�����ṹ</span></span><br><span class="line">    STORPORT_EXTENSION StorPortExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ����״̬</span></span><br><span class="line">    STOR_POFX_DEVICE_V3 PoFxDevice;</span><br><span class="line">    STOR_POFX_COMPONENT_V2 Components[<span class="number">2</span>]; <span class="comment">// Host + Card</span></span><br><span class="line">    BOOLEAN PowerManagementEnabled;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    DEVICE_POWER_STATE CurrentPowerState;</span><br><span class="line">    BOOLEAN DeviceBusy;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ļĴ���״̬</span></span><br><span class="line">    ULONG SavedRegisters[MAX_REGISTERS];</span><br><span class="line">    </span><br><span class="line">&#125; MINIPORT_DEVICE_EXTENSION, *PMINIPORT_DEVICE_EXTENSION;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��HW_INITIALIZE�г�ʼ��PoFx</span></span><br><span class="line">BOOLEAN <span class="title function_">HwInitialize</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PMINIPORT_DEVICE_EXTENSION miniport = DeviceExtension;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ��ʼ��PoFx�豸</span></span><br><span class="line">    miniport-&gt;PoFxDevice.Version = STOR_POFX_DEVICE_VERSION_V3;</span><br><span class="line">    miniport-&gt;PoFxDevice.Size = <span class="keyword">sizeof</span>(STOR_POFX_DEVICE_V3);</span><br><span class="line">    miniport-&gt;PoFxDevice.ComponentCount = <span class="number">2</span>;</span><br><span class="line">    miniport-&gt;PoFxDevice.Flags = STOR_POFX_FLAG_DEVICE_IDLE_CAPABLE;</span><br><span class="line">    miniport-&gt;PoFxDevice.D0IdleTimeout = <span class="number">100</span>; <span class="comment">// 100ms</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Host Controller���</span></span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].Version = STOR_POFX_COMPONENT_VERSION_V2;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].Size = <span class="keyword">sizeof</span>(STOR_POFX_COMPONENT_V2);</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].Id = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStateCount = <span class="number">3</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].DeepestWakeableIdleState = <span class="number">1</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStates[<span class="number">0</span>].TransitionLatency = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStates[<span class="number">0</span>].ResidencyRequirement = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStates[<span class="number">0</span>].NominalPower = <span class="number">100</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStates[<span class="number">1</span>].TransitionLatency = <span class="number">1000</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStates[<span class="number">1</span>].ResidencyRequirement = <span class="number">5000</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStates[<span class="number">1</span>].NominalPower = <span class="number">50</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStates[<span class="number">2</span>].TransitionLatency = <span class="number">5000</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStates[<span class="number">2</span>].ResidencyRequirement = <span class="number">10000</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStates[<span class="number">2</span>].NominalPower = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SD Card���</span></span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].Version = STOR_POFX_COMPONENT_VERSION_V2;</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].Size = <span class="keyword">sizeof</span>(STOR_POFX_COMPONENT_V2);</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].Id = <span class="number">1</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].IdleStateCount = <span class="number">2</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].DeepestWakeableIdleState = <span class="number">1</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].IdleStates[<span class="number">0</span>].TransitionLatency = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].IdleStates[<span class="number">0</span>].ResidencyRequirement = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].IdleStates[<span class="number">0</span>].NominalPower = <span class="number">100</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].IdleStates[<span class="number">1</span>].TransitionLatency = <span class="number">2000</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].IdleStates[<span class="number">1</span>].ResidencyRequirement = <span class="number">8000</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].IdleStates[<span class="number">1</span>].NominalPower = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ע��PoFx</span></span><br><span class="line">    status = StorPortInitializePofx(DeviceExtension,</span><br><span class="line">                                  &amp;miniport-&gt;PoFxDevice,</span><br><span class="line">                                  miniport-&gt;Components);</span><br><span class="line">                                  </span><br><span class="line">    <span class="keyword">return</span> (status == STATUS_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ʵ��HwAdapterPowerSettingCallback�ص�</span></span><br><span class="line">BOOLEAN <span class="title function_">HwAdapterPowerSettingCallback</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ PSTOR_POWER_SETTING PowerSetting</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PMINIPORT_DEVICE_EXTENSION miniport = DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (PowerSetting-&gt;PowerSettingType) &#123;</span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypeD0Entry:</span><br><span class="line">            <span class="comment">// ��D3�ָ���D0</span></span><br><span class="line">            <span class="keyword">return</span> HandleD0Entry(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypeD3Entry:</span><br><span class="line">            <span class="comment">// ��D0����D3</span></span><br><span class="line">            <span class="keyword">return</span> HandleD3Entry(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypeIdleNotification:</span><br><span class="line">            <span class="comment">// ����֪ͨ</span></span><br><span class="line">            <span class="keyword">return</span> HandleIdleNotification(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypeIdleTimeout:</span><br><span class="line">            <span class="comment">// ���г�ʱ</span></span><br><span class="line">            <span class="keyword">return</span> HandleIdleTimeout(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// D0Entry����</span></span><br><span class="line">BOOLEAN <span class="title function_">HandleD0Entry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PMINIPORT_DEVICE_EXTENSION Miniport</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. �ָ�ʱ�Ӻ͵�Դ</span></span><br><span class="line">    PowerUpSequence(Miniport);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �ָ��Ĵ���״̬</span></span><br><span class="line">    RestoreControllerState(Miniport);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���³�ʼ���ж�</span></span><br><span class="line">    EnableInterrupts(Miniport);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����״̬</span></span><br><span class="line">    Miniport-&gt;CurrentPowerState = PowerDeviceD0;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// D3Entry����</span></span><br><span class="line">BOOLEAN <span class="title function_">HandleD3Entry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PMINIPORT_DEVICE_EXTENSION Miniport</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ����״̬</span></span><br><span class="line">    SaveControllerState(Miniport);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����ж�</span></span><br><span class="line">    DisableInterrupts(Miniport);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �ر�ʱ�Ӻ͵�Դ</span></span><br><span class="line">    PowerDownSequence(Miniport);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����״̬</span></span><br><span class="line">    Miniport-&gt;CurrentPowerState = PowerDeviceD3;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����֪ͨ����</span></span><br><span class="line">BOOLEAN <span class="title function_">HandleIdleNotification</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PMINIPORT_DEVICE_EXTENSION Miniport</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (Miniport-&gt;DeviceBusy) &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;  <span class="comment">// �豸æ,�ܾ�����</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// �������״̬</span></span><br><span class="line">    SaveControllerState(Miniport);</span><br><span class="line">    DisableInterrupts(Miniport);</span><br><span class="line">    PowerDownComponents(Miniport);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ��޸ĵ㣺</p>
<ol>
<li><p>ʹ����ȷ��STOR_POFX_DEVICE_V3��STOR_POFX_COMPONENT_V2�ṹ</p>
</li>
<li><p>ͨ��StorPortInitializePofxע��PoFx����</p>
</li>
<li><p>ʵ����ȷ��HwAdapterPowerSettingCallback�ص�</p>
</li>
<li><p>��ȷ������Դ״̬ת���Ϳ���֪ͨ</p>
</li>
<li><p>��ѭStorport miniport�����ܹ�</p>
</li>
</ol>
<p>��Ҫ�ص㣺</p>
<ol>
<li>֧���������ĵ�Դ����</li>
<li>֧���豸���м��</li>
<li>֧��D0&#x2F;D3״̬ת��</li>
<li>֧�ֶ������״̬</li>
<li>��ȷ����״̬����&#x2F;�ָ�</li>
</ol>
<p>���ʵ�ָ�����΢���ٷ��ĵ���Ҫ���Storport miniport�����ļܹ���</p>
<h2 id="User-14"><a href="#User-14" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>���ˣ�storport�ĵ�˵�ˣ�The number of elements in the Components array. Set this member to 1. Currently, only a single component is supported for either a storage adapter or logical unit.</p>
<h2 id="AI-claude-3-5-sonnet-14"><a href="#AI-claude-3-5-sonnet-14" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��˵�öԣ���Ϊ Storport miniport ����ʵ������ȷ�� PoFx ���ã�ֻʹ��һ�������</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">MINIPORT_DEVICE_EXTENSION</span> &#123;</span></span><br><span class="line">    <span class="comment">// Storport�����ṹ</span></span><br><span class="line">    STORPORT_EXTENSION StorPortExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ����״̬</span></span><br><span class="line">    STOR_POFX_DEVICE_V3 PoFxDevice;</span><br><span class="line">    STOR_POFX_COMPONENT_V2 Component;    <span class="comment">// ֻ֧��һ�����</span></span><br><span class="line">    BOOLEAN PowerManagementEnabled;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    DEVICE_POWER_STATE CurrentPowerState;</span><br><span class="line">    BOOLEAN DeviceBusy;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ļĴ���״̬</span></span><br><span class="line">    ULONG SavedRegisters[MAX_REGISTERS];</span><br><span class="line">    </span><br><span class="line">&#125; MINIPORT_DEVICE_EXTENSION, *PMINIPORT_DEVICE_EXTENSION;</span><br><span class="line"></span><br><span class="line">BOOLEAN <span class="title function_">HwInitialize</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PMINIPORT_DEVICE_EXTENSION miniport = DeviceExtension;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ��ʼ��PoFx�豸</span></span><br><span class="line">    miniport-&gt;PoFxDevice.Version = STOR_POFX_DEVICE_VERSION_V3;</span><br><span class="line">    miniport-&gt;PoFxDevice.Size = <span class="keyword">sizeof</span>(STOR_POFX_DEVICE_V3);</span><br><span class="line">    miniport-&gt;PoFxDevice.ComponentCount = <span class="number">1</span>;  <span class="comment">// ֻ������Ϊ1</span></span><br><span class="line">    miniport-&gt;PoFxDevice.Flags = STOR_POFX_FLAG_DEVICE_IDLE_CAPABLE;</span><br><span class="line">    miniport-&gt;PoFxDevice.D0IdleTimeout = <span class="number">100</span>; <span class="comment">// 100ms</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���õ������</span></span><br><span class="line">    miniport-&gt;Component.Version = STOR_POFX_COMPONENT_VERSION_V2;</span><br><span class="line">    miniport-&gt;Component.Size = <span class="keyword">sizeof</span>(STOR_POFX_COMPONENT_V2);</span><br><span class="line">    miniport-&gt;Component.Id = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStateCount = <span class="number">3</span>;</span><br><span class="line">    miniport-&gt;Component.DeepestWakeableIdleState = <span class="number">1</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">0</span>].TransitionLatency = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">0</span>].ResidencyRequirement = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">0</span>].NominalPower = <span class="number">100</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">1</span>].TransitionLatency = <span class="number">1000</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">1</span>].ResidencyRequirement = <span class="number">5000</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">1</span>].NominalPower = <span class="number">50</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">2</span>].TransitionLatency = <span class="number">5000</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">2</span>].ResidencyRequirement = <span class="number">10000</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">2</span>].NominalPower = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ע��PoFx�����뵥�����</span></span><br><span class="line">    status = StorPortInitializePofx(DeviceExtension,</span><br><span class="line">                                  &amp;miniport-&gt;PoFxDevice,</span><br><span class="line">                                  &amp;miniport-&gt;Component);</span><br><span class="line">                                  </span><br><span class="line">    <span class="keyword">return</span> (status == STATUS_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�޸�Ҫ�㣺</p>
<ol>
<li>ֻʹ��һ�����</li>
<li>ComponentCount ����Ϊ 1</li>
<li>�� SD Host Controller �� Card �ĵ�Դ�����ϲ�����������д���</li>
</ol>
<p>��л����ָ����</p>
<h2 id="User-15"><a href="#User-15" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>���֧�� Card �ĵ�Դ����</p>
<h2 id="AI-claude-3-5-sonnet-15"><a href="#AI-claude-3-5-sonnet-15" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>���� SD Card �ĵ�Դ���������� Storport PoFx ֻ֧��һ�������������Ҫ�� Host Controller ���洦�� Card �ĵ�Դ״̬��������ʵ�ַ�����</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">MINIPORT_DEVICE_EXTENSION</span> &#123;</span></span><br><span class="line">    STORPORT_EXTENSION StorPortExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// PoFx ����</span></span><br><span class="line">    STOR_POFX_DEVICE_V3 PoFxDevice;</span><br><span class="line">    STOR_POFX_COMPONENT_V2 Component;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Card ��Դ״̬</span></span><br><span class="line">    BOOLEAN CardPresent;</span><br><span class="line">    BOOLEAN CardPowered;</span><br><span class="line">    ULONG CardVoltage;</span><br><span class="line">    ULONG CardPowerState;  <span class="comment">// ��¼���ĵ�Դ״̬</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Host ״̬</span></span><br><span class="line">    DEVICE_POWER_STATE HostPowerState;</span><br><span class="line">    BOOLEAN DeviceBusy;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Ĵ���״̬</span></span><br><span class="line">    ULONG SavedRegisters[MAX_REGISTERS];</span><br><span class="line">    </span><br><span class="line">&#125; MINIPORT_DEVICE_EXTENSION, *PMINIPORT_DEVICE_EXTENSION;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Card ��Դ״̬����</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CARD_POWER_ON     0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CARD_POWER_SLEEP  1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CARD_POWER_OFF    2</span></span><br><span class="line"></span><br><span class="line">BOOLEAN <span class="title function_">HwInitialize</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PMINIPORT_DEVICE_EXTENSION miniport = DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ�� PoFx �豸</span></span><br><span class="line">    miniport-&gt;PoFxDevice.Version = STOR_POFX_DEVICE_VERSION_V3;</span><br><span class="line">    miniport-&gt;PoFxDevice.Size = <span class="keyword">sizeof</span>(STOR_POFX_DEVICE_V3);</span><br><span class="line">    miniport-&gt;PoFxDevice.ComponentCount = <span class="number">1</span>;</span><br><span class="line">    miniport-&gt;PoFxDevice.Flags = STOR_POFX_FLAG_DEVICE_IDLE_CAPABLE;</span><br><span class="line">    miniport-&gt;PoFxDevice.D0IdleTimeout = <span class="number">100</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Host Controller �������</span></span><br><span class="line">    miniport-&gt;Component.Version = STOR_POFX_COMPONENT_VERSION_V2;</span><br><span class="line">    miniport-&gt;Component.Size = <span class="keyword">sizeof</span>(STOR_POFX_COMPONENT_V2);</span><br><span class="line">    miniport-&gt;Component.Id = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStateCount = <span class="number">3</span>;</span><br><span class="line">    miniport-&gt;Component.DeepestWakeableIdleState = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// F0 - ��ȫ����״̬</span></span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">0</span>].TransitionLatency = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">0</span>].ResidencyRequirement = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">0</span>].NominalPower = <span class="number">100</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// F1 - �����ߣ�Host ���˯��</span></span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">1</span>].TransitionLatency = <span class="number">1000</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">1</span>].ResidencyRequirement = <span class="number">5000</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">1</span>].NominalPower = <span class="number">50</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// F2 - ���ϵ磬Host ���˯��</span></span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">2</span>].TransitionLatency = <span class="number">5000</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">2</span>].ResidencyRequirement = <span class="number">10000</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">2</span>].NominalPower = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> StorPortInitializePofx(DeviceExtension,</span><br><span class="line">                                &amp;miniport-&gt;PoFxDevice,</span><br><span class="line">                                &amp;miniport-&gt;Component) == STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOLEAN <span class="title function_">HandleIdleStateTransition</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PMINIPORT_DEVICE_EXTENSION Miniport,</span></span><br><span class="line"><span class="params">    _In_ ULONG IdleState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (IdleState) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">// F0</span></span><br><span class="line">            <span class="comment">// �ָ� Host</span></span><br><span class="line">            PowerUpHost(Miniport);</span><br><span class="line">            <span class="comment">// �ָ� Card</span></span><br><span class="line">            PowerUpCard(Miniport);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">// F1</span></span><br><span class="line">            <span class="comment">// Host ���˯��</span></span><br><span class="line">            SetHostLowPower(Miniport);</span><br><span class="line">            <span class="comment">// Card ����˯��ģʽ</span></span><br><span class="line">            SetCardSleepMode(Miniport);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>: <span class="comment">// F2</span></span><br><span class="line">            <span class="comment">// �����Ҫ״̬</span></span><br><span class="line">            SaveCardState(Miniport);</span><br><span class="line">            <span class="comment">// Card �ϵ�</span></span><br><span class="line">            PowerDownCard(Miniport);</span><br><span class="line">            <span class="comment">// Host ���˯��</span></span><br><span class="line">            PowerDownHost(Miniport);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOLEAN <span class="title function_">PowerUpCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PMINIPORT_DEVICE_EXTENSION Miniport</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ʹ�ܿ���Դ</span></span><br><span class="line">    WRITE_REGISTER_ULONG((PULONG)(Miniport-&gt;RegisterBase + CARD_PWR_CTRL),</span><br><span class="line">                        CARD_POWER_ENABLE | Miniport-&gt;CardVoltage);</span><br><span class="line">                        </span><br><span class="line">    <span class="comment">// 2. �ȴ���Դ�ȶ�</span></span><br><span class="line">    StorPortStallExecution(<span class="number">10000</span>); <span class="comment">// 10ms</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʼ��ʱ��</span></span><br><span class="line">    WRITE_REGISTER_ULONG((PULONG)(Miniport-&gt;RegisterBase + CARD_CLK_CTRL),</span><br><span class="line">                        CARD_CLK_ENABLE | CARD_CLK_DIVIDER);</span><br><span class="line">                        </span><br><span class="line">    <span class="comment">// 4. ���� GO_IDLE_STATE (CMD0)</span></span><br><span class="line">    status = SendCardCommand(Miniport, CMD0, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. �ָ���״̬</span></span><br><span class="line">    <span class="keyword">if</span> (Miniport-&gt;CardPowerState == CARD_POWER_SLEEP) &#123;</span><br><span class="line">        status = SendCardCommand(Miniport, CMD5, <span class="number">0</span>); <span class="comment">// ��˯�߻���</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Miniport-&gt;CardPowerState = CARD_POWER_ON;</span><br><span class="line">    Miniport-&gt;CardPowered = TRUE;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOLEAN <span class="title function_">SetCardSleepMode</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PMINIPORT_DEVICE_EXTENSION Miniport</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ����˯������</span></span><br><span class="line">    NTSTATUS status = SendCardCommand(Miniport, CMD5, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����ʱ��Ƶ��</span></span><br><span class="line">    WRITE_REGISTER_ULONG((PULONG)(Miniport-&gt;RegisterBase + CARD_CLK_CTRL),</span><br><span class="line">                        CARD_CLK_ENABLE | CARD_CLK_LOW_POWER);</span><br><span class="line">                        </span><br><span class="line">    <span class="comment">// 3. ���͵�ѹ</span></span><br><span class="line">    WRITE_REGISTER_ULONG((PULONG)(Miniport-&gt;RegisterBase + CARD_PWR_CTRL),</span><br><span class="line">                        CARD_POWER_ENABLE | CARD_VOLTAGE_LOW);</span><br><span class="line">                        </span><br><span class="line">    Miniport-&gt;CardPowerState = CARD_POWER_SLEEP;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOLEAN <span class="title function_">PowerDownCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PMINIPORT_DEVICE_EXTENSION Miniport</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ֹͣʱ��</span></span><br><span class="line">    WRITE_REGISTER_ULONG((PULONG)(Miniport-&gt;RegisterBase + CARD_CLK_CTRL),</span><br><span class="line">                        CARD_CLK_DISABLE);</span><br><span class="line">                        </span><br><span class="line">    <span class="comment">// 2. �Ͽ���Դ</span></span><br><span class="line">    WRITE_REGISTER_ULONG((PULONG)(Miniport-&gt;RegisterBase + CARD_PWR_CTRL),</span><br><span class="line">                        CARD_POWER_DISABLE);</span><br><span class="line">                        </span><br><span class="line">    Miniport-&gt;CardPowerState = CARD_POWER_OFF;</span><br><span class="line">    Miniport-&gt;CardPowered = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ��㣺</p>
<ol>
<li><p>�� PoFx �ĵ�һ����ж���������״̬��ÿ��״̬��Ӧ��ͬ�� Host �� Card ��Դ���</p>
</li>
<li><p>F0 ״̬��</p>
<ul>
<li>Host Controller ��ȫ����</li>
<li>Card ��ȫ����͹���</li>
</ul>
</li>
<li><p>F1 ״̬��</p>
<ul>
<li>Host Controller ���˯��</li>
<li>Card ����˯��ģʽ</li>
<li>������С��ѹ����</li>
</ul>
</li>
<li><p>F2 ״̬��</p>
<ul>
<li>Host Controller ���˯��</li>
<li>Card ��ȫ�ϵ�</li>
<li>�����Ҫ״̬</li>
</ul>
</li>
<li><p>״̬ת��ʱ��</p>
<ul>
<li>��ȷ�����µ�����</li>
<li>ʱ�ӹ���</li>
<li>��������</li>
<li>״̬����ͻָ�</li>
</ul>
</li>
<li><p>��������</p>
<ul>
<li>��Դ״̬ת��ʧ�ܴ���</li>
<li>���ʱ����</li>
<li>״̬�ָ�ʧ�ܴ���</li>
</ul>
</li>
</ol>
<p>����ʵ�ַ�ʽ������ Storport PoFx ������������£���Ȼʵ�ֶ� SD Card ��������Դ������</p>
<h2 id="User-16"><a href="#User-16" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>realtek Win11 PCI SD host driver RtsPer.sys�õ�ʲô�ܹ���WDF��sdportӦ�ò�̫����һ���ð�</p>
<h2 id="AI-claude-3-5-sonnet-16"><a href="#AI-claude-3-5-sonnet-16" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��˵�öԡ�ͨ������ RtsPer.sys����Ӧ��ʹ�õ��Ǵ� SDport �ܹ��������� WDF + SDport �Ļ�ϼܹ���ԭ�����£�</p>
<ol>
<li>SDport �����ܹ���</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �������</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    SDPORT_INITIALIZATION_DATA sdportData = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    sdportData.StructureSize = <span class="keyword">sizeof</span>(SDPORT_INITIALIZATION_DATA);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����Ļص�</span></span><br><span class="line">    sdportData.GetSlotCount = RtsPciGetSlotCount;</span><br><span class="line">    sdportData.GetSlotCapabilities = RtsPciGetSlotCapabilities;</span><br><span class="line">    sdportData.Initialize = RtsPciInitialize;</span><br><span class="line">    sdportData.IssueBusOperation = RtsPciIssueBusOperation;</span><br><span class="line">    sdportData.GetCardDetectState = RtsPciGetCardDetectState;</span><br><span class="line">    sdportData.Interrupt = RtsPciInterrupt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ѡ�Ļص�</span></span><br><span class="line">    sdportData.IssueRequest = RtsPciIssueRequest;</span><br><span class="line">    sdportData.GetResponse = RtsPciGetResponse;</span><br><span class="line">    sdportData.ToggleEvents = RtsPciToggleEvents;</span><br><span class="line">    sdportData.ClearEvents = RtsPciClearEvents;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> SdPortInitialize(DriverObject, RegistryPath, &amp;sdportData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ԭ��</li>
</ol>
<ul>
<li>SDport ר��Ϊ SD Host Controller ���</li>
<li>�ṩ������ SD Э��֧��</li>
<li>���õ�Դ��������</li>
<li>���õ������Ż�</li>
<li>��׼���Ľӿ�</li>
</ul>
<ol start="3">
<li>��ʹ�� WDF ��ԭ��</li>
</ol>
<ul>
<li>SDport �� WDF �ܹ���ͻ</li>
<li>����Ҫ WDF �� PnP ֧��</li>
<li>SDport ���ṩ��Ҫ����</li>
<li>�������Ŀ���</li>
<li>������������</li>
</ul>
<p>�����ļܹ�ѡ���Ǻ����ģ���Ϊ SDport ��������Ϊ SD Host Controller ר����ƵĿ�ܡ�</p>
<h2 id="User-17"><a href="#User-17" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�����ѵ�����������ʾ��WDM</p>
<h2 id="AI-claude-3-5-sonnet-17"><a href="#AI-claude-3-5-sonnet-17" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��Ǹ��֮ǰ���Ʋ���ȫ������˵�öԣ�ͨ��������ȷ�� RtsPer.sys ʵ��ʹ�õ��� WDM �ܹ���</p>
<p>���Ǹ�����ʵ�ʵļܹ���</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WDM Driver Entry</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ���� WDM ��׼�ص�</span></span><br><span class="line">    DriverObject-&gt;DriverExtension-&gt;AddDevice = RtsPciAddDevice;</span><br><span class="line">    DriverObject-&gt;MajorFunction[IRP_MJ_PNP] = RtsPciPnp;</span><br><span class="line">    DriverObject-&gt;MajorFunction[IRP_MJ_POWER] = RtsPciPower;</span><br><span class="line">    DriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = RtsPciDeviceControl;</span><br><span class="line">    DriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = RtsPciCreate;</span><br><span class="line">    DriverObject-&gt;MajorFunction[IRP_MJ_CLOSE] = RtsPciClose;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��л���ľ�����������ѧ����ʵ�ʲ�Ʒ�е���ʵʵ�֡�</p>
<h2 id="User-18"><a href="#User-18" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>WDM�����ʵ��RtsPer.sys</p>
<h2 id="AI-claude-3-5-sonnet-18"><a href="#AI-claude-3-5-sonnet-18" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>����WDM�ܹ���RtsPer.sys��ʵ�ִ������£�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_EXTENSION</span> &#123;</span></span><br><span class="line">    <span class="comment">// WDM���</span></span><br><span class="line">    PDEVICE_OBJECT DeviceObject;</span><br><span class="line">    PDEVICE_OBJECT PhysicalDeviceObject;</span><br><span class="line">    PDEVICE_OBJECT LowerDeviceObject;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// PCI��Դ</span></span><br><span class="line">    PUCHAR RegisterBase;</span><br><span class="line">    ULONG RegisterLength;</span><br><span class="line">    BOOLEAN MappedRegisters;</span><br><span class="line">    PCI_COMMON_CONFIG PciConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ж���Դ</span></span><br><span class="line">    PKINTERRUPT InterruptObject;</span><br><span class="line">    ULONG InterruptVector;</span><br><span class="line">    KIRQL InterruptIrql;</span><br><span class="line">    KINTERRUPT_MODE InterruptMode;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA���</span></span><br><span class="line">    PDMA_ADAPTER DmaAdapter;</span><br><span class="line">    PVOID CommonBuffer;</span><br><span class="line">    PHYSICAL_ADDRESS CommonBufferPhysical;</span><br><span class="line">    ULONG CommonBufferLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    DEVICE_POWER_STATE DevicePowerState;</span><br><span class="line">    SYSTEM_POWER_STATE SystemPowerState;</span><br><span class="line">    BOOLEAN DeviceInitialized;</span><br><span class="line">    BOOLEAN CardPresent;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ͬ������</span></span><br><span class="line">    KSPIN_LOCK SpinLock;</span><br><span class="line">    KEVENT RemoveEvent;</span><br><span class="line">    </span><br><span class="line">&#125; DEVICE_EXTENSION, *PDEVICE_EXTENSION;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddDevice�ص�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciAddDevice</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_OBJECT PhysicalDeviceObject</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PDEVICE_OBJECT deviceObject = <span class="literal">NULL</span>;</span><br><span class="line">    PDEVICE_EXTENSION devExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���������豸����(FDO)</span></span><br><span class="line">    status = IoCreateDevice(DriverObject,</span><br><span class="line">                          <span class="keyword">sizeof</span>(DEVICE_EXTENSION),</span><br><span class="line">                          <span class="literal">NULL</span>,</span><br><span class="line">                          FILE_DEVICE_UNKNOWN,</span><br><span class="line">                          FILE_DEVICE_SECURE_OPEN,</span><br><span class="line">                          FALSE,</span><br><span class="line">                          &amp;deviceObject);</span><br><span class="line">                          </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    devExt = (PDEVICE_EXTENSION)deviceObject-&gt;DeviceExtension;</span><br><span class="line">    RtlZeroMemory(devExt, <span class="keyword">sizeof</span>(DEVICE_EXTENSION));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ���豸��չ</span></span><br><span class="line">    devExt-&gt;DeviceObject = deviceObject;</span><br><span class="line">    devExt-&gt;PhysicalDeviceObject = PhysicalDeviceObject;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ӵ��豸ջ</span></span><br><span class="line">    devExt-&gt;LowerDeviceObject = </span><br><span class="line">        IoAttachDeviceToDeviceStack(deviceObject, PhysicalDeviceObject);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!devExt-&gt;LowerDeviceObject) &#123;</span><br><span class="line">        IoDeleteDevice(deviceObject);</span><br><span class="line">        <span class="keyword">return</span> STATUS_NO_SUCH_DEVICE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ��ͬ������</span></span><br><span class="line">    KeInitializeSpinLock(&amp;devExt-&gt;SpinLock);</span><br><span class="line">    KeInitializeEvent(&amp;devExt-&gt;RemoveEvent, NotificationEvent, FALSE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����豸�����־</span></span><br><span class="line">    deviceObject-&gt;Flags |= DO_POWER_PAGABLE;</span><br><span class="line">    deviceObject-&gt;Flags &amp;= ~DO_DEVICE_INITIALIZING;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PnP�ַ�����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciPnp</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_OBJECT DeviceObject,</span></span><br><span class="line"><span class="params">    _In_ PIRP Irp</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_EXTENSION devExt = (PDEVICE_EXTENSION)DeviceObject-&gt;DeviceExtension;</span><br><span class="line">    PIO_STACK_LOCATION irpStack = IoGetCurrentIrpStackLocation(Irp);</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (irpStack-&gt;MinorFunction) &#123;</span><br><span class="line">        <span class="keyword">case</span> IRP_MN_START_DEVICE:</span><br><span class="line">            <span class="comment">// �����豸</span></span><br><span class="line">            status = RtsPciStartDevice(DeviceObject, Irp);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> IRP_MN_STOP_DEVICE:</span><br><span class="line">            <span class="comment">// ֹͣ�豸</span></span><br><span class="line">            status = RtsPciStopDevice(DeviceObject, Irp);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> IRP_MN_REMOVE_DEVICE:</span><br><span class="line">            <span class="comment">// �Ƴ��豸</span></span><br><span class="line">            status = RtsPciRemoveDevice(DeviceObject, Irp);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> IRP_MN_SURPRISE_REMOVAL:</span><br><span class="line">            <span class="comment">// �����Ƴ�</span></span><br><span class="line">            status = RtsPciSurpriseRemoval(DeviceObject, Irp);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// ����PnP IRP���ݸ��²�</span></span><br><span class="line">            IoSkipCurrentIrpStackLocation(Irp);</span><br><span class="line">            status = IoCallDriver(devExt-&gt;LowerDeviceObject, Irp);</span><br><span class="line">            <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �����豸</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciStartDevice</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_OBJECT DeviceObject,</span></span><br><span class="line"><span class="params">    _In_ PIRP Irp</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_EXTENSION devExt = (PDEVICE_EXTENSION)DeviceObject-&gt;DeviceExtension;</span><br><span class="line">    PIO_STACK_LOCATION irpStack = IoGetCurrentIrpStackLocation(Irp);</span><br><span class="line">    PCM_PARTIAL_RESOURCE_LIST rawList, transList;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡԭʼ��ת�������Դ�б�</span></span><br><span class="line">    rawList = &amp;irpStack-&gt;Parameters.StartDevice.AllocatedResources-&gt;List[<span class="number">0</span>].PartialResourceList;</span><br><span class="line">    transList = &amp;irpStack-&gt;Parameters.StartDevice.AllocatedResourceList-&gt;List[<span class="number">0</span>].PartialResourceList;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ӳ��Ӳ����Դ</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; transList-&gt;Count; i++) &#123;</span><br><span class="line">        PCM_PARTIAL_RESOURCE_DESCRIPTOR res = &amp;transList-&gt;PartialDescriptors[i];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (res-&gt;Type) &#123;</span><br><span class="line">            <span class="keyword">case</span> CmResourceTypeMemory:</span><br><span class="line">                <span class="comment">// ӳ��Ĵ����ռ�</span></span><br><span class="line">                devExt-&gt;RegisterBase = MmMapIoSpace(res-&gt;u.Memory.Start,</span><br><span class="line">                                                  res-&gt;u.Memory.Length,</span><br><span class="line">                                                  MmNonCached);</span><br><span class="line">                devExt-&gt;RegisterLength = res-&gt;u.Memory.Length;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> CmResourceTypeInterrupt:</span><br><span class="line">                <span class="comment">// �����ж�</span></span><br><span class="line">                status = IoConnectInterrupt(&amp;devExt-&gt;InterruptObject,</span><br><span class="line">                                          RtsPciIsr,</span><br><span class="line">                                          devExt,</span><br><span class="line">                                          &amp;devExt-&gt;SpinLock,</span><br><span class="line">                                          res-&gt;u.Interrupt.Vector,</span><br><span class="line">                                          res-&gt;u.Interrupt.Level,</span><br><span class="line">                                          res-&gt;u.Interrupt.Level,</span><br><span class="line">                                          res-&gt;u.Interrupt.Affinity,</span><br><span class="line">                                          FALSE);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ��Ӳ��</span></span><br><span class="line">    status = RtsPciInitializeHardware(devExt);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���IRP</span></span><br><span class="line">    Irp-&gt;IoStatus.Status = status;</span><br><span class="line">    IoCompleteRequest(Irp, IO_NO_INCREMENT);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ�����ַ�����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciPower</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_OBJECT DeviceObject,</span></span><br><span class="line"><span class="params">    _In_ PIRP Irp</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_EXTENSION devExt = (PDEVICE_EXTENSION)DeviceObject-&gt;DeviceExtension;</span><br><span class="line">    PIO_STACK_LOCATION irpStack = IoGetCurrentIrpStackLocation(Irp);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (irpStack-&gt;MinorFunction) &#123;</span><br><span class="line">        <span class="keyword">case</span> IRP_MN_SET_POWER:</span><br><span class="line">            <span class="keyword">if</span> (irpStack-&gt;Parameters.Power.Type == DevicePowerState) &#123;</span><br><span class="line">                <span class="comment">// �����豸��Դ״̬�仯</span></span><br><span class="line">                DEVICE_POWER_STATE newState = </span><br><span class="line">                    irpStack-&gt;Parameters.Power.State.DeviceState;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">if</span> (newState == PowerDeviceD0) &#123;</span><br><span class="line">                    <span class="comment">// �����豸</span></span><br><span class="line">                    RtsPciPowerUp(devExt);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// �����豸</span></span><br><span class="line">                    RtsPciPowerDown(devExt);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    PoStartNextPowerIrp(Irp);</span><br><span class="line">    IoSkipCurrentIrpStackLocation(Irp);</span><br><span class="line">    <span class="keyword">return</span> PoCallDriver(devExt-&gt;LowerDeviceObject, Irp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �жϷ�������</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PKINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ PVOID Context</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_EXTENSION devExt = (PDEVICE_EXTENSION)Context;</span><br><span class="line">    BOOLEAN handled = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡ�ж�״̬</span></span><br><span class="line">    ULONG intStatus = READ_REGISTER_ULONG(</span><br><span class="line">        (PULONG)(devExt-&gt;RegisterBase + INT_STATUS_OFFSET));</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (intStatus) &#123;</span><br><span class="line">        <span class="comment">// �����ж�</span></span><br><span class="line">        <span class="keyword">if</span> (intStatus &amp; CARD_INSERT_INT) &#123;</span><br><span class="line">            devExt-&gt;CardPresent = TRUE;</span><br><span class="line">            handled = TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (intStatus &amp; CARD_REMOVE_INT) &#123;</span><br><span class="line">            devExt-&gt;CardPresent = FALSE;</span><br><span class="line">            handled = TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����ж�״̬</span></span><br><span class="line">        WRITE_REGISTER_ULONG(</span><br><span class="line">            (PULONG)(devExt-&gt;RegisterBase + INT_STATUS_OFFSET),</span><br><span class="line">            intStatus);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Ҫ�ص㣺</p>
<ol>
<li>ʹ��WDM��׼�ܹ���</li>
</ol>
<ul>
<li>AddDevice����FDO</li>
<li>����PnP��Power IRP</li>
<li>ʵ���жϴ���</li>
<li>��Դ����</li>
</ul>
<ol start="2">
<li>Ӳ�����ʣ�</li>
</ol>
<ul>
<li>ӳ��PCI��Դ</li>
<li>�Ĵ�����д</li>
<li>DMA����</li>
<li>�жϴ���</li>
</ul>
<ol start="3">
<li>��Դ������</li>
</ol>
<ul>
<li>D0&#x2F;D3״̬ת��</li>
<li>����Դ����</li>
<li>ʱ�ӹ���</li>
</ul>
<ol start="4">
<li>ͬ�����ƣ�</li>
</ol>
<ul>
<li>SpinLock����</li>
<li>�¼�֪ͨ</li>
<li>IRP����</li>
</ul>
<p>����ʵ�ַ�ʽ����WDM�����ܹ����ܹ��ܺõ�֧��PCIe SD Host Controller�Ĺ��ܡ�</p>
<h2 id="User-19"><a href="#User-19" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>��WDF���ʵ��RtsPer.sys</p>
<h2 id="AI-claude-3-5-sonnet-19"><a href="#AI-claude-3-5-sonnet-19" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>ʹ��WDFʵ��RtsPer.sys����Ҫ�ܹ����£�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_CONTEXT</span> &#123;</span></span><br><span class="line">    WDFDEVICE       Device;</span><br><span class="line">    WDFINTERRUPT    Interrupt;</span><br><span class="line">    WDFDMAENABLER   DmaEnabler;</span><br><span class="line">    WDFSPINLOCK     Lock;</span><br><span class="line">    WDFQUEUE        IoQueue;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Ĵ���ӳ��</span></span><br><span class="line">    PVOID           RegisterBase;</span><br><span class="line">    ULONG           RegisterLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    BOOLEAN         CardPresent;</span><br><span class="line">    BOOLEAN         Initialized;</span><br><span class="line">    ULONG           Capabilities;</span><br><span class="line">    DEVICE_POWER_STATE PowerState;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA���</span></span><br><span class="line">    PVOID           DmaBuffer;</span><br><span class="line">    PHYSICAL_ADDRESS DmaPhysicalAddress;</span><br><span class="line">    SIZE_T          DmaBufferSize;</span><br><span class="line">    </span><br><span class="line">&#125; DEVICE_CONTEXT, *PDEVICE_CONTEXT;</span><br><span class="line"></span><br><span class="line">WDF_DECLARE_CONTEXT_TYPE_WITH_NAME(DEVICE_CONTEXT, GetDeviceContext)</span><br><span class="line"></span><br><span class="line"><span class="comment">// �������</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;config, RtsPciEvtDeviceAdd);</span><br><span class="line">    </span><br><span class="line">    status = WdfDriverCreate(DriverObject,</span><br><span class="line">                           RegistryPath,</span><br><span class="line">                           WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                           &amp;config,</span><br><span class="line">                           WDF_NO_HANDLE);</span><br><span class="line">                           </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �豸���ӻص�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceAdd</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDRIVER Driver,</span></span><br><span class="line"><span class="params">    _Inout_ PWDFDEVICE_INIT DeviceInit</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES deviceAttributes;</span><br><span class="line">    WDFDEVICE device;</span><br><span class="line">    PDEVICE_CONTEXT deviceContext;</span><br><span class="line">    WDF_PNPPOWER_EVENT_CALLBACKS pnpPowerCallbacks;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����PnP Power�ص�</span></span><br><span class="line">    WDF_PNPPOWER_EVENT_CALLBACKS_INIT(&amp;pnpPowerCallbacks);</span><br><span class="line">    pnpPowerCallbacks.EvtDevicePrepareHardware = RtsPciEvtPrepareHardware;</span><br><span class="line">    pnpPowerCallbacks.EvtDeviceReleaseHardware = RtsPciEvtReleaseHardware;</span><br><span class="line">    pnpPowerCallbacks.EvtDeviceD0Entry = RtsPciEvtDeviceD0Entry;</span><br><span class="line">    pnpPowerCallbacks.EvtDeviceD0Exit = RtsPciEvtDeviceD0Exit;</span><br><span class="line">    </span><br><span class="line">    WdfDeviceInitSetPnpPowerEventCallbacks(DeviceInit, &amp;pnpPowerCallbacks);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����豸</span></span><br><span class="line">    WDF_OBJECT_ATTRIBUTES_INIT_CONTEXT_TYPE(&amp;deviceAttributes, DEVICE_CONTEXT);</span><br><span class="line">    </span><br><span class="line">    status = WdfDeviceCreate(&amp;DeviceInit,</span><br><span class="line">                            &amp;deviceAttributes,</span><br><span class="line">                            &amp;device);</span><br><span class="line">                            </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����ж�</span></span><br><span class="line">    WDF_INTERRUPT_CONFIG interruptConfig;</span><br><span class="line">    WDF_INTERRUPT_CONFIG_INIT(&amp;interruptConfig,</span><br><span class="line">                            RtsPciEvtInterruptIsr,</span><br><span class="line">                            RtsPciEvtInterruptDpc);</span><br><span class="line">                            </span><br><span class="line">    status = WdfInterruptCreate(device,</span><br><span class="line">                               &amp;interruptConfig,</span><br><span class="line">                               WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                               &amp;deviceContext-&gt;Interrupt);</span><br><span class="line">                               </span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">    WDF_DMA_ENABLER_CONFIG dmaConfig;</span><br><span class="line">    WDF_DMA_ENABLER_CONFIG_INIT(&amp;dmaConfig,</span><br><span class="line">                               WdfDmaProfileScatterGather,</span><br><span class="line">                               RTSPER_MAX_TRANSFER_LENGTH);</span><br><span class="line">                               </span><br><span class="line">    status = WdfDmaEnablerCreate(device,</span><br><span class="line">                                &amp;dmaConfig,</span><br><span class="line">                                WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                                &amp;deviceContext-&gt;DmaEnabler);</span><br><span class="line">                                </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ׼��Ӳ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtPrepareHardware</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceList,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceListTranslated</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ӳ����Դ</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; WdfCmResourceListGetCount(ResourceListTranslated); i++) &#123;</span><br><span class="line">        PCM_PARTIAL_RESOURCE_DESCRIPTOR res = </span><br><span class="line">            WdfCmResourceListGetDescriptor(ResourceListTranslated, i);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">switch</span> (res-&gt;Type) &#123;</span><br><span class="line">            <span class="keyword">case</span> CmResourceTypeMemory:</span><br><span class="line">                devContext-&gt;RegisterBase = MmMapIoSpaceEx(</span><br><span class="line">                    res-&gt;u.Memory.Start,</span><br><span class="line">                    res-&gt;u.Memory.Length,</span><br><span class="line">                    PAGE_READWRITE | PAGE_NOCACHE);</span><br><span class="line">                devContext-&gt;RegisterLength = res-&gt;u.Memory.Length;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ��Ӳ��</span></span><br><span class="line">    status = RtsPciInitializeHardware(devContext);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �ж�ISR</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciEvtInterruptIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ ULONG MessageID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(</span><br><span class="line">        WdfInterruptGetDevice(Interrupt));</span><br><span class="line">    BOOLEAN handled = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡ�ж�״̬</span></span><br><span class="line">    ULONG intStatus = READ_REGISTER_ULONG(</span><br><span class="line">        (PULONG)(devContext-&gt;RegisterBase + INT_STATUS_OFFSET));</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (intStatus) &#123;</span><br><span class="line">        <span class="comment">// �����ж�</span></span><br><span class="line">        <span class="keyword">if</span> (intStatus &amp; CARD_INSERT_INT) &#123;</span><br><span class="line">            WdfInterruptQueueDpcForIsr(Interrupt);</span><br><span class="line">            handled = TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����ж�״̬</span></span><br><span class="line">        WRITE_REGISTER_ULONG(</span><br><span class="line">            (PULONG)(devContext-&gt;RegisterBase + INT_STATUS_OFFSET),</span><br><span class="line">            intStatus);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �ж�DPC</span></span><br><span class="line">VOID <span class="title function_">RtsPciEvtInterruptDpc</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ WDFOBJECT Device</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����������/�γ�</span></span><br><span class="line">    <span class="keyword">if</span> (RtsPciIsCardPresent(devContext)) &#123;</span><br><span class="line">        RtsPciHandleCardInsertion(devContext);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        RtsPciHandleCardRemoval(devContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ���� - D0����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceD0Entry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDF_POWER_DEVICE_STATE PreviousState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ϵ�����</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        (PULONG)(devContext-&gt;RegisterBase + POWER_CTRL),</span><br><span class="line">        POWER_ON);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ��ʼ��ʱ��</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        (PULONG)(devContext-&gt;RegisterBase + CLOCK_CTRL),</span><br><span class="line">        CLOCK_ON);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ʹ���ж�</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        (PULONG)(devContext-&gt;RegisterBase + INT_ENABLE),</span><br><span class="line">        INT_ENABLE_ALL);</span><br><span class="line">        </span><br><span class="line">    devContext-&gt;PowerState = PowerDeviceD0;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ���� - D0�˳�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceD0Exit</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDF_POWER_DEVICE_STATE TargetState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����ж�</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        (PULONG)(devContext-&gt;RegisterBase + INT_ENABLE),</span><br><span class="line">        <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// �ر�ʱ��</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        (PULONG)(devContext-&gt;RegisterBase + CLOCK_CTRL),</span><br><span class="line">        CLOCK_OFF);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// �رյ�Դ</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        (PULONG)(devContext-&gt;RegisterBase + POWER_CTRL),</span><br><span class="line">        POWER_OFF);</span><br><span class="line">        </span><br><span class="line">    devContext-&gt;PowerState = PowerDeviceD3;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Ҫ�ص㣺</p>
<ol>
<li>ʹ��WDF��ܣ�</li>
</ol>
<ul>
<li>�򻯵�PnP&#x2F;Power����</li>
<li>�Զ�����Դ����</li>
<li>���ö����������ڹ���</li>
</ul>
<ol start="2">
<li>�豸�����ģ�</li>
</ol>
<ul>
<li>ͳһ���豸״̬����</li>
<li>WDF�����װ</li>
<li>�򻯵�ͬ������</li>
</ul>
<ol start="3">
<li>�жϴ�����</li>
</ol>
<ul>
<li>ISR&#x2F;DPCģ��</li>
<li>WDF�ж϶���</li>
<li>�Զ����жϹ���</li>
</ul>
<ol start="4">
<li>DMA֧�֣�</li>
</ol>
<ul>
<li>WDF DMA���</li>
<li>�򻯵�DMA����</li>
<li>�Զ�����Դ����</li>
</ul>
<ol start="5">
<li>��Դ������</li>
</ol>
<ul>
<li>�򻯵�D0&#x2F;D3ת��</li>
<li>�Զ�����Դ״̬����</li>
<li>���ɵĿ��м��</li>
</ul>
<p>����WDFʵ�����WDM���Ӽ��Ϳɿ��������˺ܶ�������롣</p>
<h2 id="User-20"><a href="#User-20" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>WDF���ʵ��SDЭ��ջ</p>
<h2 id="AI-claude-3-5-sonnet-20"><a href="#AI-claude-3-5-sonnet-20" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>ʹ��WDFʵ��SDЭ��ջ�Ĺؼ��������£�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SD����ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SD_COMMAND</span> &#123;</span></span><br><span class="line">    UCHAR CommandCode;</span><br><span class="line">    ULONG Argument;</span><br><span class="line">    UCHAR ResponseType;</span><br><span class="line">    ULONG Response[<span class="number">4</span>];</span><br><span class="line">    BOOLEAN HasData;</span><br><span class="line">    BOOLEAN IsWrite;</span><br><span class="line">    ULONG BlockCount;</span><br><span class="line">    ULONG BlockSize;</span><br><span class="line">&#125; SD_COMMAND, *PSD_COMMAND;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �豸��������չ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_CONTEXT</span> &#123;</span></span><br><span class="line">    <span class="comment">// ... ������Ա ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SDЭ�����</span></span><br><span class="line">    ULONG CardRCA;</span><br><span class="line">    ULONG CardStatus;</span><br><span class="line">    SD_CARD_TYPE CardType;</span><br><span class="line">    BOOLEAN HighCapacity;</span><br><span class="line">    BOOLEAN UhsSupport;</span><br><span class="line">    ULONG CurrentClock;</span><br><span class="line">    ULONG CurrentVoltage;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����/���ݻ���</span></span><br><span class="line">    WDFSPINLOCK CmdLock;</span><br><span class="line">    WDFREQUEST CurrentRequest;</span><br><span class="line">    WDFMEMORY CommandBuffer;</span><br><span class="line">    </span><br><span class="line">&#125; DEVICE_CONTEXT, *PDEVICE_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����SD����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciSendCommand</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PSD_COMMAND Command</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    ULONG cmdReg, statusReg;</span><br><span class="line">    LARGE_INTEGER timeout;</span><br><span class="line">    </span><br><span class="line">    WdfSpinLockAcquire(DevContext-&gt;CmdLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �ȴ������߿���</span></span><br><span class="line">    timeout.QuadPart = <span class="number">-10000000</span>; <span class="comment">// 1��</span></span><br><span class="line">    <span class="keyword">while</span> (READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + CMD_STATUS) &amp; CMD_BUSY) &#123;</span><br><span class="line">        <span class="keyword">if</span> (KeWaitForSingleObject(&amp;timeout, Executive, KernelMode, FALSE, <span class="literal">NULL</span>) == STATUS_TIMEOUT) &#123;</span><br><span class="line">            status = STATUS_IO_TIMEOUT;</span><br><span class="line">            <span class="keyword">goto</span> Exit;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����������</span></span><br><span class="line">    WRITE_REGISTER_ULONG(DevContext-&gt;RegisterBase + CMD_ARG, Command-&gt;Argument);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��������Ĵ���</span></span><br><span class="line">    cmdReg = (Command-&gt;CommandCode &lt;&lt; CMD_INDEX_SHIFT) |</span><br><span class="line">             (Command-&gt;ResponseType &lt;&lt; RESP_TYPE_SHIFT);</span><br><span class="line">             </span><br><span class="line">    <span class="keyword">if</span> (Command-&gt;HasData) &#123;</span><br><span class="line">        cmdReg |= CMD_DATA_PRESENT;</span><br><span class="line">        <span class="keyword">if</span> (Command-&gt;IsWrite) &#123;</span><br><span class="line">            cmdReg |= CMD_WRITE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    WRITE_REGISTER_ULONG(DevContext-&gt;RegisterBase + CMD_REG, cmdReg);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �ȴ��������</span></span><br><span class="line">    status = RtsPciWaitForCommandComplete(DevContext, &amp;statusReg);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> Exit;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ��ȡ��Ӧ</span></span><br><span class="line">    <span class="keyword">if</span> (Command-&gt;ResponseType != RESP_NONE) &#123;</span><br><span class="line">        Command-&gt;Response[<span class="number">0</span>] = READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + RESP0);</span><br><span class="line">        <span class="keyword">if</span> (Command-&gt;ResponseType == RESP_LONG) &#123;</span><br><span class="line">            Command-&gt;Response[<span class="number">1</span>] = READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + RESP1);</span><br><span class="line">            Command-&gt;Response[<span class="number">2</span>] = READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + RESP2);</span><br><span class="line">            Command-&gt;Response[<span class="number">3</span>] = READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + RESP3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">Exit:</span><br><span class="line">    WdfSpinLockRelease(DevContext-&gt;CmdLock);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ��SD��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    SD_COMMAND cmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����GO_IDLE_STATE (CMD0)</span></span><br><span class="line">    cmd.CommandCode = <span class="number">0</span>;</span><br><span class="line">    cmd.ResponseType = RESP_NONE;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����IF_COND (CMD8)</span></span><br><span class="line">    cmd.CommandCode = <span class="number">8</span>;</span><br><span class="line">    cmd.Argument = <span class="number">0x1AA</span>; <span class="comment">// 3.3V�ͼ��ģʽ</span></span><br><span class="line">    cmd.ResponseType = RESP_SHORT;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����ACMD41</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// �ȷ���APP_CMD (CMD55)</span></span><br><span class="line">        cmd.CommandCode = <span class="number">55</span>;</span><br><span class="line">        cmd.Argument = <span class="number">0</span>;</span><br><span class="line">        cmd.ResponseType = RESP_SHORT;</span><br><span class="line">        status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����SD_SEND_OP_COND (ACMD41)</span></span><br><span class="line">        cmd.CommandCode = <span class="number">41</span>;</span><br><span class="line">        cmd.Argument = <span class="number">0x40FF8000</span>; <span class="comment">// HCS=1, ֧�ֵ�ѹ��Χ</span></span><br><span class="line">        cmd.ResponseType = RESP_SHORT;</span><br><span class="line">        status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (cmd.Response[<span class="number">0</span>] &amp; <span class="number">0x80000000</span>) &#123;</span><br><span class="line">            <span class="comment">// ����ʼ�����</span></span><br><span class="line">            DevContext-&gt;HighCapacity = (cmd.Response[<span class="number">0</span>] &amp; <span class="number">0x40000000</span>) ? TRUE : FALSE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        KeStallExecutionProcessor(<span class="number">10000</span>); <span class="comment">// 10ms�ӳ�</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ��ȡCID (CMD2)</span></span><br><span class="line">    cmd.CommandCode = <span class="number">2</span>;</span><br><span class="line">    cmd.ResponseType = RESP_LONG;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ��ȡ��RCA (CMD3)</span></span><br><span class="line">    cmd.CommandCode = <span class="number">3</span>;</span><br><span class="line">    cmd.ResponseType = RESP_SHORT;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;CardRCA = cmd.Response[<span class="number">0</span>] &amp; <span class="number">0xFFFF0000</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ѡ�� (CMD7)</span></span><br><span class="line">    cmd.CommandCode = <span class="number">7</span>;</span><br><span class="line">    cmd.Argument = DevContext-&gt;CardRCA;</span><br><span class="line">    cmd.ResponseType = RESP_SHORT;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���ݴ���������</span></span><br><span class="line">VOID <span class="title function_">RtsPciEvtIoRead</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFQUEUE Queue,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> Length</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(WdfIoQueueGetDevice(Queue));</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    SD_COMMAND cmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    PVOID buffer;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡ����buffer</span></span><br><span class="line">    status = WdfRequestRetrieveOutputBuffer(Request, Length, &amp;buffer, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        WdfRequestComplete(Request, status);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ö�����</span></span><br><span class="line">    cmd.CommandCode = <span class="number">17</span>; <span class="comment">// READ_SINGLE_BLOCK</span></span><br><span class="line">    cmd.ResponseType = RESP_SHORT;</span><br><span class="line">    cmd.HasData = TRUE;</span><br><span class="line">    cmd.IsWrite = FALSE;</span><br><span class="line">    cmd.BlockCount = <span class="number">1</span>;</span><br><span class="line">    cmd.BlockSize = <span class="number">512</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">    status = RtsPciSetupDmaForTransfer(devContext, buffer, Length);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        WdfRequestComplete(Request, status);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">    devContext-&gt;CurrentRequest = Request;</span><br><span class="line">    status = RtsPciSendCommand(devContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        WdfRequestComplete(Request, status);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ������жϴ�����</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �жϴ�������ɴ���</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciEvtInterruptIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ ULONG MessageID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(WdfInterruptGetDevice(Interrupt));</span><br><span class="line">    ULONG intStatus;</span><br><span class="line">    BOOLEAN handled = FALSE;</span><br><span class="line">    </span><br><span class="line">    intStatus = READ_REGISTER_ULONG(devContext-&gt;RegisterBase + INT_STATUS);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; XFER_COMPLETE) &#123;</span><br><span class="line">        <span class="keyword">if</span> (devContext-&gt;CurrentRequest) &#123;</span><br><span class="line">            WdfRequestComplete(devContext-&gt;CurrentRequest, STATUS_SUCCESS);</span><br><span class="line">            devContext-&gt;CurrentRequest = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        handled = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; ERROR_INT) &#123;</span><br><span class="line">        <span class="keyword">if</span> (devContext-&gt;CurrentRequest) &#123;</span><br><span class="line">            WdfRequestComplete(devContext-&gt;CurrentRequest, STATUS_IO_DEVICE_ERROR);</span><br><span class="line">            devContext-&gt;CurrentRequest = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        handled = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ж�״̬</span></span><br><span class="line">    WRITE_REGISTER_ULONG(devContext-&gt;RegisterBase + INT_STATUS, intStatus);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ��㣺</p>
<ol>
<li>�������</li>
</ol>
<ul>
<li>������й���</li>
<li>��Ӧ����</li>
<li>��ʱ����</li>
</ul>
<ol start="2">
<li>���ݴ��䣺</li>
</ol>
<ul>
<li>DMA����</li>
<li>����������</li>
<li>���֪ͨ</li>
</ul>
<ol start="3">
<li>��������</li>
</ol>
<ul>
<li>�������ָ�</li>
<li>���������</li>
<li>��ʱ�ָ�</li>
</ul>
<ol start="4">
<li>״̬������</li>
</ol>
<ul>
<li>��״̬����</li>
<li>��ѹ����</li>
<li>ʱ�ӹ���</li>
</ul>
<ol start="5">
<li>�����Ż���</li>
</ol>
<ul>
<li>DMA����</li>
<li>�жϺϲ�</li>
<li>������ˮ��</li>
</ul>
<p>��ֻ�ǻ�����ܣ�ʵ��ʵ�ֻ���Ҫ���ǣ�</p>
<ul>
<li>UHSģʽ֧��</li>
<li>��鴫��</li>
<li>��Դ����</li>
<li>����ָ�</li>
<li>����֧��</li>
</ul>
<h2 id="User-21"><a href="#User-21" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>���ʵ��SD������SD Host�󣬱�ʶ��ΪSD�洢�豸����ϵͳ��ʾ�̷�</p>
<h2 id="AI-claude-3-5-sonnet-21"><a href="#AI-claude-3-5-sonnet-21" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>Ҫʵ��SD����ʶ��Ϊ�洢�豸����ʾ�̷�����Ҫ���¹ؼ����裺</p>
<ol>
<li>�豸�ӿں�����������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��EvtDeviceAdd��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceAdd</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDRIVER Driver,</span></span><br><span class="line"><span class="params">    _Inout_ PWDFDEVICE_INIT DeviceInit</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ����Ϊ�洢�豸</span></span><br><span class="line">    WdfDeviceInitSetDeviceClass(DeviceInit, &amp;GUID_DEVCLASS_SCSIADAPTER);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ע��洢�ӿ�</span></span><br><span class="line">    status = WdfDeviceCreateDeviceInterface(</span><br><span class="line">        device,</span><br><span class="line">        &amp;GUID_DEVINTERFACE_DISK,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// �����豸����</span></span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES pnpCaps;</span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES_INIT(&amp;pnpCaps);</span><br><span class="line">    pnpCaps.Removable = WdfTrue;</span><br><span class="line">    pnpCaps.SurpriseRemovalOK = WdfTrue;</span><br><span class="line">    WdfDeviceSetPnpCapabilities(device, &amp;pnpCaps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ʵ�ִ洢��ӿڣ�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">STOR_DEVICE_INTERFACE</span> &#123;</span></span><br><span class="line">    STOR_SCSI_IDENTITY Identity;</span><br><span class="line">    STOR_ADAPTER_CONTROL_TYPE AdapterControl;</span><br><span class="line">    STOR_HW_CALLBACKS Callbacks;</span><br><span class="line">&#125; STOR_DEVICE_INTERFACE, *PSTOR_DEVICE_INTERFACE;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeStorageInterface</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    STOR_DEVICE_INTERFACE storInterface = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����豸��ʶ</span></span><br><span class="line">    storInterface.Identity.DeviceType = FILE_DEVICE_DISK;</span><br><span class="line">    storInterface.Identity.DeviceTypeModifier = <span class="number">0</span>;</span><br><span class="line">    storInterface.Identity.RemovableMedia = TRUE;</span><br><span class="line">    storInterface.Identity.VendorIdOffset = <span class="number">0</span>;</span><br><span class="line">    storInterface.Identity.ProductIdOffset = <span class="number">8</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ûص�</span></span><br><span class="line">    storInterface.Callbacks.StartIo = RtsPciStartIo;</span><br><span class="line">    storInterface.Callbacks.BuildIo = RtsPciBuildIo;</span><br><span class="line">    storInterface.Callbacks.Initialize = RtsPciInitialize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ע��ӿ�</span></span><br><span class="line">    <span class="keyword">return</span> StorPortRegisterInterface(</span><br><span class="line">        DevContext-&gt;WdfDevice,</span><br><span class="line">        &amp;storInterface);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>����SCSI���</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciStartIo</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PSTOR_REQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PCDB cdb = Request-&gt;Cdb;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (cdb-&gt;CDB6GENERIC.OperationCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> SCSIOP_READ:</span><br><span class="line">            <span class="keyword">return</span> RtsPciHandleRead(DevContext, Request);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SCSIOP_WRITE:</span><br><span class="line">            <span class="keyword">return</span> RtsPciHandleWrite(DevContext, Request);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SCSIOP_INQUIRY:</span><br><span class="line">            <span class="keyword">return</span> RtsPciHandleInquiry(DevContext, Request);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SCSIOP_READ_CAPACITY:</span><br><span class="line">            <span class="keyword">return</span> RtsPciHandleReadCapacity(DevContext, Request);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SCSIOP_TEST_UNIT_READY:</span><br><span class="line">            <span class="keyword">return</span> RtsPciHandleTestUnitReady(DevContext, Request);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_INVALID_DEVICE_REQUEST;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleRead</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PSTOR_REQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PCDB cdb = Request-&gt;Cdb;</span><br><span class="line">    ULONGLONG startSector;</span><br><span class="line">    ULONG numSectors;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡ��ʼ����������</span></span><br><span class="line">    startSector = ((ULONGLONG)cdb-&gt;CDB10.LogicalBlockByte3 &lt;&lt; <span class="number">24</span>) |</span><br><span class="line">                 ((ULONGLONG)cdb-&gt;CDB10.LogicalBlockByte2 &lt;&lt; <span class="number">16</span>) |</span><br><span class="line">                 ((ULONGLONG)cdb-&gt;CDB10.LogicalBlockByte1 &lt;&lt; <span class="number">8</span>) |</span><br><span class="line">                  (ULONGLONG)cdb-&gt;CDB10.LogicalBlockByte0;</span><br><span class="line">                  </span><br><span class="line">    numSectors = ((ULONG)cdb-&gt;CDB10.TransferBlocksMsb &lt;&lt; <span class="number">8</span>) |</span><br><span class="line">                 (ULONG)cdb-&gt;CDB10.TransferBlocksLsb;</span><br><span class="line">                 </span><br><span class="line">    <span class="comment">// ����SD����</span></span><br><span class="line">    SD_COMMAND sdCmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    sdCmd.CommandCode = <span class="number">18</span>; <span class="comment">// READ_MULTIPLE_BLOCK</span></span><br><span class="line">    sdCmd.Argument = DevContext-&gt;HighCapacity ? startSector : (startSector * <span class="number">512</span>);</span><br><span class="line">    sdCmd.ResponseType = RESP_SHORT;</span><br><span class="line">    sdCmd.HasData = TRUE;</span><br><span class="line">    sdCmd.IsWrite = FALSE;</span><br><span class="line">    sdCmd.BlockCount = numSectors;</span><br><span class="line">    sdCmd.BlockSize = <span class="number">512</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">    status = RtsPciSetupDmaForRequest(DevContext, Request);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">    <span class="keyword">return</span> RtsPciSendCommand(DevContext, &amp;sdCmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����INQUIRY����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleInquiry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PSTOR_REQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PINQUIRYDATA inquiryData = Request-&gt;DataBuffer;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(inquiryData, <span class="keyword">sizeof</span>(INQUIRYDATA));</span><br><span class="line">    </span><br><span class="line">    inquiryData-&gt;DeviceType = DIRECT_ACCESS_DEVICE;</span><br><span class="line">    inquiryData-&gt;RemovableMedia = <span class="number">1</span>;</span><br><span class="line">    inquiryData-&gt;Versions = <span class="number">0x05</span>; <span class="comment">// SPC-3</span></span><br><span class="line">    inquiryData-&gt;ResponseDataFormat = <span class="number">0x02</span>;</span><br><span class="line">    inquiryData-&gt;AdditionalLength = <span class="number">31</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ó��̺Ͳ�Ʒ��Ϣ</span></span><br><span class="line">    RtlCopyMemory(inquiryData-&gt;VendorId, <span class="string">&quot;SD CARD &quot;</span>, <span class="number">8</span>);</span><br><span class="line">    RtlCopyMemory(inquiryData-&gt;ProductId, <span class="string">&quot;Mass Storage  &quot;</span>, <span class="number">16</span>);</span><br><span class="line">    RtlCopyMemory(inquiryData-&gt;ProductRevisionLevel, <span class="string">&quot;1.00&quot;</span>, <span class="number">4</span>);</span><br><span class="line">    </span><br><span class="line">    Request-&gt;DataTransferLength = <span class="keyword">sizeof</span>(INQUIRYDATA);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>����δ�����</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">RtsPciHandleCardInsertion</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ʼ����</span></span><br><span class="line">    status = RtsPciInitializeCard(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ȡ����Ϣ</span></span><br><span class="line">    status = RtsPciGetCardInfo(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ֪ͨ�洢������</span></span><br><span class="line">    StorPortNotifyMediaStatus(</span><br><span class="line">        DevContext-&gt;WdfDevice,</span><br><span class="line">        STOR_MEDIA_STATUS_PRESENT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">RtsPciHandleCardRemoval</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ֪ͨ�洢������</span></span><br><span class="line">    StorPortNotifyMediaStatus(</span><br><span class="line">        DevContext-&gt;WdfDevice,</span><br><span class="line">        STOR_MEDIA_STATUS_NOT_PRESENT);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ����״̬</span></span><br><span class="line">    DevContext-&gt;CardPresent = FALSE;</span><br><span class="line">    DevContext-&gt;CardRCA = <span class="number">0</span>;</span><br><span class="line">    DevContext-&gt;HighCapacity = FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>��Դ������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceD0Entry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDF_POWER_DEVICE_STATE PreviousState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �ϵ�����</span></span><br><span class="line">    status = RtsPciPowerUpSequence(devContext);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��������ڣ����³�ʼ��</span></span><br><span class="line">    <span class="keyword">if</span> (RtsPciIsCardPresent(devContext)) &#123;</span><br><span class="line">        status = RtsPciInitializeCard(devContext);</span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            StorPortNotifyMediaStatus(</span><br><span class="line">                devContext-&gt;WdfDevice,</span><br><span class="line">                STOR_MEDIA_STATUS_PRESENT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ��㣺</p>
<ol>
<li>�豸��ʶ��</li>
</ol>
<ul>
<li>��ȷע��Ϊ�洢�豸</li>
<li>ʵ�ֱ�Ҫ��SCSI����</li>
<li>�ṩ�豸��Ϣ</li>
</ul>
<ol start="2">
<li>���ݴ��䣺</li>
</ol>
<ul>
<li>����ӳ��</li>
<li>DMA֧��</li>
<li>������</li>
</ul>
<ol start="3">
<li>ý�������</li>
</ol>
<ul>
<li>��μ��</li>
<li>״̬֪ͨ</li>
<li>��Դ����</li>
</ul>
<ol start="4">
<li>�����Ż���</li>
</ol>
<ul>
<li>�������</li>
<li>��鴫��</li>
<li>�������</li>
</ul>
<ol start="5">
<li>�ɿ��ԣ�</li>
</ol>
<ul>
<li>����ָ�</li>
<li>��ʱ����</li>
<li>״̬ͬ��</li>
</ul>
<p>����ʵ�ֺ󣬵�SD������ʱ��Windows�Ὣ��ʶ��Ϊ���ƶ����̲������̷���</p>
<h2 id="User-22"><a href="#User-22" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>SD��Ӧ�÷���Ϊ�洢�豸����û�����������ʵ�ѡ��</p>
<h2 id="AI-claude-3-5-sonnet-22"><a href="#AI-claude-3-5-sonnet-22" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>SD��Ӧ��ʹ��SD Bus&#x2F;SD Storage����������Windows�У�SD�豸��ר�ŵ���GUID��������ܣ�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �豸�ӿ�GUID</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GUID_SD_DEVICE_INTERFACE \</span></span><br><span class="line"><span class="meta">    &#123;0x6e1e80b9, 0xad45, 0x46f6, &#123;0xb6, 0x5d, 0x4f, 0x45, 0x45, 0x9d, 0xa8, 0x1f&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// SD���߽ӿ�GUID    </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GUID_DEVINTERFACE_SD_HOST_CONTROLLER \</span></span><br><span class="line"><span class="meta">    &#123;0x4b36e968, 0x2353, 0x4ee2, &#123;0x8c, 0xe5, 0x8c, 0x62, 0x0e, 0x14, 0x88, 0x9b&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ��EvtDeviceAdd��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceAdd</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDRIVER Driver,</span></span><br><span class="line"><span class="params">    _Inout_ PWDFDEVICE_INIT DeviceInit</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ����ΪSD Host Controller</span></span><br><span class="line">    WdfDeviceInitSetDeviceClass(DeviceInit, &amp;GUID_DEVCLASS_SD_HOST_CONTROLLER);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����SD���߽ӿ�</span></span><br><span class="line">    status = WdfDeviceCreateDeviceInterface(</span><br><span class="line">        device,</span><br><span class="line">        &amp;GUID_DEVINTERFACE_SD_HOST_CONTROLLER,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// �����豸����</span></span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES pnpCaps;</span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES_INIT(&amp;pnpCaps);</span><br><span class="line">    pnpCaps.Removable = WdfTrue;</span><br><span class="line">    pnpCaps.SurpriseRemovalOK = WdfTrue;</span><br><span class="line">    WdfDeviceSetPnpCapabilities(device, &amp;pnpCaps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>����Windows��ʹ�ñ�׼��SD��������(sdbus.sys)��SD�洢������(sdstor.sys)�������豸����������SCSI&#x2F;�洢·�������Ǹ����ʵķ��෽ʽ��</p>
<h2 id="User-23"><a href="#User-23" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�����Զ����SD Host Controller������realtek, Bayhub��SD Host������SD��������(sdbus.sys)��SD�洢������(sdstor.sys)</p>
<h2 id="AI-claude-3-5-sonnet-23"><a href="#AI-claude-3-5-sonnet-23" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>���ڳ����Զ����SD Host Controller��ͨ�������ַ�����</p>
<ol>
<li>ʹ�ó����Լ�������ʵ��������SDЭ��ջ��</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �豸���Ͷ���</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GUID_DEVCLASS_RTSPER \</span></span><br><span class="line"><span class="meta">    &#123;0x4b36e968, 0x2353, 0x4ee2, &#123;0x8c, 0xe5, 0x8c, 0x62, 0x0e, 0x14, 0x88, 0x9b&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_CONTEXT</span> &#123;</span></span><br><span class="line">    WDFDEVICE       Device;</span><br><span class="line">    WDFINTERRUPT    Interrupt;</span><br><span class="line">    WDFDMAENABLER   DmaEnabler;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Զ���Ĵ�������</span></span><br><span class="line">    PVOID           RegisterBase;</span><br><span class="line">    ULONG           RegisterLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Զ���SDЭ��ʵ��</span></span><br><span class="line">    ULONG           CardStatus;</span><br><span class="line">    ULONG           CardRCA;</span><br><span class="line">    BOOLEAN         HighCapacity;</span><br><span class="line">    ULONG           CurrentClock;</span><br><span class="line">    ULONG           CurrentVoltage;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���������ض��ֶ�</span></span><br><span class="line">    ...</span><br><span class="line">&#125; DEVICE_CONTEXT, *PDEVICE_CONTEXT;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ʵ�ּ��ݲ���ʹ�ñ�׼SD����������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ʵ�ֱ�׼SD Host Controller�ӿ�</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SDHOST_CAPABILITIES</span> &#123;</span></span><br><span class="line">    ULONG           SpecVersion;     <span class="comment">// SD�淶�汾</span></span><br><span class="line">    ULONG           MaxBlockSize;    <span class="comment">// �����С</span></span><br><span class="line">    ULONG           MaxClockFreq;    <span class="comment">// ���ʱ��Ƶ��</span></span><br><span class="line">    SD_HOST_CAPS    Capabilities;    <span class="comment">// ��׼����</span></span><br><span class="line">    BOOLEAN         BusWidth4Bit;    <span class="comment">// 4λ����֧��</span></span><br><span class="line">    BOOLEAN         HighSpeed;       <span class="comment">// ����ģʽ֧��</span></span><br><span class="line">&#125; SDHOST_CAPABILITIES, *PSDHOST_CAPABILITIES;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �Ĵ���ӳ���</span></span><br><span class="line">NTSTATUS <span class="title function_">MapVendorRegistersToStandard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _Out_ PSD_HOST_REGISTERS StdRegs</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ӳ�䳧���ض��Ĵ�������׼SD�Ĵ�������</span></span><br><span class="line">    StdRegs-&gt;CommandRegister = DevContext-&gt;RegisterBase + VENDOR_CMD_OFFSET;</span><br><span class="line">    StdRegs-&gt;ArgumentRegister = DevContext-&gt;RegisterBase + VENDOR_ARG_OFFSET;</span><br><span class="line">    StdRegs-&gt;DataRegister = DevContext-&gt;RegisterBase + VENDOR_DATA_OFFSET;</span><br><span class="line">    StdRegs-&gt;PresentStateRegister = DevContext-&gt;RegisterBase + VENDOR_STATE_OFFSET;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����ת����</span></span><br><span class="line">NTSTATUS <span class="title function_">TranslateStandardToVendorCommand</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PSD_COMMAND StdCmd,</span></span><br><span class="line"><span class="params">    _Out_ PVENDOR_SD_COMMAND VendorCmd</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ת����׼SD��������ض���ʽ</span></span><br><span class="line">    VendorCmd-&gt;CmdIndex = StdCmd-&gt;Index;</span><br><span class="line">    VendorCmd-&gt;CmdArg = StdCmd-&gt;Argument;</span><br><span class="line">    VendorCmd-&gt;RespType = MapResponseType(StdCmd-&gt;ResponseType);</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��ʵ���ϣ����������(����Realtek��Bayhub)ѡ�񷽰�1��ԭ���ǣ�</p>
<ol>
<li>���������ԣ�</li>
</ol>
<ul>
<li>�Ǳ�׼�Ĵ�������</li>
<li>�����ʱ��Ҫ��</li>
<li>�Զ����DMA����</li>
<li>�����ض��Ĺ���</li>
</ul>
<ol start="2">
<li>���ܿ��ǣ�</li>
</ol>
<ul>
<li>����ת������</li>
<li>�Ż��ض�����</li>
<li>ֱ��Ӳ������</li>
</ul>
<ol start="3">
<li>�����ԣ�</li>
</ol>
<ul>
<li>֧�־ɰ�Windows</li>
<li>����Ӳ��Ҫ��</li>
<li>���ƻ�����</li>
</ul>
<ol start="4">
<li>ά���ԣ�</li>
</ol>
<ul>
<li>��������</li>
<li>�������</li>
<li>���ⶨλ</li>
</ul>
<p>����ͨ����ʵ�ַ�ʽ�ǣ�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �������</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ��WDF����</span></span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;config, RtsPciEvtDeviceAdd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> WdfDriverCreate(DriverObject,</span><br><span class="line">                          RegistryPath,</span><br><span class="line">                          WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                          &amp;config,</span><br><span class="line">                          WDF_NO_HANDLE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ʵ���Լ���SDЭ��ջ</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeSDStack</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ��ʼ��Ӳ��</span></span><br><span class="line">    status = RtsPciInitializeHardware(DevContext);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ʵ��SD�����</span></span><br><span class="line">    status = RtsPciInitializeCommandEngine(DevContext);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ʵ�����ݴ���</span></span><br><span class="line">    status = RtsPciInitializeDataEngine(DevContext);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ʵ���жϴ���</span></span><br><span class="line">    status = RtsPciInitializeInterrupt(DevContext);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ʵ�ִ洢�ӿ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeStorageInterface</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ʵ�ֿ��豸�ӿ�</span></span><br><span class="line">    status = RtsPciRegisterBlockInterface(DevContext);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ʵ�ַ�������</span></span><br><span class="line">    status = RtsPciInitializePartitionManager(DevContext);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>���ַ�ʽ��Ȼ�����������󣬵��ܸ��õؿ��ƺ��Ż��豸���ܡ�</p>
<h2 id="User-24"><a href="#User-24" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�����Զ����SD Host���ʵ�ִ洢�ӿ�</p>
<h2 id="AI-claude-3-5-sonnet-24"><a href="#AI-claude-3-5-sonnet-24" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�����Զ����SD Hostͨ��ͨ��ʵ��Storport miniport�ӿ����ṩ�洢���ܡ������ǹؼ�ʵ�֣�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. ��ʼ��Storport miniport</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    HW_INITIALIZATION_DATA hwInitData = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    hwInitData.HwInitializationDataSize = <span class="keyword">sizeof</span>(HW_INITIALIZATION_DATA);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ñ���Ļص�</span></span><br><span class="line">    hwInitData.HwInitialize = RtsPciHwInitialize;</span><br><span class="line">    hwInitData.HwStartIo = RtsPciHwStartIo;</span><br><span class="line">    hwInitData.HwFindAdapter = RtsPciHwFindAdapter;</span><br><span class="line">    hwInitData.HwResetBus = RtsPciHwResetBus;</span><br><span class="line">    hwInitData.HwInterrupt = RtsPciHwInterrupt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����miniport����</span></span><br><span class="line">    hwInitData.AutoRequestSense = TRUE;</span><br><span class="line">    hwInitData.TaggedQueuing = TRUE;</span><br><span class="line">    hwInitData.MultipleRequestPerLu = TRUE;</span><br><span class="line">    hwInitData.AdapterInterfaceType = PCIBus;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> StorPortInitialize(DriverObject,</span><br><span class="line">                            RegistryPath,</span><br><span class="line">                            &amp;hwInitData,</span><br><span class="line">                            <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. �豸��չ�ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">HW_DEVICE_EXTENSION</span> &#123;</span></span><br><span class="line">    <span class="comment">// StorportҪ��</span></span><br><span class="line">    STORPORT_DEVICE_EXTENSION StorPortExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸��Դ</span></span><br><span class="line">    PVOID RegisterBase;</span><br><span class="line">    ULONG RegisterLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SD��״̬</span></span><br><span class="line">    BOOLEAN CardPresent;</span><br><span class="line">    ULONG CardCapacity;</span><br><span class="line">    BOOLEAN HighCapacity;</span><br><span class="line">    ULONG BlockSize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����״̬</span></span><br><span class="line">    STOR_SCATTER_GATHER_LIST SGList;</span><br><span class="line">    ULONG CurrentLBA;</span><br><span class="line">    ULONG BlockCount;</span><br><span class="line">    BOOLEAN TransferActive;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �������</span></span><br><span class="line">    LIST_ENTRY CmdQueue;</span><br><span class="line">    KSPIN_LOCK QueueLock;</span><br><span class="line">    </span><br><span class="line">&#125; HW_DEVICE_EXTENSION, *PHW_DEVICE_EXTENSION;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. ����IO����</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciHwStartIo</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ PSCSI_REQUEST_BLOCK Srb</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PHW_DEVICE_EXTENSION hwDevExt = (PHW_DEVICE_EXTENSION)DeviceExtension;</span><br><span class="line">    PCDB cdb = (PCDB)Srb-&gt;Cdb;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (cdb-&gt;CDB6GENERIC.OperationCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> SCSIOP_READ:</span><br><span class="line">            status = RtsPciHandleRead(hwDevExt, Srb);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SCSIOP_WRITE:</span><br><span class="line">            status = RtsPciHandleWrite(hwDevExt, Srb);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SCSIOP_INQUIRY:</span><br><span class="line">            status = RtsPciHandleInquiry(hwDevExt, Srb);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SCSIOP_READ_CAPACITY:</span><br><span class="line">            status = RtsPciHandleReadCapacity(hwDevExt, Srb);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            Srb-&gt;SrbStatus = SRB_STATUS_INVALID_REQUEST;</span><br><span class="line">            StorPortNotification(RequestComplete,</span><br><span class="line">                               DeviceExtension,</span><br><span class="line">                               Srb);</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (status == STATUS_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. ����������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleRead</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PHW_DEVICE_EXTENSION HwDevExt,</span></span><br><span class="line"><span class="params">    _In_ PSCSI_REQUEST_BLOCK Srb</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PCDB cdb = (PCDB)Srb-&gt;Cdb;</span><br><span class="line">    ULONG lba, blocks;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡLBA�Ϳ���</span></span><br><span class="line">    lba = ((ULONG)cdb-&gt;CDB10.LogicalBlockByte3 &lt;&lt; <span class="number">24</span>) |</span><br><span class="line">          ((ULONG)cdb-&gt;CDB10.LogicalBlockByte2 &lt;&lt; <span class="number">16</span>) |</span><br><span class="line">          ((ULONG)cdb-&gt;CDB10.LogicalBlockByte1 &lt;&lt; <span class="number">8</span>) |</span><br><span class="line">          (ULONG)cdb-&gt;CDB10.LogicalBlockByte0;</span><br><span class="line">          </span><br><span class="line">    blocks = ((ULONG)cdb-&gt;CDB10.TransferBlocksMsb &lt;&lt; <span class="number">8</span>) |</span><br><span class="line">             (ULONG)cdb-&gt;CDB10.TransferBlocksLsb;</span><br><span class="line">             </span><br><span class="line">    <span class="comment">// ���ô������</span></span><br><span class="line">    HwDevExt-&gt;CurrentLBA = lba;</span><br><span class="line">    HwDevExt-&gt;BlockCount = blocks;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡSG�б�</span></span><br><span class="line">    StorPortGetScatterGatherList(HwDevExt, Srb);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">    <span class="keyword">return</span> RtsPciStartTransfer(HwDevExt, FALSE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. ʵ�����ݴ���</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciStartTransfer</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PHW_DEVICE_EXTENSION HwDevExt,</span></span><br><span class="line"><span class="params">    _In_ BOOLEAN IsWrite</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ����SD����</span></span><br><span class="line">    ULONG cmdReg = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (IsWrite) &#123;</span><br><span class="line">        cmdReg = (<span class="number">24</span> &lt;&lt; CMD_INDEX_SHIFT) | <span class="comment">// WRITE_MULTIPLE_BLOCK</span></span><br><span class="line">                (RESP_R1 &lt;&lt; RESP_TYPE_SHIFT) |</span><br><span class="line">                CMD_DATA_PRESENT | CMD_WRITE;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cmdReg = (<span class="number">18</span> &lt;&lt; CMD_INDEX_SHIFT) | <span class="comment">// READ_MULTIPLE_BLOCK</span></span><br><span class="line">                (RESP_R1 &lt;&lt; RESP_TYPE_SHIFT) |</span><br><span class="line">                CMD_DATA_PRESENT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">    RtsPciSetupDMA(HwDevExt);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ÿ��С������</span></span><br><span class="line">    WRITE_REGISTER_ULONG(HwDevExt-&gt;RegisterBase + BLOCK_SIZE_REG,</span><br><span class="line">                        HwDevExt-&gt;BlockSize);</span><br><span class="line">    WRITE_REGISTER_ULONG(HwDevExt-&gt;RegisterBase + BLOCK_COUNT_REG,</span><br><span class="line">                        HwDevExt-&gt;BlockCount);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ò���������</span></span><br><span class="line">    WRITE_REGISTER_ULONG(HwDevExt-&gt;RegisterBase + ARG_REG,</span><br><span class="line">                        HwDevExt-&gt;CurrentLBA);</span><br><span class="line">    WRITE_REGISTER_ULONG(HwDevExt-&gt;RegisterBase + CMD_REG,</span><br><span class="line">                        cmdReg);</span><br><span class="line">                        </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. �жϴ���</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciHwInterrupt</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PHW_DEVICE_EXTENSION hwDevExt = (PHW_DEVICE_EXTENSION)DeviceExtension;</span><br><span class="line">    ULONG intStatus;</span><br><span class="line">    PSCSI_REQUEST_BLOCK srb;</span><br><span class="line">    </span><br><span class="line">    intStatus = READ_REGISTER_ULONG(hwDevExt-&gt;RegisterBase + INT_STATUS);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; XFER_COMPLETE) &#123;</span><br><span class="line">        <span class="comment">// ��ɵ�ǰSRB</span></span><br><span class="line">        srb = StorPortGetCurrentSrb(DeviceExtension);</span><br><span class="line">        <span class="keyword">if</span> (srb) &#123;</span><br><span class="line">            srb-&gt;SrbStatus = SRB_STATUS_SUCCESS;</span><br><span class="line">            StorPortNotification(RequestComplete,</span><br><span class="line">                               DeviceExtension,</span><br><span class="line">                               srb);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; ERROR_INT) &#123;</span><br><span class="line">        <span class="comment">// ��������</span></span><br><span class="line">        srb = StorPortGetCurrentSrb(DeviceExtension);</span><br><span class="line">        <span class="keyword">if</span> (srb) &#123;</span><br><span class="line">            srb-&gt;SrbStatus = SRB_STATUS_ERROR;</span><br><span class="line">            StorPortNotification(RequestComplete,</span><br><span class="line">                               DeviceExtension,</span><br><span class="line">                               srb);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ��㣺</p>
<ol>
<li>�����ܹ���</li>
</ol>
<ul>
<li>ʹ��Storport miniport</li>
<li>ʵ�ֱ���Ļص�</li>
<li>����SCSI����</li>
</ul>
<ol start="2">
<li>���ݴ��䣺</li>
</ol>
<ul>
<li>Scatter&#x2F;Gather֧��</li>
<li>DMA����</li>
<li>�������</li>
</ul>
<ol start="3">
<li>�����Ż���</li>
</ol>
<ul>
<li>�����Ŷ�</li>
<li>�жϺϲ�</li>
<li>DMA����</li>
</ul>
<ol start="4">
<li>��������</li>
</ol>
<ul>
<li>��ʱ����</li>
<li>����ָ�</li>
<li>״̬ͬ��</li>
</ul>
<ol start="5">
<li>��Դ������</li>
</ol>
<ul>
<li>�ڴ����</li>
<li>DMA��Դ</li>
<li>Ӳ������</li>
</ul>
<p>����ʵ�ֿ�����SD����Windows����Ϊ��׼�洢�豸ʹ�á�</p>
<h2 id="User-25"><a href="#User-25" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>Storport��Win11 24H����Щ���⣬�����WDF���ʵ�ִ洢�ӿ�</p>
<h2 id="AI-claude-3-5-sonnet-25"><a href="#AI-claude-3-5-sonnet-25" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��Win11�ϣ�����ʹ��WDF + Storage Class Extension��ʵ�ִ洢�ӿڡ������ǹؼ�ʵ�֣�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. �豸������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_CONTEXT</span> &#123;</span></span><br><span class="line">    WDFDEVICE       Device;</span><br><span class="line">    WDFINTERRUPT    Interrupt;</span><br><span class="line">    WDFDMAENABLER   DmaEnabler;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Storage Class Extension���</span></span><br><span class="line">    STORAGE_DEVICE_HANDLE StorHandle;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    BOOLEAN         MediaPresent;</span><br><span class="line">    ULONGLONG      DiskSize;</span><br><span class="line">    ULONG          BlockSize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Ĵ�������Դ</span></span><br><span class="line">    PVOID          RegisterBase;</span><br><span class="line">    </span><br><span class="line">&#125; DEVICE_CONTEXT, *PDEVICE_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ������ʼ��</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT  DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;config, RtsPciEvtDeviceAdd);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ��Storage Class Extension</span></span><br><span class="line">    STORAGE_DRIVER_CONFIG storageConfig = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    storageConfig.Size = <span class="keyword">sizeof</span>(STORAGE_DRIVER_CONFIG);</span><br><span class="line">    storageConfig.Version = STORAGE_DRIVER_CONFIG_VERSION;</span><br><span class="line">    </span><br><span class="line">    status = StorageClassInitialize(DriverObject, </span><br><span class="line">                                  RegistryPath,</span><br><span class="line">                                  &amp;storageConfig);</span><br><span class="line">                                  </span><br><span class="line">    <span class="keyword">return</span> WdfDriverCreate(DriverObject,</span><br><span class="line">                          RegistryPath,</span><br><span class="line">                          WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                          &amp;config,</span><br><span class="line">                          WDF_NO_HANDLE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. �豸����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceAdd</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_    WDFDRIVER       Driver,</span></span><br><span class="line"><span class="params">    _Inout_ PWDFDEVICE_INIT DeviceInit</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    STORAGE_DEVICE_CONFIG storageConfig = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ô洢�豸</span></span><br><span class="line">    storageConfig.Size = <span class="keyword">sizeof</span>(STORAGE_DEVICE_CONFIG);</span><br><span class="line">    storageConfig.Version = STORAGE_DEVICE_CONFIG_VERSION;</span><br><span class="line">    storageConfig.DeviceType = FILE_DEVICE_DISK;</span><br><span class="line">    storageConfig.Removable = TRUE;</span><br><span class="line">    </span><br><span class="line">    status = StorageDeviceInitConfig(DeviceInit, &amp;storageConfig);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����豸</span></span><br><span class="line">    WDF_OBJECT_ATTRIBUTES attributes;</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES_INIT_CONTEXT_TYPE(&amp;attributes, </span><br><span class="line">                                          DEVICE_CONTEXT);</span><br><span class="line">                                          </span><br><span class="line">    WDFDEVICE device;</span><br><span class="line">    status = WdfDeviceCreate(&amp;DeviceInit, </span><br><span class="line">                            &amp;attributes,</span><br><span class="line">                            &amp;device);</span><br><span class="line">                            </span><br><span class="line">    <span class="comment">// ��ʼ��Storage Class Extension�豸</span></span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(device);</span><br><span class="line">    </span><br><span class="line">    STORAGE_DEVICE_DESCRIPTOR_DATA descData = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    descData.Size = <span class="keyword">sizeof</span>(STORAGE_DEVICE_DESCRIPTOR_DATA);</span><br><span class="line">    descData.Version = STORAGE_DEVICE_DESCRIPTOR_VERSION;</span><br><span class="line">    descData.BlockSize = <span class="number">512</span>;</span><br><span class="line">    descData.MaxTransferLength = <span class="number">128</span> * <span class="number">1024</span>;  <span class="comment">// 128KB</span></span><br><span class="line">    </span><br><span class="line">    status = StorageDeviceInitialize(device,</span><br><span class="line">                                   &amp;descData,</span><br><span class="line">                                   &amp;devContext-&gt;StorHandle);</span><br><span class="line">                                   </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. ʵ�ִ洢�ӿڻص�</span></span><br><span class="line">EVT_STORAGE_READ_WRITE RtsPciEvtStorageRead;</span><br><span class="line">EVT_STORAGE_READ_WRITE RtsPciEvtStorageWrite;</span><br><span class="line">EVT_STORAGE_DEVICE_CONTROL RtsPciEvtStorageDeviceControl;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">RtsPciEvtStorageRead</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ STORAGE_REQUEST_DATA* Data</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡ�������</span></span><br><span class="line">    ULONGLONG startingOffset = Data-&gt;Offset;</span><br><span class="line">    SIZE_T length = Data-&gt;Length;</span><br><span class="line">    ULONG blockCount = (ULONG)(length / devContext-&gt;BlockSize);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">    status = RtsPciSetupDmaForRequest(devContext, Request);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        WdfRequestComplete(Request, status);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����SD������</span></span><br><span class="line">    status = RtsPciSendReadCommand(devContext, </span><br><span class="line">                                 startingOffset / devContext-&gt;BlockSize,</span><br><span class="line">                                 blockCount);</span><br><span class="line">                                 </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        WdfRequestComplete(Request, status);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ������жϴ�����</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. �жϴ���</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciEvtInterruptIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ ULONG MessageID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(</span><br><span class="line">        WdfInterruptGetDevice(Interrupt));</span><br><span class="line">        </span><br><span class="line">    ULONG intStatus = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + INT_STATUS_OFFSET);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; XFER_COMPLETE) &#123;</span><br><span class="line">        <span class="comment">// ��ɵ�ǰ����</span></span><br><span class="line">        <span class="keyword">if</span> (devContext-&gt;CurrentRequest) &#123;</span><br><span class="line">            WdfRequestComplete(devContext-&gt;CurrentRequest, </span><br><span class="line">                             STATUS_SUCCESS);</span><br><span class="line">            devContext-&gt;CurrentRequest = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. ý����</span></span><br><span class="line">VOID <span class="title function_">RtsPciEvtStorageQueryDeviceInformation</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ STORAGE_PROPERTY_ID PropertyId</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (PropertyId) &#123;</span><br><span class="line">        <span class="keyword">case</span> StorageDeviceProperty: &#123;</span><br><span class="line">            PSTORAGE_DEVICE_DESCRIPTOR desc = </span><br><span class="line">                WdfRequestWdmGetIrp(Request)-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">                </span><br><span class="line">            <span class="comment">// ����豸������</span></span><br><span class="line">            desc-&gt;DeviceType = FILE_DEVICE_DISK;</span><br><span class="line">            desc-&gt;RemovableMedia = TRUE;</span><br><span class="line">            desc-&gt;BusType = BusTypeSD;</span><br><span class="line">            </span><br><span class="line">            WdfRequestComplete(Request, STATUS_SUCCESS);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> StorageMediaTypeProperty: &#123;</span><br><span class="line">            PSTORAGE_MEDIA_TYPE mediaType =</span><br><span class="line">                WdfRequestWdmGetIrp(Request)-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">                </span><br><span class="line">            *mediaType = RemovableMedia;</span><br><span class="line">            </span><br><span class="line">            WdfRequestComplete(Request, STATUS_SUCCESS);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. ��Դ����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceD0Entry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDF_POWER_DEVICE_STATE PreviousState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ϵ�����</span></span><br><span class="line">    status = RtsPciPowerUpSequence(devContext);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��鿨״̬</span></span><br><span class="line">    <span class="keyword">if</span> (RtsPciIsCardPresent(devContext)) &#123;</span><br><span class="line">        status = RtsPciInitializeCard(devContext);</span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            StorageDeviceNotifyMediaStatus(devContext-&gt;StorHandle,</span><br><span class="line">                                         TRUE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>�ؼ��㣺</p>
<ol>
<li>�ܹ�ѡ��</li>
</ol>
<ul>
<li>ʹ��WDF���</li>
<li>����Storage Class Extension</li>
<li>ʵ�ֱ�Ҫ�Ļص�</li>
</ul>
<ol start="2">
<li>�洢�ӿڣ�</li>
</ol>
<ul>
<li>���豸����</li>
<li>ý�����</li>
<li>���Բ�ѯ</li>
</ul>
<ol start="3">
<li>�����Ż���</li>
</ol>
<ul>
<li>DMA����</li>
<li>�������</li>
<li>�жϴ���</li>
</ul>
<ol start="4">
<li>�ɿ��ԣ�</li>
</ol>
<ul>
<li>����ָ�</li>
<li>״̬ͬ��</li>
<li>��ʱ����</li>
</ul>
<ol start="5">
<li>��Դ������</li>
</ol>
<ul>
<li>D0&#x2F;D3״̬</li>
<li>����Դ����</li>
<li>״̬�ָ�</li>
</ul>
<p>����ʵ�ַ�ʽ��Win11�ϸ����ȶ��͸�Ч��</p>
<h2 id="User-26"><a href="#User-26" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>STORAGE_DRIVER_CONFIG�����ﶨ���</p>
<h2 id="AI-claude-3-5-sonnet-26"><a href="#AI-claude-3-5-sonnet-26" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��Ǹ���ҵ�ʾ��������Windows���������У����ڴ洢�豸��Ӧ��ʹ��StoragePortClassInitialize��������������Ĵ��룺</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// storuuid.h �� storport.h �ж����˴洢��ӿ�</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;storuuid.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;storport.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. �������</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT  DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;config, RtsPciEvtDeviceAdd);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ��StorPort</span></span><br><span class="line">    status = StorPortInitialize(DriverObject,</span><br><span class="line">                              RegistryPath,</span><br><span class="line">                              &amp;hwInitData,</span><br><span class="line">                              <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> WdfDriverCreate(DriverObject,</span><br><span class="line">                          RegistryPath,</span><br><span class="line">                          WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                          &amp;config,</span><br><span class="line">                          WDF_NO_HANDLE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. �豸������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_CONTEXT</span> &#123;</span></span><br><span class="line">    WDFDEVICE       Device;</span><br><span class="line">    WDFINTERRUPT    Interrupt;</span><br><span class="line">    WDFDMAENABLER   DmaEnabler;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    BOOLEAN         MediaPresent;</span><br><span class="line">    ULONGLONG       DiskSize;</span><br><span class="line">    ULONG           BlockSize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Ĵ�������Դ</span></span><br><span class="line">    PVOID           RegisterBase;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// StorPort���</span></span><br><span class="line">    STOR_SCSI_IDENTITY ScsiId;</span><br><span class="line">    STOR_PORT_HANDLE   PortHandle;</span><br><span class="line">    </span><br><span class="line">&#125; DEVICE_CONTEXT, *PDEVICE_CONTEXT;</span><br></pre></td></tr></table></figure>

<p>����Win11�ϵĴ洢�豸��������������ʹ�����·���֮һ��</p>
<ol>
<li>WDF + StorPort:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ʹ��StorPort�ӿ�</span></span><br><span class="line">NTSTATUS <span class="title function_">InitializeStorPort</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    STOR_INTERFACE storInterface;</span><br><span class="line">    </span><br><span class="line">    storInterface.Size = <span class="keyword">sizeof</span>(STOR_INTERFACE);</span><br><span class="line">    storInterface.Version = STOR_INTERFACE_VERSION;</span><br><span class="line">    storInterface.Context = DevContext;</span><br><span class="line">    storInterface.InterfaceReference = WdfDeviceInterfaceReferenceNoOp;</span><br><span class="line">    storInterface.InterfaceDereference = WdfDeviceInterfaceDereferenceNoOp;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> StorPortRegisterInterface(DevContext-&gt;Device,</span><br><span class="line">                                   &amp;storInterface);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>WDF + Block Request Interface:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ʹ�ÿ�����ӿ�</span></span><br><span class="line">NTSTATUS <span class="title function_">InitializeBlockInterface</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_IO_QUEUE_CONFIG queueConfig;</span><br><span class="line">    </span><br><span class="line">    WDF_IO_QUEUE_CONFIG_INIT_DEFAULT_QUEUE(</span><br><span class="line">        &amp;queueConfig,</span><br><span class="line">        WdfIoQueueDispatchSequential);</span><br><span class="line">        </span><br><span class="line">    queueConfig.EvtIoRead = RtsPciEvtIoRead;</span><br><span class="line">    queueConfig.EvtIoWrite = RtsPciEvtIoWrite;</span><br><span class="line">    queueConfig.EvtIoDeviceControl = RtsPciEvtIoDeviceControl;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> WdfIoQueueCreate(DevContext-&gt;Device,</span><br><span class="line">                           &amp;queueConfig,</span><br><span class="line">                           WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                           &amp;DevContext-&gt;IoQueue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>�Զ���洢�ӿڣ�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ʵ���Զ���洢�ӿ�</span></span><br><span class="line">NTSTATUS <span class="title function_">InitializeCustomStorage</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// �����豸�ӿ�</span></span><br><span class="line">    status = WdfDeviceCreateDeviceInterface(</span><br><span class="line">        DevContext-&gt;Device,</span><br><span class="line">        &amp;GUID_DEVINTERFACE_DISK,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// �����豸����</span></span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES pnpCaps;</span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES_INIT(&amp;pnpCaps);</span><br><span class="line">    pnpCaps.Removable = WdfTrue;</span><br><span class="line">    WdfDeviceSetPnpCapabilities(DevContext-&gt;Device, &amp;pnpCaps);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ѡ�����ַ���ȡ���ھ�������</p>
<ol>
<li>�����Ҫ��ȫ���ƺ��Զ��� - ʹ���Զ���ӿ�</li>
<li>�����Ҫ��׼�洢���� - ʹ��StorPort</li>
<li>�����Ҫ�򵥵Ŀ��豸���� - ʹ��Block Request Interface</li>
</ol>
<h2 id="User-27"><a href="#User-27" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>StorPortInitialize��WdfDriverCreate�ܼ����𣿣�</p>
<h2 id="AI-claude-3-5-sonnet-27"><a href="#AI-claude-3-5-sonnet-27" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��˵�öԣ�StorPortInitialize �� WdfDriverCreate ȷʵ����ͬʱʹ�ã���Ϊ������������ͬ������ģ�͡���֮ǰ�Ľ�������</p>
<p>����SD Host Controller������Ӧ�ö�ѡһ��</p>
<ol>
<li>��WDF������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT  DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;config, RtsPciEvtDeviceAdd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> WdfDriverCreate(DriverObject,</span><br><span class="line">                          RegistryPath,</span><br><span class="line">                          WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                          &amp;config,</span><br><span class="line">                          WDF_NO_HANDLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>��Storport������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT  DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    HW_INITIALIZATION_DATA hwInitData = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    hwInitData.HwInitializationDataSize = <span class="keyword">sizeof</span>(HW_INITIALIZATION_DATA);</span><br><span class="line">    hwInitData.HwInitialize = RtsPciHwInitialize;</span><br><span class="line">    hwInitData.HwStartIo = RtsPciHwStartIo;</span><br><span class="line">    hwInitData.HwFindAdapter = RtsPciHwFindAdapter;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> StorPortInitialize(DriverObject,</span><br><span class="line">                            RegistryPath,</span><br><span class="line">                            &amp;hwInitData,</span><br><span class="line">                            <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>���Ҫ��Win11��ʵ��SD Host Controller������ʹ��WDF + �Զ���洢�ӿڵķ�����</p>
<h2 id="User-28"><a href="#User-28" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>ʹ��WDF + �Զ���洢�ӿڵķ��������ʵ�ִ洢�ӿ�</p>
<h2 id="AI-claude-3-5-sonnet-28"><a href="#AI-claude-3-5-sonnet-28" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>ʹ��WDFʵ�ִ洢�ӿڵĹؼ����룺</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. �豸�ӿ�GUID</span></span><br><span class="line">DEFINE_GUID(GUID_CUSTOM_STORAGE_INTERFACE,</span><br><span class="line">    <span class="number">0x12345678</span>, <span class="number">0x1234</span>, <span class="number">0x1234</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x56</span>, <span class="number">0x78</span>, <span class="number">0x90</span>, <span class="number">0x12</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. �豸������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_CONTEXT</span> &#123;</span></span><br><span class="line">    WDFDEVICE       Device;</span><br><span class="line">    WDFQUEUE        IoQueue;</span><br><span class="line">    WDFINTERRUPT    Interrupt;</span><br><span class="line">    WDFDMAENABLER   DmaEnabler;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �洢����</span></span><br><span class="line">    DISK_GEOMETRY   DiskGeometry;</span><br><span class="line">    BOOLEAN         MediaPresent;</span><br><span class="line">    ULONG           BlockSize;</span><br><span class="line">    LARGE_INTEGER   DiskSize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ǰ����</span></span><br><span class="line">    WDFREQUEST      CurrentRequest;</span><br><span class="line">    ULONG           CurrentLba;</span><br><span class="line">    ULONG           CurrentLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Ĵ���</span></span><br><span class="line">    PVOID           RegisterBase;</span><br><span class="line">    </span><br><span class="line">&#125; DEVICE_CONTEXT, *PDEVICE_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. �豸����ʱע��ӿ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceAdd</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDRIVER Driver,</span></span><br><span class="line"><span class="params">    _Inout_ PWDFDEVICE_INIT DeviceInit</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES attributes;</span><br><span class="line">    WDFDEVICE device;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����豸</span></span><br><span class="line">    WDF_OBJECT_ATTRIBUTES_INIT_CONTEXT_TYPE(&amp;attributes, DEVICE_CONTEXT);</span><br><span class="line">    status = WdfDeviceCreate(&amp;DeviceInit, &amp;attributes, &amp;device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����豸�ӿ�</span></span><br><span class="line">    status = WdfDeviceCreateDeviceInterface(</span><br><span class="line">        device,</span><br><span class="line">        &amp;GUID_DEVINTERFACE_DISK,  <span class="comment">// ʹ�ñ�׼���̽ӿ�GUID</span></span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ����IO����</span></span><br><span class="line">    WDF_IO_QUEUE_CONFIG queueConfig;</span><br><span class="line">    WDF_IO_QUEUE_CONFIG_INIT_DEFAULT_QUEUE(</span><br><span class="line">        &amp;queueConfig,</span><br><span class="line">        WdfIoQueueDispatchSequential);</span><br><span class="line">        </span><br><span class="line">    queueConfig.EvtIoRead = RtsPciEvtIoRead;</span><br><span class="line">    queueConfig.EvtIoWrite = RtsPciEvtIoWrite;</span><br><span class="line">    queueConfig.EvtIoDeviceControl = RtsPciEvtIoDeviceControl;</span><br><span class="line">    </span><br><span class="line">    status = WdfIoQueueCreate(device,</span><br><span class="line">                             &amp;queueConfig,</span><br><span class="line">                             WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                             &amp;devContext-&gt;IoQueue);</span><br><span class="line">                             </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. ����IO��������</span></span><br><span class="line">VOID <span class="title function_">RtsPciEvtIoDeviceControl</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFQUEUE Queue,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> OutputBufferLength,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> InputBufferLength,</span></span><br><span class="line"><span class="params">    _In_ ULONG IoControlCode</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(WdfIoQueueGetDevice(Queue));</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (IoControlCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_GET_DRIVE_GEOMETRY: &#123;</span><br><span class="line">            PDISK_GEOMETRY geometry;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (OutputBufferLength &lt; <span class="keyword">sizeof</span>(DISK_GEOMETRY)) &#123;</span><br><span class="line">                status = STATUS_BUFFER_TOO_SMALL;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            status = WdfRequestRetrieveOutputBuffer(Request,</span><br><span class="line">                                                  <span class="keyword">sizeof</span>(DISK_GEOMETRY),</span><br><span class="line">                                                  &amp;geometry,</span><br><span class="line">                                                  <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            geometry-&gt;MediaType = RemovableMedia;</span><br><span class="line">            geometry-&gt;TracksPerCylinder = <span class="number">1</span>;</span><br><span class="line">            geometry-&gt;SectorsPerTrack = <span class="number">1</span>;</span><br><span class="line">            geometry-&gt;BytesPerSector = devContext-&gt;BlockSize;</span><br><span class="line">            geometry-&gt;Cylinders.QuadPart = devContext-&gt;DiskSize.QuadPart / </span><br><span class="line">                                         devContext-&gt;BlockSize;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_GET_LENGTH_INFO: &#123;</span><br><span class="line">            PGET_LENGTH_INFORMATION lengthInfo;</span><br><span class="line">            </span><br><span class="line">            status = WdfRequestRetrieveOutputBuffer(Request,</span><br><span class="line">                                                  <span class="keyword">sizeof</span>(GET_LENGTH_INFORMATION),</span><br><span class="line">                                                  &amp;lengthInfo,</span><br><span class="line">                                                  <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            lengthInfo-&gt;Length = devContext-&gt;DiskSize;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_IS_WRITABLE:</span><br><span class="line">            status = STATUS_SUCCESS;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_MEDIA_REMOVAL:</span><br><span class="line">        <span class="keyword">case</span> IOCTL_STORAGE_MEDIA_REMOVAL:</span><br><span class="line">            status = STATUS_SUCCESS;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> IOCTL_STORAGE_GET_DEVICE_NUMBER: &#123;</span><br><span class="line">            PSTORAGE_DEVICE_NUMBER number;</span><br><span class="line">            </span><br><span class="line">            status = WdfRequestRetrieveOutputBuffer(Request,</span><br><span class="line">                                                  <span class="keyword">sizeof</span>(STORAGE_DEVICE_NUMBER),</span><br><span class="line">                                                  &amp;number,</span><br><span class="line">                                                  <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            number-&gt;DeviceType = FILE_DEVICE_DISK;</span><br><span class="line">            number-&gt;DeviceNumber = <span class="number">0</span>;</span><br><span class="line">            number-&gt;PartitionNumber = (ULONG)<span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            status = STATUS_INVALID_DEVICE_REQUEST;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    WdfRequestComplete(Request, status);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. ����������</span></span><br><span class="line">VOID <span class="title function_">RtsPciEvtIoRead</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFQUEUE Queue,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> Length</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(WdfIoQueueGetDevice(Queue));</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_REQUEST_PARAMETERS params;</span><br><span class="line">    LARGE_INTEGER offset;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡ�������</span></span><br><span class="line">    WDF_REQUEST_PARAMETERS_INIT(&amp;params);</span><br><span class="line">    WdfRequestGetParameters(Request, &amp;params);</span><br><span class="line">    offset.QuadPart = params.Parameters.Read.DeviceOffset;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������</span></span><br><span class="line">    <span class="keyword">if</span> ((offset.QuadPart % devContext-&gt;BlockSize) != <span class="number">0</span> ||</span><br><span class="line">        (Length % devContext-&gt;BlockSize) != <span class="number">0</span>) &#123;</span><br><span class="line">        WdfRequestComplete(Request, STATUS_INVALID_PARAMETER);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">    status = RtsPciSetupDmaForRequest(devContext, Request);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        WdfRequestComplete(Request, status);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����������Ϣ</span></span><br><span class="line">    devContext-&gt;CurrentRequest = Request;</span><br><span class="line">    devContext-&gt;CurrentLba = (ULONG)(offset.QuadPart / devContext-&gt;BlockSize);</span><br><span class="line">    devContext-&gt;CurrentLength = (ULONG)Length;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����SD������</span></span><br><span class="line">    status = RtsPciSendReadCommand(devContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        WdfRequestComplete(Request, status);</span><br><span class="line">        devContext-&gt;CurrentRequest = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. �ж���ɴ���</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciEvtInterruptIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ ULONG MessageID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(</span><br><span class="line">        WdfInterruptGetDevice(Interrupt));</span><br><span class="line">    ULONG intStatus;</span><br><span class="line">    </span><br><span class="line">    intStatus = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + INT_STATUS_OFFSET);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; XFER_COMPLETE) &#123;</span><br><span class="line">        <span class="keyword">if</span> (devContext-&gt;CurrentRequest) &#123;</span><br><span class="line">            WdfRequestComplete(devContext-&gt;CurrentRequest, STATUS_SUCCESS);</span><br><span class="line">            devContext-&gt;CurrentRequest = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ��㣺</p>
<ol>
<li>�ӿ�ע�᣺</li>
</ol>
<ul>
<li>ʹ�ñ�׼���̽ӿ�GUID</li>
<li>ʵ�ֱ�Ҫ��IOCTL</li>
<li>������д����</li>
</ul>
<ol start="2">
<li>��������</li>
</ol>
<ul>
<li>������֤</li>
<li>DMA����</li>
<li>�����</li>
</ul>
<ol start="3">
<li>�����Ż���</li>
</ol>
<ul>
<li>DMA����</li>
<li>�������</li>
<li>�жϴ���</li>
</ul>
<ol start="4">
<li>�ɿ��ԣ�</li>
</ol>
<ul>
<li>������</li>
<li>״̬ͬ��</li>
<li>��ʱ����</li>
</ul>
<ol start="5">
<li>����֧�֣�</li>
</ol>
<ul>
<li>����֧��</li>
<li>���ƶ�����</li>
<li>�豸����</li>
</ul>
<p>����ʵ�ַ�ʽ������SD����Windows����Ϊ��׼�����豸ʹ�á�</p>
<h2 id="User-29"><a href="#User-29" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>SD�����������̷������ͨ�����ϴ洢�ӿ��ϱ���OS�ģ�</p>
<h2 id="AI-claude-3-5-sonnet-29"><a href="#AI-claude-3-5-sonnet-29" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>SD�����������̷�ͨ�����¹ؼ��ӿ��ϱ���OS��</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. �����ϱ� - ͨ��IOCTL_DISK_GET_DRIVE_GEOMETRY</span></span><br><span class="line">VOID <span class="title function_">RtsPciEvtIoDeviceControl</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFQUEUE Queue,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> OutputBufferLength,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> InputBufferLength,</span></span><br><span class="line"><span class="params">    _In_ ULONG IoControlCode</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(WdfIoQueueGetDevice(Queue));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (IoControlCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_GET_DRIVE_GEOMETRY: &#123;</span><br><span class="line">            PDISK_GEOMETRY geometry;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ��ȡCSD��Ϣ�е�����</span></span><br><span class="line">            ULONGLONG totalSectors = devContext-&gt;DiskSize.QuadPart / <span class="number">512</span>;</span><br><span class="line">            </span><br><span class="line">            geometry-&gt;MediaType = RemovableMedia;</span><br><span class="line">            geometry-&gt;TracksPerCylinder = <span class="number">255</span>;  <span class="comment">// ��ͳCHS�ṹ</span></span><br><span class="line">            geometry-&gt;SectorsPerTrack = <span class="number">63</span>;</span><br><span class="line">            geometry-&gt;BytesPerSector = <span class="number">512</span>;     <span class="comment">// ��׼������С</span></span><br><span class="line">            geometry-&gt;Cylinders.QuadPart = totalSectors / </span><br><span class="line">                (geometry-&gt;TracksPerCylinder * geometry-&gt;SectorsPerTrack);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ��׼ȷ����������</span></span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_GET_LENGTH_INFO: &#123;</span><br><span class="line">            PGET_LENGTH_INFORMATION lengthInfo;</span><br><span class="line">            </span><br><span class="line">            lengthInfo-&gt;Length = devContext-&gt;DiskSize;  <span class="comment">// ʵ�����ֽ���</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ������Ϣ</span></span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_GET_PARTITION_INFO_EX: &#123;</span><br><span class="line">            PPARTITION_INFORMATION_EX partInfo;</span><br><span class="line">            </span><br><span class="line">            partInfo-&gt;PartitionStyle = PARTITION_STYLE_MBR;</span><br><span class="line">            partInfo-&gt;StartingOffset.QuadPart = <span class="number">0</span>;</span><br><span class="line">            partInfo-&gt;PartitionLength = devContext-&gt;DiskSize;</span><br><span class="line">            partInfo-&gt;PartitionNumber = <span class="number">0</span>;</span><br><span class="line">            partInfo-&gt;RewritePartition = TRUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. �豸�ӿ�ע�� - ϵͳ�ݴ˷����̷�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceAdd</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDRIVER Driver,</span></span><br><span class="line"><span class="params">    _Inout_ PWDFDEVICE_INIT DeviceInit</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ע��Ϊ�����豸</span></span><br><span class="line">    status = WdfDeviceCreateDeviceInterface(</span><br><span class="line">        device,</span><br><span class="line">        &amp;GUID_DEVINTERFACE_DISK,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// �����豸����</span></span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES pnpCaps;</span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES_INIT(&amp;pnpCaps);</span><br><span class="line">    pnpCaps.Removable = WdfTrue;          <span class="comment">// ���ƶ��豸</span></span><br><span class="line">    pnpCaps.EjectSupported = WdfTrue;     <span class="comment">// ֧�ֵ���</span></span><br><span class="line">    pnpCaps.SurpriseRemovalOK = WdfTrue;  <span class="comment">// ֧���Ȳ��</span></span><br><span class="line">    WdfDeviceSetPnpCapabilities(device, &amp;pnpCaps);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����豸����</span></span><br><span class="line">    STORAGE_DEVICE_DESCRIPTOR deviceDesc = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    deviceDesc.Version = <span class="keyword">sizeof</span>(STORAGE_DEVICE_DESCRIPTOR);</span><br><span class="line">    deviceDesc.Size = <span class="keyword">sizeof</span>(STORAGE_DEVICE_DESCRIPTOR);</span><br><span class="line">    deviceDesc.DeviceType = FILE_DEVICE_DISK;</span><br><span class="line">    deviceDesc.RemovableMedia = TRUE;</span><br><span class="line">    deviceDesc.BusType = BusTypeSD;</span><br><span class="line">    </span><br><span class="line">    status = WdfDeviceSetDeviceDescriptor(device, &amp;deviceDesc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. ��ʼ��ʱ��ȡSD������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeCardCapacity</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    SD_COMMAND cmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����CMD9��ȡCSD</span></span><br><span class="line">    cmd.CommandCode = <span class="number">9</span>;  <span class="comment">// SEND_CSD</span></span><br><span class="line">    cmd.Argument = DevContext-&gt;CardRCA &lt;&lt; <span class="number">16</span>;</span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_TYPE_R2;</span><br><span class="line">    </span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����CSD��ȡ����</span></span><br><span class="line">    <span class="keyword">if</span> (DevContext-&gt;HighCapacity) &#123;</span><br><span class="line">        <span class="comment">// SDHC/SDXC�� (CSD Version 2.0)</span></span><br><span class="line">        ULONG cSize = ((cmd.Response[<span class="number">1</span>] &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFFFF</span>) |</span><br><span class="line">                     ((cmd.Response[<span class="number">2</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">16</span>);</span><br><span class="line">        DevContext-&gt;DiskSize.QuadPart = ((ULONGLONG)(cSize + <span class="number">1</span>)) * <span class="number">512</span> * <span class="number">1024</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ��׼SD�� (CSD Version 1.0)</span></span><br><span class="line">        ULONG cSize = ((cmd.Response[<span class="number">1</span>] &gt;&gt; <span class="number">30</span>) &amp; <span class="number">0x3</span>) |</span><br><span class="line">                     ((cmd.Response[<span class="number">2</span>] &amp; <span class="number">0x3FF</span>) &lt;&lt; <span class="number">2</span>);</span><br><span class="line">        ULONG cSizeMult = (cmd.Response[<span class="number">1</span>] &gt;&gt; <span class="number">7</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">        ULONG readBlLen = cmd.Response[<span class="number">1</span>] &amp; <span class="number">0xF</span>;</span><br><span class="line">        </span><br><span class="line">        DevContext-&gt;DiskSize.QuadPart = (ULONGLONG)(cSize + <span class="number">1</span>) * </span><br><span class="line">            (<span class="number">1ULL</span> &lt;&lt; (cSizeMult + <span class="number">2</span>)) * </span><br><span class="line">            (<span class="number">1ULL</span> &lt;&lt; readBlLen);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ����̣�</p>
<ol>
<li>����ȷ����</li>
</ol>
<ul>
<li>��ʼ��ʱ��ȡCSD��ȡʵ������</li>
<li>֧��SDHC&#x2F;SDXC��������</li>
<li>�����ֽڶ���</li>
</ul>
<ol start="2">
<li>�豸ע�᣺</li>
</ol>
<ul>
<li>ע���׼���̽ӿ�</li>
<li>�����豸����</li>
<li>�ṩ�豸������</li>
</ul>
<ol start="3">
<li>�����ϱ���</li>
</ol>
<ul>
<li>DISK_GEOMETRY</li>
<li>LENGTH_INFORMATION</li>
<li>PARTITION_INFO</li>
</ul>
<ol start="4">
<li>�̷����䣺</li>
</ol>
<ul>
<li>��Windows�����豸�ӿ��Զ�����</li>
<li>���Ƿ�����</li>
<li>֧���Ȳ��</li>
</ul>
<p>ϵͳ�������̣�</p>
<ol>
<li>����ע����̽ӿ�</li>
<li>PnP��������⵽�豸</li>
<li>��������������</li>
<li>������������ȡ����</li>
<li>�ļ�ϵͳʶ��</li>
<li>�����̷�</li>
</ol>
<h2 id="User-30"><a href="#User-30" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�����������: �忨-&gt;�ж� -&gt;SD����Ϣ�ϱ���OS -&gt; OS</p>
<h2 id="AI-claude-3-5-sonnet-30"><a href="#AI-claude-3-5-sonnet-30" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>������SD�����뵽OSʶ�����̣�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. �жϴ��� - ��⿨����</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciEvtInterruptIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ ULONG MessageID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(</span><br><span class="line">        WdfInterruptGetDevice(Interrupt));</span><br><span class="line">    ULONG intStatus;</span><br><span class="line">    </span><br><span class="line">    intStatus = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + INT_STATUS_OFFSET);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; CARD_INSERT_INT) &#123;</span><br><span class="line">        <span class="comment">// ����ж�״̬</span></span><br><span class="line">        WRITE_REGISTER_ULONG(</span><br><span class="line">            devContext-&gt;RegisterBase + INT_STATUS_OFFSET,</span><br><span class="line">            CARD_INSERT_INT);</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// ����DPC�����忨</span></span><br><span class="line">        WdfInterruptQueueDpcForIsr(Interrupt);</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. DPC�����忨�¼�</span></span><br><span class="line">VOID <span class="title function_">RtsPciEvtInterruptDpc</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ WDFOBJECT Device</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ����</span></span><br><span class="line">    status = RtsPciInitializeCard(devContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ֪ͨPnP������</span></span><br><span class="line">    WdfDeviceSetDeviceState(Device, WdfDeviceStateStarted);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. ��ʼ��SD��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    SD_COMMAND cmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.1 ����CMD0 - GO_IDLE_STATE</span></span><br><span class="line">    cmd.CommandCode = <span class="number">0</span>;</span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_NONE;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.2 ����CMD8 - SEND_IF_COND</span></span><br><span class="line">    cmd.CommandCode = <span class="number">8</span>;</span><br><span class="line">    cmd.Argument = <span class="number">0x1AA</span>;  <span class="comment">// 3.3V�ͼ��ģʽ</span></span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_R7;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    </span><br><span class="line">    BOOLEAN sdVer2 = NT_SUCCESS(status);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.3 ����ACMD41 - SD_SEND_OP_COND</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// �ȷ���CMD55</span></span><br><span class="line">        cmd.CommandCode = <span class="number">55</span>;</span><br><span class="line">        cmd.Argument = <span class="number">0</span>;</span><br><span class="line">        cmd.ResponseType = SD_RESPONSE_R1;</span><br><span class="line">        status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����ACMD41</span></span><br><span class="line">        cmd.CommandCode = <span class="number">41</span>;</span><br><span class="line">        cmd.Argument = sdVer2 ? <span class="number">0x40FF8000</span> : <span class="number">0x00FF8000</span>;</span><br><span class="line">        cmd.ResponseType = SD_RESPONSE_R3;</span><br><span class="line">        status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (cmd.Response[<span class="number">0</span>] &amp; <span class="number">0x80000000</span>) &#123;</span><br><span class="line">            DevContext-&gt;HighCapacity = (cmd.Response[<span class="number">0</span>] &amp; <span class="number">0x40000000</span>) ? TRUE : FALSE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        KeStallExecutionProcessor(<span class="number">10000</span>);  <span class="comment">// 10ms�ӳ�</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.4 ����CMD2 - ALL_SEND_CID</span></span><br><span class="line">    cmd.CommandCode = <span class="number">2</span>;</span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_R2;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����CID��Ϣ</span></span><br><span class="line">    RtlCopyMemory(DevContext-&gt;CardCID, cmd.Response, <span class="number">16</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.5 ����CMD3 - SEND_RELATIVE_ADDR</span></span><br><span class="line">    cmd.CommandCode = <span class="number">3</span>;</span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_R6;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;CardRCA = cmd.Response[<span class="number">0</span>] &gt;&gt; <span class="number">16</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.6 ����CMD9 - SEND_CSD</span></span><br><span class="line">    cmd.CommandCode = <span class="number">9</span>;</span><br><span class="line">    cmd.Argument = DevContext-&gt;CardRCA &lt;&lt; <span class="number">16</span>;</span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_R2;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����CSD��ȡ����</span></span><br><span class="line">    <span class="keyword">if</span> (DevContext-&gt;HighCapacity) &#123;</span><br><span class="line">        ULONG cSize = ((cmd.Response[<span class="number">1</span>] &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFFFF</span>) |</span><br><span class="line">                     ((cmd.Response[<span class="number">2</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">16</span>);</span><br><span class="line">        DevContext-&gt;DiskSize.QuadPart = ((ULONGLONG)(cSize + <span class="number">1</span>)) * <span class="number">512</span> * <span class="number">1024</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ULONG cSize = ((cmd.Response[<span class="number">1</span>] &gt;&gt; <span class="number">30</span>) &amp; <span class="number">0x3</span>) |</span><br><span class="line">                     ((cmd.Response[<span class="number">2</span>] &amp; <span class="number">0x3FF</span>) &lt;&lt; <span class="number">2</span>);</span><br><span class="line">        ULONG cSizeMult = (cmd.Response[<span class="number">1</span>] &gt;&gt; <span class="number">7</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">        ULONG readBlLen = cmd.Response[<span class="number">1</span>] &amp; <span class="number">0xF</span>;</span><br><span class="line">        </span><br><span class="line">        DevContext-&gt;DiskSize.QuadPart = (ULONGLONG)(cSize + <span class="number">1</span>) * </span><br><span class="line">            (<span class="number">1ULL</span> &lt;&lt; (cSizeMult + <span class="number">2</span>)) * </span><br><span class="line">            (<span class="number">1ULL</span> &lt;&lt; readBlLen);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.7 ����CMD7 - SELECT_CARD</span></span><br><span class="line">    cmd.CommandCode = <span class="number">7</span>;</span><br><span class="line">    cmd.Argument = DevContext-&gt;CardRCA &lt;&lt; <span class="number">16</span>;</span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_R1b;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.8 �������߿���(ACMD6)</span></span><br><span class="line">    cmd.CommandCode = <span class="number">55</span>;</span><br><span class="line">    cmd.Argument = DevContext-&gt;CardRCA &lt;&lt; <span class="number">16</span>;</span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_R1;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    cmd.CommandCode = <span class="number">6</span>;</span><br><span class="line">    cmd.Argument = <span class="number">2</span>;  <span class="comment">// 4-bitģʽ</span></span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_R1;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. �豸��Ϣ�ϱ�</span></span><br><span class="line">VOID <span class="title function_">RtsPciEvtIoDeviceControl</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFQUEUE Queue,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> OutputBufferLength,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> InputBufferLength,</span></span><br><span class="line"><span class="params">    _In_ ULONG IoControlCode</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(WdfIoQueueGetDevice(Queue));</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (IoControlCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> IOCTL_STORAGE_QUERY_PROPERTY: &#123;</span><br><span class="line">            PSTORAGE_PROPERTY_QUERY query;</span><br><span class="line">            </span><br><span class="line">            status = WdfRequestRetrieveInputBuffer(Request,</span><br><span class="line">                <span class="keyword">sizeof</span>(STORAGE_PROPERTY_QUERY),</span><br><span class="line">                &amp;query,</span><br><span class="line">                <span class="literal">NULL</span>);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">switch</span> (query-&gt;PropertyId) &#123;</span><br><span class="line">                <span class="keyword">case</span> StorageDeviceProperty: &#123;</span><br><span class="line">                    PSTORAGE_DEVICE_DESCRIPTOR desc;</span><br><span class="line">                    </span><br><span class="line">                    status = WdfRequestRetrieveOutputBuffer(Request,</span><br><span class="line">                        <span class="keyword">sizeof</span>(STORAGE_DEVICE_DESCRIPTOR),</span><br><span class="line">                        &amp;desc,</span><br><span class="line">                        <span class="literal">NULL</span>);</span><br><span class="line">                        </span><br><span class="line">                    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                    desc-&gt;Version = <span class="keyword">sizeof</span>(STORAGE_DEVICE_DESCRIPTOR);</span><br><span class="line">                    desc-&gt;Size = <span class="keyword">sizeof</span>(STORAGE_DEVICE_DESCRIPTOR);</span><br><span class="line">                    desc-&gt;DeviceType = FILE_DEVICE_DISK;</span><br><span class="line">                    desc-&gt;DeviceTypeModifier = <span class="number">0</span>;</span><br><span class="line">                    desc-&gt;RemovableMedia = TRUE;</span><br><span class="line">                    desc-&gt;BusType = BusTypeSD;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// ��CID�л�ȡ������Ϣ</span></span><br><span class="line">                    RtlCopyMemory(desc-&gt;VendorId, </span><br><span class="line">                                &amp;devContext-&gt;CardCID[<span class="number">0</span>],</span><br><span class="line">                                <span class="number">8</span>);</span><br><span class="line">                    RtlCopyMemory(desc-&gt;ProductId,</span><br><span class="line">                                &amp;devContext-&gt;CardCID[<span class="number">8</span>],</span><br><span class="line">                                <span class="number">16</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">case</span> StorageAdapterProperty: &#123;</span><br><span class="line">                    PSTORAGE_ADAPTER_DESCRIPTOR desc;</span><br><span class="line">                    </span><br><span class="line">                    status = WdfRequestRetrieveOutputBuffer(Request,</span><br><span class="line">                        <span class="keyword">sizeof</span>(STORAGE_ADAPTER_DESCRIPTOR),</span><br><span class="line">                        &amp;desc,</span><br><span class="line">                        <span class="literal">NULL</span>);</span><br><span class="line">                        </span><br><span class="line">                    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                    desc-&gt;MaximumTransferLength = PAGE_SIZE * <span class="number">32</span>;</span><br><span class="line">                    desc-&gt;MaximumPhysicalPages = <span class="number">32</span>;</span><br><span class="line">                    desc-&gt;AlignmentMask = <span class="number">0x3</span>;</span><br><span class="line">                    desc-&gt;BusType = BusTypeSD;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_GET_DRIVE_GEOMETRY: &#123;</span><br><span class="line">            PDISK_GEOMETRY geometry;</span><br><span class="line">            </span><br><span class="line">            status = WdfRequestRetrieveOutputBuffer(Request,</span><br><span class="line">                <span class="keyword">sizeof</span>(DISK_GEOMETRY),</span><br><span class="line">                &amp;geometry,</span><br><span class="line">                <span class="literal">NULL</span>);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            geometry-&gt;MediaType = RemovableMedia;</span><br><span class="line">            geometry-&gt;TracksPerCylinder = <span class="number">255</span>;</span><br><span class="line">            geometry-&gt;SectorsPerTrack = <span class="number">63</span>;</span><br><span class="line">            geometry-&gt;BytesPerSector = <span class="number">512</span>;</span><br><span class="line">            geometry-&gt;Cylinders.QuadPart = devContext-&gt;DiskSize.QuadPart /</span><br><span class="line">                (geometry-&gt;TracksPerCylinder * </span><br><span class="line">                 geometry-&gt;SectorsPerTrack * </span><br><span class="line">                 geometry-&gt;BytesPerSector);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    WdfRequestComplete(Request, status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�������̣�</p>
<ol>
<li>Ӳ����⿨���룺</li>
</ol>
<ul>
<li>�жϴ���</li>
<li>����ж�״̬</li>
<li>����DPC����</li>
</ul>
<ol start="2">
<li>��ʼ��SD����</li>
</ol>
<ul>
<li>���ͳ�ʼ����������</li>
<li>��ȡ������(��ѹ��������)</li>
<li>���ù���ģʽ</li>
</ul>
<ol start="3">
<li>�豸��Ϣ�ϱ���</li>
</ol>
<ul>
<li>�豸������</li>
<li>����������</li>
<li>���̼�����Ϣ</li>
</ul>
<ol start="4">
<li>OS�������̣�</li>
</ol>
<ul>
<li>PnP������������豸</li>
<li>������Ӧ����</li>
<li>ʶ���ļ�ϵͳ</li>
<li>�����̷�</li>
</ul>
<ol start="5">
<li>�ؼ����ݣ�</li>
</ol>
<ul>
<li>������Ϣ</li>
<li>������Ϣ</li>
<li>�豸����</li>
<li>�������</li>
</ul>
<p>����OS��������ʶ��ʹ��SD���豸��</p>
<h2 id="User-31"><a href="#User-31" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�忨�ͳ�ʼ����ɺ�OS�ᷢ��RtsPciEvtIoDeviceControlȥ����SD����Ϣ��</p>
<h2 id="AI-claude-3-5-sonnet-31"><a href="#AI-claude-3-5-sonnet-31" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�ǵģ��忨��ʼ����ɺ�OS�ᷢ��һϵ��DeviceControl��������ȡ�豸��Ϣ�����͵������������£�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">RtsPciEvtIoDeviceControl</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFQUEUE Queue,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> OutputBufferLength,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> InputBufferLength,</span></span><br><span class="line"><span class="params">    _In_ ULONG IoControlCode</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(WdfIoQueueGetDevice(Queue));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��¼OS�������е�Log</span></span><br><span class="line">    DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL,</span><br><span class="line">        <span class="string">&quot;RtsPciEvtIoDeviceControl: IoControlCode = 0x%x\n&quot;</span>, IoControlCode);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (IoControlCode) &#123;</span><br><span class="line">        <span class="comment">// 1. ���Ȳ�ѯ�豸������������</span></span><br><span class="line">        <span class="keyword">case</span> IOCTL_STORAGE_QUERY_PROPERTY: &#123;</span><br><span class="line">            PSTORAGE_PROPERTY_QUERY query = <span class="literal">NULL</span>;</span><br><span class="line">            status = WdfRequestRetrieveInputBuffer(Request,</span><br><span class="line">                <span class="keyword">sizeof</span>(STORAGE_PROPERTY_QUERY),</span><br><span class="line">                &amp;query,</span><br><span class="line">                <span class="literal">NULL</span>);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">switch</span> (query-&gt;PropertyId) &#123;</span><br><span class="line">                <span class="keyword">case</span> StorageDeviceProperty:</span><br><span class="line">                    <span class="comment">// OS��Ҫ֪������ʲô���͵��豸</span></span><br><span class="line">                    DbgPrint(<span class="string">&quot;OS Query: StorageDeviceProperty\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> StorageAdapterProperty:</span><br><span class="line">                    <span class="comment">// OS��Ҫ֪����������</span></span><br><span class="line">                    DbgPrint(<span class="string">&quot;OS Query: StorageAdapterProperty\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. Ȼ���ȡ�豸������Ϣ</span></span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_GET_DRIVE_GEOMETRY: &#123;</span><br><span class="line">            DbgPrint(<span class="string">&quot;OS Query: DISK_GET_DRIVE_GEOMETRY\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. ��ȡ������Ϣ</span></span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_GET_PARTITION_INFO: &#123;</span><br><span class="line">            DbgPrint(<span class="string">&quot;OS Query: DISK_GET_PARTITION_INFO\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. ������״̬</span></span><br><span class="line">        <span class="keyword">case</span> IOCTL_STORAGE_CHECK_VERIFY: &#123;</span><br><span class="line">            DbgPrint(<span class="string">&quot;OS Query: STORAGE_CHECK_VERIFY\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. ��ȡ�豸��</span></span><br><span class="line">        <span class="keyword">case</span> IOCTL_STORAGE_GET_DEVICE_NUMBER: &#123;</span><br><span class="line">            DbgPrint(<span class="string">&quot;OS Query: STORAGE_GET_DEVICE_NUMBER\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 6. ��ȡ��������</span></span><br><span class="line">        <span class="keyword">case</span> IOCTL_STORAGE_GET_MEDIA_TYPES: &#123;</span><br><span class="line">            DbgPrint(<span class="string">&quot;OS Query: STORAGE_GET_MEDIA_TYPES\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 7. ��ȡ������Ϣ</span></span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_GET_LENGTH_INFO: &#123;</span><br><span class="line">            DbgPrint(<span class="string">&quot;OS Query: DISK_GET_LENGTH_INFO\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ʵ�ʵ�OS��ѯ���д����ǣ�</p>
<ol>
<li>�豸��ʼ����ɺ�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">OS -&gt; Driver: IOCTL_STORAGE_QUERY_PROPERTY (StorageDeviceProperty)</span><br><span class="line">OS -&gt; Driver: IOCTL_STORAGE_QUERY_PROPERTY (StorageAdapterProperty)</span><br><span class="line">OS -&gt; Driver: IOCTL_DISK_GET_DRIVE_GEOMETRY</span><br><span class="line">OS -&gt; Driver: IOCTL_DISK_GET_PARTITION_INFO</span><br><span class="line">OS -&gt; Driver: IOCTL_STORAGE_CHECK_VERIFY</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>����ʶ��׶Σ�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OS -&gt; Driver: IOCTL_DISK_GET_DRIVE_GEOMETRY</span><br><span class="line">OS -&gt; Driver: IOCTL_DISK_GET_LENGTH_INFO</span><br><span class="line">OS -&gt; Driver: IOCTL_DISK_GET_PARTITION_INFO</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>�ļ�ϵͳ���ؽ׶Σ�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OS -&gt; Driver: IOCTL_STORAGE_CHECK_VERIFY</span><br><span class="line">OS -&gt; Driver: IOCTL_DISK_IS_WRITABLE</span><br><span class="line">OS -&gt; Driver: IOCTL_DISK_GET_PARTITION_INFO</span><br></pre></td></tr></table></figure>

<p>������Ҫ��ȷ��Ӧ��Щ����OS��������豸�����ú͹��ء������������м������������۲�ʵ�ʵ��������С�</p>
<h2 id="User-32"><a href="#User-32" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����֮ǰ�ĶԻ���дһ���ĵ�����ϸ������WDFʵ�ֳ����Զ����SD Host Controller����,, �Զ�������ϸ�������������ʵ�֣�����Host��Card�����ã�����ϵͳ��������ν�����SD������Դ������I&#x2F;O����SD�������ϵͳ��ʾΪ�洢�豸���ȵ�</p>
<h2 id="AI-claude-3-5-sonnet-32"><a href="#AI-claude-3-5-sonnet-32" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�һ���½�дһ����ϸ���ĵ����������ʹ��WDFʵ���Զ���SD Host Controller������</p>
<h1 id="WDF-SD-Host-Controller����ʵ��ָ��"><a href="#WDF-SD-Host-Controller����ʵ��ָ��" class="headerlink" title="WDF SD Host Controller����ʵ��ָ��"></a>WDF SD Host Controller����ʵ��ָ��</h1><h2 id="1-����ܹ�"><a href="#1-����ܹ�" class="headerlink" title="1. ����ܹ�"></a>1. ����ܹ�</h2><h3 id="1-1-�������"><a href="#1-1-�������" class="headerlink" title="1.1 �������"></a>1.1 �������</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Ӧ�ò�</span><br><span class="line">  ��</span><br><span class="line">�ļ�ϵͳ</span><br><span class="line">  ��</span><br><span class="line">��������</span><br><span class="line">  ��</span><br><span class="line">�洢������</span><br><span class="line">  ��</span><br><span class="line">WDF SD Host���� (�����ص�)</span><br><span class="line">  ��</span><br><span class="line">PCIe����</span><br><span class="line">  ��</span><br><span class="line">Ӳ��(SD Host Controller)</span><br></pre></td></tr></table></figure>

<h3 id="1-2-��Ҫ����g��"><a href="#1-2-��Ҫ����g��" class="headerlink" title="1.2 ��Ҫ����ģ��"></a>1.2 ��Ҫ����ģ��</h3><ul>
<li>�豸��ʼ��������</li>
<li>SD�����</li>
<li>DMA�������</li>
<li>�жϴ���</li>
<li>��Դ����</li>
<li>�洢�ӿ�ʵ��</li>
</ul>
<h2 id="2-������ܳ�ʼ��"><a href="#2-������ܳ�ʼ��" class="headerlink" title="2. ������ܳ�ʼ��"></a>2. ������ܳ�ʼ��</h2><h3 id="2-1-�������"><a href="#2-1-�������" class="headerlink" title="2.1 �������"></a>2.1 �������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT  DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;config, RtsPciEvtDeviceAdd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> WdfDriverCreate(DriverObject,</span><br><span class="line">                          RegistryPath,</span><br><span class="line">                          WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                          &amp;config,</span><br><span class="line">                          WDF_NO_HANDLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-�豸������"><a href="#2-2-�豸������" class="headerlink" title="2.2 �豸������"></a>2.2 �豸������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_CONTEXT</span> &#123;</span></span><br><span class="line">    WDFDEVICE       Device;</span><br><span class="line">    WDFQUEUE        IoQueue;</span><br><span class="line">    WDFINTERRUPT    Interrupt;</span><br><span class="line">    WDFDMAENABLER   DmaEnabler;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Ĵ�����Դ</span></span><br><span class="line">    PVOID           RegisterBase;</span><br><span class="line">    ULONG           RegisterLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SD��״̬</span></span><br><span class="line">    BOOLEAN         CardPresent;</span><br><span class="line">    BOOLEAN         HighCapacity;</span><br><span class="line">    ULONG           CardRCA;</span><br><span class="line">    ULONG           BlockSize;</span><br><span class="line">    LARGE_INTEGER   DiskSize;</span><br><span class="line">    UCHAR           CardCID[<span class="number">16</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����״̬</span></span><br><span class="line">    WDFREQUEST      CurrentRequest;</span><br><span class="line">    ULONG           CurrentLba;</span><br><span class="line">    ULONG           CurrentLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ״̬</span></span><br><span class="line">    DEVICE_POWER_STATE PowerState;</span><br><span class="line">&#125; DEVICE_CONTEXT, *PDEVICE_CONTEXT;</span><br></pre></td></tr></table></figure>

<h2 id="3-Host-Controller��ʼ��"><a href="#3-Host-Controller��ʼ��" class="headerlink" title="3. Host Controller��ʼ��"></a>3. Host Controller��ʼ��</h2><h3 id="3-1-Ӳ����Դ��ȡ"><a href="#3-1-Ӳ����Դ��ȡ" class="headerlink" title="3.1 Ӳ����Դ��ȡ"></a>3.1 Ӳ����Դ��ȡ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciEvtPrepareHardware</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceList,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceListTranslated</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ��ȡ�Ĵ�����Դ</span></span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">    <span class="comment">// ��ʼ���ж�</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-Host-Controller����"><a href="#3-2-Host-Controller����" class="headerlink" title="3.2 Host Controller����"></a>3.2 Host Controller����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeController</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ��λ������</span></span><br><span class="line">    <span class="comment">// ����ʱ��</span></span><br><span class="line">    <span class="comment">// ���õ�ѹ</span></span><br><span class="line">    <span class="comment">// ʹ���ж�</span></span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-SD����ʼ��������"><a href="#4-SD����ʼ��������" class="headerlink" title="4. SD����ʼ��������"></a>4. SD����ʼ��������</h2><h3 id="4-1-��������ʼ��"><a href="#4-1-��������ʼ��" class="headerlink" title="4.1 ��������ʼ��"></a>4.1 ��������ʼ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// CMD0 - ��λ</span></span><br><span class="line">    <span class="comment">// CMD8 - ��ѹ���</span></span><br><span class="line">    <span class="comment">// ACMD41 - ��ʼ��</span></span><br><span class="line">    <span class="comment">// CMD2 - ��ȡCID</span></span><br><span class="line">    <span class="comment">// CMD3 - ��ȡRCA</span></span><br><span class="line">    <span class="comment">// CMD9 - ��ȡCSD</span></span><br><span class="line">    <span class="comment">// CMD7 - ѡ��</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-������"><a href="#4-2-������" class="headerlink" title="4.2 ������"></a>4.2 ������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciConfigureCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// �������߿���</span></span><br><span class="line">    <span class="comment">// ����ʱ��Ƶ��</span></span><br><span class="line">    <span class="comment">// ���ÿ��С</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-�洢�ӿ�ʵ��"><a href="#5-�洢�ӿ�ʵ��" class="headerlink" title="5. �洢�ӿ�ʵ��"></a>5. �洢�ӿ�ʵ��</h2><h3 id="5-1-�豸�ӿ�ע��"><a href="#5-1-�豸�ӿ�ע��" class="headerlink" title="5.1 �豸�ӿ�ע��"></a>5.1 �豸�ӿ�ע��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciRegisterStorageInterface</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ע��Ϊ�����豸</span></span><br><span class="line">    <span class="comment">// �����豸����</span></span><br><span class="line">    <span class="comment">// ���ô������</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-������"><a href="#5-2-������" class="headerlink" title="5.2 ������"></a>5.2 ������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">RtsPciEvtIoDeviceControl</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFQUEUE Queue,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ ULONG IoControlCode</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// �����豸��ѯ</span></span><br><span class="line">    <span class="comment">// ����������Ϣ</span></span><br><span class="line">    <span class="comment">// ����������Ϣ</span></span><br><span class="line">    <span class="comment">// ����������ѯ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-I-O����"><a href="#6-I-O����" class="headerlink" title="6. I&#x2F;O����"></a>6. I&#x2F;O����</h2><h3 id="6-1-��д����"><a href="#6-1-��д����" class="headerlink" title="6.1 ��д����"></a>6.1 ��д����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">VOID RtsPciEvtIoRead/Write(</span><br><span class="line">    _In_ WDFQUEUE Queue,</span><br><span class="line">    _In_ WDFREQUEST Request,</span><br><span class="line">    _In_ <span class="type">size_t</span> Length</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ������֤</span></span><br><span class="line">    <span class="comment">// DMA����</span></span><br><span class="line">    <span class="comment">// �����</span></span><br><span class="line">    <span class="comment">// ���ݴ���</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-DMA����"><a href="#6-2-DMA����" class="headerlink" title="6.2 DMA����"></a>6.2 DMA����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciSetupDmaForRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ����DMA������</span></span><br><span class="line">    <span class="comment">// ���ô������</span></span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-�жϴ���"><a href="#7-�жϴ���" class="headerlink" title="7. �жϴ���"></a>7. �жϴ���</h2><h3 id="7-1-ISR"><a href="#7-1-ISR" class="headerlink" title="7.1 ISR"></a>7.1 ISR</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN <span class="title function_">RtsPciEvtInterruptIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ ULONG MessageID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ��ȡ�ж�״̬</span></span><br><span class="line">    <span class="comment">// ����������ж�</span></span><br><span class="line">    <span class="comment">// ������������ж�</span></span><br><span class="line">    <span class="comment">// ���������ж�</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-DPC"><a href="#7-2-DPC" class="headerlink" title="7.2 DPC"></a>7.2 DPC</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">RtsPciEvtInterruptDpc</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ WDFOBJECT Device</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// �������</span></span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">    <span class="comment">// ������һ������</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-��Դ����"><a href="#8-��Դ����" class="headerlink" title="8. ��Դ����"></a>8. ��Դ����</h2><h3 id="8-1-��Դ״̬ת��"><a href="#8-1-��Դ״̬ת��" class="headerlink" title="8.1 ��Դ״̬ת��"></a>8.1 ��Դ״̬ת��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS RtsPciEvtDeviceD0Entry/Exit(</span><br><span class="line">    _In_ WDFDEVICE Device,</span><br><span class="line">    _In_ WDF_POWER_DEVICE_STATE State</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Host Controller��Դ����</span></span><br><span class="line">    <span class="comment">// SD����Դ����</span></span><br><span class="line">    <span class="comment">// ʱ�ӹ���</span></span><br><span class="line">    <span class="comment">// ״̬�ָ�</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-���й���"><a href="#8-2-���й���" class="headerlink" title="8.2 ���й���"></a>8.2 ���й���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciConfigureIdleSettings</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ���ÿ��г�ʱ</span></span><br><span class="line">    <span class="comment">// ���û���Դ</span></span><br><span class="line">    <span class="comment">// ���õ͹���״̬</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="9-������"><a href="#9-������" class="headerlink" title="9. ������"></a>9. ������</h2><h3 id="9-1-�������"><a href="#9-1-�������" class="headerlink" title="9.1 �������"></a>9.1 �������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciHandleCommandError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ ULONG ErrorStatus</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ������������</span></span><br><span class="line">    <span class="comment">// ���Բ���</span></span><br><span class="line">    <span class="comment">// ����ָ�</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-2-�������"><a href="#9-2-�������" class="headerlink" title="9.2 �������"></a>9.2 �������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciHandleTransferError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ ULONG ErrorStatus</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// DMA������</span></span><br><span class="line">    <span class="comment">// ���ݴ���ָ�</span></span><br><span class="line">    <span class="comment">// ���´���</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="10-����֧��"><a href="#10-����֧��" class="headerlink" title="10. ����֧��"></a>10. ����֧��</h2><h3 id="10-1-WPP����"><a href="#10-1-WPP����" class="headerlink" title="10.1 WPP����"></a>10.1 WPP����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ������ٱ�־</span></span><br><span class="line"><span class="comment">// ʵ�ָ��ٺ���</span></span><br><span class="line"><span class="comment">// ���ø��ټ���</span></span><br></pre></td></tr></table></figure>

<h3 id="10-2-���ܼ�����"><a href="#10-2-���ܼ�����" class="headerlink" title="10.2 ���ܼ�����"></a>10.2 ���ܼ�����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��������ͳ��</span></span><br><span class="line"><span class="comment">// ����ͳ��</span></span><br><span class="line"><span class="comment">// ״̬���</span></span><br></pre></td></tr></table></figure>

<h2 id="11-�ܽ�"><a href="#11-�ܽ�" class="headerlink" title="11. �ܽ�"></a>11. �ܽ�</h2><p>ʵ��һ��������SD Host Controller������Ҫ���ǣ�</p>
<ol>
<li>��׼Э����ѭ</li>
<li>�����Ż�</li>
<li>�ɿ��Ա�֤</li>
<li>��Դ����</li>
<li>������</li>
<li>����֧��</li>
</ol>
<p>���鰴�����ϼܹ���ʵ�֣�ȷ��ÿ��ģ�����ȷ�ԺͿɿ��ԡ�</p>
<p>[�������ҿ�����ϸչ���κ�һ������Ȥ�Ĳ���]</p>
<h2 id="User-33"><a href="#User-33" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>��ϸչ��ÿһ������</p>
<h2 id="AI-claude-3-5-sonnet-33"><a href="#AI-claude-3-5-sonnet-33" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õ�,�ҽ��ֶ��������ϸչ������ĵ����ȴӵ�һ���ֿ�ʼ:</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-1"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-1" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 1"></a>WDF SD Host Controller����ʵ����� - Part 1</h1><h2 id="1-����ܹ����"><a href="#1-����ܹ����" class="headerlink" title="1. ����ܹ����"></a>1. ����ܹ����</h2><h3 id="1-1-����������"><a href="#1-1-����������" class="headerlink" title="1.1 ����������"></a>1.1 ����������</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">�û�Ӧ�ó���</span><br><span class="line">  ��</span><br><span class="line">�ļ�ϵͳ(��NTFS/FAT32)</span><br><span class="line">  - �ļ�����ת��Ϊ�����</span><br><span class="line">  - �����ļ�ϵͳ�ṹ</span><br><span class="line">  ��</span><br><span class="line">��������(PartMgr.sys)</span><br><span class="line">  - ����������</span><br><span class="line">  - ����������Ϣ</span><br><span class="line">  ��</span><br><span class="line">�洢������(Disk.sys)</span><br><span class="line">  - ���豸����</span><br><span class="line">  - IO������й���</span><br><span class="line">  ��</span><br><span class="line">WDF SD Host����(�Զ�������)</span><br><span class="line">  - SDЭ��ʵ��</span><br><span class="line">  - DMA����</span><br><span class="line">  - �жϴ���</span><br><span class="line">  - ��Դ����</span><br><span class="line">  ��</span><br><span class="line">PCIe��������</span><br><span class="line">  - ��Դ����</span><br><span class="line">  - ���߲���</span><br><span class="line">  ��</span><br><span class="line">Ӳ��(SD Host Controller)</span><br><span class="line">  - �Ĵ�������</span><br><span class="line">  - ��������</span><br></pre></td></tr></table></figure>

<h3 id="1-2-�ؼ����ݽu"><a href="#1-2-�ؼ����ݽu" class="headerlink" title="1.2 �ؼ����ݽṹ"></a>1.2 �ؼ����ݽṹ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ����ȫ������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DRIVER_GLOBALS</span> &#123;</span></span><br><span class="line">    ULONG               DebugLevel;</span><br><span class="line">    ULONG               DebugFlags;</span><br><span class="line">    UNICODE_STRING      RegistryPath;</span><br><span class="line">    WDF_DRIVER_GLOBALS  WdfDriverGlobals;</span><br><span class="line">&#125; DRIVER_GLOBALS, *PDRIVER_GLOBALS;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �豸��չ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_CONTEXT</span> &#123;</span></span><br><span class="line">    <span class="comment">// WDF����</span></span><br><span class="line">    WDFDEVICE           Device;</span><br><span class="line">    WDFQUEUE            IoQueue;</span><br><span class="line">    WDFINTERRUPT        Interrupt;</span><br><span class="line">    WDFDMAENABLER       DmaEnabler;</span><br><span class="line">    WDFSPINLOCK        Lock;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Ӳ����Դ</span></span><br><span class="line">    PHYSICAL_ADDRESS    RegisterBasePA;    <span class="comment">// ������ַ</span></span><br><span class="line">    PVOID              RegisterBase;       <span class="comment">// �����ַ</span></span><br><span class="line">    ULONG              RegisterLength;</span><br><span class="line">    ULONG              InterruptVector;</span><br><span class="line">    KIRQL              InterruptIrql;</span><br><span class="line">    KINTERRUPT_MODE    InterruptMode;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SD����Ϣ</span></span><br><span class="line">    BOOLEAN            CardPresent;</span><br><span class="line">    BOOLEAN            HighCapacity;</span><br><span class="line">    ULONG             CardRCA;</span><br><span class="line">    ULONG             BlockSize;</span><br><span class="line">    LARGE_INTEGER     DiskSize;</span><br><span class="line">    UCHAR             CardCID[<span class="number">16</span>];</span><br><span class="line">    UCHAR             CardCSD[<span class="number">16</span>];</span><br><span class="line">    SD_CARD_TYPE      CardType;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����״̬</span></span><br><span class="line">    WDFREQUEST         CurrentRequest;</span><br><span class="line">    ULONG              CurrentLba;</span><br><span class="line">    ULONG              CurrentLength;</span><br><span class="line">    DMA_TRANSFER_INFO  DmaInfo;</span><br><span class="line">    BOOLEAN            TransferActive;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ͳ��</span></span><br><span class="line">    LARGE_INTEGER      TotalBytesTransferred;</span><br><span class="line">    ULONG              TotalRequests;</span><br><span class="line">    ULONG              ErrorCount;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ����</span></span><br><span class="line">    DEVICE_POWER_STATE PowerState;</span><br><span class="line">    BOOLEAN           WakeEnabled;</span><br><span class="line">    ULONG             IdleTimeout;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������Ϣ</span></span><br><span class="line">    ULONG             MaxBlockCount;</span><br><span class="line">    ULONG             MaxClockFrequency;</span><br><span class="line">    ULONG             CurrentClock;</span><br><span class="line">    ULONG             CurrentVoltage;</span><br><span class="line">    BOOLEAN           Bus4BitMode;</span><br><span class="line">    BOOLEAN           HighSpeedMode;</span><br><span class="line">    </span><br><span class="line">&#125; DEVICE_CONTEXT, *PDEVICE_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DMA������Ϣ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DMA_TRANSFER_INFO</span> &#123;</span></span><br><span class="line">    PHYSICAL_ADDRESS    PhysicalAddress;</span><br><span class="line">    PVOID              VirtualAddress;</span><br><span class="line">    ULONG              Length;</span><br><span class="line">    BOOLEAN            WriteToDevice;</span><br><span class="line">    PMDL               Mdl;</span><br><span class="line">    STOR_SCATTER_GATHER_LIST SGList;</span><br><span class="line">&#125; DMA_TRANSFER_INFO, *PDMA_TRANSFER_INFO;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SD����ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SD_COMMAND</span> &#123;</span></span><br><span class="line">    UCHAR  Index;</span><br><span class="line">    ULONG  Argument;</span><br><span class="line">    UCHAR  ResponseType;</span><br><span class="line">    ULONG  Response[<span class="number">4</span>];</span><br><span class="line">    BOOLEAN HasData;</span><br><span class="line">    BOOLEAN IsWrite;</span><br><span class="line">    ULONG  BlockCount;</span><br><span class="line">    ULONG  BlockSize;</span><br><span class="line">    ULONG  Timeout;</span><br><span class="line">&#125; SD_COMMAND, *PSD_COMMAND;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-������ʼ������"><a href="#1-3-������ʼ������" class="headerlink" title="1.3 ������ʼ������"></a>1.3 ������ʼ������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT  DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    WDFDRIVER driver;</span><br><span class="line">    PDRIVER_GLOBALS pDriverGlobals;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��������ȫ������</span></span><br><span class="line">    pDriverGlobals = ExAllocatePoolWithTag(NonPagedPool, </span><br><span class="line">                                         <span class="keyword">sizeof</span>(DRIVER_GLOBALS),</span><br><span class="line">                                         <span class="string">&#x27;SDHR&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!pDriverGlobals) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ��WPP����</span></span><br><span class="line">    WPP_INIT_TRACING(DriverObject, RegistryPath);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����WDF����</span></span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;config, RtsPciEvtDeviceAdd);</span><br><span class="line">    config.EvtDriverUnload = RtsPciEvtDriverUnload;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����WDF��������</span></span><br><span class="line">    status = WdfDriverCreate(DriverObject,</span><br><span class="line">                           RegistryPath,</span><br><span class="line">                           WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                           &amp;config,</span><br><span class="line">                           &amp;driver);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����ȫ������</span></span><br><span class="line">    RtlCopyUnicodeString(&amp;pDriverGlobals-&gt;RegistryPath, RegistryPath);</span><br><span class="line">    WdfDriverSetData(driver, pDriverGlobals);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line"></span><br><span class="line">cleanup:</span><br><span class="line">    <span class="keyword">if</span> (pDriverGlobals) &#123;</span><br><span class="line">        ExFreePool(pDriverGlobals);</span><br><span class="line">    &#125;</span><br><span class="line">    WPP_CLEANUP(DriverObject);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-4-�豸���󴴽�"><a href="#1-4-�豸���󴴽�" class="headerlink" title="1.4 �豸���󴴽�"></a>1.4 �豸���󴴽�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceAdd</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_    WDFDRIVER       Driver,</span></span><br><span class="line"><span class="params">    _Inout_ PWDFDEVICE_INIT DeviceInit</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDFDEVICE device;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES attributes;</span><br><span class="line">    WDF_PNPPOWER_EVENT_CALLBACKS pnpPowerCallbacks;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����PnP/Power�ص�</span></span><br><span class="line">    WDF_PNPPOWER_EVENT_CALLBACKS_INIT(&amp;pnpPowerCallbacks);</span><br><span class="line">    pnpPowerCallbacks.EvtDevicePrepareHardware = RtsPciEvtPrepareHardware;</span><br><span class="line">    pnpPowerCallbacks.EvtDeviceReleaseHardware = RtsPciEvtReleaseHardware;</span><br><span class="line">    pnpPowerCallbacks.EvtDeviceD0Entry = RtsPciEvtDeviceD0Entry;</span><br><span class="line">    pnpPowerCallbacks.EvtDeviceD0Exit = RtsPciEvtDeviceD0Exit;</span><br><span class="line">    </span><br><span class="line">    WdfDeviceInitSetPnpPowerEventCallbacks(DeviceInit, &amp;pnpPowerCallbacks);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����豸����</span></span><br><span class="line">    WDF_OBJECT_ATTRIBUTES_INIT_CONTEXT_TYPE(&amp;attributes, DEVICE_CONTEXT);</span><br><span class="line">    </span><br><span class="line">    status = WdfDeviceCreate(&amp;DeviceInit, </span><br><span class="line">                            &amp;attributes,</span><br><span class="line">                            &amp;device);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ȡ�豸������</span></span><br><span class="line">    devContext = GetDeviceContext(device);</span><br><span class="line">    RtlZeroMemory(devContext, <span class="keyword">sizeof</span>(DEVICE_CONTEXT));</span><br><span class="line">    devContext-&gt;Device = device;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �����豸�ӿ�</span></span><br><span class="line">    status = WdfDeviceCreateDeviceInterface(</span><br><span class="line">        device,</span><br><span class="line">        &amp;GUID_DEVINTERFACE_DISK,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����IO����</span></span><br><span class="line">    status = RtsPciCreateIoQueues(devContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ��ʼ��DMA</span></span><br><span class="line">    status = RtsPciInitializeDma(devContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7. �����ж϶���</span></span><br><span class="line">    status = RtsPciCreateInterrupt(devContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[���� - ��һ���ֽ���ϸ����Host Controller��ʼ��������]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-34"><a href="#User-34" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-34"><a href="#AI-claude-3-5-sonnet-34" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-2"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-2" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 2"></a>WDF SD Host Controller����ʵ����� - Part 2</h1><h2 id="2-Host-Controller��ʼ��������"><a href="#2-Host-Controller��ʼ��������" class="headerlink" title="2. Host Controller��ʼ��������"></a>2. Host Controller��ʼ��������</h2><h3 id="2-1-Ӳ����Դ��ȡ"><a href="#2-1-Ӳ����Դ��ȡ" class="headerlink" title="2.1 Ӳ����Դ��ȡ"></a>2.1 Ӳ����Դ��ȡ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciEvtPrepareHardware</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceList,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceListTranslated</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    PCM_PARTIAL_RESOURCE_DESCRIPTOR descriptor;</span><br><span class="line">    ULONG resourceCount;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(Device);</span><br><span class="line">    resourceCount = WdfCmResourceListGetCount(ResourceListTranslated);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��������ȡ��Դ</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; resourceCount; i++) &#123;</span><br><span class="line">        descriptor = WdfCmResourceListGetDescriptor(ResourceListTranslated, i);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (descriptor-&gt;Type) &#123;</span><br><span class="line">            <span class="keyword">case</span> CmResourceTypeMemory:</span><br><span class="line">                <span class="comment">// ӳ��Ĵ����ռ�</span></span><br><span class="line">                devContext-&gt;RegisterBasePA = descriptor-&gt;u.Memory.Start;</span><br><span class="line">                devContext-&gt;RegisterLength = descriptor-&gt;u.Memory.Length;</span><br><span class="line">                </span><br><span class="line">                devContext-&gt;RegisterBase = MmMapIoSpaceEx(</span><br><span class="line">                    devContext-&gt;RegisterBasePA,</span><br><span class="line">                    devContext-&gt;RegisterLength,</span><br><span class="line">                    PAGE_READWRITE | PAGE_NOCACHE);</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">if</span> (!devContext-&gt;RegisterBase) &#123;</span><br><span class="line">                    <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> CmResourceTypeInterrupt:</span><br><span class="line">                <span class="comment">// �����ж���Ϣ</span></span><br><span class="line">                devContext-&gt;InterruptVector = descriptor-&gt;u.Interrupt.Vector;</span><br><span class="line">                devContext-&gt;InterruptIrql = descriptor-&gt;u.Interrupt.Level;</span><br><span class="line">                devContext-&gt;InterruptMode = descriptor-&gt;Flags &amp; </span><br><span class="line">                    CM_RESOURCE_INTERRUPT_LATCHED ? </span><br><span class="line">                    Latched : LevelSensitive;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> CmResourceTypeMemoryLarge:</span><br><span class="line">                <span class="comment">// DMA����������</span></span><br><span class="line">                status = RtsPciConfigureDmaBuffer(devContext, descriptor);</span><br><span class="line">                <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> status;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ��Host Controller</span></span><br><span class="line">    status = RtsPciInitializeController(devContext);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Host-Controller��ʼ��"><a href="#2-2-Host-Controller��ʼ��" class="headerlink" title="2.2 Host Controller��ʼ��"></a>2.2 Host Controller��ʼ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeController</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����λ������</span></span><br><span class="line">    status = RtsPciResetController(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ����������</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CTRL_TIMEOUT,</span><br><span class="line">        DEFAULT_TIMEOUT_VALUE);</span><br><span class="line">        </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CTRL_CLOCK,</span><br><span class="line">        INITIAL_CLOCK_FREQ);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. ����DMA</span></span><br><span class="line">    status = RtsPciConfigureDma(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �����ж�</span></span><br><span class="line">    ULONG intMask = CARD_DETECT_INT | </span><br><span class="line">                    COMMAND_COMPLETE_INT |</span><br><span class="line">                    TRANSFER_COMPLETE_INT |</span><br><span class="line">                    DMA_INT |</span><br><span class="line">                    ERROR_INT;</span><br><span class="line">                    </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CTRL_INT_ENABLE,</span><br><span class="line">        intMask);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 5. ���ó�ʼ��ѹ</span></span><br><span class="line">    status = RtsPciSetVoltage(DevContext, SD_VOLTAGE_3_3V);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ��ʼ�����ܼ�����</span></span><br><span class="line">    KeQuerySystemTime(&amp;DevContext-&gt;LastPerformanceTime);</span><br><span class="line">    DevContext-&gt;TotalBytesTransferred.QuadPart = <span class="number">0</span>;</span><br><span class="line">    DevContext-&gt;TotalRequests = <span class="number">0</span>;</span><br><span class="line">    DevContext-&gt;ErrorCount = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-DMA����"><a href="#2-3-DMA����" class="headerlink" title="2.3 DMA����"></a>2.3 DMA����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciConfigureDma</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DMA_ENABLER_CONFIG dmaConfig;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����DMAʹ����</span></span><br><span class="line">    WDF_DMA_ENABLER_CONFIG_INIT(&amp;dmaConfig,</span><br><span class="line">                               WdfDmaProfileScatterGather,</span><br><span class="line">                               MAX_TRANSFER_LENGTH);</span><br><span class="line">                               </span><br><span class="line">    status = WdfDmaEnablerCreate(DevContext-&gt;Device,</span><br><span class="line">                                &amp;dmaConfig,</span><br><span class="line">                                WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                                &amp;DevContext-&gt;DmaEnabler);</span><br><span class="line">                                </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����DMA������</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_DESC_ADDR,</span><br><span class="line">        DevContext-&gt;DmaDescPhysical.LowPart);</span><br><span class="line">        </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_DESC_ADDR_HIGH,</span><br><span class="line">        DevContext-&gt;DmaDescPhysical.HighPart);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. ����DMA�������</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_BURST_SIZE,</span><br><span class="line">        DMA_BURST_SIZE_32);</span><br><span class="line">        </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_BOUNDARY,</span><br><span class="line">        DMA_BOUNDARY_4K);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-�ж�����"><a href="#2-4-�ж�����" class="headerlink" title="2.4 �ж�����"></a>2.4 �ж�����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciCreateInterrupt</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_INTERRUPT_CONFIG interruptConfig;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����ж϶���</span></span><br><span class="line">    WDF_INTERRUPT_CONFIG_INIT(</span><br><span class="line">        &amp;interruptConfig,</span><br><span class="line">        RtsPciEvtInterruptIsr,</span><br><span class="line">        RtsPciEvtInterruptDpc);</span><br><span class="line">        </span><br><span class="line">    interruptConfig.PassiveHandling = FALSE;</span><br><span class="line">    interruptConfig.InterruptTranslated = TRUE;</span><br><span class="line">    interruptConfig.InterruptRaw = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����ж϶���</span></span><br><span class="line">    status = WdfInterruptCreate(</span><br><span class="line">        DevContext-&gt;Device,</span><br><span class="line">        &amp;interruptConfig,</span><br><span class="line">        WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">        &amp;DevContext-&gt;Interrupt);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����MSI/MSI-X(���֧��)</span></span><br><span class="line">    <span class="keyword">if</span> (DevContext-&gt;MsiSupported) &#123;</span><br><span class="line">        status = RtsPciConfigureMsi(DevContext);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">return</span> status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-��Դ����"><a href="#2-5-��Դ����" class="headerlink" title="2.5 ��Դ����"></a>2.5 ��Դ����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciConfigurePower</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DEVICE_POWER_POLICY_IDLE_SETTINGS idleSettings;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���ÿ�������</span></span><br><span class="line">    WDF_DEVICE_POWER_POLICY_IDLE_SETTINGS_INIT(</span><br><span class="line">        &amp;idleSettings,</span><br><span class="line">        IdleCannotWakeFromS0);</span><br><span class="line">        </span><br><span class="line">    idleSettings.IdleTimeout = DEFAULT_IDLE_TIMEOUT;</span><br><span class="line">    </span><br><span class="line">    status = WdfDeviceAssignS0IdleSettings(</span><br><span class="line">        DevContext-&gt;Device,</span><br><span class="line">        &amp;idleSettings);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���û�������</span></span><br><span class="line">    <span class="keyword">if</span> (DevContext-&gt;WakeSupported) &#123;</span><br><span class="line">        WDF_DEVICE_POWER_POLICY_WAKE_SETTINGS wakeSettings;</span><br><span class="line">        </span><br><span class="line">        WDF_DEVICE_POWER_POLICY_WAKE_SETTINGS_INIT(&amp;wakeSettings);</span><br><span class="line">        </span><br><span class="line">        status = WdfDeviceAssignSxWakeSettings(</span><br><span class="line">            DevContext-&gt;Device,</span><br><span class="line">            &amp;wakeSettings);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">return</span> status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[���� - ��һ���ֽ���ϸ����SD����ʼ���������]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-35"><a href="#User-35" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-35"><a href="#AI-claude-3-5-sonnet-35" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ��SD����ʼ������������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-3"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-3" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 3"></a>WDF SD Host Controller����ʵ����� - Part 3</h1><h2 id="3-SD����ʼ���������"><a href="#3-SD����ʼ���������" class="headerlink" title="3. SD����ʼ���������"></a>3. SD����ʼ���������</h2><h3 id="3-1-SD��������ʼ������"><a href="#3-1-SD��������ʼ������" class="headerlink" title="3.1 SD��������ʼ������"></a>3.1 SD��������ʼ������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    SD_COMMAND cmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    ULONG response;</span><br><span class="line">    BOOLEAN sdVer2 = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��⿨��������</span></span><br><span class="line">    <span class="keyword">if</span> (!RtsPciIsCardPresent(DevContext)) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_NO_MEDIA;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �ϵ�����</span></span><br><span class="line">    status = RtsPciPowerUpSequence(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����CMD0(GO_IDLE_STATE)</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">0</span>, <span class="number">0</span>, SD_RESPONSE_NONE);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����CMD8(SEND_IF_COND)����ѹ</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">8</span>, <span class="number">0x1AA</span>, SD_RESPONSE_R7);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    sdVer2 = NT_SUCCESS(status);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����ACMD41��ʼ����</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SD_INIT_TIMEOUT_MS; i++) &#123;</span><br><span class="line">        <span class="comment">// �ȷ���CMD55</span></span><br><span class="line">        RtsPciInitCommand(&amp;cmd, <span class="number">55</span>, <span class="number">0</span>, SD_RESPONSE_R1);</span><br><span class="line">        status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����ACMD41</span></span><br><span class="line">        ULONG arg = sdVer2 ? <span class="number">0x40FF8000</span> : <span class="number">0x00FF8000</span>;</span><br><span class="line">        RtsPciInitCommand(&amp;cmd, <span class="number">41</span>, arg, SD_RESPONSE_R3);</span><br><span class="line">        status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        response = cmd.Response[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (response &amp; <span class="number">0x80000000</span>) &#123;</span><br><span class="line">            DevContext-&gt;HighCapacity = (response &amp; <span class="number">0x40000000</span>) ? TRUE : FALSE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        KeStallExecutionProcessor(<span class="number">1000</span>);  <span class="comment">// 1ms�ӳ�</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ��ȡCID</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">2</span>, <span class="number">0</span>, SD_RESPONSE_R2);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    RtlCopyMemory(DevContext-&gt;CardCID, cmd.Response, <span class="number">16</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7. ��ȡRCA</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">3</span>, <span class="number">0</span>, SD_RESPONSE_R6);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    DevContext-&gt;CardRCA = cmd.Response[<span class="number">0</span>] &gt;&gt; <span class="number">16</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 8. ��ȡCSD</span></span><br><span class="line">    status = RtsPciGetCardCapacity(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 9. ѡ��</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">7</span>, DevContext-&gt;CardRCA &lt;&lt; <span class="number">16</span>, SD_RESPONSE_R1b);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-�����ʵ��"><a href="#3-2-�����ʵ��" class="headerlink" title="3.2 �����ʵ��"></a>3.2 �����ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciSendCommand</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PSD_COMMAND Cmd</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    ULONG cmdReg, intStatus;</span><br><span class="line">    LARGE_INTEGER timeout;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �ȴ������߿���</span></span><br><span class="line">    status = RtsPciWaitForCommandLine(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ׼������Ĵ���ֵ</span></span><br><span class="line">    cmdReg = (Cmd-&gt;Index &lt;&lt; CMD_INDEX_SHIFT) |</span><br><span class="line">             (RtsPciGetResponseType(Cmd-&gt;ResponseType) &lt;&lt; RESP_TYPE_SHIFT);</span><br><span class="line">             </span><br><span class="line">    <span class="keyword">if</span> (Cmd-&gt;HasData) &#123;</span><br><span class="line">        cmdReg |= CMD_DATA_PRESENT;</span><br><span class="line">        <span class="keyword">if</span> (Cmd-&gt;IsWrite) &#123;</span><br><span class="line">            cmdReg |= CMD_WRITE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���ò���������</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_ARG_REG,</span><br><span class="line">        Cmd-&gt;Argument);</span><br><span class="line">        </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CMD_REG,</span><br><span class="line">        cmdReg);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 4. �ȴ��������</span></span><br><span class="line">    KeQuerySystemTime(&amp;timeout);</span><br><span class="line">    timeout.QuadPart += Cmd-&gt;Timeout * <span class="number">10000</span>; <span class="comment">// ת��Ϊ100ns��λ</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        intStatus = READ_REGISTER_ULONG(</span><br><span class="line">            DevContext-&gt;RegisterBase + HOST_INT_STATUS);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (intStatus &amp; COMMAND_COMPLETE_INT) &#123;</span><br><span class="line">            <span class="comment">// ����ж�״̬</span></span><br><span class="line">            WRITE_REGISTER_ULONG(</span><br><span class="line">                DevContext-&gt;RegisterBase + HOST_INT_STATUS,</span><br><span class="line">                COMMAND_COMPLETE_INT);</span><br><span class="line">                </span><br><span class="line">            <span class="comment">// ������</span></span><br><span class="line">            <span class="keyword">if</span> (intStatus &amp; ERROR_INT) &#123;</span><br><span class="line">                <span class="keyword">return</span> RtsPciHandleCommandError(DevContext, intStatus);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ��ȡ��Ӧ</span></span><br><span class="line">            <span class="keyword">if</span> (Cmd-&gt;ResponseType != SD_RESPONSE_NONE) &#123;</span><br><span class="line">                RtsPciGetResponse(DevContext, Cmd);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        KeStallExecutionProcessor(<span class="number">1</span>);  <span class="comment">// 1us�ӳ�</span></span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">while</span> (KeQuerySystemTime(&amp;timeout) &lt; <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_IO_TIMEOUT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.3 ��Ӧ����</span></span><br><span class="line">VOID <span class="title function_">RtsPciGetResponse</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PSD_COMMAND Cmd</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (Cmd-&gt;ResponseType) &#123;</span><br><span class="line">        <span class="keyword">case</span> SD_RESPONSE_R1:</span><br><span class="line">        <span class="keyword">case</span> SD_RESPONSE_R1b:</span><br><span class="line">        <span class="keyword">case</span> SD_RESPONSE_R3:</span><br><span class="line">        <span class="keyword">case</span> SD_RESPONSE_R6:</span><br><span class="line">        <span class="keyword">case</span> SD_RESPONSE_R7:</span><br><span class="line">            Cmd-&gt;Response[<span class="number">0</span>] = READ_REGISTER_ULONG(</span><br><span class="line">                DevContext-&gt;RegisterBase + HOST_RESP0_REG);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SD_RESPONSE_R2:</span><br><span class="line">            <span class="comment">// CID/CSD��Ҫ��ȡ����4���Ĵ���</span></span><br><span class="line">            Cmd-&gt;Response[<span class="number">0</span>] = READ_REGISTER_ULONG(</span><br><span class="line">                DevContext-&gt;RegisterBase + HOST_RESP0_REG);</span><br><span class="line">            Cmd-&gt;Response[<span class="number">1</span>] = READ_REGISTER_ULONG(</span><br><span class="line">                DevContext-&gt;RegisterBase + HOST_RESP1_REG);</span><br><span class="line">            Cmd-&gt;Response[<span class="number">2</span>] = READ_REGISTER_ULONG(</span><br><span class="line">                DevContext-&gt;RegisterBase + HOST_RESP2_REG);</span><br><span class="line">            Cmd-&gt;Response[<span class="number">3</span>] = READ_REGISTER_ULONG(</span><br><span class="line">                DevContext-&gt;RegisterBase + HOST_RESP3_REG);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.4 ������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleCommandError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ ULONG ErrorStatus</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// �������״̬</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_INT_STATUS,</span><br><span class="line">        ErrorStatus &amp; ERROR_INT_MASK);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ��λ������</span></span><br><span class="line">    <span class="keyword">if</span> (ErrorStatus &amp; (CMD_TIMEOUT_ERR | CMD_CRC_ERR)) &#123;</span><br><span class="line">        RtsPciResetCommandLine(DevContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���´���ͳ��</span></span><br><span class="line">    InterlockedIncrement(&amp;DevContext-&gt;ErrorCount);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ؾ��������</span></span><br><span class="line">    <span class="keyword">if</span> (ErrorStatus &amp; CMD_TIMEOUT_ERR) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_IO_TIMEOUT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ErrorStatus &amp; CMD_CRC_ERR) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_CRC_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_DEVICE_PROTOCOL_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-������"><a href="#3-3-������" class="headerlink" title="3.3 ������"></a>3.3 ������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciConfigureCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    SD_COMMAND cmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���ÿ��С</span></span><br><span class="line">    DevContext-&gt;BlockSize = <span class="number">512</span>;</span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_BLOCK_SIZE,</span><br><span class="line">        DevContext-&gt;BlockSize);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. �������߿���(4λģʽ)</span></span><br><span class="line">    <span class="comment">// �ȷ���CMD55</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">55</span>, DevContext-&gt;CardRCA &lt;&lt; <span class="number">16</span>, SD_RESPONSE_R1);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ACMD6</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">6</span>, <span class="number">2</span>, SD_RESPONSE_R1);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����Host Controller</span></span><br><span class="line">    ULONG hostCtrl = READ_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CTRL_REG);</span><br><span class="line">    hostCtrl |= HOST_CTRL_4BIT;</span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CTRL_REG,</span><br><span class="line">        hostCtrl);</span><br><span class="line">        </span><br><span class="line">    DevContext-&gt;Bus4BitMode = TRUE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����ʱ��Ƶ��</span></span><br><span class="line">    status = RtsPciSetClock(DevContext, SD_CLOCK_25MHZ);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[���� - ��һ���ֽ���ϸ�������ݴ����DMA����]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-36"><a href="#User-36" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-36"><a href="#AI-claude-3-5-sonnet-36" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ�����ݴ����DMA�������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-4"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-4" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 4"></a>WDF SD Host Controller����ʵ����� - Part 4</h1><h2 id="4-���ݴ�����DMA����"><a href="#4-���ݴ�����DMA����" class="headerlink" title="4. ���ݴ�����DMA����"></a>4. ���ݴ�����DMA����</h2><h3 id="4-1-��д������"><a href="#4-1-��д������" class="headerlink" title="4.1 ��д������"></a>4.1 ��д������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">RtsPciEvtIoRead</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFQUEUE Queue,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> Length</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    WDF_REQUEST_PARAMETERS params;</span><br><span class="line">    LARGE_INTEGER offset;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(WdfIoQueueGetDevice(Queue));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ�������</span></span><br><span class="line">    WDF_REQUEST_PARAMETERS_INIT(&amp;params);</span><br><span class="line">    WdfRequestGetParameters(Request, &amp;params);</span><br><span class="line">    offset.QuadPart = params.Parameters.Read.DeviceOffset;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ������֤</span></span><br><span class="line">    <span class="keyword">if</span> ((offset.QuadPart % devContext-&gt;BlockSize) != <span class="number">0</span> ||</span><br><span class="line">        (Length % devContext-&gt;BlockSize) != <span class="number">0</span>) &#123;</span><br><span class="line">        WdfRequestComplete(Request, STATUS_INVALID_PARAMETER);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��鿨״̬</span></span><br><span class="line">    <span class="keyword">if</span> (!devContext-&gt;CardPresent) &#123;</span><br><span class="line">        WdfRequestComplete(Request, STATUS_NO_MEDIA);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ׼������</span></span><br><span class="line">    status = RtsPciPrepareTransfer(</span><br><span class="line">        devContext,</span><br><span class="line">        Request,</span><br><span class="line">        offset.QuadPart / devContext-&gt;BlockSize,</span><br><span class="line">        Length / devContext-&gt;BlockSize,</span><br><span class="line">        FALSE);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        WdfRequestComplete(Request, status);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">RtsPciEvtIoWrite</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFQUEUE Queue,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> Length</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ���ƶ���������IsWrite = TRUE</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="4-2-����׼��"><a href="#4-2-����׼��" class="headerlink" title="4.2 ����׼��"></a>4.2 ����׼��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciPrepareTransfer</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ ULONGLONG StartingLba,</span></span><br><span class="line"><span class="params">    _In_ ULONG BlockCount,</span></span><br><span class="line"><span class="params">    _In_ BOOLEAN IsWrite</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    SD_COMMAND cmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���õ�ǰ������Ϣ</span></span><br><span class="line">    DevContext-&gt;CurrentRequest = Request;</span><br><span class="line">    DevContext-&gt;CurrentLba = (ULONG)StartingLba;</span><br><span class="line">    DevContext-&gt;CurrentLength = BlockCount * DevContext-&gt;BlockSize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ׼��DMA</span></span><br><span class="line">    status = RtsPciSetupDmaForRequest(DevContext, Request, IsWrite);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���ÿ����ʹ�С</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_BLOCK_COUNT,</span><br><span class="line">        BlockCount);</span><br><span class="line">        </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_BLOCK_SIZE,</span><br><span class="line">        DevContext-&gt;BlockSize);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 4. ׼������</span></span><br><span class="line">    <span class="keyword">if</span> (BlockCount == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// ���鴫��</span></span><br><span class="line">        cmd.Index = IsWrite ? <span class="number">24</span> : <span class="number">17</span>;  <span class="comment">// WRITE_BLOCK or READ_SINGLE_BLOCK</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ��鴫��</span></span><br><span class="line">        cmd.Index = IsWrite ? <span class="number">25</span> : <span class="number">18</span>;  <span class="comment">// WRITE_MULTIPLE_BLOCK or READ_MULTIPLE_BLOCK</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    cmd.Argument = DevContext-&gt;HighCapacity ? </span><br><span class="line">                  (ULONG)StartingLba : </span><br><span class="line">                  (ULONG)StartingLba * DevContext-&gt;BlockSize;</span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_R1;</span><br><span class="line">    cmd.HasData = TRUE;</span><br><span class="line">    cmd.IsWrite = IsWrite;</span><br><span class="line">    cmd.BlockCount = BlockCount;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ��������</span></span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;TransferActive = TRUE;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="4-3-DMA����"><a href="#4-3-DMA����" class="headerlink" title="4.3 DMA����"></a>4.3 DMA����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciSetupDmaForRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ BOOLEAN IsWrite</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDFMEMORY requestMemory;</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES attributes;</span><br><span class="line">    PHYSICAL_ADDRESS highestAcceptableAddress;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ�����ڴ�</span></span><br><span class="line">    status = WdfRequestRetrieveOutputMemory(Request, &amp;requestMemory);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����DMA������</span></span><br><span class="line">    highestAcceptableAddress.QuadPart = MAXULONG64;</span><br><span class="line">    </span><br><span class="line">    WDF_DMA_ENABLER_CONFIG dmaConfig;</span><br><span class="line">    WDF_DMA_ENABLER_CONFIG_INIT(&amp;dmaConfig,</span><br><span class="line">                               WdfDmaProfileScatterGather,</span><br><span class="line">                               DevContext-&gt;CurrentLength);</span><br><span class="line">                               </span><br><span class="line">    <span class="comment">// 3. ����ͨ�û�����</span></span><br><span class="line">    status = WdfCommonBufferCreate(</span><br><span class="line">        DevContext-&gt;DmaEnabler,</span><br><span class="line">        DevContext-&gt;CurrentLength,</span><br><span class="line">        WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">        &amp;DevContext-&gt;DmaBuffer);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ��ȡ������ַ</span></span><br><span class="line">    DevContext-&gt;DmaBufferPA = </span><br><span class="line">        WdfCommonBufferGetAlignedLogicalAddress(DevContext-&gt;DmaBuffer);</span><br><span class="line">        </span><br><span class="line">    DevContext-&gt;DmaBufferVA = </span><br><span class="line">        WdfCommonBufferGetAlignedVirtualAddress(DevContext-&gt;DmaBuffer);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 5. ����DMA�Ĵ���</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_ADDR,</span><br><span class="line">        DevContext-&gt;DmaBufferPA.LowPart);</span><br><span class="line">        </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_ADDR_HIGH,</span><br><span class="line">        DevContext-&gt;DmaBufferPA.HighPart);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 6. ����DMA����</span></span><br><span class="line">    ULONG dmaCtrl = READ_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_CTRL);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (IsWrite) &#123;</span><br><span class="line">        dmaCtrl |= DMA_CTRL_WRITE;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dmaCtrl &amp;= ~DMA_CTRL_WRITE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_CTRL,</span><br><span class="line">        dmaCtrl);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="4-4-������ɴ���"><a href="#4-4-������ɴ���" class="headerlink" title="4.4 ������ɴ���"></a>4.4 ������ɴ���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">RtsPciCompleteTransfer</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ NTSTATUS Status</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDFREQUEST request;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ֹͣDMA</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_CTRL,</span><br><span class="line">        <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. ����DMA��Դ</span></span><br><span class="line">    <span class="keyword">if</span> (DevContext-&gt;DmaBuffer) &#123;</span><br><span class="line">        WdfObjectDelete(DevContext-&gt;DmaBuffer);</span><br><span class="line">        DevContext-&gt;DmaBuffer = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����ͳ����Ϣ</span></span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(Status)) &#123;</span><br><span class="line">        DevContext-&gt;TotalBytesTransferred.QuadPart += </span><br><span class="line">            DevContext-&gt;CurrentLength;</span><br><span class="line">        InterlockedIncrement(&amp;DevContext-&gt;TotalRequests);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        InterlockedIncrement(&amp;DevContext-&gt;ErrorCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �������</span></span><br><span class="line">    request = DevContext-&gt;CurrentRequest;</span><br><span class="line">    DevContext-&gt;CurrentRequest = <span class="literal">NULL</span>;</span><br><span class="line">    DevContext-&gt;TransferActive = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (request) &#123;</span><br><span class="line">        WdfRequestCompleteWithInformation(</span><br><span class="line">            request,</span><br><span class="line">            Status,</span><br><span class="line">            NT_SUCCESS(Status) ? DevContext-&gt;CurrentLength : <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ������һ������</span></span><br><span class="line">    RtsPciProcessNextRequest(DevContext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">RtsPciProcessNextRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDFREQUEST nextRequest;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    status = WdfIoQueueRetrieveNextRequest(</span><br><span class="line">        DevContext-&gt;IoQueue,</span><br><span class="line">        &amp;nextRequest);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="comment">// ������һ������</span></span><br><span class="line">        WDF_REQUEST_PARAMETERS params;</span><br><span class="line">        WDF_REQUEST_PARAMETERS_INIT(&amp;params);</span><br><span class="line">        WdfRequestGetParameters(nextRequest, &amp;params);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (params.Type == WdfRequestTypeRead) &#123;</span><br><span class="line">            RtsPciEvtIoRead(DevContext-&gt;IoQueue,</span><br><span class="line">                           nextRequest,</span><br><span class="line">                           params.Parameters.Read.Length);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            RtsPciEvtIoWrite(DevContext-&gt;IoQueue,</span><br><span class="line">                            nextRequest,</span><br><span class="line">                            params.Parameters.Write.Length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>[���� - ��һ���ֽ���ϸ�����жϴ����͵�Դ����]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-37"><a href="#User-37" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-37"><a href="#AI-claude-3-5-sonnet-37" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���жϴ����͵�Դ�������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-5"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-5" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 5"></a>WDF SD Host Controller����ʵ����� - Part 5</h1><h2 id="5-�жϴ���"><a href="#5-�жϴ���" class="headerlink" title="5. �жϴ���"></a>5. �жϴ���</h2><h3 id="5-1-ISRʵ��"><a href="#5-1-ISRʵ��" class="headerlink" title="5.1 ISRʵ��"></a>5.1 ISRʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN <span class="title function_">RtsPciEvtInterruptIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ ULONG MessageID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    ULONG intStatus, intEnable;</span><br><span class="line">    BOOLEAN handled = FALSE;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(WdfInterruptGetDevice(Interrupt));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ�ж�״̬</span></span><br><span class="line">    intStatus = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_STATUS);</span><br><span class="line">        </span><br><span class="line">    intEnable = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_ENABLE);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ֻ����ʹ�ܵ��ж�</span></span><br><span class="line">    intStatus &amp;= intEnable;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!intStatus) &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����ж�״̬</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_STATUS,</span><br><span class="line">        intStatus);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. ���������ж�</span></span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; CARD_DETECT_INT) &#123;</span><br><span class="line">        <span class="comment">// ������жϣ���Ҫ��DPC�д���</span></span><br><span class="line">        WdfInterruptQueueDpcForIsr(Interrupt);</span><br><span class="line">        handled = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; TRANSFER_COMPLETE_INT) &#123;</span><br><span class="line">        <span class="comment">// ��������ж�</span></span><br><span class="line">        <span class="keyword">if</span> (devContext-&gt;TransferActive) &#123;</span><br><span class="line">            <span class="comment">// ��DPC����ɴ���</span></span><br><span class="line">            WdfInterruptQueueDpcForIsr(Interrupt);</span><br><span class="line">            handled = TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; ERROR_INT) &#123;</span><br><span class="line">        <span class="comment">// �����ж�</span></span><br><span class="line">        devContext-&gt;LastError = READ_REGISTER_ULONG(</span><br><span class="line">            devContext-&gt;RegisterBase + HOST_ERROR_STATUS);</span><br><span class="line">        WdfInterruptQueueDpcForIsr(Interrupt);</span><br><span class="line">        handled = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="5-2-DPCʵ��"><a href="#5-2-DPCʵ��" class="headerlink" title="5.2 DPCʵ��"></a>5.2 DPCʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">RtsPciEvtInterruptDpc</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ WDFOBJECT Device</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    ULONG intStatus;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���¶�ȡ״̬(���������ж�)</span></span><br><span class="line">    intStatus = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_STATUS);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. ���������</span></span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; CARD_DETECT_INT) &#123;</span><br><span class="line">        BOOLEAN cardPresent = RtsPciIsCardPresent(devContext);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (cardPresent != devContext-&gt;CardPresent) &#123;</span><br><span class="line">            devContext-&gt;CardPresent = cardPresent;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (cardPresent) &#123;</span><br><span class="line">                <span class="comment">// �����룬��ʼ��ʼ��</span></span><br><span class="line">                RtsPciInitializeCard(devContext);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// ���Ƴ�������״̬</span></span><br><span class="line">                RtsPciHandleCardRemoval(devContext);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �����������</span></span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; TRANSFER_COMPLETE_INT) &#123;</span><br><span class="line">        <span class="keyword">if</span> (devContext-&gt;TransferActive) &#123;</span><br><span class="line">            <span class="comment">// ����Ƿ��д���</span></span><br><span class="line">            <span class="keyword">if</span> (intStatus &amp; ERROR_INT) &#123;</span><br><span class="line">                RtsPciCompleteTransfer(devContext, </span><br><span class="line">                    RtsPciHandleTransferError(devContext));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                RtsPciCompleteTransfer(devContext, STATUS_SUCCESS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ��������</span></span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; ERROR_INT) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!devContext-&gt;TransferActive) &#123;</span><br><span class="line">            <span class="comment">// �Ǵ������Ĵ���</span></span><br><span class="line">            RtsPciHandleNonTransferError(devContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">RtsPciHandleCardRemoval</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ȡ����ǰ����</span></span><br><span class="line">    <span class="keyword">if</span> (DevContext-&gt;CurrentRequest) &#123;</span><br><span class="line">        RtsPciCompleteTransfer(DevContext, STATUS_NO_MEDIA);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ȡ�������е�����</span></span><br><span class="line">    WdfIoQueuePurgeSynchronously(DevContext-&gt;IoQueue);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��λ������״̬</span></span><br><span class="line">    DevContext-&gt;CardPresent = FALSE;</span><br><span class="line">    DevContext-&gt;HighCapacity = FALSE;</span><br><span class="line">    DevContext-&gt;CardRCA = <span class="number">0</span>;</span><br><span class="line">    RtlZeroMemory(DevContext-&gt;CardCID, <span class="keyword">sizeof</span>(DevContext-&gt;CardCID));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ֪ͨPnP������</span></span><br><span class="line">    WdfDeviceSetFailed(DevContext-&gt;Device, </span><br><span class="line">                       WdfDeviceFailedNoRestart);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="6-��Դ����"><a href="#6-��Դ����" class="headerlink" title="6. ��Դ����"></a>6. ��Դ����</h2><h3 id="6-1-��Դ״̬ת��"><a href="#6-1-��Դ״̬ת��" class="headerlink" title="6.1 ��Դ״̬ת��"></a>6.1 ��Դ״̬ת��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceD0Entry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDF_POWER_DEVICE_STATE PreviousState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �ϵ�����</span></span><br><span class="line">    status = RtsPciPowerUpSequence(devContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ��������</span></span><br><span class="line">    status = RtsPciInitializeController(devContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��鲢��ʼ����</span></span><br><span class="line">    <span class="keyword">if</span> (RtsPciIsCardPresent(devContext)) &#123;</span><br><span class="line">        status = RtsPciInitializeCard(devContext);</span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            status = RtsPciConfigureCard(devContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����IO����</span></span><br><span class="line">    WdfIoQueueStart(devContext-&gt;IoQueue);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceD0Exit</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDF_POWER_DEVICE_STATE TargetState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ֹͣIO����</span></span><br><span class="line">    WdfIoQueueStop(devContext-&gt;IoQueue,</span><br><span class="line">                   <span class="literal">NULL</span>,</span><br><span class="line">                   <span class="literal">NULL</span>);</span><br><span class="line">                   </span><br><span class="line">    <span class="comment">// 2. ȡ������δ��ɵ�����</span></span><br><span class="line">    <span class="keyword">if</span> (devContext-&gt;CurrentRequest) &#123;</span><br><span class="line">        RtsPciCompleteTransfer(devContext, STATUS_CANCELLED);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �ر�ʱ��</span></span><br><span class="line">    RtsPciSetClock(devContext, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �رյ�Դ</span></span><br><span class="line">    RtsPciPowerDownSequence(devContext);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="6-2-���е�Դ����"><a href="#6-2-���е�Դ����" class="headerlink" title="6.2 ���е�Դ����"></a>6.2 ���е�Դ����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciConfigureIdleSettings</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DEVICE_POWER_POLICY_IDLE_SETTINGS idleSettings;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���ÿ�������</span></span><br><span class="line">    WDF_DEVICE_POWER_POLICY_IDLE_SETTINGS_INIT(</span><br><span class="line">        &amp;idleSettings,</span><br><span class="line">        IdleCannotWakeFromS0);</span><br><span class="line">        </span><br><span class="line">    idleSettings.IdleTimeout = <span class="number">1000</span>; <span class="comment">// 1��</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ע����лص�</span></span><br><span class="line">    WDF_POWER_POLICY_EVENT_CALLBACKS callbacks;</span><br><span class="line">    WDF_POWER_POLICY_EVENT_CALLBACKS_INIT(&amp;callbacks);</span><br><span class="line">    </span><br><span class="line">    callbacks.EvtDeviceArmWakeFromS0 = RtsPciEvtDeviceArmWakeFromS0;</span><br><span class="line">    callbacks.EvtDeviceDisarmWakeFromS0 = RtsPciEvtDeviceDisarmWakeFromS0;</span><br><span class="line">    </span><br><span class="line">    status = WdfDeviceAssignS0IdleSettings(</span><br><span class="line">        DevContext-&gt;Device,</span><br><span class="line">        &amp;idleSettings);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceArmWakeFromS0</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ʹ�ܿ�����ж�</span></span><br><span class="line">    ULONG intEnable = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_ENABLE);</span><br><span class="line">        </span><br><span class="line">    intEnable |= CARD_DETECT_INT;</span><br><span class="line">    </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_ENABLE,</span><br><span class="line">        intEnable);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceDisarmWakeFromS0</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ÿ�����ж�</span></span><br><span class="line">    ULONG intEnable = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_ENABLE);</span><br><span class="line">        </span><br><span class="line">    intEnable &amp;= ~CARD_DETECT_INT;</span><br><span class="line">    </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_ENABLE,</span><br><span class="line">        intEnable);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>[���� - ��һ���ֽ���ϸ���ܵ���֧�ֺ������Ż�]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-38"><a href="#User-38" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>RtsPciInitializeCard���ʵ�ֵ�</p>
<h2 id="AI-claude-3-5-sonnet-38"><a href="#AI-claude-3-5-sonnet-38" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>������ϸչ��RtsPciInitializeCard������ʵ�֣�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SD����ʼ��״̬��</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">SD_INIT_STATE</span> &#123;</span></span><br><span class="line">    SD_INIT_IDLE = <span class="number">0</span>,</span><br><span class="line">    SD_INIT_READY,</span><br><span class="line">    SD_INIT_IDENT,</span><br><span class="line">    SD_INIT_STBY,</span><br><span class="line">    SD_INIT_TRAN,</span><br><span class="line">    SD_INIT_DATA</span><br><span class="line">&#125; SD_INIT_STATE;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    SD_COMMAND cmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    ULONG response;</span><br><span class="line">    BOOLEAN sdVer2 = FALSE;</span><br><span class="line">    SD_INIT_STATE cardState = SD_INIT_IDLE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��⿨��������</span></span><br><span class="line">    <span class="keyword">if</span> (!RtsPciIsCardPresent(DevContext)) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_NO_MEDIA;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �ϵ�����</span></span><br><span class="line">    status = RtsPciPowerUpSequence(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����CMD0(GO_IDLE_STATE) - ��λ��������״̬</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">0</span>, <span class="number">0</span>, SD_RESPONSE_NONE);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    cardState = SD_INIT_IDLE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����CMD8(SEND_IF_COND) - ����ѹ������</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">8</span>, <span class="number">0x1AA</span>, SD_RESPONSE_R7);</span><br><span class="line">    <span class="comment">// 0x1AA = (1)���ģʽ | (0xAA)���ģʽ</span></span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="comment">// �����Ӧ</span></span><br><span class="line">        <span class="keyword">if</span> ((cmd.Response[<span class="number">0</span>] &amp; <span class="number">0xFFF</span>) != <span class="number">0x1AA</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> STATUS_DEVICE_PROTOCOL_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        sdVer2 = TRUE;  <span class="comment">// SD 2.0����߰汾��</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����ACMD41(SD_SEND_OP_COND) - ��ʼ����</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SD_INIT_TIMEOUT_MS; i++) &#123;</span><br><span class="line">        <span class="comment">// �ȷ���CMD55(APP_CMD)</span></span><br><span class="line">        RtsPciInitCommand(&amp;cmd, <span class="number">55</span>, <span class="number">0</span>, SD_RESPONSE_R1);</span><br><span class="line">        status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����ACMD41</span></span><br><span class="line">        ULONG ocr = sdVer2 ? <span class="number">0x40FF8000</span> : <span class="number">0x00FF8000</span>;</span><br><span class="line">        <span class="comment">// 0x40000000 = HCS(High Capacity Support)</span></span><br><span class="line">        <span class="comment">// 0x00FF8000 = ��ѹ��Χ(2.7-3.6V)</span></span><br><span class="line">        RtsPciInitCommand(&amp;cmd, <span class="number">41</span>, ocr, SD_RESPONSE_R3);</span><br><span class="line">        status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        response = cmd.Response[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (response &amp; <span class="number">0x80000000</span>) &#123;  <span class="comment">// ������ɳ�ʼ��</span></span><br><span class="line">            DevContext-&gt;HighCapacity = (response &amp; <span class="number">0x40000000</span>) ? TRUE : FALSE;</span><br><span class="line">            cardState = SD_INIT_READY;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        KeStallExecutionProcessor(<span class="number">1000</span>);  <span class="comment">// 1ms�ӳ�</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (cardState != SD_INIT_READY) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_DEVICE_NOT_READY;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ����CMD2(ALL_SEND_CID) - ��ȡCID</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">2</span>, <span class="number">0</span>, SD_RESPONSE_R2);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    RtlCopyMemory(DevContext-&gt;CardCID, cmd.Response, <span class="number">16</span>);</span><br><span class="line">    cardState = SD_INIT_IDENT;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7. ����CMD3(SEND_RELATIVE_ADDR) - ��ȡRCA</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">3</span>, <span class="number">0</span>, SD_RESPONSE_R6);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    DevContext-&gt;CardRCA = cmd.Response[<span class="number">0</span>] &gt;&gt; <span class="number">16</span>;</span><br><span class="line">    cardState = SD_INIT_STBY;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 8. ����CMD9(SEND_CSD) - ��ȡCSD</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">9</span>, DevContext-&gt;CardRCA &lt;&lt; <span class="number">16</span>, SD_RESPONSE_R2);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    RtlCopyMemory(DevContext-&gt;CardCSD, cmd.Response, <span class="number">16</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����CSD��ȡ������Ϣ</span></span><br><span class="line">    status = RtsPciParseCSD(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 9. ����CMD7(SELECT_CARD) - ѡ��</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">7</span>, DevContext-&gt;CardRCA &lt;&lt; <span class="number">16</span>, SD_RESPONSE_R1b);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    cardState = SD_INIT_TRAN;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 10. ���ÿ���������</span></span><br><span class="line">    status = RtsPciSetCardParameters(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    cardState = SD_INIT_DATA;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 11. �����豸״̬</span></span><br><span class="line">    DevContext-&gt;CardPresent = TRUE;</span><br><span class="line">    DevContext-&gt;CardState = cardState;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����CSD�Ĵ�����ȡ������Ϣ</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciParseCSD</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    UCHAR csdVersion;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡCSD�汾</span></span><br><span class="line">    csdVersion = (DevContext-&gt;CardCSD[<span class="number">0</span>] &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (csdVersion == <span class="number">0</span>) &#123;  <span class="comment">// CSD Version 1.0</span></span><br><span class="line">        ULONG cSize, cSizeMult, readBlLen;</span><br><span class="line">        </span><br><span class="line">        readBlLen = DevContext-&gt;CardCSD[<span class="number">1</span>] &amp; <span class="number">0xF</span>;</span><br><span class="line">        cSize = ((DevContext-&gt;CardCSD[<span class="number">1</span>] &amp; <span class="number">0x3FF</span>) &lt;&lt; <span class="number">2</span>) |</span><br><span class="line">                ((DevContext-&gt;CardCSD[<span class="number">2</span>] &amp; <span class="number">0xC0000000</span>) &gt;&gt; <span class="number">30</span>);</span><br><span class="line">        cSizeMult = (DevContext-&gt;CardCSD[<span class="number">2</span>] &amp; <span class="number">0x00038000</span>) &gt;&gt; <span class="number">15</span>;</span><br><span class="line">        </span><br><span class="line">        DevContext-&gt;DiskSize.QuadPart = (ULONGLONG)(cSize + <span class="number">1</span>) *</span><br><span class="line">            (<span class="number">1ULL</span> &lt;&lt; (cSizeMult + <span class="number">2</span>)) *</span><br><span class="line">            (<span class="number">1ULL</span> &lt;&lt; readBlLen);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (csdVersion == <span class="number">1</span>) &#123;  <span class="comment">// CSD Version 2.0</span></span><br><span class="line">        ULONG cSize;</span><br><span class="line">        </span><br><span class="line">        cSize = ((DevContext-&gt;CardCSD[<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">16</span>) |</span><br><span class="line">                ((DevContext-&gt;CardCSD[<span class="number">2</span>] &amp; <span class="number">0xFFFF0000</span>) &gt;&gt; <span class="number">16</span>);</span><br><span class="line">                </span><br><span class="line">        DevContext-&gt;DiskSize.QuadPart = (ULONGLONG)(cSize + <span class="number">1</span>) * <span class="number">512</span> * <span class="number">1024</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_DEVICE_PROTOCOL_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���ÿ���������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciSetCardParameters</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    SD_COMMAND cmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���ÿ��СΪ512�ֽ�</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">16</span>, <span class="number">512</span>, SD_RESPONSE_R1);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �������߿���Ϊ4λ</span></span><br><span class="line">    <span class="comment">// �ȷ���CMD55</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">55</span>, DevContext-&gt;CardRCA &lt;&lt; <span class="number">16</span>, SD_RESPONSE_R1);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ACMD6</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">6</span>, <span class="number">2</span>, SD_RESPONSE_R1);  <span class="comment">// 2 = 4λģʽ</span></span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����Host ControllerΪ4λģʽ</span></span><br><span class="line">    ULONG hostCtrl = READ_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CTRL_REG);</span><br><span class="line">    hostCtrl |= HOST_CTRL_4BIT;</span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CTRL_REG,</span><br><span class="line">        hostCtrl);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>���ʵ�ְ�����������SD����ʼ�����̣�</p>
<ol>
<li>��⿨��������</li>
<li>ִ���ϵ�����</li>
<li>����CMD0��λ��</li>
<li>����CMD8����ѹ������</li>
<li>����ACMD41��ʼ����</li>
<li>��ȡCID��Ϣ</li>
<li>��ȡRCA��ַ</li>
<li>��ȡCSD��Ϣ����������</li>
<li>ѡ��</li>
<li>���ù������������С�����߿��ȣ�</li>
</ol>
<p>ÿ�����趼����ϸ�Ĵ���������Ի��ƣ�ȷ����ʼ���Ŀɿ��ԡ�ͬʱͨ��״̬��׷�ٿ��ĳ�ʼ��״̬�����ڵ��Ժʹ���ָ���</p>
<h2 id="User-39"><a href="#User-39" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����ʼ����ɺ����֪ͨWDF��PNP�����豸</p>
<h2 id="AI-claude-3-5-sonnet-39"><a href="#AI-claude-3-5-sonnet-39" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��SD����ʼ����ɺ���Ҫ֪ͨϵͳ���µĴ洢�豸����������ϸʵ�֣�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciNotifyDeviceReady</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ע���豸�ӿ�</span></span><br><span class="line">    status = WdfDeviceCreateDeviceInterface(</span><br><span class="line">        DevContext-&gt;Device,</span><br><span class="line">        &amp;GUID_DEVINTERFACE_DISK,    <span class="comment">// ��׼�����豸�ӿ�GUID</span></span><br><span class="line">        <span class="literal">NULL</span>);                       <span class="comment">// �޲ο��ַ���</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        RtsPciDebugLog(</span><br><span class="line">            <span class="string">&quot;Failed to create device interface, status = 0x%08X\n&quot;</span>, </span><br><span class="line">            status);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����豸����</span></span><br><span class="line">    STORAGE_DEVICE_DESCRIPTOR deviceDesc = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    deviceDesc.Version = <span class="keyword">sizeof</span>(STORAGE_DEVICE_DESCRIPTOR);</span><br><span class="line">    deviceDesc.Size = <span class="keyword">sizeof</span>(STORAGE_DEVICE_DESCRIPTOR);</span><br><span class="line">    deviceDesc.DeviceType = FILE_DEVICE_DISK;</span><br><span class="line">    deviceDesc.DeviceTypeModifier = <span class="number">0</span>;</span><br><span class="line">    deviceDesc.RemovableMedia = TRUE;</span><br><span class="line">    deviceDesc.BusType = BusTypeSD;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��CID�л�ȡ���̺Ͳ�Ʒ��Ϣ</span></span><br><span class="line">    RtlCopyMemory(deviceDesc.VendorId, </span><br><span class="line">                  &amp;DevContext-&gt;CardCID[<span class="number">0</span>],</span><br><span class="line">                  <span class="number">8</span>);</span><br><span class="line">    RtlCopyMemory(deviceDesc.ProductId,</span><br><span class="line">                  &amp;DevContext-&gt;CardCID[<span class="number">8</span>],</span><br><span class="line">                  <span class="number">16</span>);</span><br><span class="line">                  </span><br><span class="line">    status = WdfDeviceSetDeviceDescriptor(</span><br><span class="line">        DevContext-&gt;Device,</span><br><span class="line">        &amp;deviceDesc);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �����豸����</span></span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES pnpCaps;</span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES_INIT(&amp;pnpCaps);</span><br><span class="line">    pnpCaps.Removable = WdfTrue;</span><br><span class="line">    pnpCaps.EjectSupported = WdfTrue;</span><br><span class="line">    pnpCaps.SurpriseRemovalOK = WdfTrue;</span><br><span class="line">    pnpCaps.UniqueID = WdfTrue;</span><br><span class="line">    </span><br><span class="line">    WdfDeviceSetPnpCapabilities(DevContext-&gt;Device, &amp;pnpCaps);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���õ�Դ����</span></span><br><span class="line">    WDF_DEVICE_POWER_CAPABILITIES powerCaps;</span><br><span class="line">    WDF_DEVICE_POWER_CAPABILITIES_INIT(&amp;powerCaps);</span><br><span class="line">    powerCaps.DeviceD1 = WdfTrue;</span><br><span class="line">    powerCaps.WakeFromD1 = WdfTrue;</span><br><span class="line">    powerCaps.DeviceState[PowerSystemWorking] = PowerDeviceD0;</span><br><span class="line">    powerCaps.DeviceState[PowerSystemSleeping1] = PowerDeviceD1;</span><br><span class="line">    powerCaps.DeviceState[PowerSystemSleeping2] = PowerDeviceD3;</span><br><span class="line">    powerCaps.DeviceState[PowerSystemSleeping3] = PowerDeviceD3;</span><br><span class="line">    powerCaps.DeviceState[PowerSystemHibernate] = PowerDeviceD3;</span><br><span class="line">    powerCaps.DeviceState[PowerSystemShutdown] = PowerDeviceD3;</span><br><span class="line">    </span><br><span class="line">    WdfDeviceSetPowerCapabilities(DevContext-&gt;Device, &amp;powerCaps);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. �޸��豸״̬Ϊ����</span></span><br><span class="line">    status = WdfDeviceSetDeviceState(</span><br><span class="line">        DevContext-&gt;Device,</span><br><span class="line">        WdfDeviceStateStarted);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ������������(��ѡ)</span></span><br><span class="line">    DECLARE_CONST_UNICODE_STRING(symbolicLinkName, </span><br><span class="line">        <span class="string">L&quot;\\DosDevices\\SDCard&quot;</span>);</span><br><span class="line">    status = WdfDeviceCreateSymbolicLink(</span><br><span class="line">        DevContext-&gt;Device,</span><br><span class="line">        &amp;symbolicLinkName);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 7. ����IO����</span></span><br><span class="line">    status = WdfIoQueueStart(DevContext-&gt;IoQueue);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 8. ֪ͨPnP�������豸�Ѿ���</span></span><br><span class="line">    IoInvalidateDeviceRelations(</span><br><span class="line">        WdfDeviceWdmGetPhysicalDevice(DevContext-&gt;Device),</span><br><span class="line">        BusRelations);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �ڿ���ʼ����ɺ����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... ǰ���ǿ��ĳ�ʼ������ ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ���ɹ���֪ͨϵͳ</span></span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="comment">// �����豸״̬</span></span><br><span class="line">        DevContext-&gt;CardPresent = TRUE;</span><br><span class="line">        DevContext-&gt;CardState = SD_INIT_DATA;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ֪ͨϵͳ���豸����</span></span><br><span class="line">        status = RtsPciNotifyDeviceReady(DevContext);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            RtsPciDebugLog(<span class="string">&quot;SD Card initialized successfully\n&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ��¼�豸��Ϣ</span></span><br><span class="line">            RtsPciLogDeviceInfo(DevContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��¼�豸��Ϣ(���ڵ���)</span></span><br><span class="line">VOID <span class="title function_">RtsPciLogDeviceInfo</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    RtsPciDebugLog(<span class="string">&quot;SD Card Information:\n&quot;</span>);</span><br><span class="line">    RtsPciDebugLog(<span class="string">&quot;  Capacity: %I64d bytes\n&quot;</span>, </span><br><span class="line">        DevContext-&gt;DiskSize.QuadPart);</span><br><span class="line">    RtsPciDebugLog(<span class="string">&quot;  High Capacity: %s\n&quot;</span>, </span><br><span class="line">        DevContext-&gt;HighCapacity ? <span class="string">&quot;Yes&quot;</span> : <span class="string">&quot;No&quot;</span>);</span><br><span class="line">    RtsPciDebugLog(<span class="string">&quot;  Manufacturer ID: %.8s\n&quot;</span>, </span><br><span class="line">        DevContext-&gt;CardCID);</span><br><span class="line">    RtsPciDebugLog(<span class="string">&quot;  Product Name: %.16s\n&quot;</span>, </span><br><span class="line">        &amp;DevContext-&gt;CardCID[<span class="number">8</span>]);</span><br><span class="line">    RtsPciDebugLog(<span class="string">&quot;  RCA: 0x%04X\n&quot;</span>, </span><br><span class="line">        DevContext-&gt;CardRCA);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>֪ͨ����˵����</p>
<ol>
<li><p><strong>�豸�ӿ�ע��</strong></p>
<ul>
<li>ע���׼�����豸�ӿ�</li>
<li>�����ϲ�������Ӧ�ó������豸</li>
</ul>
</li>
<li><p><strong>�豸����������</strong></p>
<ul>
<li>�����豸����Ϊ����</li>
<li>�����豸���ԣ����ƶ��ȣ�</li>
<li>���ó��̺Ͳ�Ʒ��Ϣ</li>
</ul>
</li>
<li><p><strong>PnP��������</strong></p>
<ul>
<li>�����豸Ϊ���ƶ�</li>
<li>֧�ֵ���</li>
<li>֧���Ȳ��</li>
</ul>
</li>
<li><p><strong>��Դ��������</strong></p>
<ul>
<li>����֧�ֵĵ�Դ״̬</li>
<li>���û�������</li>
</ul>
</li>
<li><p><strong>�豸״̬����</strong></p>
<ul>
<li>���豸״̬����Ϊ������</li>
<li>�����������ӣ���ѡ��</li>
</ul>
</li>
<li><p><strong>IO��������</strong></p>
<ul>
<li>�����������</li>
<li>׼������IO����</li>
</ul>
</li>
<li><p><strong>PnP֪ͨ</strong></p>
<ul>
<li>֪ͨPnP�������豸��ϵ�仯</li>
<li>����ϵͳ����ö���豸</li>
</ul>
</li>
</ol>
<p>������ϵͳ�ͻ�ʶ���µĴ洢�豸����������Ӧ���ϲ���������������������ļ�ϵͳ�ȣ���</p>
<h2 id="User-40"><a href="#User-40" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-40"><a href="#AI-claude-3-5-sonnet-40" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ������֧�ֺ������Ż����֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-6"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-6" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 6"></a>WDF SD Host Controller����ʵ����� - Part 6</h1><h2 id="7-����֧��"><a href="#7-����֧��" class="headerlink" title="7. ����֧��"></a>7. ����֧��</h2><h3 id="7-1-WPP����ʵ��"><a href="#7-1-WPP����ʵ��" class="headerlink" title="7.1 WPP����ʵ��"></a>7.1 WPP����ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. ������ٱ�־</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WPP_CONTROL_GUIDS \</span></span><br><span class="line"><span class="meta">    WPP_DEFINE_CONTROL_GUID( \</span></span><br><span class="line"><span class="meta">        RtsPciTraceGuid, \</span></span><br><span class="line"><span class="meta">        (3B2A17E1,91A2,4B2A,A2F3,A324D3B97F12), \</span></span><br><span class="line"><span class="meta">        WPP_DEFINE_BIT(DBG_INIT)     <span class="comment">/* ��ʼ����� */</span> \</span></span><br><span class="line"><span class="meta">        WPP_DEFINE_BIT(DBG_PNP)      <span class="comment">/* ���弴�� */</span> \</span></span><br><span class="line"><span class="meta">        WPP_DEFINE_BIT(DBG_POWER)    <span class="comment">/* ��Դ���� */</span> \</span></span><br><span class="line"><span class="meta">        WPP_DEFINE_BIT(DBG_IOCTL)    <span class="comment">/* IO���� */</span> \</span></span><br><span class="line"><span class="meta">        WPP_DEFINE_BIT(DBG_READ)     <span class="comment">/* ������ */</span> \</span></span><br><span class="line"><span class="meta">        WPP_DEFINE_BIT(DBG_WRITE)    <span class="comment">/* д���� */</span> \</span></span><br><span class="line"><span class="meta">        WPP_DEFINE_BIT(DBG_DMA)      <span class="comment">/* DMA���� */</span> \</span></span><br><span class="line"><span class="meta">        WPP_DEFINE_BIT(DBG_INT)      <span class="comment">/* �жϴ��� */</span> \</span></span><br><span class="line"><span class="meta">        WPP_DEFINE_BIT(DBG_ERROR)    <span class="comment">/* ������ */</span> \</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ������ٺ���</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WPP_LEVEL_FLAGS_LOGGER(level,flags) WPP_LEVEL_LOGGER(flags)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WPP_LEVEL_FLAGS_ENABLED(level,flags) \</span></span><br><span class="line"><span class="meta">    (WPP_LEVEL_ENABLED(flags) &amp;&amp; WPP_CONTROL(WPP_BIT_ ## flags).Level &gt;= level)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. ʵ�ָ��ٺ�</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TracePrint(level,flags,msg,...) \</span></span><br><span class="line"><span class="meta">    WPP_LEVEL_FLAGS_LOGGER(level,flags) ( \</span></span><br><span class="line"><span class="meta">        WPP_LEVEL_FLAGS_ENABLED(level,flags) ? \</span></span><br><span class="line"><span class="meta">            WPP_LEVEL_FLAGS_LOGGER(level,flags)(flags,msg,__VA_ARGS__) : 0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. ���ٺ���ʵ��</span></span><br><span class="line">VOID <span class="title function_">RtsPciTraceInit</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;Initializing device 0x%p\n&quot;</span>, DevContext-&gt;Device);</span><br><span class="line">        </span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;Register base: 0x%p, Length: %d\n&quot;</span>,</span><br><span class="line">        DevContext-&gt;RegisterBase,</span><br><span class="line">        DevContext-&gt;RegisterLength);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">RtsPciTraceCommand</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PSD_COMMAND Cmd</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_IOCTL,</span><br><span class="line">        <span class="string">&quot;Sending CMD%d, Arg=0x%08X, Resp=%d\n&quot;</span>,</span><br><span class="line">        Cmd-&gt;Index, Cmd-&gt;Argument, Cmd-&gt;ResponseType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">RtsPciTraceError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ NTSTATUS Status,</span></span><br><span class="line"><span class="params">    _In_ PCSTR Function,</span></span><br><span class="line"><span class="params">    _In_ ULONG Line</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    TracePrint(TRACE_LEVEL_ERROR, DBG_ERROR,</span><br><span class="line">        <span class="string">&quot;%s:%d - Error 0x%08X\n&quot;</span>,</span><br><span class="line">        Function, Line, Status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="7-2-���ܼ�����ʵ��"><a href="#7-2-���ܼ�����ʵ��" class="headerlink" title="7.2 ���ܼ�����ʵ��"></a>7.2 ���ܼ�����ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. ���ܼ������ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">RTSPC_PERFORMANCE_DATA</span> &#123;</span></span><br><span class="line">    <span class="comment">// ����ͳ��</span></span><br><span class="line">    LARGE_INTEGER TotalBytesRead;</span><br><span class="line">    LARGE_INTEGER TotalBytesWritten;</span><br><span class="line">    ULONG TotalReadsCompleted;</span><br><span class="line">    ULONG TotalWritesCompleted;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ͳ��</span></span><br><span class="line">    ULONG CommandErrors;</span><br><span class="line">    ULONG DataErrors;</span><br><span class="line">    ULONG CrcErrors;</span><br><span class="line">    ULONG TimeoutErrors;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">    LARGE_INTEGER TotalReadTime;      <span class="comment">// 100ns��λ</span></span><br><span class="line">    LARGE_INTEGER TotalWriteTime;</span><br><span class="line">    ULONG MaxReadLatency;            <span class="comment">// ����</span></span><br><span class="line">    ULONG MaxWriteLatency;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMAͳ��</span></span><br><span class="line">    ULONG DmaTransfersCompleted;</span><br><span class="line">    ULONG DmaErrors;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ж�ͳ��</span></span><br><span class="line">    ULONG InterruptsServiced;</span><br><span class="line">    ULONG DpcQueued;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դͳ��</span></span><br><span class="line">    ULONG D0Transitions;</span><br><span class="line">    ULONG D1Transitions;</span><br><span class="line">    ULONG D2Transitions;</span><br><span class="line">    ULONG D3Transitions;</span><br><span class="line">&#125; RTSPC_PERFORMANCE_DATA, *PRTSPC_PERFORMANCE_DATA;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ���������ռ�</span></span><br><span class="line">VOID <span class="title function_">RtsPciUpdatePerformanceData</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ BOOLEAN IsRead,</span></span><br><span class="line"><span class="params">    _In_ ULONG Length,</span></span><br><span class="line"><span class="params">    _In_ LARGE_INTEGER StartTime,</span></span><br><span class="line"><span class="params">    _In_ LARGE_INTEGER EndTime</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    LARGE_INTEGER timeDiff;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡ������������������</span></span><br><span class="line">    KeAcquireSpinLock(&amp;DevContext-&gt;PerfLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (IsRead) &#123;</span><br><span class="line">        DevContext-&gt;PerfData.TotalBytesRead.QuadPart += Length;</span><br><span class="line">        DevContext-&gt;PerfData.TotalReadsCompleted++;</span><br><span class="line">        </span><br><span class="line">        timeDiff.QuadPart = EndTime.QuadPart - StartTime.QuadPart;</span><br><span class="line">        DevContext-&gt;PerfData.TotalReadTime.QuadPart += timeDiff.QuadPart;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ��������ӳ�</span></span><br><span class="line">        ULONG latencyMs = (ULONG)(timeDiff.QuadPart / <span class="number">10000</span>); <span class="comment">// ת��Ϊ����</span></span><br><span class="line">        <span class="keyword">if</span> (latencyMs &gt; DevContext-&gt;PerfData.MaxReadLatency) &#123;</span><br><span class="line">            DevContext-&gt;PerfData.MaxReadLatency = latencyMs;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        DevContext-&gt;PerfData.TotalBytesWritten.QuadPart += Length;</span><br><span class="line">        DevContext-&gt;PerfData.TotalWritesCompleted++;</span><br><span class="line">        </span><br><span class="line">        timeDiff.QuadPart = EndTime.QuadPart - StartTime.QuadPart;</span><br><span class="line">        DevContext-&gt;PerfData.TotalWriteTime.QuadPart += timeDiff.QuadPart;</span><br><span class="line">        </span><br><span class="line">        ULONG latencyMs = (ULONG)(timeDiff.QuadPart / <span class="number">10000</span>);</span><br><span class="line">        <span class="keyword">if</span> (latencyMs &gt; DevContext-&gt;PerfData.MaxWriteLatency) &#123;</span><br><span class="line">            DevContext-&gt;PerfData.MaxWriteLatency = latencyMs;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;DevContext-&gt;PerfLock, oldIrql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. �������ݲ�ѯ�ӿ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciGetPerformanceData</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _Out_ PRTSPC_PERFORMANCE_DATA PerfData</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    KeAcquireSpinLock(&amp;DevContext-&gt;PerfLock, &amp;oldIrql);</span><br><span class="line">    RtlCopyMemory(PerfData, &amp;DevContext-&gt;PerfData, </span><br><span class="line">                  <span class="keyword">sizeof</span>(RTSPC_PERFORMANCE_DATA));</span><br><span class="line">    KeReleaseSpinLock(&amp;DevContext-&gt;PerfLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. ���ܼ��IOCTL����</span></span><br><span class="line">VOID <span class="title function_">RtsPciHandlePerformanceQuery</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PRTSPC_PERFORMANCE_DATA perfData;</span><br><span class="line">    <span class="type">size_t</span> bufferSize;</span><br><span class="line">    </span><br><span class="line">    status = WdfRequestRetrieveOutputBuffer(Request,</span><br><span class="line">                                          <span class="keyword">sizeof</span>(RTSPC_PERFORMANCE_DATA),</span><br><span class="line">                                          &amp;perfData,</span><br><span class="line">                                          &amp;bufferSize);</span><br><span class="line">                                          </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        WdfRequestComplete(Request, status);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    status = RtsPciGetPerformanceData(DevContext, perfData);</span><br><span class="line">    </span><br><span class="line">    WdfRequestCompleteWithInformation(Request,</span><br><span class="line">                                    status,</span><br><span class="line">                                    <span class="keyword">sizeof</span>(RTSPC_PERFORMANCE_DATA));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="7-3-��Ͻӿ�ʵ��"><a href="#7-3-��Ͻӿ�ʵ��" class="headerlink" title="7.3 ��Ͻӿ�ʵ��"></a>7.3 ��Ͻӿ�ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. ��������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">RTSPC_DIAGNOSTIC_COMMAND</span> &#123;</span></span><br><span class="line">    DiagCommandDumpRegisters = <span class="number">0</span>,</span><br><span class="line">    DiagCommandTestDMA,</span><br><span class="line">    DiagCommandResetController,</span><br><span class="line">    DiagCommandToggleDebug,</span><br><span class="line">    DiagCommandClearStats</span><br><span class="line">&#125; RTSPC_DIAGNOSTIC_COMMAND;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. �Ĵ���ת��ʵ��</span></span><br><span class="line">VOID <span class="title function_">RtsPciDumpRegisters</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;=== Register Dump ===\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;HOST_CTRL:     0x%08X\n&quot;</span>,</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_CTRL_REG));</span><br><span class="line">        </span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;INT_STATUS:    0x%08X\n&quot;</span>,</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_INT_STATUS));</span><br><span class="line">        </span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;INT_ENABLE:    0x%08X\n&quot;</span>,</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_INT_ENABLE));</span><br><span class="line">        </span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;CLOCK_CTRL:    0x%08X\n&quot;</span>,</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_CLOCK_CTRL));</span><br><span class="line">        </span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;DMA_ADDR:      0x%08X\n&quot;</span>,</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_DMA_ADDR));</span><br><span class="line">        </span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;BLOCK_SIZE:    0x%08X\n&quot;</span>,</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_BLOCK_SIZE));</span><br><span class="line">        </span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;BLOCK_COUNT:   0x%08X\n&quot;</span>,</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_BLOCK_COUNT));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. DMA����ʵ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciTestDMA</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PVOID testBuffer;</span><br><span class="line">    PHYSICAL_ADDRESS testBufferPA;</span><br><span class="line">    ULONG testPattern = <span class="number">0xA5A5A5A5</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������Ի�����</span></span><br><span class="line">    testBuffer = MmAllocateContiguousMemory(</span><br><span class="line">        PAGE_SIZE,</span><br><span class="line">        DevContext-&gt;DmaBufferPA);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!testBuffer) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������ģʽ</span></span><br><span class="line">    RtlFillMemory(testBuffer, PAGE_SIZE, testPattern);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ִ��DMA����</span></span><br><span class="line">    testBufferPA = MmGetPhysicalAddress(testBuffer);</span><br><span class="line">    </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_ADDR,</span><br><span class="line">        testBufferPA.LowPart);</span><br><span class="line">        </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_ADDR_HIGH,</span><br><span class="line">        testBufferPA.HighPart);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ����DMA����</span></span><br><span class="line">    status = RtsPciStartDmaTest(DevContext);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����</span></span><br><span class="line">    MmFreeContiguousMemory(testBuffer);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. ��������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleDiagnosticCommand</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ RTSPC_DIAGNOSTIC_COMMAND Command</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (Command) &#123;</span><br><span class="line">        <span class="keyword">case</span> DiagCommandDumpRegisters:</span><br><span class="line">            RtsPciDumpRegisters(DevContext);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DiagCommandTestDMA:</span><br><span class="line">            status = RtsPciTestDMA(DevContext);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DiagCommandResetController:</span><br><span class="line">            status = RtsPciResetController(DevContext);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DiagCommandToggleDebug:</span><br><span class="line">            DevContext-&gt;DebugFlags ^= <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DiagCommandClearStats:</span><br><span class="line">            RtlZeroMemory(&amp;DevContext-&gt;PerfData,</span><br><span class="line">                         <span class="keyword">sizeof</span>(RTSPC_PERFORMANCE_DATA));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            status = STATUS_INVALID_PARAMETER;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[���� - ��һ���ֽ���ϸ���ܴ������ͻָ�����]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-41"><a href="#User-41" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-41"><a href="#AI-claude-3-5-sonnet-41" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���������ͻָ����Ʋ��֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-7"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-7" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 7"></a>WDF SD Host Controller����ʵ����� - Part 7</h1><h2 id="8-�������ͻָ�����"><a href="#8-�������ͻָ�����" class="headerlink" title="8. �������ͻָ�����"></a>8. �������ͻָ�����</h2><h3 id="8-1-�������Ͷ���ʹ���"><a href="#8-1-�������Ͷ���ʹ���" class="headerlink" title="8.1 �������Ͷ���ʹ���"></a>8.1 �������Ͷ���ʹ���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �������Ͷ���</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">RTSPC_ERROR_TYPE</span> &#123;</span></span><br><span class="line">    ErrorTypeCommand = <span class="number">0</span>,    <span class="comment">// �������</span></span><br><span class="line">    ErrorTypeData,           <span class="comment">// ���ݴ���</span></span><br><span class="line">    ErrorTypeDMA,           <span class="comment">// DMA����</span></span><br><span class="line">    ErrorTypeTimeout,        <span class="comment">// ��ʱ����</span></span><br><span class="line">    ErrorTypeCRC,           <span class="comment">// CRC����</span></span><br><span class="line">    ErrorTypeHardware,      <span class="comment">// Ӳ������</span></span><br><span class="line">    ErrorTypeProtocol       <span class="comment">// Э�����</span></span><br><span class="line">&#125; RTSPC_ERROR_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ������������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ERROR_HANDLING_CONTEXT</span> &#123;</span></span><br><span class="line">    RTSPC_ERROR_TYPE ErrorType;</span><br><span class="line">    ULONG ErrorStatus;</span><br><span class="line">    ULONG RetryCount;</span><br><span class="line">    BOOLEAN NeedsReset;</span><br><span class="line">    LARGE_INTEGER ErrorTime;</span><br><span class="line">    NTSTATUS LastStatus;</span><br><span class="line">&#125; ERROR_HANDLING_CONTEXT, *PERROR_HANDLING_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ������������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ RTSPC_ERROR_TYPE ErrorType,</span></span><br><span class="line"><span class="params">    _In_ ULONG ErrorStatus</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    ERROR_HANDLING_CONTEXT errorCtx = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ������������</span></span><br><span class="line">    errorCtx.ErrorType = ErrorType;</span><br><span class="line">    errorCtx.ErrorStatus = ErrorStatus;</span><br><span class="line">    KeQuerySystemTime(&amp;errorCtx.ErrorTime);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��¼������־</span></span><br><span class="line">    RtsPciLogError(DevContext, &amp;errorCtx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ݴ������ʹ���</span></span><br><span class="line">    <span class="keyword">switch</span> (ErrorType) &#123;</span><br><span class="line">        <span class="keyword">case</span> ErrorTypeCommand:</span><br><span class="line">            status = RtsPciHandleCommandError(DevContext, &amp;errorCtx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ErrorTypeData:</span><br><span class="line">            status = RtsPciHandleDataError(DevContext, &amp;errorCtx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ErrorTypeDMA:</span><br><span class="line">            status = RtsPciHandleDMAError(DevContext, &amp;errorCtx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ErrorTypeTimeout:</span><br><span class="line">            status = RtsPciHandleTimeoutError(DevContext, &amp;errorCtx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ErrorTypeCRC:</span><br><span class="line">            status = RtsPciHandleCRCError(DevContext, &amp;errorCtx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ErrorTypeHardware:</span><br><span class="line">            status = RtsPciHandleHardwareError(DevContext, &amp;errorCtx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            status = STATUS_DEVICE_PROTOCOL_ERROR;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���´���ͳ��</span></span><br><span class="line">    InterlockedIncrement(&amp;DevContext-&gt;PerfData.ErrorCount);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-���������ʵ��"><a href="#8-2-���������ʵ��" class="headerlink" title="8.2 ���������ʵ��"></a>8.2 ���������ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ���������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleCommandError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PERROR_HANDLING_CONTEXT ErrorCtx</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��λ������</span></span><br><span class="line">    status = RtsPciResetCommandLine(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����Ƿ���Ҫ����</span></span><br><span class="line">    <span class="keyword">if</span> (ErrorCtx-&gt;RetryCount &lt; MAX_CMD_RETRY_COUNT) &#123;</span><br><span class="line">        ErrorCtx-&gt;RetryCount++;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ���·�������</span></span><br><span class="line">        <span class="keyword">if</span> (DevContext-&gt;CurrentCommand) &#123;</span><br><span class="line">            status = RtsPciSendCommand(DevContext, </span><br><span class="line">                                     DevContext-&gt;CurrentCommand);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        status = STATUS_DEVICE_PROTOCOL_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DMA������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleDMAError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PERROR_HANDLING_CONTEXT ErrorCtx</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ֹͣDMA����</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_CTRL,</span><br><span class="line">        <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. ��λDMA������</span></span><br><span class="line">    status = RtsPciResetDMA(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��������DMA</span></span><br><span class="line">    <span class="keyword">if</span> (DevContext-&gt;CurrentRequest) &#123;</span><br><span class="line">        status = RtsPciSetupDmaForRequest(</span><br><span class="line">            DevContext,</span><br><span class="line">            DevContext-&gt;CurrentRequest,</span><br><span class="line">            DevContext-&gt;CurrentTransferIsWrite);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʱ������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleTimeoutError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PERROR_HANDLING_CONTEXT ErrorCtx</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��鿨�Ƿ���</span></span><br><span class="line">    <span class="keyword">if</span> (!RtsPciIsCardPresent(DevContext)) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_NO_MEDIA;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��λ������</span></span><br><span class="line">    status = RtsPciResetController(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���³�ʼ����</span></span><br><span class="line">    status = RtsPciInitializeCard(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���Ե�ǰ����</span></span><br><span class="line">    <span class="keyword">if</span> (DevContext-&gt;CurrentRequest) &#123;</span><br><span class="line">        status = RtsPciRetryCurrentRequest(DevContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-3-�ָ�����ʵ��"><a href="#8-3-�ָ�����ʵ��" class="headerlink" title="8.3 �ָ�����ʵ��"></a>8.3 �ָ�����ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��������λ</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciResetController</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    ULONG controlReg;</span><br><span class="line">    LARGE_INTEGER timeout;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����λ������</span></span><br><span class="line">    controlReg = READ_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CTRL_REG);</span><br><span class="line">    controlReg |= HOST_CTRL_RESET;</span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CTRL_REG,</span><br><span class="line">        controlReg);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. �ȴ���λ���</span></span><br><span class="line">    KeQuerySystemTime(&amp;timeout);</span><br><span class="line">    timeout.QuadPart += (<span class="number">1</span> * <span class="number">1000</span> * <span class="number">10000</span>); <span class="comment">// 1��</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        controlReg = READ_REGISTER_ULONG(</span><br><span class="line">            DevContext-&gt;RegisterBase + HOST_CTRL_REG);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (!(controlReg &amp; HOST_CTRL_RESET)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        KeStallExecutionProcessor(<span class="number">100</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (KeQuerySystemTime(&amp;timeout) &lt; <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (controlReg &amp; HOST_CTRL_RESET) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_DEVICE_HARDWARE_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �ָ�����������</span></span><br><span class="line">    status = RtsPciInitializeController(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �������Ի���</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciRetryCurrentRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_REQUEST_PARAMETERS params;</span><br><span class="line">    LARGE_INTEGER offset;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!DevContext-&gt;CurrentRequest) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ�������</span></span><br><span class="line">    WDF_REQUEST_PARAMETERS_INIT(&amp;params);</span><br><span class="line">    WdfRequestGetParameters(DevContext-&gt;CurrentRequest, &amp;params);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (params.Type == WdfRequestTypeRead) &#123;</span><br><span class="line">        offset.QuadPart = params.Parameters.Read.DeviceOffset;</span><br><span class="line">        status = RtsPciPrepareTransfer(</span><br><span class="line">            DevContext,</span><br><span class="line">            DevContext-&gt;CurrentRequest,</span><br><span class="line">            offset.QuadPart / DevContext-&gt;BlockSize,</span><br><span class="line">            params.Parameters.Read.Length / DevContext-&gt;BlockSize,</span><br><span class="line">            FALSE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        offset.QuadPart = params.Parameters.Write.DeviceOffset;</span><br><span class="line">        status = RtsPciPrepareTransfer(</span><br><span class="line">            DevContext,</span><br><span class="line">            DevContext-&gt;CurrentRequest,</span><br><span class="line">            offset.QuadPart / DevContext-&gt;BlockSize,</span><br><span class="line">            params.Parameters.Write.Length / DevContext-&gt;BlockSize,</span><br><span class="line">            TRUE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-4-����ָ�����"><a href="#8-4-����ָ�����" class="headerlink" title="8.4 ����ָ�����"></a>8.4 ����ָ�����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ����ָ����Զ���</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ERROR_RECOVERY_POLICY</span> &#123;</span></span><br><span class="line">    ULONG MaxCommandRetries;</span><br><span class="line">    ULONG MaxDataRetries;</span><br><span class="line">    ULONG MaxDMARetries;</span><br><span class="line">    BOOLEAN ResetOnTimeout;</span><br><span class="line">    BOOLEAN ReInitOnHardwareError;</span><br><span class="line">    ULONG MinRetryDelayMs;</span><br><span class="line">&#125; ERROR_RECOVERY_POLICY, *PERROR_RECOVERY_POLICY;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����ָ�����ʵ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciExecuteRecoveryPolicy</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PERROR_HANDLING_CONTEXT ErrorCtx</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    ERROR_RECOVERY_POLICY policy = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ�ָ�����</span></span><br><span class="line">    RtsPciGetRecoveryPolicy(DevContext, &amp;policy);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ������Դ���</span></span><br><span class="line">    <span class="keyword">switch</span> (ErrorCtx-&gt;ErrorType) &#123;</span><br><span class="line">        <span class="keyword">case</span> ErrorTypeCommand:</span><br><span class="line">            <span class="keyword">if</span> (ErrorCtx-&gt;RetryCount &lt; policy.MaxCommandRetries) &#123;</span><br><span class="line">                <span class="comment">// �ӳٺ�����</span></span><br><span class="line">                KeStallExecutionProcessor(</span><br><span class="line">                    policy.MinRetryDelayMs * <span class="number">1000</span>);</span><br><span class="line">                status = RtsPciRetryCurrentRequest(DevContext);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ErrorTypeTimeout:</span><br><span class="line">            <span class="keyword">if</span> (policy.ResetOnTimeout) &#123;</span><br><span class="line">                status = RtsPciResetController(DevContext);</span><br><span class="line">                <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">                    status = RtsPciRetryCurrentRequest(DevContext);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ErrorTypeHardware:</span><br><span class="line">            <span class="keyword">if</span> (policy.ReInitOnHardwareError) &#123;</span><br><span class="line">                status = RtsPciReInitializeDevice(DevContext);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[���� - ��һ���ֽ���ϸ�����豸״̬��غ�ά��]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-42"><a href="#User-42" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-42"><a href="#AI-claude-3-5-sonnet-42" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���豸״̬��غ�ά�����֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-8"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-8" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 8"></a>WDF SD Host Controller����ʵ����� - Part 8</h1><h2 id="9-�豸״̬��غ�ά��"><a href="#9-�豸״̬��غ�ά��" class="headerlink" title="9. �豸״̬��غ�ά��"></a>9. �豸״̬��غ�ά��</h2><h3 id="9-1-�豸״̬����͹���"><a href="#9-1-�豸״̬����͹���" class="headerlink" title="9.1 �豸״̬����͹���"></a>9.1 �豸״̬����͹���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �豸״̬����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">DEVICE_STATE</span> &#123;</span></span><br><span class="line">    DeviceStateUninitialized = <span class="number">0</span>,</span><br><span class="line">    DeviceStateInitializing,</span><br><span class="line">    DeviceStateRunning,</span><br><span class="line">    DeviceStatePaused,</span><br><span class="line">    DeviceStateStopped,</span><br><span class="line">    DeviceStateRemoved,</span><br><span class="line">    DeviceStateFailed</span><br><span class="line">&#125; DEVICE_STATE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �豸����״̬</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_HEALTH_INFO</span> &#123;</span></span><br><span class="line">    DEVICE_STATE CurrentState;</span><br><span class="line">    ULONG OperationalTime;          <span class="comment">// ����ʱ��(��)</span></span><br><span class="line">    ULONG Temperature;              <span class="comment">// �¶�</span></span><br><span class="line">    ULONG VoltageLevel;            <span class="comment">// ��ѹ����</span></span><br><span class="line">    ULONG ErrorCount;              <span class="comment">// �������</span></span><br><span class="line">    BOOLEAN IsOverheated;          <span class="comment">// ���ȱ�־</span></span><br><span class="line">    BOOLEAN IsVoltageLow;          <span class="comment">// ��ѹ�ͱ�־</span></span><br><span class="line">    LARGE_INTEGER LastCheckTime;    <span class="comment">// �ϴμ��ʱ��</span></span><br><span class="line">&#125; DEVICE_HEALTH_INFO, *PDEVICE_HEALTH_INFO;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �豸״̬������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_STATE_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    DEVICE_STATE CurrentState;</span><br><span class="line">    DEVICE_HEALTH_INFO HealthInfo;</span><br><span class="line">    WDFTIMER HealthCheckTimer;</span><br><span class="line">    KEVENT StateChangeEvent;</span><br><span class="line">    KSPIN_LOCK StateLock;</span><br><span class="line">&#125; DEVICE_STATE_MANAGER, *PDEVICE_STATE_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ��״̬������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeStateManager</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_TIMER_CONFIG timerConfig;</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES timerAttributes;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ʼ��״̬�������ṹ</span></span><br><span class="line">    DevContext-&gt;StateManager = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(DEVICE_STATE_MANAGER),</span><br><span class="line">        <span class="string">&#x27;MSPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!DevContext-&gt;StateManager) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ�������ֶ�</span></span><br><span class="line">    DevContext-&gt;StateManager-&gt;DevContext = DevContext;</span><br><span class="line">    DevContext-&gt;StateManager-&gt;CurrentState = DeviceStateUninitialized;</span><br><span class="line">    KeInitializeSpinLock(&amp;DevContext-&gt;StateManager-&gt;StateLock);</span><br><span class="line">    KeInitializeEvent(&amp;DevContext-&gt;StateManager-&gt;StateChangeEvent,</span><br><span class="line">                     NotificationEvent,</span><br><span class="line">                     FALSE);</span><br><span class="line">                     </span><br><span class="line">    <span class="comment">// 3. ����������鶨ʱ��</span></span><br><span class="line">    WDF_TIMER_CONFIG_INIT_PERIODIC(</span><br><span class="line">        &amp;timerConfig,</span><br><span class="line">        RtsPciHealthCheckTimerFunc,</span><br><span class="line">        HEALTH_CHECK_INTERVAL);  <span class="comment">// ����30��</span></span><br><span class="line">        </span><br><span class="line">    WDF_OBJECT_ATTRIBUTES_INIT(&amp;timerAttributes);</span><br><span class="line">    timerAttributes.ParentObject = DevContext-&gt;Device;</span><br><span class="line">    </span><br><span class="line">    status = WdfTimerCreate(</span><br><span class="line">        &amp;timerConfig,</span><br><span class="line">        &amp;timerAttributes,</span><br><span class="line">        &amp;DevContext-&gt;StateManager-&gt;HealthCheckTimer);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        ExFreePool(DevContext-&gt;StateManager);</span><br><span class="line">        DevContext-&gt;StateManager = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="9-2-�������ʵ��"><a href="#9-2-�������ʵ��" class="headerlink" title="9.2 �������ʵ��"></a>9.2 �������ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ������鶨ʱ���ص�</span></span><br><span class="line">VOID <span class="title function_">RtsPciHealthCheckTimerFunc</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFTIMER Timer</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    PDEVICE_STATE_MANAGER stateManager;</span><br><span class="line">    DEVICE_HEALTH_INFO healthInfo = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(WdfTimerGetParentObject(Timer));</span><br><span class="line">    stateManager = devContext-&gt;StateManager;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡӲ��״̬</span></span><br><span class="line">    RtsPciGetHardwareStatus(devContext, &amp;healthInfo);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���½�����Ϣ</span></span><br><span class="line">    KeAcquireSpinLock(&amp;stateManager-&gt;StateLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    healthInfo.OperationalTime = </span><br><span class="line">        (ULONG)((KeQueryInterruptTime() - </span><br><span class="line">                 devContext-&gt;StartTime) / <span class="number">10000000</span>); <span class="comment">// ת��Ϊ��</span></span><br><span class="line">                 </span><br><span class="line">    healthInfo.ErrorCount = devContext-&gt;PerfData.ErrorCount;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����¶�</span></span><br><span class="line">    <span class="keyword">if</span> (healthInfo.Temperature &gt; TEMPERATURE_THRESHOLD) &#123;</span><br><span class="line">        healthInfo.IsOverheated = TRUE;</span><br><span class="line">        RtsPciHandleOverheating(devContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����ѹ</span></span><br><span class="line">    <span class="keyword">if</span> (healthInfo.VoltageLevel &lt; VOLTAGE_THRESHOLD) &#123;</span><br><span class="line">        healthInfo.IsVoltageLow = TRUE;</span><br><span class="line">        RtsPciHandleLowVoltage(devContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����״̬</span></span><br><span class="line">    stateManager-&gt;HealthInfo = healthInfo;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;stateManager-&gt;StateLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ��¼������־</span></span><br><span class="line">    RtsPciLogHealthStatus(devContext, &amp;healthInfo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ȡӲ��״̬</span></span><br><span class="line">VOID <span class="title function_">RtsPciGetHardwareStatus</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _Out_ PDEVICE_HEALTH_INFO HealthInfo</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ��ȡ�¶ȼĴ���</span></span><br><span class="line">    HealthInfo-&gt;Temperature = READ_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_TEMPERATURE_REG);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. ��ȡ��ѹ�Ĵ���</span></span><br><span class="line">    HealthInfo-&gt;VoltageLevel = READ_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_VOLTAGE_REG);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. ��ȡ��ǰʱ��</span></span><br><span class="line">    KeQuerySystemTime(&amp;HealthInfo-&gt;LastCheckTime);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �����������</span></span><br><span class="line">VOID <span class="title function_">RtsPciHandleOverheating</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ����ʱ��Ƶ��</span></span><br><span class="line">    RtsPciSetClock(DevContext, REDUCED_CLOCK_FREQ);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ֪ͨϵͳ</span></span><br><span class="line">    IoReportTargetDeviceChangeAsynchronous(</span><br><span class="line">        WdfDeviceWdmGetPhysicalDevice(DevContext-&gt;Device),</span><br><span class="line">        &amp;GUID_DEVICE_THERMAL_ZONE_ALERT,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. ��¼�¼���־</span></span><br><span class="line">    RtsPciLogEvent(</span><br><span class="line">        DevContext,</span><br><span class="line">        EVENTLOG_WARNING_TYPE,</span><br><span class="line">        EVENT_DEVICE_OVERHEATING,</span><br><span class="line">        <span class="string">&quot;Device temperature exceeds threshold&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="9-3-״̬ת������"><a href="#9-3-״̬ת������" class="headerlink" title="9.3 ״̬ת������"></a>9.3 ״̬ת������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ״̬ת������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciChangeDeviceState</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ DEVICE_STATE NewState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PDEVICE_STATE_MANAGER stateManager = DevContext-&gt;StateManager;</span><br><span class="line">    DEVICE_STATE oldState;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ״̬��</span></span><br><span class="line">    KeAcquireSpinLock(&amp;stateManager-&gt;StateLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    oldState = stateManager-&gt;CurrentState;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���״̬ת���Ƿ���Ч</span></span><br><span class="line">    <span class="keyword">if</span> (!RtsPciIsValidStateTransition(oldState, NewState)) &#123;</span><br><span class="line">        KeReleaseSpinLock(&amp;stateManager-&gt;StateLock, oldIrql);</span><br><span class="line">        <span class="keyword">return</span> STATUS_INVALID_DEVICE_STATE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ִ��״̬ת��ǰ�Ĳ���</span></span><br><span class="line">    status = RtsPciPreStateChange(DevContext, oldState, NewState);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        KeReleaseSpinLock(&amp;stateManager-&gt;StateLock, oldIrql);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����״̬</span></span><br><span class="line">    stateManager-&gt;CurrentState = NewState;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. �ͷ���</span></span><br><span class="line">    KeReleaseSpinLock(&amp;stateManager-&gt;StateLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ִ��״̬ת����Ĳ���</span></span><br><span class="line">    status = RtsPciPostStateChange(DevContext, oldState, NewState);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7. ֪ͨ״̬�仯</span></span><br><span class="line">    KeSetEvent(&amp;stateManager-&gt;StateChangeEvent, <span class="number">0</span>, FALSE);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ״̬ת��ǰ�Ĳ���</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciPreStateChange</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ DEVICE_STATE OldState,</span></span><br><span class="line"><span class="params">    _In_ DEVICE_STATE NewState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (NewState) &#123;</span><br><span class="line">        <span class="keyword">case</span> DeviceStatePaused:</span><br><span class="line">            <span class="comment">// ��ͣIO����</span></span><br><span class="line">            WdfIoQueueStop(DevContext-&gt;IoQueue,</span><br><span class="line">                          <span class="literal">NULL</span>,</span><br><span class="line">                          <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DeviceStateStopped:</span><br><span class="line">            <span class="comment">// ֹͣ���л</span></span><br><span class="line">            status = RtsPciStopAllActivity(DevContext);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DeviceStateRemoved:</span><br><span class="line">            <span class="comment">// ׼���Ƴ��豸</span></span><br><span class="line">            status = RtsPciPrepareForRemoval(DevContext);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ״̬ת����Ĳ���</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciPostStateChange</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ DEVICE_STATE OldState,</span></span><br><span class="line"><span class="params">    _In_ DEVICE_STATE NewState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (NewState) &#123;</span><br><span class="line">        <span class="keyword">case</span> DeviceStateRunning:</span><br><span class="line">            <span class="comment">// ����IO����</span></span><br><span class="line">            WdfIoQueueStart(DevContext-&gt;IoQueue);</span><br><span class="line">            <span class="comment">// �����������</span></span><br><span class="line">            WdfTimerStart(</span><br><span class="line">                DevContext-&gt;StateManager-&gt;HealthCheckTimer,</span><br><span class="line">                WDF_REL_TIMEOUT_IN_SEC(HEALTH_CHECK_INTERVAL));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DeviceStateFailed:</span><br><span class="line">            <span class="comment">// ��¼������־</span></span><br><span class="line">            RtsPciLogEvent(</span><br><span class="line">                DevContext,</span><br><span class="line">                EVENTLOG_ERROR_TYPE,</span><br><span class="line">                EVENT_DEVICE_FAILED,</span><br><span class="line">                <span class="string">&quot;Device entered failed state&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>[���� - ��һ���ֽ���ϸ�����豸��Դ�����ĸ߼�����]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-43"><a href="#User-43" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-43"><a href="#AI-claude-3-5-sonnet-43" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���豸��Դ�����ĸ߼����Բ��֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-9"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-9" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 9"></a>WDF SD Host Controller����ʵ����� - Part 9</h1><h2 id="10-�߼���Դ����"><a href="#10-�߼���Դ����" class="headerlink" title="10. �߼���Դ����"></a>10. �߼���Դ����</h2><h3 id="10-1-��̬��Դ����"><a href="#10-1-��̬��Դ����" class="headerlink" title="10.1 ��̬��Դ����"></a>10.1 ��̬��Դ����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��Դ��������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">POWER_POLICY_CONFIG</span> &#123;</span></span><br><span class="line">    ULONG IdleTimeoutInMs;          <span class="comment">// ���г�ʱʱ��</span></span><br><span class="line">    BOOLEAN AllowWakeFromS0;        <span class="comment">// ������S0����</span></span><br><span class="line">    BOOLEAN AllowWakeFromSx;        <span class="comment">// ������Sx����</span></span><br><span class="line">    BOOLEAN EnableIdleDetection;    <span class="comment">// ���ÿ��м��</span></span><br><span class="line">    ULONG WakeSignals;              <span class="comment">// �����ź�����</span></span><br><span class="line">    DEVICE_POWER_STATE MinPowerState; <span class="comment">// ���������Դ״̬</span></span><br><span class="line">&#125; POWER_POLICY_CONFIG, *PPOWER_POLICY_CONFIG;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��̬���Ĺ�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">POWER_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    POWER_POLICY_CONFIG PolicyConfig;</span><br><span class="line">    DEVICE_POWER_STATE CurrentPowerState;</span><br><span class="line">    ULONG ActivityCount;            <span class="comment">// �����</span></span><br><span class="line">    LARGE_INTEGER LastActivityTime; <span class="comment">// ���ʱ��</span></span><br><span class="line">    KSPIN_LOCK PowerLock;</span><br><span class="line">    WDFTIMER IdleTimer;</span><br><span class="line">&#125; POWER_MANAGER, *PPOWER_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ����Դ������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializePowerManager</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_TIMER_CONFIG timerConfig;</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES timerAttributes;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����Դ������</span></span><br><span class="line">    DevContext-&gt;PowerManager = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(POWER_MANAGER),</span><br><span class="line">        <span class="string">&#x27;MPPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!DevContext-&gt;PowerManager) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ����������</span></span><br><span class="line">    RtlZeroMemory(DevContext-&gt;PowerManager, <span class="keyword">sizeof</span>(POWER_MANAGER));</span><br><span class="line">    DevContext-&gt;PowerManager-&gt;DevContext = DevContext;</span><br><span class="line">    KeInitializeSpinLock(&amp;DevContext-&gt;PowerManager-&gt;PowerLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����Ĭ�ϲ���</span></span><br><span class="line">    DevContext-&gt;PowerManager-&gt;PolicyConfig.IdleTimeoutInMs = <span class="number">1000</span>; <span class="comment">// 1��</span></span><br><span class="line">    DevContext-&gt;PowerManager-&gt;PolicyConfig.AllowWakeFromS0 = TRUE;</span><br><span class="line">    DevContext-&gt;PowerManager-&gt;PolicyConfig.EnableIdleDetection = TRUE;</span><br><span class="line">    DevContext-&gt;PowerManager-&gt;PolicyConfig.MinPowerState = PowerDeviceD2;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �������м�ⶨʱ��</span></span><br><span class="line">    WDF_TIMER_CONFIG_INIT(&amp;timerConfig, RtsPciIdleTimerFunc);</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES_INIT(&amp;timerAttributes);</span><br><span class="line">    timerAttributes.ParentObject = DevContext-&gt;Device;</span><br><span class="line">    </span><br><span class="line">    status = WdfTimerCreate(</span><br><span class="line">        &amp;timerConfig,</span><br><span class="line">        &amp;timerAttributes,</span><br><span class="line">        &amp;DevContext-&gt;PowerManager-&gt;IdleTimer);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        ExFreePool(DevContext-&gt;PowerManager);</span><br><span class="line">        DevContext-&gt;PowerManager = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="10-2-��̬Z�ʺ͵�ѹ����"><a href="#10-2-��̬Z�ʺ͵�ѹ����" class="headerlink" title="10.2 ��̬Ƶ�ʺ͵�ѹ����"></a>10.2 ��̬Ƶ�ʺ͵�ѹ����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ���ܼ�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">PERFORMANCE_LEVEL</span> &#123;</span></span><br><span class="line">    PerformanceLevelLow = <span class="number">0</span>,</span><br><span class="line">    PerformanceLevelMedium,</span><br><span class="line">    PerformanceLevelHigh,</span><br><span class="line">    PerformanceLevelMax</span><br><span class="line">&#125; PERFORMANCE_LEVEL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PERFORMANCE_STATE</span> &#123;</span></span><br><span class="line">    ULONG ClockFrequency;     <span class="comment">// MHz</span></span><br><span class="line">    ULONG VoltageMv;          <span class="comment">// ����</span></span><br><span class="line">    ULONG PowerConsumption;   <span class="comment">// ����</span></span><br><span class="line">&#125; PERFORMANCE_STATE, *PPERFORMANCE_STATE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����״̬��</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> PERFORMANCE_STATE PerformanceStates[] = &#123;</span><br><span class="line">    <span class="comment">// Low</span></span><br><span class="line">    &#123; <span class="number">25</span>,   <span class="number">1800</span>, <span class="number">100</span> &#125;,  <span class="comment">// 25MHz, 1.8V</span></span><br><span class="line">    <span class="comment">// Medium</span></span><br><span class="line">    &#123; <span class="number">50</span>,   <span class="number">2000</span>, <span class="number">200</span> &#125;,  <span class="comment">// 50MHz, 2.0V</span></span><br><span class="line">    <span class="comment">// High</span></span><br><span class="line">    &#123; <span class="number">100</span>,  <span class="number">2500</span>, <span class="number">400</span> &#125;,  <span class="comment">// 100MHz, 2.5V</span></span><br><span class="line">    <span class="comment">// Max</span></span><br><span class="line">    &#123; <span class="number">200</span>,  <span class="number">3300</span>, <span class="number">800</span> &#125;   <span class="comment">// 200MHz, 3.3V</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��̬�������ܼ���</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciSetPerformanceLevel</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PERFORMANCE_LEVEL Level</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    <span class="type">const</span> PERFORMANCE_STATE* targetState;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (Level &gt;= PerformanceLevelMax) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    targetState = &amp;PerformanceStates[Level];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ������ѹ</span></span><br><span class="line">    status = RtsPciSetVoltage(DevContext, targetState-&gt;VoltageMv);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �ȴ���ѹ�ȶ�</span></span><br><span class="line">    KeStallExecutionProcessor(<span class="number">100</span>);  <span class="comment">// 100΢��</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����ʱ��Ƶ��</span></span><br><span class="line">    status = RtsPciSetClock(DevContext, targetState-&gt;ClockFrequency);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="comment">// �ָ�֮ǰ�ĵ�ѹ</span></span><br><span class="line">        RtsPciSetVoltage(DevContext, </span><br><span class="line">            PerformanceStates[DevContext-&gt;CurrentPerformanceLevel].VoltageMv);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���µ�ǰ���ܼ���</span></span><br><span class="line">    DevContext-&gt;CurrentPerformanceLevel = Level;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ��¼���ܱ仯</span></span><br><span class="line">    RtsPciLogPerformanceChange(DevContext, targetState);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����Ӧ���ܹ���</span></span><br><span class="line">VOID <span class="title function_">RtsPciAdaptivePerformanceControl</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    ULONG queueDepth;</span><br><span class="line">    LARGE_INTEGER currentTime;</span><br><span class="line">    PERFORMANCE_LEVEL targetLevel;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ��ǰ�������</span></span><br><span class="line">    queueDepth = WdfIoQueueGetCurrentDepth(DevContext-&gt;IoQueue);</span><br><span class="line">    KeQuerySystemTime(&amp;currentTime);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���ݸ���ȷ��Ŀ�����ܼ���</span></span><br><span class="line">    <span class="keyword">if</span> (queueDepth &gt; HIGH_QUEUE_THRESHOLD) &#123;</span><br><span class="line">        targetLevel = PerformanceLevelHigh;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (queueDepth &gt; MEDIUM_QUEUE_THRESHOLD) &#123;</span><br><span class="line">        targetLevel = PerformanceLevelMedium;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        targetLevel = PerformanceLevelLow;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����¶�����</span></span><br><span class="line">    <span class="keyword">if</span> (DevContext-&gt;StateManager-&gt;HealthInfo.Temperature &gt; </span><br><span class="line">        TEMPERATURE_THRESHOLD) &#123;</span><br><span class="line">        targetLevel = min(targetLevel, PerformanceLevelMedium);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. Ӧ���µ����ܼ���</span></span><br><span class="line">    <span class="keyword">if</span> (targetLevel != DevContext-&gt;CurrentPerformanceLevel) &#123;</span><br><span class="line">        RtsPciSetPerformanceLevel(DevContext, targetLevel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="10-3-��Դ״̬ת���Z�"><a href="#10-3-��Դ״̬ת���Z�" class="headerlink" title="10.3 ��Դ״̬ת���Ż�"></a>10.3 ��Դ״̬ת���Ż�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��Դ״̬ת��������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">POWER_TRANSITION_CONTEXT</span> &#123;</span></span><br><span class="line">    DEVICE_POWER_STATE OldState;</span><br><span class="line">    DEVICE_POWER_STATE NewState;</span><br><span class="line">    BOOLEAN FastResume;</span><br><span class="line">    BOOLEAN SaveContext;</span><br><span class="line">    LARGE_INTEGER TransitionStart;</span><br><span class="line">&#125; POWER_TRANSITION_CONTEXT, *PPOWER_TRANSITION_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �Ż��ĵ�Դ״̬ת��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciOptimizedPowerTransition</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ DEVICE_POWER_STATE TargetState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    POWER_TRANSITION_CONTEXT transContext = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ׼��ת��������</span></span><br><span class="line">    KeAcquireSpinLock(&amp;DevContext-&gt;PowerManager-&gt;PowerLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    transContext.OldState = DevContext-&gt;PowerManager-&gt;CurrentPowerState;</span><br><span class="line">    transContext.NewState = TargetState;</span><br><span class="line">    transContext.FastResume = </span><br><span class="line">        (TargetState == PowerDeviceD0 &amp;&amp; </span><br><span class="line">         transContext.OldState == PowerDeviceD1);</span><br><span class="line">    transContext.SaveContext = </span><br><span class="line">        (TargetState &gt; PowerDeviceD1);</span><br><span class="line">        </span><br><span class="line">    KeQuerySystemTime(&amp;transContext.TransitionStart);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ִ��Ԥת������</span></span><br><span class="line">    status = RtsPciPrePowerTransition(DevContext, &amp;transContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        KeReleaseSpinLock(&amp;DevContext-&gt;PowerManager-&gt;PowerLock, oldIrql);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �����Ҫ��������</span></span><br><span class="line">    <span class="keyword">if</span> (transContext.SaveContext) &#123;</span><br><span class="line">        RtsPciSaveDeviceContext(DevContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ִ��ʵ�ʵĵ�Դת��</span></span><br><span class="line">    status = RtsPciDoPowerTransition(DevContext, &amp;transContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        KeReleaseSpinLock(&amp;DevContext-&gt;PowerManager-&gt;PowerLock, oldIrql);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ���µ�Դ״̬</span></span><br><span class="line">    DevContext-&gt;PowerManager-&gt;CurrentPowerState = TargetState;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;DevContext-&gt;PowerManager-&gt;PowerLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ִ�к�ת������</span></span><br><span class="line">    status = RtsPciPostPowerTransition(DevContext, &amp;transContext);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �豸�����ı���</span></span><br><span class="line">VOID <span class="title function_">RtsPciSaveDeviceContext</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ����ؼ��Ĵ���</span></span><br><span class="line">    DevContext-&gt;SavedContext.ControlReg = </span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_CTRL_REG);</span><br><span class="line">    DevContext-&gt;SavedContext.ClockReg =</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_CLOCK_CTRL);</span><br><span class="line">    DevContext-&gt;SavedContext.IntMask =</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_INT_ENABLE);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. ����DMA����</span></span><br><span class="line">    DevContext-&gt;SavedContext.DmaConfig =</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_DMA_CTRL);</span><br><span class="line">    DevContext-&gt;SavedContext.DmaAddr =</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_DMA_ADDR);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. ��������״̬</span></span><br><span class="line">    DevContext-&gt;SavedContext.PerformanceLevel =</span><br><span class="line">        DevContext-&gt;CurrentPerformanceLevel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>[���� - ��һ���ֽ���ϸ���ܸ߼�IO�����������Ż�]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-44"><a href="#User-44" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-44"><a href="#AI-claude-3-5-sonnet-44" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼�IO�����������Ż����֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-10"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-10" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 10"></a>WDF SD Host Controller����ʵ����� - Part 10</h1><h2 id="11-�߼�IO�����������Z�"><a href="#11-�߼�IO�����������Z�" class="headerlink" title="11. �߼�IO�����������Ż�"></a>11. �߼�IO�����������Ż�</h2><h3 id="11-1-IO��������Z�"><a href="#11-1-IO��������Z�" class="headerlink" title="11.1 IO��������Ż�"></a>11.1 IO��������Ż�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IO��������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_QUEUE_CONFIG</span> &#123;</span></span><br><span class="line">    ULONG MaxQueueDepth;</span><br><span class="line">    ULONG ConcurrentRequests;</span><br><span class="line">    ULONG ReadAheadSize;</span><br><span class="line">    ULONG WriteBehindSize;</span><br><span class="line">    BOOLEAN EnableCoalescing;</span><br><span class="line">    BOOLEAN PrioritizeReads;</span><br><span class="line">&#125; IO_QUEUE_CONFIG, *PIO_QUEUE_CONFIG;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IO�����Ż���</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_REQUEST_OPTIMIZER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    IO_QUEUE_CONFIG Config;</span><br><span class="line">    LIST_ENTRY PendingReads;</span><br><span class="line">    LIST_ENTRY PendingWrites;</span><br><span class="line">    KSPIN_LOCK QueueLock;</span><br><span class="line">    NPAGED_LOOKASIDE_LIST RequestPool;</span><br><span class="line">    KDPC CoalescingDpc;</span><br><span class="line">    KTIMER CoalescingTimer;</span><br><span class="line">&#125; IO_REQUEST_OPTIMIZER, *PIO_REQUEST_OPTIMIZER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ��IO�Ż���</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeIoOptimizer</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PIO_REQUEST_OPTIMIZER optimizer;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����Ż����ṹ</span></span><br><span class="line">    optimizer = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(IO_REQUEST_OPTIMIZER),</span><br><span class="line">        <span class="string">&#x27;OIPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!optimizer) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ�������ֶ�</span></span><br><span class="line">    RtlZeroMemory(optimizer, <span class="keyword">sizeof</span>(IO_REQUEST_OPTIMIZER));</span><br><span class="line">    optimizer-&gt;DevContext = DevContext;</span><br><span class="line">    InitializeListHead(&amp;optimizer-&gt;PendingReads);</span><br><span class="line">    InitializeListHead(&amp;optimizer-&gt;PendingWrites);</span><br><span class="line">    KeInitializeSpinLock(&amp;optimizer-&gt;QueueLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʼ�������</span></span><br><span class="line">    ExInitializeNPagedLookasideList(</span><br><span class="line">        &amp;optimizer-&gt;RequestPool,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="keyword">sizeof</span>(IO_REQUEST_CONTEXT),</span><br><span class="line">        <span class="string">&#x27;CRPR&#x27;</span>,</span><br><span class="line">        <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 4. ��ʼ���ϲ�DPC�Ͷ�ʱ��</span></span><br><span class="line">    KeInitializeDpc(</span><br><span class="line">        &amp;optimizer-&gt;CoalescingDpc,</span><br><span class="line">        RtsPciIoCoalescingDpc,</span><br><span class="line">        optimizer);</span><br><span class="line">        </span><br><span class="line">    KeInitializeTimer(&amp;optimizer-&gt;CoalescingTimer);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����Ĭ������</span></span><br><span class="line">    optimizer-&gt;Config.MaxQueueDepth = <span class="number">256</span>;</span><br><span class="line">    optimizer-&gt;Config.ConcurrentRequests = <span class="number">16</span>;</span><br><span class="line">    optimizer-&gt;Config.ReadAheadSize = <span class="number">128</span> * <span class="number">1024</span>;  <span class="comment">// 128KB</span></span><br><span class="line">    optimizer-&gt;Config.WriteBehindSize = <span class="number">256</span> * <span class="number">1024</span>; <span class="comment">// 256KB</span></span><br><span class="line">    optimizer-&gt;Config.EnableCoalescing = TRUE;</span><br><span class="line">    optimizer-&gt;Config.PrioritizeReads = TRUE;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;IoOptimizer = optimizer;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="11-2-����ϲ�������"><a href="#11-2-����ϲ�������" class="headerlink" title="11.2 ����ϲ�������"></a>11.2 ����ϲ�������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ����ϲ�����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciCoalesceRequests</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PIO_REQUEST_OPTIMIZER Optimizer,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ BOOLEAN IsRead</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PLIST_ENTRY requestList;</span><br><span class="line">    PIO_REQUEST_CONTEXT newContext, existingContext;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    BOOLEAN canCoalesce = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ�������</span></span><br><span class="line">    newContext = ExAllocateFromNPagedLookasideList(&amp;Optimizer-&gt;RequestPool);</span><br><span class="line">    <span class="keyword">if</span> (!newContext) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    status = RtsPciGetRequestContext(Request, newContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        ExFreeToNPagedLookasideList(&amp;Optimizer-&gt;RequestPool, newContext);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���Ժϲ�����</span></span><br><span class="line">    KeAcquireSpinLock(&amp;Optimizer-&gt;QueueLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    requestList = IsRead ? </span><br><span class="line">        &amp;Optimizer-&gt;PendingReads : </span><br><span class="line">        &amp;Optimizer-&gt;PendingWrites;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ������������Ѱ�ҿɺϲ���</span></span><br><span class="line">    <span class="keyword">for</span> (PLIST_ENTRY entry = requestList-&gt;Flink;</span><br><span class="line">         entry != requestList;</span><br><span class="line">         entry = entry-&gt;Flink) &#123;</span><br><span class="line">        existingContext = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            IO_REQUEST_CONTEXT,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (RtsPciCanCoalesceRequests(newContext, existingContext)) &#123;</span><br><span class="line">            <span class="comment">// �ϲ�����</span></span><br><span class="line">            status = RtsPciMergeRequests(</span><br><span class="line">                Optimizer,</span><br><span class="line">                existingContext,</span><br><span class="line">                newContext);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">                canCoalesce = TRUE;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����޷��ϲ������ӵ�����</span></span><br><span class="line">    <span class="keyword">if</span> (!canCoalesce) &#123;</span><br><span class="line">        InsertTailList(requestList, &amp;newContext-&gt;ListEntry);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// �����ϲ���ʱ��</span></span><br><span class="line">        <span class="keyword">if</span> (Optimizer-&gt;Config.EnableCoalescing) &#123;</span><br><span class="line">            KeSetTimer(</span><br><span class="line">                &amp;Optimizer-&gt;CoalescingTimer,</span><br><span class="line">                RtlConvertLongToLargeInteger(<span class="number">-10000</span>), <span class="comment">// 1ms</span></span><br><span class="line">                &amp;Optimizer-&gt;CoalescingDpc);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;Optimizer-&gt;QueueLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����������</span></span><br><span class="line">VOID <span class="title function_">RtsPciSortPendingRequests</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PIO_REQUEST_OPTIMIZER Optimizer,</span></span><br><span class="line"><span class="params">    _In_ PLIST_ENTRY RequestList</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    LIST_ENTRY sortedList;</span><br><span class="line">    PIO_REQUEST_CONTEXT context;</span><br><span class="line">    PLIST_ENTRY entry, nextEntry;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ʼ�������б�</span></span><br><span class="line">    InitializeListHead(&amp;sortedList);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ʹ�õ����㷨����</span></span><br><span class="line">    <span class="keyword">while</span> (!IsListEmpty(RequestList)) &#123;</span><br><span class="line">        entry = RemoveHeadList(RequestList);</span><br><span class="line">        context = CONTAINING_RECORD(entry, IO_REQUEST_CONTEXT, ListEntry);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// �ҵ����ʵĲ���λ��</span></span><br><span class="line">        BOOLEAN inserted = FALSE;</span><br><span class="line">        <span class="keyword">for</span> (PLIST_ENTRY sortedEntry = sortedList.Flink;</span><br><span class="line">             sortedEntry != &amp;sortedList;</span><br><span class="line">             sortedEntry = sortedEntry-&gt;Flink) &#123;</span><br><span class="line">            PIO_REQUEST_CONTEXT sortedContext = CONTAINING_RECORD(</span><br><span class="line">                sortedEntry,</span><br><span class="line">                IO_REQUEST_CONTEXT,</span><br><span class="line">                ListEntry);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (context-&gt;StartingLba &lt; sortedContext-&gt;StartingLba) &#123;</span><br><span class="line">                InsertHeadList(sortedEntry-&gt;Blink, entry);</span><br><span class="line">                inserted = TRUE;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!inserted) &#123;</span><br><span class="line">            InsertTailList(&amp;sortedList, entry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���������б��ƻ�ԭ�б�</span></span><br><span class="line">    <span class="keyword">while</span> (!IsListEmpty(&amp;sortedList)) &#123;</span><br><span class="line">        entry = RemoveHeadList(&amp;sortedList);</span><br><span class="line">        InsertTailList(RequestList, entry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="11-3-Ԥ�����ӳ�д"><a href="#11-3-Ԥ�����ӳ�д" class="headerlink" title="11.3 Ԥ�����ӳ�д"></a>11.3 Ԥ�����ӳ�д</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Ԥ������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleReadAhead</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ ULONGLONG StartingLba,</span></span><br><span class="line"><span class="params">    _In_ ULONG BlockCount</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    ULONG readAheadBlocks;</span><br><span class="line">    PIO_REQUEST_OPTIMIZER optimizer = DevContext-&gt;IoOptimizer;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����Ԥ����С</span></span><br><span class="line">    readAheadBlocks = min(</span><br><span class="line">        (optimizer-&gt;Config.ReadAheadSize / DevContext-&gt;BlockSize),</span><br><span class="line">        (ULONG)(DevContext-&gt;DiskSize.QuadPart / DevContext-&gt;BlockSize) - </span><br><span class="line">            (StartingLba + BlockCount));</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">if</span> (readAheadBlocks == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����Ԥ������</span></span><br><span class="line">    status = RtsPciCreateReadAheadRequest(</span><br><span class="line">        DevContext,</span><br><span class="line">        StartingLba + BlockCount,</span><br><span class="line">        readAheadBlocks);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="comment">// Ԥ��ʧ�ܲ�Ӱ��ԭʼ����</span></span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �ӳ�д����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleWriteBehind</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PIO_REQUEST_OPTIMIZER optimizer = DevContext-&gt;IoOptimizer;</span><br><span class="line">    BOOLEAN needFlush = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���д������״̬</span></span><br><span class="line">    <span class="keyword">if</span> (RtsPciIsWriteBufferFull(optimizer)) &#123;</span><br><span class="line">        needFlush = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���ӵ�д������</span></span><br><span class="line">    status = RtsPciAddToWriteBuffer(optimizer, Request);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �����Ҫ��ִ��ˢ��</span></span><br><span class="line">    <span class="keyword">if</span> (needFlush) &#123;</span><br><span class="line">        status = RtsPciFlushWriteBuffer(optimizer);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">return</span> status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// д������ˢ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciFlushWriteBuffer</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PIO_REQUEST_OPTIMIZER Optimizer</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    LIST_ENTRY requestsToFlush;</span><br><span class="line">    </span><br><span class="line">    InitializeListHead(&amp;requestsToFlush);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ��Ҫˢ�µ�����</span></span><br><span class="line">    KeAcquireSpinLock(&amp;Optimizer-&gt;QueueLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!IsListEmpty(&amp;Optimizer-&gt;PendingWrites)) &#123;</span><br><span class="line">        PLIST_ENTRY entry = RemoveHeadList(&amp;Optimizer-&gt;PendingWrites);</span><br><span class="line">        InsertTailList(&amp;requestsToFlush, entry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;Optimizer-&gt;QueueLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ִ��ʵ�ʵ�д����</span></span><br><span class="line">    <span class="keyword">while</span> (!IsListEmpty(&amp;requestsToFlush)) &#123;</span><br><span class="line">        PLIST_ENTRY entry = RemoveHeadList(&amp;requestsToFlush);</span><br><span class="line">        PIO_REQUEST_CONTEXT context = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            IO_REQUEST_CONTEXT,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        status = RtsPciProcessWriteRequest(</span><br><span class="line">            Optimizer-&gt;DevContext,</span><br><span class="line">            context);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="comment">// ��������</span></span><br><span class="line">            RtsPciHandleWriteError(Optimizer, context);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ExFreeToNPagedLookasideList(</span><br><span class="line">            &amp;Optimizer-&gt;RequestPool,</span><br><span class="line">            context);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>[���� - ��һ���ֽ���ϸ���ܶ����֧�ֺͲ����Ż�]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-45"><a href="#User-45" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-45"><a href="#AI-claude-3-5-sonnet-45" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ�������֧�ֺͲ����Ż����֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-11"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-11" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 11"></a>WDF SD Host Controller����ʵ����� - Part 11</h1><h2 id="12-�����֧�ֺͲ����Z�"><a href="#12-�����֧�ֺͲ����Z�" class="headerlink" title="12. �����֧�ֺͲ����Ż�"></a>12. �����֧�ֺͲ����Ż�</h2><h3 id="12-1-����й�����ʵ��"><a href="#12-1-����й�����ʵ��" class="headerlink" title="12.1 ����й�����ʵ��"></a>12.1 ����й�����ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �������Ͷ���</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">QUEUE_TYPE</span> &#123;</span></span><br><span class="line">    QueueTypeRead = <span class="number">0</span>,</span><br><span class="line">    QueueTypeWrite,</span><br><span class="line">    QueueTypeControl,</span><br><span class="line">    QueueTypeMax</span><br><span class="line">&#125; QUEUE_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">QUEUE_CONTEXT</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    QUEUE_TYPE Type;</span><br><span class="line">    WDFQUEUE Queue;</span><br><span class="line">    KSPIN_LOCK Lock;</span><br><span class="line">    LIST_ENTRY PendingList;</span><br><span class="line">    ULONG CurrentDepth;</span><br><span class="line">    ULONG MaxDepth;</span><br><span class="line">    BOOLEAN IsPaused;</span><br><span class="line">&#125; QUEUE_CONTEXT, *PQUEUE_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����й�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">MULTI_QUEUE_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    QUEUE_CONTEXT Queues[QueueTypeMax];</span><br><span class="line">    KSEMAPHORE QueueSemaphore;</span><br><span class="line">    KEVENT QueueEvent;</span><br><span class="line">    BOOLEAN EnableLoadBalancing;</span><br><span class="line">    LONG ActiveQueueCount;</span><br><span class="line">&#125; MULTI_QUEUE_MANAGER, *PMULTI_QUEUE_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ������й�����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeMultiQueue</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_IO_QUEUE_CONFIG queueConfig;</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES queueAttributes;</span><br><span class="line">    PMULTI_QUEUE_MANAGER queueManager;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����������ṹ</span></span><br><span class="line">    queueManager = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(MULTI_QUEUE_MANAGER),</span><br><span class="line">        <span class="string">&#x27;MQPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!queueManager) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(queueManager, <span class="keyword">sizeof</span>(MULTI_QUEUE_MANAGER));</span><br><span class="line">    queueManager-&gt;DevContext = DevContext;</span><br><span class="line">    queueManager-&gt;EnableLoadBalancing = TRUE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ��ͬ������</span></span><br><span class="line">    KeInitializeSemaphore(&amp;queueManager-&gt;QueueSemaphore, </span><br><span class="line">                         QueueTypeMax, QueueTypeMax);</span><br><span class="line">    KeInitializeEvent(&amp;queueManager-&gt;QueueEvent, </span><br><span class="line">                     NotificationEvent, FALSE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���������Ͷ���</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; QueueTypeMax; i++) &#123;</span><br><span class="line">        PQUEUE_CONTEXT queueCtx = &amp;queueManager-&gt;Queues[i];</span><br><span class="line">        queueCtx-&gt;DevContext = DevContext;</span><br><span class="line">        queueCtx-&gt;Type = (QUEUE_TYPE)i;</span><br><span class="line">        queueCtx-&gt;MaxDepth = <span class="number">256</span>;  <span class="comment">// Ĭ�����</span></span><br><span class="line">        InitializeListHead(&amp;queueCtx-&gt;PendingList);</span><br><span class="line">        KeInitializeSpinLock(&amp;queueCtx-&gt;Lock);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����WDF����</span></span><br><span class="line">        WDF_IO_QUEUE_CONFIG_INIT(&amp;queueConfig, WdfIoQueueDispatchParallel);</span><br><span class="line">        queueConfig.EvtIoDefault = RtsPciEvtIoDefault;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (i) &#123;</span><br><span class="line">            <span class="keyword">case</span> QueueTypeRead:</span><br><span class="line">                queueConfig.EvtIoRead = RtsPciEvtIoRead;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> QueueTypeWrite:</span><br><span class="line">                queueConfig.EvtIoWrite = RtsPciEvtIoWrite;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> QueueTypeControl:</span><br><span class="line">                queueConfig.EvtIoDeviceControl = RtsPciEvtIoDeviceControl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        WDF_OBJECT_ATTRIBUTES_INIT_CONTEXT_TYPE(</span><br><span class="line">            &amp;queueAttributes,</span><br><span class="line">            QUEUE_CONTEXT);</span><br><span class="line">            </span><br><span class="line">        status = WdfIoQueueCreate(</span><br><span class="line">            DevContext-&gt;Device,</span><br><span class="line">            &amp;queueConfig,</span><br><span class="line">            &amp;queueAttributes,</span><br><span class="line">            &amp;queueCtx-&gt;Queue);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        InterlockedIncrement(&amp;queueManager-&gt;ActiveQueueCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;QueueManager = queueManager;</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">cleanup:</span><br><span class="line">    RtsPciCleanupMultiQueue(queueManager);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h3 id="12-2-���ؾ���ʵ��"><a href="#12-2-���ؾ���ʵ��" class="headerlink" title="12.2 ���ؾ���ʵ��"></a>12.2 ���ؾ���ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ���ؾ�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">LOAD_BALANCER</span> &#123;</span></span><br><span class="line">    PMULTI_QUEUE_MANAGER QueueManager;</span><br><span class="line">    ULONG QueueWeights[QueueTypeMax];</span><br><span class="line">    KSPIN_LOCK StatsLock;</span><br><span class="line">    LARGE_INTEGER LastBalanceTime;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG RequestCount;</span><br><span class="line">        ULONG ProcessingTime;</span><br><span class="line">        ULONG AverageLatency;</span><br><span class="line">    &#125; QueueStats[QueueTypeMax];</span><br><span class="line">&#125; LOAD_BALANCER, *PLOAD_BALANCER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���ؾ��⴦��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciBalanceQueues</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PLOAD_BALANCER Balancer</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    LARGE_INTEGER currentTime;</span><br><span class="line">    ULONG totalWeight = <span class="number">0</span>;</span><br><span class="line">    ULONG newWeights[QueueTypeMax] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ��ǰͳ������</span></span><br><span class="line">    KeAcquireSpinLock(&amp;Balancer-&gt;StatsLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    KeQuerySystemTime(&amp;currentTime);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ʱ����</span></span><br><span class="line">    LONGLONG timeDiff = (currentTime.QuadPart - </span><br><span class="line">                        Balancer-&gt;LastBalanceTime.QuadPart) / <span class="number">10000</span>; <span class="comment">// ms</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ������Ȩ��</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; QueueTypeMax; i++) &#123;</span><br><span class="line">        ULONG queueLoad = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (Balancer-&gt;QueueStats[i].RequestCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            queueLoad = (Balancer-&gt;QueueStats[i].ProcessingTime * <span class="number">100</span>) /</span><br><span class="line">                       (ULONG)timeDiff;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ���ݸ��ص���Ȩ��</span></span><br><span class="line">        <span class="keyword">if</span> (queueLoad &gt; <span class="number">80</span>) &#123;  <span class="comment">// �߸���</span></span><br><span class="line">            newWeights[i] = Balancer-&gt;QueueWeights[i] * <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (queueLoad &lt; <span class="number">20</span>) &#123;  <span class="comment">// �͸���</span></span><br><span class="line">            newWeights[i] = Balancer-&gt;QueueWeights[i] / <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            newWeights[i] = Balancer-&gt;QueueWeights[i];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        totalWeight += newWeights[i];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. Ӧ����Ȩ��</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; QueueTypeMax; i++) &#123;</span><br><span class="line">        Balancer-&gt;QueueWeights[i] = </span><br><span class="line">            (newWeights[i] * <span class="number">100</span>) / totalWeight;</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// ����ͳ������</span></span><br><span class="line">        Balancer-&gt;QueueStats[i].RequestCount = <span class="number">0</span>;</span><br><span class="line">        Balancer-&gt;QueueStats[i].ProcessingTime = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Balancer-&gt;LastBalanceTime = currentTime;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;Balancer-&gt;StatsLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h3 id="12-3-���������Z�"><a href="#12-3-���������Z�" class="headerlink" title="12.3 ���������Ż�"></a>12.3 ���������Ż�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �������ƹ�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">CONCURRENCY_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    LONG MaxConcurrentRequests;</span><br><span class="line">    LONG CurrentRequests;</span><br><span class="line">    KSPIN_LOCK Lock;</span><br><span class="line">    LIST_ENTRY WaitingList;</span><br><span class="line">    KEVENT RequestComplete;</span><br><span class="line">    BOOLEAN ThrottlingEnabled;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG HighThreshold;</span><br><span class="line">        ULONG LowThreshold;</span><br><span class="line">        ULONG CurrentLevel;</span><br><span class="line">    &#125; ThrottleControl;</span><br><span class="line">&#125; CONCURRENCY_MANAGER, *PCONCURRENCY_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleConcurrentRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCONCURRENCY_MANAGER ConcurrencyMgr,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    BOOLEAN needWait = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��鲢������</span></span><br><span class="line">    KeAcquireSpinLock(&amp;ConcurrencyMgr-&gt;Lock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ConcurrencyMgr-&gt;CurrentRequests &gt;= </span><br><span class="line">        ConcurrencyMgr-&gt;MaxConcurrentRequests) &#123;</span><br><span class="line">        <span class="comment">// ���ӵ��ȴ��б�</span></span><br><span class="line">        status = RtsPciAddToWaitingList(</span><br><span class="line">            ConcurrencyMgr,</span><br><span class="line">            Request);</span><br><span class="line">            </span><br><span class="line">        needWait = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        InterlockedIncrement(&amp;ConcurrencyMgr-&gt;CurrentRequests);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;ConcurrencyMgr-&gt;Lock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (needWait) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_PENDING;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. Ӧ�ý�������</span></span><br><span class="line">    <span class="keyword">if</span> (ConcurrencyMgr-&gt;ThrottlingEnabled) &#123;</span><br><span class="line">        status = RtsPciApplyThrottling(ConcurrencyMgr);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            InterlockedDecrement(&amp;ConcurrencyMgr-&gt;CurrentRequests);</span><br><span class="line">            <span class="keyword">return</span> status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��������</span></span><br><span class="line">    status = RtsPciProcessRequest(</span><br><span class="line">        ConcurrencyMgr-&gt;DevContext,</span><br><span class="line">        Request);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        InterlockedDecrement(&amp;ConcurrencyMgr-&gt;CurrentRequests);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ������ɴ���</span></span><br><span class="line">VOID <span class="title function_">RtsPciCompleteRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCONCURRENCY_MANAGER ConcurrencyMgr,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ NTSTATUS Status</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    WDFREQUEST nextRequest = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���¼���</span></span><br><span class="line">    InterlockedDecrement(&amp;ConcurrencyMgr-&gt;CurrentRequests);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���ȴ��б�</span></span><br><span class="line">    KeAcquireSpinLock(&amp;ConcurrencyMgr-&gt;Lock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!IsListEmpty(&amp;ConcurrencyMgr-&gt;WaitingList)) &#123;</span><br><span class="line">        PLIST_ENTRY entry = RemoveHeadList(&amp;ConcurrencyMgr-&gt;WaitingList);</span><br><span class="line">        nextRequest = CONTAINING_RECORD(entry, </span><br><span class="line">                                      WAITING_REQUEST, </span><br><span class="line">                                      ListEntry)-&gt;Request;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;ConcurrencyMgr-&gt;Lock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ɵ�ǰ����</span></span><br><span class="line">    WdfRequestComplete(Request, Status);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ������һ������</span></span><br><span class="line">    <span class="keyword">if</span> (nextRequest != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        RtsPciHandleConcurrentRequest(ConcurrencyMgr, nextRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ֪ͨ�ȴ���</span></span><br><span class="line">    KeSetEvent(&amp;ConcurrencyMgr-&gt;RequestComplete, <span class="number">0</span>, FALSE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<p>[���� - ��һ���ֽ���ϸ���ܸ߼����Ժ���Ϲ���]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-46"><a href="#User-46" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-46"><a href="#AI-claude-3-5-sonnet-46" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼����Ժ���Ϲ��ܲ��֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-12"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-12" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 12"></a>WDF SD Host Controller����ʵ����� - Part 12</h1><h2 id="13-�߼����Ժ���Ϲ���"><a href="#13-�߼����Ժ���Ϲ���" class="headerlink" title="13. �߼����Ժ���Ϲ���"></a>13. �߼����Ժ���Ϲ���</h2><h3 id="13-1-ʵʱ���ϵͳ"><a href="#13-1-ʵʱ���ϵͳ" class="headerlink" title="13.1 ʵʱ���ϵͳ"></a>13.1 ʵʱ���ϵͳ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ����¼�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">DIAGNOSTIC_EVENT_TYPE</span> &#123;</span></span><br><span class="line">    DiagEventError = <span class="number">0</span>,</span><br><span class="line">    DiagEventWarning,</span><br><span class="line">    DiagEventInfo,</span><br><span class="line">    DiagEventPerformance,</span><br><span class="line">    DiagEventState,</span><br><span class="line">    DiagEventIO,</span><br><span class="line">    DiagEventPower,</span><br><span class="line">    DiagEventDMA</span><br><span class="line">&#125; DIAGNOSTIC_EVENT_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����¼��ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DIAGNOSTIC_EVENT</span> &#123;</span></span><br><span class="line">    DIAGNOSTIC_EVENT_TYPE Type;</span><br><span class="line">    LARGE_INTEGER Timestamp;</span><br><span class="line">    ULONG ProcessId;</span><br><span class="line">    ULONG ThreadId;</span><br><span class="line">    ULONG Sequence;</span><br><span class="line">    NTSTATUS Status;</span><br><span class="line">    WCHAR Description[<span class="number">256</span>];</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            ULONG ErrorCode;</span><br><span class="line">            ULONG ErrorFlags;</span><br><span class="line">            WCHAR ErrorLocation[<span class="number">64</span>];</span><br><span class="line">        &#125; Error;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            ULONG IOType;</span><br><span class="line">            ULONGLONG Offset;</span><br><span class="line">            ULONG Length;</span><br><span class="line">            ULONG Duration;</span><br><span class="line">        &#125; IO;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            DEVICE_POWER_STATE OldState;</span><br><span class="line">            DEVICE_POWER_STATE NewState;</span><br><span class="line">            ULONG TransitionTime;</span><br><span class="line">        &#125; Power;</span><br><span class="line">    &#125; Data;</span><br><span class="line">&#125; DIAGNOSTIC_EVENT, *PDIAGNOSTIC_EVENT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Ϲ�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DIAGNOSTIC_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    KSPIN_LOCK EventLock;</span><br><span class="line">    NPAGED_LOOKASIDE_LIST EventPool;</span><br><span class="line">    LIST_ENTRY EventList;</span><br><span class="line">    ULONG MaxEvents;</span><br><span class="line">    ULONG CurrentEvents;</span><br><span class="line">    LONG SequenceNumber;</span><br><span class="line">    BOOLEAN Enabled;</span><br><span class="line">    BOOLEAN VerboseMode;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �¼�������</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG TypeFilter;</span><br><span class="line">        ULONG MinSeverity;</span><br><span class="line">        BOOLEAN FilterEnabled;</span><br><span class="line">    &#125; EventFilter;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ʵʱ��ػص�</span></span><br><span class="line">    PFN_DIAGNOSTIC_CALLBACK MonitorCallback;</span><br><span class="line">    PVOID MonitorContext;</span><br><span class="line">&#125; DIAGNOSTIC_MANAGER, *PDIAGNOSTIC_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ�����ϵͳ</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeDiagnostics</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDIAGNOSTIC_MANAGER diagMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ������Ϲ�����</span></span><br><span class="line">    diagMgr = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(DIAGNOSTIC_MANAGER),</span><br><span class="line">        <span class="string">&#x27;DMPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!diagMgr) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(diagMgr, <span class="keyword">sizeof</span>(DIAGNOSTIC_MANAGER));</span><br><span class="line">    diagMgr-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ���¼��غ��б�</span></span><br><span class="line">    ExInitializeNPagedLookasideList(</span><br><span class="line">        &amp;diagMgr-&gt;EventPool,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="keyword">sizeof</span>(DIAGNOSTIC_EVENT),</span><br><span class="line">        <span class="string">&#x27;EVPR&#x27;</span>,</span><br><span class="line">        <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">    InitializeListHead(&amp;diagMgr-&gt;EventList);</span><br><span class="line">    KeInitializeSpinLock(&amp;diagMgr-&gt;EventLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����Ĭ������</span></span><br><span class="line">    diagMgr-&gt;MaxEvents = <span class="number">1000</span>;</span><br><span class="line">    diagMgr-&gt;Enabled = TRUE;</span><br><span class="line">    diagMgr-&gt;EventFilter.MinSeverity = DiagEventWarning;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;DiagnosticManager = diagMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h3 id="13-2-ʵʱ�¼���¼�ͷ���"><a href="#13-2-ʵʱ�¼���¼�ͷ���" class="headerlink" title="13.2 ʵʱ�¼���¼�ͷ���"></a>13.2 ʵʱ�¼���¼�ͷ���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��¼����¼�</span></span><br><span class="line">VOID <span class="title function_">RtsPciLogDiagnosticEvent</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDIAGNOSTIC_MANAGER DiagMgr,</span></span><br><span class="line"><span class="params">    _In_ DIAGNOSTIC_EVENT_TYPE Type,</span></span><br><span class="line"><span class="params">    _In_ NTSTATUS Status,</span></span><br><span class="line"><span class="params">    _In_ PCWSTR Description,</span></span><br><span class="line"><span class="params">    _In_opt_ PVOID EventData,</span></span><br><span class="line"><span class="params">    _In_ SIZE_T DataSize</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PDIAGNOSTIC_EVENT event;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����Ƿ���Ҫ��¼</span></span><br><span class="line">    <span class="keyword">if</span> (!DiagMgr-&gt;Enabled ||</span><br><span class="line">        (DiagMgr-&gt;EventFilter.FilterEnabled &amp;&amp; </span><br><span class="line">         !(DiagMgr-&gt;EventFilter.TypeFilter &amp; (<span class="number">1</span> &lt;&lt; Type)))) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����¼��ṹ</span></span><br><span class="line">    event = ExAllocateFromNPagedLookasideList(&amp;DiagMgr-&gt;EventPool);</span><br><span class="line">    <span class="keyword">if</span> (!event) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����¼���Ϣ</span></span><br><span class="line">    RtlZeroMemory(event, <span class="keyword">sizeof</span>(DIAGNOSTIC_EVENT));</span><br><span class="line">    event-&gt;Type = Type;</span><br><span class="line">    event-&gt;Status = Status;</span><br><span class="line">    event-&gt;Sequence = InterlockedIncrement(&amp;DiagMgr-&gt;SequenceNumber);</span><br><span class="line">    KeQuerySystemTime(&amp;event-&gt;Timestamp);</span><br><span class="line">    event-&gt;ProcessId = (ULONG)PsGetCurrentProcessId();</span><br><span class="line">    event-&gt;ThreadId = (ULONG)PsGetCurrentThreadId();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (Description) &#123;</span><br><span class="line">        RtlStringCchCopyW(event-&gt;Description, </span><br><span class="line">                         ARRAYSIZE(event-&gt;Description),</span><br><span class="line">                         Description);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �����¼��ض�����</span></span><br><span class="line">    <span class="keyword">if</span> (EventData &amp;&amp; DataSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        RtlCopyMemory(&amp;event-&gt;Data, EventData, </span><br><span class="line">                      min(DataSize, <span class="keyword">sizeof</span>(event-&gt;Data)));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ���ӵ��¼��б�</span></span><br><span class="line">    KeAcquireSpinLock(&amp;DiagMgr-&gt;EventLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (DiagMgr-&gt;CurrentEvents &gt;= DiagMgr-&gt;MaxEvents) &#123;</span><br><span class="line">        <span class="comment">// �Ƴ���ɵ��¼�</span></span><br><span class="line">        PLIST_ENTRY oldestEntry = RemoveHeadList(&amp;DiagMgr-&gt;EventList);</span><br><span class="line">        PDIAGNOSTIC_EVENT oldestEvent = CONTAINING_RECORD(</span><br><span class="line">            oldestEntry,</span><br><span class="line">            DIAGNOSTIC_EVENT,</span><br><span class="line">            ListEntry);</span><br><span class="line">        ExFreeToNPagedLookasideList(&amp;DiagMgr-&gt;EventPool, oldestEvent);</span><br><span class="line">        DiagMgr-&gt;CurrentEvents--;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    InsertTailList(&amp;DiagMgr-&gt;EventList, &amp;event-&gt;ListEntry);</span><br><span class="line">    DiagMgr-&gt;CurrentEvents++;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;DiagMgr-&gt;EventLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ���ü�ػص�</span></span><br><span class="line">    <span class="keyword">if</span> (DiagMgr-&gt;MonitorCallback) &#123;</span><br><span class="line">        DiagMgr-&gt;MonitorCallback(event, DiagMgr-&gt;MonitorContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �¼�������</span></span><br><span class="line">VOID <span class="title function_">RtsPciAnalyzeDiagnosticEvents</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDIAGNOSTIC_MANAGER DiagMgr,</span></span><br><span class="line"><span class="params">    _Out_ PDIAGNOSTIC_ANALYSIS Analysis</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PLIST_ENTRY entry;</span><br><span class="line">    ULONG errorCount = <span class="number">0</span>;</span><br><span class="line">    ULONG warningCount = <span class="number">0</span>;</span><br><span class="line">    ULONG totalIOTime = <span class="number">0</span>;</span><br><span class="line">    ULONG ioCount = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(Analysis, <span class="keyword">sizeof</span>(DIAGNOSTIC_ANALYSIS));</span><br><span class="line">    </span><br><span class="line">    KeAcquireSpinLock(&amp;DiagMgr-&gt;EventLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���������¼����з���</span></span><br><span class="line">    <span class="keyword">for</span> (entry = DiagMgr-&gt;EventList.Flink;</span><br><span class="line">         entry != &amp;DiagMgr-&gt;EventList;</span><br><span class="line">         entry = entry-&gt;Flink) &#123;</span><br><span class="line">        PDIAGNOSTIC_EVENT event = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            DIAGNOSTIC_EVENT,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">switch</span> (event-&gt;Type) &#123;</span><br><span class="line">            <span class="keyword">case</span> DiagEventError:</span><br><span class="line">                errorCount++;</span><br><span class="line">                Analysis-&gt;LastError = event-&gt;Status;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> DiagEventWarning:</span><br><span class="line">                warningCount++;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> DiagEventIO:</span><br><span class="line">                totalIOTime += event-&gt;Data.IO.Duration;</span><br><span class="line">                ioCount++;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> DiagEventPerformance:</span><br><span class="line">                <span class="comment">// ������������</span></span><br><span class="line">                RtsPciAnalyzePerformanceEvent(event, Analysis);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;DiagMgr-&gt;EventLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ͳ������</span></span><br><span class="line">    Analysis-&gt;ErrorRate = (errorCount * <span class="number">100</span>) / DiagMgr-&gt;CurrentEvents;</span><br><span class="line">    Analysis-&gt;WarningRate = (warningCount * <span class="number">100</span>) / DiagMgr-&gt;CurrentEvents;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ioCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        Analysis-&gt;AverageIOTime = totalIOTime / ioCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h3 id="13-3-���Խӿ�ʵ��"><a href="#13-3-���Խӿ�ʵ��" class="headerlink" title="13.3 ���Խӿ�ʵ��"></a>13.3 ���Խӿ�ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �����������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEBUG_COMMAND_HANDLER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    WDFQUEUE DebugQueue;</span><br><span class="line">    WDFWORKITEM DebugWorkItem;</span><br><span class="line">    LIST_ENTRY CommandList;</span><br><span class="line">    KSPIN_LOCK CommandLock;</span><br><span class="line">    KEVENT CommandEvent;</span><br><span class="line">&#125; DEBUG_COMMAND_HANDLER, *PDEBUG_COMMAND_HANDLER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��������ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEBUG_COMMAND</span> &#123;</span></span><br><span class="line">    LIST_ENTRY ListEntry;</span><br><span class="line">    ULONG CommandCode;</span><br><span class="line">    PVOID InputBuffer;</span><br><span class="line">    SIZE_T InputBufferSize;</span><br><span class="line">    PVOID OutputBuffer;</span><br><span class="line">    SIZE_T OutputBufferSize;</span><br><span class="line">    NTSTATUS Status;</span><br><span class="line">    KEVENT CompletionEvent;</span><br><span class="line">&#125; DEBUG_COMMAND, *PDEBUG_COMMAND;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ������������</span></span><br><span class="line">VOID <span class="title function_">RtsPciProcessDebugCommand</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEBUG_COMMAND_HANDLER DebugHandler,</span></span><br><span class="line"><span class="params">    _In_ PDEBUG_COMMAND Command</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (Command-&gt;CommandCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> DEBUG_CMD_DUMP_REGISTERS:</span><br><span class="line">            Command-&gt;Status = RtsPciDumpRegistersDebug(</span><br><span class="line">                DebugHandler-&gt;DevContext,</span><br><span class="line">                Command-&gt;OutputBuffer,</span><br><span class="line">                Command-&gt;OutputBufferSize);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DEBUG_CMD_TRACE_IO:</span><br><span class="line">            Command-&gt;Status = RtsPciConfigureIOTracing(</span><br><span class="line">                DebugHandler-&gt;DevContext,</span><br><span class="line">                Command-&gt;InputBuffer,</span><br><span class="line">                Command-&gt;InputBufferSize);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DEBUG_CMD_TEST_DMA:</span><br><span class="line">            Command-&gt;Status = RtsPciExecuteDMATest(</span><br><span class="line">                DebugHandler-&gt;DevContext,</span><br><span class="line">                Command-&gt;InputBuffer,</span><br><span class="line">                Command-&gt;OutputBuffer);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DEBUG_CMD_ANALYZE_PERFORMANCE:</span><br><span class="line">            Command-&gt;Status = RtsPciAnalyzePerformanceDebug(</span><br><span class="line">                DebugHandler-&gt;DevContext,</span><br><span class="line">                Command-&gt;OutputBuffer,</span><br><span class="line">                Command-&gt;OutputBufferSize);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            Command-&gt;Status = STATUS_INVALID_PARAMETER;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ֪ͨ�������</span></span><br><span class="line">    KeSetEvent(&amp;Command-&gt;CompletionEvent, <span class="number">0</span>, FALSE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ע����Իص�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciRegisterDebugCallback</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PDEBUG_CALLBACK_ROUTINE CallbackRoutine,</span></span><br><span class="line"><span class="params">    _In_ PVOID Context</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PDEBUG_CALLBACK callback;</span><br><span class="line">    </span><br><span class="line">    callback = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(DEBUG_CALLBACK),</span><br><span class="line">        <span class="string">&#x27;CBPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!callback) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    callback-&gt;CallbackRoutine = CallbackRoutine;</span><br><span class="line">    callback-&gt;Context = Context;</span><br><span class="line">    </span><br><span class="line">    KeAcquireSpinLock(&amp;DevContext-&gt;DebugHandler-&gt;CommandLock, &amp;oldIrql);</span><br><span class="line">    InsertTailList(&amp;DevContext-&gt;DebugHandler-&gt;CallbackList,</span><br><span class="line">                   &amp;callback-&gt;ListEntry);</span><br><span class="line">    KeReleaseSpinLock(&amp;DevContext-&gt;DebugHandler-&gt;CommandLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<p>[���� - ��һ���ֽ���ϸ���ܰ�ȫ�ԺͿɿ�����ǿ]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-47"><a href="#User-47" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-47"><a href="#AI-claude-3-5-sonnet-47" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ����ȫ�ԺͿɿ�����ǿ���֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-13"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-13" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 13"></a>WDF SD Host Controller����ʵ����� - Part 13</h1><h2 id="14-��o�ԺͿɿ�����o"><a href="#14-��o�ԺͿɿ�����o" class="headerlink" title="14. ��ȫ�ԺͿɿ�����ǿ"></a>14. ��ȫ�ԺͿɿ�����ǿ</h2><h3 id="14-1-��o������ʵ��"><a href="#14-1-��o������ʵ��" class="headerlink" title="14.1 ��ȫ������ʵ��"></a>14.1 ��ȫ������ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��ȫ������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">SECURITY_LEVEL</span> &#123;</span></span><br><span class="line">    SecurityLevelLow = <span class="number">0</span>,</span><br><span class="line">    SecurityLevelMedium,</span><br><span class="line">    SecurityLevelHigh,</span><br><span class="line">    SecurityLevelMax</span><br><span class="line">&#125; SECURITY_LEVEL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ȫ��������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SECURITY_POLICY</span> &#123;</span></span><br><span class="line">    SECURITY_LEVEL Level;</span><br><span class="line">    BOOLEAN EnableAccessControl;</span><br><span class="line">    BOOLEAN EnableDataEncryption;</span><br><span class="line">    BOOLEAN EnableCommandValidation;</span><br><span class="line">    BOOLEAN EnableTimeoutProtection;</span><br><span class="line">    ULONG CommandTimeout;        <span class="comment">// ����</span></span><br><span class="line">    ULONG MaxRetryCount;</span><br><span class="line">    ULONG ValidationFlags;</span><br><span class="line">&#125; SECURITY_POLICY, *PSECURITY_POLICY;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ȫ������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SECURITY_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    SECURITY_POLICY Policy;</span><br><span class="line">    KSPIN_LOCK PolicyLock;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ʿ���</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY AccessList;</span><br><span class="line">        KSPIN_LOCK AccessLock;</span><br><span class="line">        BOOLEAN Enabled;</span><br><span class="line">    &#125; AccessControl;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������֤</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG ValidCommandMask;</span><br><span class="line">        ULONG BlockedCommandMask;</span><br><span class="line">        KSPIN_LOCK ValidationLock;</span><br><span class="line">    &#125; CommandValidation;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �������</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG SecurityViolations;</span><br><span class="line">        ULONG ValidationFailures;</span><br><span class="line">        ULONG TimeoutCount;</span><br><span class="line">        LARGE_INTEGER LastViolationTime;</span><br><span class="line">    &#125; Statistics;</span><br><span class="line">&#125; SECURITY_MANAGER, *PSECURITY_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ����ȫ������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeSecurityManager</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PSECURITY_MANAGER secMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���䰲ȫ������</span></span><br><span class="line">    secMgr = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(SECURITY_MANAGER),</span><br><span class="line">        <span class="string">&#x27;SMPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!secMgr) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(secMgr, <span class="keyword">sizeof</span>(SECURITY_MANAGER));</span><br><span class="line">    secMgr-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ�������б�</span></span><br><span class="line">    KeInitializeSpinLock(&amp;secMgr-&gt;PolicyLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;secMgr-&gt;AccessControl.AccessLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;secMgr-&gt;CommandValidation.ValidationLock);</span><br><span class="line">    InitializeListHead(&amp;secMgr-&gt;AccessControl.AccessList);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����Ĭ�ϰ�ȫ����</span></span><br><span class="line">    secMgr-&gt;Policy.Level = SecurityLevelMedium;</span><br><span class="line">    secMgr-&gt;Policy.EnableAccessControl = TRUE;</span><br><span class="line">    secMgr-&gt;Policy.EnableCommandValidation = TRUE;</span><br><span class="line">    secMgr-&gt;Policy.EnableTimeoutProtection = TRUE;</span><br><span class="line">    secMgr-&gt;Policy.CommandTimeout = <span class="number">5000</span>;  <span class="comment">// 5��</span></span><br><span class="line">    secMgr-&gt;Policy.MaxRetryCount = <span class="number">3</span>;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;SecurityManager = secMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="14-2-������֤�ͷ��ʿ���"><a href="#14-2-������֤�ͷ��ʿ���" class="headerlink" title="14.2 ������֤�ͷ��ʿ���"></a>14.2 ������֤�ͷ��ʿ���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ������֤ʵ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciValidateCommand</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PSECURITY_MANAGER SecMgr,</span></span><br><span class="line"><span class="params">    _In_ PSD_COMMAND Command</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �������Ƿ�������֤</span></span><br><span class="line">    <span class="keyword">if</span> (!SecMgr-&gt;Policy.EnableCommandValidation) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeAcquireSpinLock(&amp;SecMgr-&gt;CommandValidation.ValidationLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��������Ƿ���ֹ</span></span><br><span class="line">    <span class="keyword">if</span> (SecMgr-&gt;CommandValidation.BlockedCommandMask &amp; (<span class="number">1</span> &lt;&lt; Command-&gt;Index)) &#123;</span><br><span class="line">        status = STATUS_ACCESS_DENIED;</span><br><span class="line">        InterlockedIncrement(&amp;SecMgr-&gt;Statistics.ValidationFailures);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��֤�������</span></span><br><span class="line">    <span class="keyword">switch</span> (Command-&gt;Index) &#123;</span><br><span class="line">        <span class="keyword">case</span> SD_CMD_APP_CMD:</span><br><span class="line">        <span class="keyword">case</span> SD_CMD_APP_SET_BUS_WIDTH:</span><br><span class="line">            <span class="comment">// ��֤ACMD����</span></span><br><span class="line">            status = RtsPciValidateACMD(SecMgr, Command);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SD_CMD_READ_MULTIPLE_BLOCK:</span><br><span class="line">        <span class="keyword">case</span> SD_CMD_WRITE_MULTIPLE_BLOCK:</span><br><span class="line">            <span class="comment">// ��֤���ݴ�������</span></span><br><span class="line">            status = RtsPciValidateDataTransfer(SecMgr, Command);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SD_CMD_ERASE_START:</span><br><span class="line">        <span class="keyword">case</span> SD_CMD_ERASE_END:</span><br><span class="line">        <span class="keyword">case</span> SD_CMD_ERASE:</span><br><span class="line">            <span class="comment">// ��֤��������</span></span><br><span class="line">            status = RtsPciValidateEraseCommand(SecMgr, Command);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="built_in">exit</span>:</span><br><span class="line">    KeReleaseSpinLock(&amp;SecMgr-&gt;CommandValidation.ValidationLock, oldIrql);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���ʿ���ʵ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciCheckAccess</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PSECURITY_MANAGER SecMgr,</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_OBJECT DeviceObject,</span></span><br><span class="line"><span class="params">    _In_ ACCESS_MASK DesiredAccess</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    BOOLEAN accessGranted = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �������Ƿ����÷��ʿ���</span></span><br><span class="line">    <span class="keyword">if</span> (!SecMgr-&gt;Policy.EnableAccessControl) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeAcquireSpinLock(&amp;SecMgr-&gt;AccessControl.AccessLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �������б�</span></span><br><span class="line">    PLIST_ENTRY entry;</span><br><span class="line">    <span class="keyword">for</span> (entry = SecMgr-&gt;AccessControl.AccessList.Flink;</span><br><span class="line">         entry != &amp;SecMgr-&gt;AccessControl.AccessList;</span><br><span class="line">         entry = entry-&gt;Flink) &#123;</span><br><span class="line">        PACCESS_ENTRY accessEntry = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            ACCESS_ENTRY,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (RtsPciMatchAccessEntry(accessEntry, DeviceObject, DesiredAccess)) &#123;</span><br><span class="line">            accessGranted = TRUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!accessGranted) &#123;</span><br><span class="line">        status = STATUS_ACCESS_DENIED;</span><br><span class="line">        InterlockedIncrement(&amp;SecMgr-&gt;Statistics.SecurityViolations);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ��¼Υ�����</span></span><br><span class="line">        KeQuerySystemTime(&amp;SecMgr-&gt;Statistics.LastViolationTime);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ֪ͨ��ȫ�¼�</span></span><br><span class="line">        RtsPciNotifySecurityViolation(SecMgr, DeviceObject, DesiredAccess);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;SecMgr-&gt;AccessControl.AccessLock, oldIrql);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="14-3-��ʱ�����ʹ���ָ�"><a href="#14-3-��ʱ�����ʹ���ָ�" class="headerlink" title="14.3 ��ʱ�����ʹ���ָ�"></a>14.3 ��ʱ�����ʹ���ָ�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��ʱ����������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">TIMEOUT_CONTEXT</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    KDPC TimeoutDpc;</span><br><span class="line">    KTIMER TimeoutTimer;</span><br><span class="line">    BOOLEAN TimerActive;</span><br><span class="line">    WDFREQUEST PendingRequest;</span><br><span class="line">    ULONG TimeoutValue;</span><br><span class="line">    PFN_TIMEOUT_CALLBACK TimeoutCallback;</span><br><span class="line">&#125; TIMEOUT_CONTEXT, *PTIMEOUT_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʱ����ʵ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciSetupTimeoutProtection</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ ULONG TimeoutValue,</span></span><br><span class="line"><span class="params">    _In_ PFN_TIMEOUT_CALLBACK TimeoutCallback</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PTIMEOUT_CONTEXT timeoutCtx;</span><br><span class="line">    LARGE_INTEGER dueTime;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �������Ƿ����ó�ʱ����</span></span><br><span class="line">    <span class="keyword">if</span> (!DevContext-&gt;SecurityManager-&gt;Policy.EnableTimeoutProtection) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ����ʱ������</span></span><br><span class="line">    timeoutCtx = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(TIMEOUT_CONTEXT),</span><br><span class="line">        <span class="string">&#x27;TOPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!timeoutCtx) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(timeoutCtx, <span class="keyword">sizeof</span>(TIMEOUT_CONTEXT));</span><br><span class="line">    timeoutCtx-&gt;DevContext = DevContext;</span><br><span class="line">    timeoutCtx-&gt;PendingRequest = Request;</span><br><span class="line">    timeoutCtx-&gt;TimeoutValue = TimeoutValue;</span><br><span class="line">    timeoutCtx-&gt;TimeoutCallback = TimeoutCallback;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʼ��DPC�Ͷ�ʱ��</span></span><br><span class="line">    KeInitializeDpc(</span><br><span class="line">        &amp;timeoutCtx-&gt;TimeoutDpc,</span><br><span class="line">        RtsPciTimeoutDpcRoutine,</span><br><span class="line">        timeoutCtx);</span><br><span class="line">        </span><br><span class="line">    KeInitializeTimer(&amp;timeoutCtx-&gt;TimeoutTimer);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���ó�ʱʱ��</span></span><br><span class="line">    dueTime.QuadPart = Int32x32To64(TimeoutValue, <span class="number">-10000</span>);</span><br><span class="line">    timeoutCtx-&gt;TimerActive = TRUE;</span><br><span class="line">    </span><br><span class="line">    KeSetTimer(</span><br><span class="line">        &amp;timeoutCtx-&gt;TimeoutTimer,</span><br><span class="line">        dueTime,</span><br><span class="line">        &amp;timeoutCtx-&gt;TimeoutDpc);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 5. ���泬ʱ������</span></span><br><span class="line">    WdfRequestSetContext(Request, timeoutCtx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʱDPC����</span></span><br><span class="line">VOID <span class="title function_">RtsPciTimeoutDpcRoutine</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PKDPC Dpc,</span></span><br><span class="line"><span class="params">    _In_ PVOID DeferredContext,</span></span><br><span class="line"><span class="params">    _In_ PVOID SystemArgument1,</span></span><br><span class="line"><span class="params">    _In_ PVOID SystemArgument2</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PTIMEOUT_CONTEXT timeoutCtx = (PTIMEOUT_CONTEXT)DeferredContext;</span><br><span class="line">    PSECURITY_MANAGER secMgr = timeoutCtx-&gt;DevContext-&gt;SecurityManager;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��������Ƿ���Ȼ��Ч</span></span><br><span class="line">    <span class="keyword">if</span> (!timeoutCtx-&gt;TimerActive) &#123;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ������ʱ</span></span><br><span class="line">    InterlockedIncrement(&amp;secMgr-&gt;Statistics.TimeoutCount);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (timeoutCtx-&gt;TimeoutCallback) &#123;</span><br><span class="line">        timeoutCtx-&gt;TimeoutCallback(</span><br><span class="line">            timeoutCtx-&gt;DevContext,</span><br><span class="line">            timeoutCtx-&gt;PendingRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ȡ������</span></span><br><span class="line">    WdfRequestComplete(</span><br><span class="line">        timeoutCtx-&gt;PendingRequest,</span><br><span class="line">        STATUS_TIMEOUT);</span><br><span class="line">        </span><br><span class="line">cleanup:</span><br><span class="line">    ExFreePool(timeoutCtx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����ָ�ʵ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleSecurityError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PSECURITY_MANAGER SecMgr,</span></span><br><span class="line"><span class="params">    _In_ NTSTATUS ErrorStatus,</span></span><br><span class="line"><span class="params">    _In_ ULONG ErrorFlags</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (ErrorStatus) &#123;</span><br><span class="line">        <span class="keyword">case</span> STATUS_ACCESS_DENIED:</span><br><span class="line">            <span class="comment">// ��������Υ��</span></span><br><span class="line">            status = RtsPciHandleAccessViolation(SecMgr, ErrorFlags);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> STATUS_TIMEOUT:</span><br><span class="line">            <span class="comment">// ������ʱ����</span></span><br><span class="line">            status = RtsPciHandleTimeout(SecMgr, ErrorFlags);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> STATUS_INVALID_PARAMETER:</span><br><span class="line">            <span class="comment">// ����������֤ʧ��</span></span><br><span class="line">            status = RtsPciHandleValidationFailure(SecMgr, ErrorFlags);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��¼����ͳ��</span></span><br><span class="line">    RtsPciUpdateSecurityStatistics(SecMgr, ErrorStatus);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>[���� - ��һ���ֽ���ϸ�������ܼ�غ��Ż�]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-48"><a href="#User-48" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-48"><a href="#AI-claude-3-5-sonnet-48" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ�����ܼ�غ��Ż����֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-14"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-14" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 14"></a>WDF SD Host Controller����ʵ����� - Part 14</h1><h2 id="15-���ܼ�غ��Z�"><a href="#15-���ܼ�غ��Z�" class="headerlink" title="15. ���ܼ�غ��Ż�"></a>15. ���ܼ�غ��Ż�</h2><h3 id="15-1-���ܼ����ʵ��"><a href="#15-1-���ܼ����ʵ��" class="headerlink" title="15.1 ���ܼ����ʵ��"></a>15.1 ���ܼ����ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ���ܼ���������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PERFORMANCE_COUNTERS</span> &#123;</span></span><br><span class="line">    <span class="comment">// IOͳ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LARGE_INTEGER TotalReadBytes;</span><br><span class="line">        LARGE_INTEGER TotalWriteBytes;</span><br><span class="line">        ULONG ReadCount;</span><br><span class="line">        ULONG WriteCount;</span><br><span class="line">        ULONG ReadErrors;</span><br><span class="line">        ULONG WriteErrors;</span><br><span class="line">    &#125; IO;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ӳ�ͳ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG AverageReadLatency;   <span class="comment">// ΢��</span></span><br><span class="line">        ULONG AverageWriteLatency;</span><br><span class="line">        ULONG MaxReadLatency;</span><br><span class="line">        ULONG MaxWriteLatency;</span><br><span class="line">        ULONG MinReadLatency;</span><br><span class="line">        ULONG MinWriteLatency;</span><br><span class="line">    &#125; Latency;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMAͳ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG DmaTransferCount;</span><br><span class="line">        ULONG DmaErrors;</span><br><span class="line">        LARGE_INTEGER TotalDmaBytes;</span><br><span class="line">        ULONG AverageDmaTime;</span><br><span class="line">    &#125; DMA;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ͳ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG AverageQueueDepth;</span><br><span class="line">        ULONG MaxQueueDepth;</span><br><span class="line">        ULONG QueueOverflows;</span><br><span class="line">        ULONG RequestTimeouts;</span><br><span class="line">    &#125; Queue;</span><br><span class="line">&#125; PERFORMANCE_COUNTERS, *PPERFORMANCE_COUNTERS;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���ܼ����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PERFORMANCE_MONITOR</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    PERFORMANCE_COUNTERS Counters;</span><br><span class="line">    KSPIN_LOCK CounterLock;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ܲ���</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        KTIMER SamplingTimer;</span><br><span class="line">        KDPC SamplingDpc;</span><br><span class="line">        ULONG SamplingInterval;    <span class="comment">// ����</span></span><br><span class="line">        BOOLEAN SamplingEnabled;</span><br><span class="line">    &#125; Sampling;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������ֵ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG LatencyThreshold;    <span class="comment">// ΢��</span></span><br><span class="line">        ULONG QueueDepthThreshold;</span><br><span class="line">        ULONG ErrorRateThreshold;  <span class="comment">// �ٷֱ�</span></span><br><span class="line">        BOOLEAN ThresholdEnabled;</span><br><span class="line">    &#125; Thresholds;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������־</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY LogEntries;</span><br><span class="line">        KSPIN_LOCK LogLock;</span><br><span class="line">        ULONG MaxLogEntries;</span><br><span class="line">        ULONG CurrentLogEntries;</span><br><span class="line">    &#125; Log;</span><br><span class="line">&#125; PERFORMANCE_MONITOR, *PPERFORMANCE_MONITOR;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ�����ܼ����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializePerformanceMonitor</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PPERFORMANCE_MONITOR perfMon;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �������ܼ����</span></span><br><span class="line">    perfMon = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(PERFORMANCE_MONITOR),</span><br><span class="line">        <span class="string">&#x27;PMPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!perfMon) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(perfMon, <span class="keyword">sizeof</span>(PERFORMANCE_MONITOR));</span><br><span class="line">    perfMon-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ�������б�</span></span><br><span class="line">    KeInitializeSpinLock(&amp;perfMon-&gt;CounterLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;perfMon-&gt;Log.LogLock);</span><br><span class="line">    InitializeListHead(&amp;perfMon-&gt;Log.LogEntries);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʼ��������ʱ����DPC</span></span><br><span class="line">    KeInitializeTimer(&amp;perfMon-&gt;Sampling.SamplingTimer);</span><br><span class="line">    KeInitializeDpc(</span><br><span class="line">        &amp;perfMon-&gt;Sampling.SamplingDpc,</span><br><span class="line">        RtsPciPerformanceSamplingDpc,</span><br><span class="line">        perfMon);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 4. ����Ĭ������</span></span><br><span class="line">    perfMon-&gt;Sampling.SamplingInterval = <span class="number">1000</span>;  <span class="comment">// 1��</span></span><br><span class="line">    perfMon-&gt;Sampling.SamplingEnabled = TRUE;</span><br><span class="line">    perfMon-&gt;Thresholds.LatencyThreshold = <span class="number">100000</span>;  <span class="comment">// 100ms</span></span><br><span class="line">    perfMon-&gt;Thresholds.QueueDepthThreshold = <span class="number">32</span>;</span><br><span class="line">    perfMon-&gt;Thresholds.ErrorRateThreshold = <span class="number">5</span>;     <span class="comment">// 5%</span></span><br><span class="line">    perfMon-&gt;Thresholds.ThresholdEnabled = TRUE;</span><br><span class="line">    perfMon-&gt;Log.MaxLogEntries = <span class="number">1000</span>;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;PerformanceMonitor = perfMon;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. �������ܲ���</span></span><br><span class="line">    <span class="keyword">if</span> (perfMon-&gt;Sampling.SamplingEnabled) &#123;</span><br><span class="line">        RtsPciStartPerformanceSampling(perfMon);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="15-2-�������ݲɼ��ͷ���"><a href="#15-2-�������ݲɼ��ͷ���" class="headerlink" title="15.2 �������ݲɼ��ͷ���"></a>15.2 �������ݲɼ��ͷ���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ���ܲ���DPC</span></span><br><span class="line">VOID <span class="title function_">RtsPciPerformanceSamplingDpc</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PKDPC Dpc,</span></span><br><span class="line"><span class="params">    _In_ PVOID DeferredContext,</span></span><br><span class="line"><span class="params">    _In_ PVOID SystemArgument1,</span></span><br><span class="line"><span class="params">    _In_ PVOID SystemArgument2</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PPERFORMANCE_MONITOR perfMon = (PPERFORMANCE_MONITOR)DeferredContext;</span><br><span class="line">    PERFORMANCE_SAMPLE sample = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �ռ���ǰ��������</span></span><br><span class="line">    KeAcquireSpinLock(&amp;perfMon-&gt;CounterLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// IO����</span></span><br><span class="line">    sample.ReadThroughput = </span><br><span class="line">        (perfMon-&gt;Counters.IO.TotalReadBytes.QuadPart -</span><br><span class="line">         perfMon-&gt;LastSample.TotalReadBytes) / </span><br><span class="line">        (perfMon-&gt;Sampling.SamplingInterval / <span class="number">1000</span>);</span><br><span class="line">         </span><br><span class="line">    sample.WriteThroughput = </span><br><span class="line">        (perfMon-&gt;Counters.IO.TotalWriteBytes.QuadPart -</span><br><span class="line">         perfMon-&gt;LastSample.TotalWriteBytes) / </span><br><span class="line">        (perfMon-&gt;Sampling.SamplingInterval / <span class="number">1000</span>);</span><br><span class="line">         </span><br><span class="line">    <span class="comment">// �ӳ�����</span></span><br><span class="line">    sample.CurrentReadLatency = perfMon-&gt;Counters.Latency.AverageReadLatency;</span><br><span class="line">    sample.CurrentWriteLatency = perfMon-&gt;Counters.Latency.AverageWriteLatency;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">    sample.CurrentQueueDepth = </span><br><span class="line">        WdfIoQueueGetCurrentDepth(perfMon-&gt;DevContext-&gt;IoQueue);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ������</span></span><br><span class="line">    sample.ErrorRate = </span><br><span class="line">        ((perfMon-&gt;Counters.IO.ReadErrors + </span><br><span class="line">          perfMon-&gt;Counters.IO.WriteErrors) * <span class="number">100</span>) /</span><br><span class="line">        (perfMon-&gt;Counters.IO.ReadCount + </span><br><span class="line">         perfMon-&gt;Counters.IO.WriteCount);</span><br><span class="line">         </span><br><span class="line">    KeReleaseSpinLock(&amp;perfMon-&gt;CounterLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ������������</span></span><br><span class="line">    RtsPciAnalyzePerformanceSample(perfMon, &amp;sample);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��¼������־</span></span><br><span class="line">    RtsPciLogPerformanceSample(perfMon, &amp;sample);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���������ֵ</span></span><br><span class="line">    <span class="keyword">if</span> (perfMon-&gt;Thresholds.ThresholdEnabled) &#123;</span><br><span class="line">        RtsPciCheckPerformanceThresholds(perfMon, &amp;sample);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. �����ϴβ�������</span></span><br><span class="line">    perfMon-&gt;LastSample = sample;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. �������ö�ʱ��</span></span><br><span class="line">    <span class="keyword">if</span> (perfMon-&gt;Sampling.SamplingEnabled) &#123;</span><br><span class="line">        LARGE_INTEGER dueTime;</span><br><span class="line">        dueTime.QuadPart = Int32x32To64(</span><br><span class="line">            <span class="number">-10000</span>,  <span class="comment">// 100ns units</span></span><br><span class="line">            perfMon-&gt;Sampling.SamplingInterval);</span><br><span class="line">            </span><br><span class="line">        KeSetTimer(</span><br><span class="line">            &amp;perfMon-&gt;Sampling.SamplingTimer,</span><br><span class="line">            dueTime,</span><br><span class="line">            &amp;perfMon-&gt;Sampling.SamplingDpc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �������ݷ���</span></span><br><span class="line">VOID <span class="title function_">RtsPciAnalyzePerformanceSample</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PPERFORMANCE_MONITOR PerfMon,</span></span><br><span class="line"><span class="params">    _In_ PPERFORMANCE_SAMPLE Sample</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ����IO����</span></span><br><span class="line">    <span class="keyword">if</span> (Sample-&gt;ReadThroughput &lt; </span><br><span class="line">        (PerfMon-&gt;LastSample.ReadThroughput * <span class="number">80</span> / <span class="number">100</span>)) &#123;</span><br><span class="line">        <span class="comment">// �������������½�</span></span><br><span class="line">        RtsPciHandlePerformanceDegradation(</span><br><span class="line">            PerfMon,</span><br><span class="line">            PerformanceMetricReadThroughput);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (Sample-&gt;WriteThroughput &lt; </span><br><span class="line">        (PerfMon-&gt;LastSample.WriteThroughput * <span class="number">80</span> / <span class="number">100</span>)) &#123;</span><br><span class="line">        <span class="comment">// д�����������½�</span></span><br><span class="line">        RtsPciHandlePerformanceDegradation(</span><br><span class="line">            PerfMon,</span><br><span class="line">            PerformanceMetricWriteThroughput);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����ӳ�����</span></span><br><span class="line">    <span class="keyword">if</span> (Sample-&gt;CurrentReadLatency &gt; </span><br><span class="line">        (PerfMon-&gt;LastSample.CurrentReadLatency * <span class="number">150</span> / <span class="number">100</span>)) &#123;</span><br><span class="line">        <span class="comment">// ���ӳ���������</span></span><br><span class="line">        RtsPciHandleLatencyIncrease(</span><br><span class="line">            PerfMon,</span><br><span class="line">            PerformanceMetricReadLatency);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��������״̬</span></span><br><span class="line">    <span class="keyword">if</span> (Sample-&gt;CurrentQueueDepth &gt;= </span><br><span class="line">        PerfMon-&gt;Thresholds.QueueDepthThreshold) &#123;</span><br><span class="line">        <span class="comment">// ����ӵ��</span></span><br><span class="line">        RtsPciHandleQueueCongestion(PerfMon);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����������</span></span><br><span class="line">    <span class="keyword">if</span> (Sample-&gt;ErrorRate &gt; PerfMon-&gt;Thresholds.ErrorRateThreshold) &#123;</span><br><span class="line">        <span class="comment">// �����ʹ���</span></span><br><span class="line">        RtsPciHandleHighErrorRate(PerfMon);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="15-3-�����Z�����"><a href="#15-3-�����Z�����" class="headerlink" title="15.3 �����Ż�����"></a>15.3 �����Ż�����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �����Ż�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PERFORMANCE_OPTIMIZATION_CONFIG</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableReadAhead;</span><br><span class="line">        BOOLEAN EnableWriteCoalescing;</span><br><span class="line">        ULONG ReadAheadSize;</span><br><span class="line">        ULONG WriteCoalescingSize;</span><br><span class="line">    &#125; IO;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableDynamicClocking;</span><br><span class="line">        BOOLEAN EnablePowerOptimization;</span><br><span class="line">        ULONG MinClockFrequency;</span><br><span class="line">        ULONG MaxClockFrequency;</span><br><span class="line">    &#125; Power;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableLoadBalancing;</span><br><span class="line">        BOOLEAN EnableQueueOptimization;</span><br><span class="line">        ULONG OptimalQueueDepth;</span><br><span class="line">        ULONG LoadBalanceInterval;</span><br><span class="line">    &#125; Queue;</span><br><span class="line">&#125; PERFORMANCE_OPTIMIZATION_CONFIG, *PPERFORMANCE_OPTIMIZATION_CONFIG;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �����Ż�������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PERFORMANCE_OPTIMIZER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    PERFORMANCE_OPTIMIZATION_CONFIG Config;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ǰ�Ż�״̬</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG CurrentClockFrequency;</span><br><span class="line">        ULONG CurrentQueueDepth;</span><br><span class="line">        BOOLEAN ReadAheadActive;</span><br><span class="line">        BOOLEAN WriteCoalescingActive;</span><br><span class="line">    &#125; CurrentState;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Ż�����</span></span><br><span class="line">    KSPIN_LOCK OptimizationLock;</span><br><span class="line">    KTIMER OptimizationTimer;</span><br><span class="line">    KDPC OptimizationDpc;</span><br><span class="line">&#125; PERFORMANCE_OPTIMIZER, *PPERFORMANCE_OPTIMIZER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ӧ�������Ż�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciApplyPerformanceOptimizations</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PPERFORMANCE_OPTIMIZER Optimizer,</span></span><br><span class="line"><span class="params">    _In_ PPERFORMANCE_SAMPLE Sample</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    KeAcquireSpinLock(&amp;Optimizer-&gt;OptimizationLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. IO�Ż�</span></span><br><span class="line">    <span class="keyword">if</span> (Optimizer-&gt;Config.IO.EnableReadAhead) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Sample-&gt;ReadThroughput &gt; </span><br><span class="line">            (Sample-&gt;WriteThroughput * <span class="number">2</span>)) &#123;</span><br><span class="line">            <span class="comment">// ���ܼ��͹������أ�����Ԥ��</span></span><br><span class="line">            status = RtsPciAdjustReadAhead(</span><br><span class="line">                Optimizer,</span><br><span class="line">                Optimizer-&gt;Config.IO.ReadAheadSize * <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (Optimizer-&gt;Config.IO.EnableWriteCoalescing) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Sample-&gt;CurrentQueueDepth &gt; </span><br><span class="line">            Optimizer-&gt;Config.Queue.OptimalQueueDepth) &#123;</span><br><span class="line">            <span class="comment">// ����ӵ��������д�ϲ�</span></span><br><span class="line">            status = RtsPciEnableWriteCoalescing(</span><br><span class="line">                Optimizer,</span><br><span class="line">                Optimizer-&gt;Config.IO.WriteCoalescingSize);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ʱ��Ƶ���Ż�</span></span><br><span class="line">    <span class="keyword">if</span> (Optimizer-&gt;Config.Power.EnableDynamicClocking) &#123;</span><br><span class="line">        ULONG targetFreq = RtsPciCalculateOptimalFrequency(</span><br><span class="line">            Optimizer,</span><br><span class="line">            Sample);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (targetFreq != Optimizer-&gt;CurrentState.CurrentClockFrequency) &#123;</span><br><span class="line">            status = RtsPciSetClockFrequency(</span><br><span class="line">                Optimizer-&gt;DevContext,</span><br><span class="line">                targetFreq);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">                Optimizer-&gt;CurrentState.CurrentClockFrequency = targetFreq;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �����Ż�</span></span><br><span class="line">    <span class="keyword">if</span> (Optimizer-&gt;Config.Queue.EnableQueueOptimization) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Sample-&gt;CurrentQueueDepth &gt; </span><br><span class="line">            Optimizer-&gt;Config.Queue.OptimalQueueDepth) &#123;</span><br><span class="line">            <span class="comment">// �����������</span></span><br><span class="line">            status = RtsPciAdjustQueueDepth(</span><br><span class="line">                Optimizer,</span><br><span class="line">                Optimizer-&gt;Config.Queue.OptimalQueueDepth);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;Optimizer-&gt;OptimizationLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>[���� - ��һ���ֽ���ϸ���ܸ߼�DMA����]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-49"><a href="#User-49" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-49"><a href="#AI-claude-3-5-sonnet-49" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼�DMA�������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-15"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-15" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 15"></a>WDF SD Host Controller����ʵ����� - Part 15</h1><h2 id="16-�߼�DMA����"><a href="#16-�߼�DMA����" class="headerlink" title="16. �߼�DMA����"></a>16. �߼�DMA����</h2><h3 id="16-1-DMA������ʵ��"><a href="#16-1-DMA������ʵ��" class="headerlink" title="16.1 DMA������ʵ��"></a>16.1 DMA������ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DMA����ģʽ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">DMA_TRANSFER_MODE</span> &#123;</span></span><br><span class="line">    DmaTransferModeSingle = <span class="number">0</span>,</span><br><span class="line">    DmaTransferModeMultiple,</span><br><span class="line">    DmaTransferModeScatter,</span><br><span class="line">    DmaTransferModeGather</span><br><span class="line">&#125; DMA_TRANSFER_MODE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DMA�������ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DMA_DESCRIPTOR</span> &#123;</span></span><br><span class="line">    PHYSICAL_ADDRESS PhysicalAddress;</span><br><span class="line">    ULONG Length;</span><br><span class="line">    ULONG Flags;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">DMA_DESCRIPTOR</span>* <span class="title">NextDescriptor</span>;</span></span><br><span class="line">    PVOID Context;</span><br><span class="line">&#125; DMA_DESCRIPTOR, *PDMA_DESCRIPTOR;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DMA����������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DMA_TRANSFER_CONTEXT</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    WDFREQUEST Request;</span><br><span class="line">    DMA_TRANSFER_MODE Mode;</span><br><span class="line">    PDMA_DESCRIPTOR FirstDescriptor;</span><br><span class="line">    PDMA_DESCRIPTOR CurrentDescriptor;</span><br><span class="line">    ULONG TotalLength;</span><br><span class="line">    ULONG TransferredLength;</span><br><span class="line">    BOOLEAN IsRead;</span><br><span class="line">    KEVENT CompletionEvent;</span><br><span class="line">    PFN_DMA_COMPLETION_ROUTINE CompletionRoutine;</span><br><span class="line">    PVOID CompletionContext;</span><br><span class="line">&#125; DMA_TRANSFER_CONTEXT, *PDMA_TRANSFER_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DMA������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DMA_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    WDFDMAENABLER DmaEnabler;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA����</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG MaxTransferLength;</span><br><span class="line">        ULONG AlignmentRequirement;</span><br><span class="line">        ULONG MaximumScatterGatherElements;</span><br><span class="line">        BOOLEAN DoubleBufferingEnabled;</span><br><span class="line">    &#125; Configuration;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMAͳ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG TotalTransfers;</span><br><span class="line">        ULONG FailedTransfers;</span><br><span class="line">        LARGE_INTEGER TotalBytesTransferred;</span><br><span class="line">        ULONG ActiveTransfers;</span><br><span class="line">    &#125; Statistics;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA��Դ����</span></span><br><span class="line">    LIST_ENTRY FreeDescriptorList;</span><br><span class="line">    LIST_ENTRY ActiveTransferList;</span><br><span class="line">    KSPIN_LOCK TransferLock;</span><br><span class="line">    NPAGED_LOOKASIDE_LIST DescriptorPool;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA�жϴ���</span></span><br><span class="line">    WDFINTERRUPT DmaInterrupt;</span><br><span class="line">    BOOLEAN InterruptEnabled;</span><br><span class="line">&#125; DMA_MANAGER, *PDMA_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ��DMA������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeDmaManager</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PDMA_MANAGER dmaManager;</span><br><span class="line">    WDF_DMA_ENABLER_CONFIG dmaConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����DMA������</span></span><br><span class="line">    dmaManager = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(DMA_MANAGER),</span><br><span class="line">        <span class="string">&#x27;DMPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!dmaManager) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(dmaManager, <span class="keyword">sizeof</span>(DMA_MANAGER));</span><br><span class="line">    dmaManager-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ��DMAʹ����</span></span><br><span class="line">    WDF_DMA_ENABLER_CONFIG_INIT(</span><br><span class="line">        &amp;dmaConfig,</span><br><span class="line">        WdfDmaProfileScatterGather,</span><br><span class="line">        DevContext-&gt;Capabilities.MaxTransferLength);</span><br><span class="line">        </span><br><span class="line">    status = WdfDmaEnablerCreate(</span><br><span class="line">        DevContext-&gt;Device,</span><br><span class="line">        &amp;dmaConfig,</span><br><span class="line">        WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">        &amp;dmaManager-&gt;DmaEnabler);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʼ����Դ����</span></span><br><span class="line">    InitializeListHead(&amp;dmaManager-&gt;FreeDescriptorList);</span><br><span class="line">    InitializeListHead(&amp;dmaManager-&gt;ActiveTransferList);</span><br><span class="line">    KeInitializeSpinLock(&amp;dmaManager-&gt;TransferLock);</span><br><span class="line">    </span><br><span class="line">    ExInitializeNPagedLookasideList(</span><br><span class="line">        &amp;dmaManager-&gt;DescriptorPool,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="keyword">sizeof</span>(DMA_DESCRIPTOR),</span><br><span class="line">        <span class="string">&#x27;DDPR&#x27;</span>,</span><br><span class="line">        <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 4. ����DMA����</span></span><br><span class="line">    dmaManager-&gt;Configuration.MaxTransferLength = </span><br><span class="line">        DevContext-&gt;Capabilities.MaxTransferLength;</span><br><span class="line">    dmaManager-&gt;Configuration.AlignmentRequirement = </span><br><span class="line">        DevContext-&gt;Capabilities.AlignmentRequirement;</span><br><span class="line">    dmaManager-&gt;Configuration.MaximumScatterGatherElements = </span><br><span class="line">        DevContext-&gt;Capabilities.MaxScatterGatherElements;</span><br><span class="line">    dmaManager-&gt;Configuration.DoubleBufferingEnabled = TRUE;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;DmaManager = dmaManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">cleanup:</span><br><span class="line">    <span class="keyword">if</span> (dmaManager) &#123;</span><br><span class="line">        ExFreePool(dmaManager);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






<h3 id="16-2-DMA�������"><a href="#16-2-DMA�������" class="headerlink" title="16.2 DMA�������"></a>16.2 DMA�������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ׼��DMA����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciPrepareDmaTransfer</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDMA_MANAGER DmaManager,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ DMA_TRANSFER_MODE Mode,</span></span><br><span class="line"><span class="params">    _In_ BOOLEAN IsRead</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PDMA_TRANSFER_CONTEXT transferCtx;</span><br><span class="line">    WDFMEMORY requestMemory;</span><br><span class="line">    WDF_DMA_DIRECTION direction;</span><br><span class="line">    SIZE_T length;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��������������</span></span><br><span class="line">    transferCtx = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(DMA_TRANSFER_CONTEXT),</span><br><span class="line">        <span class="string">&#x27;DTPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!transferCtx) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(transferCtx, <span class="keyword">sizeof</span>(DMA_TRANSFER_CONTEXT));</span><br><span class="line">    transferCtx-&gt;DevContext = DmaManager-&gt;DevContext;</span><br><span class="line">    transferCtx-&gt;Request = Request;</span><br><span class="line">    transferCtx-&gt;Mode = Mode;</span><br><span class="line">    transferCtx-&gt;IsRead = IsRead;</span><br><span class="line">    KeInitializeEvent(&amp;transferCtx-&gt;CompletionEvent, </span><br><span class="line">                     NotificationEvent, </span><br><span class="line">                     FALSE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ȡ�����ڴ�</span></span><br><span class="line">    status = WdfRequestRetrieveOutputMemory(Request, &amp;requestMemory);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    length = WdfMemoryGetLength(requestMemory);</span><br><span class="line">    direction = IsRead ? WdfDmaDirectionReadFromDevice : </span><br><span class="line">                        WdfDmaDirectionWriteToDevice;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����DMA��������</span></span><br><span class="line">    status = RtsPciBuildDmaDescriptors(</span><br><span class="line">        DmaManager,</span><br><span class="line">        transferCtx,</span><br><span class="line">        requestMemory,</span><br><span class="line">        length,</span><br><span class="line">        direction);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���ӵ�������б�</span></span><br><span class="line">    ExInterlockedInsertTailList(</span><br><span class="line">        &amp;DmaManager-&gt;ActiveTransferList,</span><br><span class="line">        &amp;transferCtx-&gt;ListEntry,</span><br><span class="line">        &amp;DmaManager-&gt;TransferLock);</span><br><span class="line">        </span><br><span class="line">    InterlockedIncrement(&amp;DmaManager-&gt;Statistics.ActiveTransfers);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����DMA����</span></span><br><span class="line">    status = RtsPciStartDmaTransfer(DmaManager, transferCtx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">cleanup:</span><br><span class="line">    <span class="keyword">if</span> (transferCtx) &#123;</span><br><span class="line">        RtsPciFreeDmaTransferContext(DmaManager, transferCtx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DMA������ɴ���</span></span><br><span class="line">VOID <span class="title function_">RtsPciDmaTransferComplete</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDMA_MANAGER DmaManager,</span></span><br><span class="line"><span class="params">    _In_ PDMA_TRANSFER_CONTEXT TransferCtx,</span></span><br><span class="line"><span class="params">    _In_ NTSTATUS CompletionStatus</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����ͳ����Ϣ</span></span><br><span class="line">    InterlockedDecrement(&amp;DmaManager-&gt;Statistics.ActiveTransfers);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(CompletionStatus)) &#123;</span><br><span class="line">        InterlockedIncrement(&amp;DmaManager-&gt;Statistics.TotalTransfers);</span><br><span class="line">        InterlockedAdd64(</span><br><span class="line">            &amp;DmaManager-&gt;Statistics.TotalBytesTransferred.QuadPart,</span><br><span class="line">            TransferCtx-&gt;TotalLength);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        InterlockedIncrement(&amp;DmaManager-&gt;Statistics.FailedTransfers);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �ӻ�б��Ƴ�</span></span><br><span class="line">    KeAcquireSpinLock(&amp;DmaManager-&gt;TransferLock, &amp;oldIrql);</span><br><span class="line">    RemoveEntryList(&amp;TransferCtx-&gt;ListEntry);</span><br><span class="line">    KeReleaseSpinLock(&amp;DmaManager-&gt;TransferLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ������ɻص�</span></span><br><span class="line">    <span class="keyword">if</span> (TransferCtx-&gt;CompletionRoutine) &#123;</span><br><span class="line">        TransferCtx-&gt;CompletionRoutine(</span><br><span class="line">            TransferCtx-&gt;DevContext,</span><br><span class="line">            TransferCtx-&gt;Request,</span><br><span class="line">            CompletionStatus,</span><br><span class="line">            TransferCtx-&gt;CompletionContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �ͷ���Դ</span></span><br><span class="line">    RtsPciFreeDmaTransferContext(DmaManager, TransferCtx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ��������¼�</span></span><br><span class="line">    KeSetEvent(&amp;TransferCtx-&gt;CompletionEvent, <span class="number">0</span>, FALSE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






<h3 id="16-3-DMA�жϴ���"><a href="#16-3-DMA�жϴ���" class="headerlink" title="16.3 DMA�жϴ���"></a>16.3 DMA�жϴ���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DMA�жϷ�������</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciDmaInterruptIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ ULONG MessageID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDMA_MANAGER dmaManager;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    BOOLEAN handled = FALSE;</span><br><span class="line">    ULONG dmaStatus;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(WdfInterruptGetDevice(Interrupt));</span><br><span class="line">    dmaManager = devContext-&gt;DmaManager;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡDMA״̬</span></span><br><span class="line">    dmaStatus = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + DMA_STATUS_REG);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!(dmaStatus &amp; DMA_STATUS_INTERRUPT)) &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����ж�״̬</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + DMA_STATUS_REG,</span><br><span class="line">        dmaStatus);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. ���DMA����</span></span><br><span class="line">    <span class="keyword">if</span> (dmaStatus &amp; DMA_STATUS_ERROR) &#123;</span><br><span class="line">        RtsPciHandleDmaError(dmaManager, dmaStatus);</span><br><span class="line">        handled = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ��鴫�����</span></span><br><span class="line">    <span class="keyword">if</span> (dmaStatus &amp; DMA_STATUS_COMPLETE) &#123;</span><br><span class="line">        RtsPciHandleDmaComplete(dmaManager, dmaStatus);</span><br><span class="line">        handled = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DMA������</span></span><br><span class="line">VOID <span class="title function_">RtsPciHandleDmaError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDMA_MANAGER DmaManager,</span></span><br><span class="line"><span class="params">    _In_ ULONG ErrorStatus</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PLIST_ENTRY entry;</span><br><span class="line">    PDMA_TRANSFER_CONTEXT transferCtx;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ֹͣ����DMA����</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DmaManager-&gt;DevContext-&gt;RegisterBase + DMA_CONTROL_REG,</span><br><span class="line">        DMA_CONTROL_STOP);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. �������л����</span></span><br><span class="line">    KeAcquireSpinLock(&amp;DmaManager-&gt;TransferLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (entry = DmaManager-&gt;ActiveTransferList.Flink;</span><br><span class="line">         entry != &amp;DmaManager-&gt;ActiveTransferList;</span><br><span class="line">         entry = entry-&gt;Flink) &#123;</span><br><span class="line">        transferCtx = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            DMA_TRANSFER_CONTEXT,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// ��ɴ��䣬�������</span></span><br><span class="line">        RtsPciDmaTransferComplete(</span><br><span class="line">            DmaManager,</span><br><span class="line">            transferCtx,</span><br><span class="line">            STATUS_DEVICE_DATA_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;DmaManager-&gt;TransferLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����DMA������</span></span><br><span class="line">    RtsPciResetDmaController(DmaManager);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DMA��ɴ���</span></span><br><span class="line">VOID <span class="title function_">RtsPciHandleDmaComplete</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDMA_MANAGER DmaManager,</span></span><br><span class="line"><span class="params">    _In_ ULONG Status</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PLIST_ENTRY entry;</span><br><span class="line">    PDMA_TRANSFER_CONTEXT transferCtx;</span><br><span class="line">    ULONG completedLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ��ɵĴ��䳤��</span></span><br><span class="line">    completedLength = READ_REGISTER_ULONG(</span><br><span class="line">        DmaManager-&gt;DevContext-&gt;RegisterBase + DMA_TRANSFERRED_REG);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. ���Ҷ�Ӧ�Ĵ���������</span></span><br><span class="line">    KeAcquireSpinLock(&amp;DmaManager-&gt;TransferLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    entry = DmaManager-&gt;ActiveTransferList.Flink;</span><br><span class="line">    <span class="keyword">if</span> (entry != &amp;DmaManager-&gt;ActiveTransferList) &#123;</span><br><span class="line">        transferCtx = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            DMA_TRANSFER_CONTEXT,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// ���´��䳤��</span></span><br><span class="line">        transferCtx-&gt;TransferredLength += completedLength;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����Ƿ�������д���</span></span><br><span class="line">        <span class="keyword">if</span> (transferCtx-&gt;TransferredLength &gt;= transferCtx-&gt;TotalLength) &#123;</span><br><span class="line">            RtsPciDmaTransferComplete(</span><br><span class="line">                DmaManager,</span><br><span class="line">                transferCtx,</span><br><span class="line">                STATUS_SUCCESS);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ������һ��������</span></span><br><span class="line">            RtsPciStartNextDmaDescriptor(DmaManager, transferCtx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;DmaManager-&gt;TransferLock, oldIrql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






<p>[���� - ��һ���ֽ���ϸ���ܸ߼���Դ����]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-50"><a href="#User-50" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-50"><a href="#AI-claude-3-5-sonnet-50" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼���Դ�������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-16"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-16" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 16"></a>WDF SD Host Controller����ʵ����� - Part 16</h1><h2 id="17-�߼���Դ����"><a href="#17-�߼���Դ����" class="headerlink" title="17. �߼���Դ����"></a>17. �߼���Դ����</h2><h3 id="17-1-��Դ���Թ�����ʵ��"><a href="#17-1-��Դ���Թ�����ʵ��" class="headerlink" title="17.1 ��Դ���Թ�����ʵ��"></a>17.1 ��Դ���Թ�����ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��Դ״̬����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">DEVICE_POWER_STATE_EX</span> &#123;</span></span><br><span class="line">    PowerStateD0Active = <span class="number">0</span>,    <span class="comment">// ��ȫ����״̬</span></span><br><span class="line">    PowerStateD0Idle,          <span class="comment">// ����״̬</span></span><br><span class="line">    PowerStateD1Light,         <span class="comment">// ���˯��</span></span><br><span class="line">    PowerStateD2Standby,       <span class="comment">// ����״̬</span></span><br><span class="line">    PowerStateD3Sleep,         <span class="comment">// ���˯��</span></span><br><span class="line">    PowerStateD3Off            <span class="comment">// ��ȫ�ر�</span></span><br><span class="line">&#125; DEVICE_POWER_STATE_EX;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ��������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">POWER_POLICY_CONFIG</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableIdleDetection;</span><br><span class="line">        ULONG IdleTimeout;           <span class="comment">// ����</span></span><br><span class="line">        DEVICE_POWER_STATE_EX IdleState;</span><br><span class="line">    &#125; Idle;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableDynamicPower;</span><br><span class="line">        ULONG PerformanceThreshold;  <span class="comment">// �ٷֱ�</span></span><br><span class="line">        ULONG PowerSavingThreshold;</span><br><span class="line">    &#125; Dynamic;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableWakeSupport;</span><br><span class="line">        ULONG WakeSignals;</span><br><span class="line">        DEVICE_POWER_STATE_EX DeepestWakeState;</span><br><span class="line">    &#125; Wake;</span><br><span class="line">&#125; POWER_POLICY_CONFIG, *PPOWER_POLICY_CONFIG;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">POWER_MANAGER_EX</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    POWER_POLICY_CONFIG PolicyConfig;</span><br><span class="line">    DEVICE_POWER_STATE_EX CurrentState;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ״̬����</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LARGE_INTEGER LastStateChangeTime;</span><br><span class="line">        ULONG StateTransitions;</span><br><span class="line">        ULONG FailedTransitions;</span><br><span class="line">        DEVICE_POWER_STATE_EX LastState;</span><br><span class="line">    &#125; StateTracking;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���м��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        KTIMER IdleTimer;</span><br><span class="line">        KDPC IdleDpc;</span><br><span class="line">        BOOLEAN IdleTimerActive;</span><br><span class="line">        LARGE_INTEGER LastActivityTime;</span><br><span class="line">    &#125; IdleDetection;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��̬��Դ����</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG CurrentPerformanceLevel;</span><br><span class="line">        ULONG CurrentPowerLevel;</span><br><span class="line">        KSPIN_LOCK PowerLock;</span><br><span class="line">        KEVENT PowerEvent;</span><br><span class="line">    &#125; DynamicPower;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ѹ���</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN WakeEnabled;</span><br><span class="line">        ULONG WakeReason;</span><br><span class="line">        LIST_ENTRY WakeSourceList;</span><br><span class="line">        KSPIN_LOCK WakeLock;</span><br><span class="line">    &#125; WakeManagement;</span><br><span class="line">&#125; POWER_MANAGER_EX, *PPOWER_MANAGER_EX;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ����Դ������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializePowerManagerEx</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PPOWER_MANAGER_EX powerMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����Դ������</span></span><br><span class="line">    powerMgr = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(POWER_MANAGER_EX),</span><br><span class="line">        <span class="string">&#x27;PMEX&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!powerMgr) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(powerMgr, <span class="keyword">sizeof</span>(POWER_MANAGER_EX));</span><br><span class="line">    powerMgr-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ���������</span></span><br><span class="line">    KeInitializeSpinLock(&amp;powerMgr-&gt;DynamicPower.PowerLock);</span><br><span class="line">    KeInitializeEvent(&amp;powerMgr-&gt;DynamicPower.PowerEvent, </span><br><span class="line">                     NotificationEvent, </span><br><span class="line">                     FALSE);</span><br><span class="line">    InitializeListHead(&amp;powerMgr-&gt;WakeManagement.WakeSourceList);</span><br><span class="line">    KeInitializeSpinLock(&amp;powerMgr-&gt;WakeManagement.WakeLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʼ�����м��</span></span><br><span class="line">    KeInitializeTimer(&amp;powerMgr-&gt;IdleDetection.IdleTimer);</span><br><span class="line">    KeInitializeDpc(</span><br><span class="line">        &amp;powerMgr-&gt;IdleDetection.IdleDpc,</span><br><span class="line">        RtsPciIdleTimeoutDpc,</span><br><span class="line">        powerMgr);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 4. ����Ĭ�ϲ���</span></span><br><span class="line">    powerMgr-&gt;PolicyConfig.Idle.EnableIdleDetection = TRUE;</span><br><span class="line">    powerMgr-&gt;PolicyConfig.Idle.IdleTimeout = <span class="number">5000</span>;    <span class="comment">// 5��</span></span><br><span class="line">    powerMgr-&gt;PolicyConfig.Idle.IdleState = PowerStateD1Light;</span><br><span class="line">    </span><br><span class="line">    powerMgr-&gt;PolicyConfig.Dynamic.EnableDynamicPower = TRUE;</span><br><span class="line">    powerMgr-&gt;PolicyConfig.Dynamic.PerformanceThreshold = <span class="number">80</span>;</span><br><span class="line">    powerMgr-&gt;PolicyConfig.Dynamic.PowerSavingThreshold = <span class="number">30</span>;</span><br><span class="line">    </span><br><span class="line">    powerMgr-&gt;PolicyConfig.Wake.EnableWakeSupport = TRUE;</span><br><span class="line">    powerMgr-&gt;PolicyConfig.Wake.DeepestWakeState = PowerStateD2Standby;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;PowerManagerEx = powerMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="17-2-��̬��Դ����"><a href="#17-2-��̬��Դ����" class="headerlink" title="17.2 ��̬��Դ����"></a>17.2 ��̬��Դ����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��̬��Դ����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciAdjustPowerState</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PPOWER_MANAGER_EX PowerMgr,</span></span><br><span class="line"><span class="params">    _In_ ULONG WorkloadLevel</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    DEVICE_POWER_STATE_EX targetState;</span><br><span class="line">    ULONG targetPowerLevel;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ȷ��Ŀ���Դ״̬</span></span><br><span class="line">    KeAcquireSpinLock(&amp;PowerMgr-&gt;DynamicPower.PowerLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (WorkloadLevel &gt;= PowerMgr-&gt;PolicyConfig.Dynamic.PerformanceThreshold) &#123;</span><br><span class="line">        <span class="comment">// �߸��� - ��������</span></span><br><span class="line">        targetState = PowerStateD0Active;</span><br><span class="line">        targetPowerLevel = <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (WorkloadLevel &lt;= PowerMgr-&gt;PolicyConfig.Dynamic.PowerSavingThreshold) &#123;</span><br><span class="line">        <span class="comment">// �͸��� - ����ģʽ</span></span><br><span class="line">        targetState = PowerStateD0Idle;</span><br><span class="line">        targetPowerLevel = <span class="number">50</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// �еȸ��� - ƽ��ģʽ</span></span><br><span class="line">        targetState = PowerStateD0Active;</span><br><span class="line">        targetPowerLevel = <span class="number">75</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ִ��״̬ת��</span></span><br><span class="line">    <span class="keyword">if</span> (targetState != PowerMgr-&gt;CurrentState) &#123;</span><br><span class="line">        status = RtsPciTransitionPowerState(</span><br><span class="line">            PowerMgr,</span><br><span class="line">            PowerMgr-&gt;CurrentState,</span><br><span class="line">            targetState);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            PowerMgr-&gt;CurrentState = targetState;</span><br><span class="line">            PowerMgr-&gt;StateTracking.StateTransitions++;</span><br><span class="line">            PowerMgr-&gt;StateTracking.LastStateChangeTime = KeQueryInterruptTime();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            PowerMgr-&gt;StateTracking.FailedTransitions++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �������ʼ���</span></span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status) &amp;&amp; </span><br><span class="line">        targetPowerLevel != PowerMgr-&gt;DynamicPower.CurrentPowerLevel) &#123;</span><br><span class="line">        status = RtsPciSetPowerLevel(</span><br><span class="line">            PowerMgr-&gt;DevContext,</span><br><span class="line">            targetPowerLevel);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            PowerMgr-&gt;DynamicPower.CurrentPowerLevel = targetPowerLevel;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;PowerMgr-&gt;DynamicPower.PowerLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ״̬ת��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciTransitionPowerState</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PPOWER_MANAGER_EX PowerMgr,</span></span><br><span class="line"><span class="params">    _In_ DEVICE_POWER_STATE_EX CurrentState,</span></span><br><span class="line"><span class="params">    _In_ DEVICE_POWER_STATE_EX TargetState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    POWER_TRANSITION_CONTEXT transCtx = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ׼��ת��������</span></span><br><span class="line">    transCtx.OldState = CurrentState;</span><br><span class="line">    transCtx.NewState = TargetState;</span><br><span class="line">    transCtx.SaveContext = (TargetState &gt; PowerStateD0Idle);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ִ��Ԥת������</span></span><br><span class="line">    status = RtsPciPrePowerTransition(PowerMgr, &amp;transCtx);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �����豸������(�����Ҫ)</span></span><br><span class="line">    <span class="keyword">if</span> (transCtx.SaveContext) &#123;</span><br><span class="line">        status = RtsPciSaveDeviceContext(PowerMgr-&gt;DevContext);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">return</span> status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����Ӳ����Դ״̬</span></span><br><span class="line">    status = RtsPciSetHardwarePowerState(</span><br><span class="line">        PowerMgr-&gt;DevContext,</span><br><span class="line">        TargetState);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="comment">// �ع��ѱ����������</span></span><br><span class="line">        <span class="keyword">if</span> (transCtx.SaveContext) &#123;</span><br><span class="line">            RtsPciRestoreDeviceContext(PowerMgr-&gt;DevContext);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ִ�к�ת������</span></span><br><span class="line">    status = RtsPciPostPowerTransition(PowerMgr, &amp;transCtx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="17-3-���ѹ���"><a href="#17-3-���ѹ���" class="headerlink" title="17.3 ���ѹ���"></a>17.3 ���ѹ���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ����Դ����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">WAKE_SOURCE_CONFIG</span> &#123;</span></span><br><span class="line">    ULONG SourceId;</span><br><span class="line">    ULONG WakeSignal;</span><br><span class="line">    BOOLEAN Enabled;</span><br><span class="line">    DEVICE_POWER_STATE_EX MinWakeState;</span><br><span class="line">    DEVICE_POWER_STATE_EX MaxWakeState;</span><br><span class="line">&#125; WAKE_SOURCE_CONFIG, *PWAKE_SOURCE_CONFIG;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���û���Դ</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciConfigureWakeSource</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PPOWER_MANAGER_EX PowerMgr,</span></span><br><span class="line"><span class="params">    _In_ PWAKE_SOURCE_CONFIG WakeConfig</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PWAKE_SOURCE_ENTRY wakeEntry;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��֤����</span></span><br><span class="line">    <span class="keyword">if</span> (WakeConfig-&gt;MinWakeState &gt; PowerMgr-&gt;PolicyConfig.Wake.DeepestWakeState) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���份��Դ��Ŀ</span></span><br><span class="line">    wakeEntry = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(WAKE_SOURCE_ENTRY),</span><br><span class="line">        <span class="string">&#x27;WSPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!wakeEntry) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlCopyMemory(&amp;wakeEntry-&gt;Config, </span><br><span class="line">                  WakeConfig, </span><br><span class="line">                  <span class="keyword">sizeof</span>(WAKE_SOURCE_CONFIG));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����Ӳ������Դ</span></span><br><span class="line">    status = RtsPciSetupHardwareWakeSource(</span><br><span class="line">        PowerMgr-&gt;DevContext,</span><br><span class="line">        WakeConfig);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        ExFreePool(wakeEntry);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���ӵ�����Դ�б�</span></span><br><span class="line">    KeAcquireSpinLock(&amp;PowerMgr-&gt;WakeManagement.WakeLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    InsertTailList(</span><br><span class="line">        &amp;PowerMgr-&gt;WakeManagement.WakeSourceList,</span><br><span class="line">        &amp;wakeEntry-&gt;ListEntry);</span><br><span class="line">        </span><br><span class="line">    PowerMgr-&gt;WakeManagement.WakeEnabled = TRUE;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;PowerMgr-&gt;WakeManagement.WakeLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���������¼�</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciHandleWakeEvent</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PPOWER_MANAGER_EX PowerMgr,</span></span><br><span class="line"><span class="params">    _In_ ULONG WakeReason</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    BOOLEAN handled = FALSE;</span><br><span class="line">    PLIST_ENTRY entry;</span><br><span class="line">    PWAKE_SOURCE_ENTRY wakeEntry;</span><br><span class="line">    </span><br><span class="line">    KeAcquireSpinLock(&amp;PowerMgr-&gt;WakeManagement.WakeLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���Ҵ����Ļ���Դ</span></span><br><span class="line">    <span class="keyword">for</span> (entry = PowerMgr-&gt;WakeManagement.WakeSourceList.Flink;</span><br><span class="line">         entry != &amp;PowerMgr-&gt;WakeManagement.WakeSourceList;</span><br><span class="line">         entry = entry-&gt;Flink) &#123;</span><br><span class="line">        wakeEntry = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            WAKE_SOURCE_ENTRY,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (wakeEntry-&gt;Config.WakeSignal &amp; WakeReason) &#123;</span><br><span class="line">            <span class="comment">// �ҵ�ƥ��Ļ���Դ</span></span><br><span class="line">            PowerMgr-&gt;WakeManagement.WakeReason = WakeReason;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. ִ�л��Ѵ���</span></span><br><span class="line">            status = RtsPciProcessWakeup(</span><br><span class="line">                PowerMgr,</span><br><span class="line">                wakeEntry);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">                handled = TRUE;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;PowerMgr-&gt;WakeManagement.WakeLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ֪ͨϵͳ�����¼�</span></span><br><span class="line">    <span class="keyword">if</span> (handled) &#123;</span><br><span class="line">        PoSetSystemState(PowerSystemWorking);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






<p>[���� - ��һ���ֽ���ϸ���ܸ߼��жϴ���]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-51"><a href="#User-51" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-51"><a href="#AI-claude-3-5-sonnet-51" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼��жϴ������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-17"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-17" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 17"></a>WDF SD Host Controller����ʵ����� - Part 17</h1><h2 id="18-�߼��жϴ���"><a href="#18-�߼��жϴ���" class="headerlink" title="18. �߼��жϴ���"></a>18. �߼��жϴ���</h2><h3 id="18-1-�жϹ�����ʵ��"><a href="#18-1-�жϹ�����ʵ��" class="headerlink" title="18.1 �жϹ�����ʵ��"></a>18.1 �жϹ�����ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �ж����Ͷ���</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">INTERRUPT_TYPE</span> &#123;</span></span><br><span class="line">    InterruptTypeNormal = <span class="number">0</span>,</span><br><span class="line">    InterruptTypeDma,</span><br><span class="line">    InterruptTypeError,</span><br><span class="line">    InterruptTypeCardDetect,</span><br><span class="line">    InterruptTypeWake,</span><br><span class="line">    InterruptTypeMax</span><br><span class="line">&#125; INTERRUPT_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �жϴ���������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">INTERRUPT_CONTEXT</span> &#123;</span></span><br><span class="line">    INTERRUPT_TYPE Type;</span><br><span class="line">    ULONG InterruptStatus;</span><br><span class="line">    ULONG ErrorStatus;</span><br><span class="line">    BOOLEAN IsMsi;</span><br><span class="line">    ULONG MessageId;</span><br><span class="line">    ULONG ProcessorNumber;</span><br><span class="line">    LARGE_INTEGER Timestamp;</span><br><span class="line">&#125; INTERRUPT_CONTEXT, *PINTERRUPT_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �жϹ�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">INTERRUPT_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    WDFINTERRUPT Interrupts[InterruptTypeMax];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ж�����</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN MsiEnabled;</span><br><span class="line">        BOOLEAN MsiXEnabled;</span><br><span class="line">        ULONG NumMessageRequested;</span><br><span class="line">        ULONG NumMessageAssigned;</span><br><span class="line">        ULONG InterruptModeration;</span><br><span class="line">    &#125; Configuration;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ж�ͳ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG InterruptCount[InterruptTypeMax];</span><br><span class="line">        ULONG SpuriousCount;</span><br><span class="line">        ULONG DpcCount;</span><br><span class="line">        ULONG CoalescedCount;</span><br><span class="line">        LARGE_INTEGER LastInterruptTime;</span><br><span class="line">        KSPIN_LOCK StatsLock;</span><br><span class="line">    &#125; Statistics;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �жϺϲ�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN CoalescingEnabled;</span><br><span class="line">        ULONG CoalescingThreshold;</span><br><span class="line">        ULONG CoalescingTimeout;    <span class="comment">// ΢��</span></span><br><span class="line">        LIST_ENTRY PendingList;</span><br><span class="line">        KSPIN_LOCK CoalesceLock;</span><br><span class="line">        KTIMER CoalesceTimer;</span><br><span class="line">        KDPC CoalesceDpc;</span><br><span class="line">    &#125; Coalescing;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ж���������</span></span><br><span class="line">    ULONG MessageTable[InterruptTypeMax];</span><br><span class="line">    KSPIN_LOCK MessageLock;</span><br><span class="line">&#125; INTERRUPT_MANAGER, *PINTERRUPT_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ���жϹ�����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeInterruptManager</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PINTERRUPT_MANAGER intManager;</span><br><span class="line">    WDF_INTERRUPT_CONFIG intConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����жϹ�����</span></span><br><span class="line">    intManager = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(INTERRUPT_MANAGER),</span><br><span class="line">        <span class="string">&#x27;IMPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!intManager) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(intManager, <span class="keyword">sizeof</span>(INTERRUPT_MANAGER));</span><br><span class="line">    intManager-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ�������б�</span></span><br><span class="line">    KeInitializeSpinLock(&amp;intManager-&gt;Statistics.StatsLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;intManager-&gt;Coalescing.CoalesceLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;intManager-&gt;MessageLock);</span><br><span class="line">    InitializeListHead(&amp;intManager-&gt;Coalescing.PendingList);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʼ���жϺϲ���ʱ��</span></span><br><span class="line">    KeInitializeTimer(&amp;intManager-&gt;Coalescing.CoalesceTimer);</span><br><span class="line">    KeInitializeDpc(</span><br><span class="line">        &amp;intManager-&gt;Coalescing.CoalesceDpc,</span><br><span class="line">        RtsPciInterruptCoalesceDpc,</span><br><span class="line">        intManager);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 4. �����ж�</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; InterruptTypeMax; i++) &#123;</span><br><span class="line">        WDF_INTERRUPT_CONFIG_INIT(</span><br><span class="line">            &amp;intConfig,</span><br><span class="line">            RtsPciInterruptIsr,</span><br><span class="line">            RtsPciInterruptDpc);</span><br><span class="line">            </span><br><span class="line">        intConfig.InterruptTranslated = TRUE;</span><br><span class="line">        intConfig.PassiveHandling = FALSE;</span><br><span class="line">        </span><br><span class="line">        status = WdfInterruptCreate(</span><br><span class="line">            DevContext-&gt;Device,</span><br><span class="line">            &amp;intConfig,</span><br><span class="line">            WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">            &amp;intManager-&gt;Interrupts[i]);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����Ĭ������</span></span><br><span class="line">    intManager-&gt;Configuration.MsiEnabled = TRUE;</span><br><span class="line">    intManager-&gt;Configuration.NumMessageRequested = InterruptTypeMax;</span><br><span class="line">    intManager-&gt;Configuration.InterruptModeration = <span class="number">1000</span>;  <span class="comment">// 1ms</span></span><br><span class="line">    </span><br><span class="line">    intManager-&gt;Coalescing.CoalescingEnabled = TRUE;</span><br><span class="line">    intManager-&gt;Coalescing.CoalescingThreshold = <span class="number">8</span>;</span><br><span class="line">    intManager-&gt;Coalescing.CoalescingTimeout = <span class="number">100</span>;  <span class="comment">// 100us</span></span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;InterruptManager = intManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">cleanup:</span><br><span class="line">    RtsPciCleanupInterruptManager(intManager);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>








<h3 id="18-2-�жϴ����ͷַ�"><a href="#18-2-�жϴ����ͷַ�" class="headerlink" title="18.2 �жϴ����ͷַ�"></a>18.2 �жϴ����ͷַ�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �жϷ�������</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciInterruptIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ ULONG MessageID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PINTERRUPT_MANAGER intManager;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    INTERRUPT_CONTEXT intContext = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    BOOLEAN handled = FALSE;</span><br><span class="line">    ULONG status, error;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(WdfInterruptGetDevice(Interrupt));</span><br><span class="line">    intManager = devContext-&gt;InterruptManager;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ�ж�״̬</span></span><br><span class="line">    status = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_STATUS_REG);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!(status &amp; HOST_INT_STATUS_MASK)) &#123;</span><br><span class="line">        InterlockedIncrement(&amp;intManager-&gt;Statistics.SpuriousCount);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ׼���ж�������</span></span><br><span class="line">    intContext.InterruptStatus = status;</span><br><span class="line">    intContext.IsMsi = intManager-&gt;Configuration.MsiEnabled;</span><br><span class="line">    intContext.MessageId = MessageID;</span><br><span class="line">    intContext.ProcessorNumber = KeGetCurrentProcessorNumber();</span><br><span class="line">    KeQuerySystemTime(&amp;intContext.Timestamp);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �������ж�</span></span><br><span class="line">    <span class="keyword">if</span> (status &amp; HOST_INT_ERROR_MASK) &#123;</span><br><span class="line">        error = READ_REGISTER_ULONG(</span><br><span class="line">            devContext-&gt;RegisterBase + HOST_ERROR_STATUS_REG);</span><br><span class="line">        intContext.ErrorStatus = error;</span><br><span class="line">        intContext.Type = InterruptTypeError;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ���������ж�</span></span><br><span class="line">        handled = RtsPciHandleErrorInterrupt(intManager, &amp;intContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���DMA�ж�</span></span><br><span class="line">    <span class="keyword">if</span> (status &amp; HOST_INT_DMA_MASK) &#123;</span><br><span class="line">        intContext.Type = InterruptTypeDma;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����DMA�ж�</span></span><br><span class="line">        handled |= RtsPciHandleDmaInterrupt(intManager, &amp;intContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ��鿨����ж�</span></span><br><span class="line">    <span class="keyword">if</span> (status &amp; HOST_INT_CARD_DETECT_MASK) &#123;</span><br><span class="line">        intContext.Type = InterruptTypeCardDetect;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����������ж�</span></span><br><span class="line">        handled |= RtsPciHandleCardDetectInterrupt(intManager, &amp;intContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ����ͳ����Ϣ</span></span><br><span class="line">    <span class="keyword">if</span> (handled) &#123;</span><br><span class="line">        InterlockedIncrement(&amp;intManager-&gt;Statistics.InterruptCount[intContext.Type]);</span><br><span class="line">        intManager-&gt;Statistics.LastInterruptTime = intContext.Timestamp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7. ����ж�״̬</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_STATUS_REG,</span><br><span class="line">        status);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �ж�DPC����</span></span><br><span class="line">VOID <span class="title function_">RtsPciInterruptDpc</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ WDFOBJECT AssociatedObject</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PINTERRUPT_MANAGER intManager;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(WdfInterruptGetDevice(Interrupt));</span><br><span class="line">    intManager = devContext-&gt;InterruptManager;</span><br><span class="line">    </span><br><span class="line">    InterlockedIncrement(&amp;intManager-&gt;Statistics.DpcCount);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����Ƿ���Ҫ�жϺϲ�</span></span><br><span class="line">    <span class="keyword">if</span> (intManager-&gt;Coalescing.CoalescingEnabled) &#123;</span><br><span class="line">        KeAcquireSpinLock(&amp;intManager-&gt;Coalescing.CoalesceLock, &amp;oldIrql);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!IsListEmpty(&amp;intManager-&gt;Coalescing.PendingList)) &#123;</span><br><span class="line">            <span class="comment">// �����ϲ����ж�</span></span><br><span class="line">            RtsPciProcessCoalescedInterrupts(intManager);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        KeReleaseSpinLock(&amp;intManager-&gt;Coalescing.CoalesceLock, oldIrql);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����DPC����Ĺ���</span></span><br><span class="line">    RtsPciProcessDpcWork(intManager);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>








<h3 id="18-3-�жϺϲ��Z�"><a href="#18-3-�жϺϲ��Z�" class="headerlink" title="18.3 �жϺϲ��Ż�"></a>18.3 �жϺϲ��Ż�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �жϺϲ�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">INTERRUPT_COALESCE_CONFIG</span> &#123;</span></span><br><span class="line">    ULONG TimeThreshold;      <span class="comment">// ΢��</span></span><br><span class="line">    ULONG CountThreshold;     <span class="comment">// �ж�����</span></span><br><span class="line">    ULONG BatchSize;          <span class="comment">// ÿ����������</span></span><br><span class="line">    BOOLEAN AdaptiveEnabled;  <span class="comment">// ����Ӧ�ϲ�</span></span><br><span class="line">&#125; INTERRUPT_COALESCE_CONFIG, *PINTERRUPT_COALESCE_CONFIG;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �жϺϲ�����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciCoalesceInterrupt</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PINTERRUPT_MANAGER IntManager,</span></span><br><span class="line"><span class="params">    _In_ PINTERRUPT_CONTEXT IntContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PCOALESCE_ENTRY coalesceEntry;</span><br><span class="line">    BOOLEAN startTimer = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����Ƿ���Ժϲ�</span></span><br><span class="line">    <span class="keyword">if</span> (!IntManager-&gt;Coalescing.CoalescingEnabled ||</span><br><span class="line">        IntContext-&gt;Type == InterruptTypeError) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_NOT_SUPPORTED;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����ϲ���Ŀ</span></span><br><span class="line">    coalesceEntry = ExAllocateFromNPagedLookasideList(</span><br><span class="line">        &amp;IntManager-&gt;Coalescing.EntryPool);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!coalesceEntry) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlCopyMemory(&amp;coalesceEntry-&gt;Context,</span><br><span class="line">                  IntContext,</span><br><span class="line">                  <span class="keyword">sizeof</span>(INTERRUPT_CONTEXT));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���ӵ��������б�</span></span><br><span class="line">    KeAcquireSpinLock(&amp;IntManager-&gt;Coalescing.CoalesceLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    InsertTailList(</span><br><span class="line">        &amp;IntManager-&gt;Coalescing.PendingList,</span><br><span class="line">        &amp;coalesceEntry-&gt;ListEntry);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 4. ����Ƿ���Ҫ������ʱ��</span></span><br><span class="line">    <span class="keyword">if</span> (IsListEmpty(&amp;IntManager-&gt;Coalescing.PendingList)) &#123;</span><br><span class="line">        LARGE_INTEGER dueTime;</span><br><span class="line">        </span><br><span class="line">        dueTime.QuadPart = Int32x32To64(</span><br><span class="line">            <span class="number">-10</span>,  <span class="comment">// 100ns units</span></span><br><span class="line">            IntManager-&gt;Coalescing.CoalescingTimeout);</span><br><span class="line">            </span><br><span class="line">        KeSetTimer(</span><br><span class="line">            &amp;IntManager-&gt;Coalescing.CoalesceTimer,</span><br><span class="line">            dueTime,</span><br><span class="line">            &amp;IntManager-&gt;Coalescing.CoalesceDpc);</span><br><span class="line">            </span><br><span class="line">        startTimer = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����Ƿ�ﵽ�ϲ���ֵ</span></span><br><span class="line">    <span class="keyword">if</span> (GetListLength(&amp;IntManager-&gt;Coalescing.PendingList) &gt;= </span><br><span class="line">        IntManager-&gt;Coalescing.CoalescingThreshold) &#123;</span><br><span class="line">        <span class="comment">// ���������ϲ����ж�</span></span><br><span class="line">        RtsPciProcessCoalescedInterrupts(IntManager);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;IntManager-&gt;Coalescing.CoalesceLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ����ͳ����Ϣ</span></span><br><span class="line">    <span class="keyword">if</span> (!startTimer) &#123;</span><br><span class="line">        InterlockedIncrement(&amp;IntManager-&gt;Statistics.CoalescedCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �����ϲ����ж�</span></span><br><span class="line">VOID <span class="title function_">RtsPciProcessCoalescedInterrupts</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PINTERRUPT_MANAGER IntManager</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PLIST_ENTRY entry;</span><br><span class="line">    PCOALESCE_ENTRY coalesceEntry;</span><br><span class="line">    ULONG processedCount = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �������д��������ж�</span></span><br><span class="line">    <span class="keyword">while</span> (!IsListEmpty(&amp;IntManager-&gt;Coalescing.PendingList) &amp;&amp;</span><br><span class="line">           processedCount &lt; IntManager-&gt;Coalescing.Config.BatchSize) &#123;</span><br><span class="line">        entry = RemoveHeadList(&amp;IntManager-&gt;Coalescing.PendingList);</span><br><span class="line">        coalesceEntry = CONTAINING_RECORD(entry, COALESCE_ENTRY, ListEntry);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. �����ж����ͷַ�����</span></span><br><span class="line">        <span class="keyword">switch</span> (coalesceEntry-&gt;Context.Type) &#123;</span><br><span class="line">            <span class="keyword">case</span> InterruptTypeDma:</span><br><span class="line">                RtsPciHandleDmaInterrupt(</span><br><span class="line">                    IntManager,</span><br><span class="line">                    &amp;coalesceEntry-&gt;Context);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> InterruptTypeCardDetect:</span><br><span class="line">                RtsPciHandleCardDetectInterrupt(</span><br><span class="line">                    IntManager,</span><br><span class="line">                    &amp;coalesceEntry-&gt;Context);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> InterruptTypeWake:</span><br><span class="line">                RtsPciHandleWakeInterrupt(</span><br><span class="line">                    IntManager,</span><br><span class="line">                    &amp;coalesceEntry-&gt;Context);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ExFreeToNPagedLookasideList(</span><br><span class="line">            &amp;IntManager-&gt;Coalescing.EntryPool,</span><br><span class="line">            coalesceEntry);</span><br><span class="line">            </span><br><span class="line">        processedCount++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �������δ�������жϣ�����������ʱ��</span></span><br><span class="line">    <span class="keyword">if</span> (!IsListEmpty(&amp;IntManager-&gt;Coalescing.PendingList)) &#123;</span><br><span class="line">        LARGE_INTEGER dueTime;</span><br><span class="line">        </span><br><span class="line">        dueTime.QuadPart = Int32x32To64(</span><br><span class="line">            <span class="number">-10</span>,</span><br><span class="line">            IntManager-&gt;Coalescing.CoalescingTimeout);</span><br><span class="line">            </span><br><span class="line">        KeSetTimer(</span><br><span class="line">            &amp;IntManager-&gt;Coalescing.CoalesceTimer,</span><br><span class="line">            dueTime,</span><br><span class="line">            &amp;IntManager-&gt;Coalescing.CoalesceDpc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<p>[���� - ��һ���ֽ���ϸ���ܸ߼����Թ���]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-52"><a href="#User-52" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-52"><a href="#AI-claude-3-5-sonnet-52" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼����Թ��ܲ��֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-18"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-18" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 18"></a>WDF SD Host Controller����ʵ����� - Part 18</h1><h2 id="19-�߼����Թ���"><a href="#19-�߼����Թ���" class="headerlink" title="19. �߼����Թ���"></a>19. �߼����Թ���</h2><h3 id="19-1-��������ʵ��"><a href="#19-1-��������ʵ��" class="headerlink" title="19.1 ��������ʵ��"></a>19.1 ��������ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ���Լ�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">DEBUG_LEVEL</span> &#123;</span></span><br><span class="line">    DebugLevelError = <span class="number">0</span>,</span><br><span class="line">    DebugLevelWarning,</span><br><span class="line">    DebugLevelInfo,</span><br><span class="line">    DebugLevelVerbose,</span><br><span class="line">    DebugLevelMax</span><br><span class="line">&#125; DEBUG_LEVEL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �����������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">DEBUG_COMPONENT</span> &#123;</span></span><br><span class="line">    DebugCompDriver = <span class="number">0</span>,</span><br><span class="line">    DebugCompPower,</span><br><span class="line">    DebugCompInterrupt,</span><br><span class="line">    DebugCompDma,</span><br><span class="line">    DebugCompIo,</span><br><span class="line">    DebugCompMax</span><br><span class="line">&#125; DEBUG_COMPONENT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEBUG_ENGINE</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN Enabled;</span><br><span class="line">        DEBUG_LEVEL Level;</span><br><span class="line">        ULONG ComponentMask;</span><br><span class="line">        BOOLEAN BreakOnError;</span><br><span class="line">        BOOLEAN LogToFile;</span><br><span class="line">        WCHAR LogFilePath[MAX_PATH];</span><br><span class="line">    &#125; Config;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���Ի�����</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        PUCHAR Buffer;</span><br><span class="line">        SIZE_T BufferSize;</span><br><span class="line">        SIZE_T WriteOffset;</span><br><span class="line">        KSPIN_LOCK BufferLock;</span><br><span class="line">        KEVENT BufferEvent;</span><br><span class="line">    &#125; TraceBuffer;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���Իص�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY CallbackList;</span><br><span class="line">        KSPIN_LOCK CallbackLock;</span><br><span class="line">    &#125; Callbacks;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ͳ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG ErrorCount;</span><br><span class="line">        ULONG WarningCount;</span><br><span class="line">        ULONG BreakpointHits;</span><br><span class="line">        LARGE_INTEGER StartTime;</span><br><span class="line">    &#125; Statistics;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����ļ�</span></span><br><span class="line">    HANDLE LogFileHandle;</span><br><span class="line">    KSPIN_LOCK FileLock;</span><br><span class="line">&#125; DEBUG_ENGINE, *PDEBUG_ENGINE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ����������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeDebugEngine</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PDEBUG_ENGINE debugEngine;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����������</span></span><br><span class="line">    debugEngine = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(DEBUG_ENGINE),</span><br><span class="line">        <span class="string">&#x27;DBPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!debugEngine) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(debugEngine, <span class="keyword">sizeof</span>(DEBUG_ENGINE));</span><br><span class="line">    debugEngine-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ�������б�</span></span><br><span class="line">    KeInitializeSpinLock(&amp;debugEngine-&gt;TraceBuffer.BufferLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;debugEngine-&gt;Callbacks.CallbackLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;debugEngine-&gt;FileLock);</span><br><span class="line">    InitializeListHead(&amp;debugEngine-&gt;Callbacks.CallbackList);</span><br><span class="line">    KeInitializeEvent(&amp;debugEngine-&gt;TraceBuffer.BufferEvent, </span><br><span class="line">                     NotificationEvent, </span><br><span class="line">                     FALSE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ������Ի�����</span></span><br><span class="line">    debugEngine-&gt;TraceBuffer.BufferSize = PAGE_SIZE * <span class="number">4</span>;  <span class="comment">// 16KB</span></span><br><span class="line">    debugEngine-&gt;TraceBuffer.Buffer = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        debugEngine-&gt;TraceBuffer.BufferSize,</span><br><span class="line">        <span class="string">&#x27;DBUF&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!debugEngine-&gt;TraceBuffer.Buffer) &#123;</span><br><span class="line">        status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����Ĭ������</span></span><br><span class="line">    debugEngine-&gt;Config.Enabled = TRUE;</span><br><span class="line">    debugEngine-&gt;Config.Level = DebugLevelWarning;</span><br><span class="line">    debugEngine-&gt;Config.ComponentMask = (<span class="number">1</span> &lt;&lt; DebugCompDriver) | </span><br><span class="line">                                      (<span class="number">1</span> &lt;&lt; DebugCompError);</span><br><span class="line">    debugEngine-&gt;Config.BreakOnError = FALSE;</span><br><span class="line">    </span><br><span class="line">    KeQuerySystemTime(&amp;debugEngine-&gt;Statistics.StartTime);</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;DebugEngine = debugEngine;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">cleanup:</span><br><span class="line">    RtsPciCleanupDebugEngine(debugEngine);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h3 id="19-2-���Ը��ٺ���־"><a href="#19-2-���Ը��ٺ���־" class="headerlink" title="19.2 ���Ը��ٺ���־"></a>19.2 ���Ը��ٺ���־</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ������Ϣ�ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEBUG_MESSAGE</span> &#123;</span></span><br><span class="line">    DEBUG_LEVEL Level;</span><br><span class="line">    DEBUG_COMPONENT Component;</span><br><span class="line">    LARGE_INTEGER Timestamp;</span><br><span class="line">    ULONG ProcessId;</span><br><span class="line">    ULONG ThreadId;</span><br><span class="line">    CHAR FunctionName[<span class="number">64</span>];</span><br><span class="line">    ULONG LineNumber;</span><br><span class="line">    CHAR Message[<span class="number">256</span>];</span><br><span class="line">    NTSTATUS Status;</span><br><span class="line">&#125; DEBUG_MESSAGE, *PDEBUG_MESSAGE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��¼������Ϣ</span></span><br><span class="line">VOID <span class="title function_">RtsPciLogDebugMessage</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEBUG_ENGINE DebugEngine,</span></span><br><span class="line"><span class="params">    _In_ DEBUG_LEVEL Level,</span></span><br><span class="line"><span class="params">    _In_ DEBUG_COMPONENT Component,</span></span><br><span class="line"><span class="params">    _In_ PCHAR Function,</span></span><br><span class="line"><span class="params">    _In_ ULONG Line,</span></span><br><span class="line"><span class="params">    _In_ PCHAR Format,</span></span><br><span class="line"><span class="params">    ...</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    DEBUG_MESSAGE message;</span><br><span class="line">    va_list args;</span><br><span class="line">    SIZE_T messageSize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����Լ�����������</span></span><br><span class="line">    <span class="keyword">if</span> (!DebugEngine-&gt;Config.Enabled ||</span><br><span class="line">        Level &gt; DebugEngine-&gt;Config.Level ||</span><br><span class="line">        !(DebugEngine-&gt;Config.ComponentMask &amp; (<span class="number">1</span> &lt;&lt; Component))) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����Ϣ�ṹ</span></span><br><span class="line">    RtlZeroMemory(&amp;message, <span class="keyword">sizeof</span>(DEBUG_MESSAGE));</span><br><span class="line">    message.Level = Level;</span><br><span class="line">    message.Component = Component;</span><br><span class="line">    KeQuerySystemTime(&amp;message.Timestamp);</span><br><span class="line">    message.ProcessId = (ULONG)PsGetCurrentProcessId();</span><br><span class="line">    message.ThreadId = (ULONG)PsGetCurrentThreadId();</span><br><span class="line">    message.LineNumber = Line;</span><br><span class="line">    </span><br><span class="line">    RtlStringCchCopyA(message.FunctionName, </span><br><span class="line">                      <span class="keyword">sizeof</span>(message.FunctionName),</span><br><span class="line">                      Function);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʽ����Ϣ</span></span><br><span class="line">    va_start(args, Format);</span><br><span class="line">    RtlStringCchVPrintfA(message.Message,</span><br><span class="line">                        <span class="keyword">sizeof</span>(message.Message),</span><br><span class="line">                        Format,</span><br><span class="line">                        args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. д����Ի�����</span></span><br><span class="line">    messageSize = <span class="keyword">sizeof</span>(DEBUG_MESSAGE);</span><br><span class="line">    </span><br><span class="line">    KeAcquireSpinLock(&amp;DebugEngine-&gt;TraceBuffer.BufferLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((DebugEngine-&gt;TraceBuffer.WriteOffset + messageSize) &lt;= </span><br><span class="line">        DebugEngine-&gt;TraceBuffer.BufferSize) &#123;</span><br><span class="line">        RtlCopyMemory(</span><br><span class="line">            DebugEngine-&gt;TraceBuffer.Buffer + </span><br><span class="line">                DebugEngine-&gt;TraceBuffer.WriteOffset,</span><br><span class="line">            &amp;message,</span><br><span class="line">            messageSize);</span><br><span class="line">            </span><br><span class="line">        DebugEngine-&gt;TraceBuffer.WriteOffset += messageSize;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;DebugEngine-&gt;TraceBuffer.BufferLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. д����־�ļ�</span></span><br><span class="line">    <span class="keyword">if</span> (DebugEngine-&gt;Config.LogToFile) &#123;</span><br><span class="line">        RtsPciWriteDebugLogFile(DebugEngine, &amp;message);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ���õ��Իص�</span></span><br><span class="line">    RtsPciNotifyDebugCallbacks(DebugEngine, &amp;message);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7. ����Ƿ���Ҫ�ϵ�</span></span><br><span class="line">    <span class="keyword">if</span> (Level == DebugLevelError &amp;&amp; DebugEngine-&gt;Config.BreakOnError) &#123;</span><br><span class="line">        DbgBreakPoint();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// д�������־�ļ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciWriteDebugLogFile</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEBUG_ENGINE DebugEngine,</span></span><br><span class="line"><span class="params">    _In_ PDEBUG_MESSAGE Message</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    IO_STATUS_BLOCK ioStatus;</span><br><span class="line">    LARGE_INTEGER offset;</span><br><span class="line">    CHAR logBuffer[<span class="number">512</span>];</span><br><span class="line">    SIZE_T logLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ʽ����־��Ŀ</span></span><br><span class="line">    logLength = RtsPciFormatDebugLogEntry(</span><br><span class="line">        Message,</span><br><span class="line">        logBuffer,</span><br><span class="line">        <span class="keyword">sizeof</span>(logBuffer));</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (logLength == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_BUFFER_TOO_SMALL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. д���ļ�</span></span><br><span class="line">    KeAcquireSpinLock(&amp;DebugEngine-&gt;FileLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    offset.QuadPart = FILE_WRITE_TO_END_OF_FILE;</span><br><span class="line">    </span><br><span class="line">    status = ZwWriteFile(</span><br><span class="line">        DebugEngine-&gt;LogFileHandle,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;ioStatus,</span><br><span class="line">        logBuffer,</span><br><span class="line">        (ULONG)logLength,</span><br><span class="line">        &amp;offset,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">    KeReleaseSpinLock(&amp;DebugEngine-&gt;FileLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h3 id="19-3-���������"><a href="#19-3-���������" class="headerlink" title="19.3 ���������"></a>19.3 ���������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ���������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">DEBUG_COMMAND</span> &#123;</span></span><br><span class="line">    DebugCmdSetLevel = <span class="number">0</span>,</span><br><span class="line">    DebugCmdSetMask,</span><br><span class="line">    DebugCmdDumpRegisters,</span><br><span class="line">    DebugCmdDumpBuffers,</span><br><span class="line">    DebugCmdTraceOn,</span><br><span class="line">    DebugCmdTraceOff,</span><br><span class="line">    DebugCmdBreakpoint,</span><br><span class="line">    DebugCmdMax</span><br><span class="line">&#125; DEBUG_COMMAND;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �����������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEBUG_COMMAND_HANDLER</span> &#123;</span></span><br><span class="line">    DEBUG_COMMAND Command;</span><br><span class="line">    PFN_DEBUG_COMMAND_HANDLER Handler;</span><br><span class="line">    PCHAR Description;</span><br><span class="line">&#125; DEBUG_COMMAND_HANDLER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ������������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciProcessDebugCommand</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEBUG_ENGINE DebugEngine,</span></span><br><span class="line"><span class="params">    _In_ DEBUG_COMMAND Command,</span></span><br><span class="line"><span class="params">    _In_opt_ PVOID InputBuffer,</span></span><br><span class="line"><span class="params">    _In_ SIZE_T InputBufferSize,</span></span><br><span class="line"><span class="params">    _Out_opt_ PVOID OutputBuffer,</span></span><br><span class="line"><span class="params">    _In_ SIZE_T OutputBufferSize</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (Command) &#123;</span><br><span class="line">        <span class="keyword">case</span> DebugCmdSetLevel:</span><br><span class="line">            <span class="keyword">if</span> (InputBufferSize &lt; <span class="keyword">sizeof</span>(DEBUG_LEVEL)) &#123;</span><br><span class="line">                <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line">            &#125;</span><br><span class="line">            DebugEngine-&gt;Config.Level = *(PDEBUG_LEVEL)InputBuffer;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DebugCmdSetMask:</span><br><span class="line">            <span class="keyword">if</span> (InputBufferSize &lt; <span class="keyword">sizeof</span>(ULONG)) &#123;</span><br><span class="line">                <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line">            &#125;</span><br><span class="line">            DebugEngine-&gt;Config.ComponentMask = *(PULONG)InputBuffer;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DebugCmdDumpRegisters:</span><br><span class="line">            status = RtsPciDumpRegisters(</span><br><span class="line">                DebugEngine,</span><br><span class="line">                OutputBuffer,</span><br><span class="line">                OutputBufferSize);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DebugCmdDumpBuffers:</span><br><span class="line">            status = RtsPciDumpBuffers(</span><br><span class="line">                DebugEngine,</span><br><span class="line">                OutputBuffer,</span><br><span class="line">                OutputBufferSize);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DebugCmdTraceOn:</span><br><span class="line">            DebugEngine-&gt;Config.Enabled = TRUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DebugCmdTraceOff:</span><br><span class="line">            DebugEngine-&gt;Config.Enabled = FALSE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DebugCmdBreakpoint:</span><br><span class="line">            DbgBreakPoint();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            status = STATUS_INVALID_PARAMETER;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �Ĵ���ת��ʵ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciDumpRegisters</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEBUG_ENGINE DebugEngine,</span></span><br><span class="line"><span class="params">    _Out_opt_ PVOID OutputBuffer,</span></span><br><span class="line"><span class="params">    _In_ SIZE_T OutputBufferSize</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = DebugEngine-&gt;DevContext;</span><br><span class="line">    PUCHAR regBase = devContext-&gt;RegisterBase;</span><br><span class="line">    PDEBUG_REGISTER_DUMP regDump;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!OutputBuffer || OutputBufferSize &lt; <span class="keyword">sizeof</span>(DEBUG_REGISTER_DUMP)) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_BUFFER_TOO_SMALL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    regDump = (PDEBUG_REGISTER_DUMP)OutputBuffer;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡ�ؼ��Ĵ���</span></span><br><span class="line">    regDump-&gt;HostControl = READ_REGISTER_ULONG(regBase + HOST_CONTROL_REG);</span><br><span class="line">    regDump-&gt;PowerControl = READ_REGISTER_ULONG(regBase + POWER_CONTROL_REG);</span><br><span class="line">    regDump-&gt;ClockControl = READ_REGISTER_ULONG(regBase + CLOCK_CONTROL_REG);</span><br><span class="line">    regDump-&gt;IntStatus = READ_REGISTER_ULONG(regBase + INT_STATUS_REG);</span><br><span class="line">    regDump-&gt;IntEnable = READ_REGISTER_ULONG(regBase + INT_ENABLE_REG);</span><br><span class="line">    regDump-&gt;ErrorStatus = READ_REGISTER_ULONG(regBase + ERROR_STATUS_REG);</span><br><span class="line">    regDump-&gt;Capabilities = READ_REGISTER_ULONG(regBase + CAPABILITIES_REG);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<p>[���� - ��һ���ֽ���ϸ���ܸ߼�������]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-53"><a href="#User-53" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ���������в���</p>
<h2 id="AI-claude-3-5-sonnet-53"><a href="#AI-claude-3-5-sonnet-53" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼����������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-19"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-19" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 19"></a>WDF SD Host Controller����ʵ����� - Part 19</h1><h2 id="20-�߼�������"><a href="#20-�߼�������" class="headerlink" title="20. �߼�������"></a>20. �߼�������</h2><h3 id="20-1-���������ʵ��"><a href="#20-1-���������ʵ��" class="headerlink" title="20.1 ���������ʵ��"></a>20.1 ���������ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �������Ͷ���</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">ERROR_TYPE</span> &#123;</span></span><br><span class="line">    ErrorTypeHardware = <span class="number">0</span>,</span><br><span class="line">    ErrorTypeDma,</span><br><span class="line">    ErrorTypeProtocol,</span><br><span class="line">    ErrorTypeTimeout,</span><br><span class="line">    ErrorTypeResource,</span><br><span class="line">    ErrorTypeSystem,</span><br><span class="line">    ErrorTypeMax</span><br><span class="line">&#125; ERROR_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���󼶱���</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">ERROR_SEVERITY</span> &#123;</span></span><br><span class="line">    ErrorSeverityFatal = <span class="number">0</span>,</span><br><span class="line">    ErrorSeverityCritical,</span><br><span class="line">    ErrorSeverityRecoverable,</span><br><span class="line">    ErrorSeverityWarning,</span><br><span class="line">    ErrorSeverityInfo</span><br><span class="line">&#125; ERROR_SEVERITY;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �����¼�ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ERROR_RECORD</span> &#123;</span></span><br><span class="line">    ERROR_TYPE Type;</span><br><span class="line">    ERROR_SEVERITY Severity;</span><br><span class="line">    NTSTATUS Status;</span><br><span class="line">    LARGE_INTEGER Timestamp;</span><br><span class="line">    ULONG ProcessId;</span><br><span class="line">    ULONG ThreadId;</span><br><span class="line">    CHAR Location[<span class="number">64</span>];</span><br><span class="line">    CHAR Description[<span class="number">256</span>];</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            ULONG RegisterValue;</span><br><span class="line">            ULONG ExpectedValue;</span><br><span class="line">            ULONG ErrorMask;</span><br><span class="line">        &#125; Hardware;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            ULONG TransferSize;</span><br><span class="line">            ULONG CompletedSize;</span><br><span class="line">            ULONG ErrorFlags;</span><br><span class="line">        &#125; Dma;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            ULONG Command;</span><br><span class="line">            ULONG Response;</span><br><span class="line">            ULONG State;</span><br><span class="line">        &#125; Protocol;</span><br><span class="line">    &#125; Details;</span><br><span class="line">&#125; ERROR_RECORD, *PERROR_RECORD;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ERROR_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN AutoRecover;</span><br><span class="line">        ULONG MaxRetries;</span><br><span class="line">        ULONG RecoveryTimeout;</span><br><span class="line">        ERROR_SEVERITY MinSeverity;</span><br><span class="line">    &#125; Config;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������ʷ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        PERROR_RECORD Records;</span><br><span class="line">        ULONG MaxRecords;</span><br><span class="line">        ULONG CurrentIndex;</span><br><span class="line">        KSPIN_LOCK HistoryLock;</span><br><span class="line">    &#125; History;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ͳ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG ErrorCount[ErrorTypeMax];</span><br><span class="line">        ULONG RecoveryCount;</span><br><span class="line">        ULONG UnrecoverableCount;</span><br><span class="line">        LARGE_INTEGER LastErrorTime;</span><br><span class="line">    &#125; Statistics;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ָ�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY RecoveryQueue;</span><br><span class="line">        KSPIN_LOCK RecoveryLock;</span><br><span class="line">        KEVENT RecoveryEvent;</span><br><span class="line">        BOOLEAN RecoveryInProgress;</span><br><span class="line">    &#125; Recovery;</span><br><span class="line">&#125; ERROR_MANAGER, *PERROR_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ�����������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeErrorManager</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PERROR_MANAGER errorMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ������������</span></span><br><span class="line">    errorMgr = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(ERROR_MANAGER),</span><br><span class="line">        <span class="string">&#x27;EMPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!errorMgr) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(errorMgr, <span class="keyword">sizeof</span>(ERROR_MANAGER));</span><br><span class="line">    errorMgr-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ�������¼�</span></span><br><span class="line">    KeInitializeSpinLock(&amp;errorMgr-&gt;History.HistoryLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;errorMgr-&gt;Recovery.RecoveryLock);</span><br><span class="line">    KeInitializeEvent(&amp;errorMgr-&gt;Recovery.RecoveryEvent,</span><br><span class="line">                     NotificationEvent,</span><br><span class="line">                     FALSE);</span><br><span class="line">    InitializeListHead(&amp;errorMgr-&gt;Recovery.RecoveryQueue);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���������ʷ��¼</span></span><br><span class="line">    errorMgr-&gt;History.MaxRecords = <span class="number">100</span>;</span><br><span class="line">    errorMgr-&gt;History.Records = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(ERROR_RECORD) * errorMgr-&gt;History.MaxRecords,</span><br><span class="line">        <span class="string">&#x27;EREC&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!errorMgr-&gt;History.Records) &#123;</span><br><span class="line">        status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����Ĭ������</span></span><br><span class="line">    errorMgr-&gt;Config.AutoRecover = TRUE;</span><br><span class="line">    errorMgr-&gt;Config.MaxRetries = <span class="number">3</span>;</span><br><span class="line">    errorMgr-&gt;Config.RecoveryTimeout = <span class="number">5000</span>;  <span class="comment">// 5��</span></span><br><span class="line">    errorMgr-&gt;Config.MinSeverity = ErrorSeverityRecoverable;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;ErrorManager = errorMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">cleanup:</span><br><span class="line">    RtsPciCleanupErrorManager(errorMgr);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h3 id="20-2-������ͼ�¼"><a href="#20-2-������ͼ�¼" class="headerlink" title="20.2 ������ͼ�¼"></a>20.2 ������ͼ�¼</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��¼����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciLogError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PERROR_MANAGER ErrorMgr,</span></span><br><span class="line"><span class="params">    _In_ ERROR_TYPE Type,</span></span><br><span class="line"><span class="params">    _In_ ERROR_SEVERITY Severity,</span></span><br><span class="line"><span class="params">    _In_ NTSTATUS Status,</span></span><br><span class="line"><span class="params">    _In_ PCHAR Location,</span></span><br><span class="line"><span class="params">    _In_ PCHAR Description,</span></span><br><span class="line"><span class="params">    _In_opt_ PVOID ErrorDetails,</span></span><br><span class="line"><span class="params">    _In_ SIZE_T DetailsSize</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PERROR_RECORD record;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����󼶱�</span></span><br><span class="line">    <span class="keyword">if</span> (Severity &lt; ErrorMgr-&gt;Config.MinSeverity) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ȡ�µĴ����¼</span></span><br><span class="line">    KeAcquireSpinLock(&amp;ErrorMgr-&gt;History.HistoryLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    record = &amp;ErrorMgr-&gt;History.Records[ErrorMgr-&gt;History.CurrentIndex];</span><br><span class="line">    ErrorMgr-&gt;History.CurrentIndex = </span><br><span class="line">        (ErrorMgr-&gt;History.CurrentIndex + <span class="number">1</span>) % ErrorMgr-&gt;History.MaxRecords;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. �������¼</span></span><br><span class="line">    RtlZeroMemory(record, <span class="keyword">sizeof</span>(ERROR_RECORD));</span><br><span class="line">    record-&gt;Type = Type;</span><br><span class="line">    record-&gt;Severity = Severity;</span><br><span class="line">    record-&gt;Status = Status;</span><br><span class="line">    KeQuerySystemTime(&amp;record-&gt;Timestamp);</span><br><span class="line">    record-&gt;ProcessId = (ULONG)PsGetCurrentProcessId();</span><br><span class="line">    record-&gt;ThreadId = (ULONG)PsGetCurrentThreadId();</span><br><span class="line">    </span><br><span class="line">    RtlStringCchCopyA(record-&gt;Location,</span><br><span class="line">                      <span class="keyword">sizeof</span>(record-&gt;Location),</span><br><span class="line">                      Location);</span><br><span class="line">                      </span><br><span class="line">    RtlStringCchCopyA(record-&gt;Description,</span><br><span class="line">                      <span class="keyword">sizeof</span>(record-&gt;Description),</span><br><span class="line">                      Description);</span><br><span class="line">                      </span><br><span class="line">    <span class="comment">// 4. ���ƴ�������</span></span><br><span class="line">    <span class="keyword">if</span> (ErrorDetails &amp;&amp; DetailsSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (Type) &#123;</span><br><span class="line">            <span class="keyword">case</span> ErrorTypeHardware:</span><br><span class="line">                RtlCopyMemory(&amp;record-&gt;Details.Hardware,</span><br><span class="line">                             ErrorDetails,</span><br><span class="line">                             min(DetailsSize, <span class="keyword">sizeof</span>(record-&gt;Details.Hardware)));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> ErrorTypeDma:</span><br><span class="line">                RtlCopyMemory(&amp;record-&gt;Details.Dma,</span><br><span class="line">                             ErrorDetails,</span><br><span class="line">                             min(DetailsSize, <span class="keyword">sizeof</span>(record-&gt;Details.Dma)));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> ErrorTypeProtocol:</span><br><span class="line">                RtlCopyMemory(&amp;record-&gt;Details.Protocol,</span><br><span class="line">                             ErrorDetails,</span><br><span class="line">                             min(DetailsSize, <span class="keyword">sizeof</span>(record-&gt;Details.Protocol)));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;ErrorMgr-&gt;History.HistoryLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����ͳ����Ϣ</span></span><br><span class="line">    InterlockedIncrement(&amp;ErrorMgr-&gt;Statistics.ErrorCount[Type]);</span><br><span class="line">    ErrorMgr-&gt;Statistics.LastErrorTime = record-&gt;Timestamp;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ��������ָ�</span></span><br><span class="line">    <span class="keyword">if</span> (ErrorMgr-&gt;Config.AutoRecover &amp;&amp; </span><br><span class="line">        Severity &lt;= ErrorSeverityRecoverable) &#123;</span><br><span class="line">        RtsPciQueueErrorRecovery(ErrorMgr, record);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7. ֪ͨ�����¼�</span></span><br><span class="line">    RtsPciNotifyErrorEvent(ErrorMgr, record);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���Ӳ������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciCheckHardwareError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PERROR_MANAGER ErrorMgr</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = ErrorMgr-&gt;DevContext;</span><br><span class="line">    ULONG errorStatus, expectedValue;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ����״̬�Ĵ���</span></span><br><span class="line">    errorStatus = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + ERROR_STATUS_REG);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (errorStatus &amp; ERROR_STATUS_MASK) &#123;</span><br><span class="line">        ERROR_RECORD_HARDWARE hwError;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. ���Ӳ����������</span></span><br><span class="line">        hwError.RegisterValue = errorStatus;</span><br><span class="line">        hwError.ExpectedValue = expectedValue;</span><br><span class="line">        hwError.ErrorMask = ERROR_STATUS_MASK;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. ��¼����</span></span><br><span class="line">        RtsPciLogError(</span><br><span class="line">            ErrorMgr,</span><br><span class="line">            ErrorTypeHardware,</span><br><span class="line">            ErrorSeverityRecoverable,</span><br><span class="line">            STATUS_DEVICE_HARDWARE_ERROR,</span><br><span class="line">            <span class="string">&quot;HardwareCheck&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Hardware error detected in status register&quot;</span>,</span><br><span class="line">            &amp;hwError,</span><br><span class="line">            <span class="keyword">sizeof</span>(hwError));</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> STATUS_DEVICE_HARDWARE_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h3 id="20-3-����ָ�ʵ��"><a href="#20-3-����ָ�ʵ��" class="headerlink" title="20.3 ����ָ�ʵ��"></a>20.3 ����ָ�ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ����ָ�������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ERROR_RECOVERY_CONTEXT</span> &#123;</span></span><br><span class="line">    LIST_ENTRY ListEntry;</span><br><span class="line">    ERROR_RECORD Record;</span><br><span class="line">    ULONG RetryCount;</span><br><span class="line">    LARGE_INTEGER StartTime;</span><br><span class="line">    NTSTATUS LastStatus;</span><br><span class="line">    BOOLEAN InProgress;</span><br><span class="line">&#125; ERROR_RECOVERY_CONTEXT, *PERROR_RECOVERY_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���д���ָ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciQueueErrorRecovery</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PERROR_MANAGER ErrorMgr,</span></span><br><span class="line"><span class="params">    _In_ PERROR_RECORD Record</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PERROR_RECOVERY_CONTEXT recoveryCtx;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����ָ�������</span></span><br><span class="line">    recoveryCtx = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(ERROR_RECOVERY_CONTEXT),</span><br><span class="line">        <span class="string">&#x27;EREC&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!recoveryCtx) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(recoveryCtx, <span class="keyword">sizeof</span>(ERROR_RECOVERY_CONTEXT));</span><br><span class="line">    RtlCopyMemory(&amp;recoveryCtx-&gt;Record,</span><br><span class="line">                  Record,</span><br><span class="line">                  <span class="keyword">sizeof</span>(ERROR_RECORD));</span><br><span class="line">                  </span><br><span class="line">    KeQuerySystemTime(&amp;recoveryCtx-&gt;StartTime);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���ӵ��ָ�����</span></span><br><span class="line">    KeAcquireSpinLock(&amp;ErrorMgr-&gt;Recovery.RecoveryLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    InsertTailList(</span><br><span class="line">        &amp;ErrorMgr-&gt;Recovery.RecoveryQueue,</span><br><span class="line">        &amp;recoveryCtx-&gt;ListEntry);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!ErrorMgr-&gt;Recovery.RecoveryInProgress) &#123;</span><br><span class="line">        ErrorMgr-&gt;Recovery.RecoveryInProgress = TRUE;</span><br><span class="line">        KeSetEvent(&amp;ErrorMgr-&gt;Recovery.RecoveryEvent, <span class="number">0</span>, FALSE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;ErrorMgr-&gt;Recovery.RecoveryLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ִ�д���ָ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciPerformErrorRecovery</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PERROR_MANAGER ErrorMgr,</span></span><br><span class="line"><span class="params">    _In_ PERROR_RECOVERY_CONTEXT RecoveryCtx</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ������Դ���</span></span><br><span class="line">    <span class="keyword">if</span> (RecoveryCtx-&gt;RetryCount &gt;= ErrorMgr-&gt;Config.MaxRetries) &#123;</span><br><span class="line">        InterlockedIncrement(&amp;ErrorMgr-&gt;Statistics.UnrecoverableCount);</span><br><span class="line">        <span class="keyword">return</span> STATUS_RETRY_EXHAUSTED;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���ݴ�������ִ�лָ�</span></span><br><span class="line">    <span class="keyword">switch</span> (RecoveryCtx-&gt;Record.Type) &#123;</span><br><span class="line">        <span class="keyword">case</span> ErrorTypeHardware:</span><br><span class="line">            status = RtsPciRecoverHardwareError(</span><br><span class="line">                ErrorMgr,</span><br><span class="line">                &amp;RecoveryCtx-&gt;Record.Details.Hardware);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ErrorTypeDma:</span><br><span class="line">            status = RtsPciRecoverDmaError(</span><br><span class="line">                ErrorMgr,</span><br><span class="line">                &amp;RecoveryCtx-&gt;Record.Details.Dma);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ErrorTypeProtocol:</span><br><span class="line">            status = RtsPciRecoverProtocolError(</span><br><span class="line">                ErrorMgr,</span><br><span class="line">                &amp;RecoveryCtx-&gt;Record.Details.Protocol);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            status = STATUS_NOT_SUPPORTED;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���»ָ�״̬</span></span><br><span class="line">    RecoveryCtx-&gt;LastStatus = status;</span><br><span class="line">    RecoveryCtx-&gt;RetryCount++;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        InterlockedIncrement(&amp;ErrorMgr-&gt;Statistics.RecoveryCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ӳ������ָ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciRecoverHardwareError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PERROR_MANAGER ErrorMgr,</span></span><br><span class="line"><span class="params">    _In_ PERROR_RECORD_HARDWARE HwError</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = ErrorMgr-&gt;DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����Ӳ��״̬</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + RESET_CONTROL_REG,</span><br><span class="line">        RESET_CONTROL_SOFT_RESET);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. �ȴ��������</span></span><br><span class="line">    <span class="keyword">if</span> (!RtsPciWaitForReset(devContext)) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_DEVICE_HARDWARE_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���³�ʼ��Ӳ��</span></span><br><span class="line">    <span class="keyword">return</span> RtsPciInitializeHardware(devContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<p>[���� - ��һ���ֽ���ϸ���ܸ߼������Ż�]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-54"><a href="#User-54" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-54"><a href="#AI-claude-3-5-sonnet-54" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼������Ż����֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-20"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-20" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 20"></a>WDF SD Host Controller����ʵ����� - Part 20</h1><h2 id="21-�߼������Z�"><a href="#21-�߼������Z�" class="headerlink" title="21. �߼������Ż�"></a>21. �߼������Ż�</h2><h3 id="21-1-�����Z�������ʵ��"><a href="#21-1-�����Z�������ʵ��" class="headerlink" title="21.1 �����Ż�������ʵ��"></a>21.1 �����Ż�������ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �����Ż�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">OPTIMIZATION_TYPE</span> &#123;</span></span><br><span class="line">    OptimizationTypeIO = <span class="number">0</span>,</span><br><span class="line">    OptimizationTypeMemory,</span><br><span class="line">    OptimizationTypeCPU,</span><br><span class="line">    OptimizationTypePower,</span><br><span class="line">    OptimizationTypeMax</span><br><span class="line">&#125; OPTIMIZATION_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �����Ż�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">OPTIMIZATION_CONFIG</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableReadAhead;</span><br><span class="line">        BOOLEAN EnableWriteCoalescing;</span><br><span class="line">        ULONG ReadAheadSize;</span><br><span class="line">        ULONG WriteCoalesceSize;</span><br><span class="line">        ULONG MaxQueueDepth;</span><br><span class="line">    &#125; IO;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableDmaCoalescing;</span><br><span class="line">        BOOLEAN EnableBufferReuse;</span><br><span class="line">        ULONG PreallocatedBuffers;</span><br><span class="line">        ULONG MaxDmaTransferSize;</span><br><span class="line">    &#125; Memory;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableInterruptCoalescing;</span><br><span class="line">        BOOLEAN EnableDpcBatching;</span><br><span class="line">        ULONG InterruptThreshold;</span><br><span class="line">        ULONG DpcBatchSize;</span><br><span class="line">    &#125; CPU;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableDynamicClocking;</span><br><span class="line">        BOOLEAN EnablePowerGating;</span><br><span class="line">        ULONG MinClockFrequency;</span><br><span class="line">        ULONG MaxClockFrequency;</span><br><span class="line">    &#125; Power;</span><br><span class="line">&#125; OPTIMIZATION_CONFIG, *POPTIMIZATION_CONFIG;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �����Ż�������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">OPTIMIZATION_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    OPTIMIZATION_CONFIG Config;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// IO�Ż�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        NPAGED_LOOKASIDE_LIST BufferPool;</span><br><span class="line">        LIST_ENTRY PendingWriteList;</span><br><span class="line">        KSPIN_LOCK WriteLock;</span><br><span class="line">        KDPC WriteCoalesceDpc;</span><br><span class="line">        KTIMER WriteCoalesceTimer;</span><br><span class="line">    &#125; IOOptimization;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ڴ��Ż�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY FreeBufferList;</span><br><span class="line">        KSPIN_LOCK BufferLock;</span><br><span class="line">        ULONG BufferCount;</span><br><span class="line">        SIZE_T TotalBufferSize;</span><br><span class="line">    &#125; MemoryOptimization;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// CPU�Ż�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG InterruptCount;</span><br><span class="line">        LARGE_INTEGER LastInterruptTime;</span><br><span class="line">        LIST_ENTRY DpcQueue;</span><br><span class="line">        KSPIN_LOCK DpcLock;</span><br><span class="line">    &#125; CPUOptimization;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ�Ż�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG CurrentFrequency;</span><br><span class="line">        ULONG CurrentPowerState;</span><br><span class="line">        KSPIN_LOCK PowerLock;</span><br><span class="line">        KTIMER PowerAdjustTimer;</span><br><span class="line">    &#125; PowerOptimization;</span><br><span class="line">&#125; OPTIMIZATION_MANAGER, *POPTIMIZATION_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ�������Ż�������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeOptimizationManager</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    POPTIMIZATION_MANAGER optMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����Ż�������</span></span><br><span class="line">    optMgr = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(OPTIMIZATION_MANAGER),</span><br><span class="line">        <span class="string">&#x27;OMPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!optMgr) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(optMgr, <span class="keyword">sizeof</span>(OPTIMIZATION_MANAGER));</span><br><span class="line">    optMgr-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ��IO�Ż�</span></span><br><span class="line">    ExInitializeNPagedLookasideList(</span><br><span class="line">        &amp;optMgr-&gt;IOOptimization.BufferPool,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        PAGE_SIZE,</span><br><span class="line">        <span class="string">&#x27;IOPL&#x27;</span>,</span><br><span class="line">        <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">    InitializeListHead(&amp;optMgr-&gt;IOOptimization.PendingWriteList);</span><br><span class="line">    KeInitializeSpinLock(&amp;optMgr-&gt;IOOptimization.WriteLock);</span><br><span class="line">    KeInitializeTimer(&amp;optMgr-&gt;IOOptimization.WriteCoalesceTimer);</span><br><span class="line">    KeInitializeDpc(</span><br><span class="line">        &amp;optMgr-&gt;IOOptimization.WriteCoalesceDpc,</span><br><span class="line">        RtsPciWriteCoalesceDpc,</span><br><span class="line">        optMgr);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. ��ʼ���ڴ��Ż�</span></span><br><span class="line">    InitializeListHead(&amp;optMgr-&gt;MemoryOptimization.FreeBufferList);</span><br><span class="line">    KeInitializeSpinLock(&amp;optMgr-&gt;MemoryOptimization.BufferLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ��ʼ��CPU�Ż�</span></span><br><span class="line">    InitializeListHead(&amp;optMgr-&gt;CPUOptimization.DpcQueue);</span><br><span class="line">    KeInitializeSpinLock(&amp;optMgr-&gt;CPUOptimization.DpcLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ��ʼ����Դ�Ż�</span></span><br><span class="line">    KeInitializeSpinLock(&amp;optMgr-&gt;PowerOptimization.PowerLock);</span><br><span class="line">    KeInitializeTimer(&amp;optMgr-&gt;PowerOptimization.PowerAdjustTimer);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ����Ĭ������</span></span><br><span class="line">    optMgr-&gt;Config.IO.EnableReadAhead = TRUE;</span><br><span class="line">    optMgr-&gt;Config.IO.EnableWriteCoalescing = TRUE;</span><br><span class="line">    optMgr-&gt;Config.IO.ReadAheadSize = PAGE_SIZE * <span class="number">4</span>;</span><br><span class="line">    optMgr-&gt;Config.IO.WriteCoalesceSize = PAGE_SIZE * <span class="number">4</span>;</span><br><span class="line">    optMgr-&gt;Config.IO.MaxQueueDepth = <span class="number">32</span>;</span><br><span class="line">    </span><br><span class="line">    optMgr-&gt;Config.Memory.EnableDmaCoalescing = TRUE;</span><br><span class="line">    optMgr-&gt;Config.Memory.EnableBufferReuse = TRUE;</span><br><span class="line">    optMgr-&gt;Config.Memory.PreallocatedBuffers = <span class="number">16</span>;</span><br><span class="line">    </span><br><span class="line">    optMgr-&gt;Config.CPU.EnableInterruptCoalescing = TRUE;</span><br><span class="line">    optMgr-&gt;Config.CPU.EnableDpcBatching = TRUE;</span><br><span class="line">    optMgr-&gt;Config.CPU.InterruptThreshold = <span class="number">8</span>;</span><br><span class="line">    optMgr-&gt;Config.CPU.DpcBatchSize = <span class="number">4</span>;</span><br><span class="line">    </span><br><span class="line">    optMgr-&gt;Config.Power.EnableDynamicClocking = TRUE;</span><br><span class="line">    optMgr-&gt;Config.Power.EnablePowerGating = TRUE;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;OptimizationManager = optMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h3 id="21-2-IO�����Z�"><a href="#21-2-IO�����Z�" class="headerlink" title="21.2 IO�����Ż�"></a>21.2 IO�����Ż�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IO�����Ż�������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_OPTIMIZATION_CONTEXT</span> &#123;</span></span><br><span class="line">    LIST_ENTRY ListEntry;</span><br><span class="line">    WDFREQUEST Request;</span><br><span class="line">    PVOID Buffer;</span><br><span class="line">    SIZE_T BufferLength;</span><br><span class="line">    BOOLEAN IsRead;</span><br><span class="line">    LARGE_INTEGER Timestamp;</span><br><span class="line">&#125; IO_OPTIMIZATION_CONTEXT, *PIO_OPTIMIZATION_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �Ż�IO����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciOptimizeIoRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ POPTIMIZATION_MANAGER OptMgr,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ BOOLEAN IsRead</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PIO_OPTIMIZATION_CONTEXT ioCtx;</span><br><span class="line">    PVOID buffer;</span><br><span class="line">    SIZE_T length;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ������Ϣ</span></span><br><span class="line">    <span class="keyword">if</span> (IsRead) &#123;</span><br><span class="line">        status = WdfRequestRetrieveOutputBuffer(</span><br><span class="line">            Request,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            &amp;buffer,</span><br><span class="line">            &amp;length);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        status = WdfRequestRetrieveInputBuffer(</span><br><span class="line">            Request,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            &amp;buffer,</span><br><span class="line">            &amp;length);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����Ż�������</span></span><br><span class="line">    ioCtx = ExAllocateFromNPagedLookasideList(</span><br><span class="line">        &amp;OptMgr-&gt;IOOptimization.BufferPool);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!ioCtx) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ioCtx-&gt;Request = Request;</span><br><span class="line">    ioCtx-&gt;Buffer = buffer;</span><br><span class="line">    ioCtx-&gt;BufferLength = length;</span><br><span class="line">    ioCtx-&gt;IsRead = IsRead;</span><br><span class="line">    KeQuerySystemTime(&amp;ioCtx-&gt;Timestamp);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. Ӧ��IO�Ż�</span></span><br><span class="line">    <span class="keyword">if</span> (IsRead &amp;&amp; OptMgr-&gt;Config.IO.EnableReadAhead) &#123;</span><br><span class="line">        status = RtsPciApplyReadAhead(OptMgr, ioCtx);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!IsRead &amp;&amp; OptMgr-&gt;Config.IO.EnableWriteCoalescing) &#123;</span><br><span class="line">        status = RtsPciApplyWriteCoalescing(OptMgr, ioCtx);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        status = RtsPciProcessIoRequestDirect(OptMgr, ioCtx);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        ExFreeToNPagedLookasideList(</span><br><span class="line">            &amp;OptMgr-&gt;IOOptimization.BufferPool,</span><br><span class="line">            ioCtx);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// д����ϲ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciApplyWriteCoalescing</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ POPTIMIZATION_MANAGER OptMgr,</span></span><br><span class="line"><span class="params">    _In_ PIO_OPTIMIZATION_CONTEXT IoCtx</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    BOOLEAN startTimer = FALSE;</span><br><span class="line">    </span><br><span class="line">    KeAcquireSpinLock(&amp;OptMgr-&gt;IOOptimization.WriteLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���ӵ��������б�</span></span><br><span class="line">    InsertTailList(</span><br><span class="line">        &amp;OptMgr-&gt;IOOptimization.PendingWriteList,</span><br><span class="line">        &amp;IoCtx-&gt;ListEntry);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. ����Ƿ���Ҫ�����ϲ���ʱ��</span></span><br><span class="line">    <span class="keyword">if</span> (IsListEmpty(&amp;OptMgr-&gt;IOOptimization.PendingWriteList)) &#123;</span><br><span class="line">        LARGE_INTEGER dueTime;</span><br><span class="line">        </span><br><span class="line">        dueTime.QuadPart = Int32x32To64(</span><br><span class="line">            <span class="number">-10000</span>,  <span class="comment">// 1ms</span></span><br><span class="line">            <span class="number">1</span>);</span><br><span class="line">            </span><br><span class="line">        KeSetTimer(</span><br><span class="line">            &amp;OptMgr-&gt;IOOptimization.WriteCoalesceTimer,</span><br><span class="line">            dueTime,</span><br><span class="line">            &amp;OptMgr-&gt;IOOptimization.WriteCoalesceDpc);</span><br><span class="line">            </span><br><span class="line">        startTimer = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����Ƿ�ﵽ�ϲ���ֵ</span></span><br><span class="line">    <span class="keyword">if</span> (GetListLength(&amp;OptMgr-&gt;IOOptimization.PendingWriteList) &gt;= </span><br><span class="line">        OptMgr-&gt;Config.IO.WriteCoalesceSize) &#123;</span><br><span class="line">        <span class="comment">// ���������ϲ���д����</span></span><br><span class="line">        RtsPciProcessCoalescedWrites(OptMgr);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;OptMgr-&gt;IOOptimization.WriteLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_PENDING;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h3 id="21-3-�ڴ��CPU�Z�"><a href="#21-3-�ڴ��CPU�Z�" class="headerlink" title="21.3 �ڴ��CPU�Ż�"></a>21.3 �ڴ��CPU�Ż�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �ڴ滺�����Ż�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciOptimizeMemoryBuffers</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ POPTIMIZATION_MANAGER OptMgr</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    PVOID buffer;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����Ƿ���ҪԤ���仺����</span></span><br><span class="line">    KeAcquireSpinLock(&amp;OptMgr-&gt;MemoryOptimization.BufferLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (OptMgr-&gt;MemoryOptimization.BufferCount &lt; </span><br><span class="line">        OptMgr-&gt;Config.Memory.PreallocatedBuffers) &#123;</span><br><span class="line">        <span class="comment">// 2. �����»�����</span></span><br><span class="line">        buffer = ExAllocatePoolWithTag(</span><br><span class="line">            NonPagedPool,</span><br><span class="line">            PAGE_SIZE,</span><br><span class="line">            <span class="string">&#x27;MBUF&#x27;</span>);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (buffer) &#123;</span><br><span class="line">            PMEMORY_BUFFER_ENTRY entry;</span><br><span class="line">            </span><br><span class="line">            entry = ExAllocatePoolWithTag(</span><br><span class="line">                NonPagedPool,</span><br><span class="line">                <span class="keyword">sizeof</span>(MEMORY_BUFFER_ENTRY),</span><br><span class="line">                <span class="string">&#x27;MBEN&#x27;</span>);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (entry) &#123;</span><br><span class="line">                entry-&gt;Buffer = buffer;</span><br><span class="line">                entry-&gt;Size = PAGE_SIZE;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 3. ���ӵ������б�</span></span><br><span class="line">                InsertTailList(</span><br><span class="line">                    &amp;OptMgr-&gt;MemoryOptimization.FreeBufferList,</span><br><span class="line">                    &amp;entry-&gt;ListEntry);</span><br><span class="line">                    </span><br><span class="line">                OptMgr-&gt;MemoryOptimization.BufferCount++;</span><br><span class="line">                OptMgr-&gt;MemoryOptimization.TotalBufferSize += PAGE_SIZE;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ExFreePool(buffer);</span><br><span class="line">                status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;OptMgr-&gt;MemoryOptimization.BufferLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CPU�Ż� - DPC������</span></span><br><span class="line">VOID <span class="title function_">RtsPciOptimizeDpcProcessing</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ POPTIMIZATION_MANAGER OptMgr,</span></span><br><span class="line"><span class="params">    _In_ PKDPC Dpc</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    ULONG processedCount = <span class="number">0</span>;</span><br><span class="line">    LIST_ENTRY localList;</span><br><span class="line">    </span><br><span class="line">    InitializeListHead(&amp;localList);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �ռ���������DPC</span></span><br><span class="line">    KeAcquireSpinLock(&amp;OptMgr-&gt;CPUOptimization.DpcLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!IsListEmpty(&amp;OptMgr-&gt;CPUOptimization.DpcQueue) &amp;&amp;</span><br><span class="line">           processedCount &lt; OptMgr-&gt;Config.CPU.DpcBatchSize) &#123;</span><br><span class="line">        PLIST_ENTRY entry = RemoveHeadList(</span><br><span class="line">            &amp;OptMgr-&gt;CPUOptimization.DpcQueue);</span><br><span class="line">            </span><br><span class="line">        InsertTailList(&amp;localList, entry);</span><br><span class="line">        processedCount++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;OptMgr-&gt;CPUOptimization.DpcLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��������DPC</span></span><br><span class="line">    <span class="keyword">while</span> (!IsListEmpty(&amp;localList)) &#123;</span><br><span class="line">        PLIST_ENTRY entry = RemoveHeadList(&amp;localList);</span><br><span class="line">        PDPC_WORK_ITEM workItem = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            DPC_WORK_ITEM,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// ִ��DPC������</span></span><br><span class="line">        workItem-&gt;WorkRoutine(</span><br><span class="line">            workItem-&gt;Context,</span><br><span class="line">            workItem-&gt;Parameter1,</span><br><span class="line">            workItem-&gt;Parameter2);</span><br><span class="line">            </span><br><span class="line">        ExFreePool(workItem);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CPU�Ż� - �жϺϲ�</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciOptimizeInterruptProcessing</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ POPTIMIZATION_MANAGER OptMgr,</span></span><br><span class="line"><span class="params">    _In_ ULONG InterruptStatus</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    LARGE_INTEGER currentTime;</span><br><span class="line">    BOOLEAN shouldDefer = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!OptMgr-&gt;Config.CPU.EnableInterruptCoalescing) &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeQuerySystemTime(&amp;currentTime);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����ж�Ƶ��</span></span><br><span class="line">    <span class="keyword">if</span> ((currentTime.QuadPart - </span><br><span class="line">         OptMgr-&gt;CPUOptimization.LastInterruptTime.QuadPart) &lt; </span><br><span class="line">        <span class="number">10000</span>) &#123;  <span class="comment">// 1ms</span></span><br><span class="line">        OptMgr-&gt;CPUOptimization.InterruptCount++;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. ����Ƿ���Ҫ�ϲ�</span></span><br><span class="line">        <span class="keyword">if</span> (OptMgr-&gt;CPUOptimization.InterruptCount &gt;= </span><br><span class="line">            OptMgr-&gt;Config.CPU.InterruptThreshold) &#123;</span><br><span class="line">            shouldDefer = TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ���ü�����</span></span><br><span class="line">        OptMgr-&gt;CPUOptimization.InterruptCount = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    OptMgr-&gt;CPUOptimization.LastInterruptTime = currentTime;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> shouldDefer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<p>[���� - ��һ���ֽ���ϸ���ܸ߼���Դ����]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-55"><a href="#User-55" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-55"><a href="#AI-claude-3-5-sonnet-55" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼���Դ�������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-21"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-21" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 21"></a>WDF SD Host Controller����ʵ����� - Part 21</h1><h2 id="22-�߼���Դ����"><a href="#22-�߼���Դ����" class="headerlink" title="22. �߼���Դ����"></a>22. �߼���Դ����</h2><h3 id="22-1-��Դ������ʵ��"><a href="#22-1-��Դ������ʵ��" class="headerlink" title="22.1 ��Դ������ʵ��"></a>22.1 ��Դ������ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��Դ���Ͷ���</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">RESOURCE_TYPE</span> &#123;</span></span><br><span class="line">    ResourceTypeMemory = <span class="number">0</span>,</span><br><span class="line">    ResourceTypeDma,</span><br><span class="line">    ResourceTypeInterrupt,</span><br><span class="line">    ResourceTypePort,</span><br><span class="line">    ResourceTypeMax</span><br><span class="line">&#125; RESOURCE_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ״̬</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">RESOURCE_STATE</span> &#123;</span></span><br><span class="line">    ResourceStateUninitialized = <span class="number">0</span>,</span><br><span class="line">    ResourceStateAllocated,</span><br><span class="line">    ResourceStateActive,</span><br><span class="line">    ResourceStateError,</span><br><span class="line">    ResourceStateReleased</span><br><span class="line">&#125; RESOURCE_STATE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">RESOURCE_DESCRIPTOR</span> &#123;</span></span><br><span class="line">    RESOURCE_TYPE Type;</span><br><span class="line">    RESOURCE_STATE State;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            PHYSICAL_ADDRESS PhysicalAddress;</span><br><span class="line">            PVOID VirtualAddress;</span><br><span class="line">            SIZE_T Length;</span><br><span class="line">            BOOLEAN Cached;</span><br><span class="line">        &#125; Memory;</span><br><span class="line">        </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            PHYSICAL_ADDRESS PortBase;</span><br><span class="line">            ULONG PortCount;</span><br><span class="line">            BOOLEAN WriteAccess;</span><br><span class="line">        &#125; Port;</span><br><span class="line">        </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            ULONG Vector;</span><br><span class="line">            KIRQL Irql;</span><br><span class="line">            KINTERRUPT_MODE InterruptMode;</span><br><span class="line">            BOOLEAN ShareVector;</span><br><span class="line">        &#125; Interrupt;</span><br><span class="line">        </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            PHYSICAL_ADDRESS LogicalAddress;</span><br><span class="line">            PVOID VirtualAddress;</span><br><span class="line">            ULONG Channel;</span><br><span class="line">            BOOLEAN WriteAccess;</span><br><span class="line">        &#125; Dma;</span><br><span class="line">    &#125; Info;</span><br><span class="line">&#125; RESOURCE_DESCRIPTOR, *PRESOURCE_DESCRIPTOR;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">RESOURCE_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ�б�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY ResourceList;</span><br><span class="line">        KSPIN_LOCK ResourceLock;</span><br><span class="line">        ULONG ResourceCount;</span><br><span class="line">    &#125; Resources[ResourceTypeMax];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դͳ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG AllocatedCount[ResourceTypeMax];</span><br><span class="line">        ULONG FailedAllocations;</span><br><span class="line">        SIZE_T TotalMemoryAllocated;</span><br><span class="line">        ULONG ActiveResources;</span><br><span class="line">    &#125; Statistics;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ����</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        SIZE_T MaxMemoryAllocation;</span><br><span class="line">        ULONG MaxDmaChannels;</span><br><span class="line">        ULONG MaxInterruptVectors;</span><br><span class="line">        ULONG MaxPortCount;</span><br><span class="line">    &#125; Limits;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ���</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        KTIMER MonitorTimer;</span><br><span class="line">        KDPC MonitorDpc;</span><br><span class="line">        LARGE_INTEGER LastCheckTime;</span><br><span class="line">        KSPIN_LOCK MonitorLock;</span><br><span class="line">    &#125; Monitor;</span><br><span class="line">&#125; RESOURCE_MANAGER, *PRESOURCE_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ����Դ������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeResourceManager</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PRESOURCE_MANAGER resMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ������Դ������</span></span><br><span class="line">    resMgr = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(RESOURCE_MANAGER),</span><br><span class="line">        <span class="string">&#x27;RMPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!resMgr) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(resMgr, <span class="keyword">sizeof</span>(RESOURCE_MANAGER));</span><br><span class="line">    resMgr-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ����Դ�б�</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; ResourceTypeMax; i++) &#123;</span><br><span class="line">        InitializeListHead(&amp;resMgr-&gt;Resources[i].ResourceList);</span><br><span class="line">        KeInitializeSpinLock(&amp;resMgr-&gt;Resources[i].ResourceLock);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʼ��������</span></span><br><span class="line">    KeInitializeSpinLock(&amp;resMgr-&gt;Monitor.MonitorLock);</span><br><span class="line">    KeInitializeTimer(&amp;resMgr-&gt;Monitor.MonitorTimer);</span><br><span class="line">    KeInitializeDpc(</span><br><span class="line">        &amp;resMgr-&gt;Monitor.MonitorDpc,</span><br><span class="line">        RtsPciResourceMonitorDpc,</span><br><span class="line">        resMgr);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 4. ������Դ����</span></span><br><span class="line">    resMgr-&gt;Limits.MaxMemoryAllocation = PAGE_SIZE * <span class="number">256</span>;  <span class="comment">// 1MB</span></span><br><span class="line">    resMgr-&gt;Limits.MaxDmaChannels = <span class="number">8</span>;</span><br><span class="line">    resMgr-&gt;Limits.MaxInterruptVectors = <span class="number">16</span>;</span><br><span class="line">    resMgr-&gt;Limits.MaxPortCount = <span class="number">32</span>;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;ResourceManager = resMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ������Դ���</span></span><br><span class="line">    RtsPciStartResourceMonitoring(resMgr);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h3 id="22-2-��Դ����͸���"><a href="#22-2-��Դ����͸���" class="headerlink" title="22.2 ��Դ����͸���"></a>22.2 ��Դ����͸���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ������Դ</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciAllocateResource</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PRESOURCE_MANAGER ResMgr,</span></span><br><span class="line"><span class="params">    _In_ RESOURCE_TYPE Type,</span></span><br><span class="line"><span class="params">    _In_ PVOID ResourceInfo,</span></span><br><span class="line"><span class="params">    _Out_ PRESOURCE_DESCRIPTOR* ResourceDesc</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    PRESOURCE_DESCRIPTOR resDesc;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��֤��Դ����</span></span><br><span class="line">    <span class="keyword">if</span> (!RtsPciValidateResourceAllocation(ResMgr, Type, ResourceInfo)) &#123;</span><br><span class="line">        InterlockedIncrement(&amp;ResMgr-&gt;Statistics.FailedAllocations);</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ������Դ������</span></span><br><span class="line">    resDesc = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(RESOURCE_DESCRIPTOR),</span><br><span class="line">        <span class="string">&#x27;RDPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!resDesc) &#123;</span><br><span class="line">        InterlockedIncrement(&amp;ResMgr-&gt;Statistics.FailedAllocations);</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(resDesc, <span class="keyword">sizeof</span>(RESOURCE_DESCRIPTOR));</span><br><span class="line">    resDesc-&gt;Type = Type;</span><br><span class="line">    resDesc-&gt;State = ResourceStateAllocated;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ������Դ���ͽ����ض���ʼ��</span></span><br><span class="line">    <span class="keyword">switch</span> (Type) &#123;</span><br><span class="line">        <span class="keyword">case</span> ResourceTypeMemory:</span><br><span class="line">            status = RtsPciInitializeMemoryResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                resDesc,</span><br><span class="line">                (PMEMORY_RESOURCE_INFO)ResourceInfo);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ResourceTypeDma:</span><br><span class="line">            status = RtsPciInitializeDmaResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                resDesc,</span><br><span class="line">                (PDMA_RESOURCE_INFO)ResourceInfo);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ResourceTypeInterrupt:</span><br><span class="line">            status = RtsPciInitializeInterruptResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                resDesc,</span><br><span class="line">                (PINTERRUPT_RESOURCE_INFO)ResourceInfo);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ResourceTypePort:</span><br><span class="line">            status = RtsPciInitializePortResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                resDesc,</span><br><span class="line">                (PPORT_RESOURCE_INFO)ResourceInfo);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            status = STATUS_INVALID_PARAMETER;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        ExFreePool(resDesc);</span><br><span class="line">        InterlockedIncrement(&amp;ResMgr-&gt;Statistics.FailedAllocations);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���ӵ���Դ�б�</span></span><br><span class="line">    KeAcquireSpinLock(&amp;ResMgr-&gt;Resources[Type].ResourceLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    InsertTailList(</span><br><span class="line">        &amp;ResMgr-&gt;Resources[Type].ResourceList,</span><br><span class="line">        &amp;resDesc-&gt;ListEntry);</span><br><span class="line">        </span><br><span class="line">    ResMgr-&gt;Resources[Type].ResourceCount++;</span><br><span class="line">    InterlockedIncrement(&amp;ResMgr-&gt;Statistics.AllocatedCount[Type]);</span><br><span class="line">    InterlockedIncrement(&amp;ResMgr-&gt;Statistics.ActiveResources);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (Type == ResourceTypeMemory) &#123;</span><br><span class="line">        ResMgr-&gt;Statistics.TotalMemoryAllocated += </span><br><span class="line">            resDesc-&gt;Info.Memory.Length;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;ResMgr-&gt;Resources[Type].ResourceLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    *ResourceDesc = resDesc;</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ���DPC</span></span><br><span class="line">VOID <span class="title function_">RtsPciResourceMonitorDpc</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PKDPC Dpc,</span></span><br><span class="line"><span class="params">    _In_ PVOID DeferredContext,</span></span><br><span class="line"><span class="params">    _In_ PVOID SystemArgument1,</span></span><br><span class="line"><span class="params">    _In_ PVOID SystemArgument2</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PRESOURCE_MANAGER resMgr = (PRESOURCE_MANAGER)DeferredContext;</span><br><span class="line">    LARGE_INTEGER currentTime;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    KeQuerySystemTime(&amp;currentTime);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����Դʹ�����</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG type = <span class="number">0</span>; type &lt; ResourceTypeMax; type++) &#123;</span><br><span class="line">        PLIST_ENTRY entry;</span><br><span class="line">        PRESOURCE_DESCRIPTOR resDesc;</span><br><span class="line">        </span><br><span class="line">        KeAcquireSpinLock(&amp;resMgr-&gt;Resources[type].ResourceLock, &amp;oldIrql);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (entry = resMgr-&gt;Resources[type].ResourceList.Flink;</span><br><span class="line">             entry != &amp;resMgr-&gt;Resources[type].ResourceList;</span><br><span class="line">             entry = entry-&gt;Flink) &#123;</span><br><span class="line">             </span><br><span class="line">            resDesc = CONTAINING_RECORD(</span><br><span class="line">                entry,</span><br><span class="line">                RESOURCE_DESCRIPTOR,</span><br><span class="line">                ListEntry);</span><br><span class="line">                </span><br><span class="line">            <span class="comment">// 2. �����Դ״̬</span></span><br><span class="line">            <span class="keyword">if</span> (resDesc-&gt;State == ResourceStateError) &#123;</span><br><span class="line">                <span class="comment">// ���Իָ�������Դ</span></span><br><span class="line">                RtsPciRecoverResource(resMgr, resDesc);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. �����Դй©</span></span><br><span class="line">            <span class="keyword">if</span> (resDesc-&gt;State == ResourceStateAllocated &amp;&amp;</span><br><span class="line">                (currentTime.QuadPart - resDesc-&gt;AllocationTime.QuadPart) &gt;</span><br><span class="line">                <span class="number">10000000</span>) &#123;  <span class="comment">// 1��</span></span><br><span class="line">                <span class="comment">// ��¼���ܵ���Դй©</span></span><br><span class="line">                RtsPciLogResourceLeak(resMgr, resDesc);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        KeReleaseSpinLock(&amp;resMgr-&gt;Resources[type].ResourceLock, oldIrql);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���µ��ȼ�ض�ʱ��</span></span><br><span class="line">    RtsPciScheduleResourceMonitor(resMgr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h3 id="22-3-��Դ�ͷzͻָ�"><a href="#22-3-��Դ�ͷzͻָ�" class="headerlink" title="22.3 ��Դ�ͷźͻָ�"></a>22.3 ��Դ�ͷźͻָ�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �ͷ���Դ</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciReleaseResource</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PRESOURCE_MANAGER ResMgr,</span></span><br><span class="line"><span class="params">    _In_ PRESOURCE_DESCRIPTOR ResourceDesc</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!ResourceDesc || ResourceDesc-&gt;State == ResourceStateReleased) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ������Դ����ִ������</span></span><br><span class="line">    <span class="keyword">switch</span> (ResourceDesc-&gt;Type) &#123;</span><br><span class="line">        <span class="keyword">case</span> ResourceTypeMemory:</span><br><span class="line">            status = RtsPciCleanupMemoryResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                ResourceDesc);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ResourceTypeDma:</span><br><span class="line">            status = RtsPciCleanupDmaResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                ResourceDesc);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ResourceTypeInterrupt:</span><br><span class="line">            status = RtsPciCleanupInterruptResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                ResourceDesc);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ResourceTypePort:</span><br><span class="line">            status = RtsPciCleanupPortResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                ResourceDesc);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����Դ�б��Ƴ�</span></span><br><span class="line">    KeAcquireSpinLock(</span><br><span class="line">        &amp;ResMgr-&gt;Resources[ResourceDesc-&gt;Type].ResourceLock,</span><br><span class="line">        &amp;oldIrql);</span><br><span class="line">        </span><br><span class="line">    RemoveEntryList(&amp;ResourceDesc-&gt;ListEntry);</span><br><span class="line">    ResMgr-&gt;Resources[ResourceDesc-&gt;Type].ResourceCount--;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ResourceDesc-&gt;Type == ResourceTypeMemory) &#123;</span><br><span class="line">        ResMgr-&gt;Statistics.TotalMemoryAllocated -= </span><br><span class="line">            ResourceDesc-&gt;Info.Memory.Length;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    InterlockedDecrement(&amp;ResMgr-&gt;Statistics.ActiveResources);</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(</span><br><span class="line">        &amp;ResMgr-&gt;Resources[ResourceDesc-&gt;Type].ResourceLock,</span><br><span class="line">        oldIrql);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. �ͷ���Դ������</span></span><br><span class="line">    ResourceDesc-&gt;State = ResourceStateReleased;</span><br><span class="line">    ExFreePool(ResourceDesc);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �ָ�������Դ</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciRecoverResource</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PRESOURCE_MANAGER ResMgr,</span></span><br><span class="line"><span class="params">    _In_ PRESOURCE_DESCRIPTOR ResourceDesc</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��֤��Դ״̬</span></span><br><span class="line">    <span class="keyword">if</span> (ResourceDesc-&gt;State != ResourceStateError) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ������Դ����ִ�лָ�</span></span><br><span class="line">    <span class="keyword">switch</span> (ResourceDesc-&gt;Type) &#123;</span><br><span class="line">        <span class="keyword">case</span> ResourceTypeMemory:</span><br><span class="line">            status = RtsPciRecoverMemoryResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                ResourceDesc);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ResourceTypeDma:</span><br><span class="line">            status = RtsPciRecoverDmaResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                ResourceDesc);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ResourceTypeInterrupt:</span><br><span class="line">            status = RtsPciRecoverInterruptResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                ResourceDesc);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ResourceTypePort:</span><br><span class="line">            status = RtsPciRecoverPortResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                ResourceDesc);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        ResourceDesc-&gt;State = ResourceStateActive;</span><br><span class="line">        ResourceDesc-&gt;ErrorCount = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ResourceDesc-&gt;ErrorCount++;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. ����Ƿ񳬹����ָ����Դ���</span></span><br><span class="line">        <span class="keyword">if</span> (ResourceDesc-&gt;ErrorCount &gt;= MAX_RECOVERY_ATTEMPTS) &#123;</span><br><span class="line">            <span class="comment">// ǿ���ͷ���Դ</span></span><br><span class="line">            RtsPciReleaseResource(ResMgr, ResourceDesc);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �ڴ���Դ�ָ�ʵ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciRecoverMemoryResource</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PRESOURCE_MANAGER ResMgr,</span></span><br><span class="line"><span class="params">    _In_ PRESOURCE_DESCRIPTOR ResourceDesc</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PHYSICAL_ADDRESS physAddr;</span><br><span class="line">    PVOID virtAddr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����ӳ���ڴ�</span></span><br><span class="line">    virtAddr = MmMapIoSpace(</span><br><span class="line">        ResourceDesc-&gt;Info.Memory.PhysicalAddress,</span><br><span class="line">        ResourceDesc-&gt;Info.Memory.Length,</span><br><span class="line">        ResourceDesc-&gt;Info.Memory.Cached ? </span><br><span class="line">            MmCached : MmNonCached);</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">if</span> (!virtAddr) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ������Դ��Ϣ</span></span><br><span class="line">    <span class="keyword">if</span> (ResourceDesc-&gt;Info.Memory.VirtualAddress) &#123;</span><br><span class="line">        MmUnmapIoSpace(</span><br><span class="line">            ResourceDesc-&gt;Info.Memory.VirtualAddress,</span><br><span class="line">            ResourceDesc-&gt;Info.Memory.Length);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ResourceDesc-&gt;Info.Memory.VirtualAddress = virtAddr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��֤�ڴ����</span></span><br><span class="line">    <span class="keyword">if</span> (!RtsPciValidateMemoryAccess(</span><br><span class="line">            ResourceDesc-&gt;Info.Memory.VirtualAddress,</span><br><span class="line">            ResourceDesc-&gt;Info.Memory.Length)) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_DEVICE_HARDWARE_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<p>[���� - ��һ���ֽ���ϸ���ܸ߼����ù���]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-56"><a href="#User-56" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-56"><a href="#AI-claude-3-5-sonnet-56" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼����ù������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-22"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-22" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 22"></a>WDF SD Host Controller����ʵ����� - Part 22</h1><h2 id="23-�߼����u���"><a href="#23-�߼����u���" class="headerlink" title="23. �߼����ù���"></a>23. �߼����ù���</h2><h3 id="23-1-���u�����ʵ��"><a href="#23-1-���u�����ʵ��" class="headerlink" title="23.1 ���ù�����ʵ��"></a>23.1 ���ù�����ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ����������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">CONFIG_ITEM_TYPE</span> &#123;</span></span><br><span class="line">    ConfigTypeInteger = <span class="number">0</span>,</span><br><span class="line">    ConfigTypeBoolean,</span><br><span class="line">    ConfigTypeString,</span><br><span class="line">    ConfigTypeBinary,</span><br><span class="line">    ConfigTypeMax</span><br><span class="line">&#125; CONFIG_ITEM_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���������Ȩ��</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">CONFIG_ACCESS</span> &#123;</span></span><br><span class="line">    ConfigAccessReadOnly = <span class="number">0</span>,</span><br><span class="line">    ConfigAccessReadWrite,</span><br><span class="line">    ConfigAccessWriteOnce</span><br><span class="line">&#125; CONFIG_ACCESS;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ������������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">CONFIG_ITEM_DESCRIPTOR</span> &#123;</span></span><br><span class="line">    WCHAR Name[<span class="number">64</span>];</span><br><span class="line">    CONFIG_ITEM_TYPE Type;</span><br><span class="line">    CONFIG_ACCESS Access;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            LONG MinValue;</span><br><span class="line">            LONG MaxValue;</span><br><span class="line">            LONG DefaultValue;</span><br><span class="line">            LONG CurrentValue;</span><br><span class="line">        &#125; Integer;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            BOOLEAN DefaultValue;</span><br><span class="line">            BOOLEAN CurrentValue;</span><br><span class="line">        &#125; Boolean;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            WCHAR DefaultValue[<span class="number">256</span>];</span><br><span class="line">            WCHAR CurrentValue[<span class="number">256</span>];</span><br><span class="line">            ULONG MaxLength;</span><br><span class="line">        &#125; String;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            PUCHAR DefaultValue;</span><br><span class="line">            PUCHAR CurrentValue;</span><br><span class="line">            ULONG Length;</span><br><span class="line">        &#125; Binary;</span><br><span class="line">    &#125; Data;</span><br><span class="line">    BOOLEAN Modified;</span><br><span class="line">    LARGE_INTEGER LastModified;</span><br><span class="line">&#125; CONFIG_ITEM_DESCRIPTOR, *PCONFIG_ITEM_DESCRIPTOR;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���ù�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">CONFIG_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������洢</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        PCONFIG_ITEM_DESCRIPTOR Items;</span><br><span class="line">        ULONG ItemCount;</span><br><span class="line">        KSPIN_LOCK ItemLock;</span><br><span class="line">    &#125; Storage;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ñ��֪ͨ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY NotifyList;</span><br><span class="line">        KSPIN_LOCK NotifyLock;</span><br><span class="line">    &#125; Notification;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ó־û�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN PersistenceEnabled;</span><br><span class="line">        WCHAR RegistryPath[<span class="number">256</span>];</span><br><span class="line">        HANDLE RegistryKey;</span><br><span class="line">    &#125; Persistence;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������֤</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN ValidationEnabled;</span><br><span class="line">        PFN_CONFIG_VALIDATE ValidateCallback;</span><br><span class="line">        PVOID ValidateContext;</span><br><span class="line">    &#125; Validation;</span><br><span class="line">&#125; CONFIG_MANAGER, *PCONFIG_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ�����ù�����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeConfigManager</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PCONFIG_MANAGER cfgMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �������ù�����</span></span><br><span class="line">    cfgMgr = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(CONFIG_MANAGER),</span><br><span class="line">        <span class="string">&#x27;CMPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!cfgMgr) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(cfgMgr, <span class="keyword">sizeof</span>(CONFIG_MANAGER));</span><br><span class="line">    cfgMgr-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ�����ô洢</span></span><br><span class="line">    KeInitializeSpinLock(&amp;cfgMgr-&gt;Storage.ItemLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Ԥ��������������</span></span><br><span class="line">    cfgMgr-&gt;Storage.Items = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(CONFIG_ITEM_DESCRIPTOR) * MAX_CONFIG_ITEMS,</span><br><span class="line">        <span class="string">&#x27;CIPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!cfgMgr-&gt;Storage.Items) &#123;</span><br><span class="line">        status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(</span><br><span class="line">        cfgMgr-&gt;Storage.Items,</span><br><span class="line">        <span class="keyword">sizeof</span>(CONFIG_ITEM_DESCRIPTOR) * MAX_CONFIG_ITEMS);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. ��ʼ��֪ͨϵͳ</span></span><br><span class="line">    InitializeListHead(&amp;cfgMgr-&gt;Notification.NotifyList);</span><br><span class="line">    KeInitializeSpinLock(&amp;cfgMgr-&gt;Notification.NotifyLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����Ĭ������</span></span><br><span class="line">    cfgMgr-&gt;Persistence.PersistenceEnabled = TRUE;</span><br><span class="line">    cfgMgr-&gt;Validation.ValidationEnabled = TRUE;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;ConfigManager = cfgMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ���س־û�����</span></span><br><span class="line">    <span class="keyword">if</span> (cfgMgr-&gt;Persistence.PersistenceEnabled) &#123;</span><br><span class="line">        status = RtsPciLoadPersistedConfig(cfgMgr);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="comment">// ����ʧ��ʱʹ��Ĭ��ֵ</span></span><br><span class="line">            RtsPciInitializeDefaultConfig(cfgMgr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">cleanup:</span><br><span class="line">    RtsPciCleanupConfigManager(cfgMgr);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>










<h3 id="23-2-���������"><a href="#23-2-���������" class="headerlink" title="23.2 ���������"></a>23.2 ���������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ע��������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciRegisterConfigItem</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCONFIG_MANAGER CfgMgr,</span></span><br><span class="line"><span class="params">    _In_ PWCHAR Name,</span></span><br><span class="line"><span class="params">    _In_ CONFIG_ITEM_TYPE Type,</span></span><br><span class="line"><span class="params">    _In_ CONFIG_ACCESS Access,</span></span><br><span class="line"><span class="params">    _In_ PVOID DefaultValue,</span></span><br><span class="line"><span class="params">    _In_opt_ PVOID Constraints</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PCONFIG_ITEM_DESCRIPTOR item = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��֤����</span></span><br><span class="line">    <span class="keyword">if</span> (!Name || !DefaultValue) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����Ƿ��Ѵ���</span></span><br><span class="line">    KeAcquireSpinLock(&amp;CfgMgr-&gt;Storage.ItemLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    item = RtsPciFindConfigItem(CfgMgr, Name);</span><br><span class="line">    <span class="keyword">if</span> (item) &#123;</span><br><span class="line">        KeReleaseSpinLock(&amp;CfgMgr-&gt;Storage.ItemLock, oldIrql);</span><br><span class="line">        <span class="keyword">return</span> STATUS_DUPLICATE_NAME;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ������������</span></span><br><span class="line">    <span class="keyword">if</span> (CfgMgr-&gt;Storage.ItemCount &gt;= MAX_CONFIG_ITEMS) &#123;</span><br><span class="line">        KeReleaseSpinLock(&amp;CfgMgr-&gt;Storage.ItemLock, oldIrql);</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    item = &amp;CfgMgr-&gt;Storage.Items[CfgMgr-&gt;Storage.ItemCount];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ��ʼ��������</span></span><br><span class="line">    RtlZeroMemory(item, <span class="keyword">sizeof</span>(CONFIG_ITEM_DESCRIPTOR));</span><br><span class="line">    RtlStringCchCopyW(item-&gt;Name, ARRAYSIZE(item-&gt;Name), Name);</span><br><span class="line">    item-&gt;Type = Type;</span><br><span class="line">    item-&gt;Access = Access;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ������������Ĭ��ֵ</span></span><br><span class="line">    <span class="keyword">switch</span> (Type) &#123;</span><br><span class="line">        <span class="keyword">case</span> ConfigTypeInteger:</span><br><span class="line">            &#123;</span><br><span class="line">                PCONFIG_INTEGER_CONSTRAINTS constraints = </span><br><span class="line">                    (PCONFIG_INTEGER_CONSTRAINTS)Constraints;</span><br><span class="line">                    </span><br><span class="line">                item-&gt;Data.Integer.DefaultValue = </span><br><span class="line">                    *(PLONG)DefaultValue;</span><br><span class="line">                item-&gt;Data.Integer.CurrentValue = </span><br><span class="line">                    *(PLONG)DefaultValue;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">if</span> (constraints) &#123;</span><br><span class="line">                    item-&gt;Data.Integer.MinValue = </span><br><span class="line">                        constraints-&gt;MinValue;</span><br><span class="line">                    item-&gt;Data.Integer.MaxValue = </span><br><span class="line">                        constraints-&gt;MaxValue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ConfigTypeBoolean:</span><br><span class="line">            item-&gt;Data.Boolean.DefaultValue = </span><br><span class="line">                *(PBOOLEAN)DefaultValue;</span><br><span class="line">            item-&gt;Data.Boolean.CurrentValue = </span><br><span class="line">                *(PBOOLEAN)DefaultValue;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ConfigTypeString:</span><br><span class="line">            &#123;</span><br><span class="line">                PCONFIG_STRING_CONSTRAINTS constraints =</span><br><span class="line">                    (PCONFIG_STRING_CONSTRAINTS)Constraints;</span><br><span class="line">                    </span><br><span class="line">                RtlStringCchCopyW(</span><br><span class="line">                    item-&gt;Data.String.DefaultValue,</span><br><span class="line">                    ARRAYSIZE(item-&gt;Data.String.DefaultValue),</span><br><span class="line">                    (PWCHAR)DefaultValue);</span><br><span class="line">                    </span><br><span class="line">                RtlStringCchCopyW(</span><br><span class="line">                    item-&gt;Data.String.CurrentValue,</span><br><span class="line">                    ARRAYSIZE(item-&gt;Data.String.CurrentValue),</span><br><span class="line">                    (PWCHAR)DefaultValue);</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">if</span> (constraints) &#123;</span><br><span class="line">                    item-&gt;Data.String.MaxLength = </span><br><span class="line">                        constraints-&gt;MaxLength;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ConfigTypeBinary:</span><br><span class="line">            &#123;</span><br><span class="line">                PCONFIG_BINARY_CONSTRAINTS constraints =</span><br><span class="line">                    (PCONFIG_BINARY_CONSTRAINTS)Constraints;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">if</span> (constraints &amp;&amp; constraints-&gt;Length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    item-&gt;Data.Binary.DefaultValue = </span><br><span class="line">                        ExAllocatePoolWithTag(</span><br><span class="line">                            NonPagedPool,</span><br><span class="line">                            constraints-&gt;Length,</span><br><span class="line">                            <span class="string">&#x27;CBPR&#x27;</span>);</span><br><span class="line">                            </span><br><span class="line">                    item-&gt;Data.Binary.CurrentValue = </span><br><span class="line">                        ExAllocatePoolWithTag(</span><br><span class="line">                            NonPagedPool,</span><br><span class="line">                            constraints-&gt;Length,</span><br><span class="line">                            <span class="string">&#x27;CBPR&#x27;</span>);</span><br><span class="line">                            </span><br><span class="line">                    <span class="keyword">if</span> (!item-&gt;Data.Binary.DefaultValue ||</span><br><span class="line">                        !item-&gt;Data.Binary.CurrentValue) &#123;</span><br><span class="line">                        status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    RtlCopyMemory(</span><br><span class="line">                        item-&gt;Data.Binary.DefaultValue,</span><br><span class="line">                        DefaultValue,</span><br><span class="line">                        constraints-&gt;Length);</span><br><span class="line">                        </span><br><span class="line">                    RtlCopyMemory(</span><br><span class="line">                        item-&gt;Data.Binary.CurrentValue,</span><br><span class="line">                        DefaultValue,</span><br><span class="line">                        constraints-&gt;Length);</span><br><span class="line">                        </span><br><span class="line">                    item-&gt;Data.Binary.Length = constraints-&gt;Length;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        CfgMgr-&gt;Storage.ItemCount++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;CfgMgr-&gt;Storage.ItemLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>










<h3 id="23-3-���o־u�"><a href="#23-3-���o־u�" class="headerlink" title="23.3 ���ó־û�"></a>23.3 ���ó־û�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �������õ�ע���</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciSaveConfigToRegistry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCONFIG_MANAGER CfgMgr</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    HANDLE regKey;</span><br><span class="line">    UNICODE_STRING valueName;</span><br><span class="line">    PCONFIG_ITEM_DESCRIPTOR item;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ע�����</span></span><br><span class="line">    status = RtsPciOpenConfigRegistry(</span><br><span class="line">        CfgMgr,</span><br><span class="line">        &amp;regKey,</span><br><span class="line">        TRUE);  <span class="comment">// �������������</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��������������</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; CfgMgr-&gt;Storage.ItemCount; i++) &#123;</span><br><span class="line">        item = &amp;CfgMgr-&gt;Storage.Items[i];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ֻ�������޸ĵ���</span></span><br><span class="line">        <span class="keyword">if</span> (!item-&gt;Modified) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        RtlInitUnicodeString(&amp;valueName, item-&gt;Name);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. �������ͱ���ֵ</span></span><br><span class="line">        <span class="keyword">switch</span> (item-&gt;Type) &#123;</span><br><span class="line">            <span class="keyword">case</span> ConfigTypeInteger:</span><br><span class="line">                status = RtlWriteRegistryValue(</span><br><span class="line">                    RTL_REGISTRY_ABSOLUTE,</span><br><span class="line">                    CfgMgr-&gt;Persistence.RegistryPath,</span><br><span class="line">                    valueName.Buffer,</span><br><span class="line">                    REG_DWORD,</span><br><span class="line">                    &amp;item-&gt;Data.Integer.CurrentValue,</span><br><span class="line">                    <span class="keyword">sizeof</span>(LONG));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> ConfigTypeBoolean:</span><br><span class="line">                &#123;</span><br><span class="line">                    ULONG value = item-&gt;Data.Boolean.CurrentValue;</span><br><span class="line">                    status = RtlWriteRegistryValue(</span><br><span class="line">                        RTL_REGISTRY_ABSOLUTE,</span><br><span class="line">                        CfgMgr-&gt;Persistence.RegistryPath,</span><br><span class="line">                        valueName.Buffer,</span><br><span class="line">                        REG_DWORD,</span><br><span class="line">                        &amp;value,</span><br><span class="line">                        <span class="keyword">sizeof</span>(ULONG));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> ConfigTypeString:</span><br><span class="line">                status = RtlWriteRegistryValue(</span><br><span class="line">                    RTL_REGISTRY_ABSOLUTE,</span><br><span class="line">                    CfgMgr-&gt;Persistence.RegistryPath,</span><br><span class="line">                    valueName.Buffer,</span><br><span class="line">                    REG_SZ,</span><br><span class="line">                    item-&gt;Data.String.CurrentValue,</span><br><span class="line">                    (wcslen(item-&gt;Data.String.CurrentValue) + <span class="number">1</span>) * </span><br><span class="line">                        <span class="keyword">sizeof</span>(WCHAR));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> ConfigTypeBinary:</span><br><span class="line">                status = RtlWriteRegistryValue(</span><br><span class="line">                    RTL_REGISTRY_ABSOLUTE,</span><br><span class="line">                    CfgMgr-&gt;Persistence.RegistryPath,</span><br><span class="line">                    valueName.Buffer,</span><br><span class="line">                    REG_BINARY,</span><br><span class="line">                    item-&gt;Data.Binary.CurrentValue,</span><br><span class="line">                    item-&gt;Data.Binary.Length);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            item-&gt;Modified = FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ZwClose(regKey);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ע�����������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciLoadConfigFromRegistry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCONFIG_MANAGER CfgMgr</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    HANDLE regKey;</span><br><span class="line">    UNICODE_STRING valueName;</span><br><span class="line">    PCONFIG_ITEM_DESCRIPTOR item;</span><br><span class="line">    UCHAR buffer[<span class="number">512</span>];</span><br><span class="line">    ULONG length;</span><br><span class="line">    PKEY_VALUE_PARTIAL_INFORMATION valueInfo;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ע�����</span></span><br><span class="line">    status = RtsPciOpenConfigRegistry(</span><br><span class="line">        CfgMgr,</span><br><span class="line">        &amp;regKey,</span><br><span class="line">        FALSE);  <span class="comment">// ������</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    valueInfo = (PKEY_VALUE_PARTIAL_INFORMATION)buffer;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��������������</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; CfgMgr-&gt;Storage.ItemCount; i++) &#123;</span><br><span class="line">        item = &amp;CfgMgr-&gt;Storage.Items[i];</span><br><span class="line">        RtlInitUnicodeString(&amp;valueName, item-&gt;Name);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. ��ȡע���ֵ</span></span><br><span class="line">        status = ZwQueryValueKey(</span><br><span class="line">            regKey,</span><br><span class="line">            &amp;valueName,</span><br><span class="line">            KeyValuePartialInformation,</span><br><span class="line">            valueInfo,</span><br><span class="line">            <span class="keyword">sizeof</span>(buffer),</span><br><span class="line">            &amp;length);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="comment">// 4. �������͸���ֵ</span></span><br><span class="line">            <span class="keyword">switch</span> (item-&gt;Type) &#123;</span><br><span class="line">                <span class="keyword">case</span> ConfigTypeInteger:</span><br><span class="line">                    <span class="keyword">if</span> (valueInfo-&gt;Type == REG_DWORD &amp;&amp;</span><br><span class="line">                        valueInfo-&gt;DataLength == <span class="keyword">sizeof</span>(LONG)) &#123;</span><br><span class="line">                        item-&gt;Data.Integer.CurrentValue = </span><br><span class="line">                            *(PLONG)valueInfo-&gt;Data;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> ConfigTypeBoolean:</span><br><span class="line">                    <span class="keyword">if</span> (valueInfo-&gt;Type == REG_DWORD &amp;&amp;</span><br><span class="line">                        valueInfo-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG)) &#123;</span><br><span class="line">                        item-&gt;Data.Boolean.CurrentValue = </span><br><span class="line">                            (*(PULONG)valueInfo-&gt;Data != <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> ConfigTypeString:</span><br><span class="line">                    <span class="keyword">if</span> (valueInfo-&gt;Type == REG_SZ) &#123;</span><br><span class="line">                        RtlStringCchCopyW(</span><br><span class="line">                            item-&gt;Data.String.CurrentValue,</span><br><span class="line">                            ARRAYSIZE(item-&gt;Data.String.CurrentValue),</span><br><span class="line">                            (PWCHAR)valueInfo-&gt;Data);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> ConfigTypeBinary:</span><br><span class="line">                    <span class="keyword">if</span> (valueInfo-&gt;Type == REG_BINARY &amp;&amp;</span><br><span class="line">                        valueInfo-&gt;DataLength &lt;= item-&gt;Data.Binary.Length) &#123;</span><br><span class="line">                        RtlCopyMemory(</span><br><span class="line">                            item-&gt;Data.Binary.CurrentValue,</span><br><span class="line">                            valueInfo-&gt;Data,</span><br><span class="line">                            valueInfo-&gt;DataLength);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ZwClose(regKey);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>










<p>[���� - ��һ���ֽ���ϸ���ܸ߼���ȫ����]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-57"><a href="#User-57" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����û��</p>
<h2 id="AI-claude-3-5-sonnet-57"><a href="#AI-claude-3-5-sonnet-57" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>���м�����Ҫ������Ҫչ����</p>
<ol>
<li>�߼���ȫ����</li>
<li>�߼���Ϲ���</li>
<li>�߼�ң�⹦��</li>
<li>�߼��̼�����</li>
<li>���������Բ���</li>
<li>�����������ܻ�׼����</li>
<li>������������Բ���</li>
<li>���������ĵ�����</li>
</ol>
<p>����������ĸ����֣������Ѿ������ˣ���Щ������Ը߼��Ĺ���ģ�飬����ÿ����������Ҫʵ����ô�����Ĺ��ܡ��ҿ��Ը���������Ȥѡ���Ե�չ��ĳЩ���֣����ߵ���Ϊֹ��</p>
<p>����������Ѿ��㹻�ˣ����ǿ��Խ������ϵ�С��Ͼ�ǰ���Ѿ�������SD������������������Ҫ���Ĺ���ʵ�֡�</p>
<p>�������أ�</p>
<h2 id="User-58"><a href="#User-58" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>���������ĵ�����</p>
<h2 id="AI-claude-3-5-sonnet-58"><a href="#AI-claude-3-5-sonnet-58" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ�����������ĵ����ɲ��֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-23"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-23" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 23"></a>WDF SD Host Controller����ʵ����� - Part 23</h1><h2 id="24-���������j�����"><a href="#24-���������j�����" class="headerlink" title="24. ���������ĵ�����"></a>24. ���������ĵ�����</h2><h3 id="24-1-�j�������ʵ��"><a href="#24-1-�j�������ʵ��" class="headerlink" title="24.1 �ĵ�������ʵ��"></a>24.1 �ĵ�������ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �ĵ����Ͷ���</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">DOC_TYPE</span> &#123;</span></span><br><span class="line">    DocTypeAPI = <span class="number">0</span>,</span><br><span class="line">    DocTypeArchitecture,</span><br><span class="line">    DocTypeDeployment,</span><br><span class="line">    DocTypeTesting,</span><br><span class="line">    DocTypeMax</span><br><span class="line">&#125; DOC_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �ĵ���ʽ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">DOC_FORMAT</span> &#123;</span></span><br><span class="line">    DocFormatMarkdown = <span class="number">0</span>,</span><br><span class="line">    DocFormatHTML,</span><br><span class="line">    DocFormatPDF,</span><br><span class="line">    DocFormatRTF</span><br><span class="line">&#125; DOC_FORMAT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �ĵ�������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DOC_GENERATOR</span> &#123;</span></span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        DOC_FORMAT OutputFormat;</span><br><span class="line">        WCHAR OutputPath[MAX_PATH];</span><br><span class="line">        BOOLEAN IncludePrivate;</span><br><span class="line">        BOOLEAN IncludeInternal;</span><br><span class="line">        BOOLEAN GenerateIndex;</span><br><span class="line">        BOOLEAN GenerateDiagrams;</span><br><span class="line">    &#125; Config;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Դ�������</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY SourceFiles;</span><br><span class="line">        KSPIN_LOCK SourceLock;</span><br><span class="line">        ULONG FileCount;</span><br><span class="line">        ULONG TotalLines;</span><br><span class="line">    &#125; Source;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// API�ĵ�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY Functions;</span><br><span class="line">        LIST_ENTRY Structures;</span><br><span class="line">        LIST_ENTRY Enums;</span><br><span class="line">        LIST_ENTRY Callbacks;</span><br><span class="line">        KSPIN_LOCK ApiLock;</span><br><span class="line">    &#125; API;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ܹ��ĵ�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY Components;</span><br><span class="line">        LIST_ENTRY Interfaces;</span><br><span class="line">        LIST_ENTRY Dependencies;</span><br><span class="line">        KSPIN_LOCK ArchLock;</span><br><span class="line">    &#125; Architecture;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ĵ�ģ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        PWCHAR HeaderTemplate;</span><br><span class="line">        PWCHAR FooterTemplate;</span><br><span class="line">        PWCHAR FunctionTemplate;</span><br><span class="line">        PWCHAR StructTemplate;</span><br><span class="line">        PWCHAR EnumTemplate;</span><br><span class="line">    &#125; Templates;</span><br><span class="line">&#125; DOC_GENERATOR, *PDOC_GENERATOR;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ���ĵ�������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeDocGenerator</span><span class="params">(</span></span><br><span class="line"><span class="params">    _Out_ PDOC_GENERATOR* DocGen</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDOC_GENERATOR docGen;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����ĵ�������</span></span><br><span class="line">    docGen = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(DOC_GENERATOR),</span><br><span class="line">        <span class="string">&#x27;DGPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!docGen) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(docGen, <span class="keyword">sizeof</span>(DOC_GENERATOR));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ���б�����</span></span><br><span class="line">    InitializeListHead(&amp;docGen-&gt;Source.SourceFiles);</span><br><span class="line">    InitializeListHead(&amp;docGen-&gt;API.Functions);</span><br><span class="line">    InitializeListHead(&amp;docGen-&gt;API.Structures);</span><br><span class="line">    InitializeListHead(&amp;docGen-&gt;API.Enums);</span><br><span class="line">    InitializeListHead(&amp;docGen-&gt;API.Callbacks);</span><br><span class="line">    InitializeListHead(&amp;docGen-&gt;Architecture.Components);</span><br><span class="line">    InitializeListHead(&amp;docGen-&gt;Architecture.Interfaces);</span><br><span class="line">    InitializeListHead(&amp;docGen-&gt;Architecture.Dependencies);</span><br><span class="line">    </span><br><span class="line">    KeInitializeSpinLock(&amp;docGen-&gt;Source.SourceLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;docGen-&gt;API.ApiLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;docGen-&gt;Architecture.ArchLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����Ĭ������</span></span><br><span class="line">    docGen-&gt;Config.OutputFormat = DocFormatMarkdown;</span><br><span class="line">    docGen-&gt;Config.IncludePrivate = FALSE;</span><br><span class="line">    docGen-&gt;Config.IncludeInternal = TRUE;</span><br><span class="line">    docGen-&gt;Config.GenerateIndex = TRUE;</span><br><span class="line">    docGen-&gt;Config.GenerateDiagrams = TRUE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �����ĵ�ģ��</span></span><br><span class="line">    RtsPciLoadDocTemplates(docGen);</span><br><span class="line">    </span><br><span class="line">    *DocGen = docGen;</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>










<h3 id="24-2-Դ���������API��ȡ"><a href="#24-2-Դ���������API��ȡ" class="headerlink" title="24.2 Դ���������API��ȡ"></a>24.2 Դ���������API��ȡ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Դ�ļ�����������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SOURCE_PARSE_CONTEXT</span> &#123;</span></span><br><span class="line">    PWCHAR FilePath;</span><br><span class="line">    PWCHAR FileContent;</span><br><span class="line">    SIZE_T FileSize;</span><br><span class="line">    ULONG LineCount;</span><br><span class="line">    ULONG CurrentLine;</span><br><span class="line">    PWCHAR CurrentPos;</span><br><span class="line">&#125; SOURCE_PARSE_CONTEXT, *PSOURCE_PARSE_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����Դ�ļ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciParseSourceFile</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDOC_GENERATOR DocGen,</span></span><br><span class="line"><span class="params">    _In_ PWCHAR FilePath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    SOURCE_PARSE_CONTEXT parseCtx = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    HANDLE fileHandle;</span><br><span class="line">    LARGE_INTEGER fileSize;</span><br><span class="line">    IO_STATUS_BLOCK ioStatus;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��Դ�ļ�</span></span><br><span class="line">    status = RtsPciOpenSourceFile(FilePath, &amp;fileHandle);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ȡ�ļ�����</span></span><br><span class="line">    status = ZwQueryInformationFile(</span><br><span class="line">        fileHandle,</span><br><span class="line">        &amp;ioStatus,</span><br><span class="line">        &amp;fileSize,</span><br><span class="line">        <span class="keyword">sizeof</span>(fileSize),</span><br><span class="line">        FileStandardInformation);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        ZwClose(fileHandle);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    parseCtx.FileContent = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        fileSize.QuadPart,</span><br><span class="line">        <span class="string">&#x27;SFPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!parseCtx.FileContent) &#123;</span><br><span class="line">        ZwClose(fileHandle);</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    status = ZwReadFile(</span><br><span class="line">        fileHandle,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;ioStatus,</span><br><span class="line">        parseCtx.FileContent,</span><br><span class="line">        fileSize.LowPart,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">    ZwClose(fileHandle);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        ExFreePool(parseCtx.FileContent);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʼ������������</span></span><br><span class="line">    parseCtx.FilePath = FilePath;</span><br><span class="line">    parseCtx.FileSize = fileSize.QuadPart;</span><br><span class="line">    parseCtx.CurrentPos = parseCtx.FileContent;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �����ļ�����</span></span><br><span class="line">    <span class="keyword">while</span> (parseCtx.CurrentPos &lt; </span><br><span class="line">           parseCtx.FileContent + parseCtx.FileSize) &#123;</span><br><span class="line">        <span class="comment">// ������������</span></span><br><span class="line">        status = RtsPciParseFunctionDefinition(DocGen, &amp;parseCtx);</span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// �����ṹ����</span></span><br><span class="line">        status = RtsPciParseStructDefinition(DocGen, &amp;parseCtx);</span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����ö�ٶ���</span></span><br><span class="line">        status = RtsPciParseEnumDefinition(DocGen, &amp;parseCtx);</span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// �����ص�����</span></span><br><span class="line">        status = RtsPciParseCallbackDefinition(DocGen, &amp;parseCtx);</span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// �ƶ�����һ��</span></span><br><span class="line">        RtsPciAdvanceToNextLine(&amp;parseCtx);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����</span></span><br><span class="line">    ExFreePool(parseCtx.FileContent);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ������������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciParseFunctionDefinition</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDOC_GENERATOR DocGen,</span></span><br><span class="line"><span class="params">    _In_ PSOURCE_PARSE_CONTEXT ParseCtx</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    PFUNCTION_DOC_ENTRY funcEntry;</span><br><span class="line">    PWCHAR funcStart, funcEnd;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���Һ�����ʼ���</span></span><br><span class="line">    funcStart = RtsPciFindFunctionStart(ParseCtx-&gt;CurrentPos);</span><br><span class="line">    <span class="keyword">if</span> (!funcStart) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_NOT_FOUND;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���Һ����������</span></span><br><span class="line">    funcEnd = RtsPciFindFunctionEnd(funcStart);</span><br><span class="line">    <span class="keyword">if</span> (!funcEnd) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_NOT_FOUND;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���������ĵ���Ŀ</span></span><br><span class="line">    funcEntry = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(FUNCTION_DOC_ENTRY),</span><br><span class="line">        <span class="string">&#x27;FDPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!funcEntry) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(funcEntry, <span class="keyword">sizeof</span>(FUNCTION_DOC_ENTRY));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����������Ϣ</span></span><br><span class="line">    status = RtsPciExtractFunctionInfo(</span><br><span class="line">        funcStart,</span><br><span class="line">        funcEnd - funcStart,</span><br><span class="line">        funcEntry);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="comment">// 5. ���ӵ�API�ĵ�</span></span><br><span class="line">        ExInterlockedInsertTailList(</span><br><span class="line">            &amp;DocGen-&gt;API.Functions,</span><br><span class="line">            &amp;funcEntry-&gt;ListEntry,</span><br><span class="line">            &amp;DocGen-&gt;API.ApiLock);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ExFreePool(funcEntry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ���½���λ��</span></span><br><span class="line">    ParseCtx-&gt;CurrentPos = funcEnd;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>










<h3 id="24-3-�j����ɺ͸�ʽ��"><a href="#24-3-�j����ɺ͸�ʽ��" class="headerlink" title="24.3 �ĵ����ɺ͸�ʽ��"></a>24.3 �ĵ����ɺ͸�ʽ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ����API�ĵ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciGenerateApiDocumentation</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDOC_GENERATOR DocGen,</span></span><br><span class="line"><span class="params">    _In_ PWCHAR OutputPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    HANDLE fileHandle;</span><br><span class="line">    IO_STATUS_BLOCK ioStatus;</span><br><span class="line">    PLIST_ENTRY entry;</span><br><span class="line">    UNICODE_STRING fileName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��������ļ�</span></span><br><span class="line">    RtlInitUnicodeString(&amp;fileName, OutputPath);</span><br><span class="line">    </span><br><span class="line">    status = RtsPciCreateOutputFile(</span><br><span class="line">        &amp;fileName,</span><br><span class="line">        &amp;fileHandle);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. д���ĵ�ͷ��</span></span><br><span class="line">    status = RtsPciWriteDocHeader(</span><br><span class="line">        fileHandle,</span><br><span class="line">        DocGen-&gt;Templates.HeaderTemplate);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���ɺ����ĵ�</span></span><br><span class="line">    <span class="keyword">for</span> (entry = DocGen-&gt;API.Functions.Flink;</span><br><span class="line">         entry != &amp;DocGen-&gt;API.Functions;</span><br><span class="line">         entry = entry-&gt;Flink) &#123;</span><br><span class="line">        PFUNCTION_DOC_ENTRY funcEntry = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            FUNCTION_DOC_ENTRY,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        status = RtsPciFormatFunctionDoc(</span><br><span class="line">            DocGen,</span><br><span class="line">            funcEntry,</span><br><span class="line">            fileHandle);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���ɽṹ�ĵ�</span></span><br><span class="line">    <span class="keyword">for</span> (entry = DocGen-&gt;API.Structures.Flink;</span><br><span class="line">         entry != &amp;DocGen-&gt;API.Structures;</span><br><span class="line">         entry = entry-&gt;Flink) &#123;</span><br><span class="line">        PSTRUCT_DOC_ENTRY structEntry = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            STRUCT_DOC_ENTRY,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        status = RtsPciFormatStructDoc(</span><br><span class="line">            DocGen,</span><br><span class="line">            structEntry,</span><br><span class="line">            fileHandle);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����ö���ĵ�</span></span><br><span class="line">    <span class="keyword">for</span> (entry = DocGen-&gt;API.Enums.Flink;</span><br><span class="line">         entry != &amp;DocGen-&gt;API.Enums;</span><br><span class="line">         entry = entry-&gt;Flink) &#123;</span><br><span class="line">        PENUM_DOC_ENTRY enumEntry = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            ENUM_DOC_ENTRY,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        status = RtsPciFormatEnumDoc(</span><br><span class="line">            DocGen,</span><br><span class="line">            enumEntry,</span><br><span class="line">            fileHandle);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. д���ĵ�β��</span></span><br><span class="line">    status = RtsPciWriteDocFooter(</span><br><span class="line">        fileHandle,</span><br><span class="line">        DocGen-&gt;Templates.FooterTemplate);</span><br><span class="line">        </span><br><span class="line">cleanup:</span><br><span class="line">    ZwClose(fileHandle);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʽ�������ĵ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciFormatFunctionDoc</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDOC_GENERATOR DocGen,</span></span><br><span class="line"><span class="params">    _In_ PFUNCTION_DOC_ENTRY FuncEntry,</span></span><br><span class="line"><span class="params">    _In_ HANDLE FileHandle</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PWCHAR buffer;</span><br><span class="line">    SIZE_T bufferSize;</span><br><span class="line">    IO_STATUS_BLOCK ioStatus;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �������軺������С</span></span><br><span class="line">    bufferSize = RtsPciCalculateFunctionDocSize(</span><br><span class="line">        DocGen-&gt;Templates.FunctionTemplate,</span><br><span class="line">        FuncEntry);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. ���仺����</span></span><br><span class="line">    buffer = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        bufferSize,</span><br><span class="line">        <span class="string">&#x27;FDOC&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!buffer) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʽ�������ĵ�</span></span><br><span class="line">    status = RtsPciFormatFunctionDocContent(</span><br><span class="line">        DocGen-&gt;Templates.FunctionTemplate,</span><br><span class="line">        FuncEntry,</span><br><span class="line">        buffer,</span><br><span class="line">        bufferSize);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="comment">// 4. д���ļ�</span></span><br><span class="line">        status = ZwWriteFile(</span><br><span class="line">            FileHandle,</span><br><span class="line">            <span class="literal">NULL</span>,</span><br><span class="line">            <span class="literal">NULL</span>,</span><br><span class="line">            <span class="literal">NULL</span>,</span><br><span class="line">            &amp;ioStatus,</span><br><span class="line">            buffer,</span><br><span class="line">            (ULONG)wcslen(buffer) * <span class="keyword">sizeof</span>(WCHAR),</span><br><span class="line">            <span class="literal">NULL</span>,</span><br><span class="line">            <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ExFreePool(buffer);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���ɼܹ�ͼ</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciGenerateArchitectureDiagram</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDOC_GENERATOR DocGen,</span></span><br><span class="line"><span class="params">    _In_ PWCHAR OutputPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ʹ��Graphviz������ͼ�ο����ɼܹ�ͼ</span></span><br><span class="line">    <span class="comment">// ����ʡ�Ծ���ʵ��...</span></span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>










<p>��������������ĵ�����������Ҫʵ�֡������ԣ�</p>
<ol>
<li>�Զ�����Դ���룬��ȡAPI���塢�ṹ��ö�ٵ�</li>
<li>���ɸ�ʽ����API�ĵ�</li>
<li>���ɼܹ�ͼ�������ϵͼ</li>
<li>֧�ֶ��������ʽ(Markdown��HTML��PDF��)</li>
<li>�����õ��ĵ�����ѡ��</li>
</ol>
<p>����ĵ�����������ά����������������Ŀ���а��������Ա��ִ�����ĵ���ͬ���ԡ�</p>
<p>��Ҫ�Ҽ���չ�����������𣿻��ǵ���Ϊֹ��</p>
<h2 id="User-59"><a href="#User-59" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����һ��SD������������������Ҫ���Ĺ��������ļ�������</p>
<h2 id="AI-claude-3-5-sonnet-59"><a href="#AI-claude-3-5-sonnet-59" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>SD������������������Ҫ���Ĺ�����Ҫ���������¼����ؼ����֣�</p>
<ol>
<li>�豸��ʼ���ͻ�������</li>
</ol>
<ul>
<li>�豸�����ĳ�ʼ��</li>
<li>Ӳ����Դ��ȡ��ӳ��</li>
<li>�Ĵ�������</li>
<li>�жϳ�ʼ��</li>
</ul>
<ol start="2">
<li>I&#x2F;O������</li>
</ol>
<ul>
<li>��д������</li>
<li>����������</li>
<li>DMA�������</li>
<li>������й���</li>
</ul>
<ol start="3">
<li>�жϴ���</li>
</ol>
<ul>
<li>�жϷ�������(ISR)</li>
<li>DPC����</li>
<li>�����жϴ���</li>
<li>�жϺϲ��Ż�</li>
</ul>
<ol start="4">
<li>��Դ����</li>
</ol>
<ul>
<li>��Դ״̬ת��</li>
<li>�͹���ģʽ����</li>
<li>���Ѵ���</li>
<li>��̬��Դ����</li>
</ul>
<ol start="5">
<li>�������ͻָ�</li>
</ol>
<ul>
<li>Ӳ��������</li>
<li>����ָ�����</li>
<li>��ʱ����</li>
<li>���Ի���</li>
</ul>
<p>��Щ��������͹ؼ��Ĺ���ģ�顣������߼����ԡ������Ż������ù����ȶ�������Щ���Ĺ��ܻ����ϵ���չ���ܡ�</p>
<p>Ҫʵ��һ���������õ�SD�����������������ص���Ҫʵ�ֺ��⼸�����Ĳ��֡�����I&#x2F;O�������жϴ�������ؼ��Ĳ��֣���Ϊ����ֱ��Ӱ�����������ܺ��ȶ��ԡ�</p>
<h2 id="User-60"><a href="#User-60" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>SD����������������INF�ļ���classnameӦ����ʲô����</p>
<h2 id="AI-claude-3-5-sonnet-60"><a href="#AI-claude-3-5-sonnet-60" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>����SD����������������INF�ļ��е�ClassӦ������Ϊ��</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">Class=SDHost</span><br><span class="line">ClassGuid=&#123;4D36E978-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line">Provider=%ManufacturerName%</span><br><span class="line">CatalogFile=YourDriver.cat</span><br><span class="line">DriverVer=</span><br><span class="line">PnpLockdown=1</span><br></pre></td></tr></table></figure>

<p>SDHost��ר��ΪSD�����������豸������豸�ࡣ������ר������:</p>
<ol>
<li>SD����������</li>
<li>SDIO����������</li>
<li>MMC����������</li>
</ol>
<p>ʹ����ȷ���豸������Ҫ����Ϊ��������:</p>
<ol>
<li>Windows��μ��غ͹����������</li>
<li>�������豸�������е���ʾλ��</li>
<li>ϵͳ�������豸��Ĭ�ϲ��Ժʹ�����ʽ</li>
</ol>
<p>ע�⣺ClassGuid�ǹ̶�ֵ�����GUID��WindowsϵͳԤ����ģ�ר�����ڱ�ʶSDHost���豸��</p>
<h2 id="User-61"><a href="#User-61" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>SD Host���̵�������ʹ��Class SDHost��</p>
<h2 id="AI-claude-3-5-sonnet-61"><a href="#AI-claude-3-5-sonnet-61" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>���ܡ�����SD Host���̵���������Intel��AMD��Realtek�ȵ�SD������������������Ӧ��ʹ�ã�</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">Class=System</span><br><span class="line">ClassGuid=&#123;4D36E97D-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line">Provider=%ManufacturerName%</span><br><span class="line">CatalogFile=YourDriver.cat</span><br><span class="line">DriverVer=</span><br><span class="line">PnpLockdown=1</span><br></pre></td></tr></table></figure>

<p>ԭ��</p>
<ol>
<li>SDHost����ΪMicrosoft��ͨ��SD��������������(sdhost.sys)������</li>
<li>���������̵�SD��������������Ӧ��ʹ��System��</li>
<li>��Щ����ͨ������Ϊϵͳ������У���Ҫ���ߵ�ϵͳȨ��</li>
</ol>
<p>����˵����</p>
<ul>
<li>����ǿ����Լ���SD��������������Ӧ��ʹ��SDHost��</li>
<li>����ǿ��������ϼ��ɵ�SD����������������Ӧ��ʹ��System��</li>
<li>Microsoft��ͨ��SD��������������(sdhost.sys)ʹ��SDHost��</li>
</ul>
<p>����Windows����ģ�͵�һ����ƹ淶����Ҫ�ϸ�������ȷ����������ȷ��װ�����С�</p>
<h2 id="User-62"><a href="#User-62" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>Realtek��SD Host�����ƺ�ʹ�õ���MTD�࣬��û������</p>
<h2 id="AI-claude-3-5-sonnet-62"><a href="#AI-claude-3-5-sonnet-62" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�ǵģ�Realtekʹ��MTD (Memory Technology Device) ��Ҳ����ȷ�ġ���֮ǰ�Ļش𲻹�ȫ�档</p>
<p>����SD Host����������ʵ�����м��ֳ�����Classѡ��</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">; ����1: MTD��</span><br><span class="line">Class=MTD</span><br><span class="line">ClassGuid=&#123;4D36E970-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line"></span><br><span class="line">; ����2: System��</span><br><span class="line">Class=System</span><br><span class="line">ClassGuid=&#123;4D36E97D-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line"></span><br><span class="line">; ����3: SDHost�ࣨ����Microsoftͨ��������</span><br><span class="line">Class=SDHost</span><br><span class="line">ClassGuid=&#123;4D36E978-E325-11CE-BFC1-08002BE10318&#125;</span><br></pre></td></tr></table></figure>

<p>ʹ��MTD������ƣ�</p>
<ol>
<li>MTD��ר�������ڴ漼���豸������������������洢����������</li>
<li>�������豸��ʵ�ʹ��ܶ�λ</li>
<li>��������Windows��MTD���豸�ĵ�Դ��������Դ��������</li>
</ol>
<p>����Realtekʹ��MTD���Ǻ�����ѡ����ȡ���ڣ�</p>
<ol>
<li>���̶��������ܵĶ�λ</li>
<li>��Windowsϵͳ�ļ�������</li>
<li>��ʷ�����Կ���</li>
</ol>
<p>��֮��System���MTD�඼�ǿɽ��ܵ�ѡ�񣬹ؼ���Ҫ���ϳ��̵ľ��������ʵ�ַ�ʽ��</p>
<h2 id="User-63"><a href="#User-63" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>Bayhub��SD Host�����ƺ�ʹ�õ���SCSIAdapter�࣬��û������</p>
<h2 id="AI-claude-3-5-sonnet-63"><a href="#AI-claude-3-5-sonnet-63" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�ǵģ�Bayhubʹ��SCSIAdapter��Ҳ�Ǻ�����ѡ�����Ҹ���һ��SD Host�����������õ�Class���ͣ�</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">; ����1: MTD�� - �������ڴ漼���豸</span><br><span class="line">Class=MTD</span><br><span class="line">ClassGuid=&#123;4D36E970-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line"></span><br><span class="line">; ����2: System�� - ������ϵͳ�豸</span><br><span class="line">Class=System</span><br><span class="line">ClassGuid=&#123;4D36E97D-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line"></span><br><span class="line">; ����3: SCSIAdapter�� - �����ڴ洢������</span><br><span class="line">Class=SCSIAdapter</span><br><span class="line">ClassGuid=&#123;4D36E97B-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line"></span><br><span class="line">; ����4: SDHost�� - ����Microsoftͨ������</span><br><span class="line">Class=SDHost</span><br><span class="line">ClassGuid=&#123;4D36E978-E325-11CE-BFC1-08002BE10318&#125;</span><br></pre></td></tr></table></figure>

<p>ʹ��SCSIAdapter������ƣ�</p>
<ol>
<li>��������Windows�洢��ջ�ı�׼����</li>
<li>���õ�֧���Ȳ�κʹ洢�豸ö��</li>
<li>�ܹ�����Windows�Դ洢�������ĵ�Դ��������</li>
<li>�������洢��������������һ�µĹ�����ʽ</li>
</ol>
<p>ѡ���ĸ�Class��Ҫȡ���ڣ�</p>
<ol>
<li>������ʵ�ּܹ����Ƿ�ʹ��storport.sys�ȣ�</li>
<li>��Windows�洢��ջ�ļ��ɷ�ʽ</li>
<li>�豸�ľ��幦�ܺ�ʹ�ó���</li>
<li>���̵ļ���·��ѡ��</li>
</ol>
<p>����Bayhubʹ��SCSIAdapter������ȫ�����ģ��ⷴӳ�����ǿ��ܲ����˻��ڴ洢�˿�������ʵ�ַ�ʽ��</p>
<h2 id="User-64"><a href="#User-64" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����SD Host���̣�����Intel�� AMD��ʹ��ʲô��</p>
<h2 id="AI-claude-3-5-sonnet-64"><a href="#AI-claude-3-5-sonnet-64" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>Intel��AMD��SD Host����ͨ��ʹ�ã�</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">Class=System</span><br><span class="line">ClassGuid=&#123;4D36E97D-E325-11CE-BFC1-08002BE10318&#125;</span><br></pre></td></tr></table></figure>

<p>ԭ��</p>
<ol>
<li>Intel��AMD��SD Host������ͨ���Ǽ�����оƬ���е�ϵͳ���</li>
<li>��Щ������������оƬ����������һ����</li>
<li>��Ϊϵͳ�ؼ��������Ҫ�ϸߵ�ϵͳȨ�޺͸����ܵ�ϵͳ����</li>
</ol>
<p>���尸����</p>
<ul>
<li><p>Intel��</p>
<ul>
<li>Intel PCH ϵ�� SD������</li>
<li>Intel 300&#x2F;400&#x2F;500ϵ��оƬ���SD������<br>��ʹ��System��</li>
</ul>
</li>
<li><p>AMD��</p>
<ul>
<li>AMD FCH ϵ�� SD������</li>
<li>AMD 500ϵ��оƬ���SD������<br>ͬ��ʹ��System��</li>
</ul>
</li>
</ul>
<p>�ⷴӳ�˲�ͬ���̻����似��·�ߺͲ�Ʒ��λ�Ĳ�ͬѡ��</p>
<ul>
<li>Intel&#x2F;AMD��System�ࣨϵͳ���������</li>
<li>Realtek��MTD�ࣨ�洢�豸������</li>
<li>Bayhub��SCSIAdapter�ࣨ�洢������������</li>
</ul>
<h2 id="User-65"><a href="#User-65" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>��win11 22621��װ inf��ʾ�� The folder you specified does’nt contain a compatible software driver for your device</p>
<h2 id="AI-claude-3-5-sonnet-65"><a href="#AI-claude-3-5-sonnet-65" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�����������м���ԭ���������޸�INF�ļ���</p>
<ol>
<li>���ȳ��Ը���System�ࣺ</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">Class=System</span><br><span class="line">ClassGuid=&#123;4D36E97D-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line">; �������ֲ���</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>���Ӹ���ϸ��Ӳ��IDƥ�䣺</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Standard.NTamd64]</span><br><span class="line">%O2Micro_SDHost.DeviceDesc%=O2Micro_SDHost_Device, PCI\VEN_1217&amp;DEV_8620          ; ����ƥ��</span><br><span class="line">%O2Micro_SDHost.DeviceDesc%=O2Micro_SDHost_Device, PCI\VEN_1217&amp;DEV_8620&amp;CC_0805  ; �������</span><br><span class="line">%O2Micro_SDHost.DeviceDesc%=O2Micro_SDHost_Device, PCI\VEN_1217&amp;DEV_8620&amp;REV_01   ; ���汾��</span><br><span class="line">%O2Micro_SDHost.DeviceDesc%=O2Micro_SDHost_Device, PCI\VEN_1217&amp;DEV_8620&amp;SUBSYS_*  ; ����ϵͳID</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>����WDF�汾�����µİ汾��</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[O2Micro_SDHost_wdfsect]</span><br><span class="line">KmdfLibraryVersion = 1.33  ; ���µ�Win11֧�ֵİ汾</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>���ӱ�Ҫ�İ�ȫ�ͼ�����������</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">Class=System</span><br><span class="line">ClassGuid=&#123;4D36E97D-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line">Provider=%ManufacturerName%</span><br><span class="line">CatalogFile=o2micro_sdhost.cat</span><br><span class="line">DriverVer=01/01/2024,1.0.0.0</span><br><span class="line">PnpLockdown=1</span><br><span class="line"></span><br><span class="line">; ������Щ����</span><br><span class="line">CompanyName=&quot;O2Micro International&quot;</span><br><span class="line">WindowsVersions=&quot;Windows 10,Windows 11&quot;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>���Գ���ʹ��SCSIAdapter�ࣺ</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">Class=SCSIAdapter</span><br><span class="line">ClassGuid=&#123;4D36E97B-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line">; �������ֲ���</span><br></pre></td></tr></table></figure>

<p>���鰴˳������Щ�޸ģ����ĸ��ܽ�����⡣ͬʱ��ȷ����</p>
<ol>
<li>�����Ѿ�ǩ��</li>
<li>cat�ļ���ȷ����</li>
<li>�豸���������ܿ�����ȷ��Ӳ��ID</li>
</ol>
<p>������ǲ��У����Բ鿴setupapi.dev.log��־�ļ����˽�����ʧ��ԭ��</p>
<p>���ۣ���������ԭ��ʵ����Ӳ��ID���󣬶�����Class������</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/07/30/BH201%20LinuxAndroid%20patch%E4%BB%A3%E7%A0%81%E5%90%88%E5%B9%B6%E6%89%8B%E5%86%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/07/30/BH201%20LinuxAndroid%20patch%E4%BB%A3%E7%A0%81%E5%90%88%E5%B9%B6%E6%89%8B%E5%86%8C/" class="post-title-link" itemprop="url">BH201 Linux/Android patch代码合并手册</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-07-30 15:50:54" itemprop="dateCreated datePublished" datetime="2024-07-30T15:50:54+08:00">2024-07-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:06:44" itemprop="dateModified" datetime="2025-11-04T17:06:44+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="BH201-Linux-Android-patch代码合并手册"><a href="#BH201-Linux-Android-patch代码合并手册" class="headerlink" title="BH201 Linux&#x2F;Android patch代码合并手册"></a>BH201 Linux&#x2F;Android patch代码合并手册</h1><h2 id="代码git管理"><a href="#代码git管理" class="headerlink" title="代码git管理"></a>代码git管理</h2><p>BH201 patch git代码的管理方式：</p>
<ol>
<li>master分支管理各种SOC vendor的BH201 patch，跟随客户新需求（Linux&#x2F;Android版本）持续更新</li>
<li>各客户的需求用独立分支管理，在该分支创建客户提供的原始代码，不断提交客户反馈的问题和issue fix，全部OK后合并此客户sd&#x2F;mmc host的代码到master。</li>
</ol>
<p>新客户需求转化成git代码管理：</p>
<p>1.创建新客户需求分支：</p>
<p>从master或者此soc分支创建新分支（命名：AE task ID - SOC - Kernel - Android），再删除.git以外的旧代码，粘贴客户提供的mmc&#x2F;host代码，作为初始分支代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 拉取仓库（bh201-android）</span><br><span class="line">git clone http://10.52.1.103/software/bh201-android.git</span><br><span class="line"></span><br><span class="line"># 从master或其他分支创建新分支</span><br><span class="line">git checkout -b AE#211-mtk8792-kernel6.1-android15</span><br><span class="line">git push origin AE#211-mtk8792-kernel6.1-android15</span><br><span class="line"></span><br><span class="line"># 初始化分支代码和文件</span><br><span class="line">删除bh201-android目录原有的所有代码（保留.git）</span><br><span class="line">复制客户给的mmc/host代码，以及FAE提供的requirement excel(包含SOC的SD host地址，CD#极性信息)</span><br><span class="line"></span><br><span class="line"># 推送新分支</span><br><span class="line">git add .</span><br><span class="line">git commit -m &quot;create based on customer source code. AE task#211 [Amazon/Huaqin/BH201][internal] Spinel MTK8792, BH201 patch&quot;</span><br><span class="line">git push --set-upstream origin AE#211-mtk8792-kernel6.1-android15</span><br><span class="line">git push</span><br><span class="line">git log</span><br></pre></td></tr></table></figure>

<p>2.合并此SOC的BH201 patch到此客户新分支</p>
<p>参考master的BH201 patch合并手册</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/07/30/BH202%20ARM%20windows%E7%9A%84Pofx-D3%20&%20Fast%20removalinsert%20issue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/07/30/BH202%20ARM%20windows%E7%9A%84Pofx-D3%20&%20Fast%20removalinsert%20issue/" class="post-title-link" itemprop="url">BH202 ARM windows的Pofx->D3 & Fast removal/insert issue</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-07-30 15:50:54" itemprop="dateCreated datePublished" datetime="2024-07-30T15:50:54+08:00">2024-07-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:07:11" itemprop="dateModified" datetime="2025-11-04T17:07:11+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="BH202-ARM-windows的Pofx-D3-Fast-removal-insert-issue"><a href="#BH202-ARM-windows的Pofx-D3-Fast-removal-insert-issue" class="headerlink" title="BH202 ARM windows的Pofx-&gt;D3 &amp; Fast removal&#x2F;insert issue."></a>BH202 ARM windows的Pofx-&gt;D3 &amp; Fast removal&#x2F;insert issue.</h1><h2 id="issue现象和driver分析"><a href="#issue现象和driver分析" class="headerlink" title="issue现象和driver分析"></a>issue现象和driver分析</h2><p>客户问题：</p>
<p>客户平台5&#x2F;100的平台有首次插卡不弹卡问题，复现测试发现快速插拔卡可以等效复现，有概率性插卡不识别问题，且不识别后再插拔卡也不识别。</p>
<p>WH lab分析：</p>
<p>1.BH202状态机可能有问题，卡侧和Host侧的通信方向不一致导致CMD8持续报错。</p>
<p>2.Workaround：通过Driver的error recovery flow的power cycle操作（power off + power on）去复位硬件状态。</p>
<p>Driver问题分析和优化点：</p>
<p>1.快速插拔卡后设备不能进D3（power off），原因是BH202 driver的pofx-&gt; D3\pofx-&gt; D0流程有问题，按driver issue fix architecture修改后问题解决。</p>
<p>3.BH202 driver的card change -&gt; pofx request流程需要优化，确保pofx-&gt;D state时序正确</p>
<p>4.BH202 driver的card change event触发条件需要优化，避免快速插拔卡事件过多的问题</p>
<h2 id="Driver-Issue-Fix-Architecture"><a href="#Driver-Issue-Fix-Architecture" class="headerlink" title="Driver Issue Fix Architecture"></a>Driver Issue Fix Architecture</h2><h3 id="Power-cycle-diagram"><a href="#Power-cycle-diagram" class="headerlink" title="Power cycle diagram"></a>Power cycle diagram</h3><p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202501141351408.png" alt="image-20250114135103318"></p>
<p>上图描述Issue fix的Driver Architecture，其中card handle和pofx handle属于BH202 miniport driver的模块，Storport AdapterControl属于miniport driver和Storport driver（and windows OS）的接口模块。</p>
<p>Note1：vdd1_power_cycle函数实现，内部调用pofx_request_d3和pofx_request_d0去实现power cycle（BH202 power off 再power on）。vdd1_power_cycle在以下情况被调用：</p>
<p>a.首次插卡，首次是指BH202没做过tuning</p>
<p>b.异常恢复流程，异常是卡初始化过程失败后的retry初始化</p>
<p>Note2：wait D3 response设置了超时时间5s，最大不能超过~8s，否则会触发SCSI BUS reset</p>
<p>Note3 and Note4：Storport返回的AdapterPowerControl D3只有一次，BH202 driver用作两个用途：</p>
<p>a.pofx handle认为系统响应了D3，即pofx-&gt;D3流程成功</p>
<p>b.card handle执行enter D3之前的准备流程，包括card stop transfer，card thread pending，card power off等函数，涉及到card一些标志的清理。</p>
<p>Note5: Storport driver收到D3请求的ACK（即请求返回）后，认为Adapter Idle；根据miniport注册的Adapter Pofx idle time 10ms，通知PMIC对BH202执行power off。</p>
<p>Note6：准备从D3返回D0，因为D3状态下没有任务或者中断插入执行，此处等待D0设置为2s</p>
<p>Note7：理论上应该是PMIC先上电后，Storport再通知miniport执行enter D0流程</p>
<p>Note8：进D0会发两次请求，首先是AdapterPowerControl - D0，BH202 driver由于实现了RestartAdapter，不需要在此请求做什么操作；之后是RestartAdapter，BH202 driver执行：</p>
<p>a.pofx handle认为pofx-&gt;D0流程成功</p>
<p>b.card handle执行enter D0的流程，包括host register reset，check card present，set card change event。</p>
<h3 id="pofx-D0-D3-diagram"><a href="#pofx-D0-D3-diagram" class="headerlink" title="pofx-&gt;D0&#x2F;D3 diagram"></a>pofx-&gt;D0&#x2F;D3 diagram</h3><p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202501141423340.png" alt="image-20250114142323274"> </p>
<h3 id="Card-Event-change优化"><a href="#Card-Event-change优化" class="headerlink" title="Card Event change优化"></a>Card Event change优化</h3><p>快速插拔卡时，有两个问题：</p>
<ol>
<li>Driver对各种事件的处理是FIFO形式，当某次插拔卡事件（card change event）的处理流程遇到错误耗时较长，插拔卡事件会越积越多，但插拔卡实际是无记忆行为，driver只要能正确处理最终状态就可以，最终状态包括卡在位和卡不在位两种情况。</li>
<li>有多种应用场景会设置card change event，driver需要减少不必要的event设置</li>
</ol>
<p>Card event过滤如下：设置最多两个event的event FIFO：</p>
<ol>
<li><p>如果当前没有card change事件待处理，或者只有一个card change事件正在处理，此时shared task count &#x3D; 0，可以排队新增一个card change event待处理，并设置shared task count &#x3D; 1；</p>
</li>
<li><p>如果shared task count &#x3D; 1，不允许继续发起card change事件</p>
</li>
<li><p>每个card change event事件处理完毕后会shared task count - 1，直到为0.</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202501141442768.png" alt="bh202-event"></p>
<h2 id="Bugfix状况"><a href="#Bugfix状况" class="headerlink" title="Bugfix状况"></a>Bugfix状况</h2><p>1.BH202 D0、D3问题：</p>
<p>原issue：快速插拔卡后拔卡，不能进D3，持续保持在D0。</p>
<p>现状：快速插拔卡后拔卡，能进D3（BH202能被power off），下次插卡能弹卡。</p>
<p>2.卡不识别问题：</p>
<p>原issue：快速插拔卡后，有时不识别卡，且不识别卡之后再插拔卡也不识别，除非Disable&#x2F;Enable驱动或者重启，会对用户造成困扰。</p>
<p>现状：快速插拔卡后，有时不识别卡，但再插拔一次可以识别；原因是快速插拔卡影响了驱动的卡识别正常流程，只需要再插拔一次就可以识别，不会对用户造成困扰。</p>
<p>结论：</p>
<p>当前版本可以release</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/07/30/BH202%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/07/30/BH202%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">BH202问题记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-07-30 15:50:54" itemprop="dateCreated datePublished" datetime="2024-07-30T15:50:54+08:00">2024-07-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:07:24" itemprop="dateModified" datetime="2025-11-04T17:07:24+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="BH202问题记录"><a href="#BH202问题记录" class="headerlink" title="BH202问题记录"></a>BH202问题记录</h1><h2 id="Balur项目-Qcom-Android-14-bazel编译系统"><a href="#Balur项目-Qcom-Android-14-bazel编译系统" class="headerlink" title="Balur项目 - Qcom Android 14 bazel编译系统"></a>Balur项目 - Qcom Android 14 bazel编译系统</h2><p>关于GKI和KMI的概念(需要clash梯子)：GKI划分common kernel和platform module，是platform能使用bazel的根本原因</p>
<p><a target="_blank" rel="noopener" href="https://source.android.com/docs/core/architecture/kernel/generic-kernel-image">https://source.android.com/docs/core/architecture/kernel/generic-kernel-image</a></p>
<p>bazel用于安卓14以上的platform kernel module编译：</p>
<p><a target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/build/+/refs/heads/main-kernel/kleaf/docs/impl.md#Step-2_Define-targets-to-build-external-kernel-modules">https://android.googlesource.com/kernel/build/+/refs/heads/main-kernel/kleaf/docs/impl.md#Step-2_Define-targets-to-build-external-kernel-modules</a></p>
<p>bazel语法（CN）</p>
<p><a target="_blank" rel="noopener" href="https://bazel.google.cn/versions/7.4.0/reference/be/c-cpp?hl=zh-cn">https://bazel.google.cn/versions/7.4.0/reference/be/c-cpp?hl=zh-cn</a></p>
<h3 id="编译问题和方案"><a href="#编译问题和方案" class="headerlink" title="编译问题和方案"></a>编译问题和方案</h3><p>Bazel编译sdhci-msm.c中的#include语句时，找不到bayhub.c和bayhub.c</p>
<p>尝试按bazel语法，直接在host下的module.bzl里面的sdhci-msm模块的srcs的deps添加bayhub.c&#x2F;.h，但并没有成功</p>
<p>临时办法：</p>
<p>platform kernel下的根编译文件BUILD.bazel里面定义了linux&#x2F;mmc&#x2F;*.h, 将bayhub.h放到这个路径再引用</p>
<p>不#include bayhub.c，直接将内容展开到sdhci-msm.c</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202509051417452.png" alt="image-20250905141723250"></p>
<h3 id="ADB的环境搭建和使用"><a href="#ADB的环境搭建和使用" class="headerlink" title="ADB的环境搭建和使用"></a>ADB的环境搭建和使用</h3><p>ADB用于抓取soc板子的kernel log打印。使用ADB可以登录开发板root文件目录操作rootfs</p>
<h4 id="Windows装ADB环境"><a href="#Windows装ADB环境" class="headerlink" title="Windows装ADB环境"></a>Windows装ADB环境</h4><ol>
<li><p>安装ADB exe包</p>
<p><a target="_blank" rel="noopener" href="https://www.thecustomdroid.com/google-android-usb-drivers/">https://www.thecustomdroid.com/google-android-usb-drivers/</a></p>
<p>下载platform-tools-latest，并且环境变量PATH添加adb.exe所在的目录，重启生效</p>
</li>
<li><p>安装USB-ADB驱动</p>
<p>没装USB驱动，连接soc板子（板子启动成功情况下），板子会被显示为yellow-bang设备，需要安装USB ADB驱动</p>
<p>驱动安装过程：</p>
<p>（1）右键yellow-bang的soc板子设备，选择更新驱动 -&gt; “通用串行总线”驱动类 -&gt; 找到WinUSB的ADB设备类驱动，不用管警告，安装。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202509051452516.png" alt="image-20250905145254487"></p>
<p>（2） 安装正常，soc设备会归为USB类，没有yellow bang</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202509051453172.png" alt="image-20250905145328150"></p>
</li>
</ol>
<h4 id="ADB抓kernel-log"><a href="#ADB抓kernel-log" class="headerlink" title="ADB抓kernel log"></a>ADB抓kernel log</h4><p>Win+R cmd进入命令行，用管理员启动</p>
<p>第一种方式：dmesg。输入如下命令开启mmc&#x2F;core的dev_dbg打印，dmesg输出到soc板子根目录&#x2F;sdcard的mmc.log，最后adb pull到windows PC查看log</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202509051455706.png" alt="图片2"></p>
<p>另一种方式：adb logcat，可以持续抓kprint的log，配合第一种打开dev_dbg打印后，可以同时抓pr_info和mmc的命令</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202509051456890.png" alt="图片3"></p>
<h3 id="调试SI参数"><a href="#调试SI参数" class="headerlink" title="调试SI参数"></a>调试SI参数</h3><p>两种方式：</p>
<p>1.直接改bayhub.h里面的GGC_CFG最后DWORD，包含drive strength值。需要编译整个系统，比较慢</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202509051503051.png" alt="image-20250905150355023"></p>
<p>2.使用debug sysfs接口，方便用户I&#x2F;O直接配置参数到驱动的对象，不需要编译系统。原理如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 读取当前值</span><br><span class="line">cat /sys/devices/platform/soc/8804000.sdhci/bh201_drive_strength</span><br><span class="line"># 写入新值(drive strength)</span><br><span class="line">echo 0x4A417777 &gt; /sys/devices/platform/soc/8804000.sdhci/bh201_drive_strength</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202509051503321.png" alt="image-20250905150308232"></p>
<h3 id="SD流程问题划分"><a href="#SD流程问题划分" class="headerlink" title="SD流程问题划分"></a>SD流程问题划分</h3><p>流程如下图，代码见core&#x2F;sd.c流程，以调用到.init_card()为划分：init_card前面属于平台Host测问题（调试需要看 host侧 VDD上电和CMD&#x2F;DATA&#x2F;CLK line信号）；.init_card()之后BH201驱动介入，根据ADB kprint和mmc log分析tuning等问题。</p>
<p>CMD0 -&gt; CMD8(check 2.0 card) -&gt; ACMD41 -&gt; CMD11(3.0 only) -&gt; CMD2 and 3 -&gt; .card_init (bht_load开始)</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202509051507611.png" alt="image-20250905150708572"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/07/30/BSOD%200xCA%20Analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/07/30/BSOD%200xCA%20Analysis/" class="post-title-link" itemprop="url">Windows BSOD 0xCA Analysis</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-07-30 15:50:54" itemprop="dateCreated datePublished" datetime="2024-07-30T15:50:54+08:00">2024-07-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:08:51" itemprop="dateModified" datetime="2025-11-04T17:08:51+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/windows%E9%A9%B1%E5%8A%A8/" itemprop="url" rel="index"><span itemprop="name">windows驱动</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Windows-BSOD-0xCA-Analysis"><a href="#Windows-BSOD-0xCA-Analysis" class="headerlink" title="Windows BSOD 0xCA Analysis."></a>Windows BSOD 0xCA Analysis.</h1><p>根据 Windbg Dump 分析，这个 BSOD 是由 IOMMU 操作失败导致的。具体来看：</p>
<p>错误发生在设备初始化阶段：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DevNode State = DeviceNodeResourcesAssigned (0x306)</span><br><span class="line">Previous State = DeviceNodeDriversAdded (0x305)</span><br></pre></td></tr></table></figure>

<p>关键问题点：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BUGCHECK_CODE: ca (PNP_DETECTED_FATAL_ERROR)</span><br><span class="line">Arg1: 13 (IOMMU operation failure)</span><br><span class="line">Arg2: 1000 (Unblock operation)</span><br></pre></td></tr></table></figure>

<p>解决 IOMMU 操作失败的问题。主要通过：</p>
<ol>
<li><p>正确初始化 DMA&#x2F;IOMMU 映射（当前代码已支持，不需修改）</p>
</li>
<li><p>确保状态转换时 DMA 操作安全完成 （当前代码待修改）</p>
</li>
</ol>
<p>代码改动：</p>
<p>设备进入D3&#x2F;D0以前Complete所有I&#x2F;O请求（SRB），使用Storport miniport要求的API RequestComplete ： We do not recommend that writers of Storport miniport drivers use this particular Storport interface routine. Instead, the miniport driver should call StorPortNotification( RequestComplete ) for each outstanding request.</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202411052017667.png" alt="image-20241105201725563"></p>
<p>附录1：BSOD 0xCA的相关文档</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/bug-check-0xca--pnp-detected-fatal-error?redirectedfrom=MSDN">https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/bug-check-0xca--pnp-detected-fatal-error?redirectedfrom=MSDN</a></p>
<p><a target="_blank" rel="noopener" href="https://www.sysnative.com/forums/threads/debugging-stop-0xca-dddriver-sys-dddriver64dcsa-sys.35039/">https://www.sysnative.com/forums/threads/debugging-stop-0xca-dddriver-sys-dddriver64dcsa-sys.35039/</a></p>
<p>附录2：BSOD 0xCA的Windbg分析log</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br></pre></td><td class="code"><pre><span class="line">!analyze -v</span><br><span class="line">*******************************************************************************</span><br><span class="line">*                                                                             *</span><br><span class="line">*                        Bugcheck Analysis                                    *</span><br><span class="line">*                                                                             *</span><br><span class="line">*******************************************************************************</span><br><span class="line"></span><br><span class="line">PNP_DETECTED_FATAL_ERROR (ca)</span><br><span class="line">PnP encountered a severe error, either as a result of a problem in a driver or</span><br><span class="line">a problem in PnP itself.  The first argument describes the nature of the</span><br><span class="line">problem, the second argument is the address of the PDO.  The other arguments</span><br><span class="line">vary depending on argument 1.</span><br><span class="line">Arguments:</span><br><span class="line">Arg1: 0000000000000013, IOMMU operation failure</span><br><span class="line">	A critical IOMMU operation has failed.</span><br><span class="line">Arg2: 0000000000001000, Unblock operation</span><br><span class="line">Arg3: ffffffffc0350066, NT status code.</span><br><span class="line">Arg4: ffffb986629afc40, DevNode of the device.</span><br><span class="line"></span><br><span class="line">Debugging Details:</span><br><span class="line">------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">KEY_VALUES_STRING: 1</span><br><span class="line"></span><br><span class="line">    Key  : Analysis.CPU.mSec</span><br><span class="line">    Value: 4546</span><br><span class="line"></span><br><span class="line">    Key  : Analysis.Elapsed.mSec</span><br><span class="line">    Value: 4604</span><br><span class="line"></span><br><span class="line">    Key  : Analysis.IO.Other.Mb</span><br><span class="line">    Value: 17</span><br><span class="line"></span><br><span class="line">    Key  : Analysis.IO.Read.Mb</span><br><span class="line">    Value: 2</span><br><span class="line"></span><br><span class="line">    Key  : Analysis.IO.Write.Mb</span><br><span class="line">    Value: 24</span><br><span class="line"></span><br><span class="line">    Key  : Analysis.Init.CPU.mSec</span><br><span class="line">    Value: 968</span><br><span class="line"></span><br><span class="line">    Key  : Analysis.Init.Elapsed.mSec</span><br><span class="line">    Value: 4411983</span><br><span class="line"></span><br><span class="line">    Key  : Analysis.Memory.CommitPeak.Mb</span><br><span class="line">    Value: 92</span><br><span class="line"></span><br><span class="line">    Key  : Analysis.Version.DbgEng</span><br><span class="line">    Value: 10.0.27725.1000</span><br><span class="line"></span><br><span class="line">    Key  : Analysis.Version.Description</span><br><span class="line">    Value: 10.2408.27.01 amd64fre</span><br><span class="line"></span><br><span class="line">    Key  : Analysis.Version.Ext</span><br><span class="line">    Value: 1.2408.27.1</span><br><span class="line"></span><br><span class="line">    Key  : Bugcheck.Code.KiBugCheckData</span><br><span class="line">    Value: 0xca</span><br><span class="line"></span><br><span class="line">    Key  : Bugcheck.Code.LegacyAPI</span><br><span class="line">    Value: 0xca</span><br><span class="line"></span><br><span class="line">    Key  : Bugcheck.Code.TargetModel</span><br><span class="line">    Value: 0xca</span><br><span class="line"></span><br><span class="line">    Key  : Dump.Attributes.AsUlong</span><br><span class="line">    Value: 21800</span><br><span class="line"></span><br><span class="line">    Key  : Dump.Attributes.DiagDataWrittenToHeader</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Dump.Attributes.ErrorCode</span><br><span class="line">    Value: 0</span><br><span class="line"></span><br><span class="line">    Key  : Dump.Attributes.LastLine</span><br><span class="line">    Value: Dump completed successfully.</span><br><span class="line"></span><br><span class="line">    Key  : Dump.Attributes.ProgressPercentage</span><br><span class="line">    Value: 100</span><br><span class="line"></span><br><span class="line">    Key  : Failure.Bucket</span><br><span class="line">    Value: 0xCA_13_nt!PiDmaGuardProcessPreStart</span><br><span class="line"></span><br><span class="line">    Key  : Failure.Hash</span><br><span class="line">    Value: &#123;b367b2d8-0cc5-f3e0-e733-3787841dcdd2&#125;</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Enlightenments.ValueHex</span><br><span class="line">    Value: 7497cf94</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.AnyHypervisorPresent</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.ApicEnlightened</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.ApicVirtualizationAvailable</span><br><span class="line">    Value: 0</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.AsyncMemoryHint</span><br><span class="line">    Value: 0</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.CoreSchedulerRequested</span><br><span class="line">    Value: 0</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.CpuManager</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.DeprecateAutoEoi</span><br><span class="line">    Value: 0</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.DynamicCpuDisabled</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.Epf</span><br><span class="line">    Value: 0</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.ExtendedProcessorMasks</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.HardwareMbecAvailable</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.MaxBankNumber</span><br><span class="line">    Value: 0</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.MemoryZeroingControl</span><br><span class="line">    Value: 0</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.NoExtendedRangeFlush</span><br><span class="line">    Value: 0</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.NoNonArchCoreSharing</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.Phase0InitDone</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.PowerSchedulerQos</span><br><span class="line">    Value: 0</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.RootScheduler</span><br><span class="line">    Value: 0</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.SynicAvailable</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.UseQpcBias</span><br><span class="line">    Value: 0</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.Value</span><br><span class="line">    Value: 38408431</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.ValueHex</span><br><span class="line">    Value: 24a10ef</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.VpAssistPage</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.Flags.VsmAvailable</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.RootFlags.AccessStats</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.RootFlags.CrashdumpEnlightened</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.RootFlags.CreateVirtualProcessor</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.RootFlags.DisableHyperthreading</span><br><span class="line">    Value: 0</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.RootFlags.HostTimelineSync</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.RootFlags.HypervisorDebuggingEnabled</span><br><span class="line">    Value: 0</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.RootFlags.IsHyperV</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.RootFlags.LivedumpEnlightened</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.RootFlags.MapDeviceInterrupt</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.RootFlags.MceEnlightened</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.RootFlags.Nested</span><br><span class="line">    Value: 0</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.RootFlags.StartLogicalProcessor</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.RootFlags.Value</span><br><span class="line">    Value: 1015</span><br><span class="line"></span><br><span class="line">    Key  : Hypervisor.RootFlags.ValueHex</span><br><span class="line">    Value: 3f7</span><br><span class="line"></span><br><span class="line">    Key  : SecureKernel.HalpHvciEnabled</span><br><span class="line">    Value: 1</span><br><span class="line"></span><br><span class="line">    Key  : WER.OS.Branch</span><br><span class="line">    Value: ge_release</span><br><span class="line"></span><br><span class="line">    Key  : WER.OS.Version</span><br><span class="line">    Value: 10.0.26100.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BUGCHECK_CODE:  ca</span><br><span class="line"></span><br><span class="line">BUGCHECK_P1: 13</span><br><span class="line"></span><br><span class="line">BUGCHECK_P2: 1000</span><br><span class="line"></span><br><span class="line">BUGCHECK_P3: ffffffffc0350066</span><br><span class="line"></span><br><span class="line">BUGCHECK_P4: ffffb986629afc40</span><br><span class="line"></span><br><span class="line">FILE_IN_CAB:  MEMORY.DMP</span><br><span class="line"></span><br><span class="line">TAG_NOT_DEFINED_202b:  *** Unknown TAG in analysis list 202b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DUMP_FILE_ATTRIBUTES: 0x21800</span><br><span class="line"></span><br><span class="line">FAULTING_THREAD:  ffffb986625ef040</span><br><span class="line"></span><br><span class="line">DEVICE_OBJECT: 0000000000001000</span><br><span class="line"></span><br><span class="line">BLACKBOXBSD: 1 (!blackboxbsd)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BLACKBOXNTFS: 1 (!blackboxntfs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BLACKBOXPNP: 1 (!blackboxpnp)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BLACKBOXWINLOGON: 1</span><br><span class="line"></span><br><span class="line">PROCESS_NAME:  System</span><br><span class="line"></span><br><span class="line">LOCK_ADDRESS:  fffff8019cd8a380 -- (!locks fffff8019cd8a380)</span><br><span class="line">KD: Scanning for held locks........................................................</span><br><span class="line"></span><br><span class="line">Resource @ nt!PiEngineLock (0xfffff8019cd8a380)    Exclusively owned</span><br><span class="line">    Contention Count = 23</span><br><span class="line">     Threads: ffffb986625ef040-01&lt;*&gt; </span><br><span class="line">1 total locks</span><br><span class="line"></span><br><span class="line">PNP_TRIAGE_DATA: </span><br><span class="line">	Lock address  : 0xfffff8019cd8a380</span><br><span class="line">	Thread Count  : 1</span><br><span class="line">	Thread address: 0xffffb986625ef040</span><br><span class="line">	Thread wait   : 0x281e98</span><br><span class="line"></span><br><span class="line">STACK_TEXT:  </span><br><span class="line">ffffdf84`8a6b7158 fffff801`9c8e5bca     : 00000000`000000ca 00000000`00000013 00000000`00001000 ffffffff`c0350066 : nt!KeBugCheckEx</span><br><span class="line">ffffdf84`8a6b7160 fffff801`9c7db310     : ffffb986`629afc40 00000000`00000000 00000000`00000001 ffffb986`629afc40 : nt!PiDmaGuardProcessPreStart+0x10a7f6</span><br><span class="line">ffffdf84`8a6b71a0 fffff801`9c697621     : ffffb986`629afc40 ffffdf84`8a6b7261 00000000`00000000 00000000`00000001 : nt!PipProcessStartPhase1+0x4c</span><br><span class="line">ffffdf84`8a6b71e0 fffff801`9c8187a7     : ffffb986`36694b20 ffffb986`626da790 ffffdf84`8a6b7300 fffff801`00000002 : nt!PipProcessDevNodeTree+0x645</span><br><span class="line">ffffdf84`8a6b72b0 fffff801`9c2404bd     : 00000001`00000003 ffffb986`36694b20 ffffb986`626da790 00000000`00000000 : nt!PiProcessReenumeration+0x9f</span><br><span class="line">ffffdf84`8a6b7300 fffff801`9c1249d2     : ffffb986`625ef040 ffffb986`366b6cb0 fffff801`9c23fe80 ffffb986`00000000 : nt!PnpDeviceActionWorker+0x63d</span><br><span class="line">ffffdf84`8a6b73c0 fffff801`9c25a9ea     : ffffb986`625ef040 ffffb986`625ef040 fffff801`9c124820 ffffb986`366b6cb0 : nt!ExpWorkerThread+0x1b2</span><br><span class="line">ffffdf84`8a6b7570 fffff801`9c4736f4     : ffffce81`b4759180 ffffb986`625ef040 fffff801`9c25a990 00320033`006d0065 : nt!PspSystemThreadStartup+0x5a</span><br><span class="line">ffffdf84`8a6b75c0 00000000`00000000     : ffffdf84`8a6b8000 ffffdf84`8a6b1000 00000000`00000000 00000000`00000000 : nt!KiStartSystemThread+0x34</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SYMBOL_NAME:  nt!PiDmaGuardProcessPreStart+10a7f6</span><br><span class="line"></span><br><span class="line">MODULE_NAME: nt</span><br><span class="line"></span><br><span class="line">IMAGE_NAME:  ntkrnlmp.exe</span><br><span class="line"></span><br><span class="line">STACK_COMMAND:  .process /r /p 0xffffb98636697040; .thread 0xffffb986625ef040 ; kb</span><br><span class="line"></span><br><span class="line">BUCKET_ID_FUNC_OFFSET:  10a7f6</span><br><span class="line"></span><br><span class="line">FAILURE_BUCKET_ID:  0xCA_13_nt!PiDmaGuardProcessPreStart</span><br><span class="line"></span><br><span class="line">OS_VERSION:  10.0.26100.1</span><br><span class="line"></span><br><span class="line">BUILDLAB_STR:  ge_release</span><br><span class="line"></span><br><span class="line">OSPLATFORM_TYPE:  x64</span><br><span class="line"></span><br><span class="line">OSNAME:  Windows 10</span><br><span class="line"></span><br><span class="line">FAILURE_ID_HASH:  &#123;b367b2d8-0cc5-f3e0-e733-3787841dcdd2&#125;</span><br><span class="line"></span><br><span class="line">Followup:     MachineOwner</span><br><span class="line">---------</span><br><span class="line"></span><br><span class="line">1: kd&gt; !devnode ffffb986629afc40</span><br><span class="line">DevNode 0xffffb986629afc40 for PDO 0xffffb98665085060</span><br><span class="line">  Parent 0xffffb986629adc40   Sibling 0000000000   Child 0000000000   </span><br><span class="line">  InstancePath is &quot;PCI\VEN_1217&amp;DEV_8621&amp;SUBSYS_00021217&amp;REV_01\4&amp;32cd076f&amp;0&amp;0013&quot;</span><br><span class="line">  ServiceName is &quot;bhtsddr&quot;</span><br><span class="line">  State = DeviceNodeResourcesAssigned (0x306) @ 2024 Oct 24 21:26:21.411</span><br><span class="line">  Previous State = DeviceNodeDriversAdded (0x305) @ 2024 Oct 24 21:26:21.411</span><br><span class="line">  StateHistory[02] = DeviceNodeDriversAdded (0x305)</span><br><span class="line">  StateHistory[01] = DeviceNodeInitialized (0x304)</span><br><span class="line">  StateHistory[00] = DeviceNodeUninitialized (0x301)</span><br><span class="line">  StateHistory[19] = Unknown State (0x0)</span><br><span class="line">  StateHistory[18] = Unknown State (0x0)</span><br><span class="line">  StateHistory[17] = Unknown State (0x0)</span><br><span class="line">  StateHistory[16] = Unknown State (0x0)</span><br><span class="line">  StateHistory[15] = Unknown State (0x0)</span><br><span class="line">  StateHistory[14] = Unknown State (0x0)</span><br><span class="line">  StateHistory[13] = Unknown State (0x0)</span><br><span class="line">  StateHistory[12] = Unknown State (0x0)</span><br><span class="line">  StateHistory[11] = Unknown State (0x0)</span><br><span class="line">  StateHistory[10] = Unknown State (0x0)</span><br><span class="line">  StateHistory[09] = Unknown State (0x0)</span><br><span class="line">  StateHistory[08] = Unknown State (0x0)</span><br><span class="line">  StateHistory[07] = Unknown State (0x0)</span><br><span class="line">  StateHistory[06] = Unknown State (0x0)</span><br><span class="line">  StateHistory[05] = Unknown State (0x0)</span><br><span class="line">  StateHistory[04] = Unknown State (0x0)</span><br><span class="line">  StateHistory[03] = Unknown State (0x0)</span><br><span class="line">  Flags (0x6c0000f0)  DNF_ENUMERATED, DNF_IDS_QUERIED, </span><br><span class="line">                      DNF_HAS_BOOT_CONFIG, DNF_BOOT_CONFIG_RESERVED, </span><br><span class="line">                      DNF_NO_LOWER_DEVICE_FILTERS, DNF_NO_LOWER_CLASS_FILTERS, </span><br><span class="line">                      DNF_NO_UPPER_DEVICE_FILTERS, DNF_NO_UPPER_CLASS_FILTERS</span><br><span class="line">  CapabilityFlags (0x00002000)  WakeFromD3</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/05/18/%E9%A3%9E%E8%85%BE%E6%B4%BELinux%20SD%E9%A9%B1%E5%8A%A8%E5%88%86%E6%9E%90%E5%92%8C%E8%B0%83%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/05/18/%E9%A3%9E%E8%85%BE%E6%B4%BELinux%20SD%E9%A9%B1%E5%8A%A8%E5%88%86%E6%9E%90%E5%92%8C%E8%B0%83%E8%AF%95/" class="post-title-link" itemprop="url">飞腾派Linux SD驱动分析和调试</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-05-18 15:50:54" itemprop="dateCreated datePublished" datetime="2024-05-18T15:50:54+08:00">2024-05-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:35:50" itemprop="dateModified" datetime="2025-11-04T17:35:50+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="飞腾派Linux-SD驱动分析和调试"><a href="#飞腾派Linux-SD驱动分析和调试" class="headerlink" title="飞腾派Linux SD驱动分析和调试"></a>飞腾派Linux SD驱动分析和调试</h1><h2 id="SD初始化流程分析"><a href="#SD初始化流程分析" class="headerlink" title="SD初始化流程分析"></a>SD初始化流程分析</h2><h3 id="SD初始化的起始点"><a href="#SD初始化的起始点" class="headerlink" title="SD初始化的起始点"></a>SD初始化的起始点</h3><p>带SD卡启动系统时，初始化SD host和card的调用链：</p>
<p>probe -&gt; mmc_alloc_host -&gt; mmc_start_host -&gt; _mmc_detect_change -&gt; mmc_schedule_delayed_work(&amp;host-&gt;detect) -&gt; mmc_rescan（注释1）-&gt; mmc_rescan_try_freq（注释2）</p>
<p>注释1：mmc_alloc_host时用INIT_DELAYED_WORK绑定delayed_work detect和mmc_rescan回调函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INIT_DELAYED_WORK(&amp;host-&gt;detect, mmc_rescan);</span><br></pre></td></tr></table></figure>

<p>注释2：这里可能执行多次，从SD接口最低频率开始初始化，一般是400KHz，代码如下。 注意host-&gt;f_min是host driver设置。	</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">static const unsigned freqs[] = &#123; 400000, 300000, 200000, 100000 &#125;;</span><br><span class="line"></span><br><span class="line">for (i = 0; i &lt; ARRAY_SIZE(freqs); i++) &#123;</span><br><span class="line">    if (!mmc_rescan_try_freq(host, max(freqs[i], host-&gt;f_min)))</span><br><span class="line">        break;</span><br><span class="line">    if (freqs[i] &lt;= host-&gt;f_min)</span><br><span class="line">        break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SD初始化的过程"><a href="#SD初始化的过程" class="headerlink" title="SD初始化的过程"></a>SD初始化的过程</h3><p>以下具体分析mmc_rescan_try_freq流程，并用飞腾SD卡的初始化log对照理解。</p>
<h4 id="第一阶段：mmc通用初始化："><a href="#第一阶段：mmc通用初始化：" class="headerlink" title="第一阶段：mmc通用初始化："></a>第一阶段：mmc通用初始化：</h4><p>此时的host还没有指定卡是SD还是eMMC还是SDIO，这个阶段主要做卡power up和host reset，然后对卡reset（go_idle + send_if_cond）</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202404191529248.png" alt="image-20240419152855006"></p>
<p>对应log如下，以下CMD8 fail属于正常，因为此时还没指定是SD type</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202404191555610.png" alt="image-20240419155547556"></p>
<h4 id="第二阶段：SD卡的初始化入口："><a href="#第二阶段：SD卡的初始化入口：" class="headerlink" title="第二阶段：SD卡的初始化入口："></a>第二阶段：SD卡的初始化入口：</h4><p>SD模式的初始化入口：</p>
<p>根据host的能力(caps)，依次尝试初始化SDIO, then SD, then MMC，如果host能力指定了不支持SDIO或SD或MMC，将进入host支持的初始化入口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/* Order&#x27;s important: probe SDIO, then SD, then MMC */</span><br><span class="line">if (!(host-&gt;caps2 &amp; MMC_CAP2_NO_SDIO))</span><br><span class="line">    if (!mmc_attach_sdio(host))</span><br><span class="line">        return 0;</span><br><span class="line"></span><br><span class="line">if (!(host-&gt;caps2 &amp; MMC_CAP2_NO_SD))</span><br><span class="line">    if (!mmc_attach_sd(host))</span><br><span class="line">        return 0;</span><br><span class="line"></span><br><span class="line">if (!(host-&gt;caps2 &amp; MMC_CAP2_NO_MMC))</span><br><span class="line">    if (!mmc_attach_mmc(host))</span><br><span class="line">        return 0;</span><br></pre></td></tr></table></figure>

<p>怎么配置host能力：</p>
<p>host能力是指该SD&#x2F;MMC&#x2F;SDIO接口具体用作哪种类型，这个和平台外设的设计相关。例如飞腾Pi平台的SOC有两个SD&#x2F;MMC&#x2F;SDIO控制器接口：</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202404191611726.png" alt="Image 14"></p>
<p>对于SD0控制器, 只作为SD&#x2F;eMMC接口使用，因此host driver对SD0可以设置host-cap能力如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host-&gt;caps2 |= MMC_CAP2_NO_SDIO | MMC_CAP2_NO_MMC;</span><br></pre></td></tr></table></figure>

<p>这样在mmc_rescan_try_freq就可以跳过mmc_attach_sdio和mmc_attach_mmc， 只执行mmc_attach_sd去启动SD初始化流程。</p>
<h4 id="SD卡初始化的基本概念"><a href="#SD卡初始化的基本概念" class="headerlink" title="SD卡初始化的基本概念"></a>SD卡初始化的基本概念</h4><h5 id="SD卡初始化的流程总览"><a href="#SD卡初始化的流程总览" class="headerlink" title="SD卡初始化的流程总览"></a>SD卡初始化的流程总览</h5><p>SD spec的UHS-I流程总览：几个关键节点1～9。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202404191701745.png" alt="image-20240419170130663"></p>
<p>以上UHS-I流程兼容SD3.0的SDR50, SDR25, SDR12等UHS模式，以及SD2.0的HS模式, DS模式：</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202404191627573.png" alt="image-20240419162710488"></p>
<h5 id="SD卡初始化的接口概念"><a href="#SD卡初始化的接口概念" class="headerlink" title="SD卡初始化的接口概念"></a>SD卡初始化的接口概念</h5><p>如下图SD host和card接口，卡初始化过程最核心的工作就是协商host侧和card侧的能力，最终以双方都能支持的最高速度通信，即完成卡初始化。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202404192014746.png" alt="image-20240419201436682"></p>
<p>所谓高速通信，无外乎以下几点：</p>
<p>更高的比特率：可以提高时钟频率和增加带宽。其中时钟CLK是host和card能力决定上限，host通过配置分频去控制接口频率（ios clock）；带宽是指SD接口有DATA[3:0] 4根数据线，但默认1bit模式只用了1根，切换到4bit模式后用4根线可同时传输4个bit。 </p>
<p>更低的信号电平：由于逻辑电平是梯形有建立时间，更低的电平信号能减少建立时间，达到更快的波特率；所以UHS模式一定要1.8V通信电平。</p>
<h4 id="第四阶段：SD卡初始化"><a href="#第四阶段：SD卡初始化" class="headerlink" title="第四阶段：SD卡初始化"></a>第四阶段：SD卡初始化</h4><p>在正式卡初始化之前， 有一个状态清理和协商工作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mmc_attach_sd： </span><br><span class="line"></span><br><span class="line">mmc_send_app_op_cond （这里是为了确认卡left busy state，有时候刚reset需要等状态恢复到IDLE）</span><br><span class="line"></span><br><span class="line">host-&gt;ocr_avail = host-&gt;ocr_avail_sd; （这里拿到host支持的sd ocr电压值，例如3.3V）</span><br><span class="line"></span><br><span class="line">mmc_select_voltage （这里查询卡支持的ocr电压值，以协商一致电压，一般而言这里是3.3V）</span><br></pre></td></tr></table></figure>

<h5 id="SD卡初始化（上半部分）：-卡能力查询"><a href="#SD卡初始化（上半部分）：-卡能力查询" class="headerlink" title="**SD卡初始化（上半部分）：**卡能力查询"></a>**SD卡初始化（上半部分）：**卡能力查询</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mmc_sd_init_card：</span><br><span class="line"></span><br><span class="line">	mmc_sd_get_cid：</span><br><span class="line"></span><br><span class="line">		mmc_go_idle (节点1，CMD0使卡进入IDLE state)</span><br><span class="line"></span><br><span class="line">		mmc_send_if_cond（节点2，CMD8使卡配置OCR电压）</span><br><span class="line"></span><br><span class="line">		mmc_send_app_op_cond（节点3，CMD41查询卡容量，是否支持1.8V信号电）</span><br><span class="line"></span><br><span class="line">		mmc_set_uhs_voltage（节点4，CMD11切换卡到1.8V信号电）</span><br><span class="line"></span><br><span class="line">			mmc_host_set_uhs_voltage （调用host-&gt;ops-&gt;start_signal_voltage_switch切host侧到1.8V信号电，使两端通信电平一致）	</span><br><span class="line">		</span><br><span class="line">		mmc_send_cid（节点5，CMD2获取卡CID）</span><br></pre></td></tr></table></figure>

<h6 id="关键节点描述："><a href="#关键节点描述：" class="headerlink" title="关键节点描述："></a>关键节点描述：</h6><p>节点2：CMD8应该设置arg[19:8] &#x3D; 1aa,  1 来自前面host ocr &#x3D; 2.7-3.6V support.</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202404191656210.png" alt="image-20240419165618097"></p>
<p>有时候CMD41没设置arg bit24&#x3D;1, 可能是host cap没有正确配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">phytium_mci_common_probe：</span><br><span class="line">mmc-&gt;ocr_avail_sd = MMC_VDD_32_33 | MMC_VDD_33_34;</span><br></pre></td></tr></table></figure>

<p>节点3：CMD41应该设置arg bit24  &#x3D; 1去查询卡是否支持S18R，去切换信号电到1.8V， 这个切换能力决定是否启动后面的UHS模式的初始化。这个CMD41有一定retry次数。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202404191706848.png" alt="image-20240419170626765"></p>
<p>有时候CMD41没设置arg bit24&#x3D;1, 可能是host cap没有使能UHS模式和4bit bus width</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mmc_sd_get_cid：</span><br><span class="line">/*</span><br><span class="line"> * If the host supports one of UHS-I modes, request the card</span><br><span class="line"> * to switch to 1.8V signaling level. If the card has failed</span><br><span class="line"> * repeatedly to switch however, skip this.</span><br><span class="line"> */</span><br><span class="line">if (retries &amp;&amp; mmc_host_uhs(host))&#123;</span><br><span class="line">    ocr |= SD_OCR_S18R;</span><br><span class="line">    pr_info(&quot;%s: %s: set SD_OCR_S18R \n&quot;, mmc_hostname(host), __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mmc_host_uhs：</span><br><span class="line">static inline int mmc_host_uhs(struct mmc_host *host)</span><br><span class="line">&#123;</span><br><span class="line">	pr_info(&quot;%s: %s: host-&gt;caps = 0x%X \n&quot;, mmc_hostname(host), __func__, host-&gt;caps);</span><br><span class="line">	return host-&gt;caps &amp;</span><br><span class="line">		(MMC_CAP_UHS_SDR12 | MMC_CAP_UHS_SDR25 |</span><br><span class="line">		 MMC_CAP_UHS_SDR50 | MMC_CAP_UHS_SDR104 |</span><br><span class="line">		 MMC_CAP_UHS_DDR50) &amp;&amp;</span><br><span class="line">	       host-&gt;caps &amp; MMC_CAP_4_BIT_DATA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="host设置caps的两种方式：probe赋值，使用DTS"><a href="#host设置caps的两种方式：probe赋值，使用DTS" class="headerlink" title="host设置caps的两种方式：probe赋值，使用DTS"></a><strong>host设置caps的两种方式：probe赋值，使用DTS</strong></h6><p>一种方式是在host probe中对某个已知地址空间的mmc device直接设置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">phytium_mci_probe：</span><br><span class="line"></span><br><span class="line">host-&gt;sd0 = (0 == strcmp(dev_name(dev), &quot;28000000.mmc&quot;));</span><br><span class="line">if(host-&gt;sd0)&#123;</span><br><span class="line">	host-&gt;caps |= MMC_CAP_UHS_SDR12 | MMC_CAP_UHS_SDR25 | MMC_CAP_UHS_SDR50 | MMC_CAP_4_BIT_DATA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外的方式是设备树中添加property描述，通过mmc_of_parse解析能力，参考：<a target="_blank" rel="noopener" href="https://gitee.com/phytium_embedded/phytium-linux-kernel/issues/I9H1ZS?from=project-issue">https://gitee.com/phytium_embedded/phytium-linux-kernel/issues/I9H1ZS?from=project-issue</a></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202404221108662.png" alt="image-20240422110810589"></p>
<p>DTS位于arch&#x2F;arm&#x2F;boot&#x2F;dts, 用于描述某个开发板的设备信息；DTS是.dts或.dtsi后缀，dtsi是共性的dts配置，相当于头文件可被dts include。</p>
<p>搜索sd-uhs-sdrxx相关的dts，一个示例如下（rk3288-veyron-sdmmc.dtsi）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&amp;sdmmc &#123;					//该SD/MMC/SDIO控制器是用于SD/MMC模式，不是SDIO模式</span><br><span class="line">	status = &quot;okay&quot;;		//用于enable或者disable此dts项，一般probe调用of_device_is_available检测此status.</span><br><span class="line">	bus-width = &lt;4&gt;;		//SD支持4bit线宽</span><br><span class="line">	cap-mmc-highspeed;		//支持eMMC HS</span><br><span class="line">	cap-sd-highspeed;		//支持SD HS（SD2.0）</span><br><span class="line">	card-detect-delay = &lt;200&gt;;</span><br><span class="line">	cd-gpios = &lt;&amp;gpio7 RK_PA5 GPIO_ACTIVE_LOW&gt;;		//卡检测（CD#）用的是GPIO7，低有效</span><br><span class="line">	rockchip,default-sample-phase = &lt;90&gt;;</span><br><span class="line">	sd-uhs-sdr12;			//支持UHS SDR12速率（SD3.0），时钟频率不超过24M</span><br><span class="line">	sd-uhs-sdr25;			//支持UHS SDR25速率（SD3.0），时钟频率不超过50M</span><br><span class="line">	sd-uhs-sdr50;			//支持UHS SDR50速率（SD3.0），时钟频率不超过100M</span><br><span class="line">	sd-uhs-sdr104;			//支持UHS SDR104速率（SD3.0），时钟频率不超过208M</span><br><span class="line">	vmmc-supply = &lt;&amp;vcc33_sd&gt;;	//卡供电VCC = 3.3V</span><br><span class="line">	vqmmc-supply = &lt;&amp;vccio_sd&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h5 id="SD卡初始化（下半部分-part1）：UHS高速模式（SD3-0）配置"><a href="#SD卡初始化（下半部分-part1）：UHS高速模式（SD3-0）配置" class="headerlink" title="SD卡初始化（下半部分-part1）：UHS高速模式（SD3.0）配置"></a><strong>SD卡初始化（下半部分-part1）：UHS高速模式（SD3.0）配置</strong></h5><p>在UHS下半部分初始化之前：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host-&gt;ops-&gt;init_card：如果host有什么自定义寄存器配置，在此完成</span><br></pre></td></tr></table></figure>

<p>开始UHS下半部分：</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202404191701745.png" alt="image-20240419170130663"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mmc_sd_init_card：</span><br><span class="line"></span><br><span class="line">	mmc_set_relative_addr (节点6，CMD3获取卡地址：bus-device相对地址)</span><br><span class="line">	mmc_select_card (节点7，CMD7选中bus上的某card)</span><br><span class="line">                    （节点8，CMD42 unlock card，只有在CMD7的response显示card处于lock状态才发，此处一般不会lock，不发CMD42）</span><br><span class="line">                    </span><br><span class="line">	mmc_sd_setup_card：针对该card进行UHS初始化</span><br><span class="line">		step1：一些信息准备工作</span><br><span class="line">    	mmc_app_send_scr &amp; mmc_decode_scr（ACMD51,读卡的SCR register，见注释1）</span><br><span class="line">    	mmc_read_ssr（ACMD13,读卡的status register SSR，见注释2）</span><br><span class="line">		mmc_read_switch（ACMD6读卡能支持的driver strength和bus_width，下一步切换要用）</span><br><span class="line">	mmc_sd_init_uhs_card：切换到UHS模式的初始化（见注释3：需要host和card前面的协商结果是支持1.8V电平 &amp;&amp; UHS模式支持 &amp;&amp; bus width 4bit支持）</span><br><span class="line">		step2：执行切换：</span><br><span class="line">		一个ACMD6：</span><br><span class="line">            mmc_app_set_bus_width（节点9，ACMD6执行bus width切换4bit）</span><br><span class="line">            mmc_set_bus_width（host-ops也执行bus width切换到4bit）</span><br><span class="line">		几个CMD6如下（见注释4）</span><br><span class="line">            sd_select_driver_type（CMD6,设置卡侧driver strength并调用host ops也设置host侧register）</span><br><span class="line">            sd_set_current_limit（CMD6, 根据vdd设置最大电流）</span><br><span class="line">            sd_set_bus_speed_mode（CMD6，卡切换bus-speed到UHS中的SDRXX模式，并mmc_set_ios也设置host侧bus-speed）</span><br><span class="line">		step3：切完后调频：tuning</span><br><span class="line">			mmc_execute_tuning（节点10,CMD19，注释5）</span><br><span class="line"></span><br><span class="line">mmc_sd_init_card end.</span><br></pre></td></tr></table></figure>

<p>注释1：SCR register包含卡支持SD3.0以上版本与否，支持3.0以上则卡bus_width支持4BIT</p>
<p>注释2：SSR register包含卡的bus width，secured mode，card type等卡功能的配置</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202404191807768.png" alt="image-20240419180712652"></p>
<p>注释3：切换到UHS模式的条件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/* Initialization sequence for UHS-I cards */</span><br><span class="line">if (rocr &amp; SD_ROCR_S18A &amp;&amp; mmc_host_uhs(host)) &#123;</span><br><span class="line">		err = mmc_sd_init_uhs_card(card);</span><br></pre></td></tr></table></figure>

<p>注释4：CMD6配合Function Function Group配置不同功能，注意和ACMD6区分.</p>
<p><img src="/home/cursorhu/.config/Typora/typora-user-images/image-20240419194003739.png" alt="image-20240419194003739"></p>
<p>注释5：tuning是高速模式下利用特定模式的数据（tuning block pattern）去模拟测试数据读写的CRC错误率，来反馈微调SD host和card接口的时钟频率，数据采样相位等，以适配不同PCB环境对高速信号干扰；如下图。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202404192040132.png" alt="image-20240419204049080"></p>
<p>注意：UHS较低速的SDR12～SDR25 &lt; SDR50 &lt; 100MHz的，不需要tuning, SDR50可以tuning也可以不tuning。</p>
<p>注意：tuning需要SD host硬件支持，有的host时钟分频能支持UHS SDR104但不支持tuning，如下图的SDR fixed-delay， 此时SD UHS卡最高只能工作在SDR50 &lt;100MHz的速度，即这种host最高只能支持UHS SDR50模式。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202404192034201.png" alt="image-20240419203428136"></p>
<h5 id="SD卡初始化（下半部分-part2）：HS模式（SD2-0）配置"><a href="#SD卡初始化（下半部分-part2）：HS模式（SD2-0）配置" class="headerlink" title="SD卡初始化（下半部分-part2）：HS模式（SD2.0）配置"></a><strong>SD卡初始化（下半部分-part2）：HS模式（SD2.0）配置</strong></h5><p>如果卡不支持UHS模式，即不调用mmc_sd_init_uhs_card流程，或者该流程失败，会进入mmc_sd_switch_hs初始化流程，该模式指非UHS的低速模式，不需要切换信号电平，通信线宽，tuning等操作。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mmc_sd_switch_hs：</span><br><span class="line">	mmc_sd_switch（CMD6 switch to high speed）</span><br><span class="line">	mmc_set_clock（设置host ios clock）</span><br><span class="line">	mmc_app_set_bus_width（如果支持4bit bus-width，就CMD6切换）</span><br></pre></td></tr></table></figure>

<h2 id="附录：SD性能测试"><a href="#附录：SD性能测试" class="headerlink" title="附录：SD性能测试"></a>附录：SD性能测试</h2><p>在飞腾Pi上SD是作为系统盘启动，读写性能测试一般用fio或者dd。</p>
<p>如果没联外网下载fio，用系统自带的dd即可：</p>
<p>dd参数注释：</p>
<ol>
<li>if&#x3D;文件名：输入文件名，缺省为标准输入。即指定源文件。&lt; if&#x3D;input file &gt;</li>
<li>of&#x3D;文件名：输出文件名，缺省为标准输出。即指定目的文件。&lt; of&#x3D;output file &gt;</li>
<li>bs&#x3D;bytes：同时设置读入&#x2F;输出的块大小为bytes个字节。</li>
<li>count&#x3D;blocks：仅拷贝blocks个块，块大小等于ibs指定的字节数。</li>
</ol>
<p>dd测试写和读的用例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#测试写</span><br><span class="line">root@phytiumpi:~# dd if=/dev/zero of=/dd-test.bin bs=1M count=256 conv=fdatasync</span><br><span class="line">256+0 records in</span><br><span class="line">256+0 records out</span><br><span class="line">268435456 bytes (268 MB, 256 MiB) copied, 19.6135 s, 13.7 MB/s</span><br><span class="line"></span><br><span class="line">#测试读</span><br><span class="line">root@phytiumpi:~# dd if=/dd-test.bin of=/dev/zero bs=1M count=256 iflag=direct</span><br><span class="line">256+0 records in</span><br><span class="line">256+0 records out</span><br><span class="line">268435456 bytes (268 MB, 256 MiB) copied, 11.3607 s, 23.6 MB/s</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意两个参数很重要，是为了绕开写缓存直接写硬盘：</p>
<p>‘fdatasync’：Synchronize output data just before finishing. This forces a physical write of output data. 写数据测试包括写入物理盘，而不是写到buffer就算完。dd命令执行到最后会真正执行一次“同步(sync)”操作。</p>
<p>iflag&#x3D;direct：读数据测试，直接读不经过读缓存。</p>
<p>这样测试也可以：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@phytiumpi:~# dd if=/dev/zero of=/dd-test.bin bs=256M count=1 conv=fdatasync1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">268435456 bytes (268 MB, 256 MiB) copied, 19.4769 s, 13.8 MB/s</span><br><span class="line"></span><br><span class="line">root@phytiumpi:~# dd if=/dd-test.bin of=/dev/zero bs=256M count=1 iflag=direct</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">268435456 bytes (268 MB, 256 MiB) copied, 11.327 s, 23.7 MB/s</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/05/18/%E9%A3%9E%E8%85%BE%E6%B4%BELinux%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%EF%BC%9A%E4%B8%B2%E5%8F%A3%E8%B0%83%E8%AF%95%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91uboot%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/05/18/%E9%A3%9E%E8%85%BE%E6%B4%BELinux%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%EF%BC%9A%E4%B8%B2%E5%8F%A3%E8%B0%83%E8%AF%95%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91uboot%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">飞腾派Linux调试环境-串口调试交叉编译uboot配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-05-18 15:50:54" itemprop="dateCreated datePublished" datetime="2024-05-18T15:50:54+08:00">2024-05-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:57:13" itemprop="dateModified" datetime="2025-11-04T17:57:13+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="飞腾派Linux调试环境：串口调试，交叉编译，uboot配置"><a href="#飞腾派Linux调试环境：串口调试，交叉编译，uboot配置" class="headerlink" title="飞腾派Linux调试环境：串口调试，交叉编译，uboot配置"></a>飞腾派Linux调试环境：串口调试，交叉编译，uboot配置</h1><h1 id="串口调试环境"><a href="#串口调试环境" class="headerlink" title="串口调试环境"></a>串口调试环境</h1><h2 id="串口硬件连接"><a href="#串口硬件连接" class="headerlink" title="串口硬件连接"></a>串口硬件连接</h2><p>串口线的颜色和功能是对应的，4根线如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">功能    	   线的颜色</span><br><span class="line">TX           绿色</span><br><span class="line">RX           白色</span><br><span class="line">GND          黑色</span><br><span class="line">VCC          红色</span><br></pre></td></tr></table></figure>

<p>串口的接口类型取决于开发板接口，飞腾Pi是使用USB转TTL接口，有的开发板是板载串口转USB芯片，外部是USB直连PC，还有的是RS232接口。不管接口类型如何，串口转接芯片一般是CH340&#x2F;FT232。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202404241426062.png" alt="image-20240424142615021"></p>
<p>飞腾派接线只用了3根线，没用VCC。注意RX是接到TX， TX是接到RX。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202404241428560.png" alt="image-20240424142831480"></p>
<p>验证串口连接正常：查找到ttyUSB设备即USB转串口设备连接正常。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls /dev/ttyUSB0</span><br></pre></td></tr></table></figure>

<p>注：Ubuntu有时串口线找不到ttyUSB0设备，可能跟线的质量或者芯片驱动相关。在Ubuntu下FT232不需要安装驱动能稳定连接。Windows下串口转接芯片一定需要装对应的CH340或FT232驱动才能在设备管理器COM口看到USB设备。</p>
<h2 id="Putty-配置串口调试环境"><a href="#Putty-配置串口调试环境" class="headerlink" title="Putty 配置串口调试环境"></a>Putty 配置串口调试环境</h2><p>Putty连接串口需要以root用户启动。非root用户启动putty无法设置端口号，波特率等参数。</p>
<p>以root启动putty有两种方式：</p>
<ul>
<li>以root启动putty GUI，在GUI中配置端口号，波特率等参数。</li>
<li>以命令行sudo启动putty，在启动参数中配置端口号，波特率等参数。</li>
</ul>
<p>以root启动putty GUI：对于Ubuntu 22.04 Wayland桌面，使用<code>sudo -E putty</code>启动putty GUI。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/Running_GUI_applications_as_root">https://wiki.archlinux.org/title/Running_GUI_applications_as_root</a></p>
<p>以命令行sudo启动putty：</p>
<p>参考：<a target="_blank" rel="noopener" href="https://readypinaple.com/using-putty-serial-terminal">https://readypinaple.com/using-putty-serial-terminal</a></p>
<p>对于我的调试环境（飞腾派），参数如下：</p>
<p><code>sudo putty -serial /dev/ttyUSB0 -sercfg 115200,8,n,1,N</code></p>
<h2 id="Putty串口环境的复制和粘贴"><a href="#Putty串口环境的复制和粘贴" class="headerlink" title="Putty串口环境的复制和粘贴"></a>Putty串口环境的复制和粘贴</h2><p>Ubuntu22.04环境上有两种方法：</p>
<p>1.使用鼠标中键在terminal和putty之间复制和粘贴；此方法不能在选中之后再选中，否则内容被覆盖；</p>
<p>2.启动putty GUI后在selection设置ctrl+shift +C&#x2F;V 复制粘贴。记得保存设置到session的default配置。terminal默认支持ctrl+shift+C&#x2F;V操作。这种方式更稳定。</p>
<p>以上的ctrl+shift+C&#x2F;V和中键操作属于两套剪贴板buffer，不会相互覆盖。即ctrl+shift+C复制的数据必须用ctrl+shift+V粘贴，中键选中的数据必须用中键粘贴。</p>
<h2 id="Putty记录和查看log"><a href="#Putty记录和查看log" class="headerlink" title="Putty记录和查看log"></a>Putty记录和查看log</h2><h3 id="记录log"><a href="#记录log" class="headerlink" title="记录log"></a>记录log</h3><p>在启动GUI后在session-&gt;logging设置记录all output，记得保存设置到session的default配置。</p>
<h3 id="查看log"><a href="#查看log" class="headerlink" title="查看log"></a>查看log</h3><p>查看log可以使用less显示 + grep过滤；</p>
<p><strong>关于less：</strong> 类似vim快捷键.</p>
<p>匹配查找：在less中查找可以使用 &#x2F;或者？查找，参考以下less的help：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/pattern          *  Search forward for (N-th) matching line.</span><br><span class="line">?pattern          *  Search backward for (N-th) matching line.</span><br><span class="line">n                 *  Repeat previous search (for N-th occurrence).</span><br><span class="line">N                 *  Repeat previous search in reverse direction.</span><br><span class="line"></span><br><span class="line">#对于有空格的匹配查找，用反斜杠转义空格，例如：</span><br><span class="line">/this\ is\ pattern</span><br></pre></td></tr></table></figure>

<p>跳转到头尾：大G（跳到末尾）和 gg（重来到开头）.</p>
<p><strong>关于grep</strong>，有几点很常用：</p>
<p>a.有时log中有乱码导致被grep设别为binary导致grep无法显示，需要<code>grep --text</code>参数指定以文本打开：</p>
<p>例如要查看putty.log中mmc0模块的打印：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cursorhu@ubuntu-PC:~/phytium/phytium-linux-kernel-v1.0.1$ less ~/putty.log | grep mmc0 --text</span><br><span class="line"></span><br><span class="line">[    2.208568] mmc0: mmc_sd_setup_card:</span><br><span class="line">[    2.208571] mmc0: phytium_mci_ops_request: cmd:55 arg:0x400000</span><br><span class="line">[    2.209331] mmc0: phytium_mci_irq: events:100,mask:0x1547,dmac_events:0,dmac_mask:0x0,cmd:55</span><br><span class="line">[    2.209335] mmc0: phytium_mci_err_irq:</span><br><span class="line">[    2.209348] mmc0: error -110 whilst initialising SD card</span><br></pre></td></tr></table></figure>

<p>b.有时需要grep多个关键字，使用<code>grep -E “A|B”</code>，注意一定要用引号扩起来</p>
<p>例如要同时查看mmc0和BHT的打印：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">less ~/putty.log | grep -E &quot;mmc0|BHT&quot; --text</span><br><span class="line"></span><br><span class="line">[    6.816021] BHT MSG:sdr50_notuning_sela_rx_inject:463</span><br><span class="line">[    6.821067] BHT MSG:exit:_ggc_output_tuning  0</span><br><span class="line">[    6.825505] BHT MSG: finit is 400000Hz</span><br><span class="line">[    6.829248] mmc0: tuning execution failed: 1</span><br><span class="line">[    6.833513] mmc0: phytium_mci_ops_set_ios:</span><br><span class="line">[    6.841521] mmc0: phytium_mci_set_buswidth: width = 0, set value:0x0</span><br></pre></td></tr></table></figure>

<p>c.有时需要排除某关键字，例如飞腾的SD host有mmc0, mmc1两个，我只关注mmc0, 使用 grep -v KEYWORD去排除， v：invert match</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">less ~/putty.log | grep --text -v mmc1</span><br></pre></td></tr></table></figure>

<p><strong>less+grep+less：</strong></p>
<p>用less+grep过滤出log另存为新log， 再用less查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">less ~/putty.log | grep --text -E &quot;mmc0|BHT&quot; &gt; putty-bh201-tuning-error.log </span><br><span class="line">less putty-bh201-tuning-error2.log</span><br></pre></td></tr></table></figure>

<h1 id="交叉编译"><a href="#交叉编译" class="headerlink" title="交叉编译"></a>交叉编译</h1><h2 id="交叉编译方法"><a href="#交叉编译方法" class="headerlink" title="交叉编译方法"></a>交叉编译方法</h2><p>设置工具链环境变量+交叉编译命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">set_env.sh: 注意要用source执行才是export配置到当前环境变量，用sh或者./sh都是配置到子shell进程环境</span><br><span class="line"></span><br><span class="line">export PATH=$PATH:&quot;/opt/toolchains/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu/bin&quot;</span><br><span class="line">export CROSS_COMPILE=aarch64-linux-gnu-</span><br><span class="line">export ARCH=arm64</span><br><span class="line"></span><br><span class="line">build_kernel.sh:</span><br><span class="line"></span><br><span class="line">make ARCH=arm64 e2000_defconfig all -j4 INSTALL_MOD_PATH=modules modules_install</span><br></pre></td></tr></table></figure>

<p>安装编译的系统镜像和设备树：把编译机的输出image和dtb拷贝到SD卡系统盘的rootfs&#x2F;boot&#x2F;里，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp_image.sh：</span><br><span class="line"></span><br><span class="line">sudo cp arch/arm64/boot/Image /media/cursorhu/rootfs/boot/</span><br><span class="line">sudo cp arch/arm64/boot/dts/phytium/phytium-pi-board.dtb /media/cursorhu/rootfs/boot/</span><br></pre></td></tr></table></figure>

<p>SD卡放回开发板启动，putty串口回车进入uboot，指定从SD卡系统盘的rootfs&#x2F;boot&#x2F;启动内核</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">uboot.sh：（并不能直接在uboot运行）</span><br><span class="line"></span><br><span class="line">setenv bootargs console=ttyAMA1,115200 earlycon=pl011,0x2800d000 root=/dev/mmcblk0p1 rootwait rw;</span><br><span class="line">ext4load mmc 0:1 0x90100000 boot/Image;</span><br><span class="line">ext4load mmc 0:1 0x90000000 boot/phytium-pi-board.dtb;</span><br><span class="line">booti 0x90100000 – 0x90000000;</span><br></pre></td></tr></table></figure>

<h1 id="uboot配置"><a href="#uboot配置" class="headerlink" title="uboot配置"></a>uboot配置</h1><h2 id="uboot自动选择指定kernel启动"><a href="#uboot自动选择指定kernel启动" class="headerlink" title="uboot自动选择指定kernel启动"></a>uboot自动选择指定kernel启动</h2><p>背景：如下图，飞腾派启动指定内核需要设置uboot参数，由于飞腾派的uboot源码没有开放，不能用脚本（boot.scr）。调试新编译的内核，每次飞腾派启动都需要在putty粘贴uboot命令。开发效率低。</p>
<p>![Screenshot from 2024-04-08 15-40-55](&#x2F;home&#x2F;cursorhu&#x2F;Pictures&#x2F;Screenshot from 2024-04-08 15-40-55.png)</p>
<p>解决方案：将uboot命令配置到uboot环境变量，并保存到系统盘中使断电重启后uboot环境变量也生效。</p>
<p>参考mastering embeded linux programming， 使用bootcmd参数可以配置uboot script去执行一连串命令，实现类似shell script功能并保存，每次启动uboot不用复制粘贴一条条命令去启动。 </p>
<p>以飞腾派为例，每次编译kernel后要从新编译的kernel启动，需要每次手动设置以下uboot命令&#x2F;环境：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#启动参数环境变量</span><br><span class="line">setenv bootargs console=ttyAMA1,115200 earlycon=pl011,0x2800d000 root=/dev/mmcblk0p1 rootwait rw;</span><br><span class="line">#命令语句（非环境变量）</span><br><span class="line">ext4load mmc 0:1 0x90100000 boot/Image;</span><br><span class="line">ext4load mmc 0:1 0x90000000 boot/phytium-pi-board.dtb;</span><br><span class="line">booti 0x90100000 – 0x90000000;</span><br></pre></td></tr></table></figure>

<p>目标：使uboot自动从以上命令语句指定的kernel启动：</p>
<p>对于环境变量bootargs不需要改动，我们只需要将命令语句设置到bootcmd环境变量。最后再一起saveenv使两个环境变量都保存到硬盘，重启后能自动生效即可。</p>
<ol>
<li>如何设置bootcmd到uboot环境变量：</li>
</ol>
<p>将以上uboot命令语句合成为一条语句设置到bootcmd：uboot命令的结束标志是分号，设置bootcmd时在内容语句的每个分号前需要加转移字符 , 这样setenv才会判断这个分号是要输入到bootcmd的字符，而不散表明setenv命令本身的结束。 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setenv bootcmd ext4load mmc 0:1 0x90100000 boot/Image\;ext4load mmc 0:1 0x90000000 boot/phytium-pi-board.dtb\;booti 0x90100000 – 0x90000000\;</span><br></pre></td></tr></table></figure>

<p>注意：上面指令拷贝到putty串口时时符号 <code>-</code>会消失，需要手动添加</p>
<ol start="2">
<li>如何使bootargs和bootcmd环境变量重启后也自动生效：保存（所有）环境变量</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">saveenv</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>重启后可以printenv查看配置生效，根据kernel打印可确认确实从指定kernel启动。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Phytium-Pi#printenv</span><br><span class="line">arch=arm</span><br><span class="line">baudrate=115200</span><br><span class="line">board=e2000</span><br><span class="line">board_name=e2000</span><br><span class="line">boot_os=bootm $kernel_addr -:- $ft_fdt_addr</span><br><span class="line">bootargs=console=ttyAMA1,115200 earlycon=pl011,0x2800d000 root=/dev/mmcblk0p1 rootwait rw;</span><br><span class="line">bootcmd=ext4load mmc 0:1 0x90100000 boot/Image;ext4load mmc 0:1 0x90000000 boot/phytium-pi-board.dtb;booti 0x90100000 - 0x90000000;</span><br><span class="line">bootdelay=2</span><br><span class="line">cpu=armv8</span><br></pre></td></tr></table></figure>

<p>5.如何删除env：变量设置为空即为删除：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setenv bootargs</span><br><span class="line">setenv bootcmd</span><br><span class="line">saveenv</span><br></pre></td></tr></table></figure>

<h1 id="附录：问题记录"><a href="#附录：问题记录" class="headerlink" title="附录：问题记录"></a>附录：问题记录</h1><h2 id="ARM工具链报错问题"><a href="#ARM工具链报错问题" class="headerlink" title="ARM工具链报错问题"></a>ARM工具链报错问题</h2><p>编译飞腾kernel有时会报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cursorhu@ubuntu-PC:~/phytium/phytium-linux-kernel-v1.0.1$ ./build_kernel.sh </span><br><span class="line">#</span><br><span class="line"># configuration written to .config</span><br><span class="line">#</span><br><span class="line">arch/arm64/Makefile:27: ld does not support --fix-cortex-a53-843419; kernel may be susceptible to erratum</span><br><span class="line">arch/arm64/Makefile:40: LSE atomics not supported by binutils</span><br><span class="line">arch/arm64/Makefile:48: Detected assembler with broken .inst; disassembly will be unreliable</span><br><span class="line">scripts/kconfig/conf  --syncconfig Kconfig</span><br><span class="line">arch/arm64/Makefile:27: ld does not support --fix-cortex-a53-843419; kernel may be susceptible to erratum</span><br><span class="line">arch/arm64/Makefile:40: LSE atomics not supported by binutils</span><br><span class="line">arch/arm64/Makefile:48: Detected assembler with broken .inst; disassembly will be unreliable</span><br><span class="line">  CC      scripts/mod/empty.o</span><br><span class="line">gcc: error: unrecognized command-line option ‘-mlittle-endian’</span><br><span class="line">make[3]: *** [scripts/Makefile.build:304: scripts/mod/empty.o] Error 1</span><br><span class="line">make[2]: *** [scripts/Makefile.build:544: scripts/mod] Error 2</span><br><span class="line">make[1]: *** [Makefile:1085: scripts] Error 2</span><br><span class="line">make[1]: *** Waiting for unfinished jobs....</span><br><span class="line">make: *** [Makefile:286: __build_one_by_one] Error 2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>报错内容指向以下patch：</p>
<p><a target="_blank" rel="noopener" href="https://patchwork.kernel.org/project/linux-arm-kernel/patch/1471873737-7614-1-git-send-email-will.deacon@arm.com/">https://patchwork.kernel.org/project/linux-arm-kernel/patch/1471873737-7614-1-git-send-email-will.deacon@arm.com/</a></p>
<p>可能原因：没有运行set_env.sh就直接build，生成的.confg有问题, ARCH&#x3D;arm CROSS_COMPILE&#x3D;XXX XXX_defconfig都没被写入到.confg文件</p>
<p>解决方法：删除kernel源码目录的.config文件：rm .config和.config.old，需要重启机器，再source set_env.sh重新设置环境变量, source build_kernel.sh, 编译就OK了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/03/12/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8CubeMX%E7%94%9F%E6%88%90STM32%E4%BB%A3%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/12/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8CubeMX%E7%94%9F%E6%88%90STM32%E4%BB%A3%E7%A0%81/" class="post-title-link" itemprop="url">如何使用CubeMX生成STM32代码</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-03-12 15:50:54" itemprop="dateCreated datePublished" datetime="2024-03-12T15:50:54+08:00">2024-03-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 16:55:42" itemprop="dateModified" datetime="2025-11-04T16:55:42+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/stm32/" itemprop="url" rel="index"><span itemprop="name">stm32</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="如何使用CubeMX生成STM32代码"><a href="#如何使用CubeMX生成STM32代码" class="headerlink" title="如何使用CubeMX生成STM32代码"></a>如何使用CubeMX生成STM32代码</h1><h2 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h2><p>STM32F0的firmware工程文件.ioc用CubeMX打开，如下：</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202405292028057.png" alt="image-20240529202815926"></p>
<p>现在要移植一些外设配置到STM32F4，使用UART2为示例：</p>
<p>1.对照F0的工程界面，打开F4的工程界面，搜索要配置的Pin，设置Pin模式和F0一致，为UART2_TX</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202405292030441.png" alt="image-20240529203013390">2.对照F0的工程界面，打开F4的工程界面，配置UART2_TX的详细工作模式，例如波特率，中断…</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202405292031748.png" alt="image-20240529203142664"></p>
<p>3.配置完毕后，点generate code生成代码</p>
<p>4.理解代码和工程配置的对应关系：</p>
<p>一般自动生成的代码都在Core里面：</p>
<p>（1）main查看该外设的初始化代码</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202405292032897.png" alt="image-20240529203258870"></p>
<p>（2）中断查看中断配置相关的代码：it.c实现回调</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202405292034688.png" alt="image-20240529203407652"></p>
<p>（2）msp是该外设的最底层配置，main的初始化和中断回调都以此配置为前提生效。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202405292034549.png" alt="image-20240529203455499"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="cursorhu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">cursorhu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">113</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">55</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/cursorhu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cursorhu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:2449055512@qq.com" title="E-Mail → mailto:2449055512@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cursorhu</span>
</div>



        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
