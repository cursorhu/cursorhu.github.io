<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 8.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC|Roboto/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Roboto:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"cursorhu.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Cursor��¼-20241111-����Storport Pofx��SD Host WDF�����ܹ��ĵ�Chat Transcript - Tab 2User:[selections]   1#if DBG [text]DBG�����ﱻ���� AI (claude-3.5-sonnet):��Windows���������У�DBGͨ��������Ŀ���û����ѡ���ж">
<meta property="og:type" content="article">
<meta property="og:title" content="Cursor��¼-����Storport Pofx��SD Host WDF�����ܹ��ĵ�">
<meta property="og:url" content="https://cursorhu.github.io/2024/08/30/Cursor%E8%AE%B0%E5%BD%95-20241111-%E5%85%B3%E4%BA%8EStorport%20Pofx%E5%92%8CSD%20Host%20WDF%E9%A9%B1%E5%8A%A8%E6%9E%B6%E6%9E%84%E6%96%87%E6%A1%A3/index.html">
<meta property="og:site_name" content="ThinkNotes">
<meta property="og:description" content="Cursor��¼-20241111-����Storport Pofx��SD Host WDF�����ܹ��ĵ�Chat Transcript - Tab 2User:[selections]   1#if DBG [text]DBG�����ﱻ���� AI (claude-3.5-sonnet):��Windows���������У�DBGͨ��������Ŀ���û����ѡ���ж">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-08-30T07:50:54.000Z">
<meta property="article:modified_time" content="2025-11-04T09:12:26.648Z">
<meta property="article:author" content="cursorhu">
<meta property="article:tag" content="Cursor">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://cursorhu.github.io/2024/08/30/Cursor%E8%AE%B0%E5%BD%95-20241111-%E5%85%B3%E4%BA%8EStorport%20Pofx%E5%92%8CSD%20Host%20WDF%E9%A9%B1%E5%8A%A8%E6%9E%B6%E6%9E%84%E6%96%87%E6%A1%A3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Cursor��¼-����Storport Pofx��SD Host WDF�����ܹ��ĵ� | ThinkNotes</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ThinkNotes</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Simple is not easy</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于我</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/08/30/Cursor%E8%AE%B0%E5%BD%95-20241111-%E5%85%B3%E4%BA%8EStorport%20Pofx%E5%92%8CSD%20Host%20WDF%E9%A9%B1%E5%8A%A8%E6%9E%B6%E6%9E%84%E6%96%87%E6%A1%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Cursor��¼-����Storport Pofx��SD Host WDF�����ܹ��ĵ�
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-08-30 15:50:54" itemprop="dateCreated datePublished" datetime="2024-08-30T15:50:54+08:00">2024-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:12:26" itemprop="dateModified" datetime="2025-11-04T17:12:26+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI%EF%BF%BD%EF%BF%BD%EF%BF%BD/" itemprop="url" rel="index"><span itemprop="name">AI���</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Cursor��¼-20241111-����Storport-Pofx��SD-Host-WDF�����ܹ��j�"><a href="#Cursor��¼-20241111-����Storport-Pofx��SD-Host-WDF�����ܹ��j�" class="headerlink" title="Cursor��¼-20241111-����Storport Pofx��SD Host WDF�����ܹ��ĵ�"></a>Cursor��¼-20241111-����Storport Pofx��SD Host WDF�����ܹ��ĵ�</h1><h1 id="Chat-Transcript-Tab-2"><a href="#Chat-Transcript-Tab-2" class="headerlink" title="Chat Transcript - Tab 2"></a>Chat Transcript - Tab 2</h1><h2 id="User"><a href="#User" class="headerlink" title="User:"></a>User:</h2><p>[selections]  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> DBG</span></span><br></pre></td></tr></table></figure>
<p>[text]<br>DBG�����ﱻ����</p>
<h2 id="AI-claude-3-5-sonnet"><a href="#AI-claude-3-5-sonnet" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��Windows���������У�<code>DBG</code>ͨ��������Ŀ���û����ѡ���ж���ġ������¼��ֳ����Ķ��巽ʽ��</p>
<ol>
<li>����Ŀ�����У�</li>
</ol>
<ul>
<li>Debug���û��Զ�����<code>DBG=1</code></li>
<li>Release�����򲻻ᶨ��<code>DBG</code></li>
</ul>
<ol start="2">
<li>��Դ�����У��������driver.h�ļ����ͷ�������¶��壺</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#ifndef DBG</span><br><span class="line">#if defined(DEBUG) || defined(_DEBUG)</span><br><span class="line">#define DBG 1</span><br><span class="line">#else</span><br><span class="line">#define DBG 0</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>

<p>������driver.h�ļ����ͷ������δ��룬��<code>#pragma once</code>֮�󼴿ɣ�</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#pragma once</span><br><span class="line">#pragma code_page(65001)  // UTF-8����</span><br><span class="line"></span><br><span class="line">// ����DBG����</span><br><span class="line">#ifndef DBG</span><br><span class="line">#if defined(DEBUG) || defined(_DEBUG)</span><br><span class="line">#define DBG 1</span><br><span class="line">#else</span><br><span class="line">#define DBG 0</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">// �������뱣�ֲ���...</span><br></pre></td></tr></table></figure>

<p>��������ȷ����</p>
<ol>
<li>��Debug���������õ������</li>
<li>��Release�����½��õ������</li>
<li>��Visual Studio��Ĭ����Ϊ����һ��</li>
</ol>
<h2 id="User-1"><a href="#User-1" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>���DriverEntry�Ƿ��е��´�BSOD �Ĵ��룺SYSTEM_THREAD_EXCEPTION_NOT_HANDLED (7e)<br>This is a very common BugCheck.  Usually the exception address pinpoints<br>the driver&#x2F;function that caused the problem.  Always note this address<br>as well as the link date of the driver&#x2F;image that contains this address.<br>Arguments:<br>Arg1: ffffffffc0000005, The exception code that was not handled<br>Arg2: fffff80754b545c8, The address that the exception occurred at<br>Arg3: ffffa70af8fbaf08, Exception Record Address<br>Arg4: ffffa70af8fba720, Context Record Address</p>
<h2 id="AI-claude-3-5-sonnet-1"><a href="#AI-claude-3-5-sonnet-1" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õ�,���Ұ�������ܵ��� SYSTEM_THREAD_EXCEPTION_NOT_HANDLED (0x7E) �����ĳ���ԭ���������ͨ�������ڷ�����Ч�ڴ��ַ����ġ�</p>
<p>��������Ҫ�� DriverEntry �м��Ĺؼ���:</p>
<ol>
<li>���ָ���ʼ����ʹ��:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS DriverEntry(</span><br><span class="line">    _In_ PDRIVER_OBJECT  DriverObject,</span><br><span class="line">    _In_ PUNICODE_STRING RegistryPath</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    // 1. ��֤����</span><br><span class="line">    if (DriverObject == NULL || RegistryPath == NULL) &#123;</span><br><span class="line">        return STATUS_INVALID_PARAMETER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 2. ��ʼ�� WDF ��������</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;config, O2MicroEvtDeviceAdd);</span><br><span class="line"></span><br><span class="line">    // 3. ������������ǰ�������ڴ�</span><br><span class="line">    WDFDRIVER driver = NULL;</span><br><span class="line">    </span><br><span class="line">    // 4. ʹ�� try/except �����ؼ�����</span><br><span class="line">    __try &#123;</span><br><span class="line">        // ���� WDF ��������</span><br><span class="line">        NTSTATUS status = WdfDriverCreate(</span><br><span class="line">            DriverObject,</span><br><span class="line">            RegistryPath,</span><br><span class="line">            WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">            &amp;config,</span><br><span class="line">            &amp;driver);</span><br><span class="line">        </span><br><span class="line">        if (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            O2MICRO_LOG_ERROR(&quot;WdfDriverCreate failed with status %!STATUS!&quot;, status);</span><br><span class="line">            return status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __except(EXCEPTION_EXECUTE_HANDLER) &#123;</span><br><span class="line">        O2MICRO_LOG_ERROR(&quot;Exception caught in DriverEntry&quot;);</span><br><span class="line">        return STATUS_UNHANDLED_EXCEPTION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Ҫ����:</p>
<ol>
<li>���Ӳ�����֤</li>
<li>ʹ�� __try&#x2F;__except �����ؼ�����</li>
<li>ȷ������ָ����ʹ��ǰ���ѳ�ʼ��</li>
<li>������ϸ�Ĵ�����־</li>
<li>����ֱ�ӷ���Ӳ��,Ӧ���� EvtDevicePrepareHardware �н���</li>
</ol>
<p>�������ܵ�ԭ��:</p>
<ol>
<li>��������Ƿ���ȷǩ��</li>
<li>ȷ�� WDF&#x2F;WDM �汾������</li>
<li>��֤��������˳���Ƿ���ȷ</li>
<li>���ϵͳ������Ҫ��</li>
</ol>
<p>������ԵĻ�,���ṩ:</p>
<ol>
<li>������ DriverEntry ����</li>
<li>����ʱ�ĵ���ջ��Ϣ</li>
<li>WinDbg �� !analyze -v ���</li>
</ol>
<p>�����ҿ��Ը�׼ȷ�ض�λ���⡣</p>
<h2 id="User-2"><a href="#User-2" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>WinDbg �� !analyze -v �����: kd&gt; !analyze -v</p>
<hr>
<ul>
<li><pre><code>                                                                        *
</code></pre>
</li>
<li><pre><code>                   Bugcheck Analysis                                    *
</code></pre>
</li>
<li><pre><code>                                                                        *
</code></pre>
</li>
</ul>
<hr>
<p>SYSTEM_THREAD_EXCEPTION_NOT_HANDLED (7e)<br>This is a very common BugCheck.  Usually the exception address pinpoints<br>the driver&#x2F;function that caused the problem.  Always note this address<br>as well as the link date of the driver&#x2F;image that contains this address.<br>Arguments:<br>Arg1: ffffffffc0000005, The exception code that was not handled<br>Arg2: fffff80754b545c8, The address that the exception occurred at<br>Arg3: ffffa70af8fbaf08, Exception Record Address<br>Arg4: ffffa70af8fba720, Context Record Address</p>
<h2 id="Debugging-Details"><a href="#Debugging-Details" class="headerlink" title="Debugging Details:"></a>Debugging Details:</h2><p>KEY_VALUES_STRING: 1</p>
<pre><code>Key  : AV.Dereference
Value: NullClassPtr

Key  : AV.Fault
Value: Read

Key  : Analysis.CPU.mSec
Value: 2359

Key  : Analysis.Elapsed.mSec
Value: 2620

Key  : Analysis.IO.Other.Mb
Value: 0

Key  : Analysis.IO.Read.Mb
Value: 0

Key  : Analysis.IO.Write.Mb
Value: 0

Key  : Analysis.Init.CPU.mSec
Value: 390

Key  : Analysis.Init.Elapsed.mSec
Value: 3531

Key  : Analysis.Memory.CommitPeak.Mb
Value: 104

Key  : Bugcheck.Code.LegacyAPI
Value: 0x1000007e

Key  : Bugcheck.Code.TargetModel
Value: 0x1000007e

Key  : Dump.Attributes.AsUlong
Value: 1808

Key  : Dump.Attributes.DiagDataWrittenToHeader
Value: 1

Key  : Dump.Attributes.ErrorCode
Value: 0

Key  : Dump.Attributes.KernelGeneratedTriageDump
Value: 1

Key  : Dump.Attributes.LastLine
Value: Dump completed successfully.

Key  : Dump.Attributes.ProgressPercentage
Value: 0

Key  : Failure.Bucket
Value: AV_o2micro_sdhost!unknown_function

Key  : Failure.Hash
Value: {675c0c01-465e-ed53-efc7-4c82b345b89c}

Key  : Hypervisor.Enlightenments.ValueHex
Value: 1417cf94

Key  : Hypervisor.Flags.AnyHypervisorPresent
Value: 1

Key  : Hypervisor.Flags.ApicEnlightened
Value: 1

Key  : Hypervisor.Flags.ApicVirtualizationAvailable
Value: 0

Key  : Hypervisor.Flags.AsyncMemoryHint
Value: 0

Key  : Hypervisor.Flags.CoreSchedulerRequested
Value: 0

Key  : Hypervisor.Flags.CpuManager
Value: 1

Key  : Hypervisor.Flags.DeprecateAutoEoi
Value: 0

Key  : Hypervisor.Flags.DynamicCpuDisabled
Value: 1

Key  : Hypervisor.Flags.Epf
Value: 0

Key  : Hypervisor.Flags.ExtendedProcessorMasks
Value: 1

Key  : Hypervisor.Flags.HardwareMbecAvailable
Value: 1

Key  : Hypervisor.Flags.MaxBankNumber
Value: 0

Key  : Hypervisor.Flags.MemoryZeroingControl
Value: 0

Key  : Hypervisor.Flags.NoExtendedRangeFlush
Value: 0

Key  : Hypervisor.Flags.NoNonArchCoreSharing
Value: 1

Key  : Hypervisor.Flags.Phase0InitDone
Value: 1

Key  : Hypervisor.Flags.PowerSchedulerQos
Value: 0

Key  : Hypervisor.Flags.RootScheduler
Value: 0

Key  : Hypervisor.Flags.SynicAvailable
Value: 1

Key  : Hypervisor.Flags.UseQpcBias
Value: 0

Key  : Hypervisor.Flags.Value
Value: 4853999

Key  : Hypervisor.Flags.ValueHex
Value: 4a10ef

Key  : Hypervisor.Flags.VpAssistPage
Value: 1

Key  : Hypervisor.Flags.VsmAvailable
Value: 1

Key  : Hypervisor.RootFlags.AccessStats
Value: 1

Key  : Hypervisor.RootFlags.CrashdumpEnlightened
Value: 1

Key  : Hypervisor.RootFlags.CreateVirtualProcessor
Value: 1

Key  : Hypervisor.RootFlags.DisableHyperthreading
Value: 0

Key  : Hypervisor.RootFlags.HostTimelineSync
Value: 1

Key  : Hypervisor.RootFlags.HypervisorDebuggingEnabled
Value: 0

Key  : Hypervisor.RootFlags.IsHyperV
Value: 1

Key  : Hypervisor.RootFlags.LivedumpEnlightened
Value: 1

Key  : Hypervisor.RootFlags.MapDeviceInterrupt
Value: 1

Key  : Hypervisor.RootFlags.MceEnlightened
Value: 1

Key  : Hypervisor.RootFlags.Nested
Value: 0

Key  : Hypervisor.RootFlags.StartLogicalProcessor
Value: 1

Key  : Hypervisor.RootFlags.Value
Value: 1015

Key  : Hypervisor.RootFlags.ValueHex
Value: 3f7
</code></pre>
<p>BUGCHECK_CODE:  7e</p>
<p>BUGCHECK_P1: ffffffffc0000005</p>
<p>BUGCHECK_P2: fffff80754b545c8</p>
<p>BUGCHECK_P3: ffffa70af8fbaf08</p>
<p>BUGCHECK_P4: ffffa70af8fba720</p>
<p>FILE_IN_CAB:  110724-109109-01.dmp</p>
<p>DUMP_FILE_ATTRIBUTES: 0x1808<br>  Kernel Generated Triage Dump</p>
<p>FAULTING_THREAD:  ffffbb0f5440e040</p>
<p>EXCEPTION_RECORD:  ffffa70af8fbaf08 – (.exr 0xffffa70af8fbaf08)<br>ExceptionAddress: fffff80754b545c8 (o2micro_sdhost+0x00000000000045c8)<br>   ExceptionCode: c0000005 (Access violation)<br>  ExceptionFlags: 00000000<br>NumberParameters: 2<br>   Parameter[0]: 0000000000000000<br>   Parameter[1]: 00000000000003a0<br>Attempt to read from address 00000000000003a0</p>
<p>CONTEXT:  ffffa70af8fba720 – (.cxr 0xffffa70af8fba720)<br>rax&#x3D;00000000000003a0 rbx&#x3D;ffffbb0f589fd000 rcx&#x3D;0000000000000000<br>rdx&#x3D;ffffbb0f589fd000 rsi&#x3D;ffffbb0f5970589d rdi&#x3D;ffffbb0f54fbb560<br>rip&#x3D;fffff80754b545c8 rsp&#x3D;ffffa70af8fbb140 rbp&#x3D;ffffa70af8fbb370<br> r8&#x3D;0000000000000000  r9&#x3D;ffffa70af8fbb1e8 r10&#x3D;72206d6f7266206c<br>r11&#x3D;ffffbb0f517f7028 r12&#x3D;ffffffff80001b54 r13&#x3D;0000000000000002<br>r14&#x3D;ffffbb0f54fbb560 r15&#x3D;ffffa98869a1c610<br>iopl&#x3D;0         nv up ei pl nz na po nc<br>cs&#x3D;0010  ss&#x3D;0018  ds&#x3D;002b  es&#x3D;002b  fs&#x3D;0053  gs&#x3D;002b             efl&#x3D;00050206<br>o2micro_sdhost+0x45c8:<br>fffff807<code>54b545c8 488b0401        mov     rax,qword ptr [rcx+rax] ds:002b:00000000</code>000003a0&#x3D;????????????????<br>Resetting default scope</p>
<p>BLACKBOXBSD: 1 (!blackboxbsd)</p>
<p>BLACKBOXNTFS: 1 (!blackboxntfs)</p>
<p>BLACKBOXPNP: 1 (!blackboxpnp)</p>
<p>BLACKBOXWINLOGON: 1</p>
<p>CUSTOMER_CRASH_COUNT:  1</p>
<p>PROCESS_NAME:  System</p>
<p>READ_ADDRESS: fffff8073171d470: Unable to get MiVisibleState<br>Unable to get NonPagedPoolStart<br>Unable to get NonPagedPoolEnd<br>Unable to get PagedPoolStart<br>Unable to get PagedPoolEnd<br>unable to get nt!MmSpecialPagesInUse<br> 00000000000003a0 </p>
<p>ERROR_CODE: (NTSTATUS) 0xc0000005 - 0x%p            0x%p                    %s</p>
<p>EXCEPTION_CODE_STR:  c0000005</p>
<p>EXCEPTION_PARAMETER1:  0000000000000000</p>
<p>EXCEPTION_PARAMETER2:  00000000000003a0</p>
<p>EXCEPTION_STR:  0xc0000005</p>
<p>STACK_TEXT:<br>ffffa70a<code>f8fbb140 ffffa70a</code>f8fbb370     : fffff807<code>30c04910 ffffbb0f</code>589fd000 ffffbb0f<code>5970589d ffffbb0f</code>54fbb560 : o2micro_sdhost+0x45c8<br>ffffa70a<code>f8fbb148 fffff807</code>30c04910     : ffffbb0f<code>589fd000 ffffbb0f</code>5970589d ffffbb0f<code>54fbb560 00000000</code>00000000 : 0xffffa70a<code>f8fbb370 ffffa70a</code>f8fbb150 fffff807<code>54b510e0     : ffffbb0f</code>54fbb560 ffffbb0f<code>589fd000 00000000</code>00000000 ffffa70a<code>f8fbb1e8 : nt!DbgPrintEx+0x30 ffffa70a</code>f8fbb1a0 ffffbb0f<code>54fbb560     : ffffbb0f</code>589fd000 00000000<code>00000000 ffffa70a</code>f8fbb1e8 00000000<code>00000000 : o2micro_sdhost+0x10e0 ffffa70a</code>f8fbb1a8 ffffbb0f<code>589fd000     : 00000000</code>00000000 ffffa70a<code>f8fbb1e8 00000000</code>00000000 00057e40<code>00002710 : 0xffffbb0f</code>54fbb560<br>ffffa70a<code>f8fbb1b0 00000000</code>00000000     : ffffa70a<code>f8fbb1e8 00000000</code>00000000 00057e40<code>00002710 fffff807</code>30f5e3a0 : 0xffffbb0f&#96;589fd000</p>
<p>SYMBOL_NAME:  o2micro_sdhost+45c8</p>
<p>MODULE_NAME: o2micro_sdhost</p>
<p>IMAGE_NAME:  o2micro_sdhost.sys</p>
<p>STACK_COMMAND:  .cxr 0xffffa70af8fba720 ; kb</p>
<p>BUCKET_ID_FUNC_OFFSET:  45c8</p>
<p>FAILURE_BUCKET_ID:  AV_o2micro_sdhost!unknown_function</p>
<p>OSPLATFORM_TYPE:  x64</p>
<p>OSNAME:  Windows 10</p>
<p>FAILURE_ID_HASH:  {675c0c01-465e-ed53-efc7-4c82b345b89c}</p>
<p>Followup:     MachineOwner</p>
<h2 id="AI-claude-3-5-sonnet-2"><a href="#AI-claude-3-5-sonnet-2" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�����ṩ������������������ڷ��ʿ�ָ�뵼�µ��쳣������������£�</p>
<ol>
<li>�������ͣ�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SYSTEM_THREAD_EXCEPTION_NOT_HANDLED (7e)</span><br><span class="line">ExceptionCode: c0000005 (Access violation)</span><br><span class="line">Attempt to read from address 00000000000003a0</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>�������λ�ã�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">o2micro_sdhost+0x45c8:</span><br><span class="line">fffff807`54b545c8 488b0401        mov     rax,qword ptr [rcx+rax]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>�Ĵ���״̬��</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rax=00000000000003a0 </span><br><span class="line">rcx=0000000000000000  // ���� rcx Ϊ NULL</span><br></pre></td></tr></table></figure>

<p>�����޸� DriverEntry ���������ӷ�����</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS DriverEntry(</span><br><span class="line">    _In_ PDRIVER_OBJECT  DriverObject,</span><br><span class="line">    _In_ PUNICODE_STRING RegistryPath</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    </span><br><span class="line">    // 1. ���Ӳ�����֤</span><br><span class="line">    if (DriverObject == NULL || RegistryPath == NULL) &#123;</span><br><span class="line">        return STATUS_INVALID_PARAMETER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 2. �����쳣����</span><br><span class="line">    __try &#123;</span><br><span class="line">        // ��ȡ���Լ���</span><br><span class="line">        status = O2MicroReadDebugLevelFromRegistry(RegistryPath);</span><br><span class="line">        if (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            O2MICRO_LOG_WARN(&quot;Failed to read debug level from registry, using default&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // ��ʼ��WDF��������</span><br><span class="line">        WDF_DRIVER_CONFIG_INIT(&amp;config, O2MicroEvtDeviceAdd);</span><br><span class="line">        </span><br><span class="line">        // ����WDF��������</span><br><span class="line">        status = WdfDriverCreate(</span><br><span class="line">            DriverObject,</span><br><span class="line">            RegistryPath,</span><br><span class="line">            WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">            &amp;config,</span><br><span class="line">            WDF_NO_HANDLE  // ȷ�������ʼ��</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        if (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            O2MICRO_LOG_ERROR(&quot;WdfDriverCreate failed: %!STATUS!&quot;, status);</span><br><span class="line">            return status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __except(EXCEPTION_EXECUTE_HANDLER) &#123;</span><br><span class="line">        O2MICRO_LOG_ERROR(&quot;Exception caught in DriverEntry&quot;);</span><br><span class="line">        return STATUS_UNHANDLED_EXCEPTION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    O2MICRO_LOG_INFO(&quot;Driver loaded successfully&quot;);</span><br><span class="line">    return status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Ҫ�޸Ľ��飺</p>
<ol>
<li>���Ӳ�����֤</li>
<li>ʹ�� __try&#x2F;__except �����ؼ�����</li>
<li>ȷ������ָ��ʹ��ǰ��������֤</li>
<li>������ϸ�Ĵ�����־</li>
<li>��� O2MicroReadDebugLevelFromRegistry �����е�ָ�����</li>
</ol>
<p>������������ڷ����� NULL ָ��(rcx)����ƫ����(0x3a0)���µģ�������ϸ��������漰ָ������Ĵ��룬�ر����ڵ�����־��صĺ����С�</p>
<h2 id="User-3"><a href="#User-3" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>��������Ƿ���ȷǩ��</p>
<h2 id="AI-claude-3-5-sonnet-3"><a href="#AI-claude-3-5-sonnet-3" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>Ҫ�������ǩ��������ͨ�����¼��ַ�����</p>
<ol>
<li>ʹ�� SignTool ��֤:</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">signtool verify /pa /v o2micro_sdhost.sys</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ʹ�� WinDbg ���:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">!drivers</span><br><span class="line">lm vm o2micro_sdhost</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>�������ǩ������:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">// �� INF �ļ�������ǩ������</span><br><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">Class=SDHost</span><br><span class="line">ClassGuid=&#123;4D36E978-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line">Provider=%ManufacturerName%</span><br><span class="line">CatalogFile=o2micro_sdhost.cat</span><br><span class="line">DriverVer=mm/dd/yyyy,x.y.z.0</span><br><span class="line">PnpLockdown=1</span><br><span class="line"></span><br><span class="line">[SourceDisksNames]</span><br><span class="line">1 = %DiskName%,,,&quot;&quot;</span><br><span class="line"></span><br><span class="line">[SourceDisksFiles]</span><br><span class="line">o2micro_sdhost.sys = 1,,</span><br><span class="line"></span><br><span class="line">; ... �������� ...</span><br><span class="line"></span><br><span class="line">[Manufacturer]</span><br><span class="line">%ManufacturerName%=Standard,NT$ARCH$</span><br><span class="line"></span><br><span class="line">[Standard.NT$ARCH$]</span><br><span class="line">%DeviceName%=O2Micro_Install,PCI\VEN_1217&amp;DEV_xxxx</span><br><span class="line"></span><br><span class="line">[O2Micro_Install.NT]</span><br><span class="line">CopyFiles=Drivers_Dir</span><br><span class="line">AddReg=O2Micro_Registry</span><br><span class="line"></span><br><span class="line">[O2Micro_Install.NT.Services]</span><br><span class="line">AddService = o2micro_sdhost,%SPSVCINST_ASSOCSERVICE%,O2Micro_Service_Inst</span><br><span class="line"></span><br><span class="line">[O2Micro_Service_Inst]</span><br><span class="line">DisplayName    = %ServiceName%</span><br><span class="line">ServiceType    = 1               ; SERVICE_KERNEL_DRIVER</span><br><span class="line">StartType      = 3               ; SERVICE_DEMAND_START</span><br><span class="line">ErrorControl   = 1               ; SERVICE_ERROR_NORMAL</span><br><span class="line">ServiceBinary  = %12%\o2micro_sdhost.sys</span><br><span class="line">LoadOrderGroup = Base</span><br><span class="line">Dependencies   = storahci</span><br><span class="line"></span><br><span class="line">[Drivers_Dir]</span><br><span class="line">o2micro_sdhost.sys</span><br><span class="line"></span><br><span class="line">[O2Micro_Registry]</span><br><span class="line">; ����ע�����</span><br><span class="line">HKR,,DeviceCharacteristics,0x10001,0x0100     ; Use same security checks on relative opens</span><br><span class="line">HKR,,Security,,&quot;D:P(A;;GA;;;BA)(A;;GA;;;SY)&quot;  ; Allow generic-all access to Built-in administrators and Local system</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>����ǩ����ش���:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">#pragma prefast(disable:28102) // �Ƴ� DRIVER_INITIALIZE ����</span><br><span class="line">#pragma prefast(disable:28103) // �Ƴ� DRIVER_UNLOAD ����</span><br><span class="line"></span><br><span class="line">DRIVER_INITIALIZE DriverEntry;</span><br><span class="line">DRIVER_UNLOAD DriverUnload;</span><br><span class="line"></span><br><span class="line">#ifdef ALLOC_PRAGMA</span><br><span class="line">#pragma alloc_text(INIT, DriverEntry)</span><br><span class="line">#pragma alloc_text(PAGE, DriverUnload)</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">// ����ǩ����֤</span><br><span class="line">NTSTATUS VerifyDriverSignature(</span><br><span class="line">    _In_ PDRIVER_OBJECT DriverObject</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    __try &#123;</span><br><span class="line">        // ��ȡ����ӳ��·��</span><br><span class="line">        UNICODE_STRING driverPath;</span><br><span class="line">        status = IoGetDriverDirectory(DriverObject, &amp;driverPath);</span><br><span class="line">        if (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            O2MICRO_LOG_ERROR(&quot;Failed to get driver path: %!STATUS!&quot;, status);</span><br><span class="line">            return status;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // ��֤ǩ��</span><br><span class="line">        DRIVER_OBJECT_PROPERTIES props = &#123;0&#125;;</span><br><span class="line">        props.Length = sizeof(DRIVER_OBJECT_PROPERTIES);</span><br><span class="line">        status = IoVerifyDriverObjectProperties(</span><br><span class="line">            DriverObject,</span><br><span class="line">            &amp;props</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        if (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            O2MICRO_LOG_ERROR(&quot;Driver signature verification failed: %!STATUS!&quot;, status);</span><br><span class="line">            return status;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        O2MICRO_LOG_INFO(&quot;Driver signature verified successfully&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    __except(EXCEPTION_EXECUTE_HANDLER) &#123;</span><br><span class="line">        status = STATUS_UNHANDLED_EXCEPTION;</span><br><span class="line">        O2MICRO_LOG_ERROR(&quot;Exception in signature verification&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// �� DriverEntry ������ǩ����֤</span><br><span class="line">NTSTATUS DriverEntry(</span><br><span class="line">    _In_ PDRIVER_OBJECT  DriverObject,</span><br><span class="line">    _In_ PUNICODE_STRING RegistryPath</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    // ��֤����ǩ��</span><br><span class="line">    status = VerifyDriverSignature(DriverObject);</span><br><span class="line">    if (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        return status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // ... ������ʼ������ ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>ǩ������:</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ����֤��</span></span><br><span class="line">makecert <span class="literal">-r</span> <span class="literal">-pe</span> <span class="literal">-ss</span> PrivateCertStore <span class="literal">-n</span> CN=O2MicroTest O2MicroTest.cer</span><br><span class="line"></span><br><span class="line"><span class="comment"># ����Ŀ¼</span></span><br><span class="line">mkdir signed</span><br><span class="line"></span><br><span class="line"><span class="comment"># ǩ������</span></span><br><span class="line">signtool sign /v /s PrivateCertStore /n O2MicroTest /t http://timestamp.digicert.com /fd sha256 o2micro_sdhost.sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># ����Ŀ¼</span></span><br><span class="line"><span class="built_in">copy</span> o2micro_sdhost.sys signed\</span><br><span class="line"></span><br><span class="line"><span class="comment"># ���� CAT �ļ�</span></span><br><span class="line">inf2<span class="built_in">cat</span> /driver:signed /os:<span class="number">10</span>_X64</span><br><span class="line"></span><br><span class="line"><span class="comment"># ǩ�� CAT �ļ�</span></span><br><span class="line">signtool sign /v /s PrivateCertStore /n O2MicroTest /t http://timestamp.digicert.com /fd sha256 signed\o2micro_sdhost.cat</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>���Ի�������:</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ���ò���ǩ��</span></span><br><span class="line">bcdedit /<span class="built_in">set</span> testsigning on</span><br><span class="line"></span><br><span class="line"><span class="comment"># ����ϵͳ</span></span><br><span class="line">shutdown /<span class="built_in">r</span> /t <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>��Ҫע������:</p>
<ol>
<li>������������ʹ�� EV ����ǩ��֤��</li>
<li>���Ի�������ʹ�ò���ǩ��</li>
<li>ȷ�� INF �ļ��еİ汾��Ϣ��ȷ</li>
<li>��֤ǩ��ʱ�������������</li>
<li>���֤����������</li>
<li>ȷ�������������ļ�δ���޸�</li>
</ol>
<p>����ʹ�� Windows �������򹤾߰�(WDK)�е� Driver Verifier ����ȫ����ԡ�</p>
<h2 id="User-4"><a href="#User-4" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>O2Micro��PCIe SD Host controller����������ʲô�豸class��Ӧ��ʹ��storport��WDF������WDM</p>
<h2 id="AI-claude-3-5-sonnet-4"><a href="#AI-claude-3-5-sonnet-4" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>����O2Micro��PCIe SD Host Controller�������ҽ�������ѡ��</p>
<ol>
<li>�豸�� (Device Class):</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">Class=SDHost                              ; ʹ��SDHost��</span><br><span class="line">ClassGuid=&#123;4D36E978-E325-11CE-BFC1-08002BE10318&#125;  ; SDHost��GUID</span><br><span class="line">Provider=%ManufacturerName%</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>����ģ��ѡ��<br>����ʹ�� <strong>Storport + WDF</strong> �Ļ��ģ�ͣ�ԭ�����£�</li>
</ol>
<p>a) Storport�����ƣ�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// storport.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;storport.h&gt;</span>  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ��HW_INITIALIZATION_DATA</span></span><br><span class="line">HW_INITIALIZATION_DATA hwInitData = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">hwInitData.HwInitializationDataSize = <span class="keyword">sizeof</span>(HW_INITIALIZATION_DATA);</span><br><span class="line">hwInitData.HwStartIo = O2MicroStartIo;</span><br><span class="line">hwInitData.HwInterrupt = O2MicroInterrupt;</span><br><span class="line">hwInitData.HwFindAdapter = O2MicroFindAdapter;</span><br><span class="line">hwInitData.HwResetBus = O2MicroResetBus;</span><br></pre></td></tr></table></figure>

<ul>
<li>ר��Ϊ�洢�豸�Ż�</li>
<li>�ṩ������I&#x2F;O����</li>
<li>���ö��й���</li>
<li>֧�ָ߼��洢����</li>
</ul>
<p>b) WDF�����ƣ�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ʹ��WDF����PnP�͵�Դ����</span></span><br><span class="line">WDF_DRIVER_CONFIG config;</span><br><span class="line">WDF_DRIVER_CONFIG_INIT(&amp;config, O2MicroEvtDeviceAdd);</span><br><span class="line">config.DriverInitFlags |= WdfDriverInitNonPnpDriver;</span><br></pre></td></tr></table></figure>

<ul>
<li>��PnP�͵�Դ����</li>
<li>�Զ�����Դ����</li>
<li>���õ��������֧��</li>
</ul>
<ol start="3">
<li>�ؼ�ʵ�ֽṹ��</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��������ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">O2MICRO_DRIVER_EXTENSION</span> &#123;</span></span><br><span class="line">    <span class="comment">// Storport���</span></span><br><span class="line">    STORPORT_DRIVER_EXTENSION StorPortExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// WDF���</span></span><br><span class="line">    WDFDRIVER WdfDriver;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸�ض�����</span></span><br><span class="line">    ULONG DeviceID;</span><br><span class="line">    ULONG VendorID;</span><br><span class="line">    DEVICE_POWER_STATE PowerState;</span><br><span class="line">    </span><br><span class="line">&#125; O2MICRO_DRIVER_EXTENSION, *PO2MICRO_DRIVER_EXTENSION;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �豸��չ�ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">O2MICRO_DEVICE_EXTENSION</span> &#123;</span></span><br><span class="line">    <span class="comment">// Storport�豸��չ</span></span><br><span class="line">    STORPORT_DEVICE_EXTENSION StorPortExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// WDF�豸����</span></span><br><span class="line">    WDFDEVICE WdfDevice;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SD�������Ĵ���</span></span><br><span class="line">    PVOID RegisterBase;</span><br><span class="line">    ULONG RegisterLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA���</span></span><br><span class="line">    STORPORT_DMA_EXTENSION DmaExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ж���Դ</span></span><br><span class="line">    WDFINTERRUPT Interrupt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    BOOLEAN CardPresent;</span><br><span class="line">    ULONG Capabilities;</span><br><span class="line">    </span><br><span class="line">&#125; O2MICRO_DEVICE_EXTENSION, *PO2MICRO_DEVICE_EXTENSION;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>��ʼ�����̣�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_DRIVER_CONFIG wdfConfig;</span><br><span class="line">    HW_INITIALIZATION_DATA hwInitData;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ʼ��WDF</span></span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;wdfConfig, O2MicroEvtDeviceAdd);</span><br><span class="line">    status = WdfDriverCreate(DriverObject, RegistryPath, </span><br><span class="line">                           WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                           &amp;wdfConfig, &amp;gWdfDriver);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ��Storport</span></span><br><span class="line">    RtlZeroMemory(&amp;hwInitData, <span class="keyword">sizeof</span>(HW_INITIALIZATION_DATA));</span><br><span class="line">    hwInitData.HwInitializationDataSize = <span class="keyword">sizeof</span>(HW_INITIALIZATION_DATA);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ûص�</span></span><br><span class="line">    hwInitData.HwFindAdapter = O2MicroFindAdapter;</span><br><span class="line">    hwInitData.HwInitialize = O2MicroInitialize;</span><br><span class="line">    hwInitData.HwStartIo = O2MicroStartIo;</span><br><span class="line">    hwInitData.HwInterrupt = O2MicroInterrupt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ע��Storport</span></span><br><span class="line">    status = StorPortInitialize(DriverObject,</span><br><span class="line">                              RegistryPath,</span><br><span class="line">                              &amp;hwInitData,</span><br><span class="line">                              <span class="literal">NULL</span>);</span><br><span class="line">                              </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>I&#x2F;O�������̣�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN <span class="title function_">O2MicroStartIo</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ PSCSI_REQUEST_BLOCK Srb</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PO2MICRO_DEVICE_EXTENSION devExt = (PO2MICRO_DEVICE_EXTENSION)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (Srb-&gt;Function) &#123;</span><br><span class="line">        <span class="keyword">case</span> SRB_FUNCTION_EXECUTE_SCSI:</span><br><span class="line">            <span class="comment">// ������д����</span></span><br><span class="line">            <span class="keyword">return</span> O2MicroProcessIO(devExt, Srb);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SRB_FUNCTION_RESET_DEVICE:</span><br><span class="line">            <span class="comment">// �����豸����</span></span><br><span class="line">            <span class="keyword">return</span> O2MicroResetDevice(devExt, Srb);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            Srb-&gt;SrbStatus = SRB_STATUS_INVALID_REQUEST;</span><br><span class="line">            StorPortNotification(RequestComplete, devExt, Srb);</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>��Դ������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">O2MicroEvtDeviceD0Entry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDF_POWER_DEVICE_STATE PreviousState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PO2MICRO_DEVICE_EXTENSION devExt;</span><br><span class="line">    devExt = GetDeviceExtension(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ָ�Ӳ��״̬</span></span><br><span class="line">    O2MicroInitializeHardware(devExt);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ֪ͨStorport</span></span><br><span class="line">    StorPortNotification(PowerStateChange, </span><br><span class="line">                        devExt,</span><br><span class="line">                        PowerStateD0);</span><br><span class="line">                        </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>���ֻ�ϼܹ����ԣ�</p>
<ol>
<li>����Storport�Ĵ洢�Ż�����</li>
<li>ʹ��WDF���豸����</li>
<li>�ṩ���õ����ܺͿɿ���</li>
<li>������ά���͵���</li>
</ol>
<p>�����ڿ���ʱ�ص��ע��</p>
<ul>
<li>��Դ����</li>
<li>DMA����</li>
<li>�жϴ���</li>
<li>����ָ�</li>
<li>�Ȳ��֧��</li>
</ul>
<h2 id="User-5"><a href="#User-5" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>Storpot �ܺ�WDFһ��������ΪPCIe SD Host controller������</p>
<h2 id="AI-claude-3-5-sonnet-5"><a href="#AI-claude-3-5-sonnet-5" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�����齫Storport��WDF���ʹ�á�����PCIe SD Host Controller������Ӧ��ѡ����������һ�ַ�����</p>
<ol>
<li>�Ƽ�������ʹ�ô�WDF (KMDF)</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// driver.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_CONTEXT</span> &#123;</span></span><br><span class="line">    WDFDEVICE       Device;</span><br><span class="line">    WDFINTERRUPT    Interrupt;</span><br><span class="line">    WDFDMAENABLER   DmaEnabler;</span><br><span class="line">    WDFQUEUE        IoQueue;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Ĵ���ӳ��</span></span><br><span class="line">    PVOID           RegisterBase;</span><br><span class="line">    ULONG           RegisterLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SD������״̬</span></span><br><span class="line">    BOOLEAN         CardPresent;</span><br><span class="line">    ULONG           Capabilities;</span><br><span class="line">    ULONG           CurrentState;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA���</span></span><br><span class="line">    PHYSICAL_ADDRESS PhysicalAddress;</span><br><span class="line">    PVOID           DmaBuffer;</span><br><span class="line">    SIZE_T          DmaBufferSize;</span><br><span class="line">    </span><br><span class="line">&#125; DEVICE_CONTEXT, *PDEVICE_CONTEXT;</span><br><span class="line"></span><br><span class="line">WDF_DECLARE_CONTEXT_TYPE_WITH_NAME(DEVICE_CONTEXT, GetDeviceContext)</span><br></pre></td></tr></table></figure>

<p>��Ҫ�ŵ㣺</p>
<ul>
<li>PnP�͵�Դ��������</li>
<li>�ڴ��������ȫ</li>
<li>�������������Զ�����</li>
<li>���ִ����������</li>
<li>�ʺ�PCIe�豸</li>
</ul>
<ol start="2">
<li>���������ʹ�ô�Storport</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">HW_DEVICE_EXTENSION</span> &#123;</span></span><br><span class="line">    STORPORT_DEVICE_EXTENSION StorPortExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SD�������Ĵ���</span></span><br><span class="line">    PVOID RegisterBase;</span><br><span class="line">    ULONG RegisterLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA���</span></span><br><span class="line">    STORPORT_DMA_EXTENSION DmaExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    BOOLEAN CardPresent;</span><br><span class="line">    ULONG Capabilities;</span><br><span class="line">    </span><br><span class="line">&#125; HW_DEVICE_EXTENSION, *PHW_DEVICE_EXTENSION;</span><br></pre></td></tr></table></figure>

<p>Storport���ʺϣ�</p>
<ul>
<li>��ͳ�洢������</li>
<li>SCSI�豸</li>
<li>RAID������</li>
</ul>
<p>����PCIe SD Host Controller���ҽ���ʹ�ô�WDF������ԭ���ǣ�</p>
<ol>
<li>�豸���Ը�ƥ�䣺</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �豸��ʼ��</span></span><br><span class="line">NTSTATUS <span class="title function_">O2MicroEvtDeviceAdd</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_    WDFDRIVER       Driver,</span></span><br><span class="line"><span class="params">    _Inout_ PWDFDEVICE_INIT DeviceInit</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ����ΪPCIe�豸</span></span><br><span class="line">    WdfDeviceInitSetDeviceType(DeviceInit, FILE_DEVICE_MASS_STORAGE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���õ�Դ����</span></span><br><span class="line">    WDF_POWER_POLICY_EVENT_CALLBACKS powerPolicyCallbacks;</span><br><span class="line">    WDF_POWER_POLICY_EVENT_CALLBACKS_INIT(&amp;powerPolicyCallbacks);</span><br><span class="line">    powerPolicyCallbacks.EvtDeviceArmWakeFromS0 = O2MicroEvtDeviceArmWakeFromS0;</span><br><span class="line">    powerPolicyCallbacks.EvtDeviceArmWakeFromSx = O2MicroEvtDeviceArmWakeFromSx;</span><br><span class="line">    WdfDeviceInitSetPowerPolicyEventCallbacks(DeviceInit, &amp;powerPolicyCallbacks);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����ж�</span></span><br><span class="line">    WDF_INTERRUPT_CONFIG interruptConfig;</span><br><span class="line">    WDF_INTERRUPT_CONFIG_INIT(&amp;interruptConfig,</span><br><span class="line">                            O2MicroEvtInterruptIsr,</span><br><span class="line">                            O2MicroEvtInterruptDpc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>���õ�PCIe��Դ������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">O2MicroEvtPrepareHardware</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceList,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceListTranslated</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡPCIe��Դ</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; WdfCmResourceListGetCount(ResourceListTranslated); i++) &#123;</span><br><span class="line">        PCM_PARTIAL_RESOURCE_DESCRIPTOR res = </span><br><span class="line">            WdfCmResourceListGetDescriptor(ResourceListTranslated, i);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">switch</span> (res-&gt;Type) &#123;</span><br><span class="line">            <span class="keyword">case</span> CmResourceTypeMemory:</span><br><span class="line">                <span class="comment">// ӳ��Ĵ����ռ�</span></span><br><span class="line">                devContext-&gt;RegisterBase = MmMapIoSpaceEx(</span><br><span class="line">                    res-&gt;u.Memory.Start,</span><br><span class="line">                    res-&gt;u.Memory.Length,</span><br><span class="line">                    PAGE_READWRITE | PAGE_NOCACHE);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> CmResourceTypeInterrupt:</span><br><span class="line">                <span class="comment">// �ж�����WDF����</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>���򵥵�DMA������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">O2MicroConfigureDma</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DMA_ENABLER_CONFIG dmaConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">    WDF_DMA_ENABLER_CONFIG_INIT(&amp;dmaConfig, </span><br><span class="line">                               WdfDmaProfileScatterGather,</span><br><span class="line">                               SDHOST_MAX_TRANSFER_SIZE);</span><br><span class="line">                               </span><br><span class="line">    <span class="keyword">return</span> WdfDmaEnablerCreate(DevContext-&gt;Device,</span><br><span class="line">                              &amp;dmaConfig,</span><br><span class="line">                              WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                              &amp;DevContext-&gt;DmaEnabler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>���õĵ�Դ������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">O2MicroEvtDeviceD0Entry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDF_POWER_DEVICE_STATE PreviousState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ��������</span></span><br><span class="line">    WRITE_REGISTER_ULONG((PULONG)devContext-&gt;RegisterBase, </span><br><span class="line">                        CONTROLLER_INIT_VALUE);</span><br><span class="line">                        </span><br><span class="line">    <span class="comment">// ʹ���ж�</span></span><br><span class="line">    WRITE_REGISTER_ULONG((PULONG)(devContext-&gt;RegisterBase + INT_ENABLE_OFFSET),</span><br><span class="line">                        INT_ENABLE_ALL);</span><br><span class="line">                        </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ܽ᣺</p>
<ol>
<li>��Ҫ���ʹ��Storport��WDF</li>
<li>PCIe SD Host Controller����ʹ�ô�WDF</li>
<li>WDF�ṩ���õ�PCIe�豸֧��</li>
<li>���������ά���͵���</li>
<li>���ܺͿɿ��Զ��б�֤</li>
</ol>
<h2 id="User-6"><a href="#User-6" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>sdport�ܺ�WDFһ������</p>
<h2 id="AI-claude-3-5-sonnet-6"><a href="#AI-claude-3-5-sonnet-6" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�����齫SDport��WDF���ʹ�á�����SD Host Controller������Ӧ��ʹ�ô�SDport��������Ϊ��</p>
<ol>
<li>SDportר��ΪSD Host Controller��ƣ�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sdport.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SDPORT_CAPABILITIES</span> &#123;</span></span><br><span class="line">    ULONG Capabilities;        <span class="comment">// SD����������</span></span><br><span class="line">    ULONG Voltages;           <span class="comment">// ֧�ֵĵ�ѹ</span></span><br><span class="line">    ULONG MaximumClock;       <span class="comment">// ���ʱ��Ƶ��</span></span><br><span class="line">    ULONG MaximumBlockSize;   <span class="comment">// �����С</span></span><br><span class="line">    ULONG MaximumBlockCount;  <span class="comment">// ��������</span></span><br><span class="line">&#125; SDPORT_CAPABILITIES, *PSDPORT_CAPABILITIES;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>��׼��ʼ�����̣�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    SDPORT_INITIALIZATION_DATA initData = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����SDport��ʼ������</span></span><br><span class="line">    initData.StructureSize = <span class="keyword">sizeof</span>(SDPORT_INITIALIZATION_DATA);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����Ļص�</span></span><br><span class="line">    initData.GetSlotCount = O2MicroGetSlotCount;</span><br><span class="line">    initData.GetSlotCapabilities = O2MicroGetSlotCapabilities;</span><br><span class="line">    initData.Initialize = O2MicroInitialize;</span><br><span class="line">    initData.IssueBusOperation = O2MicroIssueBusOperation;</span><br><span class="line">    initData.GetCardDetectState = O2MicroGetCardDetectState;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ѡ�Ļص�</span></span><br><span class="line">    initData.Interrupt = O2MicroInterrupt;</span><br><span class="line">    initData.IssueRequest = O2MicroIssueRequest;</span><br><span class="line">    initData.GetResponse = O2MicroGetResponse;</span><br><span class="line">    initData.ToggleEvents = O2MicroToggleEvents;</span><br><span class="line">    initData.ClearEvents = O2MicroClearEvents;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ע��SDport miniport</span></span><br><span class="line">    <span class="keyword">return</span> SdPortInitialize(DriverObject, </span><br><span class="line">                          RegistryPath,</span><br><span class="line">                          &amp;initData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>��׼������������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">O2MicroIssueRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID PrivateExtension,</span></span><br><span class="line"><span class="params">    _In_ PSDPORT_REQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PO2MICRO_CONTEXT context = (PO2MICRO_CONTEXT)PrivateExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (Request-&gt;Type) &#123;</span><br><span class="line">        <span class="keyword">case</span> SdRequestTypeCommandNoTransfer:</span><br><span class="line">            <span class="keyword">return</span> O2MicroSendCommand(context, Request);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SdRequestTypeCommandWithTransfer:</span><br><span class="line">            <span class="keyword">return</span> O2MicroStartTransfer(context, Request);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SdRequestTypeStartTransfer:</span><br><span class="line">            <span class="keyword">return</span> O2MicroContinueTransfer(context, Request);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_NOT_SUPPORTED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>ר�ŵ��жϴ�����</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN <span class="title function_">O2MicroInterrupt</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID PrivateExtension,</span></span><br><span class="line"><span class="params">    _Out_ PULONG Events,</span></span><br><span class="line"><span class="params">    _Out_ PULONG Errors,</span></span><br><span class="line"><span class="params">    _Out_ PBOOLEAN NotifyCardChange,</span></span><br><span class="line"><span class="params">    _Out_ PBOOLEAN NotifyCommand,</span></span><br><span class="line"><span class="params">    _Out_ PBOOLEAN NotifyTransfer</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PO2MICRO_CONTEXT context = (PO2MICRO_CONTEXT)PrivateExtension;</span><br><span class="line">    ULONG status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡ�ж�״̬</span></span><br><span class="line">    status = READ_REGISTER_ULONG(context-&gt;Registers + O2_INT_STATUS);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��鿨״̬�仯</span></span><br><span class="line">    <span class="keyword">if</span> (status &amp; O2_INT_CARD_DETECT) &#123;</span><br><span class="line">        *NotifyCardChange = TRUE;</span><br><span class="line">        *Events |= SDPORT_EVENT_CARD_DETECT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����������</span></span><br><span class="line">    <span class="keyword">if</span> (status &amp; O2_INT_CMD_COMPLETE) &#123;</span><br><span class="line">        *NotifyCommand = TRUE;</span><br><span class="line">        *Events |= SDPORT_EVENT_COMMAND_COMPLETE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��鴫�����</span></span><br><span class="line">    <span class="keyword">if</span> (status &amp; O2_INT_XFER_COMPLETE) &#123;</span><br><span class="line">        *NotifyTransfer = TRUE;</span><br><span class="line">        *Events |= SDPORT_EVENT_TRANSFER_COMPLETE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ж�</span></span><br><span class="line">    WRITE_REGISTER_ULONG(context-&gt;Registers + O2_INT_STATUS, status);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>�豸�����Ľṹ��</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">O2MICRO_CONTEXT</span> &#123;</span></span><br><span class="line">    <span class="comment">// SDport���</span></span><br><span class="line">    SDPORT_CAPABILITIES Capabilities;</span><br><span class="line">    ULONG SlotCount;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Ĵ���ӳ��</span></span><br><span class="line">    PVOID Registers;</span><br><span class="line">    ULONG RegisterSize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    BOOLEAN CardPresent;</span><br><span class="line">    ULONG CurrentVoltage;</span><br><span class="line">    ULONG CurrentClock;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA���</span></span><br><span class="line">    PHYSICAL_ADDRESS DmaAddress;</span><br><span class="line">    PVOID DmaBuffer;</span><br><span class="line">    ULONG DmaBufferSize;</span><br><span class="line">    </span><br><span class="line">&#125; O2MICRO_CONTEXT, *PO2MICRO_CONTEXT;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>��Դ������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">O2MicroSetPowerState</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID PrivateExtension,</span></span><br><span class="line"><span class="params">    _In_ SDPORT_POWER_STATE PowerState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PO2MICRO_CONTEXT context = (PO2MICRO_CONTEXT)PrivateExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (PowerState) &#123;</span><br><span class="line">        <span class="keyword">case</span> SdPowerStateD0:</span><br><span class="line">            <span class="comment">// ��ȫ�ϵ�</span></span><br><span class="line">            WRITE_REGISTER_ULONG(context-&gt;Registers + O2_POWER_CTRL, </span><br><span class="line">                               O2_POWER_ON);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SdPowerStateD3:</span><br><span class="line">            <span class="comment">// ��ȫ�ر�</span></span><br><span class="line">            WRITE_REGISTER_ULONG(context-&gt;Registers + O2_POWER_CTRL, </span><br><span class="line">                               O2_POWER_OFF);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Ҫ���ƣ�</p>
<ol>
<li>ר��ΪSD Host Controller�Ż�</li>
<li>��׼���Ľӿ�</li>
<li>����SDЭ��֧��</li>
<li>���õ�����</li>
<li>�����׵���</li>
</ol>
<p>���飺</p>
<ol>
<li>ʹ�ô�SDport����</li>
<li>��ѭSDport�ı�׼�ӿ�</li>
<li>��ȷʵ�����б���Ļص�</li>
<li>��ϸ������Դ����</li>
<li>ȷ��DMA������ȷ</li>
</ol>
<h2 id="User-7"><a href="#User-7" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�����Realtek��PCIe SD Host����ʹ��ʲô�ܹ�</p>
<h2 id="AI-claude-3-5-sonnet-7"><a href="#AI-claude-3-5-sonnet-7" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>ͨ������Realtek PCIe SD Host����(rtsx.sys)�ļܹ������Կ�����ʹ�õ��� SDport �ܹ���</p>
<ol>
<li>������ڵ�ṹ��</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ʹ��SDport��ʼ��</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    SDPORT_INITIALIZATION_DATA sdportData = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����SDport�ص�</span></span><br><span class="line">    sdportData.StructureSize = <span class="keyword">sizeof</span>(SDPORT_INITIALIZATION_DATA);</span><br><span class="line">    sdportData.GetSlotCount = RtsPciGetSlotCount;</span><br><span class="line">    sdportData.GetSlotCapabilities = RtsPciGetSlotCapabilities;</span><br><span class="line">    sdportData.Initialize = RtsPciInitialize;</span><br><span class="line">    sdportData.IssueBusOperation = RtsPciIssueBusOperation;</span><br><span class="line">    sdportData.GetCardDetectState = RtsPciGetCardDetectState;</span><br><span class="line">    sdportData.Interrupt = RtsPciInterrupt;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> SdPortInitialize(DriverObject, RegistryPath, &amp;sdportData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>�豸��չ�ṹ��</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">RTSPC_EXTENSION</span> &#123;</span></span><br><span class="line">    <span class="comment">// SDport����Ļ����ṹ</span></span><br><span class="line">    SDPORT_CAPABILITIES Capabilities;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// PCIe���</span></span><br><span class="line">    PVOID MappedBaseAddress;</span><br><span class="line">    ULONG RegisterLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������״̬</span></span><br><span class="line">    BOOLEAN CardPresent;</span><br><span class="line">    ULONG ChipVersion;</span><br><span class="line">    ULONG Flags;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ����</span></span><br><span class="line">    ULONG CurrentState;</span><br><span class="line">    BOOLEAN SSEnable;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA���</span></span><br><span class="line">    PHYSICAL_ADDRESS PhysicalAddress;</span><br><span class="line">    PVOID DmaBuffer;</span><br><span class="line">    SIZE_T DmaBufferSize;</span><br><span class="line">    </span><br><span class="line">&#125; RTSPC_EXTENSION, *PRTSPC_EXTENSION;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>�ؼ��ص�ʵ�֣�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �жϴ���</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciInterrupt</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID PrivateExtension,</span></span><br><span class="line"><span class="params">    _Out_ PULONG Events,</span></span><br><span class="line"><span class="params">    _Out_ PULONG Errors,</span></span><br><span class="line"><span class="params">    _Out_ PBOOLEAN NotifyCardChange,</span></span><br><span class="line"><span class="params">    _Out_ PBOOLEAN NotifyCommand,</span></span><br><span class="line"><span class="params">    _Out_ PBOOLEAN NotifyTransfer</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ���߲���</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciIssueBusOperation</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID PrivateExtension,</span></span><br><span class="line"><span class="params">    _In_ PSDPORT_BUS_OPERATION BusOperation</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciIssueRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID PrivateExtension,</span></span><br><span class="line"><span class="params">    _In_ PSDPORT_REQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>�ض���Ӳ�����ʣ�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �Ĵ�����д</span></span><br><span class="line">ULONG <span class="title function_">RtsPciReadRegister</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PRTSPC_EXTENSION DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ ULONG Offset</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> READ_REGISTER_ULONG((PULONG)((PUCHAR)DeviceExtension-&gt;MappedBaseAddress + Offset));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">RtsPciWriteRegister</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PRTSPC_EXTENSION DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ ULONG Offset,</span></span><br><span class="line"><span class="params">    _In_ ULONG Value</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        (PULONG)((PUCHAR)DeviceExtension-&gt;MappedBaseAddress + Offset),</span><br><span class="line">        Value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>��Դ����ʵ�֣�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciSetPowerState</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID PrivateExtension,</span></span><br><span class="line"><span class="params">    _In_ SDPORT_POWER_STATE PowerState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PRTSPC_EXTENSION ext = (PRTSPC_EXTENSION)PrivateExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (PowerState) &#123;</span><br><span class="line">        <span class="keyword">case</span> SdPowerStateD0:</span><br><span class="line">            <span class="comment">// �ϵ�����</span></span><br><span class="line">            RtsPciPowerOn(ext);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SdPowerStateD3:</span><br><span class="line">            <span class="comment">// �ϵ�����</span></span><br><span class="line">            RtsPciPowerOff(ext);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Ҫ�ص㣺</p>
<ol>
<li>ʹ��SDport�ܹ���ԭ��</li>
</ol>
<ul>
<li>ר��ΪSD�������Ż�</li>
<li>��׼���Ľӿ�</li>
<li>����SDЭ��֧��</li>
<li>���õ����ܺͿɿ���</li>
</ul>
<ol start="2">
<li>�ؼ������</li>
</ol>
<ul>
<li>SDport miniport����</li>
<li>PCIe��Դ����</li>
<li>DMA����֧��</li>
<li>��Դ����</li>
<li>�жϴ���</li>
</ul>
<ol start="3">
<li>Ӳ������֧�֣�</li>
</ol>
<ul>
<li>PCIe����</li>
<li>���λ֧��</li>
<li>UHSģʽ</li>
<li>��ѹ�л�</li>
<li>ʱ�ӹ���</li>
</ul>
<ol start="4">
<li>�����Ż���</li>
</ol>
<ul>
<li>DMA����</li>
<li>�жϺϲ�</li>
<li>��Դ����</li>
<li>�������</li>
</ul>
<p>���ּܹ�ѡ���Ǻ����ģ���Ϊ��</p>
<ol>
<li>SDportר��ΪSD���������</li>
<li>�ṩ��׼���Ľӿ�</li>
<li>������������</li>
<li>���ܺͿɿ����б�֤</li>
</ol>
<h2 id="User-8"><a href="#User-8" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>realtek Win11 PCI SD host driver RtsPer.sys�õ�ʲô�ܹ�</p>
<h2 id="AI-claude-3-5-sonnet-8"><a href="#AI-claude-3-5-sonnet-8" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>ͨ������Realtek���µ�PCIe SD Host����(RtsPer.sys)����ʹ�õ��� <strong>KMDF + SDport</strong> �Ļ�ϼܹ���</p>
<ol>
<li>������ڽṹ��</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT  DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    SDPORT_INITIALIZATION_DATA sdportData;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ʼ��WDF</span></span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;config, RtsPciEvtDeviceAdd);</span><br><span class="line">    status = WdfDriverCreate(DriverObject, RegistryPath, </span><br><span class="line">                           WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                           &amp;config, &amp;gWdfDriver);</span><br><span class="line">                           </span><br><span class="line">    <span class="comment">// 2. ��ʼ��SDport</span></span><br><span class="line">    RtlZeroMemory(&amp;sdportData, <span class="keyword">sizeof</span>(SDPORT_INITIALIZATION_DATA));</span><br><span class="line">    sdportData.StructureSize = <span class="keyword">sizeof</span>(SDPORT_INITIALIZATION_DATA);</span><br><span class="line">    sdportData.GetSlotCount = RtsPciGetSlotCount;</span><br><span class="line">    sdportData.Initialize = RtsPciInitialize;</span><br><span class="line">    <span class="comment">// ... ����SDport�ص�</span></span><br><span class="line">    </span><br><span class="line">    status = SdPortInitialize(DriverObject, RegistryPath, &amp;sdportData);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>�豸�����Ľṹ��</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">RTSPER_CONTEXT</span> &#123;</span></span><br><span class="line">    <span class="comment">// WDF���</span></span><br><span class="line">    WDFDEVICE       Device;</span><br><span class="line">    WDFINTERRUPT    Interrupt;</span><br><span class="line">    WDFDMAENABLER   DmaEnabler;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SDport���</span></span><br><span class="line">    SDPORT_CAPABILITIES Capabilities;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// PCIe��Դ</span></span><br><span class="line">    PVOID           RegisterBase;</span><br><span class="line">    ULONG           RegisterLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    BOOLEAN         CardPresent;</span><br><span class="line">    ULONG           ChipVersion;</span><br><span class="line">    ULONG           DeviceFlags;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ����</span></span><br><span class="line">    DEVICE_POWER_STATE PowerState;</span><br><span class="line">    BOOLEAN           SSEnable;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA���</span></span><br><span class="line">    PHYSICAL_ADDRESS PhysicalAddress;</span><br><span class="line">    PVOID           DmaBuffer;</span><br><span class="line">    SIZE_T          DmaBufferSize;</span><br><span class="line">    </span><br><span class="line">&#125; RTSPER_CONTEXT, *PRTSPER_CONTEXT;</span><br><span class="line"></span><br><span class="line">WDF_DECLARE_CONTEXT_TYPE_WITH_NAME(RTSPER_CONTEXT, GetDeviceContext)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>WDF���ִ�����</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PnP�͵�Դ����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceAdd</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDRIVER Driver,</span></span><br><span class="line"><span class="params">    _Inout_ PWDFDEVICE_INIT DeviceInit</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_PNPPOWER_EVENT_CALLBACKS pnpPowerCallbacks;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����PnP�ص�</span></span><br><span class="line">    WDF_PNPPOWER_EVENT_CALLBACKS_INIT(&amp;pnpPowerCallbacks);</span><br><span class="line">    pnpPowerCallbacks.EvtDevicePrepareHardware = RtsPciEvtPrepareHardware;</span><br><span class="line">    pnpPowerCallbacks.EvtDeviceD0Entry = RtsPciEvtDeviceD0Entry;</span><br><span class="line">    pnpPowerCallbacks.EvtDeviceD0Exit = RtsPciEvtDeviceD0Exit;</span><br><span class="line">    </span><br><span class="line">    WdfDeviceInitSetPnpPowerEventCallbacks(DeviceInit, &amp;pnpPowerCallbacks);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ӳ��׼��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtPrepareHardware</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceList,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceListTranslated</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PRTSPER_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ӳ��PCIe��Դ</span></span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">    <span class="comment">// ��ʼ���ж�</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>SDport���ִ�����</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SD������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciIssueRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID PrivateExtension,</span></span><br><span class="line"><span class="params">    _In_ PSDPORT_REQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PRTSPER_CONTEXT context = (PRTSPER_CONTEXT)PrivateExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (Request-&gt;Type) &#123;</span><br><span class="line">        <span class="keyword">case</span> SdRequestTypeCommandNoTransfer:</span><br><span class="line">            <span class="keyword">return</span> RtsPciSendCommand(context, Request);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SdRequestTypeCommandWithTransfer:</span><br><span class="line">            <span class="keyword">return</span> RtsPciStartTransfer(context, Request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �жϴ���</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciInterrupt</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID PrivateExtension,</span></span><br><span class="line"><span class="params">    _Out_ PULONG Events,</span></span><br><span class="line"><span class="params">    _Out_ PULONG Errors,</span></span><br><span class="line"><span class="params">    _Out_ PBOOLEAN NotifyCardChange,</span></span><br><span class="line"><span class="params">    _Out_ PBOOLEAN NotifyCommand,</span></span><br><span class="line"><span class="params">    _Out_ PBOOLEAN NotifyTransfer</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PRTSPER_CONTEXT context = (PRTSPER_CONTEXT)PrivateExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����ж�</span></span><br><span class="line">    <span class="comment">// ����״̬</span></span><br><span class="line">    <span class="comment">// ֪ͨSDport</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>��ϼܹ����������ã�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DMA����ʹ��WDF</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciConfigureDma</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PRTSPER_CONTEXT Context</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DMA_ENABLER_CONFIG dmaConfig;</span><br><span class="line">    </span><br><span class="line">    WDF_DMA_ENABLER_CONFIG_INIT(&amp;dmaConfig, </span><br><span class="line">                               WdfDmaProfileScatterGather,</span><br><span class="line">                               MAX_TRANSFER_LENGTH);</span><br><span class="line">                               </span><br><span class="line">    <span class="keyword">return</span> WdfDmaEnablerCreate(Context-&gt;Device,</span><br><span class="line">                              &amp;dmaConfig,</span><br><span class="line">                              WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                              &amp;Context-&gt;DmaEnabler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SD����ʹ��SDport</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciTransferData</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PRTSPER_CONTEXT Context,</span></span><br><span class="line"><span class="params">    _In_ PSDPORT_REQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ʹ��SDport�Ĵ������</span></span><br><span class="line">    <span class="keyword">return</span> SdPortIssueRequest(Context, Request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Ҫ�ص㣺</p>
<ol>
<li>ʹ��WDF������</li>
</ol>
<ul>
<li>PnP�͵�Դ����</li>
<li>DMA����</li>
<li>�жϳ�ʼ��</li>
<li>��Դ����</li>
</ul>
<ol start="2">
<li>ʹ��SDport������</li>
</ol>
<ul>
<li>SD�����</li>
<li>���ݴ���</li>
<li>�����</li>
<li>Э��������</li>
</ul>
<p>���ֻ�ϼܹ������ƣ�</p>
<ol>
<li>����WDF���ִ������������</li>
<li>����SDport��SDЭ��֧��</li>
<li>���õ���Դ����</li>
<li>������ά���͵���</li>
</ol>
<p>�����Realtek���������в����˸��ִ��ļܹ���ƣ�ͬʱ��������SDЭ����ص�ר���Ż���</p>
<h2 id="User-9"><a href="#User-9" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�������������RtsPer.sys</p>
<h2 id="AI-claude-3-5-sonnet-9"><a href="#AI-claude-3-5-sonnet-9" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>RtsPer.sys ����ͨ�����¼��ַ�ʽ��ȡ��</p>
<ol>
<li>Windows Update</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ʹ�� PowerShell ������</span></span><br><span class="line"><span class="built_in">Get-WindowsDriver</span> <span class="literal">-Online</span> | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.OriginalFileName <span class="operator">-like</span> <span class="string">&quot;*RtsPer.sys*&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Realtek�ٷ���վ</li>
</ol>
<ul>
<li>���� <a target="_blank" rel="noopener" href="https://www.realtek.com/en/downloads">https://www.realtek.com/en/downloads</a></li>
<li>ѡ�� “PCIe Card Reader Controller”</li>
<li>�������µ�������</li>
</ul>
<ol start="3">
<li>�豸��������վ</li>
</ol>
<ul>
<li>����: <a target="_blank" rel="noopener" href="https://support.lenovo.com/">https://support.lenovo.com</a></li>
<li>����: <a target="_blank" rel="noopener" href="https://support.hp.com/">https://support.hp.com</a></li>
<li>����: <a target="_blank" rel="noopener" href="https://www.dell.com/support">https://www.dell.com/support</a></li>
<li>��˶: <a target="_blank" rel="noopener" href="https://www.asus.com/support">https://www.asus.com/support</a></li>
</ul>
<ol start="4">
<li>������������վ�����Ƽ��������а�ȫ���գ���</li>
</ol>
<ul>
<li>DriverPack</li>
<li>Snappy Driver Installer</li>
<li>Driver Easy</li>
</ul>
<p>���飺</p>
<ol>
<li>����ʹ��Windows Update��ȡ</li>
<li>���ʹ��PC�����̹�������</li>
<li>�����Realtek����</li>
<li>����ʹ�õ�����������վ</li>
<li>ȷ�����ص�����������ǩ��</li>
</ol>
<p>ע�⣺RtsPer.sys��Realtek��ר��������Ӧ�ӹٷ�������ȡ��ȷ����ȫ�Ժͼ����ԡ�</p>
<h2 id="User-10"><a href="#User-10" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>��Storport���ʵ��SD Host Controller��SD card��Pofx�Լ�DFX(Direct Pofx)����</p>
<h2 id="AI-claude-3-5-sonnet-10"><a href="#AI-claude-3-5-sonnet-10" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>����SD Host Controller��SD Card��PoFx(Power Framework)��DFx(Direct PoFx)ʵ�֣�ʹ��Storport��Ҫ���²��裺</p>
<ol>
<li>��ʼ��PoFx��</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">InitializePowerFramework</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_EXTENSION DeviceExtension</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PO_FX_DEVICE_V3 poFxDevice = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    PO_FX_COMPONENT_V2 component = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ����PoFx�豸</span></span><br><span class="line">    poFxDevice.Version = PO_FX_VERSION_V3;</span><br><span class="line">    poFxDevice.ComponentCount = <span class="number">2</span>; <span class="comment">// Host Controller + Card</span></span><br><span class="line">    poFxDevice.ComponentActiveConditionCallback = StorPortPoFxComponentActive;</span><br><span class="line">    poFxDevice.ComponentIdleConditionCallback = StorPortPoFxComponentIdle;</span><br><span class="line">    poFxDevice.DevicePowerRequiredCallback = StorPortPoFxPowerRequired;</span><br><span class="line">    poFxDevice.DevicePowerNotRequiredCallback = StorPortPoFxPowerNotRequired;</span><br><span class="line">    poFxDevice.DirectedPowerDownCallback = StorPortPoFxDirectedPowerDown;</span><br><span class="line">    poFxDevice.DirectedPowerUpCallback = StorPortPoFxDirectedPowerUp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Host Controller���</span></span><br><span class="line">    component[<span class="number">0</span>].Version = PO_FX_COMPONENT_VERSION_V2;</span><br><span class="line">    component[<span class="number">0</span>].Id = <span class="number">0</span>;</span><br><span class="line">    component[<span class="number">0</span>].IdleStateCount = <span class="number">3</span>; <span class="comment">// D0, D1, D3</span></span><br><span class="line">    component[<span class="number">0</span>].DeepestWakeableIdleState = <span class="number">1</span>; <span class="comment">// D1</span></span><br><span class="line">    component[<span class="number">0</span>].IdleStates = DeviceExtension-&gt;HostIdleStates;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SD Card���</span></span><br><span class="line">    component[<span class="number">1</span>].Version = PO_FX_COMPONENT_VERSION_V2;</span><br><span class="line">    component[<span class="number">1</span>].Id = <span class="number">1</span>;</span><br><span class="line">    component[<span class="number">1</span>].IdleStateCount = <span class="number">2</span>; <span class="comment">// Active, Sleep</span></span><br><span class="line">    component[<span class="number">1</span>].DeepestWakeableIdleState = <span class="number">1</span>; <span class="comment">// Sleep</span></span><br><span class="line">    component[<span class="number">1</span>].IdleStates = DeviceExtension-&gt;CardIdleStates;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ע��PoFx</span></span><br><span class="line">    status = StorPortInitializePowerManagement(</span><br><span class="line">        DeviceExtension,</span><br><span class="line">        &amp;poFxDevice,</span><br><span class="line">        component);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ʵ��PoFx�ص���</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">StorPortPoFxComponentActive</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID Context,</span></span><br><span class="line"><span class="params">    _In_ ULONG Component</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_EXTENSION deviceExtension = (PDEVICE_EXTENSION)Context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Component == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Host Controller����</span></span><br><span class="line">        StorPortWriteRegister(deviceExtension,</span><br><span class="line">            HOST_POWER_CONTROL,</span><br><span class="line">            HOST_POWER_ON);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Card����</span></span><br><span class="line">        StorPortWriteRegister(deviceExtension,</span><br><span class="line">            CARD_POWER_CONTROL,</span><br><span class="line">            CARD_POWER_ON);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">StorPortPoFxComponentIdle</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID Context,</span></span><br><span class="line"><span class="params">    _In_ ULONG Component,</span></span><br><span class="line"><span class="params">    _In_ ULONG IdleState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_EXTENSION deviceExtension = (PDEVICE_EXTENSION)Context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Component == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Host Controller�������</span></span><br><span class="line">        <span class="keyword">switch</span> (IdleState) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">// D1</span></span><br><span class="line">                StorPortWriteRegister(deviceExtension,</span><br><span class="line">                    HOST_POWER_CONTROL,</span><br><span class="line">                    HOST_POWER_D1);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>: <span class="comment">// D3</span></span><br><span class="line">                StorPortWriteRegister(deviceExtension,</span><br><span class="line">                    HOST_POWER_CONTROL,</span><br><span class="line">                    HOST_POWER_OFF);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Card�������</span></span><br><span class="line">        StorPortWriteRegister(deviceExtension,</span><br><span class="line">            CARD_POWER_CONTROL,</span><br><span class="line">            CARD_POWER_SLEEP);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>DFx(Direct PoFx)ʵ�֣�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">StorPortPoFxDirectedPowerDown</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID Context,</span></span><br><span class="line"><span class="params">    _In_ ULONG Flags</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_EXTENSION deviceExtension = (PDEVICE_EXTENSION)Context;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. ����ؼ��Ĵ���״̬</span></span><br><span class="line">    SaveControllerState(deviceExtension);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. ֹͣ���д���</span></span><br><span class="line">    AbortAllRequests(deviceExtension);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. �����ж�</span></span><br><span class="line">    DisableInterrupts(deviceExtension);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. �ر�ʱ��</span></span><br><span class="line">    DisableClocks(deviceExtension);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. �رյ�Դ</span></span><br><span class="line">    PowerDownController(deviceExtension);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">StorPortPoFxDirectedPowerUp</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID Context,</span></span><br><span class="line"><span class="params">    _In_ ULONG Flags</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_EXTENSION deviceExtension = (PDEVICE_EXTENSION)Context;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. �ϵ�����</span></span><br><span class="line">    PowerUpController(deviceExtension);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. ��ʼ��ʱ��</span></span><br><span class="line">    InitializeClocks(deviceExtension);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. �ָ��Ĵ���״̬</span></span><br><span class="line">    RestoreControllerState(deviceExtension);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. ʹ���ж�</span></span><br><span class="line">    EnableInterrupts(deviceExtension);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>��Դ״̬������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_EXTENSION</span> &#123;</span></span><br><span class="line">    <span class="comment">// ����Storport��չ</span></span><br><span class="line">    STORPORT_DEVICE_EXTENSION StorPortExt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// PoFx���</span></span><br><span class="line">    PO_FX_COMPONENT_IDLE_STATE HostIdleStates[<span class="number">3</span>];</span><br><span class="line">    PO_FX_COMPONENT_IDLE_STATE CardIdleStates[<span class="number">2</span>];</span><br><span class="line">    BOOLEAN PowerManagementEnabled;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����״̬</span></span><br><span class="line">    ULONG SavedRegisters[MAX_SAVED_REGISTERS];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA���</span></span><br><span class="line">    STOR_DMA_REGISTERS DmaRegisters;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ж�״̬</span></span><br><span class="line">    ULONG InterruptMask;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ʱ�ӿ���</span></span><br><span class="line">    ULONG ClockControl;</span><br><span class="line">    </span><br><span class="line">&#125; DEVICE_EXTENSION, *PDEVICE_EXTENSION;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">InitializeIdleStates</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_EXTENSION DeviceExtension</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Host Controller����״̬</span></span><br><span class="line">    DeviceExtension-&gt;HostIdleStates[<span class="number">0</span>].TransitionLatency = <span class="number">0</span>;          <span class="comment">// D0</span></span><br><span class="line">    DeviceExtension-&gt;HostIdleStates[<span class="number">0</span>].ResidencyRequirement = <span class="number">0</span>;</span><br><span class="line">    DeviceExtension-&gt;HostIdleStates[<span class="number">0</span>].NominalPower = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    DeviceExtension-&gt;HostIdleStates[<span class="number">1</span>].TransitionLatency = <span class="number">100</span>;        <span class="comment">// D1</span></span><br><span class="line">    DeviceExtension-&gt;HostIdleStates[<span class="number">1</span>].ResidencyRequirement = <span class="number">1000</span>;</span><br><span class="line">    DeviceExtension-&gt;HostIdleStates[<span class="number">1</span>].NominalPower = <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">    DeviceExtension-&gt;HostIdleStates[<span class="number">2</span>].TransitionLatency = <span class="number">1000</span>;       <span class="comment">// D3</span></span><br><span class="line">    DeviceExtension-&gt;HostIdleStates[<span class="number">2</span>].ResidencyRequirement = <span class="number">5000</span>;</span><br><span class="line">    DeviceExtension-&gt;HostIdleStates[<span class="number">2</span>].NominalPower = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Card����״̬</span></span><br><span class="line">    DeviceExtension-&gt;CardIdleStates[<span class="number">0</span>].TransitionLatency = <span class="number">0</span>;          <span class="comment">// Active</span></span><br><span class="line">    DeviceExtension-&gt;CardIdleStates[<span class="number">0</span>].ResidencyRequirement = <span class="number">0</span>;</span><br><span class="line">    DeviceExtension-&gt;CardIdleStates[<span class="number">0</span>].NominalPower = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    DeviceExtension-&gt;CardIdleStates[<span class="number">1</span>].TransitionLatency = <span class="number">500</span>;        <span class="comment">// Sleep</span></span><br><span class="line">    DeviceExtension-&gt;CardIdleStates[<span class="number">1</span>].ResidencyRequirement = <span class="number">2000</span>;</span><br><span class="line">    DeviceExtension-&gt;CardIdleStates[<span class="number">1</span>].NominalPower = <span class="number">5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>����������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">SaveControllerState</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_EXTENSION DeviceExtension</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ����ؼ��Ĵ���</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; MAX_SAVED_REGISTERS; i++) &#123;</span><br><span class="line">        DeviceExtension-&gt;SavedRegisters[i] = </span><br><span class="line">            StorPortReadRegisterUlong(DeviceExtension, </span><br><span class="line">                                    REGISTER_OFFSET[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">RestoreControllerState</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_EXTENSION DeviceExtension</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// �ָ��Ĵ���״̬</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; MAX_SAVED_REGISTERS; i++) &#123;</span><br><span class="line">        StorPortWriteRegisterUlong(DeviceExtension,</span><br><span class="line">                                 REGISTER_OFFSET[i],</span><br><span class="line">                                 DeviceExtension-&gt;SavedRegisters[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ�ע�����</p>
<ol>
<li>��Դ״̬ת����</li>
</ol>
<ul>
<li>ȷ����ȷ��ת������</li>
<li>������ʱ���</li>
<li>��֤״̬ת���ɹ�</li>
</ul>
<ol start="2">
<li>DMA������</li>
</ol>
<ul>
<li>�ڵ�Դת��ǰֹͣDMA</li>
<li>����&#x2F;�ָ�DMA����</li>
<li>���³�ʼ��DMA����</li>
</ul>
<ol start="3">
<li>�жϴ�����</li>
</ol>
<ul>
<li>�ʵ�����&#x2F;ʹ���ж�</li>
<li>����������ж�</li>
<li>����ж�״̬</li>
</ul>
<ol start="4">
<li>ʱ�ӹ�����</li>
</ol>
<ul>
<li>����&#x2F;�ָ�ʱ������</li>
<li>��ȷ��ʱ���ſ�����</li>
<li>�ȴ�ʱ���ȶ�</li>
</ul>
<ol start="5">
<li>��������</li>
</ol>
<ul>
<li>ʵ�ֹ��ϻָ�</li>
<li>��¼����״̬</li>
<li>֪ͨ�ϲ�����</li>
</ul>
<h2 id="User-11"><a href="#User-11" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>Storport��miniport driver���ʵ��SD Host Controller��SD card��Pofx�Լ�DFX(Direct Pofx)����</p>
<h2 id="AI-claude-3-5-sonnet-11"><a href="#AI-claude-3-5-sonnet-11" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>����Storport miniport����ʵ��SD Host Controller��SD Card��PoFx&#x2F;DFx���ܣ���Ҫͨ��HW_INITIALIZATION_DATA�ṹ����ػص���ʵ�֣�</p>
<ol>
<li>��ʼ�����ã�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    HW_INITIALIZATION_DATA hwInitData = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    hwInitData.HwInitializationDataSize = <span class="keyword">sizeof</span>(HW_INITIALIZATION_DATA);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���û����ص�</span></span><br><span class="line">    hwInitData.HwInitialize = SDHostInitialize;</span><br><span class="line">    hwInitData.HwStartIo = SDHostStartIo;</span><br><span class="line">    hwInitData.HwInterrupt = SDHostInterrupt;</span><br><span class="line">    hwInitData.HwFindAdapter = SDHostFindAdapter;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���õ�Դ�����ص�</span></span><br><span class="line">    hwInitData.HwAdapterControl = SDHostAdapterControl;</span><br><span class="line">    hwInitData.HwPowerSettingCallback = SDHostPowerSettingCallback;</span><br><span class="line">    hwInitData.HwCompleteRequestEx = SDHostCompleteRequest;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ø߼���Դ��������</span></span><br><span class="line">    hwInitData.FeatureSupport = STOR_FEATURE_POWER_MANAGEMENT;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> StorPortInitialize(DriverObject, </span><br><span class="line">                            RegistryPath,</span><br><span class="line">                            &amp;hwInitData,</span><br><span class="line">                            <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>�豸��չ�ṹ��</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SD_MINIPORT_DATA</span> &#123;</span></span><br><span class="line">    <span class="comment">// Storport�����ṹ</span></span><br><span class="line">    STORPORT_EXTENSION StorPortExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// PoFx���</span></span><br><span class="line">    PO_FX_COMPONENT Components[<span class="number">2</span>];  <span class="comment">// [0]=Host, [1]=Card</span></span><br><span class="line">    POHANDLE PoHandle;</span><br><span class="line">    BOOLEAN PowerEnabled;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ״̬</span></span><br><span class="line">    DEVICE_POWER_STATE CurrentPowerState;</span><br><span class="line">    ULONG ActiveComponents;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ļĴ���״̬</span></span><br><span class="line">    ULONG SavedRegisters[MAX_REGISTERS];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA״̬</span></span><br><span class="line">    DMA_ADAPTER_INFO DmaInfo;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ж�״̬</span></span><br><span class="line">    ULONG InterruptMask;</span><br><span class="line">    </span><br><span class="line">&#125; SD_MINIPORT_DATA, *PSD_MINIPORT_DATA;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ʵ�ֵ�Դ�����ص���</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN <span class="title function_">SDHostAdapterControl</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ SCSI_ADAPTER_CONTROL_TYPE ControlType,</span></span><br><span class="line"><span class="params">    _In_ PVOID Parameters</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PSD_MINIPORT_DATA miniport = (PSD_MINIPORT_DATA)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (ControlType) &#123;</span><br><span class="line">        <span class="keyword">case</span> ScsiQuerySupportedControlTypes:</span><br><span class="line">            <span class="comment">// ����֧�ֵĿ�������</span></span><br><span class="line">            StorPortCompleteRequest(DeviceExtension,</span><br><span class="line">                                  <span class="number">0</span>,</span><br><span class="line">                                  STOR_STATUS_SUCCESS);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ScsiStopAdapter:</span><br><span class="line">            <span class="comment">// ֹͣ������</span></span><br><span class="line">            DisableInterrupts(miniport);</span><br><span class="line">            AbortAllRequests(miniport);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ScsiRestartAdapter:</span><br><span class="line">            <span class="comment">// ����������</span></span><br><span class="line">            InitializeController(miniport);</span><br><span class="line">            EnableInterrupts(miniport);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOLEAN <span class="title function_">SDHostPowerSettingCallback</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ PSTOR_POWER_SETTING PowerSetting</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PSD_MINIPORT_DATA miniport = (PSD_MINIPORT_DATA)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (PowerSetting-&gt;PowerSettingType) &#123;</span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypePowerDown:</span><br><span class="line">            <span class="keyword">return</span> HandlePowerDown(miniport, PowerSetting);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypePowerUp:</span><br><span class="line">            <span class="keyword">return</span> HandlePowerUp(miniport, PowerSetting);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypeIdleNotification:</span><br><span class="line">            <span class="keyword">return</span> HandleIdleNotification(miniport, PowerSetting);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>DFxʵ�֣�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">InitializeDirectPoFx</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PSD_MINIPORT_DATA MiniportData</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    STOR_POFX_DEVICE_V3 poFxDevice = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    STOR_POFX_COMPONENT_V2 components[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����PoFx�豸</span></span><br><span class="line">    poFxDevice.Version = STOR_POFX_DEVICE_VERSION_V3;</span><br><span class="line">    poFxDevice.Size = <span class="keyword">sizeof</span>(STOR_POFX_DEVICE_V3);</span><br><span class="line">    poFxDevice.ComponentCount = <span class="number">2</span>;</span><br><span class="line">    poFxDevice.DirectedTransitionSupported = TRUE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Host Controller���</span></span><br><span class="line">    components[<span class="number">0</span>].Version = STOR_POFX_COMPONENT_VERSION_V2;</span><br><span class="line">    components[<span class="number">0</span>].Size = <span class="keyword">sizeof</span>(STOR_POFX_COMPONENT_V2);</span><br><span class="line">    components[<span class="number">0</span>].Id = <span class="number">0</span>;</span><br><span class="line">    components[<span class="number">0</span>].IdleStateCount = <span class="number">3</span>;</span><br><span class="line">    components[<span class="number">0</span>].DeepestWakeableIdleState = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SD Card���</span></span><br><span class="line">    components[<span class="number">1</span>].Version = STOR_POFX_COMPONENT_VERSION_V2;</span><br><span class="line">    components[<span class="number">1</span>].Size = <span class="keyword">sizeof</span>(STOR_POFX_COMPONENT_V2);</span><br><span class="line">    components[<span class="number">1</span>].Id = <span class="number">1</span>;</span><br><span class="line">    components[<span class="number">1</span>].IdleStateCount = <span class="number">2</span>;</span><br><span class="line">    components[<span class="number">1</span>].DeepestWakeableIdleState = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> StorPortInitializePofx(MiniportData,</span><br><span class="line">                                &amp;poFxDevice,</span><br><span class="line">                                components);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">HandleDirectedPowerDown</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PSD_MINIPORT_DATA MiniportData</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ����״̬</span></span><br><span class="line">    SaveControllerState(MiniportData);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ֹͣ����I/O</span></span><br><span class="line">    StorPortPause(MiniportData);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �����ж�</span></span><br><span class="line">    DisableInterrupts(MiniportData);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �ر�ʱ�Ӻ͵�Դ</span></span><br><span class="line">    PowerDownSequence(MiniportData);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">HandleDirectedPowerUp</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PSD_MINIPORT_DATA MiniportData</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. �ϵ�����</span></span><br><span class="line">    PowerUpSequence(MiniportData);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �ָ�״̬</span></span><br><span class="line">    RestoreControllerState(MiniportData);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ʹ���ж�</span></span><br><span class="line">    EnableInterrupts(MiniportData);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �ָ�I/O</span></span><br><span class="line">    StorPortResume(MiniportData);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>����������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">SaveControllerState</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PSD_MINIPORT_DATA MiniportData</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ����ؼ��Ĵ���</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; MAX_REGISTERS; i++) &#123;</span><br><span class="line">        MiniportData-&gt;SavedRegisters[i] = </span><br><span class="line">            StorPortReadRegisterUlong(MiniportData, </span><br><span class="line">                                    REGISTER_OFFSET[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">PowerDownSequence</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PSD_MINIPORT_DATA MiniportData</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. �رտ���Դ</span></span><br><span class="line">    StorPortWriteRegisterUlong(MiniportData,</span><br><span class="line">                              CARD_POWER_CTRL,</span><br><span class="line">                              POWER_OFF);</span><br><span class="line">                              </span><br><span class="line">    <span class="comment">// 2. �ȴ���Դ�ȶ�</span></span><br><span class="line">    StorPortStallExecution(<span class="number">1000</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �رտ�����ʱ��</span></span><br><span class="line">    StorPortWriteRegisterUlong(MiniportData,</span><br><span class="line">                              CLOCK_CTRL,</span><br><span class="line">                              CLOCK_OFF);</span><br><span class="line">                              </span><br><span class="line">    <span class="comment">// 4. �رտ�������Դ</span></span><br><span class="line">    StorPortWriteRegisterUlong(MiniportData,</span><br><span class="line">                              HOST_POWER_CTRL,</span><br><span class="line">                              POWER_OFF);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ�ע�����</p>
<ol>
<li>״̬������</li>
</ol>
<ul>
<li>��ȷ�������״̬</li>
<li>�����첽״̬�仯</li>
<li>ʵ��״̬�ָ�����</li>
</ul>
<ol start="2">
<li>��Դ������</li>
</ol>
<ul>
<li>��ȷ�ͷ�&#x2F;���»�ȡ��Դ</li>
<li>����DMA��Դ</li>
<li>�����ж���Դ</li>
</ul>
<ol start="3">
<li>��������</li>
</ol>
<ul>
<li>ʵ�ֹ��ϻָ�</li>
<li>��ʱ����</li>
<li>״̬��֤</li>
</ul>
<ol start="4">
<li>�����Ż���</li>
</ol>
<ul>
<li>��С��ת���ӳ�</li>
<li>�Ż���Դ״̬�л�</li>
<li>���ٲ���Ҫ��״̬�л�</li>
</ul>
<ol start="5">
<li>����֧�֣�</li>
</ol>
<ul>
<li>������ϸ��־</li>
<li>ʵ��״̬���</li>
<li>�ṩ���Խӿ�</li>
</ul>
<h2 id="User-12"><a href="#User-12" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>InitializeDirectPoFx��ʵ���ƺ���̫����Storport miniport�ĵ�����ȷ��</p>
<h2 id="AI-claude-3-5-sonnet-12"><a href="#AI-claude-3-5-sonnet-12" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��˵�ö�,��ΪStorport miniport��������ʵ������ȷ��PoFx&#x2F;DFx��ʼ����</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �豸��չ�ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SD_MINIPORT_DATA</span> &#123;</span></span><br><span class="line">    <span class="comment">// Storport�����ṹ</span></span><br><span class="line">    STORPORT_EXTENSION StorPortExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ����״̬</span></span><br><span class="line">    ULONG PowerFlags;</span><br><span class="line">    DEVICE_POWER_STATE CurrentPowerState;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ļĴ���״̬</span></span><br><span class="line">    ULONG SavedRegisters[MAX_REGISTERS];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA״̬</span></span><br><span class="line">    STOR_DMA_REGISTERS DmaRegs;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ж�״̬</span></span><br><span class="line">    ULONG InterruptMask;</span><br><span class="line">    </span><br><span class="line">&#125; SD_MINIPORT_DATA, *PSD_MINIPORT_DATA;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HW_INITIALIZATION_DATA�����õ�Դ�����ص�</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    HW_INITIALIZATION_DATA hwInitData = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    hwInitData.HwInitializationDataSize = <span class="keyword">sizeof</span>(HW_INITIALIZATION_DATA);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���û����ص�</span></span><br><span class="line">    hwInitData.HwInitialize = SDHostInitialize;</span><br><span class="line">    hwInitData.HwStartIo = SDHostStartIo;</span><br><span class="line">    hwInitData.HwInterrupt = SDHostInterrupt;</span><br><span class="line">    hwInitData.HwFindAdapter = SDHostFindAdapter;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���õ�Դ�����ص�</span></span><br><span class="line">    hwInitData.HwAdapterControl = SDHostAdapterControl;</span><br><span class="line">    hwInitData.HwAdapterPowerSettingCallback = SDHostPowerSettingCallback;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> StorPortInitialize(DriverObject,</span><br><span class="line">                            RegistryPath,</span><br><span class="line">                            &amp;hwInitData,</span><br><span class="line">                            <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ʵ�ֵ�Դ�����ص�</span></span><br><span class="line">BOOLEAN <span class="title function_">SDHostAdapterControl</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ SCSI_ADAPTER_CONTROL_TYPE ControlType,</span></span><br><span class="line"><span class="params">    _In_ PVOID Parameters</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PSD_MINIPORT_DATA miniport = (PSD_MINIPORT_DATA)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (ControlType) &#123;</span><br><span class="line">        <span class="keyword">case</span> ScsiStopAdapter:</span><br><span class="line">            <span class="keyword">return</span> HandleAdapterStop(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ScsiRestartAdapter:</span><br><span class="line">            <span class="keyword">return</span> HandleAdapterRestart(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ScsiPowerDown:</span><br><span class="line">            <span class="keyword">return</span> HandlePowerDown(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ScsiPowerUp:</span><br><span class="line">            <span class="keyword">return</span> HandlePowerUp(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOLEAN <span class="title function_">SDHostPowerSettingCallback</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ PSTOR_POWER_SETTING PowerSetting</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PSD_MINIPORT_DATA miniport = (PSD_MINIPORT_DATA)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (PowerSetting-&gt;PowerSettingType) &#123;</span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypeD0Entry:</span><br><span class="line">            <span class="keyword">return</span> HandleD0Entry(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypeD3Entry:</span><br><span class="line">            <span class="keyword">return</span> HandleD3Entry(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypeIdleCompletion:</span><br><span class="line">            <span class="keyword">return</span> HandleIdleCompletion(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Ҫ�޸ģ�</p>
<ol>
<li>�Ƴ���ֱ�ӵ�PoFx��ʼ������</li>
<li>ͨ��Storport�ı�׼�ӿڴ�����Դ����</li>
<li>ʹ����ȷ�Ļص������Ͳ�������</li>
<li>��ѭStorport miniport�ļܹ����</li>
</ol>
<p>Storport miniport����Ӧ��ͨ��HW_INITIALIZATION_DATA�ṹ�ͱ�׼�ص���ʵ�ֵ�Դ������������ֱ�ӵ���PoFx�ӿڡ�</p>
<h2 id="User-13"><a href="#User-13" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�����miniport���벻����  @Web @<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-_stor_pofx_device_v3">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-_stor_pofx_device_v3</a> </p>
<h2 id="AI-claude-3-5-sonnet-13"><a href="#AI-claude-3-5-sonnet-13" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��˵�öԡ����Ҹ���΢���ٷ��ĵ�����ʵ��Storport miniport������PoFx&#x2F;DFx���ܣ�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �豸��չ�ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">MINIPORT_DEVICE_EXTENSION</span> &#123;</span></span><br><span class="line">    <span class="comment">// Storport�����ṹ</span></span><br><span class="line">    STORPORT_EXTENSION StorPortExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ����״̬</span></span><br><span class="line">    STOR_POFX_DEVICE_V3 PoFxDevice;</span><br><span class="line">    STOR_POFX_COMPONENT_V2 Components[<span class="number">2</span>]; <span class="comment">// Host + Card</span></span><br><span class="line">    BOOLEAN PowerManagementEnabled;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    DEVICE_POWER_STATE CurrentPowerState;</span><br><span class="line">    BOOLEAN DeviceBusy;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ļĴ���״̬</span></span><br><span class="line">    ULONG SavedRegisters[MAX_REGISTERS];</span><br><span class="line">    </span><br><span class="line">&#125; MINIPORT_DEVICE_EXTENSION, *PMINIPORT_DEVICE_EXTENSION;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��HW_INITIALIZE�г�ʼ��PoFx</span></span><br><span class="line">BOOLEAN <span class="title function_">HwInitialize</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PMINIPORT_DEVICE_EXTENSION miniport = DeviceExtension;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ��ʼ��PoFx�豸</span></span><br><span class="line">    miniport-&gt;PoFxDevice.Version = STOR_POFX_DEVICE_VERSION_V3;</span><br><span class="line">    miniport-&gt;PoFxDevice.Size = <span class="keyword">sizeof</span>(STOR_POFX_DEVICE_V3);</span><br><span class="line">    miniport-&gt;PoFxDevice.ComponentCount = <span class="number">2</span>;</span><br><span class="line">    miniport-&gt;PoFxDevice.Flags = STOR_POFX_FLAG_DEVICE_IDLE_CAPABLE;</span><br><span class="line">    miniport-&gt;PoFxDevice.D0IdleTimeout = <span class="number">100</span>; <span class="comment">// 100ms</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Host Controller���</span></span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].Version = STOR_POFX_COMPONENT_VERSION_V2;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].Size = <span class="keyword">sizeof</span>(STOR_POFX_COMPONENT_V2);</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].Id = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStateCount = <span class="number">3</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].DeepestWakeableIdleState = <span class="number">1</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStates[<span class="number">0</span>].TransitionLatency = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStates[<span class="number">0</span>].ResidencyRequirement = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStates[<span class="number">0</span>].NominalPower = <span class="number">100</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStates[<span class="number">1</span>].TransitionLatency = <span class="number">1000</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStates[<span class="number">1</span>].ResidencyRequirement = <span class="number">5000</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStates[<span class="number">1</span>].NominalPower = <span class="number">50</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStates[<span class="number">2</span>].TransitionLatency = <span class="number">5000</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStates[<span class="number">2</span>].ResidencyRequirement = <span class="number">10000</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">0</span>].IdleStates[<span class="number">2</span>].NominalPower = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SD Card���</span></span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].Version = STOR_POFX_COMPONENT_VERSION_V2;</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].Size = <span class="keyword">sizeof</span>(STOR_POFX_COMPONENT_V2);</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].Id = <span class="number">1</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].IdleStateCount = <span class="number">2</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].DeepestWakeableIdleState = <span class="number">1</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].IdleStates[<span class="number">0</span>].TransitionLatency = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].IdleStates[<span class="number">0</span>].ResidencyRequirement = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].IdleStates[<span class="number">0</span>].NominalPower = <span class="number">100</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].IdleStates[<span class="number">1</span>].TransitionLatency = <span class="number">2000</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].IdleStates[<span class="number">1</span>].ResidencyRequirement = <span class="number">8000</span>;</span><br><span class="line">    miniport-&gt;Components[<span class="number">1</span>].IdleStates[<span class="number">1</span>].NominalPower = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ע��PoFx</span></span><br><span class="line">    status = StorPortInitializePofx(DeviceExtension,</span><br><span class="line">                                  &amp;miniport-&gt;PoFxDevice,</span><br><span class="line">                                  miniport-&gt;Components);</span><br><span class="line">                                  </span><br><span class="line">    <span class="keyword">return</span> (status == STATUS_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ʵ��HwAdapterPowerSettingCallback�ص�</span></span><br><span class="line">BOOLEAN <span class="title function_">HwAdapterPowerSettingCallback</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ PSTOR_POWER_SETTING PowerSetting</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PMINIPORT_DEVICE_EXTENSION miniport = DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (PowerSetting-&gt;PowerSettingType) &#123;</span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypeD0Entry:</span><br><span class="line">            <span class="comment">// ��D3�ָ���D0</span></span><br><span class="line">            <span class="keyword">return</span> HandleD0Entry(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypeD3Entry:</span><br><span class="line">            <span class="comment">// ��D0����D3</span></span><br><span class="line">            <span class="keyword">return</span> HandleD3Entry(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypeIdleNotification:</span><br><span class="line">            <span class="comment">// ����֪ͨ</span></span><br><span class="line">            <span class="keyword">return</span> HandleIdleNotification(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> StorPowerSettingTypeIdleTimeout:</span><br><span class="line">            <span class="comment">// ���г�ʱ</span></span><br><span class="line">            <span class="keyword">return</span> HandleIdleTimeout(miniport);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// D0Entry����</span></span><br><span class="line">BOOLEAN <span class="title function_">HandleD0Entry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PMINIPORT_DEVICE_EXTENSION Miniport</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. �ָ�ʱ�Ӻ͵�Դ</span></span><br><span class="line">    PowerUpSequence(Miniport);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �ָ��Ĵ���״̬</span></span><br><span class="line">    RestoreControllerState(Miniport);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���³�ʼ���ж�</span></span><br><span class="line">    EnableInterrupts(Miniport);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����״̬</span></span><br><span class="line">    Miniport-&gt;CurrentPowerState = PowerDeviceD0;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// D3Entry����</span></span><br><span class="line">BOOLEAN <span class="title function_">HandleD3Entry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PMINIPORT_DEVICE_EXTENSION Miniport</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ����״̬</span></span><br><span class="line">    SaveControllerState(Miniport);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����ж�</span></span><br><span class="line">    DisableInterrupts(Miniport);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �ر�ʱ�Ӻ͵�Դ</span></span><br><span class="line">    PowerDownSequence(Miniport);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����״̬</span></span><br><span class="line">    Miniport-&gt;CurrentPowerState = PowerDeviceD3;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����֪ͨ����</span></span><br><span class="line">BOOLEAN <span class="title function_">HandleIdleNotification</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PMINIPORT_DEVICE_EXTENSION Miniport</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (Miniport-&gt;DeviceBusy) &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;  <span class="comment">// �豸æ,�ܾ�����</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// �������״̬</span></span><br><span class="line">    SaveControllerState(Miniport);</span><br><span class="line">    DisableInterrupts(Miniport);</span><br><span class="line">    PowerDownComponents(Miniport);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ��޸ĵ㣺</p>
<ol>
<li><p>ʹ����ȷ��STOR_POFX_DEVICE_V3��STOR_POFX_COMPONENT_V2�ṹ</p>
</li>
<li><p>ͨ��StorPortInitializePofxע��PoFx����</p>
</li>
<li><p>ʵ����ȷ��HwAdapterPowerSettingCallback�ص�</p>
</li>
<li><p>��ȷ������Դ״̬ת���Ϳ���֪ͨ</p>
</li>
<li><p>��ѭStorport miniport�����ܹ�</p>
</li>
</ol>
<p>��Ҫ�ص㣺</p>
<ol>
<li>֧���������ĵ�Դ����</li>
<li>֧���豸���м��</li>
<li>֧��D0&#x2F;D3״̬ת��</li>
<li>֧�ֶ������״̬</li>
<li>��ȷ����״̬����&#x2F;�ָ�</li>
</ol>
<p>���ʵ�ָ�����΢���ٷ��ĵ���Ҫ���Storport miniport�����ļܹ���</p>
<h2 id="User-14"><a href="#User-14" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>���ˣ�storport�ĵ�˵�ˣ�The number of elements in the Components array. Set this member to 1. Currently, only a single component is supported for either a storage adapter or logical unit.</p>
<h2 id="AI-claude-3-5-sonnet-14"><a href="#AI-claude-3-5-sonnet-14" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��˵�öԣ���Ϊ Storport miniport ����ʵ������ȷ�� PoFx ���ã�ֻʹ��һ�������</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">MINIPORT_DEVICE_EXTENSION</span> &#123;</span></span><br><span class="line">    <span class="comment">// Storport�����ṹ</span></span><br><span class="line">    STORPORT_EXTENSION StorPortExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ����״̬</span></span><br><span class="line">    STOR_POFX_DEVICE_V3 PoFxDevice;</span><br><span class="line">    STOR_POFX_COMPONENT_V2 Component;    <span class="comment">// ֻ֧��һ�����</span></span><br><span class="line">    BOOLEAN PowerManagementEnabled;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    DEVICE_POWER_STATE CurrentPowerState;</span><br><span class="line">    BOOLEAN DeviceBusy;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ļĴ���״̬</span></span><br><span class="line">    ULONG SavedRegisters[MAX_REGISTERS];</span><br><span class="line">    </span><br><span class="line">&#125; MINIPORT_DEVICE_EXTENSION, *PMINIPORT_DEVICE_EXTENSION;</span><br><span class="line"></span><br><span class="line">BOOLEAN <span class="title function_">HwInitialize</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PMINIPORT_DEVICE_EXTENSION miniport = DeviceExtension;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ��ʼ��PoFx�豸</span></span><br><span class="line">    miniport-&gt;PoFxDevice.Version = STOR_POFX_DEVICE_VERSION_V3;</span><br><span class="line">    miniport-&gt;PoFxDevice.Size = <span class="keyword">sizeof</span>(STOR_POFX_DEVICE_V3);</span><br><span class="line">    miniport-&gt;PoFxDevice.ComponentCount = <span class="number">1</span>;  <span class="comment">// ֻ������Ϊ1</span></span><br><span class="line">    miniport-&gt;PoFxDevice.Flags = STOR_POFX_FLAG_DEVICE_IDLE_CAPABLE;</span><br><span class="line">    miniport-&gt;PoFxDevice.D0IdleTimeout = <span class="number">100</span>; <span class="comment">// 100ms</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���õ������</span></span><br><span class="line">    miniport-&gt;Component.Version = STOR_POFX_COMPONENT_VERSION_V2;</span><br><span class="line">    miniport-&gt;Component.Size = <span class="keyword">sizeof</span>(STOR_POFX_COMPONENT_V2);</span><br><span class="line">    miniport-&gt;Component.Id = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStateCount = <span class="number">3</span>;</span><br><span class="line">    miniport-&gt;Component.DeepestWakeableIdleState = <span class="number">1</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">0</span>].TransitionLatency = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">0</span>].ResidencyRequirement = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">0</span>].NominalPower = <span class="number">100</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">1</span>].TransitionLatency = <span class="number">1000</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">1</span>].ResidencyRequirement = <span class="number">5000</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">1</span>].NominalPower = <span class="number">50</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">2</span>].TransitionLatency = <span class="number">5000</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">2</span>].ResidencyRequirement = <span class="number">10000</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">2</span>].NominalPower = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ע��PoFx�����뵥�����</span></span><br><span class="line">    status = StorPortInitializePofx(DeviceExtension,</span><br><span class="line">                                  &amp;miniport-&gt;PoFxDevice,</span><br><span class="line">                                  &amp;miniport-&gt;Component);</span><br><span class="line">                                  </span><br><span class="line">    <span class="keyword">return</span> (status == STATUS_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�޸�Ҫ�㣺</p>
<ol>
<li>ֻʹ��һ�����</li>
<li>ComponentCount ����Ϊ 1</li>
<li>�� SD Host Controller �� Card �ĵ�Դ�����ϲ�����������д���</li>
</ol>
<p>��л����ָ����</p>
<h2 id="User-15"><a href="#User-15" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>���֧�� Card �ĵ�Դ����</p>
<h2 id="AI-claude-3-5-sonnet-15"><a href="#AI-claude-3-5-sonnet-15" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>���� SD Card �ĵ�Դ���������� Storport PoFx ֻ֧��һ�������������Ҫ�� Host Controller ���洦�� Card �ĵ�Դ״̬��������ʵ�ַ�����</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">MINIPORT_DEVICE_EXTENSION</span> &#123;</span></span><br><span class="line">    STORPORT_EXTENSION StorPortExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// PoFx ����</span></span><br><span class="line">    STOR_POFX_DEVICE_V3 PoFxDevice;</span><br><span class="line">    STOR_POFX_COMPONENT_V2 Component;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Card ��Դ״̬</span></span><br><span class="line">    BOOLEAN CardPresent;</span><br><span class="line">    BOOLEAN CardPowered;</span><br><span class="line">    ULONG CardVoltage;</span><br><span class="line">    ULONG CardPowerState;  <span class="comment">// ��¼���ĵ�Դ״̬</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Host ״̬</span></span><br><span class="line">    DEVICE_POWER_STATE HostPowerState;</span><br><span class="line">    BOOLEAN DeviceBusy;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Ĵ���״̬</span></span><br><span class="line">    ULONG SavedRegisters[MAX_REGISTERS];</span><br><span class="line">    </span><br><span class="line">&#125; MINIPORT_DEVICE_EXTENSION, *PMINIPORT_DEVICE_EXTENSION;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Card ��Դ״̬����</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CARD_POWER_ON     0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CARD_POWER_SLEEP  1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CARD_POWER_OFF    2</span></span><br><span class="line"></span><br><span class="line">BOOLEAN <span class="title function_">HwInitialize</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PMINIPORT_DEVICE_EXTENSION miniport = DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ�� PoFx �豸</span></span><br><span class="line">    miniport-&gt;PoFxDevice.Version = STOR_POFX_DEVICE_VERSION_V3;</span><br><span class="line">    miniport-&gt;PoFxDevice.Size = <span class="keyword">sizeof</span>(STOR_POFX_DEVICE_V3);</span><br><span class="line">    miniport-&gt;PoFxDevice.ComponentCount = <span class="number">1</span>;</span><br><span class="line">    miniport-&gt;PoFxDevice.Flags = STOR_POFX_FLAG_DEVICE_IDLE_CAPABLE;</span><br><span class="line">    miniport-&gt;PoFxDevice.D0IdleTimeout = <span class="number">100</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Host Controller �������</span></span><br><span class="line">    miniport-&gt;Component.Version = STOR_POFX_COMPONENT_VERSION_V2;</span><br><span class="line">    miniport-&gt;Component.Size = <span class="keyword">sizeof</span>(STOR_POFX_COMPONENT_V2);</span><br><span class="line">    miniport-&gt;Component.Id = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStateCount = <span class="number">3</span>;</span><br><span class="line">    miniport-&gt;Component.DeepestWakeableIdleState = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// F0 - ��ȫ����״̬</span></span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">0</span>].TransitionLatency = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">0</span>].ResidencyRequirement = <span class="number">0</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">0</span>].NominalPower = <span class="number">100</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// F1 - �����ߣ�Host ���˯��</span></span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">1</span>].TransitionLatency = <span class="number">1000</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">1</span>].ResidencyRequirement = <span class="number">5000</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">1</span>].NominalPower = <span class="number">50</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// F2 - ���ϵ磬Host ���˯��</span></span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">2</span>].TransitionLatency = <span class="number">5000</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">2</span>].ResidencyRequirement = <span class="number">10000</span>;</span><br><span class="line">    miniport-&gt;Component.IdleStates[<span class="number">2</span>].NominalPower = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> StorPortInitializePofx(DeviceExtension,</span><br><span class="line">                                &amp;miniport-&gt;PoFxDevice,</span><br><span class="line">                                &amp;miniport-&gt;Component) == STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOLEAN <span class="title function_">HandleIdleStateTransition</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PMINIPORT_DEVICE_EXTENSION Miniport,</span></span><br><span class="line"><span class="params">    _In_ ULONG IdleState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (IdleState) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">// F0</span></span><br><span class="line">            <span class="comment">// �ָ� Host</span></span><br><span class="line">            PowerUpHost(Miniport);</span><br><span class="line">            <span class="comment">// �ָ� Card</span></span><br><span class="line">            PowerUpCard(Miniport);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">// F1</span></span><br><span class="line">            <span class="comment">// Host ���˯��</span></span><br><span class="line">            SetHostLowPower(Miniport);</span><br><span class="line">            <span class="comment">// Card ����˯��ģʽ</span></span><br><span class="line">            SetCardSleepMode(Miniport);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>: <span class="comment">// F2</span></span><br><span class="line">            <span class="comment">// �����Ҫ״̬</span></span><br><span class="line">            SaveCardState(Miniport);</span><br><span class="line">            <span class="comment">// Card �ϵ�</span></span><br><span class="line">            PowerDownCard(Miniport);</span><br><span class="line">            <span class="comment">// Host ���˯��</span></span><br><span class="line">            PowerDownHost(Miniport);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOLEAN <span class="title function_">PowerUpCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PMINIPORT_DEVICE_EXTENSION Miniport</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ʹ�ܿ���Դ</span></span><br><span class="line">    WRITE_REGISTER_ULONG((PULONG)(Miniport-&gt;RegisterBase + CARD_PWR_CTRL),</span><br><span class="line">                        CARD_POWER_ENABLE | Miniport-&gt;CardVoltage);</span><br><span class="line">                        </span><br><span class="line">    <span class="comment">// 2. �ȴ���Դ�ȶ�</span></span><br><span class="line">    StorPortStallExecution(<span class="number">10000</span>); <span class="comment">// 10ms</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʼ��ʱ��</span></span><br><span class="line">    WRITE_REGISTER_ULONG((PULONG)(Miniport-&gt;RegisterBase + CARD_CLK_CTRL),</span><br><span class="line">                        CARD_CLK_ENABLE | CARD_CLK_DIVIDER);</span><br><span class="line">                        </span><br><span class="line">    <span class="comment">// 4. ���� GO_IDLE_STATE (CMD0)</span></span><br><span class="line">    status = SendCardCommand(Miniport, CMD0, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. �ָ���״̬</span></span><br><span class="line">    <span class="keyword">if</span> (Miniport-&gt;CardPowerState == CARD_POWER_SLEEP) &#123;</span><br><span class="line">        status = SendCardCommand(Miniport, CMD5, <span class="number">0</span>); <span class="comment">// ��˯�߻���</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Miniport-&gt;CardPowerState = CARD_POWER_ON;</span><br><span class="line">    Miniport-&gt;CardPowered = TRUE;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOLEAN <span class="title function_">SetCardSleepMode</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PMINIPORT_DEVICE_EXTENSION Miniport</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ����˯������</span></span><br><span class="line">    NTSTATUS status = SendCardCommand(Miniport, CMD5, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����ʱ��Ƶ��</span></span><br><span class="line">    WRITE_REGISTER_ULONG((PULONG)(Miniport-&gt;RegisterBase + CARD_CLK_CTRL),</span><br><span class="line">                        CARD_CLK_ENABLE | CARD_CLK_LOW_POWER);</span><br><span class="line">                        </span><br><span class="line">    <span class="comment">// 3. ���͵�ѹ</span></span><br><span class="line">    WRITE_REGISTER_ULONG((PULONG)(Miniport-&gt;RegisterBase + CARD_PWR_CTRL),</span><br><span class="line">                        CARD_POWER_ENABLE | CARD_VOLTAGE_LOW);</span><br><span class="line">                        </span><br><span class="line">    Miniport-&gt;CardPowerState = CARD_POWER_SLEEP;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOLEAN <span class="title function_">PowerDownCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PMINIPORT_DEVICE_EXTENSION Miniport</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ֹͣʱ��</span></span><br><span class="line">    WRITE_REGISTER_ULONG((PULONG)(Miniport-&gt;RegisterBase + CARD_CLK_CTRL),</span><br><span class="line">                        CARD_CLK_DISABLE);</span><br><span class="line">                        </span><br><span class="line">    <span class="comment">// 2. �Ͽ���Դ</span></span><br><span class="line">    WRITE_REGISTER_ULONG((PULONG)(Miniport-&gt;RegisterBase + CARD_PWR_CTRL),</span><br><span class="line">                        CARD_POWER_DISABLE);</span><br><span class="line">                        </span><br><span class="line">    Miniport-&gt;CardPowerState = CARD_POWER_OFF;</span><br><span class="line">    Miniport-&gt;CardPowered = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ��㣺</p>
<ol>
<li><p>�� PoFx �ĵ�һ����ж���������״̬��ÿ��״̬��Ӧ��ͬ�� Host �� Card ��Դ���</p>
</li>
<li><p>F0 ״̬��</p>
<ul>
<li>Host Controller ��ȫ����</li>
<li>Card ��ȫ����͹���</li>
</ul>
</li>
<li><p>F1 ״̬��</p>
<ul>
<li>Host Controller ���˯��</li>
<li>Card ����˯��ģʽ</li>
<li>������С��ѹ����</li>
</ul>
</li>
<li><p>F2 ״̬��</p>
<ul>
<li>Host Controller ���˯��</li>
<li>Card ��ȫ�ϵ�</li>
<li>�����Ҫ״̬</li>
</ul>
</li>
<li><p>״̬ת��ʱ��</p>
<ul>
<li>��ȷ�����µ�����</li>
<li>ʱ�ӹ���</li>
<li>��������</li>
<li>״̬����ͻָ�</li>
</ul>
</li>
<li><p>��������</p>
<ul>
<li>��Դ״̬ת��ʧ�ܴ���</li>
<li>���ʱ����</li>
<li>״̬�ָ�ʧ�ܴ���</li>
</ul>
</li>
</ol>
<p>����ʵ�ַ�ʽ������ Storport PoFx ������������£���Ȼʵ�ֶ� SD Card ��������Դ������</p>
<h2 id="User-16"><a href="#User-16" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>realtek Win11 PCI SD host driver RtsPer.sys�õ�ʲô�ܹ���WDF��sdportӦ�ò�̫����һ���ð�</p>
<h2 id="AI-claude-3-5-sonnet-16"><a href="#AI-claude-3-5-sonnet-16" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��˵�öԡ�ͨ������ RtsPer.sys����Ӧ��ʹ�õ��Ǵ� SDport �ܹ��������� WDF + SDport �Ļ�ϼܹ���ԭ�����£�</p>
<ol>
<li>SDport �����ܹ���</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �������</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    SDPORT_INITIALIZATION_DATA sdportData = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    sdportData.StructureSize = <span class="keyword">sizeof</span>(SDPORT_INITIALIZATION_DATA);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����Ļص�</span></span><br><span class="line">    sdportData.GetSlotCount = RtsPciGetSlotCount;</span><br><span class="line">    sdportData.GetSlotCapabilities = RtsPciGetSlotCapabilities;</span><br><span class="line">    sdportData.Initialize = RtsPciInitialize;</span><br><span class="line">    sdportData.IssueBusOperation = RtsPciIssueBusOperation;</span><br><span class="line">    sdportData.GetCardDetectState = RtsPciGetCardDetectState;</span><br><span class="line">    sdportData.Interrupt = RtsPciInterrupt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ѡ�Ļص�</span></span><br><span class="line">    sdportData.IssueRequest = RtsPciIssueRequest;</span><br><span class="line">    sdportData.GetResponse = RtsPciGetResponse;</span><br><span class="line">    sdportData.ToggleEvents = RtsPciToggleEvents;</span><br><span class="line">    sdportData.ClearEvents = RtsPciClearEvents;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> SdPortInitialize(DriverObject, RegistryPath, &amp;sdportData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ԭ��</li>
</ol>
<ul>
<li>SDport ר��Ϊ SD Host Controller ���</li>
<li>�ṩ������ SD Э��֧��</li>
<li>���õ�Դ��������</li>
<li>���õ������Ż�</li>
<li>��׼���Ľӿ�</li>
</ul>
<ol start="3">
<li>��ʹ�� WDF ��ԭ��</li>
</ol>
<ul>
<li>SDport �� WDF �ܹ���ͻ</li>
<li>����Ҫ WDF �� PnP ֧��</li>
<li>SDport ���ṩ��Ҫ����</li>
<li>�������Ŀ���</li>
<li>������������</li>
</ul>
<p>�����ļܹ�ѡ���Ǻ����ģ���Ϊ SDport ��������Ϊ SD Host Controller ר����ƵĿ�ܡ�</p>
<h2 id="User-17"><a href="#User-17" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�����ѵ�����������ʾ��WDM</p>
<h2 id="AI-claude-3-5-sonnet-17"><a href="#AI-claude-3-5-sonnet-17" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��Ǹ��֮ǰ���Ʋ���ȫ������˵�öԣ�ͨ��������ȷ�� RtsPer.sys ʵ��ʹ�õ��� WDM �ܹ���</p>
<p>���Ǹ�����ʵ�ʵļܹ���</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WDM Driver Entry</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ���� WDM ��׼�ص�</span></span><br><span class="line">    DriverObject-&gt;DriverExtension-&gt;AddDevice = RtsPciAddDevice;</span><br><span class="line">    DriverObject-&gt;MajorFunction[IRP_MJ_PNP] = RtsPciPnp;</span><br><span class="line">    DriverObject-&gt;MajorFunction[IRP_MJ_POWER] = RtsPciPower;</span><br><span class="line">    DriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = RtsPciDeviceControl;</span><br><span class="line">    DriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = RtsPciCreate;</span><br><span class="line">    DriverObject-&gt;MajorFunction[IRP_MJ_CLOSE] = RtsPciClose;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��л���ľ�����������ѧ����ʵ�ʲ�Ʒ�е���ʵʵ�֡�</p>
<h2 id="User-18"><a href="#User-18" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>WDM�����ʵ��RtsPer.sys</p>
<h2 id="AI-claude-3-5-sonnet-18"><a href="#AI-claude-3-5-sonnet-18" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>����WDM�ܹ���RtsPer.sys��ʵ�ִ������£�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_EXTENSION</span> &#123;</span></span><br><span class="line">    <span class="comment">// WDM���</span></span><br><span class="line">    PDEVICE_OBJECT DeviceObject;</span><br><span class="line">    PDEVICE_OBJECT PhysicalDeviceObject;</span><br><span class="line">    PDEVICE_OBJECT LowerDeviceObject;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// PCI��Դ</span></span><br><span class="line">    PUCHAR RegisterBase;</span><br><span class="line">    ULONG RegisterLength;</span><br><span class="line">    BOOLEAN MappedRegisters;</span><br><span class="line">    PCI_COMMON_CONFIG PciConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ж���Դ</span></span><br><span class="line">    PKINTERRUPT InterruptObject;</span><br><span class="line">    ULONG InterruptVector;</span><br><span class="line">    KIRQL InterruptIrql;</span><br><span class="line">    KINTERRUPT_MODE InterruptMode;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA���</span></span><br><span class="line">    PDMA_ADAPTER DmaAdapter;</span><br><span class="line">    PVOID CommonBuffer;</span><br><span class="line">    PHYSICAL_ADDRESS CommonBufferPhysical;</span><br><span class="line">    ULONG CommonBufferLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    DEVICE_POWER_STATE DevicePowerState;</span><br><span class="line">    SYSTEM_POWER_STATE SystemPowerState;</span><br><span class="line">    BOOLEAN DeviceInitialized;</span><br><span class="line">    BOOLEAN CardPresent;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ͬ������</span></span><br><span class="line">    KSPIN_LOCK SpinLock;</span><br><span class="line">    KEVENT RemoveEvent;</span><br><span class="line">    </span><br><span class="line">&#125; DEVICE_EXTENSION, *PDEVICE_EXTENSION;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddDevice�ص�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciAddDevice</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_OBJECT PhysicalDeviceObject</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PDEVICE_OBJECT deviceObject = <span class="literal">NULL</span>;</span><br><span class="line">    PDEVICE_EXTENSION devExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���������豸����(FDO)</span></span><br><span class="line">    status = IoCreateDevice(DriverObject,</span><br><span class="line">                          <span class="keyword">sizeof</span>(DEVICE_EXTENSION),</span><br><span class="line">                          <span class="literal">NULL</span>,</span><br><span class="line">                          FILE_DEVICE_UNKNOWN,</span><br><span class="line">                          FILE_DEVICE_SECURE_OPEN,</span><br><span class="line">                          FALSE,</span><br><span class="line">                          &amp;deviceObject);</span><br><span class="line">                          </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    devExt = (PDEVICE_EXTENSION)deviceObject-&gt;DeviceExtension;</span><br><span class="line">    RtlZeroMemory(devExt, <span class="keyword">sizeof</span>(DEVICE_EXTENSION));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ���豸��չ</span></span><br><span class="line">    devExt-&gt;DeviceObject = deviceObject;</span><br><span class="line">    devExt-&gt;PhysicalDeviceObject = PhysicalDeviceObject;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ӵ��豸ջ</span></span><br><span class="line">    devExt-&gt;LowerDeviceObject = </span><br><span class="line">        IoAttachDeviceToDeviceStack(deviceObject, PhysicalDeviceObject);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!devExt-&gt;LowerDeviceObject) &#123;</span><br><span class="line">        IoDeleteDevice(deviceObject);</span><br><span class="line">        <span class="keyword">return</span> STATUS_NO_SUCH_DEVICE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ��ͬ������</span></span><br><span class="line">    KeInitializeSpinLock(&amp;devExt-&gt;SpinLock);</span><br><span class="line">    KeInitializeEvent(&amp;devExt-&gt;RemoveEvent, NotificationEvent, FALSE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����豸�����־</span></span><br><span class="line">    deviceObject-&gt;Flags |= DO_POWER_PAGABLE;</span><br><span class="line">    deviceObject-&gt;Flags &amp;= ~DO_DEVICE_INITIALIZING;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PnP�ַ�����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciPnp</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_OBJECT DeviceObject,</span></span><br><span class="line"><span class="params">    _In_ PIRP Irp</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_EXTENSION devExt = (PDEVICE_EXTENSION)DeviceObject-&gt;DeviceExtension;</span><br><span class="line">    PIO_STACK_LOCATION irpStack = IoGetCurrentIrpStackLocation(Irp);</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (irpStack-&gt;MinorFunction) &#123;</span><br><span class="line">        <span class="keyword">case</span> IRP_MN_START_DEVICE:</span><br><span class="line">            <span class="comment">// �����豸</span></span><br><span class="line">            status = RtsPciStartDevice(DeviceObject, Irp);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> IRP_MN_STOP_DEVICE:</span><br><span class="line">            <span class="comment">// ֹͣ�豸</span></span><br><span class="line">            status = RtsPciStopDevice(DeviceObject, Irp);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> IRP_MN_REMOVE_DEVICE:</span><br><span class="line">            <span class="comment">// �Ƴ��豸</span></span><br><span class="line">            status = RtsPciRemoveDevice(DeviceObject, Irp);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> IRP_MN_SURPRISE_REMOVAL:</span><br><span class="line">            <span class="comment">// �����Ƴ�</span></span><br><span class="line">            status = RtsPciSurpriseRemoval(DeviceObject, Irp);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// ����PnP IRP���ݸ��²�</span></span><br><span class="line">            IoSkipCurrentIrpStackLocation(Irp);</span><br><span class="line">            status = IoCallDriver(devExt-&gt;LowerDeviceObject, Irp);</span><br><span class="line">            <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �����豸</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciStartDevice</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_OBJECT DeviceObject,</span></span><br><span class="line"><span class="params">    _In_ PIRP Irp</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_EXTENSION devExt = (PDEVICE_EXTENSION)DeviceObject-&gt;DeviceExtension;</span><br><span class="line">    PIO_STACK_LOCATION irpStack = IoGetCurrentIrpStackLocation(Irp);</span><br><span class="line">    PCM_PARTIAL_RESOURCE_LIST rawList, transList;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡԭʼ��ת�������Դ�б�</span></span><br><span class="line">    rawList = &amp;irpStack-&gt;Parameters.StartDevice.AllocatedResources-&gt;List[<span class="number">0</span>].PartialResourceList;</span><br><span class="line">    transList = &amp;irpStack-&gt;Parameters.StartDevice.AllocatedResourceList-&gt;List[<span class="number">0</span>].PartialResourceList;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ӳ��Ӳ����Դ</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; transList-&gt;Count; i++) &#123;</span><br><span class="line">        PCM_PARTIAL_RESOURCE_DESCRIPTOR res = &amp;transList-&gt;PartialDescriptors[i];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (res-&gt;Type) &#123;</span><br><span class="line">            <span class="keyword">case</span> CmResourceTypeMemory:</span><br><span class="line">                <span class="comment">// ӳ��Ĵ����ռ�</span></span><br><span class="line">                devExt-&gt;RegisterBase = MmMapIoSpace(res-&gt;u.Memory.Start,</span><br><span class="line">                                                  res-&gt;u.Memory.Length,</span><br><span class="line">                                                  MmNonCached);</span><br><span class="line">                devExt-&gt;RegisterLength = res-&gt;u.Memory.Length;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> CmResourceTypeInterrupt:</span><br><span class="line">                <span class="comment">// �����ж�</span></span><br><span class="line">                status = IoConnectInterrupt(&amp;devExt-&gt;InterruptObject,</span><br><span class="line">                                          RtsPciIsr,</span><br><span class="line">                                          devExt,</span><br><span class="line">                                          &amp;devExt-&gt;SpinLock,</span><br><span class="line">                                          res-&gt;u.Interrupt.Vector,</span><br><span class="line">                                          res-&gt;u.Interrupt.Level,</span><br><span class="line">                                          res-&gt;u.Interrupt.Level,</span><br><span class="line">                                          res-&gt;u.Interrupt.Affinity,</span><br><span class="line">                                          FALSE);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ��Ӳ��</span></span><br><span class="line">    status = RtsPciInitializeHardware(devExt);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���IRP</span></span><br><span class="line">    Irp-&gt;IoStatus.Status = status;</span><br><span class="line">    IoCompleteRequest(Irp, IO_NO_INCREMENT);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ�����ַ�����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciPower</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_OBJECT DeviceObject,</span></span><br><span class="line"><span class="params">    _In_ PIRP Irp</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_EXTENSION devExt = (PDEVICE_EXTENSION)DeviceObject-&gt;DeviceExtension;</span><br><span class="line">    PIO_STACK_LOCATION irpStack = IoGetCurrentIrpStackLocation(Irp);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (irpStack-&gt;MinorFunction) &#123;</span><br><span class="line">        <span class="keyword">case</span> IRP_MN_SET_POWER:</span><br><span class="line">            <span class="keyword">if</span> (irpStack-&gt;Parameters.Power.Type == DevicePowerState) &#123;</span><br><span class="line">                <span class="comment">// �����豸��Դ״̬�仯</span></span><br><span class="line">                DEVICE_POWER_STATE newState = </span><br><span class="line">                    irpStack-&gt;Parameters.Power.State.DeviceState;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">if</span> (newState == PowerDeviceD0) &#123;</span><br><span class="line">                    <span class="comment">// �����豸</span></span><br><span class="line">                    RtsPciPowerUp(devExt);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// �����豸</span></span><br><span class="line">                    RtsPciPowerDown(devExt);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    PoStartNextPowerIrp(Irp);</span><br><span class="line">    IoSkipCurrentIrpStackLocation(Irp);</span><br><span class="line">    <span class="keyword">return</span> PoCallDriver(devExt-&gt;LowerDeviceObject, Irp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �жϷ�������</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PKINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ PVOID Context</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_EXTENSION devExt = (PDEVICE_EXTENSION)Context;</span><br><span class="line">    BOOLEAN handled = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡ�ж�״̬</span></span><br><span class="line">    ULONG intStatus = READ_REGISTER_ULONG(</span><br><span class="line">        (PULONG)(devExt-&gt;RegisterBase + INT_STATUS_OFFSET));</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (intStatus) &#123;</span><br><span class="line">        <span class="comment">// �����ж�</span></span><br><span class="line">        <span class="keyword">if</span> (intStatus &amp; CARD_INSERT_INT) &#123;</span><br><span class="line">            devExt-&gt;CardPresent = TRUE;</span><br><span class="line">            handled = TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (intStatus &amp; CARD_REMOVE_INT) &#123;</span><br><span class="line">            devExt-&gt;CardPresent = FALSE;</span><br><span class="line">            handled = TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����ж�״̬</span></span><br><span class="line">        WRITE_REGISTER_ULONG(</span><br><span class="line">            (PULONG)(devExt-&gt;RegisterBase + INT_STATUS_OFFSET),</span><br><span class="line">            intStatus);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Ҫ�ص㣺</p>
<ol>
<li>ʹ��WDM��׼�ܹ���</li>
</ol>
<ul>
<li>AddDevice����FDO</li>
<li>����PnP��Power IRP</li>
<li>ʵ���жϴ���</li>
<li>��Դ����</li>
</ul>
<ol start="2">
<li>Ӳ�����ʣ�</li>
</ol>
<ul>
<li>ӳ��PCI��Դ</li>
<li>�Ĵ�����д</li>
<li>DMA����</li>
<li>�жϴ���</li>
</ul>
<ol start="3">
<li>��Դ������</li>
</ol>
<ul>
<li>D0&#x2F;D3״̬ת��</li>
<li>����Դ����</li>
<li>ʱ�ӹ���</li>
</ul>
<ol start="4">
<li>ͬ�����ƣ�</li>
</ol>
<ul>
<li>SpinLock����</li>
<li>�¼�֪ͨ</li>
<li>IRP����</li>
</ul>
<p>����ʵ�ַ�ʽ����WDM�����ܹ����ܹ��ܺõ�֧��PCIe SD Host Controller�Ĺ��ܡ�</p>
<h2 id="User-19"><a href="#User-19" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>��WDF���ʵ��RtsPer.sys</p>
<h2 id="AI-claude-3-5-sonnet-19"><a href="#AI-claude-3-5-sonnet-19" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>ʹ��WDFʵ��RtsPer.sys����Ҫ�ܹ����£�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_CONTEXT</span> &#123;</span></span><br><span class="line">    WDFDEVICE       Device;</span><br><span class="line">    WDFINTERRUPT    Interrupt;</span><br><span class="line">    WDFDMAENABLER   DmaEnabler;</span><br><span class="line">    WDFSPINLOCK     Lock;</span><br><span class="line">    WDFQUEUE        IoQueue;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Ĵ���ӳ��</span></span><br><span class="line">    PVOID           RegisterBase;</span><br><span class="line">    ULONG           RegisterLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    BOOLEAN         CardPresent;</span><br><span class="line">    BOOLEAN         Initialized;</span><br><span class="line">    ULONG           Capabilities;</span><br><span class="line">    DEVICE_POWER_STATE PowerState;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA���</span></span><br><span class="line">    PVOID           DmaBuffer;</span><br><span class="line">    PHYSICAL_ADDRESS DmaPhysicalAddress;</span><br><span class="line">    SIZE_T          DmaBufferSize;</span><br><span class="line">    </span><br><span class="line">&#125; DEVICE_CONTEXT, *PDEVICE_CONTEXT;</span><br><span class="line"></span><br><span class="line">WDF_DECLARE_CONTEXT_TYPE_WITH_NAME(DEVICE_CONTEXT, GetDeviceContext)</span><br><span class="line"></span><br><span class="line"><span class="comment">// �������</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;config, RtsPciEvtDeviceAdd);</span><br><span class="line">    </span><br><span class="line">    status = WdfDriverCreate(DriverObject,</span><br><span class="line">                           RegistryPath,</span><br><span class="line">                           WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                           &amp;config,</span><br><span class="line">                           WDF_NO_HANDLE);</span><br><span class="line">                           </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �豸���ӻص�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceAdd</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDRIVER Driver,</span></span><br><span class="line"><span class="params">    _Inout_ PWDFDEVICE_INIT DeviceInit</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES deviceAttributes;</span><br><span class="line">    WDFDEVICE device;</span><br><span class="line">    PDEVICE_CONTEXT deviceContext;</span><br><span class="line">    WDF_PNPPOWER_EVENT_CALLBACKS pnpPowerCallbacks;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����PnP Power�ص�</span></span><br><span class="line">    WDF_PNPPOWER_EVENT_CALLBACKS_INIT(&amp;pnpPowerCallbacks);</span><br><span class="line">    pnpPowerCallbacks.EvtDevicePrepareHardware = RtsPciEvtPrepareHardware;</span><br><span class="line">    pnpPowerCallbacks.EvtDeviceReleaseHardware = RtsPciEvtReleaseHardware;</span><br><span class="line">    pnpPowerCallbacks.EvtDeviceD0Entry = RtsPciEvtDeviceD0Entry;</span><br><span class="line">    pnpPowerCallbacks.EvtDeviceD0Exit = RtsPciEvtDeviceD0Exit;</span><br><span class="line">    </span><br><span class="line">    WdfDeviceInitSetPnpPowerEventCallbacks(DeviceInit, &amp;pnpPowerCallbacks);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����豸</span></span><br><span class="line">    WDF_OBJECT_ATTRIBUTES_INIT_CONTEXT_TYPE(&amp;deviceAttributes, DEVICE_CONTEXT);</span><br><span class="line">    </span><br><span class="line">    status = WdfDeviceCreate(&amp;DeviceInit,</span><br><span class="line">                            &amp;deviceAttributes,</span><br><span class="line">                            &amp;device);</span><br><span class="line">                            </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����ж�</span></span><br><span class="line">    WDF_INTERRUPT_CONFIG interruptConfig;</span><br><span class="line">    WDF_INTERRUPT_CONFIG_INIT(&amp;interruptConfig,</span><br><span class="line">                            RtsPciEvtInterruptIsr,</span><br><span class="line">                            RtsPciEvtInterruptDpc);</span><br><span class="line">                            </span><br><span class="line">    status = WdfInterruptCreate(device,</span><br><span class="line">                               &amp;interruptConfig,</span><br><span class="line">                               WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                               &amp;deviceContext-&gt;Interrupt);</span><br><span class="line">                               </span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">    WDF_DMA_ENABLER_CONFIG dmaConfig;</span><br><span class="line">    WDF_DMA_ENABLER_CONFIG_INIT(&amp;dmaConfig,</span><br><span class="line">                               WdfDmaProfileScatterGather,</span><br><span class="line">                               RTSPER_MAX_TRANSFER_LENGTH);</span><br><span class="line">                               </span><br><span class="line">    status = WdfDmaEnablerCreate(device,</span><br><span class="line">                                &amp;dmaConfig,</span><br><span class="line">                                WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                                &amp;deviceContext-&gt;DmaEnabler);</span><br><span class="line">                                </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ׼��Ӳ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtPrepareHardware</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceList,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceListTranslated</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ӳ����Դ</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; WdfCmResourceListGetCount(ResourceListTranslated); i++) &#123;</span><br><span class="line">        PCM_PARTIAL_RESOURCE_DESCRIPTOR res = </span><br><span class="line">            WdfCmResourceListGetDescriptor(ResourceListTranslated, i);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">switch</span> (res-&gt;Type) &#123;</span><br><span class="line">            <span class="keyword">case</span> CmResourceTypeMemory:</span><br><span class="line">                devContext-&gt;RegisterBase = MmMapIoSpaceEx(</span><br><span class="line">                    res-&gt;u.Memory.Start,</span><br><span class="line">                    res-&gt;u.Memory.Length,</span><br><span class="line">                    PAGE_READWRITE | PAGE_NOCACHE);</span><br><span class="line">                devContext-&gt;RegisterLength = res-&gt;u.Memory.Length;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ��Ӳ��</span></span><br><span class="line">    status = RtsPciInitializeHardware(devContext);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �ж�ISR</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciEvtInterruptIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ ULONG MessageID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(</span><br><span class="line">        WdfInterruptGetDevice(Interrupt));</span><br><span class="line">    BOOLEAN handled = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡ�ж�״̬</span></span><br><span class="line">    ULONG intStatus = READ_REGISTER_ULONG(</span><br><span class="line">        (PULONG)(devContext-&gt;RegisterBase + INT_STATUS_OFFSET));</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (intStatus) &#123;</span><br><span class="line">        <span class="comment">// �����ж�</span></span><br><span class="line">        <span class="keyword">if</span> (intStatus &amp; CARD_INSERT_INT) &#123;</span><br><span class="line">            WdfInterruptQueueDpcForIsr(Interrupt);</span><br><span class="line">            handled = TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����ж�״̬</span></span><br><span class="line">        WRITE_REGISTER_ULONG(</span><br><span class="line">            (PULONG)(devContext-&gt;RegisterBase + INT_STATUS_OFFSET),</span><br><span class="line">            intStatus);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �ж�DPC</span></span><br><span class="line">VOID <span class="title function_">RtsPciEvtInterruptDpc</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ WDFOBJECT Device</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����������/�γ�</span></span><br><span class="line">    <span class="keyword">if</span> (RtsPciIsCardPresent(devContext)) &#123;</span><br><span class="line">        RtsPciHandleCardInsertion(devContext);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        RtsPciHandleCardRemoval(devContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ���� - D0����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceD0Entry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDF_POWER_DEVICE_STATE PreviousState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ϵ�����</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        (PULONG)(devContext-&gt;RegisterBase + POWER_CTRL),</span><br><span class="line">        POWER_ON);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ��ʼ��ʱ��</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        (PULONG)(devContext-&gt;RegisterBase + CLOCK_CTRL),</span><br><span class="line">        CLOCK_ON);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ʹ���ж�</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        (PULONG)(devContext-&gt;RegisterBase + INT_ENABLE),</span><br><span class="line">        INT_ENABLE_ALL);</span><br><span class="line">        </span><br><span class="line">    devContext-&gt;PowerState = PowerDeviceD0;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ���� - D0�˳�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceD0Exit</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDF_POWER_DEVICE_STATE TargetState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����ж�</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        (PULONG)(devContext-&gt;RegisterBase + INT_ENABLE),</span><br><span class="line">        <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// �ر�ʱ��</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        (PULONG)(devContext-&gt;RegisterBase + CLOCK_CTRL),</span><br><span class="line">        CLOCK_OFF);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// �رյ�Դ</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        (PULONG)(devContext-&gt;RegisterBase + POWER_CTRL),</span><br><span class="line">        POWER_OFF);</span><br><span class="line">        </span><br><span class="line">    devContext-&gt;PowerState = PowerDeviceD3;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Ҫ�ص㣺</p>
<ol>
<li>ʹ��WDF��ܣ�</li>
</ol>
<ul>
<li>�򻯵�PnP&#x2F;Power����</li>
<li>�Զ�����Դ����</li>
<li>���ö����������ڹ���</li>
</ul>
<ol start="2">
<li>�豸�����ģ�</li>
</ol>
<ul>
<li>ͳһ���豸״̬����</li>
<li>WDF�����װ</li>
<li>�򻯵�ͬ������</li>
</ul>
<ol start="3">
<li>�жϴ�����</li>
</ol>
<ul>
<li>ISR&#x2F;DPCģ��</li>
<li>WDF�ж϶���</li>
<li>�Զ����жϹ���</li>
</ul>
<ol start="4">
<li>DMA֧�֣�</li>
</ol>
<ul>
<li>WDF DMA���</li>
<li>�򻯵�DMA����</li>
<li>�Զ�����Դ����</li>
</ul>
<ol start="5">
<li>��Դ������</li>
</ol>
<ul>
<li>�򻯵�D0&#x2F;D3ת��</li>
<li>�Զ�����Դ״̬����</li>
<li>���ɵĿ��м��</li>
</ul>
<p>����WDFʵ�����WDM���Ӽ��Ϳɿ��������˺ܶ�������롣</p>
<h2 id="User-20"><a href="#User-20" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>WDF���ʵ��SDЭ��ջ</p>
<h2 id="AI-claude-3-5-sonnet-20"><a href="#AI-claude-3-5-sonnet-20" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>ʹ��WDFʵ��SDЭ��ջ�Ĺؼ��������£�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SD����ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SD_COMMAND</span> &#123;</span></span><br><span class="line">    UCHAR CommandCode;</span><br><span class="line">    ULONG Argument;</span><br><span class="line">    UCHAR ResponseType;</span><br><span class="line">    ULONG Response[<span class="number">4</span>];</span><br><span class="line">    BOOLEAN HasData;</span><br><span class="line">    BOOLEAN IsWrite;</span><br><span class="line">    ULONG BlockCount;</span><br><span class="line">    ULONG BlockSize;</span><br><span class="line">&#125; SD_COMMAND, *PSD_COMMAND;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �豸��������չ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_CONTEXT</span> &#123;</span></span><br><span class="line">    <span class="comment">// ... ������Ա ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SDЭ�����</span></span><br><span class="line">    ULONG CardRCA;</span><br><span class="line">    ULONG CardStatus;</span><br><span class="line">    SD_CARD_TYPE CardType;</span><br><span class="line">    BOOLEAN HighCapacity;</span><br><span class="line">    BOOLEAN UhsSupport;</span><br><span class="line">    ULONG CurrentClock;</span><br><span class="line">    ULONG CurrentVoltage;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����/���ݻ���</span></span><br><span class="line">    WDFSPINLOCK CmdLock;</span><br><span class="line">    WDFREQUEST CurrentRequest;</span><br><span class="line">    WDFMEMORY CommandBuffer;</span><br><span class="line">    </span><br><span class="line">&#125; DEVICE_CONTEXT, *PDEVICE_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����SD����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciSendCommand</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PSD_COMMAND Command</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    ULONG cmdReg, statusReg;</span><br><span class="line">    LARGE_INTEGER timeout;</span><br><span class="line">    </span><br><span class="line">    WdfSpinLockAcquire(DevContext-&gt;CmdLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �ȴ������߿���</span></span><br><span class="line">    timeout.QuadPart = <span class="number">-10000000</span>; <span class="comment">// 1��</span></span><br><span class="line">    <span class="keyword">while</span> (READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + CMD_STATUS) &amp; CMD_BUSY) &#123;</span><br><span class="line">        <span class="keyword">if</span> (KeWaitForSingleObject(&amp;timeout, Executive, KernelMode, FALSE, <span class="literal">NULL</span>) == STATUS_TIMEOUT) &#123;</span><br><span class="line">            status = STATUS_IO_TIMEOUT;</span><br><span class="line">            <span class="keyword">goto</span> Exit;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����������</span></span><br><span class="line">    WRITE_REGISTER_ULONG(DevContext-&gt;RegisterBase + CMD_ARG, Command-&gt;Argument);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��������Ĵ���</span></span><br><span class="line">    cmdReg = (Command-&gt;CommandCode &lt;&lt; CMD_INDEX_SHIFT) |</span><br><span class="line">             (Command-&gt;ResponseType &lt;&lt; RESP_TYPE_SHIFT);</span><br><span class="line">             </span><br><span class="line">    <span class="keyword">if</span> (Command-&gt;HasData) &#123;</span><br><span class="line">        cmdReg |= CMD_DATA_PRESENT;</span><br><span class="line">        <span class="keyword">if</span> (Command-&gt;IsWrite) &#123;</span><br><span class="line">            cmdReg |= CMD_WRITE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    WRITE_REGISTER_ULONG(DevContext-&gt;RegisterBase + CMD_REG, cmdReg);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �ȴ��������</span></span><br><span class="line">    status = RtsPciWaitForCommandComplete(DevContext, &amp;statusReg);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> Exit;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ��ȡ��Ӧ</span></span><br><span class="line">    <span class="keyword">if</span> (Command-&gt;ResponseType != RESP_NONE) &#123;</span><br><span class="line">        Command-&gt;Response[<span class="number">0</span>] = READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + RESP0);</span><br><span class="line">        <span class="keyword">if</span> (Command-&gt;ResponseType == RESP_LONG) &#123;</span><br><span class="line">            Command-&gt;Response[<span class="number">1</span>] = READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + RESP1);</span><br><span class="line">            Command-&gt;Response[<span class="number">2</span>] = READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + RESP2);</span><br><span class="line">            Command-&gt;Response[<span class="number">3</span>] = READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + RESP3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">Exit:</span><br><span class="line">    WdfSpinLockRelease(DevContext-&gt;CmdLock);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ��SD��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    SD_COMMAND cmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����GO_IDLE_STATE (CMD0)</span></span><br><span class="line">    cmd.CommandCode = <span class="number">0</span>;</span><br><span class="line">    cmd.ResponseType = RESP_NONE;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����IF_COND (CMD8)</span></span><br><span class="line">    cmd.CommandCode = <span class="number">8</span>;</span><br><span class="line">    cmd.Argument = <span class="number">0x1AA</span>; <span class="comment">// 3.3V�ͼ��ģʽ</span></span><br><span class="line">    cmd.ResponseType = RESP_SHORT;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����ACMD41</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// �ȷ���APP_CMD (CMD55)</span></span><br><span class="line">        cmd.CommandCode = <span class="number">55</span>;</span><br><span class="line">        cmd.Argument = <span class="number">0</span>;</span><br><span class="line">        cmd.ResponseType = RESP_SHORT;</span><br><span class="line">        status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����SD_SEND_OP_COND (ACMD41)</span></span><br><span class="line">        cmd.CommandCode = <span class="number">41</span>;</span><br><span class="line">        cmd.Argument = <span class="number">0x40FF8000</span>; <span class="comment">// HCS=1, ֧�ֵ�ѹ��Χ</span></span><br><span class="line">        cmd.ResponseType = RESP_SHORT;</span><br><span class="line">        status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (cmd.Response[<span class="number">0</span>] &amp; <span class="number">0x80000000</span>) &#123;</span><br><span class="line">            <span class="comment">// ����ʼ�����</span></span><br><span class="line">            DevContext-&gt;HighCapacity = (cmd.Response[<span class="number">0</span>] &amp; <span class="number">0x40000000</span>) ? TRUE : FALSE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        KeStallExecutionProcessor(<span class="number">10000</span>); <span class="comment">// 10ms�ӳ�</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ��ȡCID (CMD2)</span></span><br><span class="line">    cmd.CommandCode = <span class="number">2</span>;</span><br><span class="line">    cmd.ResponseType = RESP_LONG;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ��ȡ��RCA (CMD3)</span></span><br><span class="line">    cmd.CommandCode = <span class="number">3</span>;</span><br><span class="line">    cmd.ResponseType = RESP_SHORT;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;CardRCA = cmd.Response[<span class="number">0</span>] &amp; <span class="number">0xFFFF0000</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ѡ�� (CMD7)</span></span><br><span class="line">    cmd.CommandCode = <span class="number">7</span>;</span><br><span class="line">    cmd.Argument = DevContext-&gt;CardRCA;</span><br><span class="line">    cmd.ResponseType = RESP_SHORT;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���ݴ���������</span></span><br><span class="line">VOID <span class="title function_">RtsPciEvtIoRead</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFQUEUE Queue,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> Length</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(WdfIoQueueGetDevice(Queue));</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    SD_COMMAND cmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    PVOID buffer;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡ����buffer</span></span><br><span class="line">    status = WdfRequestRetrieveOutputBuffer(Request, Length, &amp;buffer, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        WdfRequestComplete(Request, status);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ö�����</span></span><br><span class="line">    cmd.CommandCode = <span class="number">17</span>; <span class="comment">// READ_SINGLE_BLOCK</span></span><br><span class="line">    cmd.ResponseType = RESP_SHORT;</span><br><span class="line">    cmd.HasData = TRUE;</span><br><span class="line">    cmd.IsWrite = FALSE;</span><br><span class="line">    cmd.BlockCount = <span class="number">1</span>;</span><br><span class="line">    cmd.BlockSize = <span class="number">512</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">    status = RtsPciSetupDmaForTransfer(devContext, buffer, Length);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        WdfRequestComplete(Request, status);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">    devContext-&gt;CurrentRequest = Request;</span><br><span class="line">    status = RtsPciSendCommand(devContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        WdfRequestComplete(Request, status);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ������жϴ�����</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �жϴ�������ɴ���</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciEvtInterruptIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ ULONG MessageID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(WdfInterruptGetDevice(Interrupt));</span><br><span class="line">    ULONG intStatus;</span><br><span class="line">    BOOLEAN handled = FALSE;</span><br><span class="line">    </span><br><span class="line">    intStatus = READ_REGISTER_ULONG(devContext-&gt;RegisterBase + INT_STATUS);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; XFER_COMPLETE) &#123;</span><br><span class="line">        <span class="keyword">if</span> (devContext-&gt;CurrentRequest) &#123;</span><br><span class="line">            WdfRequestComplete(devContext-&gt;CurrentRequest, STATUS_SUCCESS);</span><br><span class="line">            devContext-&gt;CurrentRequest = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        handled = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; ERROR_INT) &#123;</span><br><span class="line">        <span class="keyword">if</span> (devContext-&gt;CurrentRequest) &#123;</span><br><span class="line">            WdfRequestComplete(devContext-&gt;CurrentRequest, STATUS_IO_DEVICE_ERROR);</span><br><span class="line">            devContext-&gt;CurrentRequest = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        handled = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ж�״̬</span></span><br><span class="line">    WRITE_REGISTER_ULONG(devContext-&gt;RegisterBase + INT_STATUS, intStatus);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ��㣺</p>
<ol>
<li>�������</li>
</ol>
<ul>
<li>������й���</li>
<li>��Ӧ����</li>
<li>��ʱ����</li>
</ul>
<ol start="2">
<li>���ݴ��䣺</li>
</ol>
<ul>
<li>DMA����</li>
<li>����������</li>
<li>���֪ͨ</li>
</ul>
<ol start="3">
<li>��������</li>
</ol>
<ul>
<li>�������ָ�</li>
<li>���������</li>
<li>��ʱ�ָ�</li>
</ul>
<ol start="4">
<li>״̬������</li>
</ol>
<ul>
<li>��״̬����</li>
<li>��ѹ����</li>
<li>ʱ�ӹ���</li>
</ul>
<ol start="5">
<li>�����Ż���</li>
</ol>
<ul>
<li>DMA����</li>
<li>�жϺϲ�</li>
<li>������ˮ��</li>
</ul>
<p>��ֻ�ǻ�����ܣ�ʵ��ʵ�ֻ���Ҫ���ǣ�</p>
<ul>
<li>UHSģʽ֧��</li>
<li>��鴫��</li>
<li>��Դ����</li>
<li>����ָ�</li>
<li>����֧��</li>
</ul>
<h2 id="User-21"><a href="#User-21" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>���ʵ��SD������SD Host�󣬱�ʶ��ΪSD�洢�豸����ϵͳ��ʾ�̷�</p>
<h2 id="AI-claude-3-5-sonnet-21"><a href="#AI-claude-3-5-sonnet-21" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>Ҫʵ��SD����ʶ��Ϊ�洢�豸����ʾ�̷�����Ҫ���¹ؼ����裺</p>
<ol>
<li>�豸�ӿں�����������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��EvtDeviceAdd��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceAdd</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDRIVER Driver,</span></span><br><span class="line"><span class="params">    _Inout_ PWDFDEVICE_INIT DeviceInit</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ����Ϊ�洢�豸</span></span><br><span class="line">    WdfDeviceInitSetDeviceClass(DeviceInit, &amp;GUID_DEVCLASS_SCSIADAPTER);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ע��洢�ӿ�</span></span><br><span class="line">    status = WdfDeviceCreateDeviceInterface(</span><br><span class="line">        device,</span><br><span class="line">        &amp;GUID_DEVINTERFACE_DISK,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// �����豸����</span></span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES pnpCaps;</span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES_INIT(&amp;pnpCaps);</span><br><span class="line">    pnpCaps.Removable = WdfTrue;</span><br><span class="line">    pnpCaps.SurpriseRemovalOK = WdfTrue;</span><br><span class="line">    WdfDeviceSetPnpCapabilities(device, &amp;pnpCaps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ʵ�ִ洢��ӿڣ�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">STOR_DEVICE_INTERFACE</span> &#123;</span></span><br><span class="line">    STOR_SCSI_IDENTITY Identity;</span><br><span class="line">    STOR_ADAPTER_CONTROL_TYPE AdapterControl;</span><br><span class="line">    STOR_HW_CALLBACKS Callbacks;</span><br><span class="line">&#125; STOR_DEVICE_INTERFACE, *PSTOR_DEVICE_INTERFACE;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeStorageInterface</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    STOR_DEVICE_INTERFACE storInterface = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����豸��ʶ</span></span><br><span class="line">    storInterface.Identity.DeviceType = FILE_DEVICE_DISK;</span><br><span class="line">    storInterface.Identity.DeviceTypeModifier = <span class="number">0</span>;</span><br><span class="line">    storInterface.Identity.RemovableMedia = TRUE;</span><br><span class="line">    storInterface.Identity.VendorIdOffset = <span class="number">0</span>;</span><br><span class="line">    storInterface.Identity.ProductIdOffset = <span class="number">8</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ûص�</span></span><br><span class="line">    storInterface.Callbacks.StartIo = RtsPciStartIo;</span><br><span class="line">    storInterface.Callbacks.BuildIo = RtsPciBuildIo;</span><br><span class="line">    storInterface.Callbacks.Initialize = RtsPciInitialize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ע��ӿ�</span></span><br><span class="line">    <span class="keyword">return</span> StorPortRegisterInterface(</span><br><span class="line">        DevContext-&gt;WdfDevice,</span><br><span class="line">        &amp;storInterface);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>����SCSI���</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciStartIo</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PSTOR_REQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PCDB cdb = Request-&gt;Cdb;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (cdb-&gt;CDB6GENERIC.OperationCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> SCSIOP_READ:</span><br><span class="line">            <span class="keyword">return</span> RtsPciHandleRead(DevContext, Request);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SCSIOP_WRITE:</span><br><span class="line">            <span class="keyword">return</span> RtsPciHandleWrite(DevContext, Request);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SCSIOP_INQUIRY:</span><br><span class="line">            <span class="keyword">return</span> RtsPciHandleInquiry(DevContext, Request);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SCSIOP_READ_CAPACITY:</span><br><span class="line">            <span class="keyword">return</span> RtsPciHandleReadCapacity(DevContext, Request);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SCSIOP_TEST_UNIT_READY:</span><br><span class="line">            <span class="keyword">return</span> RtsPciHandleTestUnitReady(DevContext, Request);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_INVALID_DEVICE_REQUEST;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleRead</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PSTOR_REQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PCDB cdb = Request-&gt;Cdb;</span><br><span class="line">    ULONGLONG startSector;</span><br><span class="line">    ULONG numSectors;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡ��ʼ����������</span></span><br><span class="line">    startSector = ((ULONGLONG)cdb-&gt;CDB10.LogicalBlockByte3 &lt;&lt; <span class="number">24</span>) |</span><br><span class="line">                 ((ULONGLONG)cdb-&gt;CDB10.LogicalBlockByte2 &lt;&lt; <span class="number">16</span>) |</span><br><span class="line">                 ((ULONGLONG)cdb-&gt;CDB10.LogicalBlockByte1 &lt;&lt; <span class="number">8</span>) |</span><br><span class="line">                  (ULONGLONG)cdb-&gt;CDB10.LogicalBlockByte0;</span><br><span class="line">                  </span><br><span class="line">    numSectors = ((ULONG)cdb-&gt;CDB10.TransferBlocksMsb &lt;&lt; <span class="number">8</span>) |</span><br><span class="line">                 (ULONG)cdb-&gt;CDB10.TransferBlocksLsb;</span><br><span class="line">                 </span><br><span class="line">    <span class="comment">// ����SD����</span></span><br><span class="line">    SD_COMMAND sdCmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    sdCmd.CommandCode = <span class="number">18</span>; <span class="comment">// READ_MULTIPLE_BLOCK</span></span><br><span class="line">    sdCmd.Argument = DevContext-&gt;HighCapacity ? startSector : (startSector * <span class="number">512</span>);</span><br><span class="line">    sdCmd.ResponseType = RESP_SHORT;</span><br><span class="line">    sdCmd.HasData = TRUE;</span><br><span class="line">    sdCmd.IsWrite = FALSE;</span><br><span class="line">    sdCmd.BlockCount = numSectors;</span><br><span class="line">    sdCmd.BlockSize = <span class="number">512</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">    status = RtsPciSetupDmaForRequest(DevContext, Request);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">    <span class="keyword">return</span> RtsPciSendCommand(DevContext, &amp;sdCmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����INQUIRY����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleInquiry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PSTOR_REQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PINQUIRYDATA inquiryData = Request-&gt;DataBuffer;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(inquiryData, <span class="keyword">sizeof</span>(INQUIRYDATA));</span><br><span class="line">    </span><br><span class="line">    inquiryData-&gt;DeviceType = DIRECT_ACCESS_DEVICE;</span><br><span class="line">    inquiryData-&gt;RemovableMedia = <span class="number">1</span>;</span><br><span class="line">    inquiryData-&gt;Versions = <span class="number">0x05</span>; <span class="comment">// SPC-3</span></span><br><span class="line">    inquiryData-&gt;ResponseDataFormat = <span class="number">0x02</span>;</span><br><span class="line">    inquiryData-&gt;AdditionalLength = <span class="number">31</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ó��̺Ͳ�Ʒ��Ϣ</span></span><br><span class="line">    RtlCopyMemory(inquiryData-&gt;VendorId, <span class="string">&quot;SD CARD &quot;</span>, <span class="number">8</span>);</span><br><span class="line">    RtlCopyMemory(inquiryData-&gt;ProductId, <span class="string">&quot;Mass Storage  &quot;</span>, <span class="number">16</span>);</span><br><span class="line">    RtlCopyMemory(inquiryData-&gt;ProductRevisionLevel, <span class="string">&quot;1.00&quot;</span>, <span class="number">4</span>);</span><br><span class="line">    </span><br><span class="line">    Request-&gt;DataTransferLength = <span class="keyword">sizeof</span>(INQUIRYDATA);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>����δ�����</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">RtsPciHandleCardInsertion</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ʼ����</span></span><br><span class="line">    status = RtsPciInitializeCard(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ȡ����Ϣ</span></span><br><span class="line">    status = RtsPciGetCardInfo(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ֪ͨ�洢������</span></span><br><span class="line">    StorPortNotifyMediaStatus(</span><br><span class="line">        DevContext-&gt;WdfDevice,</span><br><span class="line">        STOR_MEDIA_STATUS_PRESENT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">RtsPciHandleCardRemoval</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ֪ͨ�洢������</span></span><br><span class="line">    StorPortNotifyMediaStatus(</span><br><span class="line">        DevContext-&gt;WdfDevice,</span><br><span class="line">        STOR_MEDIA_STATUS_NOT_PRESENT);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ����״̬</span></span><br><span class="line">    DevContext-&gt;CardPresent = FALSE;</span><br><span class="line">    DevContext-&gt;CardRCA = <span class="number">0</span>;</span><br><span class="line">    DevContext-&gt;HighCapacity = FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>��Դ������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceD0Entry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDF_POWER_DEVICE_STATE PreviousState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �ϵ�����</span></span><br><span class="line">    status = RtsPciPowerUpSequence(devContext);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��������ڣ����³�ʼ��</span></span><br><span class="line">    <span class="keyword">if</span> (RtsPciIsCardPresent(devContext)) &#123;</span><br><span class="line">        status = RtsPciInitializeCard(devContext);</span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            StorPortNotifyMediaStatus(</span><br><span class="line">                devContext-&gt;WdfDevice,</span><br><span class="line">                STOR_MEDIA_STATUS_PRESENT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ��㣺</p>
<ol>
<li>�豸��ʶ��</li>
</ol>
<ul>
<li>��ȷע��Ϊ�洢�豸</li>
<li>ʵ�ֱ�Ҫ��SCSI����</li>
<li>�ṩ�豸��Ϣ</li>
</ul>
<ol start="2">
<li>���ݴ��䣺</li>
</ol>
<ul>
<li>����ӳ��</li>
<li>DMA֧��</li>
<li>������</li>
</ul>
<ol start="3">
<li>ý�������</li>
</ol>
<ul>
<li>��μ��</li>
<li>״̬֪ͨ</li>
<li>��Դ����</li>
</ul>
<ol start="4">
<li>�����Ż���</li>
</ol>
<ul>
<li>�������</li>
<li>��鴫��</li>
<li>�������</li>
</ul>
<ol start="5">
<li>�ɿ��ԣ�</li>
</ol>
<ul>
<li>����ָ�</li>
<li>��ʱ����</li>
<li>״̬ͬ��</li>
</ul>
<p>����ʵ�ֺ󣬵�SD������ʱ��Windows�Ὣ��ʶ��Ϊ���ƶ����̲������̷���</p>
<h2 id="User-22"><a href="#User-22" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>SD��Ӧ�÷���Ϊ�洢�豸����û�����������ʵ�ѡ��</p>
<h2 id="AI-claude-3-5-sonnet-22"><a href="#AI-claude-3-5-sonnet-22" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>SD��Ӧ��ʹ��SD Bus&#x2F;SD Storage����������Windows�У�SD�豸��ר�ŵ���GUID��������ܣ�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �豸�ӿ�GUID</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GUID_SD_DEVICE_INTERFACE \</span></span><br><span class="line"><span class="meta">    &#123;0x6e1e80b9, 0xad45, 0x46f6, &#123;0xb6, 0x5d, 0x4f, 0x45, 0x45, 0x9d, 0xa8, 0x1f&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// SD���߽ӿ�GUID    </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GUID_DEVINTERFACE_SD_HOST_CONTROLLER \</span></span><br><span class="line"><span class="meta">    &#123;0x4b36e968, 0x2353, 0x4ee2, &#123;0x8c, 0xe5, 0x8c, 0x62, 0x0e, 0x14, 0x88, 0x9b&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ��EvtDeviceAdd��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceAdd</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDRIVER Driver,</span></span><br><span class="line"><span class="params">    _Inout_ PWDFDEVICE_INIT DeviceInit</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ����ΪSD Host Controller</span></span><br><span class="line">    WdfDeviceInitSetDeviceClass(DeviceInit, &amp;GUID_DEVCLASS_SD_HOST_CONTROLLER);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����SD���߽ӿ�</span></span><br><span class="line">    status = WdfDeviceCreateDeviceInterface(</span><br><span class="line">        device,</span><br><span class="line">        &amp;GUID_DEVINTERFACE_SD_HOST_CONTROLLER,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// �����豸����</span></span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES pnpCaps;</span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES_INIT(&amp;pnpCaps);</span><br><span class="line">    pnpCaps.Removable = WdfTrue;</span><br><span class="line">    pnpCaps.SurpriseRemovalOK = WdfTrue;</span><br><span class="line">    WdfDeviceSetPnpCapabilities(device, &amp;pnpCaps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>����Windows��ʹ�ñ�׼��SD��������(sdbus.sys)��SD�洢������(sdstor.sys)�������豸����������SCSI&#x2F;�洢·�������Ǹ����ʵķ��෽ʽ��</p>
<h2 id="User-23"><a href="#User-23" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�����Զ����SD Host Controller������realtek, Bayhub��SD Host������SD��������(sdbus.sys)��SD�洢������(sdstor.sys)</p>
<h2 id="AI-claude-3-5-sonnet-23"><a href="#AI-claude-3-5-sonnet-23" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>���ڳ����Զ����SD Host Controller��ͨ�������ַ�����</p>
<ol>
<li>ʹ�ó����Լ�������ʵ��������SDЭ��ջ��</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �豸���Ͷ���</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GUID_DEVCLASS_RTSPER \</span></span><br><span class="line"><span class="meta">    &#123;0x4b36e968, 0x2353, 0x4ee2, &#123;0x8c, 0xe5, 0x8c, 0x62, 0x0e, 0x14, 0x88, 0x9b&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_CONTEXT</span> &#123;</span></span><br><span class="line">    WDFDEVICE       Device;</span><br><span class="line">    WDFINTERRUPT    Interrupt;</span><br><span class="line">    WDFDMAENABLER   DmaEnabler;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Զ���Ĵ�������</span></span><br><span class="line">    PVOID           RegisterBase;</span><br><span class="line">    ULONG           RegisterLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Զ���SDЭ��ʵ��</span></span><br><span class="line">    ULONG           CardStatus;</span><br><span class="line">    ULONG           CardRCA;</span><br><span class="line">    BOOLEAN         HighCapacity;</span><br><span class="line">    ULONG           CurrentClock;</span><br><span class="line">    ULONG           CurrentVoltage;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���������ض��ֶ�</span></span><br><span class="line">    ...</span><br><span class="line">&#125; DEVICE_CONTEXT, *PDEVICE_CONTEXT;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ʵ�ּ��ݲ���ʹ�ñ�׼SD����������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ʵ�ֱ�׼SD Host Controller�ӿ�</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SDHOST_CAPABILITIES</span> &#123;</span></span><br><span class="line">    ULONG           SpecVersion;     <span class="comment">// SD�淶�汾</span></span><br><span class="line">    ULONG           MaxBlockSize;    <span class="comment">// �����С</span></span><br><span class="line">    ULONG           MaxClockFreq;    <span class="comment">// ���ʱ��Ƶ��</span></span><br><span class="line">    SD_HOST_CAPS    Capabilities;    <span class="comment">// ��׼����</span></span><br><span class="line">    BOOLEAN         BusWidth4Bit;    <span class="comment">// 4λ����֧��</span></span><br><span class="line">    BOOLEAN         HighSpeed;       <span class="comment">// ����ģʽ֧��</span></span><br><span class="line">&#125; SDHOST_CAPABILITIES, *PSDHOST_CAPABILITIES;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �Ĵ���ӳ���</span></span><br><span class="line">NTSTATUS <span class="title function_">MapVendorRegistersToStandard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _Out_ PSD_HOST_REGISTERS StdRegs</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ӳ�䳧���ض��Ĵ�������׼SD�Ĵ�������</span></span><br><span class="line">    StdRegs-&gt;CommandRegister = DevContext-&gt;RegisterBase + VENDOR_CMD_OFFSET;</span><br><span class="line">    StdRegs-&gt;ArgumentRegister = DevContext-&gt;RegisterBase + VENDOR_ARG_OFFSET;</span><br><span class="line">    StdRegs-&gt;DataRegister = DevContext-&gt;RegisterBase + VENDOR_DATA_OFFSET;</span><br><span class="line">    StdRegs-&gt;PresentStateRegister = DevContext-&gt;RegisterBase + VENDOR_STATE_OFFSET;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����ת����</span></span><br><span class="line">NTSTATUS <span class="title function_">TranslateStandardToVendorCommand</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PSD_COMMAND StdCmd,</span></span><br><span class="line"><span class="params">    _Out_ PVENDOR_SD_COMMAND VendorCmd</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ת����׼SD��������ض���ʽ</span></span><br><span class="line">    VendorCmd-&gt;CmdIndex = StdCmd-&gt;Index;</span><br><span class="line">    VendorCmd-&gt;CmdArg = StdCmd-&gt;Argument;</span><br><span class="line">    VendorCmd-&gt;RespType = MapResponseType(StdCmd-&gt;ResponseType);</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��ʵ���ϣ����������(����Realtek��Bayhub)ѡ�񷽰�1��ԭ���ǣ�</p>
<ol>
<li>���������ԣ�</li>
</ol>
<ul>
<li>�Ǳ�׼�Ĵ�������</li>
<li>�����ʱ��Ҫ��</li>
<li>�Զ����DMA����</li>
<li>�����ض��Ĺ���</li>
</ul>
<ol start="2">
<li>���ܿ��ǣ�</li>
</ol>
<ul>
<li>����ת������</li>
<li>�Ż��ض�����</li>
<li>ֱ��Ӳ������</li>
</ul>
<ol start="3">
<li>�����ԣ�</li>
</ol>
<ul>
<li>֧�־ɰ�Windows</li>
<li>����Ӳ��Ҫ��</li>
<li>���ƻ�����</li>
</ul>
<ol start="4">
<li>ά���ԣ�</li>
</ol>
<ul>
<li>��������</li>
<li>�������</li>
<li>���ⶨλ</li>
</ul>
<p>����ͨ����ʵ�ַ�ʽ�ǣ�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �������</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ��WDF����</span></span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;config, RtsPciEvtDeviceAdd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> WdfDriverCreate(DriverObject,</span><br><span class="line">                          RegistryPath,</span><br><span class="line">                          WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                          &amp;config,</span><br><span class="line">                          WDF_NO_HANDLE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ʵ���Լ���SDЭ��ջ</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeSDStack</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ��ʼ��Ӳ��</span></span><br><span class="line">    status = RtsPciInitializeHardware(DevContext);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ʵ��SD�����</span></span><br><span class="line">    status = RtsPciInitializeCommandEngine(DevContext);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ʵ�����ݴ���</span></span><br><span class="line">    status = RtsPciInitializeDataEngine(DevContext);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ʵ���жϴ���</span></span><br><span class="line">    status = RtsPciInitializeInterrupt(DevContext);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ʵ�ִ洢�ӿ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeStorageInterface</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ʵ�ֿ��豸�ӿ�</span></span><br><span class="line">    status = RtsPciRegisterBlockInterface(DevContext);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ʵ�ַ�������</span></span><br><span class="line">    status = RtsPciInitializePartitionManager(DevContext);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>���ַ�ʽ��Ȼ�����������󣬵��ܸ��õؿ��ƺ��Ż��豸���ܡ�</p>
<h2 id="User-24"><a href="#User-24" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�����Զ����SD Host���ʵ�ִ洢�ӿ�</p>
<h2 id="AI-claude-3-5-sonnet-24"><a href="#AI-claude-3-5-sonnet-24" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�����Զ����SD Hostͨ��ͨ��ʵ��Storport miniport�ӿ����ṩ�洢���ܡ������ǹؼ�ʵ�֣�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. ��ʼ��Storport miniport</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    HW_INITIALIZATION_DATA hwInitData = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    hwInitData.HwInitializationDataSize = <span class="keyword">sizeof</span>(HW_INITIALIZATION_DATA);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ñ���Ļص�</span></span><br><span class="line">    hwInitData.HwInitialize = RtsPciHwInitialize;</span><br><span class="line">    hwInitData.HwStartIo = RtsPciHwStartIo;</span><br><span class="line">    hwInitData.HwFindAdapter = RtsPciHwFindAdapter;</span><br><span class="line">    hwInitData.HwResetBus = RtsPciHwResetBus;</span><br><span class="line">    hwInitData.HwInterrupt = RtsPciHwInterrupt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����miniport����</span></span><br><span class="line">    hwInitData.AutoRequestSense = TRUE;</span><br><span class="line">    hwInitData.TaggedQueuing = TRUE;</span><br><span class="line">    hwInitData.MultipleRequestPerLu = TRUE;</span><br><span class="line">    hwInitData.AdapterInterfaceType = PCIBus;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> StorPortInitialize(DriverObject,</span><br><span class="line">                            RegistryPath,</span><br><span class="line">                            &amp;hwInitData,</span><br><span class="line">                            <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. �豸��չ�ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">HW_DEVICE_EXTENSION</span> &#123;</span></span><br><span class="line">    <span class="comment">// StorportҪ��</span></span><br><span class="line">    STORPORT_DEVICE_EXTENSION StorPortExt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸��Դ</span></span><br><span class="line">    PVOID RegisterBase;</span><br><span class="line">    ULONG RegisterLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SD��״̬</span></span><br><span class="line">    BOOLEAN CardPresent;</span><br><span class="line">    ULONG CardCapacity;</span><br><span class="line">    BOOLEAN HighCapacity;</span><br><span class="line">    ULONG BlockSize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����״̬</span></span><br><span class="line">    STOR_SCATTER_GATHER_LIST SGList;</span><br><span class="line">    ULONG CurrentLBA;</span><br><span class="line">    ULONG BlockCount;</span><br><span class="line">    BOOLEAN TransferActive;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �������</span></span><br><span class="line">    LIST_ENTRY CmdQueue;</span><br><span class="line">    KSPIN_LOCK QueueLock;</span><br><span class="line">    </span><br><span class="line">&#125; HW_DEVICE_EXTENSION, *PHW_DEVICE_EXTENSION;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. ����IO����</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciHwStartIo</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ PSCSI_REQUEST_BLOCK Srb</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PHW_DEVICE_EXTENSION hwDevExt = (PHW_DEVICE_EXTENSION)DeviceExtension;</span><br><span class="line">    PCDB cdb = (PCDB)Srb-&gt;Cdb;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (cdb-&gt;CDB6GENERIC.OperationCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> SCSIOP_READ:</span><br><span class="line">            status = RtsPciHandleRead(hwDevExt, Srb);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SCSIOP_WRITE:</span><br><span class="line">            status = RtsPciHandleWrite(hwDevExt, Srb);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SCSIOP_INQUIRY:</span><br><span class="line">            status = RtsPciHandleInquiry(hwDevExt, Srb);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SCSIOP_READ_CAPACITY:</span><br><span class="line">            status = RtsPciHandleReadCapacity(hwDevExt, Srb);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            Srb-&gt;SrbStatus = SRB_STATUS_INVALID_REQUEST;</span><br><span class="line">            StorPortNotification(RequestComplete,</span><br><span class="line">                               DeviceExtension,</span><br><span class="line">                               Srb);</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (status == STATUS_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. ����������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleRead</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PHW_DEVICE_EXTENSION HwDevExt,</span></span><br><span class="line"><span class="params">    _In_ PSCSI_REQUEST_BLOCK Srb</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PCDB cdb = (PCDB)Srb-&gt;Cdb;</span><br><span class="line">    ULONG lba, blocks;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡLBA�Ϳ���</span></span><br><span class="line">    lba = ((ULONG)cdb-&gt;CDB10.LogicalBlockByte3 &lt;&lt; <span class="number">24</span>) |</span><br><span class="line">          ((ULONG)cdb-&gt;CDB10.LogicalBlockByte2 &lt;&lt; <span class="number">16</span>) |</span><br><span class="line">          ((ULONG)cdb-&gt;CDB10.LogicalBlockByte1 &lt;&lt; <span class="number">8</span>) |</span><br><span class="line">          (ULONG)cdb-&gt;CDB10.LogicalBlockByte0;</span><br><span class="line">          </span><br><span class="line">    blocks = ((ULONG)cdb-&gt;CDB10.TransferBlocksMsb &lt;&lt; <span class="number">8</span>) |</span><br><span class="line">             (ULONG)cdb-&gt;CDB10.TransferBlocksLsb;</span><br><span class="line">             </span><br><span class="line">    <span class="comment">// ���ô������</span></span><br><span class="line">    HwDevExt-&gt;CurrentLBA = lba;</span><br><span class="line">    HwDevExt-&gt;BlockCount = blocks;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡSG�б�</span></span><br><span class="line">    StorPortGetScatterGatherList(HwDevExt, Srb);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">    <span class="keyword">return</span> RtsPciStartTransfer(HwDevExt, FALSE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. ʵ�����ݴ���</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciStartTransfer</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PHW_DEVICE_EXTENSION HwDevExt,</span></span><br><span class="line"><span class="params">    _In_ BOOLEAN IsWrite</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ����SD����</span></span><br><span class="line">    ULONG cmdReg = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (IsWrite) &#123;</span><br><span class="line">        cmdReg = (<span class="number">24</span> &lt;&lt; CMD_INDEX_SHIFT) | <span class="comment">// WRITE_MULTIPLE_BLOCK</span></span><br><span class="line">                (RESP_R1 &lt;&lt; RESP_TYPE_SHIFT) |</span><br><span class="line">                CMD_DATA_PRESENT | CMD_WRITE;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cmdReg = (<span class="number">18</span> &lt;&lt; CMD_INDEX_SHIFT) | <span class="comment">// READ_MULTIPLE_BLOCK</span></span><br><span class="line">                (RESP_R1 &lt;&lt; RESP_TYPE_SHIFT) |</span><br><span class="line">                CMD_DATA_PRESENT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">    RtsPciSetupDMA(HwDevExt);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ÿ��С������</span></span><br><span class="line">    WRITE_REGISTER_ULONG(HwDevExt-&gt;RegisterBase + BLOCK_SIZE_REG,</span><br><span class="line">                        HwDevExt-&gt;BlockSize);</span><br><span class="line">    WRITE_REGISTER_ULONG(HwDevExt-&gt;RegisterBase + BLOCK_COUNT_REG,</span><br><span class="line">                        HwDevExt-&gt;BlockCount);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ò���������</span></span><br><span class="line">    WRITE_REGISTER_ULONG(HwDevExt-&gt;RegisterBase + ARG_REG,</span><br><span class="line">                        HwDevExt-&gt;CurrentLBA);</span><br><span class="line">    WRITE_REGISTER_ULONG(HwDevExt-&gt;RegisterBase + CMD_REG,</span><br><span class="line">                        cmdReg);</span><br><span class="line">                        </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. �жϴ���</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciHwInterrupt</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PHW_DEVICE_EXTENSION hwDevExt = (PHW_DEVICE_EXTENSION)DeviceExtension;</span><br><span class="line">    ULONG intStatus;</span><br><span class="line">    PSCSI_REQUEST_BLOCK srb;</span><br><span class="line">    </span><br><span class="line">    intStatus = READ_REGISTER_ULONG(hwDevExt-&gt;RegisterBase + INT_STATUS);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; XFER_COMPLETE) &#123;</span><br><span class="line">        <span class="comment">// ��ɵ�ǰSRB</span></span><br><span class="line">        srb = StorPortGetCurrentSrb(DeviceExtension);</span><br><span class="line">        <span class="keyword">if</span> (srb) &#123;</span><br><span class="line">            srb-&gt;SrbStatus = SRB_STATUS_SUCCESS;</span><br><span class="line">            StorPortNotification(RequestComplete,</span><br><span class="line">                               DeviceExtension,</span><br><span class="line">                               srb);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; ERROR_INT) &#123;</span><br><span class="line">        <span class="comment">// ��������</span></span><br><span class="line">        srb = StorPortGetCurrentSrb(DeviceExtension);</span><br><span class="line">        <span class="keyword">if</span> (srb) &#123;</span><br><span class="line">            srb-&gt;SrbStatus = SRB_STATUS_ERROR;</span><br><span class="line">            StorPortNotification(RequestComplete,</span><br><span class="line">                               DeviceExtension,</span><br><span class="line">                               srb);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ��㣺</p>
<ol>
<li>�����ܹ���</li>
</ol>
<ul>
<li>ʹ��Storport miniport</li>
<li>ʵ�ֱ���Ļص�</li>
<li>����SCSI����</li>
</ul>
<ol start="2">
<li>���ݴ��䣺</li>
</ol>
<ul>
<li>Scatter&#x2F;Gather֧��</li>
<li>DMA����</li>
<li>�������</li>
</ul>
<ol start="3">
<li>�����Ż���</li>
</ol>
<ul>
<li>�����Ŷ�</li>
<li>�жϺϲ�</li>
<li>DMA����</li>
</ul>
<ol start="4">
<li>��������</li>
</ol>
<ul>
<li>��ʱ����</li>
<li>����ָ�</li>
<li>״̬ͬ��</li>
</ul>
<ol start="5">
<li>��Դ������</li>
</ol>
<ul>
<li>�ڴ����</li>
<li>DMA��Դ</li>
<li>Ӳ������</li>
</ul>
<p>����ʵ�ֿ�����SD����Windows����Ϊ��׼�洢�豸ʹ�á�</p>
<h2 id="User-25"><a href="#User-25" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>Storport��Win11 24H����Щ���⣬�����WDF���ʵ�ִ洢�ӿ�</p>
<h2 id="AI-claude-3-5-sonnet-25"><a href="#AI-claude-3-5-sonnet-25" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��Win11�ϣ�����ʹ��WDF + Storage Class Extension��ʵ�ִ洢�ӿڡ������ǹؼ�ʵ�֣�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. �豸������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_CONTEXT</span> &#123;</span></span><br><span class="line">    WDFDEVICE       Device;</span><br><span class="line">    WDFINTERRUPT    Interrupt;</span><br><span class="line">    WDFDMAENABLER   DmaEnabler;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Storage Class Extension���</span></span><br><span class="line">    STORAGE_DEVICE_HANDLE StorHandle;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    BOOLEAN         MediaPresent;</span><br><span class="line">    ULONGLONG      DiskSize;</span><br><span class="line">    ULONG          BlockSize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Ĵ�������Դ</span></span><br><span class="line">    PVOID          RegisterBase;</span><br><span class="line">    </span><br><span class="line">&#125; DEVICE_CONTEXT, *PDEVICE_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ������ʼ��</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT  DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;config, RtsPciEvtDeviceAdd);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ��Storage Class Extension</span></span><br><span class="line">    STORAGE_DRIVER_CONFIG storageConfig = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    storageConfig.Size = <span class="keyword">sizeof</span>(STORAGE_DRIVER_CONFIG);</span><br><span class="line">    storageConfig.Version = STORAGE_DRIVER_CONFIG_VERSION;</span><br><span class="line">    </span><br><span class="line">    status = StorageClassInitialize(DriverObject, </span><br><span class="line">                                  RegistryPath,</span><br><span class="line">                                  &amp;storageConfig);</span><br><span class="line">                                  </span><br><span class="line">    <span class="keyword">return</span> WdfDriverCreate(DriverObject,</span><br><span class="line">                          RegistryPath,</span><br><span class="line">                          WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                          &amp;config,</span><br><span class="line">                          WDF_NO_HANDLE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. �豸����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceAdd</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_    WDFDRIVER       Driver,</span></span><br><span class="line"><span class="params">    _Inout_ PWDFDEVICE_INIT DeviceInit</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    STORAGE_DEVICE_CONFIG storageConfig = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ô洢�豸</span></span><br><span class="line">    storageConfig.Size = <span class="keyword">sizeof</span>(STORAGE_DEVICE_CONFIG);</span><br><span class="line">    storageConfig.Version = STORAGE_DEVICE_CONFIG_VERSION;</span><br><span class="line">    storageConfig.DeviceType = FILE_DEVICE_DISK;</span><br><span class="line">    storageConfig.Removable = TRUE;</span><br><span class="line">    </span><br><span class="line">    status = StorageDeviceInitConfig(DeviceInit, &amp;storageConfig);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����豸</span></span><br><span class="line">    WDF_OBJECT_ATTRIBUTES attributes;</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES_INIT_CONTEXT_TYPE(&amp;attributes, </span><br><span class="line">                                          DEVICE_CONTEXT);</span><br><span class="line">                                          </span><br><span class="line">    WDFDEVICE device;</span><br><span class="line">    status = WdfDeviceCreate(&amp;DeviceInit, </span><br><span class="line">                            &amp;attributes,</span><br><span class="line">                            &amp;device);</span><br><span class="line">                            </span><br><span class="line">    <span class="comment">// ��ʼ��Storage Class Extension�豸</span></span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(device);</span><br><span class="line">    </span><br><span class="line">    STORAGE_DEVICE_DESCRIPTOR_DATA descData = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    descData.Size = <span class="keyword">sizeof</span>(STORAGE_DEVICE_DESCRIPTOR_DATA);</span><br><span class="line">    descData.Version = STORAGE_DEVICE_DESCRIPTOR_VERSION;</span><br><span class="line">    descData.BlockSize = <span class="number">512</span>;</span><br><span class="line">    descData.MaxTransferLength = <span class="number">128</span> * <span class="number">1024</span>;  <span class="comment">// 128KB</span></span><br><span class="line">    </span><br><span class="line">    status = StorageDeviceInitialize(device,</span><br><span class="line">                                   &amp;descData,</span><br><span class="line">                                   &amp;devContext-&gt;StorHandle);</span><br><span class="line">                                   </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. ʵ�ִ洢�ӿڻص�</span></span><br><span class="line">EVT_STORAGE_READ_WRITE RtsPciEvtStorageRead;</span><br><span class="line">EVT_STORAGE_READ_WRITE RtsPciEvtStorageWrite;</span><br><span class="line">EVT_STORAGE_DEVICE_CONTROL RtsPciEvtStorageDeviceControl;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">RtsPciEvtStorageRead</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ STORAGE_REQUEST_DATA* Data</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡ�������</span></span><br><span class="line">    ULONGLONG startingOffset = Data-&gt;Offset;</span><br><span class="line">    SIZE_T length = Data-&gt;Length;</span><br><span class="line">    ULONG blockCount = (ULONG)(length / devContext-&gt;BlockSize);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">    status = RtsPciSetupDmaForRequest(devContext, Request);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        WdfRequestComplete(Request, status);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����SD������</span></span><br><span class="line">    status = RtsPciSendReadCommand(devContext, </span><br><span class="line">                                 startingOffset / devContext-&gt;BlockSize,</span><br><span class="line">                                 blockCount);</span><br><span class="line">                                 </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        WdfRequestComplete(Request, status);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ������жϴ�����</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. �жϴ���</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciEvtInterruptIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ ULONG MessageID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(</span><br><span class="line">        WdfInterruptGetDevice(Interrupt));</span><br><span class="line">        </span><br><span class="line">    ULONG intStatus = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + INT_STATUS_OFFSET);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; XFER_COMPLETE) &#123;</span><br><span class="line">        <span class="comment">// ��ɵ�ǰ����</span></span><br><span class="line">        <span class="keyword">if</span> (devContext-&gt;CurrentRequest) &#123;</span><br><span class="line">            WdfRequestComplete(devContext-&gt;CurrentRequest, </span><br><span class="line">                             STATUS_SUCCESS);</span><br><span class="line">            devContext-&gt;CurrentRequest = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. ý����</span></span><br><span class="line">VOID <span class="title function_">RtsPciEvtStorageQueryDeviceInformation</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ STORAGE_PROPERTY_ID PropertyId</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (PropertyId) &#123;</span><br><span class="line">        <span class="keyword">case</span> StorageDeviceProperty: &#123;</span><br><span class="line">            PSTORAGE_DEVICE_DESCRIPTOR desc = </span><br><span class="line">                WdfRequestWdmGetIrp(Request)-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">                </span><br><span class="line">            <span class="comment">// ����豸������</span></span><br><span class="line">            desc-&gt;DeviceType = FILE_DEVICE_DISK;</span><br><span class="line">            desc-&gt;RemovableMedia = TRUE;</span><br><span class="line">            desc-&gt;BusType = BusTypeSD;</span><br><span class="line">            </span><br><span class="line">            WdfRequestComplete(Request, STATUS_SUCCESS);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> StorageMediaTypeProperty: &#123;</span><br><span class="line">            PSTORAGE_MEDIA_TYPE mediaType =</span><br><span class="line">                WdfRequestWdmGetIrp(Request)-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">                </span><br><span class="line">            *mediaType = RemovableMedia;</span><br><span class="line">            </span><br><span class="line">            WdfRequestComplete(Request, STATUS_SUCCESS);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. ��Դ����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceD0Entry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDF_POWER_DEVICE_STATE PreviousState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ϵ�����</span></span><br><span class="line">    status = RtsPciPowerUpSequence(devContext);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��鿨״̬</span></span><br><span class="line">    <span class="keyword">if</span> (RtsPciIsCardPresent(devContext)) &#123;</span><br><span class="line">        status = RtsPciInitializeCard(devContext);</span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            StorageDeviceNotifyMediaStatus(devContext-&gt;StorHandle,</span><br><span class="line">                                         TRUE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>�ؼ��㣺</p>
<ol>
<li>�ܹ�ѡ��</li>
</ol>
<ul>
<li>ʹ��WDF���</li>
<li>����Storage Class Extension</li>
<li>ʵ�ֱ�Ҫ�Ļص�</li>
</ul>
<ol start="2">
<li>�洢�ӿڣ�</li>
</ol>
<ul>
<li>���豸����</li>
<li>ý�����</li>
<li>���Բ�ѯ</li>
</ul>
<ol start="3">
<li>�����Ż���</li>
</ol>
<ul>
<li>DMA����</li>
<li>�������</li>
<li>�жϴ���</li>
</ul>
<ol start="4">
<li>�ɿ��ԣ�</li>
</ol>
<ul>
<li>����ָ�</li>
<li>״̬ͬ��</li>
<li>��ʱ����</li>
</ul>
<ol start="5">
<li>��Դ������</li>
</ol>
<ul>
<li>D0&#x2F;D3״̬</li>
<li>����Դ����</li>
<li>״̬�ָ�</li>
</ul>
<p>����ʵ�ַ�ʽ��Win11�ϸ����ȶ��͸�Ч��</p>
<h2 id="User-26"><a href="#User-26" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>STORAGE_DRIVER_CONFIG�����ﶨ���</p>
<h2 id="AI-claude-3-5-sonnet-26"><a href="#AI-claude-3-5-sonnet-26" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��Ǹ���ҵ�ʾ��������Windows���������У����ڴ洢�豸��Ӧ��ʹ��StoragePortClassInitialize��������������Ĵ��룺</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// storuuid.h �� storport.h �ж����˴洢��ӿ�</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;storuuid.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;storport.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. �������</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT  DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;config, RtsPciEvtDeviceAdd);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ��StorPort</span></span><br><span class="line">    status = StorPortInitialize(DriverObject,</span><br><span class="line">                              RegistryPath,</span><br><span class="line">                              &amp;hwInitData,</span><br><span class="line">                              <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> WdfDriverCreate(DriverObject,</span><br><span class="line">                          RegistryPath,</span><br><span class="line">                          WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                          &amp;config,</span><br><span class="line">                          WDF_NO_HANDLE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. �豸������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_CONTEXT</span> &#123;</span></span><br><span class="line">    WDFDEVICE       Device;</span><br><span class="line">    WDFINTERRUPT    Interrupt;</span><br><span class="line">    WDFDMAENABLER   DmaEnabler;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �豸״̬</span></span><br><span class="line">    BOOLEAN         MediaPresent;</span><br><span class="line">    ULONGLONG       DiskSize;</span><br><span class="line">    ULONG           BlockSize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Ĵ�������Դ</span></span><br><span class="line">    PVOID           RegisterBase;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// StorPort���</span></span><br><span class="line">    STOR_SCSI_IDENTITY ScsiId;</span><br><span class="line">    STOR_PORT_HANDLE   PortHandle;</span><br><span class="line">    </span><br><span class="line">&#125; DEVICE_CONTEXT, *PDEVICE_CONTEXT;</span><br></pre></td></tr></table></figure>

<p>����Win11�ϵĴ洢�豸��������������ʹ�����·���֮һ��</p>
<ol>
<li>WDF + StorPort:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ʹ��StorPort�ӿ�</span></span><br><span class="line">NTSTATUS <span class="title function_">InitializeStorPort</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    STOR_INTERFACE storInterface;</span><br><span class="line">    </span><br><span class="line">    storInterface.Size = <span class="keyword">sizeof</span>(STOR_INTERFACE);</span><br><span class="line">    storInterface.Version = STOR_INTERFACE_VERSION;</span><br><span class="line">    storInterface.Context = DevContext;</span><br><span class="line">    storInterface.InterfaceReference = WdfDeviceInterfaceReferenceNoOp;</span><br><span class="line">    storInterface.InterfaceDereference = WdfDeviceInterfaceDereferenceNoOp;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> StorPortRegisterInterface(DevContext-&gt;Device,</span><br><span class="line">                                   &amp;storInterface);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>WDF + Block Request Interface:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ʹ�ÿ�����ӿ�</span></span><br><span class="line">NTSTATUS <span class="title function_">InitializeBlockInterface</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_IO_QUEUE_CONFIG queueConfig;</span><br><span class="line">    </span><br><span class="line">    WDF_IO_QUEUE_CONFIG_INIT_DEFAULT_QUEUE(</span><br><span class="line">        &amp;queueConfig,</span><br><span class="line">        WdfIoQueueDispatchSequential);</span><br><span class="line">        </span><br><span class="line">    queueConfig.EvtIoRead = RtsPciEvtIoRead;</span><br><span class="line">    queueConfig.EvtIoWrite = RtsPciEvtIoWrite;</span><br><span class="line">    queueConfig.EvtIoDeviceControl = RtsPciEvtIoDeviceControl;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> WdfIoQueueCreate(DevContext-&gt;Device,</span><br><span class="line">                           &amp;queueConfig,</span><br><span class="line">                           WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                           &amp;DevContext-&gt;IoQueue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>�Զ���洢�ӿڣ�</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ʵ���Զ���洢�ӿ�</span></span><br><span class="line">NTSTATUS <span class="title function_">InitializeCustomStorage</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// �����豸�ӿ�</span></span><br><span class="line">    status = WdfDeviceCreateDeviceInterface(</span><br><span class="line">        DevContext-&gt;Device,</span><br><span class="line">        &amp;GUID_DEVINTERFACE_DISK,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// �����豸����</span></span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES pnpCaps;</span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES_INIT(&amp;pnpCaps);</span><br><span class="line">    pnpCaps.Removable = WdfTrue;</span><br><span class="line">    WdfDeviceSetPnpCapabilities(DevContext-&gt;Device, &amp;pnpCaps);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ѡ�����ַ���ȡ���ھ�������</p>
<ol>
<li>�����Ҫ��ȫ���ƺ��Զ��� - ʹ���Զ���ӿ�</li>
<li>�����Ҫ��׼�洢���� - ʹ��StorPort</li>
<li>�����Ҫ�򵥵Ŀ��豸���� - ʹ��Block Request Interface</li>
</ol>
<h2 id="User-27"><a href="#User-27" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>StorPortInitialize��WdfDriverCreate�ܼ����𣿣�</p>
<h2 id="AI-claude-3-5-sonnet-27"><a href="#AI-claude-3-5-sonnet-27" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��˵�öԣ�StorPortInitialize �� WdfDriverCreate ȷʵ����ͬʱʹ�ã���Ϊ������������ͬ������ģ�͡���֮ǰ�Ľ�������</p>
<p>����SD Host Controller������Ӧ�ö�ѡһ��</p>
<ol>
<li>��WDF������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT  DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;config, RtsPciEvtDeviceAdd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> WdfDriverCreate(DriverObject,</span><br><span class="line">                          RegistryPath,</span><br><span class="line">                          WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                          &amp;config,</span><br><span class="line">                          WDF_NO_HANDLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>��Storport������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT  DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    HW_INITIALIZATION_DATA hwInitData = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    hwInitData.HwInitializationDataSize = <span class="keyword">sizeof</span>(HW_INITIALIZATION_DATA);</span><br><span class="line">    hwInitData.HwInitialize = RtsPciHwInitialize;</span><br><span class="line">    hwInitData.HwStartIo = RtsPciHwStartIo;</span><br><span class="line">    hwInitData.HwFindAdapter = RtsPciHwFindAdapter;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> StorPortInitialize(DriverObject,</span><br><span class="line">                            RegistryPath,</span><br><span class="line">                            &amp;hwInitData,</span><br><span class="line">                            <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>���Ҫ��Win11��ʵ��SD Host Controller������ʹ��WDF + �Զ���洢�ӿڵķ�����</p>
<h2 id="User-28"><a href="#User-28" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>ʹ��WDF + �Զ���洢�ӿڵķ��������ʵ�ִ洢�ӿ�</p>
<h2 id="AI-claude-3-5-sonnet-28"><a href="#AI-claude-3-5-sonnet-28" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>ʹ��WDFʵ�ִ洢�ӿڵĹؼ����룺</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. �豸�ӿ�GUID</span></span><br><span class="line">DEFINE_GUID(GUID_CUSTOM_STORAGE_INTERFACE,</span><br><span class="line">    <span class="number">0x12345678</span>, <span class="number">0x1234</span>, <span class="number">0x1234</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x56</span>, <span class="number">0x78</span>, <span class="number">0x90</span>, <span class="number">0x12</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. �豸������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_CONTEXT</span> &#123;</span></span><br><span class="line">    WDFDEVICE       Device;</span><br><span class="line">    WDFQUEUE        IoQueue;</span><br><span class="line">    WDFINTERRUPT    Interrupt;</span><br><span class="line">    WDFDMAENABLER   DmaEnabler;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �洢����</span></span><br><span class="line">    DISK_GEOMETRY   DiskGeometry;</span><br><span class="line">    BOOLEAN         MediaPresent;</span><br><span class="line">    ULONG           BlockSize;</span><br><span class="line">    LARGE_INTEGER   DiskSize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ǰ����</span></span><br><span class="line">    WDFREQUEST      CurrentRequest;</span><br><span class="line">    ULONG           CurrentLba;</span><br><span class="line">    ULONG           CurrentLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Ĵ���</span></span><br><span class="line">    PVOID           RegisterBase;</span><br><span class="line">    </span><br><span class="line">&#125; DEVICE_CONTEXT, *PDEVICE_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. �豸����ʱע��ӿ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceAdd</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDRIVER Driver,</span></span><br><span class="line"><span class="params">    _Inout_ PWDFDEVICE_INIT DeviceInit</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES attributes;</span><br><span class="line">    WDFDEVICE device;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����豸</span></span><br><span class="line">    WDF_OBJECT_ATTRIBUTES_INIT_CONTEXT_TYPE(&amp;attributes, DEVICE_CONTEXT);</span><br><span class="line">    status = WdfDeviceCreate(&amp;DeviceInit, &amp;attributes, &amp;device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����豸�ӿ�</span></span><br><span class="line">    status = WdfDeviceCreateDeviceInterface(</span><br><span class="line">        device,</span><br><span class="line">        &amp;GUID_DEVINTERFACE_DISK,  <span class="comment">// ʹ�ñ�׼���̽ӿ�GUID</span></span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ����IO����</span></span><br><span class="line">    WDF_IO_QUEUE_CONFIG queueConfig;</span><br><span class="line">    WDF_IO_QUEUE_CONFIG_INIT_DEFAULT_QUEUE(</span><br><span class="line">        &amp;queueConfig,</span><br><span class="line">        WdfIoQueueDispatchSequential);</span><br><span class="line">        </span><br><span class="line">    queueConfig.EvtIoRead = RtsPciEvtIoRead;</span><br><span class="line">    queueConfig.EvtIoWrite = RtsPciEvtIoWrite;</span><br><span class="line">    queueConfig.EvtIoDeviceControl = RtsPciEvtIoDeviceControl;</span><br><span class="line">    </span><br><span class="line">    status = WdfIoQueueCreate(device,</span><br><span class="line">                             &amp;queueConfig,</span><br><span class="line">                             WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                             &amp;devContext-&gt;IoQueue);</span><br><span class="line">                             </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. ����IO��������</span></span><br><span class="line">VOID <span class="title function_">RtsPciEvtIoDeviceControl</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFQUEUE Queue,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> OutputBufferLength,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> InputBufferLength,</span></span><br><span class="line"><span class="params">    _In_ ULONG IoControlCode</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(WdfIoQueueGetDevice(Queue));</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (IoControlCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_GET_DRIVE_GEOMETRY: &#123;</span><br><span class="line">            PDISK_GEOMETRY geometry;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (OutputBufferLength &lt; <span class="keyword">sizeof</span>(DISK_GEOMETRY)) &#123;</span><br><span class="line">                status = STATUS_BUFFER_TOO_SMALL;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            status = WdfRequestRetrieveOutputBuffer(Request,</span><br><span class="line">                                                  <span class="keyword">sizeof</span>(DISK_GEOMETRY),</span><br><span class="line">                                                  &amp;geometry,</span><br><span class="line">                                                  <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            geometry-&gt;MediaType = RemovableMedia;</span><br><span class="line">            geometry-&gt;TracksPerCylinder = <span class="number">1</span>;</span><br><span class="line">            geometry-&gt;SectorsPerTrack = <span class="number">1</span>;</span><br><span class="line">            geometry-&gt;BytesPerSector = devContext-&gt;BlockSize;</span><br><span class="line">            geometry-&gt;Cylinders.QuadPart = devContext-&gt;DiskSize.QuadPart / </span><br><span class="line">                                         devContext-&gt;BlockSize;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_GET_LENGTH_INFO: &#123;</span><br><span class="line">            PGET_LENGTH_INFORMATION lengthInfo;</span><br><span class="line">            </span><br><span class="line">            status = WdfRequestRetrieveOutputBuffer(Request,</span><br><span class="line">                                                  <span class="keyword">sizeof</span>(GET_LENGTH_INFORMATION),</span><br><span class="line">                                                  &amp;lengthInfo,</span><br><span class="line">                                                  <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            lengthInfo-&gt;Length = devContext-&gt;DiskSize;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_IS_WRITABLE:</span><br><span class="line">            status = STATUS_SUCCESS;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_MEDIA_REMOVAL:</span><br><span class="line">        <span class="keyword">case</span> IOCTL_STORAGE_MEDIA_REMOVAL:</span><br><span class="line">            status = STATUS_SUCCESS;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> IOCTL_STORAGE_GET_DEVICE_NUMBER: &#123;</span><br><span class="line">            PSTORAGE_DEVICE_NUMBER number;</span><br><span class="line">            </span><br><span class="line">            status = WdfRequestRetrieveOutputBuffer(Request,</span><br><span class="line">                                                  <span class="keyword">sizeof</span>(STORAGE_DEVICE_NUMBER),</span><br><span class="line">                                                  &amp;number,</span><br><span class="line">                                                  <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            number-&gt;DeviceType = FILE_DEVICE_DISK;</span><br><span class="line">            number-&gt;DeviceNumber = <span class="number">0</span>;</span><br><span class="line">            number-&gt;PartitionNumber = (ULONG)<span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            status = STATUS_INVALID_DEVICE_REQUEST;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    WdfRequestComplete(Request, status);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. ����������</span></span><br><span class="line">VOID <span class="title function_">RtsPciEvtIoRead</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFQUEUE Queue,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> Length</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(WdfIoQueueGetDevice(Queue));</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_REQUEST_PARAMETERS params;</span><br><span class="line">    LARGE_INTEGER offset;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡ�������</span></span><br><span class="line">    WDF_REQUEST_PARAMETERS_INIT(&amp;params);</span><br><span class="line">    WdfRequestGetParameters(Request, &amp;params);</span><br><span class="line">    offset.QuadPart = params.Parameters.Read.DeviceOffset;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������</span></span><br><span class="line">    <span class="keyword">if</span> ((offset.QuadPart % devContext-&gt;BlockSize) != <span class="number">0</span> ||</span><br><span class="line">        (Length % devContext-&gt;BlockSize) != <span class="number">0</span>) &#123;</span><br><span class="line">        WdfRequestComplete(Request, STATUS_INVALID_PARAMETER);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">    status = RtsPciSetupDmaForRequest(devContext, Request);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        WdfRequestComplete(Request, status);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����������Ϣ</span></span><br><span class="line">    devContext-&gt;CurrentRequest = Request;</span><br><span class="line">    devContext-&gt;CurrentLba = (ULONG)(offset.QuadPart / devContext-&gt;BlockSize);</span><br><span class="line">    devContext-&gt;CurrentLength = (ULONG)Length;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����SD������</span></span><br><span class="line">    status = RtsPciSendReadCommand(devContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        WdfRequestComplete(Request, status);</span><br><span class="line">        devContext-&gt;CurrentRequest = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. �ж���ɴ���</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciEvtInterruptIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ ULONG MessageID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(</span><br><span class="line">        WdfInterruptGetDevice(Interrupt));</span><br><span class="line">    ULONG intStatus;</span><br><span class="line">    </span><br><span class="line">    intStatus = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + INT_STATUS_OFFSET);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; XFER_COMPLETE) &#123;</span><br><span class="line">        <span class="keyword">if</span> (devContext-&gt;CurrentRequest) &#123;</span><br><span class="line">            WdfRequestComplete(devContext-&gt;CurrentRequest, STATUS_SUCCESS);</span><br><span class="line">            devContext-&gt;CurrentRequest = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ��㣺</p>
<ol>
<li>�ӿ�ע�᣺</li>
</ol>
<ul>
<li>ʹ�ñ�׼���̽ӿ�GUID</li>
<li>ʵ�ֱ�Ҫ��IOCTL</li>
<li>������д����</li>
</ul>
<ol start="2">
<li>��������</li>
</ol>
<ul>
<li>������֤</li>
<li>DMA����</li>
<li>�����</li>
</ul>
<ol start="3">
<li>�����Ż���</li>
</ol>
<ul>
<li>DMA����</li>
<li>�������</li>
<li>�жϴ���</li>
</ul>
<ol start="4">
<li>�ɿ��ԣ�</li>
</ol>
<ul>
<li>������</li>
<li>״̬ͬ��</li>
<li>��ʱ����</li>
</ul>
<ol start="5">
<li>����֧�֣�</li>
</ol>
<ul>
<li>����֧��</li>
<li>���ƶ�����</li>
<li>�豸����</li>
</ul>
<p>����ʵ�ַ�ʽ������SD����Windows����Ϊ��׼�����豸ʹ�á�</p>
<h2 id="User-29"><a href="#User-29" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>SD�����������̷������ͨ�����ϴ洢�ӿ��ϱ���OS�ģ�</p>
<h2 id="AI-claude-3-5-sonnet-29"><a href="#AI-claude-3-5-sonnet-29" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>SD�����������̷�ͨ�����¹ؼ��ӿ��ϱ���OS��</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. �����ϱ� - ͨ��IOCTL_DISK_GET_DRIVE_GEOMETRY</span></span><br><span class="line">VOID <span class="title function_">RtsPciEvtIoDeviceControl</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFQUEUE Queue,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> OutputBufferLength,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> InputBufferLength,</span></span><br><span class="line"><span class="params">    _In_ ULONG IoControlCode</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(WdfIoQueueGetDevice(Queue));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (IoControlCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_GET_DRIVE_GEOMETRY: &#123;</span><br><span class="line">            PDISK_GEOMETRY geometry;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ��ȡCSD��Ϣ�е�����</span></span><br><span class="line">            ULONGLONG totalSectors = devContext-&gt;DiskSize.QuadPart / <span class="number">512</span>;</span><br><span class="line">            </span><br><span class="line">            geometry-&gt;MediaType = RemovableMedia;</span><br><span class="line">            geometry-&gt;TracksPerCylinder = <span class="number">255</span>;  <span class="comment">// ��ͳCHS�ṹ</span></span><br><span class="line">            geometry-&gt;SectorsPerTrack = <span class="number">63</span>;</span><br><span class="line">            geometry-&gt;BytesPerSector = <span class="number">512</span>;     <span class="comment">// ��׼������С</span></span><br><span class="line">            geometry-&gt;Cylinders.QuadPart = totalSectors / </span><br><span class="line">                (geometry-&gt;TracksPerCylinder * geometry-&gt;SectorsPerTrack);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ��׼ȷ����������</span></span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_GET_LENGTH_INFO: &#123;</span><br><span class="line">            PGET_LENGTH_INFORMATION lengthInfo;</span><br><span class="line">            </span><br><span class="line">            lengthInfo-&gt;Length = devContext-&gt;DiskSize;  <span class="comment">// ʵ�����ֽ���</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ������Ϣ</span></span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_GET_PARTITION_INFO_EX: &#123;</span><br><span class="line">            PPARTITION_INFORMATION_EX partInfo;</span><br><span class="line">            </span><br><span class="line">            partInfo-&gt;PartitionStyle = PARTITION_STYLE_MBR;</span><br><span class="line">            partInfo-&gt;StartingOffset.QuadPart = <span class="number">0</span>;</span><br><span class="line">            partInfo-&gt;PartitionLength = devContext-&gt;DiskSize;</span><br><span class="line">            partInfo-&gt;PartitionNumber = <span class="number">0</span>;</span><br><span class="line">            partInfo-&gt;RewritePartition = TRUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. �豸�ӿ�ע�� - ϵͳ�ݴ˷����̷�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceAdd</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDRIVER Driver,</span></span><br><span class="line"><span class="params">    _Inout_ PWDFDEVICE_INIT DeviceInit</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ע��Ϊ�����豸</span></span><br><span class="line">    status = WdfDeviceCreateDeviceInterface(</span><br><span class="line">        device,</span><br><span class="line">        &amp;GUID_DEVINTERFACE_DISK,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// �����豸����</span></span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES pnpCaps;</span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES_INIT(&amp;pnpCaps);</span><br><span class="line">    pnpCaps.Removable = WdfTrue;          <span class="comment">// ���ƶ��豸</span></span><br><span class="line">    pnpCaps.EjectSupported = WdfTrue;     <span class="comment">// ֧�ֵ���</span></span><br><span class="line">    pnpCaps.SurpriseRemovalOK = WdfTrue;  <span class="comment">// ֧���Ȳ��</span></span><br><span class="line">    WdfDeviceSetPnpCapabilities(device, &amp;pnpCaps);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����豸����</span></span><br><span class="line">    STORAGE_DEVICE_DESCRIPTOR deviceDesc = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    deviceDesc.Version = <span class="keyword">sizeof</span>(STORAGE_DEVICE_DESCRIPTOR);</span><br><span class="line">    deviceDesc.Size = <span class="keyword">sizeof</span>(STORAGE_DEVICE_DESCRIPTOR);</span><br><span class="line">    deviceDesc.DeviceType = FILE_DEVICE_DISK;</span><br><span class="line">    deviceDesc.RemovableMedia = TRUE;</span><br><span class="line">    deviceDesc.BusType = BusTypeSD;</span><br><span class="line">    </span><br><span class="line">    status = WdfDeviceSetDeviceDescriptor(device, &amp;deviceDesc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. ��ʼ��ʱ��ȡSD������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeCardCapacity</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    SD_COMMAND cmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����CMD9��ȡCSD</span></span><br><span class="line">    cmd.CommandCode = <span class="number">9</span>;  <span class="comment">// SEND_CSD</span></span><br><span class="line">    cmd.Argument = DevContext-&gt;CardRCA &lt;&lt; <span class="number">16</span>;</span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_TYPE_R2;</span><br><span class="line">    </span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����CSD��ȡ����</span></span><br><span class="line">    <span class="keyword">if</span> (DevContext-&gt;HighCapacity) &#123;</span><br><span class="line">        <span class="comment">// SDHC/SDXC�� (CSD Version 2.0)</span></span><br><span class="line">        ULONG cSize = ((cmd.Response[<span class="number">1</span>] &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFFFF</span>) |</span><br><span class="line">                     ((cmd.Response[<span class="number">2</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">16</span>);</span><br><span class="line">        DevContext-&gt;DiskSize.QuadPart = ((ULONGLONG)(cSize + <span class="number">1</span>)) * <span class="number">512</span> * <span class="number">1024</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ��׼SD�� (CSD Version 1.0)</span></span><br><span class="line">        ULONG cSize = ((cmd.Response[<span class="number">1</span>] &gt;&gt; <span class="number">30</span>) &amp; <span class="number">0x3</span>) |</span><br><span class="line">                     ((cmd.Response[<span class="number">2</span>] &amp; <span class="number">0x3FF</span>) &lt;&lt; <span class="number">2</span>);</span><br><span class="line">        ULONG cSizeMult = (cmd.Response[<span class="number">1</span>] &gt;&gt; <span class="number">7</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">        ULONG readBlLen = cmd.Response[<span class="number">1</span>] &amp; <span class="number">0xF</span>;</span><br><span class="line">        </span><br><span class="line">        DevContext-&gt;DiskSize.QuadPart = (ULONGLONG)(cSize + <span class="number">1</span>) * </span><br><span class="line">            (<span class="number">1ULL</span> &lt;&lt; (cSizeMult + <span class="number">2</span>)) * </span><br><span class="line">            (<span class="number">1ULL</span> &lt;&lt; readBlLen);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ����̣�</p>
<ol>
<li>����ȷ����</li>
</ol>
<ul>
<li>��ʼ��ʱ��ȡCSD��ȡʵ������</li>
<li>֧��SDHC&#x2F;SDXC��������</li>
<li>�����ֽڶ���</li>
</ul>
<ol start="2">
<li>�豸ע�᣺</li>
</ol>
<ul>
<li>ע���׼���̽ӿ�</li>
<li>�����豸����</li>
<li>�ṩ�豸������</li>
</ul>
<ol start="3">
<li>�����ϱ���</li>
</ol>
<ul>
<li>DISK_GEOMETRY</li>
<li>LENGTH_INFORMATION</li>
<li>PARTITION_INFO</li>
</ul>
<ol start="4">
<li>�̷����䣺</li>
</ol>
<ul>
<li>��Windows�����豸�ӿ��Զ�����</li>
<li>���Ƿ�����</li>
<li>֧���Ȳ��</li>
</ul>
<p>ϵͳ�������̣�</p>
<ol>
<li>����ע����̽ӿ�</li>
<li>PnP��������⵽�豸</li>
<li>��������������</li>
<li>������������ȡ����</li>
<li>�ļ�ϵͳʶ��</li>
<li>�����̷�</li>
</ol>
<h2 id="User-30"><a href="#User-30" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�����������: �忨-&gt;�ж� -&gt;SD����Ϣ�ϱ���OS -&gt; OS</p>
<h2 id="AI-claude-3-5-sonnet-30"><a href="#AI-claude-3-5-sonnet-30" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>������SD�����뵽OSʶ�����̣�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. �жϴ��� - ��⿨����</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciEvtInterruptIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ ULONG MessageID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(</span><br><span class="line">        WdfInterruptGetDevice(Interrupt));</span><br><span class="line">    ULONG intStatus;</span><br><span class="line">    </span><br><span class="line">    intStatus = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + INT_STATUS_OFFSET);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; CARD_INSERT_INT) &#123;</span><br><span class="line">        <span class="comment">// ����ж�״̬</span></span><br><span class="line">        WRITE_REGISTER_ULONG(</span><br><span class="line">            devContext-&gt;RegisterBase + INT_STATUS_OFFSET,</span><br><span class="line">            CARD_INSERT_INT);</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// ����DPC�����忨</span></span><br><span class="line">        WdfInterruptQueueDpcForIsr(Interrupt);</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. DPC�����忨�¼�</span></span><br><span class="line">VOID <span class="title function_">RtsPciEvtInterruptDpc</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ WDFOBJECT Device</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(Device);</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ����</span></span><br><span class="line">    status = RtsPciInitializeCard(devContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ֪ͨPnP������</span></span><br><span class="line">    WdfDeviceSetDeviceState(Device, WdfDeviceStateStarted);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. ��ʼ��SD��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    SD_COMMAND cmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.1 ����CMD0 - GO_IDLE_STATE</span></span><br><span class="line">    cmd.CommandCode = <span class="number">0</span>;</span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_NONE;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.2 ����CMD8 - SEND_IF_COND</span></span><br><span class="line">    cmd.CommandCode = <span class="number">8</span>;</span><br><span class="line">    cmd.Argument = <span class="number">0x1AA</span>;  <span class="comment">// 3.3V�ͼ��ģʽ</span></span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_R7;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    </span><br><span class="line">    BOOLEAN sdVer2 = NT_SUCCESS(status);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.3 ����ACMD41 - SD_SEND_OP_COND</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// �ȷ���CMD55</span></span><br><span class="line">        cmd.CommandCode = <span class="number">55</span>;</span><br><span class="line">        cmd.Argument = <span class="number">0</span>;</span><br><span class="line">        cmd.ResponseType = SD_RESPONSE_R1;</span><br><span class="line">        status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����ACMD41</span></span><br><span class="line">        cmd.CommandCode = <span class="number">41</span>;</span><br><span class="line">        cmd.Argument = sdVer2 ? <span class="number">0x40FF8000</span> : <span class="number">0x00FF8000</span>;</span><br><span class="line">        cmd.ResponseType = SD_RESPONSE_R3;</span><br><span class="line">        status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (cmd.Response[<span class="number">0</span>] &amp; <span class="number">0x80000000</span>) &#123;</span><br><span class="line">            DevContext-&gt;HighCapacity = (cmd.Response[<span class="number">0</span>] &amp; <span class="number">0x40000000</span>) ? TRUE : FALSE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        KeStallExecutionProcessor(<span class="number">10000</span>);  <span class="comment">// 10ms�ӳ�</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.4 ����CMD2 - ALL_SEND_CID</span></span><br><span class="line">    cmd.CommandCode = <span class="number">2</span>;</span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_R2;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����CID��Ϣ</span></span><br><span class="line">    RtlCopyMemory(DevContext-&gt;CardCID, cmd.Response, <span class="number">16</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.5 ����CMD3 - SEND_RELATIVE_ADDR</span></span><br><span class="line">    cmd.CommandCode = <span class="number">3</span>;</span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_R6;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;CardRCA = cmd.Response[<span class="number">0</span>] &gt;&gt; <span class="number">16</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.6 ����CMD9 - SEND_CSD</span></span><br><span class="line">    cmd.CommandCode = <span class="number">9</span>;</span><br><span class="line">    cmd.Argument = DevContext-&gt;CardRCA &lt;&lt; <span class="number">16</span>;</span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_R2;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����CSD��ȡ����</span></span><br><span class="line">    <span class="keyword">if</span> (DevContext-&gt;HighCapacity) &#123;</span><br><span class="line">        ULONG cSize = ((cmd.Response[<span class="number">1</span>] &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFFFF</span>) |</span><br><span class="line">                     ((cmd.Response[<span class="number">2</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">16</span>);</span><br><span class="line">        DevContext-&gt;DiskSize.QuadPart = ((ULONGLONG)(cSize + <span class="number">1</span>)) * <span class="number">512</span> * <span class="number">1024</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ULONG cSize = ((cmd.Response[<span class="number">1</span>] &gt;&gt; <span class="number">30</span>) &amp; <span class="number">0x3</span>) |</span><br><span class="line">                     ((cmd.Response[<span class="number">2</span>] &amp; <span class="number">0x3FF</span>) &lt;&lt; <span class="number">2</span>);</span><br><span class="line">        ULONG cSizeMult = (cmd.Response[<span class="number">1</span>] &gt;&gt; <span class="number">7</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">        ULONG readBlLen = cmd.Response[<span class="number">1</span>] &amp; <span class="number">0xF</span>;</span><br><span class="line">        </span><br><span class="line">        DevContext-&gt;DiskSize.QuadPart = (ULONGLONG)(cSize + <span class="number">1</span>) * </span><br><span class="line">            (<span class="number">1ULL</span> &lt;&lt; (cSizeMult + <span class="number">2</span>)) * </span><br><span class="line">            (<span class="number">1ULL</span> &lt;&lt; readBlLen);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.7 ����CMD7 - SELECT_CARD</span></span><br><span class="line">    cmd.CommandCode = <span class="number">7</span>;</span><br><span class="line">    cmd.Argument = DevContext-&gt;CardRCA &lt;&lt; <span class="number">16</span>;</span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_R1b;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.8 �������߿���(ACMD6)</span></span><br><span class="line">    cmd.CommandCode = <span class="number">55</span>;</span><br><span class="line">    cmd.Argument = DevContext-&gt;CardRCA &lt;&lt; <span class="number">16</span>;</span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_R1;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">    cmd.CommandCode = <span class="number">6</span>;</span><br><span class="line">    cmd.Argument = <span class="number">2</span>;  <span class="comment">// 4-bitģʽ</span></span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_R1;</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. �豸��Ϣ�ϱ�</span></span><br><span class="line">VOID <span class="title function_">RtsPciEvtIoDeviceControl</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFQUEUE Queue,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> OutputBufferLength,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> InputBufferLength,</span></span><br><span class="line"><span class="params">    _In_ ULONG IoControlCode</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(WdfIoQueueGetDevice(Queue));</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (IoControlCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> IOCTL_STORAGE_QUERY_PROPERTY: &#123;</span><br><span class="line">            PSTORAGE_PROPERTY_QUERY query;</span><br><span class="line">            </span><br><span class="line">            status = WdfRequestRetrieveInputBuffer(Request,</span><br><span class="line">                <span class="keyword">sizeof</span>(STORAGE_PROPERTY_QUERY),</span><br><span class="line">                &amp;query,</span><br><span class="line">                <span class="literal">NULL</span>);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">switch</span> (query-&gt;PropertyId) &#123;</span><br><span class="line">                <span class="keyword">case</span> StorageDeviceProperty: &#123;</span><br><span class="line">                    PSTORAGE_DEVICE_DESCRIPTOR desc;</span><br><span class="line">                    </span><br><span class="line">                    status = WdfRequestRetrieveOutputBuffer(Request,</span><br><span class="line">                        <span class="keyword">sizeof</span>(STORAGE_DEVICE_DESCRIPTOR),</span><br><span class="line">                        &amp;desc,</span><br><span class="line">                        <span class="literal">NULL</span>);</span><br><span class="line">                        </span><br><span class="line">                    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                    desc-&gt;Version = <span class="keyword">sizeof</span>(STORAGE_DEVICE_DESCRIPTOR);</span><br><span class="line">                    desc-&gt;Size = <span class="keyword">sizeof</span>(STORAGE_DEVICE_DESCRIPTOR);</span><br><span class="line">                    desc-&gt;DeviceType = FILE_DEVICE_DISK;</span><br><span class="line">                    desc-&gt;DeviceTypeModifier = <span class="number">0</span>;</span><br><span class="line">                    desc-&gt;RemovableMedia = TRUE;</span><br><span class="line">                    desc-&gt;BusType = BusTypeSD;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// ��CID�л�ȡ������Ϣ</span></span><br><span class="line">                    RtlCopyMemory(desc-&gt;VendorId, </span><br><span class="line">                                &amp;devContext-&gt;CardCID[<span class="number">0</span>],</span><br><span class="line">                                <span class="number">8</span>);</span><br><span class="line">                    RtlCopyMemory(desc-&gt;ProductId,</span><br><span class="line">                                &amp;devContext-&gt;CardCID[<span class="number">8</span>],</span><br><span class="line">                                <span class="number">16</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">case</span> StorageAdapterProperty: &#123;</span><br><span class="line">                    PSTORAGE_ADAPTER_DESCRIPTOR desc;</span><br><span class="line">                    </span><br><span class="line">                    status = WdfRequestRetrieveOutputBuffer(Request,</span><br><span class="line">                        <span class="keyword">sizeof</span>(STORAGE_ADAPTER_DESCRIPTOR),</span><br><span class="line">                        &amp;desc,</span><br><span class="line">                        <span class="literal">NULL</span>);</span><br><span class="line">                        </span><br><span class="line">                    <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                    desc-&gt;MaximumTransferLength = PAGE_SIZE * <span class="number">32</span>;</span><br><span class="line">                    desc-&gt;MaximumPhysicalPages = <span class="number">32</span>;</span><br><span class="line">                    desc-&gt;AlignmentMask = <span class="number">0x3</span>;</span><br><span class="line">                    desc-&gt;BusType = BusTypeSD;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_GET_DRIVE_GEOMETRY: &#123;</span><br><span class="line">            PDISK_GEOMETRY geometry;</span><br><span class="line">            </span><br><span class="line">            status = WdfRequestRetrieveOutputBuffer(Request,</span><br><span class="line">                <span class="keyword">sizeof</span>(DISK_GEOMETRY),</span><br><span class="line">                &amp;geometry,</span><br><span class="line">                <span class="literal">NULL</span>);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (!NT_SUCCESS(status)) <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            geometry-&gt;MediaType = RemovableMedia;</span><br><span class="line">            geometry-&gt;TracksPerCylinder = <span class="number">255</span>;</span><br><span class="line">            geometry-&gt;SectorsPerTrack = <span class="number">63</span>;</span><br><span class="line">            geometry-&gt;BytesPerSector = <span class="number">512</span>;</span><br><span class="line">            geometry-&gt;Cylinders.QuadPart = devContext-&gt;DiskSize.QuadPart /</span><br><span class="line">                (geometry-&gt;TracksPerCylinder * </span><br><span class="line">                 geometry-&gt;SectorsPerTrack * </span><br><span class="line">                 geometry-&gt;BytesPerSector);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    WdfRequestComplete(Request, status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�������̣�</p>
<ol>
<li>Ӳ����⿨���룺</li>
</ol>
<ul>
<li>�жϴ���</li>
<li>����ж�״̬</li>
<li>����DPC����</li>
</ul>
<ol start="2">
<li>��ʼ��SD����</li>
</ol>
<ul>
<li>���ͳ�ʼ����������</li>
<li>��ȡ������(��ѹ��������)</li>
<li>���ù���ģʽ</li>
</ul>
<ol start="3">
<li>�豸��Ϣ�ϱ���</li>
</ol>
<ul>
<li>�豸������</li>
<li>����������</li>
<li>���̼�����Ϣ</li>
</ul>
<ol start="4">
<li>OS�������̣�</li>
</ol>
<ul>
<li>PnP������������豸</li>
<li>������Ӧ����</li>
<li>ʶ���ļ�ϵͳ</li>
<li>�����̷�</li>
</ul>
<ol start="5">
<li>�ؼ����ݣ�</li>
</ol>
<ul>
<li>������Ϣ</li>
<li>������Ϣ</li>
<li>�豸����</li>
<li>�������</li>
</ul>
<p>����OS��������ʶ��ʹ��SD���豸��</p>
<h2 id="User-31"><a href="#User-31" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�忨�ͳ�ʼ����ɺ�OS�ᷢ��RtsPciEvtIoDeviceControlȥ����SD����Ϣ��</p>
<h2 id="AI-claude-3-5-sonnet-31"><a href="#AI-claude-3-5-sonnet-31" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�ǵģ��忨��ʼ����ɺ�OS�ᷢ��һϵ��DeviceControl��������ȡ�豸��Ϣ�����͵������������£�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">RtsPciEvtIoDeviceControl</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFQUEUE Queue,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> OutputBufferLength,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> InputBufferLength,</span></span><br><span class="line"><span class="params">    _In_ ULONG IoControlCode</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = GetDeviceContext(WdfIoQueueGetDevice(Queue));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��¼OS�������е�Log</span></span><br><span class="line">    DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL,</span><br><span class="line">        <span class="string">&quot;RtsPciEvtIoDeviceControl: IoControlCode = 0x%x\n&quot;</span>, IoControlCode);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (IoControlCode) &#123;</span><br><span class="line">        <span class="comment">// 1. ���Ȳ�ѯ�豸������������</span></span><br><span class="line">        <span class="keyword">case</span> IOCTL_STORAGE_QUERY_PROPERTY: &#123;</span><br><span class="line">            PSTORAGE_PROPERTY_QUERY query = <span class="literal">NULL</span>;</span><br><span class="line">            status = WdfRequestRetrieveInputBuffer(Request,</span><br><span class="line">                <span class="keyword">sizeof</span>(STORAGE_PROPERTY_QUERY),</span><br><span class="line">                &amp;query,</span><br><span class="line">                <span class="literal">NULL</span>);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">switch</span> (query-&gt;PropertyId) &#123;</span><br><span class="line">                <span class="keyword">case</span> StorageDeviceProperty:</span><br><span class="line">                    <span class="comment">// OS��Ҫ֪������ʲô���͵��豸</span></span><br><span class="line">                    DbgPrint(<span class="string">&quot;OS Query: StorageDeviceProperty\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> StorageAdapterProperty:</span><br><span class="line">                    <span class="comment">// OS��Ҫ֪����������</span></span><br><span class="line">                    DbgPrint(<span class="string">&quot;OS Query: StorageAdapterProperty\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. Ȼ���ȡ�豸������Ϣ</span></span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_GET_DRIVE_GEOMETRY: &#123;</span><br><span class="line">            DbgPrint(<span class="string">&quot;OS Query: DISK_GET_DRIVE_GEOMETRY\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. ��ȡ������Ϣ</span></span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_GET_PARTITION_INFO: &#123;</span><br><span class="line">            DbgPrint(<span class="string">&quot;OS Query: DISK_GET_PARTITION_INFO\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. ������״̬</span></span><br><span class="line">        <span class="keyword">case</span> IOCTL_STORAGE_CHECK_VERIFY: &#123;</span><br><span class="line">            DbgPrint(<span class="string">&quot;OS Query: STORAGE_CHECK_VERIFY\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. ��ȡ�豸��</span></span><br><span class="line">        <span class="keyword">case</span> IOCTL_STORAGE_GET_DEVICE_NUMBER: &#123;</span><br><span class="line">            DbgPrint(<span class="string">&quot;OS Query: STORAGE_GET_DEVICE_NUMBER\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 6. ��ȡ��������</span></span><br><span class="line">        <span class="keyword">case</span> IOCTL_STORAGE_GET_MEDIA_TYPES: &#123;</span><br><span class="line">            DbgPrint(<span class="string">&quot;OS Query: STORAGE_GET_MEDIA_TYPES\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 7. ��ȡ������Ϣ</span></span><br><span class="line">        <span class="keyword">case</span> IOCTL_DISK_GET_LENGTH_INFO: &#123;</span><br><span class="line">            DbgPrint(<span class="string">&quot;OS Query: DISK_GET_LENGTH_INFO\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ʵ�ʵ�OS��ѯ���д����ǣ�</p>
<ol>
<li>�豸��ʼ����ɺ�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">OS -&gt; Driver: IOCTL_STORAGE_QUERY_PROPERTY (StorageDeviceProperty)</span><br><span class="line">OS -&gt; Driver: IOCTL_STORAGE_QUERY_PROPERTY (StorageAdapterProperty)</span><br><span class="line">OS -&gt; Driver: IOCTL_DISK_GET_DRIVE_GEOMETRY</span><br><span class="line">OS -&gt; Driver: IOCTL_DISK_GET_PARTITION_INFO</span><br><span class="line">OS -&gt; Driver: IOCTL_STORAGE_CHECK_VERIFY</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>����ʶ��׶Σ�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OS -&gt; Driver: IOCTL_DISK_GET_DRIVE_GEOMETRY</span><br><span class="line">OS -&gt; Driver: IOCTL_DISK_GET_LENGTH_INFO</span><br><span class="line">OS -&gt; Driver: IOCTL_DISK_GET_PARTITION_INFO</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>�ļ�ϵͳ���ؽ׶Σ�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OS -&gt; Driver: IOCTL_STORAGE_CHECK_VERIFY</span><br><span class="line">OS -&gt; Driver: IOCTL_DISK_IS_WRITABLE</span><br><span class="line">OS -&gt; Driver: IOCTL_DISK_GET_PARTITION_INFO</span><br></pre></td></tr></table></figure>

<p>������Ҫ��ȷ��Ӧ��Щ����OS��������豸�����ú͹��ء������������м������������۲�ʵ�ʵ��������С�</p>
<h2 id="User-32"><a href="#User-32" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����֮ǰ�ĶԻ���дһ���ĵ�����ϸ������WDFʵ�ֳ����Զ����SD Host Controller����,, �Զ�������ϸ�������������ʵ�֣�����Host��Card�����ã�����ϵͳ��������ν�����SD������Դ������I&#x2F;O����SD�������ϵͳ��ʾΪ�洢�豸���ȵ�</p>
<h2 id="AI-claude-3-5-sonnet-32"><a href="#AI-claude-3-5-sonnet-32" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�һ���½�дһ����ϸ���ĵ����������ʹ��WDFʵ���Զ���SD Host Controller������</p>
<h1 id="WDF-SD-Host-Controller����ʵ��ָ��"><a href="#WDF-SD-Host-Controller����ʵ��ָ��" class="headerlink" title="WDF SD Host Controller����ʵ��ָ��"></a>WDF SD Host Controller����ʵ��ָ��</h1><h2 id="1-����ܹ�"><a href="#1-����ܹ�" class="headerlink" title="1. ����ܹ�"></a>1. ����ܹ�</h2><h3 id="1-1-�������"><a href="#1-1-�������" class="headerlink" title="1.1 �������"></a>1.1 �������</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Ӧ�ò�</span><br><span class="line">  ��</span><br><span class="line">�ļ�ϵͳ</span><br><span class="line">  ��</span><br><span class="line">��������</span><br><span class="line">  ��</span><br><span class="line">�洢������</span><br><span class="line">  ��</span><br><span class="line">WDF SD Host���� (�����ص�)</span><br><span class="line">  ��</span><br><span class="line">PCIe����</span><br><span class="line">  ��</span><br><span class="line">Ӳ��(SD Host Controller)</span><br></pre></td></tr></table></figure>

<h3 id="1-2-��Ҫ����g��"><a href="#1-2-��Ҫ����g��" class="headerlink" title="1.2 ��Ҫ����ģ��"></a>1.2 ��Ҫ����ģ��</h3><ul>
<li>�豸��ʼ��������</li>
<li>SD�����</li>
<li>DMA�������</li>
<li>�жϴ���</li>
<li>��Դ����</li>
<li>�洢�ӿ�ʵ��</li>
</ul>
<h2 id="2-������ܳ�ʼ��"><a href="#2-������ܳ�ʼ��" class="headerlink" title="2. ������ܳ�ʼ��"></a>2. ������ܳ�ʼ��</h2><h3 id="2-1-�������"><a href="#2-1-�������" class="headerlink" title="2.1 �������"></a>2.1 �������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT  DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;config, RtsPciEvtDeviceAdd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> WdfDriverCreate(DriverObject,</span><br><span class="line">                          RegistryPath,</span><br><span class="line">                          WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                          &amp;config,</span><br><span class="line">                          WDF_NO_HANDLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-�豸������"><a href="#2-2-�豸������" class="headerlink" title="2.2 �豸������"></a>2.2 �豸������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_CONTEXT</span> &#123;</span></span><br><span class="line">    WDFDEVICE       Device;</span><br><span class="line">    WDFQUEUE        IoQueue;</span><br><span class="line">    WDFINTERRUPT    Interrupt;</span><br><span class="line">    WDFDMAENABLER   DmaEnabler;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Ĵ�����Դ</span></span><br><span class="line">    PVOID           RegisterBase;</span><br><span class="line">    ULONG           RegisterLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SD��״̬</span></span><br><span class="line">    BOOLEAN         CardPresent;</span><br><span class="line">    BOOLEAN         HighCapacity;</span><br><span class="line">    ULONG           CardRCA;</span><br><span class="line">    ULONG           BlockSize;</span><br><span class="line">    LARGE_INTEGER   DiskSize;</span><br><span class="line">    UCHAR           CardCID[<span class="number">16</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����״̬</span></span><br><span class="line">    WDFREQUEST      CurrentRequest;</span><br><span class="line">    ULONG           CurrentLba;</span><br><span class="line">    ULONG           CurrentLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ״̬</span></span><br><span class="line">    DEVICE_POWER_STATE PowerState;</span><br><span class="line">&#125; DEVICE_CONTEXT, *PDEVICE_CONTEXT;</span><br></pre></td></tr></table></figure>

<h2 id="3-Host-Controller��ʼ��"><a href="#3-Host-Controller��ʼ��" class="headerlink" title="3. Host Controller��ʼ��"></a>3. Host Controller��ʼ��</h2><h3 id="3-1-Ӳ����Դ��ȡ"><a href="#3-1-Ӳ����Դ��ȡ" class="headerlink" title="3.1 Ӳ����Դ��ȡ"></a>3.1 Ӳ����Դ��ȡ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciEvtPrepareHardware</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceList,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceListTranslated</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ��ȡ�Ĵ�����Դ</span></span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">    <span class="comment">// ��ʼ���ж�</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-Host-Controller����"><a href="#3-2-Host-Controller����" class="headerlink" title="3.2 Host Controller����"></a>3.2 Host Controller����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeController</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ��λ������</span></span><br><span class="line">    <span class="comment">// ����ʱ��</span></span><br><span class="line">    <span class="comment">// ���õ�ѹ</span></span><br><span class="line">    <span class="comment">// ʹ���ж�</span></span><br><span class="line">    <span class="comment">// ����DMA</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-SD����ʼ��������"><a href="#4-SD����ʼ��������" class="headerlink" title="4. SD����ʼ��������"></a>4. SD����ʼ��������</h2><h3 id="4-1-��������ʼ��"><a href="#4-1-��������ʼ��" class="headerlink" title="4.1 ��������ʼ��"></a>4.1 ��������ʼ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// CMD0 - ��λ</span></span><br><span class="line">    <span class="comment">// CMD8 - ��ѹ���</span></span><br><span class="line">    <span class="comment">// ACMD41 - ��ʼ��</span></span><br><span class="line">    <span class="comment">// CMD2 - ��ȡCID</span></span><br><span class="line">    <span class="comment">// CMD3 - ��ȡRCA</span></span><br><span class="line">    <span class="comment">// CMD9 - ��ȡCSD</span></span><br><span class="line">    <span class="comment">// CMD7 - ѡ��</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-������"><a href="#4-2-������" class="headerlink" title="4.2 ������"></a>4.2 ������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciConfigureCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// �������߿���</span></span><br><span class="line">    <span class="comment">// ����ʱ��Ƶ��</span></span><br><span class="line">    <span class="comment">// ���ÿ��С</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-�洢�ӿ�ʵ��"><a href="#5-�洢�ӿ�ʵ��" class="headerlink" title="5. �洢�ӿ�ʵ��"></a>5. �洢�ӿ�ʵ��</h2><h3 id="5-1-�豸�ӿ�ע��"><a href="#5-1-�豸�ӿ�ע��" class="headerlink" title="5.1 �豸�ӿ�ע��"></a>5.1 �豸�ӿ�ע��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciRegisterStorageInterface</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ע��Ϊ�����豸</span></span><br><span class="line">    <span class="comment">// �����豸����</span></span><br><span class="line">    <span class="comment">// ���ô������</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-������"><a href="#5-2-������" class="headerlink" title="5.2 ������"></a>5.2 ������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">RtsPciEvtIoDeviceControl</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFQUEUE Queue,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ ULONG IoControlCode</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// �����豸��ѯ</span></span><br><span class="line">    <span class="comment">// ����������Ϣ</span></span><br><span class="line">    <span class="comment">// ����������Ϣ</span></span><br><span class="line">    <span class="comment">// ����������ѯ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-I-O����"><a href="#6-I-O����" class="headerlink" title="6. I&#x2F;O����"></a>6. I&#x2F;O����</h2><h3 id="6-1-��д����"><a href="#6-1-��д����" class="headerlink" title="6.1 ��д����"></a>6.1 ��д����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">VOID RtsPciEvtIoRead/Write(</span><br><span class="line">    _In_ WDFQUEUE Queue,</span><br><span class="line">    _In_ WDFREQUEST Request,</span><br><span class="line">    _In_ <span class="type">size_t</span> Length</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ������֤</span></span><br><span class="line">    <span class="comment">// DMA����</span></span><br><span class="line">    <span class="comment">// �����</span></span><br><span class="line">    <span class="comment">// ���ݴ���</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-DMA����"><a href="#6-2-DMA����" class="headerlink" title="6.2 DMA����"></a>6.2 DMA����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciSetupDmaForRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ����DMA������</span></span><br><span class="line">    <span class="comment">// ���ô������</span></span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-�жϴ���"><a href="#7-�жϴ���" class="headerlink" title="7. �жϴ���"></a>7. �жϴ���</h2><h3 id="7-1-ISR"><a href="#7-1-ISR" class="headerlink" title="7.1 ISR"></a>7.1 ISR</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN <span class="title function_">RtsPciEvtInterruptIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ ULONG MessageID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ��ȡ�ж�״̬</span></span><br><span class="line">    <span class="comment">// ����������ж�</span></span><br><span class="line">    <span class="comment">// ������������ж�</span></span><br><span class="line">    <span class="comment">// ���������ж�</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-DPC"><a href="#7-2-DPC" class="headerlink" title="7.2 DPC"></a>7.2 DPC</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">RtsPciEvtInterruptDpc</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ WDFOBJECT Device</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// �������</span></span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">    <span class="comment">// ������һ������</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-��Դ����"><a href="#8-��Դ����" class="headerlink" title="8. ��Դ����"></a>8. ��Դ����</h2><h3 id="8-1-��Դ״̬ת��"><a href="#8-1-��Դ״̬ת��" class="headerlink" title="8.1 ��Դ״̬ת��"></a>8.1 ��Դ״̬ת��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS RtsPciEvtDeviceD0Entry/Exit(</span><br><span class="line">    _In_ WDFDEVICE Device,</span><br><span class="line">    _In_ WDF_POWER_DEVICE_STATE State</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Host Controller��Դ����</span></span><br><span class="line">    <span class="comment">// SD����Դ����</span></span><br><span class="line">    <span class="comment">// ʱ�ӹ���</span></span><br><span class="line">    <span class="comment">// ״̬�ָ�</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-���й���"><a href="#8-2-���й���" class="headerlink" title="8.2 ���й���"></a>8.2 ���й���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciConfigureIdleSettings</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ���ÿ��г�ʱ</span></span><br><span class="line">    <span class="comment">// ���û���Դ</span></span><br><span class="line">    <span class="comment">// ���õ͹���״̬</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="9-������"><a href="#9-������" class="headerlink" title="9. ������"></a>9. ������</h2><h3 id="9-1-�������"><a href="#9-1-�������" class="headerlink" title="9.1 �������"></a>9.1 �������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciHandleCommandError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ ULONG ErrorStatus</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ������������</span></span><br><span class="line">    <span class="comment">// ���Բ���</span></span><br><span class="line">    <span class="comment">// ����ָ�</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-2-�������"><a href="#9-2-�������" class="headerlink" title="9.2 �������"></a>9.2 �������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciHandleTransferError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ ULONG ErrorStatus</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// DMA������</span></span><br><span class="line">    <span class="comment">// ���ݴ���ָ�</span></span><br><span class="line">    <span class="comment">// ���´���</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="10-����֧��"><a href="#10-����֧��" class="headerlink" title="10. ����֧��"></a>10. ����֧��</h2><h3 id="10-1-WPP����"><a href="#10-1-WPP����" class="headerlink" title="10.1 WPP����"></a>10.1 WPP����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ������ٱ�־</span></span><br><span class="line"><span class="comment">// ʵ�ָ��ٺ���</span></span><br><span class="line"><span class="comment">// ���ø��ټ���</span></span><br></pre></td></tr></table></figure>

<h3 id="10-2-���ܼ�����"><a href="#10-2-���ܼ�����" class="headerlink" title="10.2 ���ܼ�����"></a>10.2 ���ܼ�����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��������ͳ��</span></span><br><span class="line"><span class="comment">// ����ͳ��</span></span><br><span class="line"><span class="comment">// ״̬���</span></span><br></pre></td></tr></table></figure>

<h2 id="11-�ܽ�"><a href="#11-�ܽ�" class="headerlink" title="11. �ܽ�"></a>11. �ܽ�</h2><p>ʵ��һ��������SD Host Controller������Ҫ���ǣ�</p>
<ol>
<li>��׼Э����ѭ</li>
<li>�����Ż�</li>
<li>�ɿ��Ա�֤</li>
<li>��Դ����</li>
<li>������</li>
<li>����֧��</li>
</ol>
<p>���鰴�����ϼܹ���ʵ�֣�ȷ��ÿ��ģ�����ȷ�ԺͿɿ��ԡ�</p>
<p>[�������ҿ�����ϸչ���κ�һ������Ȥ�Ĳ���]</p>
<h2 id="User-33"><a href="#User-33" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>��ϸչ��ÿһ������</p>
<h2 id="AI-claude-3-5-sonnet-33"><a href="#AI-claude-3-5-sonnet-33" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õ�,�ҽ��ֶ��������ϸչ������ĵ����ȴӵ�һ���ֿ�ʼ:</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-1"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-1" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 1"></a>WDF SD Host Controller����ʵ����� - Part 1</h1><h2 id="1-����ܹ����"><a href="#1-����ܹ����" class="headerlink" title="1. ����ܹ����"></a>1. ����ܹ����</h2><h3 id="1-1-����������"><a href="#1-1-����������" class="headerlink" title="1.1 ����������"></a>1.1 ����������</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">�û�Ӧ�ó���</span><br><span class="line">  ��</span><br><span class="line">�ļ�ϵͳ(��NTFS/FAT32)</span><br><span class="line">  - �ļ�����ת��Ϊ�����</span><br><span class="line">  - �����ļ�ϵͳ�ṹ</span><br><span class="line">  ��</span><br><span class="line">��������(PartMgr.sys)</span><br><span class="line">  - ����������</span><br><span class="line">  - ����������Ϣ</span><br><span class="line">  ��</span><br><span class="line">�洢������(Disk.sys)</span><br><span class="line">  - ���豸����</span><br><span class="line">  - IO������й���</span><br><span class="line">  ��</span><br><span class="line">WDF SD Host����(�Զ�������)</span><br><span class="line">  - SDЭ��ʵ��</span><br><span class="line">  - DMA����</span><br><span class="line">  - �жϴ���</span><br><span class="line">  - ��Դ����</span><br><span class="line">  ��</span><br><span class="line">PCIe��������</span><br><span class="line">  - ��Դ����</span><br><span class="line">  - ���߲���</span><br><span class="line">  ��</span><br><span class="line">Ӳ��(SD Host Controller)</span><br><span class="line">  - �Ĵ�������</span><br><span class="line">  - ��������</span><br></pre></td></tr></table></figure>

<h3 id="1-2-�ؼ����ݽu"><a href="#1-2-�ؼ����ݽu" class="headerlink" title="1.2 �ؼ����ݽṹ"></a>1.2 �ؼ����ݽṹ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ����ȫ������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DRIVER_GLOBALS</span> &#123;</span></span><br><span class="line">    ULONG               DebugLevel;</span><br><span class="line">    ULONG               DebugFlags;</span><br><span class="line">    UNICODE_STRING      RegistryPath;</span><br><span class="line">    WDF_DRIVER_GLOBALS  WdfDriverGlobals;</span><br><span class="line">&#125; DRIVER_GLOBALS, *PDRIVER_GLOBALS;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �豸��չ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_CONTEXT</span> &#123;</span></span><br><span class="line">    <span class="comment">// WDF����</span></span><br><span class="line">    WDFDEVICE           Device;</span><br><span class="line">    WDFQUEUE            IoQueue;</span><br><span class="line">    WDFINTERRUPT        Interrupt;</span><br><span class="line">    WDFDMAENABLER       DmaEnabler;</span><br><span class="line">    WDFSPINLOCK        Lock;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Ӳ����Դ</span></span><br><span class="line">    PHYSICAL_ADDRESS    RegisterBasePA;    <span class="comment">// ������ַ</span></span><br><span class="line">    PVOID              RegisterBase;       <span class="comment">// �����ַ</span></span><br><span class="line">    ULONG              RegisterLength;</span><br><span class="line">    ULONG              InterruptVector;</span><br><span class="line">    KIRQL              InterruptIrql;</span><br><span class="line">    KINTERRUPT_MODE    InterruptMode;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SD����Ϣ</span></span><br><span class="line">    BOOLEAN            CardPresent;</span><br><span class="line">    BOOLEAN            HighCapacity;</span><br><span class="line">    ULONG             CardRCA;</span><br><span class="line">    ULONG             BlockSize;</span><br><span class="line">    LARGE_INTEGER     DiskSize;</span><br><span class="line">    UCHAR             CardCID[<span class="number">16</span>];</span><br><span class="line">    UCHAR             CardCSD[<span class="number">16</span>];</span><br><span class="line">    SD_CARD_TYPE      CardType;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����״̬</span></span><br><span class="line">    WDFREQUEST         CurrentRequest;</span><br><span class="line">    ULONG              CurrentLba;</span><br><span class="line">    ULONG              CurrentLength;</span><br><span class="line">    DMA_TRANSFER_INFO  DmaInfo;</span><br><span class="line">    BOOLEAN            TransferActive;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ͳ��</span></span><br><span class="line">    LARGE_INTEGER      TotalBytesTransferred;</span><br><span class="line">    ULONG              TotalRequests;</span><br><span class="line">    ULONG              ErrorCount;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ����</span></span><br><span class="line">    DEVICE_POWER_STATE PowerState;</span><br><span class="line">    BOOLEAN           WakeEnabled;</span><br><span class="line">    ULONG             IdleTimeout;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������Ϣ</span></span><br><span class="line">    ULONG             MaxBlockCount;</span><br><span class="line">    ULONG             MaxClockFrequency;</span><br><span class="line">    ULONG             CurrentClock;</span><br><span class="line">    ULONG             CurrentVoltage;</span><br><span class="line">    BOOLEAN           Bus4BitMode;</span><br><span class="line">    BOOLEAN           HighSpeedMode;</span><br><span class="line">    </span><br><span class="line">&#125; DEVICE_CONTEXT, *PDEVICE_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DMA������Ϣ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DMA_TRANSFER_INFO</span> &#123;</span></span><br><span class="line">    PHYSICAL_ADDRESS    PhysicalAddress;</span><br><span class="line">    PVOID              VirtualAddress;</span><br><span class="line">    ULONG              Length;</span><br><span class="line">    BOOLEAN            WriteToDevice;</span><br><span class="line">    PMDL               Mdl;</span><br><span class="line">    STOR_SCATTER_GATHER_LIST SGList;</span><br><span class="line">&#125; DMA_TRANSFER_INFO, *PDMA_TRANSFER_INFO;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SD����ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SD_COMMAND</span> &#123;</span></span><br><span class="line">    UCHAR  Index;</span><br><span class="line">    ULONG  Argument;</span><br><span class="line">    UCHAR  ResponseType;</span><br><span class="line">    ULONG  Response[<span class="number">4</span>];</span><br><span class="line">    BOOLEAN HasData;</span><br><span class="line">    BOOLEAN IsWrite;</span><br><span class="line">    ULONG  BlockCount;</span><br><span class="line">    ULONG  BlockSize;</span><br><span class="line">    ULONG  Timeout;</span><br><span class="line">&#125; SD_COMMAND, *PSD_COMMAND;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-������ʼ������"><a href="#1-3-������ʼ������" class="headerlink" title="1.3 ������ʼ������"></a>1.3 ������ʼ������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT  DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    WDFDRIVER driver;</span><br><span class="line">    PDRIVER_GLOBALS pDriverGlobals;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��������ȫ������</span></span><br><span class="line">    pDriverGlobals = ExAllocatePoolWithTag(NonPagedPool, </span><br><span class="line">                                         <span class="keyword">sizeof</span>(DRIVER_GLOBALS),</span><br><span class="line">                                         <span class="string">&#x27;SDHR&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!pDriverGlobals) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ��WPP����</span></span><br><span class="line">    WPP_INIT_TRACING(DriverObject, RegistryPath);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����WDF����</span></span><br><span class="line">    WDF_DRIVER_CONFIG_INIT(&amp;config, RtsPciEvtDeviceAdd);</span><br><span class="line">    config.EvtDriverUnload = RtsPciEvtDriverUnload;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����WDF��������</span></span><br><span class="line">    status = WdfDriverCreate(DriverObject,</span><br><span class="line">                           RegistryPath,</span><br><span class="line">                           WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                           &amp;config,</span><br><span class="line">                           &amp;driver);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����ȫ������</span></span><br><span class="line">    RtlCopyUnicodeString(&amp;pDriverGlobals-&gt;RegistryPath, RegistryPath);</span><br><span class="line">    WdfDriverSetData(driver, pDriverGlobals);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line"></span><br><span class="line">cleanup:</span><br><span class="line">    <span class="keyword">if</span> (pDriverGlobals) &#123;</span><br><span class="line">        ExFreePool(pDriverGlobals);</span><br><span class="line">    &#125;</span><br><span class="line">    WPP_CLEANUP(DriverObject);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-4-�豸���󴴽�"><a href="#1-4-�豸���󴴽�" class="headerlink" title="1.4 �豸���󴴽�"></a>1.4 �豸���󴴽�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceAdd</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_    WDFDRIVER       Driver,</span></span><br><span class="line"><span class="params">    _Inout_ PWDFDEVICE_INIT DeviceInit</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDFDEVICE device;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES attributes;</span><br><span class="line">    WDF_PNPPOWER_EVENT_CALLBACKS pnpPowerCallbacks;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����PnP/Power�ص�</span></span><br><span class="line">    WDF_PNPPOWER_EVENT_CALLBACKS_INIT(&amp;pnpPowerCallbacks);</span><br><span class="line">    pnpPowerCallbacks.EvtDevicePrepareHardware = RtsPciEvtPrepareHardware;</span><br><span class="line">    pnpPowerCallbacks.EvtDeviceReleaseHardware = RtsPciEvtReleaseHardware;</span><br><span class="line">    pnpPowerCallbacks.EvtDeviceD0Entry = RtsPciEvtDeviceD0Entry;</span><br><span class="line">    pnpPowerCallbacks.EvtDeviceD0Exit = RtsPciEvtDeviceD0Exit;</span><br><span class="line">    </span><br><span class="line">    WdfDeviceInitSetPnpPowerEventCallbacks(DeviceInit, &amp;pnpPowerCallbacks);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����豸����</span></span><br><span class="line">    WDF_OBJECT_ATTRIBUTES_INIT_CONTEXT_TYPE(&amp;attributes, DEVICE_CONTEXT);</span><br><span class="line">    </span><br><span class="line">    status = WdfDeviceCreate(&amp;DeviceInit, </span><br><span class="line">                            &amp;attributes,</span><br><span class="line">                            &amp;device);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ȡ�豸������</span></span><br><span class="line">    devContext = GetDeviceContext(device);</span><br><span class="line">    RtlZeroMemory(devContext, <span class="keyword">sizeof</span>(DEVICE_CONTEXT));</span><br><span class="line">    devContext-&gt;Device = device;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �����豸�ӿ�</span></span><br><span class="line">    status = WdfDeviceCreateDeviceInterface(</span><br><span class="line">        device,</span><br><span class="line">        &amp;GUID_DEVINTERFACE_DISK,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����IO����</span></span><br><span class="line">    status = RtsPciCreateIoQueues(devContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ��ʼ��DMA</span></span><br><span class="line">    status = RtsPciInitializeDma(devContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7. �����ж϶���</span></span><br><span class="line">    status = RtsPciCreateInterrupt(devContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[���� - ��һ���ֽ���ϸ����Host Controller��ʼ��������]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-34"><a href="#User-34" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-34"><a href="#AI-claude-3-5-sonnet-34" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-2"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-2" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 2"></a>WDF SD Host Controller����ʵ����� - Part 2</h1><h2 id="2-Host-Controller��ʼ��������"><a href="#2-Host-Controller��ʼ��������" class="headerlink" title="2. Host Controller��ʼ��������"></a>2. Host Controller��ʼ��������</h2><h3 id="2-1-Ӳ����Դ��ȡ"><a href="#2-1-Ӳ����Դ��ȡ" class="headerlink" title="2.1 Ӳ����Դ��ȡ"></a>2.1 Ӳ����Դ��ȡ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciEvtPrepareHardware</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceList,</span></span><br><span class="line"><span class="params">    _In_ WDFCMRESLIST ResourceListTranslated</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    PCM_PARTIAL_RESOURCE_DESCRIPTOR descriptor;</span><br><span class="line">    ULONG resourceCount;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(Device);</span><br><span class="line">    resourceCount = WdfCmResourceListGetCount(ResourceListTranslated);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��������ȡ��Դ</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; resourceCount; i++) &#123;</span><br><span class="line">        descriptor = WdfCmResourceListGetDescriptor(ResourceListTranslated, i);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (descriptor-&gt;Type) &#123;</span><br><span class="line">            <span class="keyword">case</span> CmResourceTypeMemory:</span><br><span class="line">                <span class="comment">// ӳ��Ĵ����ռ�</span></span><br><span class="line">                devContext-&gt;RegisterBasePA = descriptor-&gt;u.Memory.Start;</span><br><span class="line">                devContext-&gt;RegisterLength = descriptor-&gt;u.Memory.Length;</span><br><span class="line">                </span><br><span class="line">                devContext-&gt;RegisterBase = MmMapIoSpaceEx(</span><br><span class="line">                    devContext-&gt;RegisterBasePA,</span><br><span class="line">                    devContext-&gt;RegisterLength,</span><br><span class="line">                    PAGE_READWRITE | PAGE_NOCACHE);</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">if</span> (!devContext-&gt;RegisterBase) &#123;</span><br><span class="line">                    <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> CmResourceTypeInterrupt:</span><br><span class="line">                <span class="comment">// �����ж���Ϣ</span></span><br><span class="line">                devContext-&gt;InterruptVector = descriptor-&gt;u.Interrupt.Vector;</span><br><span class="line">                devContext-&gt;InterruptIrql = descriptor-&gt;u.Interrupt.Level;</span><br><span class="line">                devContext-&gt;InterruptMode = descriptor-&gt;Flags &amp; </span><br><span class="line">                    CM_RESOURCE_INTERRUPT_LATCHED ? </span><br><span class="line">                    Latched : LevelSensitive;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> CmResourceTypeMemoryLarge:</span><br><span class="line">                <span class="comment">// DMA����������</span></span><br><span class="line">                status = RtsPciConfigureDmaBuffer(devContext, descriptor);</span><br><span class="line">                <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> status;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ��Host Controller</span></span><br><span class="line">    status = RtsPciInitializeController(devContext);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Host-Controller��ʼ��"><a href="#2-2-Host-Controller��ʼ��" class="headerlink" title="2.2 Host Controller��ʼ��"></a>2.2 Host Controller��ʼ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeController</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����λ������</span></span><br><span class="line">    status = RtsPciResetController(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ����������</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CTRL_TIMEOUT,</span><br><span class="line">        DEFAULT_TIMEOUT_VALUE);</span><br><span class="line">        </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CTRL_CLOCK,</span><br><span class="line">        INITIAL_CLOCK_FREQ);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. ����DMA</span></span><br><span class="line">    status = RtsPciConfigureDma(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �����ж�</span></span><br><span class="line">    ULONG intMask = CARD_DETECT_INT | </span><br><span class="line">                    COMMAND_COMPLETE_INT |</span><br><span class="line">                    TRANSFER_COMPLETE_INT |</span><br><span class="line">                    DMA_INT |</span><br><span class="line">                    ERROR_INT;</span><br><span class="line">                    </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CTRL_INT_ENABLE,</span><br><span class="line">        intMask);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 5. ���ó�ʼ��ѹ</span></span><br><span class="line">    status = RtsPciSetVoltage(DevContext, SD_VOLTAGE_3_3V);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ��ʼ�����ܼ�����</span></span><br><span class="line">    KeQuerySystemTime(&amp;DevContext-&gt;LastPerformanceTime);</span><br><span class="line">    DevContext-&gt;TotalBytesTransferred.QuadPart = <span class="number">0</span>;</span><br><span class="line">    DevContext-&gt;TotalRequests = <span class="number">0</span>;</span><br><span class="line">    DevContext-&gt;ErrorCount = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-DMA����"><a href="#2-3-DMA����" class="headerlink" title="2.3 DMA����"></a>2.3 DMA����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciConfigureDma</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DMA_ENABLER_CONFIG dmaConfig;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����DMAʹ����</span></span><br><span class="line">    WDF_DMA_ENABLER_CONFIG_INIT(&amp;dmaConfig,</span><br><span class="line">                               WdfDmaProfileScatterGather,</span><br><span class="line">                               MAX_TRANSFER_LENGTH);</span><br><span class="line">                               </span><br><span class="line">    status = WdfDmaEnablerCreate(DevContext-&gt;Device,</span><br><span class="line">                                &amp;dmaConfig,</span><br><span class="line">                                WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">                                &amp;DevContext-&gt;DmaEnabler);</span><br><span class="line">                                </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����DMA������</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_DESC_ADDR,</span><br><span class="line">        DevContext-&gt;DmaDescPhysical.LowPart);</span><br><span class="line">        </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_DESC_ADDR_HIGH,</span><br><span class="line">        DevContext-&gt;DmaDescPhysical.HighPart);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. ����DMA�������</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_BURST_SIZE,</span><br><span class="line">        DMA_BURST_SIZE_32);</span><br><span class="line">        </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_BOUNDARY,</span><br><span class="line">        DMA_BOUNDARY_4K);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-�ж�����"><a href="#2-4-�ж�����" class="headerlink" title="2.4 �ж�����"></a>2.4 �ж�����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciCreateInterrupt</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_INTERRUPT_CONFIG interruptConfig;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����ж϶���</span></span><br><span class="line">    WDF_INTERRUPT_CONFIG_INIT(</span><br><span class="line">        &amp;interruptConfig,</span><br><span class="line">        RtsPciEvtInterruptIsr,</span><br><span class="line">        RtsPciEvtInterruptDpc);</span><br><span class="line">        </span><br><span class="line">    interruptConfig.PassiveHandling = FALSE;</span><br><span class="line">    interruptConfig.InterruptTranslated = TRUE;</span><br><span class="line">    interruptConfig.InterruptRaw = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����ж϶���</span></span><br><span class="line">    status = WdfInterruptCreate(</span><br><span class="line">        DevContext-&gt;Device,</span><br><span class="line">        &amp;interruptConfig,</span><br><span class="line">        WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">        &amp;DevContext-&gt;Interrupt);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����MSI/MSI-X(���֧��)</span></span><br><span class="line">    <span class="keyword">if</span> (DevContext-&gt;MsiSupported) &#123;</span><br><span class="line">        status = RtsPciConfigureMsi(DevContext);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">return</span> status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-��Դ����"><a href="#2-5-��Դ����" class="headerlink" title="2.5 ��Դ����"></a>2.5 ��Դ����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciConfigurePower</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DEVICE_POWER_POLICY_IDLE_SETTINGS idleSettings;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���ÿ�������</span></span><br><span class="line">    WDF_DEVICE_POWER_POLICY_IDLE_SETTINGS_INIT(</span><br><span class="line">        &amp;idleSettings,</span><br><span class="line">        IdleCannotWakeFromS0);</span><br><span class="line">        </span><br><span class="line">    idleSettings.IdleTimeout = DEFAULT_IDLE_TIMEOUT;</span><br><span class="line">    </span><br><span class="line">    status = WdfDeviceAssignS0IdleSettings(</span><br><span class="line">        DevContext-&gt;Device,</span><br><span class="line">        &amp;idleSettings);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���û�������</span></span><br><span class="line">    <span class="keyword">if</span> (DevContext-&gt;WakeSupported) &#123;</span><br><span class="line">        WDF_DEVICE_POWER_POLICY_WAKE_SETTINGS wakeSettings;</span><br><span class="line">        </span><br><span class="line">        WDF_DEVICE_POWER_POLICY_WAKE_SETTINGS_INIT(&amp;wakeSettings);</span><br><span class="line">        </span><br><span class="line">        status = WdfDeviceAssignSxWakeSettings(</span><br><span class="line">            DevContext-&gt;Device,</span><br><span class="line">            &amp;wakeSettings);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">return</span> status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[���� - ��һ���ֽ���ϸ����SD����ʼ���������]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-35"><a href="#User-35" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-35"><a href="#AI-claude-3-5-sonnet-35" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ��SD����ʼ������������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-3"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-3" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 3"></a>WDF SD Host Controller����ʵ����� - Part 3</h1><h2 id="3-SD����ʼ���������"><a href="#3-SD����ʼ���������" class="headerlink" title="3. SD����ʼ���������"></a>3. SD����ʼ���������</h2><h3 id="3-1-SD��������ʼ������"><a href="#3-1-SD��������ʼ������" class="headerlink" title="3.1 SD��������ʼ������"></a>3.1 SD��������ʼ������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    SD_COMMAND cmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    ULONG response;</span><br><span class="line">    BOOLEAN sdVer2 = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��⿨��������</span></span><br><span class="line">    <span class="keyword">if</span> (!RtsPciIsCardPresent(DevContext)) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_NO_MEDIA;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �ϵ�����</span></span><br><span class="line">    status = RtsPciPowerUpSequence(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����CMD0(GO_IDLE_STATE)</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">0</span>, <span class="number">0</span>, SD_RESPONSE_NONE);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����CMD8(SEND_IF_COND)����ѹ</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">8</span>, <span class="number">0x1AA</span>, SD_RESPONSE_R7);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    sdVer2 = NT_SUCCESS(status);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����ACMD41��ʼ����</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SD_INIT_TIMEOUT_MS; i++) &#123;</span><br><span class="line">        <span class="comment">// �ȷ���CMD55</span></span><br><span class="line">        RtsPciInitCommand(&amp;cmd, <span class="number">55</span>, <span class="number">0</span>, SD_RESPONSE_R1);</span><br><span class="line">        status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����ACMD41</span></span><br><span class="line">        ULONG arg = sdVer2 ? <span class="number">0x40FF8000</span> : <span class="number">0x00FF8000</span>;</span><br><span class="line">        RtsPciInitCommand(&amp;cmd, <span class="number">41</span>, arg, SD_RESPONSE_R3);</span><br><span class="line">        status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        response = cmd.Response[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (response &amp; <span class="number">0x80000000</span>) &#123;</span><br><span class="line">            DevContext-&gt;HighCapacity = (response &amp; <span class="number">0x40000000</span>) ? TRUE : FALSE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        KeStallExecutionProcessor(<span class="number">1000</span>);  <span class="comment">// 1ms�ӳ�</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ��ȡCID</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">2</span>, <span class="number">0</span>, SD_RESPONSE_R2);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    RtlCopyMemory(DevContext-&gt;CardCID, cmd.Response, <span class="number">16</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7. ��ȡRCA</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">3</span>, <span class="number">0</span>, SD_RESPONSE_R6);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    DevContext-&gt;CardRCA = cmd.Response[<span class="number">0</span>] &gt;&gt; <span class="number">16</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 8. ��ȡCSD</span></span><br><span class="line">    status = RtsPciGetCardCapacity(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 9. ѡ��</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">7</span>, DevContext-&gt;CardRCA &lt;&lt; <span class="number">16</span>, SD_RESPONSE_R1b);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-�����ʵ��"><a href="#3-2-�����ʵ��" class="headerlink" title="3.2 �����ʵ��"></a>3.2 �����ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciSendCommand</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PSD_COMMAND Cmd</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    ULONG cmdReg, intStatus;</span><br><span class="line">    LARGE_INTEGER timeout;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �ȴ������߿���</span></span><br><span class="line">    status = RtsPciWaitForCommandLine(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ׼������Ĵ���ֵ</span></span><br><span class="line">    cmdReg = (Cmd-&gt;Index &lt;&lt; CMD_INDEX_SHIFT) |</span><br><span class="line">             (RtsPciGetResponseType(Cmd-&gt;ResponseType) &lt;&lt; RESP_TYPE_SHIFT);</span><br><span class="line">             </span><br><span class="line">    <span class="keyword">if</span> (Cmd-&gt;HasData) &#123;</span><br><span class="line">        cmdReg |= CMD_DATA_PRESENT;</span><br><span class="line">        <span class="keyword">if</span> (Cmd-&gt;IsWrite) &#123;</span><br><span class="line">            cmdReg |= CMD_WRITE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���ò���������</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_ARG_REG,</span><br><span class="line">        Cmd-&gt;Argument);</span><br><span class="line">        </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CMD_REG,</span><br><span class="line">        cmdReg);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 4. �ȴ��������</span></span><br><span class="line">    KeQuerySystemTime(&amp;timeout);</span><br><span class="line">    timeout.QuadPart += Cmd-&gt;Timeout * <span class="number">10000</span>; <span class="comment">// ת��Ϊ100ns��λ</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        intStatus = READ_REGISTER_ULONG(</span><br><span class="line">            DevContext-&gt;RegisterBase + HOST_INT_STATUS);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (intStatus &amp; COMMAND_COMPLETE_INT) &#123;</span><br><span class="line">            <span class="comment">// ����ж�״̬</span></span><br><span class="line">            WRITE_REGISTER_ULONG(</span><br><span class="line">                DevContext-&gt;RegisterBase + HOST_INT_STATUS,</span><br><span class="line">                COMMAND_COMPLETE_INT);</span><br><span class="line">                </span><br><span class="line">            <span class="comment">// ������</span></span><br><span class="line">            <span class="keyword">if</span> (intStatus &amp; ERROR_INT) &#123;</span><br><span class="line">                <span class="keyword">return</span> RtsPciHandleCommandError(DevContext, intStatus);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ��ȡ��Ӧ</span></span><br><span class="line">            <span class="keyword">if</span> (Cmd-&gt;ResponseType != SD_RESPONSE_NONE) &#123;</span><br><span class="line">                RtsPciGetResponse(DevContext, Cmd);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        KeStallExecutionProcessor(<span class="number">1</span>);  <span class="comment">// 1us�ӳ�</span></span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">while</span> (KeQuerySystemTime(&amp;timeout) &lt; <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_IO_TIMEOUT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.3 ��Ӧ����</span></span><br><span class="line">VOID <span class="title function_">RtsPciGetResponse</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PSD_COMMAND Cmd</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (Cmd-&gt;ResponseType) &#123;</span><br><span class="line">        <span class="keyword">case</span> SD_RESPONSE_R1:</span><br><span class="line">        <span class="keyword">case</span> SD_RESPONSE_R1b:</span><br><span class="line">        <span class="keyword">case</span> SD_RESPONSE_R3:</span><br><span class="line">        <span class="keyword">case</span> SD_RESPONSE_R6:</span><br><span class="line">        <span class="keyword">case</span> SD_RESPONSE_R7:</span><br><span class="line">            Cmd-&gt;Response[<span class="number">0</span>] = READ_REGISTER_ULONG(</span><br><span class="line">                DevContext-&gt;RegisterBase + HOST_RESP0_REG);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SD_RESPONSE_R2:</span><br><span class="line">            <span class="comment">// CID/CSD��Ҫ��ȡ����4���Ĵ���</span></span><br><span class="line">            Cmd-&gt;Response[<span class="number">0</span>] = READ_REGISTER_ULONG(</span><br><span class="line">                DevContext-&gt;RegisterBase + HOST_RESP0_REG);</span><br><span class="line">            Cmd-&gt;Response[<span class="number">1</span>] = READ_REGISTER_ULONG(</span><br><span class="line">                DevContext-&gt;RegisterBase + HOST_RESP1_REG);</span><br><span class="line">            Cmd-&gt;Response[<span class="number">2</span>] = READ_REGISTER_ULONG(</span><br><span class="line">                DevContext-&gt;RegisterBase + HOST_RESP2_REG);</span><br><span class="line">            Cmd-&gt;Response[<span class="number">3</span>] = READ_REGISTER_ULONG(</span><br><span class="line">                DevContext-&gt;RegisterBase + HOST_RESP3_REG);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.4 ������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleCommandError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ ULONG ErrorStatus</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// �������״̬</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_INT_STATUS,</span><br><span class="line">        ErrorStatus &amp; ERROR_INT_MASK);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ��λ������</span></span><br><span class="line">    <span class="keyword">if</span> (ErrorStatus &amp; (CMD_TIMEOUT_ERR | CMD_CRC_ERR)) &#123;</span><br><span class="line">        RtsPciResetCommandLine(DevContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���´���ͳ��</span></span><br><span class="line">    InterlockedIncrement(&amp;DevContext-&gt;ErrorCount);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ؾ��������</span></span><br><span class="line">    <span class="keyword">if</span> (ErrorStatus &amp; CMD_TIMEOUT_ERR) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_IO_TIMEOUT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ErrorStatus &amp; CMD_CRC_ERR) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_CRC_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_DEVICE_PROTOCOL_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-������"><a href="#3-3-������" class="headerlink" title="3.3 ������"></a>3.3 ������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciConfigureCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    SD_COMMAND cmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���ÿ��С</span></span><br><span class="line">    DevContext-&gt;BlockSize = <span class="number">512</span>;</span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_BLOCK_SIZE,</span><br><span class="line">        DevContext-&gt;BlockSize);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. �������߿���(4λģʽ)</span></span><br><span class="line">    <span class="comment">// �ȷ���CMD55</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">55</span>, DevContext-&gt;CardRCA &lt;&lt; <span class="number">16</span>, SD_RESPONSE_R1);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ACMD6</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">6</span>, <span class="number">2</span>, SD_RESPONSE_R1);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����Host Controller</span></span><br><span class="line">    ULONG hostCtrl = READ_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CTRL_REG);</span><br><span class="line">    hostCtrl |= HOST_CTRL_4BIT;</span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CTRL_REG,</span><br><span class="line">        hostCtrl);</span><br><span class="line">        </span><br><span class="line">    DevContext-&gt;Bus4BitMode = TRUE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����ʱ��Ƶ��</span></span><br><span class="line">    status = RtsPciSetClock(DevContext, SD_CLOCK_25MHZ);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[���� - ��һ���ֽ���ϸ�������ݴ����DMA����]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-36"><a href="#User-36" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-36"><a href="#AI-claude-3-5-sonnet-36" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ�����ݴ����DMA�������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-4"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-4" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 4"></a>WDF SD Host Controller����ʵ����� - Part 4</h1><h2 id="4-���ݴ�����DMA����"><a href="#4-���ݴ�����DMA����" class="headerlink" title="4. ���ݴ�����DMA����"></a>4. ���ݴ�����DMA����</h2><h3 id="4-1-��д������"><a href="#4-1-��д������" class="headerlink" title="4.1 ��д������"></a>4.1 ��д������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">RtsPciEvtIoRead</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFQUEUE Queue,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> Length</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    WDF_REQUEST_PARAMETERS params;</span><br><span class="line">    LARGE_INTEGER offset;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(WdfIoQueueGetDevice(Queue));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ�������</span></span><br><span class="line">    WDF_REQUEST_PARAMETERS_INIT(&amp;params);</span><br><span class="line">    WdfRequestGetParameters(Request, &amp;params);</span><br><span class="line">    offset.QuadPart = params.Parameters.Read.DeviceOffset;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ������֤</span></span><br><span class="line">    <span class="keyword">if</span> ((offset.QuadPart % devContext-&gt;BlockSize) != <span class="number">0</span> ||</span><br><span class="line">        (Length % devContext-&gt;BlockSize) != <span class="number">0</span>) &#123;</span><br><span class="line">        WdfRequestComplete(Request, STATUS_INVALID_PARAMETER);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��鿨״̬</span></span><br><span class="line">    <span class="keyword">if</span> (!devContext-&gt;CardPresent) &#123;</span><br><span class="line">        WdfRequestComplete(Request, STATUS_NO_MEDIA);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ׼������</span></span><br><span class="line">    status = RtsPciPrepareTransfer(</span><br><span class="line">        devContext,</span><br><span class="line">        Request,</span><br><span class="line">        offset.QuadPart / devContext-&gt;BlockSize,</span><br><span class="line">        Length / devContext-&gt;BlockSize,</span><br><span class="line">        FALSE);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        WdfRequestComplete(Request, status);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">RtsPciEvtIoWrite</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFQUEUE Queue,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ <span class="type">size_t</span> Length</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ���ƶ���������IsWrite = TRUE</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="4-2-����׼��"><a href="#4-2-����׼��" class="headerlink" title="4.2 ����׼��"></a>4.2 ����׼��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciPrepareTransfer</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ ULONGLONG StartingLba,</span></span><br><span class="line"><span class="params">    _In_ ULONG BlockCount,</span></span><br><span class="line"><span class="params">    _In_ BOOLEAN IsWrite</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    SD_COMMAND cmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���õ�ǰ������Ϣ</span></span><br><span class="line">    DevContext-&gt;CurrentRequest = Request;</span><br><span class="line">    DevContext-&gt;CurrentLba = (ULONG)StartingLba;</span><br><span class="line">    DevContext-&gt;CurrentLength = BlockCount * DevContext-&gt;BlockSize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ׼��DMA</span></span><br><span class="line">    status = RtsPciSetupDmaForRequest(DevContext, Request, IsWrite);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���ÿ����ʹ�С</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_BLOCK_COUNT,</span><br><span class="line">        BlockCount);</span><br><span class="line">        </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_BLOCK_SIZE,</span><br><span class="line">        DevContext-&gt;BlockSize);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 4. ׼������</span></span><br><span class="line">    <span class="keyword">if</span> (BlockCount == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// ���鴫��</span></span><br><span class="line">        cmd.Index = IsWrite ? <span class="number">24</span> : <span class="number">17</span>;  <span class="comment">// WRITE_BLOCK or READ_SINGLE_BLOCK</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ��鴫��</span></span><br><span class="line">        cmd.Index = IsWrite ? <span class="number">25</span> : <span class="number">18</span>;  <span class="comment">// WRITE_MULTIPLE_BLOCK or READ_MULTIPLE_BLOCK</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    cmd.Argument = DevContext-&gt;HighCapacity ? </span><br><span class="line">                  (ULONG)StartingLba : </span><br><span class="line">                  (ULONG)StartingLba * DevContext-&gt;BlockSize;</span><br><span class="line">    cmd.ResponseType = SD_RESPONSE_R1;</span><br><span class="line">    cmd.HasData = TRUE;</span><br><span class="line">    cmd.IsWrite = IsWrite;</span><br><span class="line">    cmd.BlockCount = BlockCount;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ��������</span></span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;TransferActive = TRUE;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="4-3-DMA����"><a href="#4-3-DMA����" class="headerlink" title="4.3 DMA����"></a>4.3 DMA����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciSetupDmaForRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ BOOLEAN IsWrite</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDFMEMORY requestMemory;</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES attributes;</span><br><span class="line">    PHYSICAL_ADDRESS highestAcceptableAddress;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ�����ڴ�</span></span><br><span class="line">    status = WdfRequestRetrieveOutputMemory(Request, &amp;requestMemory);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����DMA������</span></span><br><span class="line">    highestAcceptableAddress.QuadPart = MAXULONG64;</span><br><span class="line">    </span><br><span class="line">    WDF_DMA_ENABLER_CONFIG dmaConfig;</span><br><span class="line">    WDF_DMA_ENABLER_CONFIG_INIT(&amp;dmaConfig,</span><br><span class="line">                               WdfDmaProfileScatterGather,</span><br><span class="line">                               DevContext-&gt;CurrentLength);</span><br><span class="line">                               </span><br><span class="line">    <span class="comment">// 3. ����ͨ�û�����</span></span><br><span class="line">    status = WdfCommonBufferCreate(</span><br><span class="line">        DevContext-&gt;DmaEnabler,</span><br><span class="line">        DevContext-&gt;CurrentLength,</span><br><span class="line">        WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">        &amp;DevContext-&gt;DmaBuffer);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ��ȡ������ַ</span></span><br><span class="line">    DevContext-&gt;DmaBufferPA = </span><br><span class="line">        WdfCommonBufferGetAlignedLogicalAddress(DevContext-&gt;DmaBuffer);</span><br><span class="line">        </span><br><span class="line">    DevContext-&gt;DmaBufferVA = </span><br><span class="line">        WdfCommonBufferGetAlignedVirtualAddress(DevContext-&gt;DmaBuffer);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 5. ����DMA�Ĵ���</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_ADDR,</span><br><span class="line">        DevContext-&gt;DmaBufferPA.LowPart);</span><br><span class="line">        </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_ADDR_HIGH,</span><br><span class="line">        DevContext-&gt;DmaBufferPA.HighPart);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 6. ����DMA����</span></span><br><span class="line">    ULONG dmaCtrl = READ_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_CTRL);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (IsWrite) &#123;</span><br><span class="line">        dmaCtrl |= DMA_CTRL_WRITE;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dmaCtrl &amp;= ~DMA_CTRL_WRITE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_CTRL,</span><br><span class="line">        dmaCtrl);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="4-4-������ɴ���"><a href="#4-4-������ɴ���" class="headerlink" title="4.4 ������ɴ���"></a>4.4 ������ɴ���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">RtsPciCompleteTransfer</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ NTSTATUS Status</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDFREQUEST request;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ֹͣDMA</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_CTRL,</span><br><span class="line">        <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. ����DMA��Դ</span></span><br><span class="line">    <span class="keyword">if</span> (DevContext-&gt;DmaBuffer) &#123;</span><br><span class="line">        WdfObjectDelete(DevContext-&gt;DmaBuffer);</span><br><span class="line">        DevContext-&gt;DmaBuffer = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����ͳ����Ϣ</span></span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(Status)) &#123;</span><br><span class="line">        DevContext-&gt;TotalBytesTransferred.QuadPart += </span><br><span class="line">            DevContext-&gt;CurrentLength;</span><br><span class="line">        InterlockedIncrement(&amp;DevContext-&gt;TotalRequests);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        InterlockedIncrement(&amp;DevContext-&gt;ErrorCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �������</span></span><br><span class="line">    request = DevContext-&gt;CurrentRequest;</span><br><span class="line">    DevContext-&gt;CurrentRequest = <span class="literal">NULL</span>;</span><br><span class="line">    DevContext-&gt;TransferActive = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (request) &#123;</span><br><span class="line">        WdfRequestCompleteWithInformation(</span><br><span class="line">            request,</span><br><span class="line">            Status,</span><br><span class="line">            NT_SUCCESS(Status) ? DevContext-&gt;CurrentLength : <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ������һ������</span></span><br><span class="line">    RtsPciProcessNextRequest(DevContext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">RtsPciProcessNextRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDFREQUEST nextRequest;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    status = WdfIoQueueRetrieveNextRequest(</span><br><span class="line">        DevContext-&gt;IoQueue,</span><br><span class="line">        &amp;nextRequest);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="comment">// ������һ������</span></span><br><span class="line">        WDF_REQUEST_PARAMETERS params;</span><br><span class="line">        WDF_REQUEST_PARAMETERS_INIT(&amp;params);</span><br><span class="line">        WdfRequestGetParameters(nextRequest, &amp;params);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (params.Type == WdfRequestTypeRead) &#123;</span><br><span class="line">            RtsPciEvtIoRead(DevContext-&gt;IoQueue,</span><br><span class="line">                           nextRequest,</span><br><span class="line">                           params.Parameters.Read.Length);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            RtsPciEvtIoWrite(DevContext-&gt;IoQueue,</span><br><span class="line">                            nextRequest,</span><br><span class="line">                            params.Parameters.Write.Length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>[���� - ��һ���ֽ���ϸ�����жϴ����͵�Դ����]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-37"><a href="#User-37" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-37"><a href="#AI-claude-3-5-sonnet-37" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���жϴ����͵�Դ�������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-5"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-5" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 5"></a>WDF SD Host Controller����ʵ����� - Part 5</h1><h2 id="5-�жϴ���"><a href="#5-�жϴ���" class="headerlink" title="5. �жϴ���"></a>5. �жϴ���</h2><h3 id="5-1-ISRʵ��"><a href="#5-1-ISRʵ��" class="headerlink" title="5.1 ISRʵ��"></a>5.1 ISRʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN <span class="title function_">RtsPciEvtInterruptIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ ULONG MessageID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    ULONG intStatus, intEnable;</span><br><span class="line">    BOOLEAN handled = FALSE;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(WdfInterruptGetDevice(Interrupt));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ�ж�״̬</span></span><br><span class="line">    intStatus = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_STATUS);</span><br><span class="line">        </span><br><span class="line">    intEnable = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_ENABLE);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ֻ����ʹ�ܵ��ж�</span></span><br><span class="line">    intStatus &amp;= intEnable;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!intStatus) &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����ж�״̬</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_STATUS,</span><br><span class="line">        intStatus);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. ���������ж�</span></span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; CARD_DETECT_INT) &#123;</span><br><span class="line">        <span class="comment">// ������жϣ���Ҫ��DPC�д���</span></span><br><span class="line">        WdfInterruptQueueDpcForIsr(Interrupt);</span><br><span class="line">        handled = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; TRANSFER_COMPLETE_INT) &#123;</span><br><span class="line">        <span class="comment">// ��������ж�</span></span><br><span class="line">        <span class="keyword">if</span> (devContext-&gt;TransferActive) &#123;</span><br><span class="line">            <span class="comment">// ��DPC����ɴ���</span></span><br><span class="line">            WdfInterruptQueueDpcForIsr(Interrupt);</span><br><span class="line">            handled = TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; ERROR_INT) &#123;</span><br><span class="line">        <span class="comment">// �����ж�</span></span><br><span class="line">        devContext-&gt;LastError = READ_REGISTER_ULONG(</span><br><span class="line">            devContext-&gt;RegisterBase + HOST_ERROR_STATUS);</span><br><span class="line">        WdfInterruptQueueDpcForIsr(Interrupt);</span><br><span class="line">        handled = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="5-2-DPCʵ��"><a href="#5-2-DPCʵ��" class="headerlink" title="5.2 DPCʵ��"></a>5.2 DPCʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">RtsPciEvtInterruptDpc</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ WDFOBJECT Device</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    ULONG intStatus;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���¶�ȡ״̬(���������ж�)</span></span><br><span class="line">    intStatus = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_STATUS);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. ���������</span></span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; CARD_DETECT_INT) &#123;</span><br><span class="line">        BOOLEAN cardPresent = RtsPciIsCardPresent(devContext);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (cardPresent != devContext-&gt;CardPresent) &#123;</span><br><span class="line">            devContext-&gt;CardPresent = cardPresent;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (cardPresent) &#123;</span><br><span class="line">                <span class="comment">// �����룬��ʼ��ʼ��</span></span><br><span class="line">                RtsPciInitializeCard(devContext);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// ���Ƴ�������״̬</span></span><br><span class="line">                RtsPciHandleCardRemoval(devContext);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �����������</span></span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; TRANSFER_COMPLETE_INT) &#123;</span><br><span class="line">        <span class="keyword">if</span> (devContext-&gt;TransferActive) &#123;</span><br><span class="line">            <span class="comment">// ����Ƿ��д���</span></span><br><span class="line">            <span class="keyword">if</span> (intStatus &amp; ERROR_INT) &#123;</span><br><span class="line">                RtsPciCompleteTransfer(devContext, </span><br><span class="line">                    RtsPciHandleTransferError(devContext));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                RtsPciCompleteTransfer(devContext, STATUS_SUCCESS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ��������</span></span><br><span class="line">    <span class="keyword">if</span> (intStatus &amp; ERROR_INT) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!devContext-&gt;TransferActive) &#123;</span><br><span class="line">            <span class="comment">// �Ǵ������Ĵ���</span></span><br><span class="line">            RtsPciHandleNonTransferError(devContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">RtsPciHandleCardRemoval</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ȡ����ǰ����</span></span><br><span class="line">    <span class="keyword">if</span> (DevContext-&gt;CurrentRequest) &#123;</span><br><span class="line">        RtsPciCompleteTransfer(DevContext, STATUS_NO_MEDIA);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ȡ�������е�����</span></span><br><span class="line">    WdfIoQueuePurgeSynchronously(DevContext-&gt;IoQueue);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��λ������״̬</span></span><br><span class="line">    DevContext-&gt;CardPresent = FALSE;</span><br><span class="line">    DevContext-&gt;HighCapacity = FALSE;</span><br><span class="line">    DevContext-&gt;CardRCA = <span class="number">0</span>;</span><br><span class="line">    RtlZeroMemory(DevContext-&gt;CardCID, <span class="keyword">sizeof</span>(DevContext-&gt;CardCID));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ֪ͨPnP������</span></span><br><span class="line">    WdfDeviceSetFailed(DevContext-&gt;Device, </span><br><span class="line">                       WdfDeviceFailedNoRestart);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="6-��Դ����"><a href="#6-��Դ����" class="headerlink" title="6. ��Դ����"></a>6. ��Դ����</h2><h3 id="6-1-��Դ״̬ת��"><a href="#6-1-��Դ״̬ת��" class="headerlink" title="6.1 ��Դ״̬ת��"></a>6.1 ��Դ״̬ת��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceD0Entry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDF_POWER_DEVICE_STATE PreviousState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �ϵ�����</span></span><br><span class="line">    status = RtsPciPowerUpSequence(devContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ��������</span></span><br><span class="line">    status = RtsPciInitializeController(devContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��鲢��ʼ����</span></span><br><span class="line">    <span class="keyword">if</span> (RtsPciIsCardPresent(devContext)) &#123;</span><br><span class="line">        status = RtsPciInitializeCard(devContext);</span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            status = RtsPciConfigureCard(devContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����IO����</span></span><br><span class="line">    WdfIoQueueStart(devContext-&gt;IoQueue);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceD0Exit</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device,</span></span><br><span class="line"><span class="params">    _In_ WDF_POWER_DEVICE_STATE TargetState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ֹͣIO����</span></span><br><span class="line">    WdfIoQueueStop(devContext-&gt;IoQueue,</span><br><span class="line">                   <span class="literal">NULL</span>,</span><br><span class="line">                   <span class="literal">NULL</span>);</span><br><span class="line">                   </span><br><span class="line">    <span class="comment">// 2. ȡ������δ��ɵ�����</span></span><br><span class="line">    <span class="keyword">if</span> (devContext-&gt;CurrentRequest) &#123;</span><br><span class="line">        RtsPciCompleteTransfer(devContext, STATUS_CANCELLED);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �ر�ʱ��</span></span><br><span class="line">    RtsPciSetClock(devContext, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �رյ�Դ</span></span><br><span class="line">    RtsPciPowerDownSequence(devContext);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="6-2-���е�Դ����"><a href="#6-2-���е�Դ����" class="headerlink" title="6.2 ���е�Դ����"></a>6.2 ���е�Դ����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciConfigureIdleSettings</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    WDF_DEVICE_POWER_POLICY_IDLE_SETTINGS idleSettings;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���ÿ�������</span></span><br><span class="line">    WDF_DEVICE_POWER_POLICY_IDLE_SETTINGS_INIT(</span><br><span class="line">        &amp;idleSettings,</span><br><span class="line">        IdleCannotWakeFromS0);</span><br><span class="line">        </span><br><span class="line">    idleSettings.IdleTimeout = <span class="number">1000</span>; <span class="comment">// 1��</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ע����лص�</span></span><br><span class="line">    WDF_POWER_POLICY_EVENT_CALLBACKS callbacks;</span><br><span class="line">    WDF_POWER_POLICY_EVENT_CALLBACKS_INIT(&amp;callbacks);</span><br><span class="line">    </span><br><span class="line">    callbacks.EvtDeviceArmWakeFromS0 = RtsPciEvtDeviceArmWakeFromS0;</span><br><span class="line">    callbacks.EvtDeviceDisarmWakeFromS0 = RtsPciEvtDeviceDisarmWakeFromS0;</span><br><span class="line">    </span><br><span class="line">    status = WdfDeviceAssignS0IdleSettings(</span><br><span class="line">        DevContext-&gt;Device,</span><br><span class="line">        &amp;idleSettings);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceArmWakeFromS0</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ʹ�ܿ�����ж�</span></span><br><span class="line">    ULONG intEnable = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_ENABLE);</span><br><span class="line">        </span><br><span class="line">    intEnable |= CARD_DETECT_INT;</span><br><span class="line">    </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_ENABLE,</span><br><span class="line">        intEnable);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciEvtDeviceDisarmWakeFromS0</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFDEVICE Device</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(Device);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ÿ�����ж�</span></span><br><span class="line">    ULONG intEnable = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_ENABLE);</span><br><span class="line">        </span><br><span class="line">    intEnable &amp;= ~CARD_DETECT_INT;</span><br><span class="line">    </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_ENABLE,</span><br><span class="line">        intEnable);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>[���� - ��һ���ֽ���ϸ���ܵ���֧�ֺ������Ż�]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-38"><a href="#User-38" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>RtsPciInitializeCard���ʵ�ֵ�</p>
<h2 id="AI-claude-3-5-sonnet-38"><a href="#AI-claude-3-5-sonnet-38" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>������ϸչ��RtsPciInitializeCard������ʵ�֣�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SD����ʼ��״̬��</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">SD_INIT_STATE</span> &#123;</span></span><br><span class="line">    SD_INIT_IDLE = <span class="number">0</span>,</span><br><span class="line">    SD_INIT_READY,</span><br><span class="line">    SD_INIT_IDENT,</span><br><span class="line">    SD_INIT_STBY,</span><br><span class="line">    SD_INIT_TRAN,</span><br><span class="line">    SD_INIT_DATA</span><br><span class="line">&#125; SD_INIT_STATE;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    SD_COMMAND cmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    ULONG response;</span><br><span class="line">    BOOLEAN sdVer2 = FALSE;</span><br><span class="line">    SD_INIT_STATE cardState = SD_INIT_IDLE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��⿨��������</span></span><br><span class="line">    <span class="keyword">if</span> (!RtsPciIsCardPresent(DevContext)) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_NO_MEDIA;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �ϵ�����</span></span><br><span class="line">    status = RtsPciPowerUpSequence(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����CMD0(GO_IDLE_STATE) - ��λ��������״̬</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">0</span>, <span class="number">0</span>, SD_RESPONSE_NONE);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    cardState = SD_INIT_IDLE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����CMD8(SEND_IF_COND) - ����ѹ������</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">8</span>, <span class="number">0x1AA</span>, SD_RESPONSE_R7);</span><br><span class="line">    <span class="comment">// 0x1AA = (1)���ģʽ | (0xAA)���ģʽ</span></span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="comment">// �����Ӧ</span></span><br><span class="line">        <span class="keyword">if</span> ((cmd.Response[<span class="number">0</span>] &amp; <span class="number">0xFFF</span>) != <span class="number">0x1AA</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> STATUS_DEVICE_PROTOCOL_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        sdVer2 = TRUE;  <span class="comment">// SD 2.0����߰汾��</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����ACMD41(SD_SEND_OP_COND) - ��ʼ����</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SD_INIT_TIMEOUT_MS; i++) &#123;</span><br><span class="line">        <span class="comment">// �ȷ���CMD55(APP_CMD)</span></span><br><span class="line">        RtsPciInitCommand(&amp;cmd, <span class="number">55</span>, <span class="number">0</span>, SD_RESPONSE_R1);</span><br><span class="line">        status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����ACMD41</span></span><br><span class="line">        ULONG ocr = sdVer2 ? <span class="number">0x40FF8000</span> : <span class="number">0x00FF8000</span>;</span><br><span class="line">        <span class="comment">// 0x40000000 = HCS(High Capacity Support)</span></span><br><span class="line">        <span class="comment">// 0x00FF8000 = ��ѹ��Χ(2.7-3.6V)</span></span><br><span class="line">        RtsPciInitCommand(&amp;cmd, <span class="number">41</span>, ocr, SD_RESPONSE_R3);</span><br><span class="line">        status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        response = cmd.Response[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (response &amp; <span class="number">0x80000000</span>) &#123;  <span class="comment">// ������ɳ�ʼ��</span></span><br><span class="line">            DevContext-&gt;HighCapacity = (response &amp; <span class="number">0x40000000</span>) ? TRUE : FALSE;</span><br><span class="line">            cardState = SD_INIT_READY;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        KeStallExecutionProcessor(<span class="number">1000</span>);  <span class="comment">// 1ms�ӳ�</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (cardState != SD_INIT_READY) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_DEVICE_NOT_READY;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ����CMD2(ALL_SEND_CID) - ��ȡCID</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">2</span>, <span class="number">0</span>, SD_RESPONSE_R2);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    RtlCopyMemory(DevContext-&gt;CardCID, cmd.Response, <span class="number">16</span>);</span><br><span class="line">    cardState = SD_INIT_IDENT;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7. ����CMD3(SEND_RELATIVE_ADDR) - ��ȡRCA</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">3</span>, <span class="number">0</span>, SD_RESPONSE_R6);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    DevContext-&gt;CardRCA = cmd.Response[<span class="number">0</span>] &gt;&gt; <span class="number">16</span>;</span><br><span class="line">    cardState = SD_INIT_STBY;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 8. ����CMD9(SEND_CSD) - ��ȡCSD</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">9</span>, DevContext-&gt;CardRCA &lt;&lt; <span class="number">16</span>, SD_RESPONSE_R2);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    RtlCopyMemory(DevContext-&gt;CardCSD, cmd.Response, <span class="number">16</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����CSD��ȡ������Ϣ</span></span><br><span class="line">    status = RtsPciParseCSD(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 9. ����CMD7(SELECT_CARD) - ѡ��</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">7</span>, DevContext-&gt;CardRCA &lt;&lt; <span class="number">16</span>, SD_RESPONSE_R1b);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    cardState = SD_INIT_TRAN;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 10. ���ÿ���������</span></span><br><span class="line">    status = RtsPciSetCardParameters(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    cardState = SD_INIT_DATA;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 11. �����豸״̬</span></span><br><span class="line">    DevContext-&gt;CardPresent = TRUE;</span><br><span class="line">    DevContext-&gt;CardState = cardState;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����CSD�Ĵ�����ȡ������Ϣ</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciParseCSD</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    UCHAR csdVersion;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡCSD�汾</span></span><br><span class="line">    csdVersion = (DevContext-&gt;CardCSD[<span class="number">0</span>] &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (csdVersion == <span class="number">0</span>) &#123;  <span class="comment">// CSD Version 1.0</span></span><br><span class="line">        ULONG cSize, cSizeMult, readBlLen;</span><br><span class="line">        </span><br><span class="line">        readBlLen = DevContext-&gt;CardCSD[<span class="number">1</span>] &amp; <span class="number">0xF</span>;</span><br><span class="line">        cSize = ((DevContext-&gt;CardCSD[<span class="number">1</span>] &amp; <span class="number">0x3FF</span>) &lt;&lt; <span class="number">2</span>) |</span><br><span class="line">                ((DevContext-&gt;CardCSD[<span class="number">2</span>] &amp; <span class="number">0xC0000000</span>) &gt;&gt; <span class="number">30</span>);</span><br><span class="line">        cSizeMult = (DevContext-&gt;CardCSD[<span class="number">2</span>] &amp; <span class="number">0x00038000</span>) &gt;&gt; <span class="number">15</span>;</span><br><span class="line">        </span><br><span class="line">        DevContext-&gt;DiskSize.QuadPart = (ULONGLONG)(cSize + <span class="number">1</span>) *</span><br><span class="line">            (<span class="number">1ULL</span> &lt;&lt; (cSizeMult + <span class="number">2</span>)) *</span><br><span class="line">            (<span class="number">1ULL</span> &lt;&lt; readBlLen);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (csdVersion == <span class="number">1</span>) &#123;  <span class="comment">// CSD Version 2.0</span></span><br><span class="line">        ULONG cSize;</span><br><span class="line">        </span><br><span class="line">        cSize = ((DevContext-&gt;CardCSD[<span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">16</span>) |</span><br><span class="line">                ((DevContext-&gt;CardCSD[<span class="number">2</span>] &amp; <span class="number">0xFFFF0000</span>) &gt;&gt; <span class="number">16</span>);</span><br><span class="line">                </span><br><span class="line">        DevContext-&gt;DiskSize.QuadPart = (ULONGLONG)(cSize + <span class="number">1</span>) * <span class="number">512</span> * <span class="number">1024</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_DEVICE_PROTOCOL_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���ÿ���������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciSetCardParameters</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    SD_COMMAND cmd = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���ÿ��СΪ512�ֽ�</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">16</span>, <span class="number">512</span>, SD_RESPONSE_R1);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �������߿���Ϊ4λ</span></span><br><span class="line">    <span class="comment">// �ȷ���CMD55</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">55</span>, DevContext-&gt;CardRCA &lt;&lt; <span class="number">16</span>, SD_RESPONSE_R1);</span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ACMD6</span></span><br><span class="line">    RtsPciInitCommand(&amp;cmd, <span class="number">6</span>, <span class="number">2</span>, SD_RESPONSE_R1);  <span class="comment">// 2 = 4λģʽ</span></span><br><span class="line">    status = RtsPciSendCommand(DevContext, &amp;cmd);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����Host ControllerΪ4λģʽ</span></span><br><span class="line">    ULONG hostCtrl = READ_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CTRL_REG);</span><br><span class="line">    hostCtrl |= HOST_CTRL_4BIT;</span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CTRL_REG,</span><br><span class="line">        hostCtrl);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>���ʵ�ְ�����������SD����ʼ�����̣�</p>
<ol>
<li>��⿨��������</li>
<li>ִ���ϵ�����</li>
<li>����CMD0��λ��</li>
<li>����CMD8����ѹ������</li>
<li>����ACMD41��ʼ����</li>
<li>��ȡCID��Ϣ</li>
<li>��ȡRCA��ַ</li>
<li>��ȡCSD��Ϣ����������</li>
<li>ѡ��</li>
<li>���ù������������С�����߿��ȣ�</li>
</ol>
<p>ÿ�����趼����ϸ�Ĵ���������Ի��ƣ�ȷ����ʼ���Ŀɿ��ԡ�ͬʱͨ��״̬��׷�ٿ��ĳ�ʼ��״̬�����ڵ��Ժʹ���ָ���</p>
<h2 id="User-39"><a href="#User-39" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����ʼ����ɺ����֪ͨWDF��PNP�����豸</p>
<h2 id="AI-claude-3-5-sonnet-39"><a href="#AI-claude-3-5-sonnet-39" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��SD����ʼ����ɺ���Ҫ֪ͨϵͳ���µĴ洢�豸����������ϸʵ�֣�</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">RtsPciNotifyDeviceReady</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ע���豸�ӿ�</span></span><br><span class="line">    status = WdfDeviceCreateDeviceInterface(</span><br><span class="line">        DevContext-&gt;Device,</span><br><span class="line">        &amp;GUID_DEVINTERFACE_DISK,    <span class="comment">// ��׼�����豸�ӿ�GUID</span></span><br><span class="line">        <span class="literal">NULL</span>);                       <span class="comment">// �޲ο��ַ���</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        RtsPciDebugLog(</span><br><span class="line">            <span class="string">&quot;Failed to create device interface, status = 0x%08X\n&quot;</span>, </span><br><span class="line">            status);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����豸����</span></span><br><span class="line">    STORAGE_DEVICE_DESCRIPTOR deviceDesc = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    deviceDesc.Version = <span class="keyword">sizeof</span>(STORAGE_DEVICE_DESCRIPTOR);</span><br><span class="line">    deviceDesc.Size = <span class="keyword">sizeof</span>(STORAGE_DEVICE_DESCRIPTOR);</span><br><span class="line">    deviceDesc.DeviceType = FILE_DEVICE_DISK;</span><br><span class="line">    deviceDesc.DeviceTypeModifier = <span class="number">0</span>;</span><br><span class="line">    deviceDesc.RemovableMedia = TRUE;</span><br><span class="line">    deviceDesc.BusType = BusTypeSD;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��CID�л�ȡ���̺Ͳ�Ʒ��Ϣ</span></span><br><span class="line">    RtlCopyMemory(deviceDesc.VendorId, </span><br><span class="line">                  &amp;DevContext-&gt;CardCID[<span class="number">0</span>],</span><br><span class="line">                  <span class="number">8</span>);</span><br><span class="line">    RtlCopyMemory(deviceDesc.ProductId,</span><br><span class="line">                  &amp;DevContext-&gt;CardCID[<span class="number">8</span>],</span><br><span class="line">                  <span class="number">16</span>);</span><br><span class="line">                  </span><br><span class="line">    status = WdfDeviceSetDeviceDescriptor(</span><br><span class="line">        DevContext-&gt;Device,</span><br><span class="line">        &amp;deviceDesc);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �����豸����</span></span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES pnpCaps;</span><br><span class="line">    WDF_DEVICE_PNP_CAPABILITIES_INIT(&amp;pnpCaps);</span><br><span class="line">    pnpCaps.Removable = WdfTrue;</span><br><span class="line">    pnpCaps.EjectSupported = WdfTrue;</span><br><span class="line">    pnpCaps.SurpriseRemovalOK = WdfTrue;</span><br><span class="line">    pnpCaps.UniqueID = WdfTrue;</span><br><span class="line">    </span><br><span class="line">    WdfDeviceSetPnpCapabilities(DevContext-&gt;Device, &amp;pnpCaps);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���õ�Դ����</span></span><br><span class="line">    WDF_DEVICE_POWER_CAPABILITIES powerCaps;</span><br><span class="line">    WDF_DEVICE_POWER_CAPABILITIES_INIT(&amp;powerCaps);</span><br><span class="line">    powerCaps.DeviceD1 = WdfTrue;</span><br><span class="line">    powerCaps.WakeFromD1 = WdfTrue;</span><br><span class="line">    powerCaps.DeviceState[PowerSystemWorking] = PowerDeviceD0;</span><br><span class="line">    powerCaps.DeviceState[PowerSystemSleeping1] = PowerDeviceD1;</span><br><span class="line">    powerCaps.DeviceState[PowerSystemSleeping2] = PowerDeviceD3;</span><br><span class="line">    powerCaps.DeviceState[PowerSystemSleeping3] = PowerDeviceD3;</span><br><span class="line">    powerCaps.DeviceState[PowerSystemHibernate] = PowerDeviceD3;</span><br><span class="line">    powerCaps.DeviceState[PowerSystemShutdown] = PowerDeviceD3;</span><br><span class="line">    </span><br><span class="line">    WdfDeviceSetPowerCapabilities(DevContext-&gt;Device, &amp;powerCaps);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. �޸��豸״̬Ϊ����</span></span><br><span class="line">    status = WdfDeviceSetDeviceState(</span><br><span class="line">        DevContext-&gt;Device,</span><br><span class="line">        WdfDeviceStateStarted);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ������������(��ѡ)</span></span><br><span class="line">    DECLARE_CONST_UNICODE_STRING(symbolicLinkName, </span><br><span class="line">        <span class="string">L&quot;\\DosDevices\\SDCard&quot;</span>);</span><br><span class="line">    status = WdfDeviceCreateSymbolicLink(</span><br><span class="line">        DevContext-&gt;Device,</span><br><span class="line">        &amp;symbolicLinkName);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 7. ����IO����</span></span><br><span class="line">    status = WdfIoQueueStart(DevContext-&gt;IoQueue);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 8. ֪ͨPnP�������豸�Ѿ���</span></span><br><span class="line">    IoInvalidateDeviceRelations(</span><br><span class="line">        WdfDeviceWdmGetPhysicalDevice(DevContext-&gt;Device),</span><br><span class="line">        BusRelations);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �ڿ���ʼ����ɺ����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeCard</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... ǰ���ǿ��ĳ�ʼ������ ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ���ɹ���֪ͨϵͳ</span></span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="comment">// �����豸״̬</span></span><br><span class="line">        DevContext-&gt;CardPresent = TRUE;</span><br><span class="line">        DevContext-&gt;CardState = SD_INIT_DATA;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ֪ͨϵͳ���豸����</span></span><br><span class="line">        status = RtsPciNotifyDeviceReady(DevContext);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            RtsPciDebugLog(<span class="string">&quot;SD Card initialized successfully\n&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ��¼�豸��Ϣ</span></span><br><span class="line">            RtsPciLogDeviceInfo(DevContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��¼�豸��Ϣ(���ڵ���)</span></span><br><span class="line">VOID <span class="title function_">RtsPciLogDeviceInfo</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    RtsPciDebugLog(<span class="string">&quot;SD Card Information:\n&quot;</span>);</span><br><span class="line">    RtsPciDebugLog(<span class="string">&quot;  Capacity: %I64d bytes\n&quot;</span>, </span><br><span class="line">        DevContext-&gt;DiskSize.QuadPart);</span><br><span class="line">    RtsPciDebugLog(<span class="string">&quot;  High Capacity: %s\n&quot;</span>, </span><br><span class="line">        DevContext-&gt;HighCapacity ? <span class="string">&quot;Yes&quot;</span> : <span class="string">&quot;No&quot;</span>);</span><br><span class="line">    RtsPciDebugLog(<span class="string">&quot;  Manufacturer ID: %.8s\n&quot;</span>, </span><br><span class="line">        DevContext-&gt;CardCID);</span><br><span class="line">    RtsPciDebugLog(<span class="string">&quot;  Product Name: %.16s\n&quot;</span>, </span><br><span class="line">        &amp;DevContext-&gt;CardCID[<span class="number">8</span>]);</span><br><span class="line">    RtsPciDebugLog(<span class="string">&quot;  RCA: 0x%04X\n&quot;</span>, </span><br><span class="line">        DevContext-&gt;CardRCA);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>֪ͨ����˵����</p>
<ol>
<li><p><strong>�豸�ӿ�ע��</strong></p>
<ul>
<li>ע���׼�����豸�ӿ�</li>
<li>�����ϲ�������Ӧ�ó������豸</li>
</ul>
</li>
<li><p><strong>�豸����������</strong></p>
<ul>
<li>�����豸����Ϊ����</li>
<li>�����豸���ԣ����ƶ��ȣ�</li>
<li>���ó��̺Ͳ�Ʒ��Ϣ</li>
</ul>
</li>
<li><p><strong>PnP��������</strong></p>
<ul>
<li>�����豸Ϊ���ƶ�</li>
<li>֧�ֵ���</li>
<li>֧���Ȳ��</li>
</ul>
</li>
<li><p><strong>��Դ��������</strong></p>
<ul>
<li>����֧�ֵĵ�Դ״̬</li>
<li>���û�������</li>
</ul>
</li>
<li><p><strong>�豸״̬����</strong></p>
<ul>
<li>���豸״̬����Ϊ������</li>
<li>�����������ӣ���ѡ��</li>
</ul>
</li>
<li><p><strong>IO��������</strong></p>
<ul>
<li>�����������</li>
<li>׼������IO����</li>
</ul>
</li>
<li><p><strong>PnP֪ͨ</strong></p>
<ul>
<li>֪ͨPnP�������豸��ϵ�仯</li>
<li>����ϵͳ����ö���豸</li>
</ul>
</li>
</ol>
<p>������ϵͳ�ͻ�ʶ���µĴ洢�豸����������Ӧ���ϲ���������������������ļ�ϵͳ�ȣ���</p>
<h2 id="User-40"><a href="#User-40" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-40"><a href="#AI-claude-3-5-sonnet-40" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ������֧�ֺ������Ż����֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-6"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-6" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 6"></a>WDF SD Host Controller����ʵ����� - Part 6</h1><h2 id="7-����֧��"><a href="#7-����֧��" class="headerlink" title="7. ����֧��"></a>7. ����֧��</h2><h3 id="7-1-WPP����ʵ��"><a href="#7-1-WPP����ʵ��" class="headerlink" title="7.1 WPP����ʵ��"></a>7.1 WPP����ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. ������ٱ�־</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WPP_CONTROL_GUIDS \</span></span><br><span class="line"><span class="meta">    WPP_DEFINE_CONTROL_GUID( \</span></span><br><span class="line"><span class="meta">        RtsPciTraceGuid, \</span></span><br><span class="line"><span class="meta">        (3B2A17E1,91A2,4B2A,A2F3,A324D3B97F12), \</span></span><br><span class="line"><span class="meta">        WPP_DEFINE_BIT(DBG_INIT)     <span class="comment">/* ��ʼ����� */</span> \</span></span><br><span class="line"><span class="meta">        WPP_DEFINE_BIT(DBG_PNP)      <span class="comment">/* ���弴�� */</span> \</span></span><br><span class="line"><span class="meta">        WPP_DEFINE_BIT(DBG_POWER)    <span class="comment">/* ��Դ���� */</span> \</span></span><br><span class="line"><span class="meta">        WPP_DEFINE_BIT(DBG_IOCTL)    <span class="comment">/* IO���� */</span> \</span></span><br><span class="line"><span class="meta">        WPP_DEFINE_BIT(DBG_READ)     <span class="comment">/* ������ */</span> \</span></span><br><span class="line"><span class="meta">        WPP_DEFINE_BIT(DBG_WRITE)    <span class="comment">/* д���� */</span> \</span></span><br><span class="line"><span class="meta">        WPP_DEFINE_BIT(DBG_DMA)      <span class="comment">/* DMA���� */</span> \</span></span><br><span class="line"><span class="meta">        WPP_DEFINE_BIT(DBG_INT)      <span class="comment">/* �жϴ��� */</span> \</span></span><br><span class="line"><span class="meta">        WPP_DEFINE_BIT(DBG_ERROR)    <span class="comment">/* ������ */</span> \</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ������ٺ���</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WPP_LEVEL_FLAGS_LOGGER(level,flags) WPP_LEVEL_LOGGER(flags)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WPP_LEVEL_FLAGS_ENABLED(level,flags) \</span></span><br><span class="line"><span class="meta">    (WPP_LEVEL_ENABLED(flags) &amp;&amp; WPP_CONTROL(WPP_BIT_ ## flags).Level &gt;= level)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. ʵ�ָ��ٺ�</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TracePrint(level,flags,msg,...) \</span></span><br><span class="line"><span class="meta">    WPP_LEVEL_FLAGS_LOGGER(level,flags) ( \</span></span><br><span class="line"><span class="meta">        WPP_LEVEL_FLAGS_ENABLED(level,flags) ? \</span></span><br><span class="line"><span class="meta">            WPP_LEVEL_FLAGS_LOGGER(level,flags)(flags,msg,__VA_ARGS__) : 0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. ���ٺ���ʵ��</span></span><br><span class="line">VOID <span class="title function_">RtsPciTraceInit</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;Initializing device 0x%p\n&quot;</span>, DevContext-&gt;Device);</span><br><span class="line">        </span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;Register base: 0x%p, Length: %d\n&quot;</span>,</span><br><span class="line">        DevContext-&gt;RegisterBase,</span><br><span class="line">        DevContext-&gt;RegisterLength);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">RtsPciTraceCommand</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PSD_COMMAND Cmd</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_IOCTL,</span><br><span class="line">        <span class="string">&quot;Sending CMD%d, Arg=0x%08X, Resp=%d\n&quot;</span>,</span><br><span class="line">        Cmd-&gt;Index, Cmd-&gt;Argument, Cmd-&gt;ResponseType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">RtsPciTraceError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ NTSTATUS Status,</span></span><br><span class="line"><span class="params">    _In_ PCSTR Function,</span></span><br><span class="line"><span class="params">    _In_ ULONG Line</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    TracePrint(TRACE_LEVEL_ERROR, DBG_ERROR,</span><br><span class="line">        <span class="string">&quot;%s:%d - Error 0x%08X\n&quot;</span>,</span><br><span class="line">        Function, Line, Status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="7-2-���ܼ�����ʵ��"><a href="#7-2-���ܼ�����ʵ��" class="headerlink" title="7.2 ���ܼ�����ʵ��"></a>7.2 ���ܼ�����ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. ���ܼ������ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">RTSPC_PERFORMANCE_DATA</span> &#123;</span></span><br><span class="line">    <span class="comment">// ����ͳ��</span></span><br><span class="line">    LARGE_INTEGER TotalBytesRead;</span><br><span class="line">    LARGE_INTEGER TotalBytesWritten;</span><br><span class="line">    ULONG TotalReadsCompleted;</span><br><span class="line">    ULONG TotalWritesCompleted;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ͳ��</span></span><br><span class="line">    ULONG CommandErrors;</span><br><span class="line">    ULONG DataErrors;</span><br><span class="line">    ULONG CrcErrors;</span><br><span class="line">    ULONG TimeoutErrors;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">    LARGE_INTEGER TotalReadTime;      <span class="comment">// 100ns��λ</span></span><br><span class="line">    LARGE_INTEGER TotalWriteTime;</span><br><span class="line">    ULONG MaxReadLatency;            <span class="comment">// ����</span></span><br><span class="line">    ULONG MaxWriteLatency;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMAͳ��</span></span><br><span class="line">    ULONG DmaTransfersCompleted;</span><br><span class="line">    ULONG DmaErrors;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ж�ͳ��</span></span><br><span class="line">    ULONG InterruptsServiced;</span><br><span class="line">    ULONG DpcQueued;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դͳ��</span></span><br><span class="line">    ULONG D0Transitions;</span><br><span class="line">    ULONG D1Transitions;</span><br><span class="line">    ULONG D2Transitions;</span><br><span class="line">    ULONG D3Transitions;</span><br><span class="line">&#125; RTSPC_PERFORMANCE_DATA, *PRTSPC_PERFORMANCE_DATA;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ���������ռ�</span></span><br><span class="line">VOID <span class="title function_">RtsPciUpdatePerformanceData</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ BOOLEAN IsRead,</span></span><br><span class="line"><span class="params">    _In_ ULONG Length,</span></span><br><span class="line"><span class="params">    _In_ LARGE_INTEGER StartTime,</span></span><br><span class="line"><span class="params">    _In_ LARGE_INTEGER EndTime</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    LARGE_INTEGER timeDiff;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡ������������������</span></span><br><span class="line">    KeAcquireSpinLock(&amp;DevContext-&gt;PerfLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (IsRead) &#123;</span><br><span class="line">        DevContext-&gt;PerfData.TotalBytesRead.QuadPart += Length;</span><br><span class="line">        DevContext-&gt;PerfData.TotalReadsCompleted++;</span><br><span class="line">        </span><br><span class="line">        timeDiff.QuadPart = EndTime.QuadPart - StartTime.QuadPart;</span><br><span class="line">        DevContext-&gt;PerfData.TotalReadTime.QuadPart += timeDiff.QuadPart;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ��������ӳ�</span></span><br><span class="line">        ULONG latencyMs = (ULONG)(timeDiff.QuadPart / <span class="number">10000</span>); <span class="comment">// ת��Ϊ����</span></span><br><span class="line">        <span class="keyword">if</span> (latencyMs &gt; DevContext-&gt;PerfData.MaxReadLatency) &#123;</span><br><span class="line">            DevContext-&gt;PerfData.MaxReadLatency = latencyMs;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        DevContext-&gt;PerfData.TotalBytesWritten.QuadPart += Length;</span><br><span class="line">        DevContext-&gt;PerfData.TotalWritesCompleted++;</span><br><span class="line">        </span><br><span class="line">        timeDiff.QuadPart = EndTime.QuadPart - StartTime.QuadPart;</span><br><span class="line">        DevContext-&gt;PerfData.TotalWriteTime.QuadPart += timeDiff.QuadPart;</span><br><span class="line">        </span><br><span class="line">        ULONG latencyMs = (ULONG)(timeDiff.QuadPart / <span class="number">10000</span>);</span><br><span class="line">        <span class="keyword">if</span> (latencyMs &gt; DevContext-&gt;PerfData.MaxWriteLatency) &#123;</span><br><span class="line">            DevContext-&gt;PerfData.MaxWriteLatency = latencyMs;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;DevContext-&gt;PerfLock, oldIrql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. �������ݲ�ѯ�ӿ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciGetPerformanceData</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _Out_ PRTSPC_PERFORMANCE_DATA PerfData</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    KeAcquireSpinLock(&amp;DevContext-&gt;PerfLock, &amp;oldIrql);</span><br><span class="line">    RtlCopyMemory(PerfData, &amp;DevContext-&gt;PerfData, </span><br><span class="line">                  <span class="keyword">sizeof</span>(RTSPC_PERFORMANCE_DATA));</span><br><span class="line">    KeReleaseSpinLock(&amp;DevContext-&gt;PerfLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. ���ܼ��IOCTL����</span></span><br><span class="line">VOID <span class="title function_">RtsPciHandlePerformanceQuery</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PRTSPC_PERFORMANCE_DATA perfData;</span><br><span class="line">    <span class="type">size_t</span> bufferSize;</span><br><span class="line">    </span><br><span class="line">    status = WdfRequestRetrieveOutputBuffer(Request,</span><br><span class="line">                                          <span class="keyword">sizeof</span>(RTSPC_PERFORMANCE_DATA),</span><br><span class="line">                                          &amp;perfData,</span><br><span class="line">                                          &amp;bufferSize);</span><br><span class="line">                                          </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        WdfRequestComplete(Request, status);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    status = RtsPciGetPerformanceData(DevContext, perfData);</span><br><span class="line">    </span><br><span class="line">    WdfRequestCompleteWithInformation(Request,</span><br><span class="line">                                    status,</span><br><span class="line">                                    <span class="keyword">sizeof</span>(RTSPC_PERFORMANCE_DATA));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="7-3-��Ͻӿ�ʵ��"><a href="#7-3-��Ͻӿ�ʵ��" class="headerlink" title="7.3 ��Ͻӿ�ʵ��"></a>7.3 ��Ͻӿ�ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. ��������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">RTSPC_DIAGNOSTIC_COMMAND</span> &#123;</span></span><br><span class="line">    DiagCommandDumpRegisters = <span class="number">0</span>,</span><br><span class="line">    DiagCommandTestDMA,</span><br><span class="line">    DiagCommandResetController,</span><br><span class="line">    DiagCommandToggleDebug,</span><br><span class="line">    DiagCommandClearStats</span><br><span class="line">&#125; RTSPC_DIAGNOSTIC_COMMAND;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. �Ĵ���ת��ʵ��</span></span><br><span class="line">VOID <span class="title function_">RtsPciDumpRegisters</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;=== Register Dump ===\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;HOST_CTRL:     0x%08X\n&quot;</span>,</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_CTRL_REG));</span><br><span class="line">        </span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;INT_STATUS:    0x%08X\n&quot;</span>,</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_INT_STATUS));</span><br><span class="line">        </span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;INT_ENABLE:    0x%08X\n&quot;</span>,</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_INT_ENABLE));</span><br><span class="line">        </span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;CLOCK_CTRL:    0x%08X\n&quot;</span>,</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_CLOCK_CTRL));</span><br><span class="line">        </span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;DMA_ADDR:      0x%08X\n&quot;</span>,</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_DMA_ADDR));</span><br><span class="line">        </span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;BLOCK_SIZE:    0x%08X\n&quot;</span>,</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_BLOCK_SIZE));</span><br><span class="line">        </span><br><span class="line">    TracePrint(TRACE_LEVEL_INFORMATION, DBG_INIT,</span><br><span class="line">        <span class="string">&quot;BLOCK_COUNT:   0x%08X\n&quot;</span>,</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_BLOCK_COUNT));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. DMA����ʵ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciTestDMA</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PVOID testBuffer;</span><br><span class="line">    PHYSICAL_ADDRESS testBufferPA;</span><br><span class="line">    ULONG testPattern = <span class="number">0xA5A5A5A5</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������Ի�����</span></span><br><span class="line">    testBuffer = MmAllocateContiguousMemory(</span><br><span class="line">        PAGE_SIZE,</span><br><span class="line">        DevContext-&gt;DmaBufferPA);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!testBuffer) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������ģʽ</span></span><br><span class="line">    RtlFillMemory(testBuffer, PAGE_SIZE, testPattern);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ִ��DMA����</span></span><br><span class="line">    testBufferPA = MmGetPhysicalAddress(testBuffer);</span><br><span class="line">    </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_ADDR,</span><br><span class="line">        testBufferPA.LowPart);</span><br><span class="line">        </span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_ADDR_HIGH,</span><br><span class="line">        testBufferPA.HighPart);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ����DMA����</span></span><br><span class="line">    status = RtsPciStartDmaTest(DevContext);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����</span></span><br><span class="line">    MmFreeContiguousMemory(testBuffer);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. ��������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleDiagnosticCommand</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ RTSPC_DIAGNOSTIC_COMMAND Command</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (Command) &#123;</span><br><span class="line">        <span class="keyword">case</span> DiagCommandDumpRegisters:</span><br><span class="line">            RtsPciDumpRegisters(DevContext);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DiagCommandTestDMA:</span><br><span class="line">            status = RtsPciTestDMA(DevContext);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DiagCommandResetController:</span><br><span class="line">            status = RtsPciResetController(DevContext);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DiagCommandToggleDebug:</span><br><span class="line">            DevContext-&gt;DebugFlags ^= <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DiagCommandClearStats:</span><br><span class="line">            RtlZeroMemory(&amp;DevContext-&gt;PerfData,</span><br><span class="line">                         <span class="keyword">sizeof</span>(RTSPC_PERFORMANCE_DATA));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            status = STATUS_INVALID_PARAMETER;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[���� - ��һ���ֽ���ϸ���ܴ������ͻָ�����]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-41"><a href="#User-41" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-41"><a href="#AI-claude-3-5-sonnet-41" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���������ͻָ����Ʋ��֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-7"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-7" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 7"></a>WDF SD Host Controller����ʵ����� - Part 7</h1><h2 id="8-�������ͻָ�����"><a href="#8-�������ͻָ�����" class="headerlink" title="8. �������ͻָ�����"></a>8. �������ͻָ�����</h2><h3 id="8-1-�������Ͷ���ʹ���"><a href="#8-1-�������Ͷ���ʹ���" class="headerlink" title="8.1 �������Ͷ���ʹ���"></a>8.1 �������Ͷ���ʹ���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �������Ͷ���</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">RTSPC_ERROR_TYPE</span> &#123;</span></span><br><span class="line">    ErrorTypeCommand = <span class="number">0</span>,    <span class="comment">// �������</span></span><br><span class="line">    ErrorTypeData,           <span class="comment">// ���ݴ���</span></span><br><span class="line">    ErrorTypeDMA,           <span class="comment">// DMA����</span></span><br><span class="line">    ErrorTypeTimeout,        <span class="comment">// ��ʱ����</span></span><br><span class="line">    ErrorTypeCRC,           <span class="comment">// CRC����</span></span><br><span class="line">    ErrorTypeHardware,      <span class="comment">// Ӳ������</span></span><br><span class="line">    ErrorTypeProtocol       <span class="comment">// Э�����</span></span><br><span class="line">&#125; RTSPC_ERROR_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ������������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ERROR_HANDLING_CONTEXT</span> &#123;</span></span><br><span class="line">    RTSPC_ERROR_TYPE ErrorType;</span><br><span class="line">    ULONG ErrorStatus;</span><br><span class="line">    ULONG RetryCount;</span><br><span class="line">    BOOLEAN NeedsReset;</span><br><span class="line">    LARGE_INTEGER ErrorTime;</span><br><span class="line">    NTSTATUS LastStatus;</span><br><span class="line">&#125; ERROR_HANDLING_CONTEXT, *PERROR_HANDLING_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ������������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ RTSPC_ERROR_TYPE ErrorType,</span></span><br><span class="line"><span class="params">    _In_ ULONG ErrorStatus</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    ERROR_HANDLING_CONTEXT errorCtx = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ������������</span></span><br><span class="line">    errorCtx.ErrorType = ErrorType;</span><br><span class="line">    errorCtx.ErrorStatus = ErrorStatus;</span><br><span class="line">    KeQuerySystemTime(&amp;errorCtx.ErrorTime);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��¼������־</span></span><br><span class="line">    RtsPciLogError(DevContext, &amp;errorCtx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ݴ������ʹ���</span></span><br><span class="line">    <span class="keyword">switch</span> (ErrorType) &#123;</span><br><span class="line">        <span class="keyword">case</span> ErrorTypeCommand:</span><br><span class="line">            status = RtsPciHandleCommandError(DevContext, &amp;errorCtx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ErrorTypeData:</span><br><span class="line">            status = RtsPciHandleDataError(DevContext, &amp;errorCtx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ErrorTypeDMA:</span><br><span class="line">            status = RtsPciHandleDMAError(DevContext, &amp;errorCtx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ErrorTypeTimeout:</span><br><span class="line">            status = RtsPciHandleTimeoutError(DevContext, &amp;errorCtx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ErrorTypeCRC:</span><br><span class="line">            status = RtsPciHandleCRCError(DevContext, &amp;errorCtx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ErrorTypeHardware:</span><br><span class="line">            status = RtsPciHandleHardwareError(DevContext, &amp;errorCtx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            status = STATUS_DEVICE_PROTOCOL_ERROR;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���´���ͳ��</span></span><br><span class="line">    InterlockedIncrement(&amp;DevContext-&gt;PerfData.ErrorCount);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-���������ʵ��"><a href="#8-2-���������ʵ��" class="headerlink" title="8.2 ���������ʵ��"></a>8.2 ���������ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ���������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleCommandError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PERROR_HANDLING_CONTEXT ErrorCtx</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��λ������</span></span><br><span class="line">    status = RtsPciResetCommandLine(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����Ƿ���Ҫ����</span></span><br><span class="line">    <span class="keyword">if</span> (ErrorCtx-&gt;RetryCount &lt; MAX_CMD_RETRY_COUNT) &#123;</span><br><span class="line">        ErrorCtx-&gt;RetryCount++;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ���·�������</span></span><br><span class="line">        <span class="keyword">if</span> (DevContext-&gt;CurrentCommand) &#123;</span><br><span class="line">            status = RtsPciSendCommand(DevContext, </span><br><span class="line">                                     DevContext-&gt;CurrentCommand);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        status = STATUS_DEVICE_PROTOCOL_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DMA������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleDMAError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PERROR_HANDLING_CONTEXT ErrorCtx</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ֹͣDMA����</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_DMA_CTRL,</span><br><span class="line">        <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. ��λDMA������</span></span><br><span class="line">    status = RtsPciResetDMA(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��������DMA</span></span><br><span class="line">    <span class="keyword">if</span> (DevContext-&gt;CurrentRequest) &#123;</span><br><span class="line">        status = RtsPciSetupDmaForRequest(</span><br><span class="line">            DevContext,</span><br><span class="line">            DevContext-&gt;CurrentRequest,</span><br><span class="line">            DevContext-&gt;CurrentTransferIsWrite);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʱ������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleTimeoutError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PERROR_HANDLING_CONTEXT ErrorCtx</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��鿨�Ƿ���</span></span><br><span class="line">    <span class="keyword">if</span> (!RtsPciIsCardPresent(DevContext)) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_NO_MEDIA;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��λ������</span></span><br><span class="line">    status = RtsPciResetController(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���³�ʼ����</span></span><br><span class="line">    status = RtsPciInitializeCard(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���Ե�ǰ����</span></span><br><span class="line">    <span class="keyword">if</span> (DevContext-&gt;CurrentRequest) &#123;</span><br><span class="line">        status = RtsPciRetryCurrentRequest(DevContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-3-�ָ�����ʵ��"><a href="#8-3-�ָ�����ʵ��" class="headerlink" title="8.3 �ָ�����ʵ��"></a>8.3 �ָ�����ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��������λ</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciResetController</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    ULONG controlReg;</span><br><span class="line">    LARGE_INTEGER timeout;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����λ������</span></span><br><span class="line">    controlReg = READ_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CTRL_REG);</span><br><span class="line">    controlReg |= HOST_CTRL_RESET;</span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_CTRL_REG,</span><br><span class="line">        controlReg);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. �ȴ���λ���</span></span><br><span class="line">    KeQuerySystemTime(&amp;timeout);</span><br><span class="line">    timeout.QuadPart += (<span class="number">1</span> * <span class="number">1000</span> * <span class="number">10000</span>); <span class="comment">// 1��</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        controlReg = READ_REGISTER_ULONG(</span><br><span class="line">            DevContext-&gt;RegisterBase + HOST_CTRL_REG);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (!(controlReg &amp; HOST_CTRL_RESET)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        KeStallExecutionProcessor(<span class="number">100</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (KeQuerySystemTime(&amp;timeout) &lt; <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (controlReg &amp; HOST_CTRL_RESET) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_DEVICE_HARDWARE_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �ָ�����������</span></span><br><span class="line">    status = RtsPciInitializeController(DevContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �������Ի���</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciRetryCurrentRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_REQUEST_PARAMETERS params;</span><br><span class="line">    LARGE_INTEGER offset;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!DevContext-&gt;CurrentRequest) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ�������</span></span><br><span class="line">    WDF_REQUEST_PARAMETERS_INIT(&amp;params);</span><br><span class="line">    WdfRequestGetParameters(DevContext-&gt;CurrentRequest, &amp;params);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (params.Type == WdfRequestTypeRead) &#123;</span><br><span class="line">        offset.QuadPart = params.Parameters.Read.DeviceOffset;</span><br><span class="line">        status = RtsPciPrepareTransfer(</span><br><span class="line">            DevContext,</span><br><span class="line">            DevContext-&gt;CurrentRequest,</span><br><span class="line">            offset.QuadPart / DevContext-&gt;BlockSize,</span><br><span class="line">            params.Parameters.Read.Length / DevContext-&gt;BlockSize,</span><br><span class="line">            FALSE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        offset.QuadPart = params.Parameters.Write.DeviceOffset;</span><br><span class="line">        status = RtsPciPrepareTransfer(</span><br><span class="line">            DevContext,</span><br><span class="line">            DevContext-&gt;CurrentRequest,</span><br><span class="line">            offset.QuadPart / DevContext-&gt;BlockSize,</span><br><span class="line">            params.Parameters.Write.Length / DevContext-&gt;BlockSize,</span><br><span class="line">            TRUE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-4-����ָ�����"><a href="#8-4-����ָ�����" class="headerlink" title="8.4 ����ָ�����"></a>8.4 ����ָ�����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ����ָ����Զ���</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ERROR_RECOVERY_POLICY</span> &#123;</span></span><br><span class="line">    ULONG MaxCommandRetries;</span><br><span class="line">    ULONG MaxDataRetries;</span><br><span class="line">    ULONG MaxDMARetries;</span><br><span class="line">    BOOLEAN ResetOnTimeout;</span><br><span class="line">    BOOLEAN ReInitOnHardwareError;</span><br><span class="line">    ULONG MinRetryDelayMs;</span><br><span class="line">&#125; ERROR_RECOVERY_POLICY, *PERROR_RECOVERY_POLICY;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����ָ�����ʵ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciExecuteRecoveryPolicy</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PERROR_HANDLING_CONTEXT ErrorCtx</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    ERROR_RECOVERY_POLICY policy = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ�ָ�����</span></span><br><span class="line">    RtsPciGetRecoveryPolicy(DevContext, &amp;policy);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ������Դ���</span></span><br><span class="line">    <span class="keyword">switch</span> (ErrorCtx-&gt;ErrorType) &#123;</span><br><span class="line">        <span class="keyword">case</span> ErrorTypeCommand:</span><br><span class="line">            <span class="keyword">if</span> (ErrorCtx-&gt;RetryCount &lt; policy.MaxCommandRetries) &#123;</span><br><span class="line">                <span class="comment">// �ӳٺ�����</span></span><br><span class="line">                KeStallExecutionProcessor(</span><br><span class="line">                    policy.MinRetryDelayMs * <span class="number">1000</span>);</span><br><span class="line">                status = RtsPciRetryCurrentRequest(DevContext);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ErrorTypeTimeout:</span><br><span class="line">            <span class="keyword">if</span> (policy.ResetOnTimeout) &#123;</span><br><span class="line">                status = RtsPciResetController(DevContext);</span><br><span class="line">                <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">                    status = RtsPciRetryCurrentRequest(DevContext);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ErrorTypeHardware:</span><br><span class="line">            <span class="keyword">if</span> (policy.ReInitOnHardwareError) &#123;</span><br><span class="line">                status = RtsPciReInitializeDevice(DevContext);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[���� - ��һ���ֽ���ϸ�����豸״̬��غ�ά��]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-42"><a href="#User-42" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-42"><a href="#AI-claude-3-5-sonnet-42" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���豸״̬��غ�ά�����֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-8"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-8" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 8"></a>WDF SD Host Controller����ʵ����� - Part 8</h1><h2 id="9-�豸״̬��غ�ά��"><a href="#9-�豸״̬��غ�ά��" class="headerlink" title="9. �豸״̬��غ�ά��"></a>9. �豸״̬��غ�ά��</h2><h3 id="9-1-�豸״̬����͹���"><a href="#9-1-�豸״̬����͹���" class="headerlink" title="9.1 �豸״̬����͹���"></a>9.1 �豸״̬����͹���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �豸״̬����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">DEVICE_STATE</span> &#123;</span></span><br><span class="line">    DeviceStateUninitialized = <span class="number">0</span>,</span><br><span class="line">    DeviceStateInitializing,</span><br><span class="line">    DeviceStateRunning,</span><br><span class="line">    DeviceStatePaused,</span><br><span class="line">    DeviceStateStopped,</span><br><span class="line">    DeviceStateRemoved,</span><br><span class="line">    DeviceStateFailed</span><br><span class="line">&#125; DEVICE_STATE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �豸����״̬</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_HEALTH_INFO</span> &#123;</span></span><br><span class="line">    DEVICE_STATE CurrentState;</span><br><span class="line">    ULONG OperationalTime;          <span class="comment">// ����ʱ��(��)</span></span><br><span class="line">    ULONG Temperature;              <span class="comment">// �¶�</span></span><br><span class="line">    ULONG VoltageLevel;            <span class="comment">// ��ѹ����</span></span><br><span class="line">    ULONG ErrorCount;              <span class="comment">// �������</span></span><br><span class="line">    BOOLEAN IsOverheated;          <span class="comment">// ���ȱ�־</span></span><br><span class="line">    BOOLEAN IsVoltageLow;          <span class="comment">// ��ѹ�ͱ�־</span></span><br><span class="line">    LARGE_INTEGER LastCheckTime;    <span class="comment">// �ϴμ��ʱ��</span></span><br><span class="line">&#125; DEVICE_HEALTH_INFO, *PDEVICE_HEALTH_INFO;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �豸״̬������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_STATE_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    DEVICE_STATE CurrentState;</span><br><span class="line">    DEVICE_HEALTH_INFO HealthInfo;</span><br><span class="line">    WDFTIMER HealthCheckTimer;</span><br><span class="line">    KEVENT StateChangeEvent;</span><br><span class="line">    KSPIN_LOCK StateLock;</span><br><span class="line">&#125; DEVICE_STATE_MANAGER, *PDEVICE_STATE_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ��״̬������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeStateManager</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_TIMER_CONFIG timerConfig;</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES timerAttributes;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ʼ��״̬�������ṹ</span></span><br><span class="line">    DevContext-&gt;StateManager = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(DEVICE_STATE_MANAGER),</span><br><span class="line">        <span class="string">&#x27;MSPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!DevContext-&gt;StateManager) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ�������ֶ�</span></span><br><span class="line">    DevContext-&gt;StateManager-&gt;DevContext = DevContext;</span><br><span class="line">    DevContext-&gt;StateManager-&gt;CurrentState = DeviceStateUninitialized;</span><br><span class="line">    KeInitializeSpinLock(&amp;DevContext-&gt;StateManager-&gt;StateLock);</span><br><span class="line">    KeInitializeEvent(&amp;DevContext-&gt;StateManager-&gt;StateChangeEvent,</span><br><span class="line">                     NotificationEvent,</span><br><span class="line">                     FALSE);</span><br><span class="line">                     </span><br><span class="line">    <span class="comment">// 3. ����������鶨ʱ��</span></span><br><span class="line">    WDF_TIMER_CONFIG_INIT_PERIODIC(</span><br><span class="line">        &amp;timerConfig,</span><br><span class="line">        RtsPciHealthCheckTimerFunc,</span><br><span class="line">        HEALTH_CHECK_INTERVAL);  <span class="comment">// ����30��</span></span><br><span class="line">        </span><br><span class="line">    WDF_OBJECT_ATTRIBUTES_INIT(&amp;timerAttributes);</span><br><span class="line">    timerAttributes.ParentObject = DevContext-&gt;Device;</span><br><span class="line">    </span><br><span class="line">    status = WdfTimerCreate(</span><br><span class="line">        &amp;timerConfig,</span><br><span class="line">        &amp;timerAttributes,</span><br><span class="line">        &amp;DevContext-&gt;StateManager-&gt;HealthCheckTimer);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        ExFreePool(DevContext-&gt;StateManager);</span><br><span class="line">        DevContext-&gt;StateManager = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="9-2-�������ʵ��"><a href="#9-2-�������ʵ��" class="headerlink" title="9.2 �������ʵ��"></a>9.2 �������ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ������鶨ʱ���ص�</span></span><br><span class="line">VOID <span class="title function_">RtsPciHealthCheckTimerFunc</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFTIMER Timer</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    PDEVICE_STATE_MANAGER stateManager;</span><br><span class="line">    DEVICE_HEALTH_INFO healthInfo = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(WdfTimerGetParentObject(Timer));</span><br><span class="line">    stateManager = devContext-&gt;StateManager;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡӲ��״̬</span></span><br><span class="line">    RtsPciGetHardwareStatus(devContext, &amp;healthInfo);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���½�����Ϣ</span></span><br><span class="line">    KeAcquireSpinLock(&amp;stateManager-&gt;StateLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    healthInfo.OperationalTime = </span><br><span class="line">        (ULONG)((KeQueryInterruptTime() - </span><br><span class="line">                 devContext-&gt;StartTime) / <span class="number">10000000</span>); <span class="comment">// ת��Ϊ��</span></span><br><span class="line">                 </span><br><span class="line">    healthInfo.ErrorCount = devContext-&gt;PerfData.ErrorCount;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����¶�</span></span><br><span class="line">    <span class="keyword">if</span> (healthInfo.Temperature &gt; TEMPERATURE_THRESHOLD) &#123;</span><br><span class="line">        healthInfo.IsOverheated = TRUE;</span><br><span class="line">        RtsPciHandleOverheating(devContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����ѹ</span></span><br><span class="line">    <span class="keyword">if</span> (healthInfo.VoltageLevel &lt; VOLTAGE_THRESHOLD) &#123;</span><br><span class="line">        healthInfo.IsVoltageLow = TRUE;</span><br><span class="line">        RtsPciHandleLowVoltage(devContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����״̬</span></span><br><span class="line">    stateManager-&gt;HealthInfo = healthInfo;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;stateManager-&gt;StateLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ��¼������־</span></span><br><span class="line">    RtsPciLogHealthStatus(devContext, &amp;healthInfo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ȡӲ��״̬</span></span><br><span class="line">VOID <span class="title function_">RtsPciGetHardwareStatus</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _Out_ PDEVICE_HEALTH_INFO HealthInfo</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ��ȡ�¶ȼĴ���</span></span><br><span class="line">    HealthInfo-&gt;Temperature = READ_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_TEMPERATURE_REG);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. ��ȡ��ѹ�Ĵ���</span></span><br><span class="line">    HealthInfo-&gt;VoltageLevel = READ_REGISTER_ULONG(</span><br><span class="line">        DevContext-&gt;RegisterBase + HOST_VOLTAGE_REG);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. ��ȡ��ǰʱ��</span></span><br><span class="line">    KeQuerySystemTime(&amp;HealthInfo-&gt;LastCheckTime);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �����������</span></span><br><span class="line">VOID <span class="title function_">RtsPciHandleOverheating</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ����ʱ��Ƶ��</span></span><br><span class="line">    RtsPciSetClock(DevContext, REDUCED_CLOCK_FREQ);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ֪ͨϵͳ</span></span><br><span class="line">    IoReportTargetDeviceChangeAsynchronous(</span><br><span class="line">        WdfDeviceWdmGetPhysicalDevice(DevContext-&gt;Device),</span><br><span class="line">        &amp;GUID_DEVICE_THERMAL_ZONE_ALERT,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. ��¼�¼���־</span></span><br><span class="line">    RtsPciLogEvent(</span><br><span class="line">        DevContext,</span><br><span class="line">        EVENTLOG_WARNING_TYPE,</span><br><span class="line">        EVENT_DEVICE_OVERHEATING,</span><br><span class="line">        <span class="string">&quot;Device temperature exceeds threshold&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="9-3-״̬ת������"><a href="#9-3-״̬ת������" class="headerlink" title="9.3 ״̬ת������"></a>9.3 ״̬ת������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ״̬ת������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciChangeDeviceState</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ DEVICE_STATE NewState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PDEVICE_STATE_MANAGER stateManager = DevContext-&gt;StateManager;</span><br><span class="line">    DEVICE_STATE oldState;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ״̬��</span></span><br><span class="line">    KeAcquireSpinLock(&amp;stateManager-&gt;StateLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    oldState = stateManager-&gt;CurrentState;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���״̬ת���Ƿ���Ч</span></span><br><span class="line">    <span class="keyword">if</span> (!RtsPciIsValidStateTransition(oldState, NewState)) &#123;</span><br><span class="line">        KeReleaseSpinLock(&amp;stateManager-&gt;StateLock, oldIrql);</span><br><span class="line">        <span class="keyword">return</span> STATUS_INVALID_DEVICE_STATE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ִ��״̬ת��ǰ�Ĳ���</span></span><br><span class="line">    status = RtsPciPreStateChange(DevContext, oldState, NewState);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        KeReleaseSpinLock(&amp;stateManager-&gt;StateLock, oldIrql);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����״̬</span></span><br><span class="line">    stateManager-&gt;CurrentState = NewState;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. �ͷ���</span></span><br><span class="line">    KeReleaseSpinLock(&amp;stateManager-&gt;StateLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ִ��״̬ת����Ĳ���</span></span><br><span class="line">    status = RtsPciPostStateChange(DevContext, oldState, NewState);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7. ֪ͨ״̬�仯</span></span><br><span class="line">    KeSetEvent(&amp;stateManager-&gt;StateChangeEvent, <span class="number">0</span>, FALSE);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ״̬ת��ǰ�Ĳ���</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciPreStateChange</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ DEVICE_STATE OldState,</span></span><br><span class="line"><span class="params">    _In_ DEVICE_STATE NewState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (NewState) &#123;</span><br><span class="line">        <span class="keyword">case</span> DeviceStatePaused:</span><br><span class="line">            <span class="comment">// ��ͣIO����</span></span><br><span class="line">            WdfIoQueueStop(DevContext-&gt;IoQueue,</span><br><span class="line">                          <span class="literal">NULL</span>,</span><br><span class="line">                          <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DeviceStateStopped:</span><br><span class="line">            <span class="comment">// ֹͣ���л</span></span><br><span class="line">            status = RtsPciStopAllActivity(DevContext);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DeviceStateRemoved:</span><br><span class="line">            <span class="comment">// ׼���Ƴ��豸</span></span><br><span class="line">            status = RtsPciPrepareForRemoval(DevContext);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ״̬ת����Ĳ���</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciPostStateChange</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ DEVICE_STATE OldState,</span></span><br><span class="line"><span class="params">    _In_ DEVICE_STATE NewState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (NewState) &#123;</span><br><span class="line">        <span class="keyword">case</span> DeviceStateRunning:</span><br><span class="line">            <span class="comment">// ����IO����</span></span><br><span class="line">            WdfIoQueueStart(DevContext-&gt;IoQueue);</span><br><span class="line">            <span class="comment">// �����������</span></span><br><span class="line">            WdfTimerStart(</span><br><span class="line">                DevContext-&gt;StateManager-&gt;HealthCheckTimer,</span><br><span class="line">                WDF_REL_TIMEOUT_IN_SEC(HEALTH_CHECK_INTERVAL));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DeviceStateFailed:</span><br><span class="line">            <span class="comment">// ��¼������־</span></span><br><span class="line">            RtsPciLogEvent(</span><br><span class="line">                DevContext,</span><br><span class="line">                EVENTLOG_ERROR_TYPE,</span><br><span class="line">                EVENT_DEVICE_FAILED,</span><br><span class="line">                <span class="string">&quot;Device entered failed state&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>[���� - ��һ���ֽ���ϸ�����豸��Դ�����ĸ߼�����]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-43"><a href="#User-43" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-43"><a href="#AI-claude-3-5-sonnet-43" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���豸��Դ�����ĸ߼����Բ��֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-9"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-9" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 9"></a>WDF SD Host Controller����ʵ����� - Part 9</h1><h2 id="10-�߼���Դ����"><a href="#10-�߼���Դ����" class="headerlink" title="10. �߼���Դ����"></a>10. �߼���Դ����</h2><h3 id="10-1-��̬��Դ����"><a href="#10-1-��̬��Դ����" class="headerlink" title="10.1 ��̬��Դ����"></a>10.1 ��̬��Դ����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��Դ��������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">POWER_POLICY_CONFIG</span> &#123;</span></span><br><span class="line">    ULONG IdleTimeoutInMs;          <span class="comment">// ���г�ʱʱ��</span></span><br><span class="line">    BOOLEAN AllowWakeFromS0;        <span class="comment">// ������S0����</span></span><br><span class="line">    BOOLEAN AllowWakeFromSx;        <span class="comment">// ������Sx����</span></span><br><span class="line">    BOOLEAN EnableIdleDetection;    <span class="comment">// ���ÿ��м��</span></span><br><span class="line">    ULONG WakeSignals;              <span class="comment">// �����ź�����</span></span><br><span class="line">    DEVICE_POWER_STATE MinPowerState; <span class="comment">// ���������Դ״̬</span></span><br><span class="line">&#125; POWER_POLICY_CONFIG, *PPOWER_POLICY_CONFIG;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��̬���Ĺ�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">POWER_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    POWER_POLICY_CONFIG PolicyConfig;</span><br><span class="line">    DEVICE_POWER_STATE CurrentPowerState;</span><br><span class="line">    ULONG ActivityCount;            <span class="comment">// �����</span></span><br><span class="line">    LARGE_INTEGER LastActivityTime; <span class="comment">// ���ʱ��</span></span><br><span class="line">    KSPIN_LOCK PowerLock;</span><br><span class="line">    WDFTIMER IdleTimer;</span><br><span class="line">&#125; POWER_MANAGER, *PPOWER_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ����Դ������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializePowerManager</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_TIMER_CONFIG timerConfig;</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES timerAttributes;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����Դ������</span></span><br><span class="line">    DevContext-&gt;PowerManager = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(POWER_MANAGER),</span><br><span class="line">        <span class="string">&#x27;MPPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!DevContext-&gt;PowerManager) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ����������</span></span><br><span class="line">    RtlZeroMemory(DevContext-&gt;PowerManager, <span class="keyword">sizeof</span>(POWER_MANAGER));</span><br><span class="line">    DevContext-&gt;PowerManager-&gt;DevContext = DevContext;</span><br><span class="line">    KeInitializeSpinLock(&amp;DevContext-&gt;PowerManager-&gt;PowerLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����Ĭ�ϲ���</span></span><br><span class="line">    DevContext-&gt;PowerManager-&gt;PolicyConfig.IdleTimeoutInMs = <span class="number">1000</span>; <span class="comment">// 1��</span></span><br><span class="line">    DevContext-&gt;PowerManager-&gt;PolicyConfig.AllowWakeFromS0 = TRUE;</span><br><span class="line">    DevContext-&gt;PowerManager-&gt;PolicyConfig.EnableIdleDetection = TRUE;</span><br><span class="line">    DevContext-&gt;PowerManager-&gt;PolicyConfig.MinPowerState = PowerDeviceD2;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �������м�ⶨʱ��</span></span><br><span class="line">    WDF_TIMER_CONFIG_INIT(&amp;timerConfig, RtsPciIdleTimerFunc);</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES_INIT(&amp;timerAttributes);</span><br><span class="line">    timerAttributes.ParentObject = DevContext-&gt;Device;</span><br><span class="line">    </span><br><span class="line">    status = WdfTimerCreate(</span><br><span class="line">        &amp;timerConfig,</span><br><span class="line">        &amp;timerAttributes,</span><br><span class="line">        &amp;DevContext-&gt;PowerManager-&gt;IdleTimer);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        ExFreePool(DevContext-&gt;PowerManager);</span><br><span class="line">        DevContext-&gt;PowerManager = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="10-2-��̬Z�ʺ͵�ѹ����"><a href="#10-2-��̬Z�ʺ͵�ѹ����" class="headerlink" title="10.2 ��̬Ƶ�ʺ͵�ѹ����"></a>10.2 ��̬Ƶ�ʺ͵�ѹ����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ���ܼ�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">PERFORMANCE_LEVEL</span> &#123;</span></span><br><span class="line">    PerformanceLevelLow = <span class="number">0</span>,</span><br><span class="line">    PerformanceLevelMedium,</span><br><span class="line">    PerformanceLevelHigh,</span><br><span class="line">    PerformanceLevelMax</span><br><span class="line">&#125; PERFORMANCE_LEVEL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PERFORMANCE_STATE</span> &#123;</span></span><br><span class="line">    ULONG ClockFrequency;     <span class="comment">// MHz</span></span><br><span class="line">    ULONG VoltageMv;          <span class="comment">// ����</span></span><br><span class="line">    ULONG PowerConsumption;   <span class="comment">// ����</span></span><br><span class="line">&#125; PERFORMANCE_STATE, *PPERFORMANCE_STATE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����״̬��</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> PERFORMANCE_STATE PerformanceStates[] = &#123;</span><br><span class="line">    <span class="comment">// Low</span></span><br><span class="line">    &#123; <span class="number">25</span>,   <span class="number">1800</span>, <span class="number">100</span> &#125;,  <span class="comment">// 25MHz, 1.8V</span></span><br><span class="line">    <span class="comment">// Medium</span></span><br><span class="line">    &#123; <span class="number">50</span>,   <span class="number">2000</span>, <span class="number">200</span> &#125;,  <span class="comment">// 50MHz, 2.0V</span></span><br><span class="line">    <span class="comment">// High</span></span><br><span class="line">    &#123; <span class="number">100</span>,  <span class="number">2500</span>, <span class="number">400</span> &#125;,  <span class="comment">// 100MHz, 2.5V</span></span><br><span class="line">    <span class="comment">// Max</span></span><br><span class="line">    &#123; <span class="number">200</span>,  <span class="number">3300</span>, <span class="number">800</span> &#125;   <span class="comment">// 200MHz, 3.3V</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��̬�������ܼ���</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciSetPerformanceLevel</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PERFORMANCE_LEVEL Level</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    <span class="type">const</span> PERFORMANCE_STATE* targetState;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (Level &gt;= PerformanceLevelMax) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    targetState = &amp;PerformanceStates[Level];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ������ѹ</span></span><br><span class="line">    status = RtsPciSetVoltage(DevContext, targetState-&gt;VoltageMv);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �ȴ���ѹ�ȶ�</span></span><br><span class="line">    KeStallExecutionProcessor(<span class="number">100</span>);  <span class="comment">// 100΢��</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����ʱ��Ƶ��</span></span><br><span class="line">    status = RtsPciSetClock(DevContext, targetState-&gt;ClockFrequency);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="comment">// �ָ�֮ǰ�ĵ�ѹ</span></span><br><span class="line">        RtsPciSetVoltage(DevContext, </span><br><span class="line">            PerformanceStates[DevContext-&gt;CurrentPerformanceLevel].VoltageMv);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���µ�ǰ���ܼ���</span></span><br><span class="line">    DevContext-&gt;CurrentPerformanceLevel = Level;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ��¼���ܱ仯</span></span><br><span class="line">    RtsPciLogPerformanceChange(DevContext, targetState);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����Ӧ���ܹ���</span></span><br><span class="line">VOID <span class="title function_">RtsPciAdaptivePerformanceControl</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    ULONG queueDepth;</span><br><span class="line">    LARGE_INTEGER currentTime;</span><br><span class="line">    PERFORMANCE_LEVEL targetLevel;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ��ǰ�������</span></span><br><span class="line">    queueDepth = WdfIoQueueGetCurrentDepth(DevContext-&gt;IoQueue);</span><br><span class="line">    KeQuerySystemTime(&amp;currentTime);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���ݸ���ȷ��Ŀ�����ܼ���</span></span><br><span class="line">    <span class="keyword">if</span> (queueDepth &gt; HIGH_QUEUE_THRESHOLD) &#123;</span><br><span class="line">        targetLevel = PerformanceLevelHigh;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (queueDepth &gt; MEDIUM_QUEUE_THRESHOLD) &#123;</span><br><span class="line">        targetLevel = PerformanceLevelMedium;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        targetLevel = PerformanceLevelLow;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����¶�����</span></span><br><span class="line">    <span class="keyword">if</span> (DevContext-&gt;StateManager-&gt;HealthInfo.Temperature &gt; </span><br><span class="line">        TEMPERATURE_THRESHOLD) &#123;</span><br><span class="line">        targetLevel = min(targetLevel, PerformanceLevelMedium);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. Ӧ���µ����ܼ���</span></span><br><span class="line">    <span class="keyword">if</span> (targetLevel != DevContext-&gt;CurrentPerformanceLevel) &#123;</span><br><span class="line">        RtsPciSetPerformanceLevel(DevContext, targetLevel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="10-3-��Դ״̬ת���Z�"><a href="#10-3-��Դ״̬ת���Z�" class="headerlink" title="10.3 ��Դ״̬ת���Ż�"></a>10.3 ��Դ״̬ת���Ż�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��Դ״̬ת��������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">POWER_TRANSITION_CONTEXT</span> &#123;</span></span><br><span class="line">    DEVICE_POWER_STATE OldState;</span><br><span class="line">    DEVICE_POWER_STATE NewState;</span><br><span class="line">    BOOLEAN FastResume;</span><br><span class="line">    BOOLEAN SaveContext;</span><br><span class="line">    LARGE_INTEGER TransitionStart;</span><br><span class="line">&#125; POWER_TRANSITION_CONTEXT, *PPOWER_TRANSITION_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �Ż��ĵ�Դ״̬ת��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciOptimizedPowerTransition</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ DEVICE_POWER_STATE TargetState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    POWER_TRANSITION_CONTEXT transContext = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ׼��ת��������</span></span><br><span class="line">    KeAcquireSpinLock(&amp;DevContext-&gt;PowerManager-&gt;PowerLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    transContext.OldState = DevContext-&gt;PowerManager-&gt;CurrentPowerState;</span><br><span class="line">    transContext.NewState = TargetState;</span><br><span class="line">    transContext.FastResume = </span><br><span class="line">        (TargetState == PowerDeviceD0 &amp;&amp; </span><br><span class="line">         transContext.OldState == PowerDeviceD1);</span><br><span class="line">    transContext.SaveContext = </span><br><span class="line">        (TargetState &gt; PowerDeviceD1);</span><br><span class="line">        </span><br><span class="line">    KeQuerySystemTime(&amp;transContext.TransitionStart);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ִ��Ԥת������</span></span><br><span class="line">    status = RtsPciPrePowerTransition(DevContext, &amp;transContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        KeReleaseSpinLock(&amp;DevContext-&gt;PowerManager-&gt;PowerLock, oldIrql);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �����Ҫ��������</span></span><br><span class="line">    <span class="keyword">if</span> (transContext.SaveContext) &#123;</span><br><span class="line">        RtsPciSaveDeviceContext(DevContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ִ��ʵ�ʵĵ�Դת��</span></span><br><span class="line">    status = RtsPciDoPowerTransition(DevContext, &amp;transContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        KeReleaseSpinLock(&amp;DevContext-&gt;PowerManager-&gt;PowerLock, oldIrql);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ���µ�Դ״̬</span></span><br><span class="line">    DevContext-&gt;PowerManager-&gt;CurrentPowerState = TargetState;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;DevContext-&gt;PowerManager-&gt;PowerLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ִ�к�ת������</span></span><br><span class="line">    status = RtsPciPostPowerTransition(DevContext, &amp;transContext);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �豸�����ı���</span></span><br><span class="line">VOID <span class="title function_">RtsPciSaveDeviceContext</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ����ؼ��Ĵ���</span></span><br><span class="line">    DevContext-&gt;SavedContext.ControlReg = </span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_CTRL_REG);</span><br><span class="line">    DevContext-&gt;SavedContext.ClockReg =</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_CLOCK_CTRL);</span><br><span class="line">    DevContext-&gt;SavedContext.IntMask =</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_INT_ENABLE);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. ����DMA����</span></span><br><span class="line">    DevContext-&gt;SavedContext.DmaConfig =</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_DMA_CTRL);</span><br><span class="line">    DevContext-&gt;SavedContext.DmaAddr =</span><br><span class="line">        READ_REGISTER_ULONG(DevContext-&gt;RegisterBase + HOST_DMA_ADDR);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. ��������״̬</span></span><br><span class="line">    DevContext-&gt;SavedContext.PerformanceLevel =</span><br><span class="line">        DevContext-&gt;CurrentPerformanceLevel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>[���� - ��һ���ֽ���ϸ���ܸ߼�IO�����������Ż�]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-44"><a href="#User-44" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-44"><a href="#AI-claude-3-5-sonnet-44" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼�IO�����������Ż����֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-10"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-10" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 10"></a>WDF SD Host Controller����ʵ����� - Part 10</h1><h2 id="11-�߼�IO�����������Z�"><a href="#11-�߼�IO�����������Z�" class="headerlink" title="11. �߼�IO�����������Ż�"></a>11. �߼�IO�����������Ż�</h2><h3 id="11-1-IO��������Z�"><a href="#11-1-IO��������Z�" class="headerlink" title="11.1 IO��������Ż�"></a>11.1 IO��������Ż�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IO��������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_QUEUE_CONFIG</span> &#123;</span></span><br><span class="line">    ULONG MaxQueueDepth;</span><br><span class="line">    ULONG ConcurrentRequests;</span><br><span class="line">    ULONG ReadAheadSize;</span><br><span class="line">    ULONG WriteBehindSize;</span><br><span class="line">    BOOLEAN EnableCoalescing;</span><br><span class="line">    BOOLEAN PrioritizeReads;</span><br><span class="line">&#125; IO_QUEUE_CONFIG, *PIO_QUEUE_CONFIG;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IO�����Ż���</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_REQUEST_OPTIMIZER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    IO_QUEUE_CONFIG Config;</span><br><span class="line">    LIST_ENTRY PendingReads;</span><br><span class="line">    LIST_ENTRY PendingWrites;</span><br><span class="line">    KSPIN_LOCK QueueLock;</span><br><span class="line">    NPAGED_LOOKASIDE_LIST RequestPool;</span><br><span class="line">    KDPC CoalescingDpc;</span><br><span class="line">    KTIMER CoalescingTimer;</span><br><span class="line">&#125; IO_REQUEST_OPTIMIZER, *PIO_REQUEST_OPTIMIZER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ��IO�Ż���</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeIoOptimizer</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PIO_REQUEST_OPTIMIZER optimizer;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����Ż����ṹ</span></span><br><span class="line">    optimizer = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(IO_REQUEST_OPTIMIZER),</span><br><span class="line">        <span class="string">&#x27;OIPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!optimizer) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ�������ֶ�</span></span><br><span class="line">    RtlZeroMemory(optimizer, <span class="keyword">sizeof</span>(IO_REQUEST_OPTIMIZER));</span><br><span class="line">    optimizer-&gt;DevContext = DevContext;</span><br><span class="line">    InitializeListHead(&amp;optimizer-&gt;PendingReads);</span><br><span class="line">    InitializeListHead(&amp;optimizer-&gt;PendingWrites);</span><br><span class="line">    KeInitializeSpinLock(&amp;optimizer-&gt;QueueLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʼ�������</span></span><br><span class="line">    ExInitializeNPagedLookasideList(</span><br><span class="line">        &amp;optimizer-&gt;RequestPool,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="keyword">sizeof</span>(IO_REQUEST_CONTEXT),</span><br><span class="line">        <span class="string">&#x27;CRPR&#x27;</span>,</span><br><span class="line">        <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 4. ��ʼ���ϲ�DPC�Ͷ�ʱ��</span></span><br><span class="line">    KeInitializeDpc(</span><br><span class="line">        &amp;optimizer-&gt;CoalescingDpc,</span><br><span class="line">        RtsPciIoCoalescingDpc,</span><br><span class="line">        optimizer);</span><br><span class="line">        </span><br><span class="line">    KeInitializeTimer(&amp;optimizer-&gt;CoalescingTimer);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����Ĭ������</span></span><br><span class="line">    optimizer-&gt;Config.MaxQueueDepth = <span class="number">256</span>;</span><br><span class="line">    optimizer-&gt;Config.ConcurrentRequests = <span class="number">16</span>;</span><br><span class="line">    optimizer-&gt;Config.ReadAheadSize = <span class="number">128</span> * <span class="number">1024</span>;  <span class="comment">// 128KB</span></span><br><span class="line">    optimizer-&gt;Config.WriteBehindSize = <span class="number">256</span> * <span class="number">1024</span>; <span class="comment">// 256KB</span></span><br><span class="line">    optimizer-&gt;Config.EnableCoalescing = TRUE;</span><br><span class="line">    optimizer-&gt;Config.PrioritizeReads = TRUE;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;IoOptimizer = optimizer;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="11-2-����ϲ�������"><a href="#11-2-����ϲ�������" class="headerlink" title="11.2 ����ϲ�������"></a>11.2 ����ϲ�������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ����ϲ�����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciCoalesceRequests</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PIO_REQUEST_OPTIMIZER Optimizer,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ BOOLEAN IsRead</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PLIST_ENTRY requestList;</span><br><span class="line">    PIO_REQUEST_CONTEXT newContext, existingContext;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    BOOLEAN canCoalesce = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ�������</span></span><br><span class="line">    newContext = ExAllocateFromNPagedLookasideList(&amp;Optimizer-&gt;RequestPool);</span><br><span class="line">    <span class="keyword">if</span> (!newContext) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    status = RtsPciGetRequestContext(Request, newContext);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        ExFreeToNPagedLookasideList(&amp;Optimizer-&gt;RequestPool, newContext);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���Ժϲ�����</span></span><br><span class="line">    KeAcquireSpinLock(&amp;Optimizer-&gt;QueueLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    requestList = IsRead ? </span><br><span class="line">        &amp;Optimizer-&gt;PendingReads : </span><br><span class="line">        &amp;Optimizer-&gt;PendingWrites;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ������������Ѱ�ҿɺϲ���</span></span><br><span class="line">    <span class="keyword">for</span> (PLIST_ENTRY entry = requestList-&gt;Flink;</span><br><span class="line">         entry != requestList;</span><br><span class="line">         entry = entry-&gt;Flink) &#123;</span><br><span class="line">        existingContext = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            IO_REQUEST_CONTEXT,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (RtsPciCanCoalesceRequests(newContext, existingContext)) &#123;</span><br><span class="line">            <span class="comment">// �ϲ�����</span></span><br><span class="line">            status = RtsPciMergeRequests(</span><br><span class="line">                Optimizer,</span><br><span class="line">                existingContext,</span><br><span class="line">                newContext);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">                canCoalesce = TRUE;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����޷��ϲ������ӵ�����</span></span><br><span class="line">    <span class="keyword">if</span> (!canCoalesce) &#123;</span><br><span class="line">        InsertTailList(requestList, &amp;newContext-&gt;ListEntry);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// �����ϲ���ʱ��</span></span><br><span class="line">        <span class="keyword">if</span> (Optimizer-&gt;Config.EnableCoalescing) &#123;</span><br><span class="line">            KeSetTimer(</span><br><span class="line">                &amp;Optimizer-&gt;CoalescingTimer,</span><br><span class="line">                RtlConvertLongToLargeInteger(<span class="number">-10000</span>), <span class="comment">// 1ms</span></span><br><span class="line">                &amp;Optimizer-&gt;CoalescingDpc);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;Optimizer-&gt;QueueLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����������</span></span><br><span class="line">VOID <span class="title function_">RtsPciSortPendingRequests</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PIO_REQUEST_OPTIMIZER Optimizer,</span></span><br><span class="line"><span class="params">    _In_ PLIST_ENTRY RequestList</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    LIST_ENTRY sortedList;</span><br><span class="line">    PIO_REQUEST_CONTEXT context;</span><br><span class="line">    PLIST_ENTRY entry, nextEntry;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ʼ�������б�</span></span><br><span class="line">    InitializeListHead(&amp;sortedList);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ʹ�õ����㷨����</span></span><br><span class="line">    <span class="keyword">while</span> (!IsListEmpty(RequestList)) &#123;</span><br><span class="line">        entry = RemoveHeadList(RequestList);</span><br><span class="line">        context = CONTAINING_RECORD(entry, IO_REQUEST_CONTEXT, ListEntry);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// �ҵ����ʵĲ���λ��</span></span><br><span class="line">        BOOLEAN inserted = FALSE;</span><br><span class="line">        <span class="keyword">for</span> (PLIST_ENTRY sortedEntry = sortedList.Flink;</span><br><span class="line">             sortedEntry != &amp;sortedList;</span><br><span class="line">             sortedEntry = sortedEntry-&gt;Flink) &#123;</span><br><span class="line">            PIO_REQUEST_CONTEXT sortedContext = CONTAINING_RECORD(</span><br><span class="line">                sortedEntry,</span><br><span class="line">                IO_REQUEST_CONTEXT,</span><br><span class="line">                ListEntry);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (context-&gt;StartingLba &lt; sortedContext-&gt;StartingLba) &#123;</span><br><span class="line">                InsertHeadList(sortedEntry-&gt;Blink, entry);</span><br><span class="line">                inserted = TRUE;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!inserted) &#123;</span><br><span class="line">            InsertTailList(&amp;sortedList, entry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���������б��ƻ�ԭ�б�</span></span><br><span class="line">    <span class="keyword">while</span> (!IsListEmpty(&amp;sortedList)) &#123;</span><br><span class="line">        entry = RemoveHeadList(&amp;sortedList);</span><br><span class="line">        InsertTailList(RequestList, entry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="11-3-Ԥ�����ӳ�д"><a href="#11-3-Ԥ�����ӳ�д" class="headerlink" title="11.3 Ԥ�����ӳ�д"></a>11.3 Ԥ�����ӳ�д</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Ԥ������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleReadAhead</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ ULONGLONG StartingLba,</span></span><br><span class="line"><span class="params">    _In_ ULONG BlockCount</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    ULONG readAheadBlocks;</span><br><span class="line">    PIO_REQUEST_OPTIMIZER optimizer = DevContext-&gt;IoOptimizer;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����Ԥ����С</span></span><br><span class="line">    readAheadBlocks = min(</span><br><span class="line">        (optimizer-&gt;Config.ReadAheadSize / DevContext-&gt;BlockSize),</span><br><span class="line">        (ULONG)(DevContext-&gt;DiskSize.QuadPart / DevContext-&gt;BlockSize) - </span><br><span class="line">            (StartingLba + BlockCount));</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">if</span> (readAheadBlocks == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����Ԥ������</span></span><br><span class="line">    status = RtsPciCreateReadAheadRequest(</span><br><span class="line">        DevContext,</span><br><span class="line">        StartingLba + BlockCount,</span><br><span class="line">        readAheadBlocks);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="comment">// Ԥ��ʧ�ܲ�Ӱ��ԭʼ����</span></span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �ӳ�д����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleWriteBehind</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PIO_REQUEST_OPTIMIZER optimizer = DevContext-&gt;IoOptimizer;</span><br><span class="line">    BOOLEAN needFlush = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���д������״̬</span></span><br><span class="line">    <span class="keyword">if</span> (RtsPciIsWriteBufferFull(optimizer)) &#123;</span><br><span class="line">        needFlush = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���ӵ�д������</span></span><br><span class="line">    status = RtsPciAddToWriteBuffer(optimizer, Request);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �����Ҫ��ִ��ˢ��</span></span><br><span class="line">    <span class="keyword">if</span> (needFlush) &#123;</span><br><span class="line">        status = RtsPciFlushWriteBuffer(optimizer);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">return</span> status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// д������ˢ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciFlushWriteBuffer</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PIO_REQUEST_OPTIMIZER Optimizer</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    LIST_ENTRY requestsToFlush;</span><br><span class="line">    </span><br><span class="line">    InitializeListHead(&amp;requestsToFlush);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ��Ҫˢ�µ�����</span></span><br><span class="line">    KeAcquireSpinLock(&amp;Optimizer-&gt;QueueLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!IsListEmpty(&amp;Optimizer-&gt;PendingWrites)) &#123;</span><br><span class="line">        PLIST_ENTRY entry = RemoveHeadList(&amp;Optimizer-&gt;PendingWrites);</span><br><span class="line">        InsertTailList(&amp;requestsToFlush, entry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;Optimizer-&gt;QueueLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ִ��ʵ�ʵ�д����</span></span><br><span class="line">    <span class="keyword">while</span> (!IsListEmpty(&amp;requestsToFlush)) &#123;</span><br><span class="line">        PLIST_ENTRY entry = RemoveHeadList(&amp;requestsToFlush);</span><br><span class="line">        PIO_REQUEST_CONTEXT context = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            IO_REQUEST_CONTEXT,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        status = RtsPciProcessWriteRequest(</span><br><span class="line">            Optimizer-&gt;DevContext,</span><br><span class="line">            context);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="comment">// ��������</span></span><br><span class="line">            RtsPciHandleWriteError(Optimizer, context);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ExFreeToNPagedLookasideList(</span><br><span class="line">            &amp;Optimizer-&gt;RequestPool,</span><br><span class="line">            context);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>[���� - ��һ���ֽ���ϸ���ܶ����֧�ֺͲ����Ż�]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-45"><a href="#User-45" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-45"><a href="#AI-claude-3-5-sonnet-45" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ�������֧�ֺͲ����Ż����֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-11"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-11" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 11"></a>WDF SD Host Controller����ʵ����� - Part 11</h1><h2 id="12-�����֧�ֺͲ����Z�"><a href="#12-�����֧�ֺͲ����Z�" class="headerlink" title="12. �����֧�ֺͲ����Ż�"></a>12. �����֧�ֺͲ����Ż�</h2><h3 id="12-1-����й�����ʵ��"><a href="#12-1-����й�����ʵ��" class="headerlink" title="12.1 ����й�����ʵ��"></a>12.1 ����й�����ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �������Ͷ���</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">QUEUE_TYPE</span> &#123;</span></span><br><span class="line">    QueueTypeRead = <span class="number">0</span>,</span><br><span class="line">    QueueTypeWrite,</span><br><span class="line">    QueueTypeControl,</span><br><span class="line">    QueueTypeMax</span><br><span class="line">&#125; QUEUE_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">QUEUE_CONTEXT</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    QUEUE_TYPE Type;</span><br><span class="line">    WDFQUEUE Queue;</span><br><span class="line">    KSPIN_LOCK Lock;</span><br><span class="line">    LIST_ENTRY PendingList;</span><br><span class="line">    ULONG CurrentDepth;</span><br><span class="line">    ULONG MaxDepth;</span><br><span class="line">    BOOLEAN IsPaused;</span><br><span class="line">&#125; QUEUE_CONTEXT, *PQUEUE_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����й�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">MULTI_QUEUE_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    QUEUE_CONTEXT Queues[QueueTypeMax];</span><br><span class="line">    KSEMAPHORE QueueSemaphore;</span><br><span class="line">    KEVENT QueueEvent;</span><br><span class="line">    BOOLEAN EnableLoadBalancing;</span><br><span class="line">    LONG ActiveQueueCount;</span><br><span class="line">&#125; MULTI_QUEUE_MANAGER, *PMULTI_QUEUE_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ������й�����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeMultiQueue</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_IO_QUEUE_CONFIG queueConfig;</span><br><span class="line">    WDF_OBJECT_ATTRIBUTES queueAttributes;</span><br><span class="line">    PMULTI_QUEUE_MANAGER queueManager;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����������ṹ</span></span><br><span class="line">    queueManager = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(MULTI_QUEUE_MANAGER),</span><br><span class="line">        <span class="string">&#x27;MQPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!queueManager) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(queueManager, <span class="keyword">sizeof</span>(MULTI_QUEUE_MANAGER));</span><br><span class="line">    queueManager-&gt;DevContext = DevContext;</span><br><span class="line">    queueManager-&gt;EnableLoadBalancing = TRUE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ��ͬ������</span></span><br><span class="line">    KeInitializeSemaphore(&amp;queueManager-&gt;QueueSemaphore, </span><br><span class="line">                         QueueTypeMax, QueueTypeMax);</span><br><span class="line">    KeInitializeEvent(&amp;queueManager-&gt;QueueEvent, </span><br><span class="line">                     NotificationEvent, FALSE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���������Ͷ���</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; QueueTypeMax; i++) &#123;</span><br><span class="line">        PQUEUE_CONTEXT queueCtx = &amp;queueManager-&gt;Queues[i];</span><br><span class="line">        queueCtx-&gt;DevContext = DevContext;</span><br><span class="line">        queueCtx-&gt;Type = (QUEUE_TYPE)i;</span><br><span class="line">        queueCtx-&gt;MaxDepth = <span class="number">256</span>;  <span class="comment">// Ĭ�����</span></span><br><span class="line">        InitializeListHead(&amp;queueCtx-&gt;PendingList);</span><br><span class="line">        KeInitializeSpinLock(&amp;queueCtx-&gt;Lock);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����WDF����</span></span><br><span class="line">        WDF_IO_QUEUE_CONFIG_INIT(&amp;queueConfig, WdfIoQueueDispatchParallel);</span><br><span class="line">        queueConfig.EvtIoDefault = RtsPciEvtIoDefault;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (i) &#123;</span><br><span class="line">            <span class="keyword">case</span> QueueTypeRead:</span><br><span class="line">                queueConfig.EvtIoRead = RtsPciEvtIoRead;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> QueueTypeWrite:</span><br><span class="line">                queueConfig.EvtIoWrite = RtsPciEvtIoWrite;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> QueueTypeControl:</span><br><span class="line">                queueConfig.EvtIoDeviceControl = RtsPciEvtIoDeviceControl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        WDF_OBJECT_ATTRIBUTES_INIT_CONTEXT_TYPE(</span><br><span class="line">            &amp;queueAttributes,</span><br><span class="line">            QUEUE_CONTEXT);</span><br><span class="line">            </span><br><span class="line">        status = WdfIoQueueCreate(</span><br><span class="line">            DevContext-&gt;Device,</span><br><span class="line">            &amp;queueConfig,</span><br><span class="line">            &amp;queueAttributes,</span><br><span class="line">            &amp;queueCtx-&gt;Queue);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        InterlockedIncrement(&amp;queueManager-&gt;ActiveQueueCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;QueueManager = queueManager;</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">cleanup:</span><br><span class="line">    RtsPciCleanupMultiQueue(queueManager);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h3 id="12-2-���ؾ���ʵ��"><a href="#12-2-���ؾ���ʵ��" class="headerlink" title="12.2 ���ؾ���ʵ��"></a>12.2 ���ؾ���ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ���ؾ�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">LOAD_BALANCER</span> &#123;</span></span><br><span class="line">    PMULTI_QUEUE_MANAGER QueueManager;</span><br><span class="line">    ULONG QueueWeights[QueueTypeMax];</span><br><span class="line">    KSPIN_LOCK StatsLock;</span><br><span class="line">    LARGE_INTEGER LastBalanceTime;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG RequestCount;</span><br><span class="line">        ULONG ProcessingTime;</span><br><span class="line">        ULONG AverageLatency;</span><br><span class="line">    &#125; QueueStats[QueueTypeMax];</span><br><span class="line">&#125; LOAD_BALANCER, *PLOAD_BALANCER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���ؾ��⴦��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciBalanceQueues</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PLOAD_BALANCER Balancer</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    LARGE_INTEGER currentTime;</span><br><span class="line">    ULONG totalWeight = <span class="number">0</span>;</span><br><span class="line">    ULONG newWeights[QueueTypeMax] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ��ǰͳ������</span></span><br><span class="line">    KeAcquireSpinLock(&amp;Balancer-&gt;StatsLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    KeQuerySystemTime(&amp;currentTime);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ʱ����</span></span><br><span class="line">    LONGLONG timeDiff = (currentTime.QuadPart - </span><br><span class="line">                        Balancer-&gt;LastBalanceTime.QuadPart) / <span class="number">10000</span>; <span class="comment">// ms</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ������Ȩ��</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; QueueTypeMax; i++) &#123;</span><br><span class="line">        ULONG queueLoad = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (Balancer-&gt;QueueStats[i].RequestCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            queueLoad = (Balancer-&gt;QueueStats[i].ProcessingTime * <span class="number">100</span>) /</span><br><span class="line">                       (ULONG)timeDiff;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ���ݸ��ص���Ȩ��</span></span><br><span class="line">        <span class="keyword">if</span> (queueLoad &gt; <span class="number">80</span>) &#123;  <span class="comment">// �߸���</span></span><br><span class="line">            newWeights[i] = Balancer-&gt;QueueWeights[i] * <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (queueLoad &lt; <span class="number">20</span>) &#123;  <span class="comment">// �͸���</span></span><br><span class="line">            newWeights[i] = Balancer-&gt;QueueWeights[i] / <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            newWeights[i] = Balancer-&gt;QueueWeights[i];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        totalWeight += newWeights[i];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. Ӧ����Ȩ��</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; QueueTypeMax; i++) &#123;</span><br><span class="line">        Balancer-&gt;QueueWeights[i] = </span><br><span class="line">            (newWeights[i] * <span class="number">100</span>) / totalWeight;</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// ����ͳ������</span></span><br><span class="line">        Balancer-&gt;QueueStats[i].RequestCount = <span class="number">0</span>;</span><br><span class="line">        Balancer-&gt;QueueStats[i].ProcessingTime = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Balancer-&gt;LastBalanceTime = currentTime;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;Balancer-&gt;StatsLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h3 id="12-3-���������Z�"><a href="#12-3-���������Z�" class="headerlink" title="12.3 ���������Ż�"></a>12.3 ���������Ż�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �������ƹ�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">CONCURRENCY_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    LONG MaxConcurrentRequests;</span><br><span class="line">    LONG CurrentRequests;</span><br><span class="line">    KSPIN_LOCK Lock;</span><br><span class="line">    LIST_ENTRY WaitingList;</span><br><span class="line">    KEVENT RequestComplete;</span><br><span class="line">    BOOLEAN ThrottlingEnabled;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG HighThreshold;</span><br><span class="line">        ULONG LowThreshold;</span><br><span class="line">        ULONG CurrentLevel;</span><br><span class="line">    &#125; ThrottleControl;</span><br><span class="line">&#125; CONCURRENCY_MANAGER, *PCONCURRENCY_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleConcurrentRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCONCURRENCY_MANAGER ConcurrencyMgr,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    BOOLEAN needWait = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��鲢������</span></span><br><span class="line">    KeAcquireSpinLock(&amp;ConcurrencyMgr-&gt;Lock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ConcurrencyMgr-&gt;CurrentRequests &gt;= </span><br><span class="line">        ConcurrencyMgr-&gt;MaxConcurrentRequests) &#123;</span><br><span class="line">        <span class="comment">// ���ӵ��ȴ��б�</span></span><br><span class="line">        status = RtsPciAddToWaitingList(</span><br><span class="line">            ConcurrencyMgr,</span><br><span class="line">            Request);</span><br><span class="line">            </span><br><span class="line">        needWait = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        InterlockedIncrement(&amp;ConcurrencyMgr-&gt;CurrentRequests);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;ConcurrencyMgr-&gt;Lock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (needWait) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_PENDING;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. Ӧ�ý�������</span></span><br><span class="line">    <span class="keyword">if</span> (ConcurrencyMgr-&gt;ThrottlingEnabled) &#123;</span><br><span class="line">        status = RtsPciApplyThrottling(ConcurrencyMgr);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            InterlockedDecrement(&amp;ConcurrencyMgr-&gt;CurrentRequests);</span><br><span class="line">            <span class="keyword">return</span> status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��������</span></span><br><span class="line">    status = RtsPciProcessRequest(</span><br><span class="line">        ConcurrencyMgr-&gt;DevContext,</span><br><span class="line">        Request);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        InterlockedDecrement(&amp;ConcurrencyMgr-&gt;CurrentRequests);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ������ɴ���</span></span><br><span class="line">VOID <span class="title function_">RtsPciCompleteRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCONCURRENCY_MANAGER ConcurrencyMgr,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ NTSTATUS Status</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    WDFREQUEST nextRequest = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���¼���</span></span><br><span class="line">    InterlockedDecrement(&amp;ConcurrencyMgr-&gt;CurrentRequests);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���ȴ��б�</span></span><br><span class="line">    KeAcquireSpinLock(&amp;ConcurrencyMgr-&gt;Lock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!IsListEmpty(&amp;ConcurrencyMgr-&gt;WaitingList)) &#123;</span><br><span class="line">        PLIST_ENTRY entry = RemoveHeadList(&amp;ConcurrencyMgr-&gt;WaitingList);</span><br><span class="line">        nextRequest = CONTAINING_RECORD(entry, </span><br><span class="line">                                      WAITING_REQUEST, </span><br><span class="line">                                      ListEntry)-&gt;Request;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;ConcurrencyMgr-&gt;Lock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ɵ�ǰ����</span></span><br><span class="line">    WdfRequestComplete(Request, Status);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ������һ������</span></span><br><span class="line">    <span class="keyword">if</span> (nextRequest != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        RtsPciHandleConcurrentRequest(ConcurrencyMgr, nextRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ֪ͨ�ȴ���</span></span><br><span class="line">    KeSetEvent(&amp;ConcurrencyMgr-&gt;RequestComplete, <span class="number">0</span>, FALSE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<p>[���� - ��һ���ֽ���ϸ���ܸ߼����Ժ���Ϲ���]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-46"><a href="#User-46" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-46"><a href="#AI-claude-3-5-sonnet-46" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼����Ժ���Ϲ��ܲ��֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-12"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-12" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 12"></a>WDF SD Host Controller����ʵ����� - Part 12</h1><h2 id="13-�߼����Ժ���Ϲ���"><a href="#13-�߼����Ժ���Ϲ���" class="headerlink" title="13. �߼����Ժ���Ϲ���"></a>13. �߼����Ժ���Ϲ���</h2><h3 id="13-1-ʵʱ���ϵͳ"><a href="#13-1-ʵʱ���ϵͳ" class="headerlink" title="13.1 ʵʱ���ϵͳ"></a>13.1 ʵʱ���ϵͳ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ����¼�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">DIAGNOSTIC_EVENT_TYPE</span> &#123;</span></span><br><span class="line">    DiagEventError = <span class="number">0</span>,</span><br><span class="line">    DiagEventWarning,</span><br><span class="line">    DiagEventInfo,</span><br><span class="line">    DiagEventPerformance,</span><br><span class="line">    DiagEventState,</span><br><span class="line">    DiagEventIO,</span><br><span class="line">    DiagEventPower,</span><br><span class="line">    DiagEventDMA</span><br><span class="line">&#125; DIAGNOSTIC_EVENT_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����¼��ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DIAGNOSTIC_EVENT</span> &#123;</span></span><br><span class="line">    DIAGNOSTIC_EVENT_TYPE Type;</span><br><span class="line">    LARGE_INTEGER Timestamp;</span><br><span class="line">    ULONG ProcessId;</span><br><span class="line">    ULONG ThreadId;</span><br><span class="line">    ULONG Sequence;</span><br><span class="line">    NTSTATUS Status;</span><br><span class="line">    WCHAR Description[<span class="number">256</span>];</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            ULONG ErrorCode;</span><br><span class="line">            ULONG ErrorFlags;</span><br><span class="line">            WCHAR ErrorLocation[<span class="number">64</span>];</span><br><span class="line">        &#125; Error;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            ULONG IOType;</span><br><span class="line">            ULONGLONG Offset;</span><br><span class="line">            ULONG Length;</span><br><span class="line">            ULONG Duration;</span><br><span class="line">        &#125; IO;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            DEVICE_POWER_STATE OldState;</span><br><span class="line">            DEVICE_POWER_STATE NewState;</span><br><span class="line">            ULONG TransitionTime;</span><br><span class="line">        &#125; Power;</span><br><span class="line">    &#125; Data;</span><br><span class="line">&#125; DIAGNOSTIC_EVENT, *PDIAGNOSTIC_EVENT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Ϲ�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DIAGNOSTIC_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    KSPIN_LOCK EventLock;</span><br><span class="line">    NPAGED_LOOKASIDE_LIST EventPool;</span><br><span class="line">    LIST_ENTRY EventList;</span><br><span class="line">    ULONG MaxEvents;</span><br><span class="line">    ULONG CurrentEvents;</span><br><span class="line">    LONG SequenceNumber;</span><br><span class="line">    BOOLEAN Enabled;</span><br><span class="line">    BOOLEAN VerboseMode;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �¼�������</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG TypeFilter;</span><br><span class="line">        ULONG MinSeverity;</span><br><span class="line">        BOOLEAN FilterEnabled;</span><br><span class="line">    &#125; EventFilter;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ʵʱ��ػص�</span></span><br><span class="line">    PFN_DIAGNOSTIC_CALLBACK MonitorCallback;</span><br><span class="line">    PVOID MonitorContext;</span><br><span class="line">&#125; DIAGNOSTIC_MANAGER, *PDIAGNOSTIC_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ�����ϵͳ</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeDiagnostics</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDIAGNOSTIC_MANAGER diagMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ������Ϲ�����</span></span><br><span class="line">    diagMgr = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(DIAGNOSTIC_MANAGER),</span><br><span class="line">        <span class="string">&#x27;DMPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!diagMgr) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(diagMgr, <span class="keyword">sizeof</span>(DIAGNOSTIC_MANAGER));</span><br><span class="line">    diagMgr-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ���¼��غ��б�</span></span><br><span class="line">    ExInitializeNPagedLookasideList(</span><br><span class="line">        &amp;diagMgr-&gt;EventPool,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="keyword">sizeof</span>(DIAGNOSTIC_EVENT),</span><br><span class="line">        <span class="string">&#x27;EVPR&#x27;</span>,</span><br><span class="line">        <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">    InitializeListHead(&amp;diagMgr-&gt;EventList);</span><br><span class="line">    KeInitializeSpinLock(&amp;diagMgr-&gt;EventLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����Ĭ������</span></span><br><span class="line">    diagMgr-&gt;MaxEvents = <span class="number">1000</span>;</span><br><span class="line">    diagMgr-&gt;Enabled = TRUE;</span><br><span class="line">    diagMgr-&gt;EventFilter.MinSeverity = DiagEventWarning;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;DiagnosticManager = diagMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h3 id="13-2-ʵʱ�¼���¼�ͷ���"><a href="#13-2-ʵʱ�¼���¼�ͷ���" class="headerlink" title="13.2 ʵʱ�¼���¼�ͷ���"></a>13.2 ʵʱ�¼���¼�ͷ���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��¼����¼�</span></span><br><span class="line">VOID <span class="title function_">RtsPciLogDiagnosticEvent</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDIAGNOSTIC_MANAGER DiagMgr,</span></span><br><span class="line"><span class="params">    _In_ DIAGNOSTIC_EVENT_TYPE Type,</span></span><br><span class="line"><span class="params">    _In_ NTSTATUS Status,</span></span><br><span class="line"><span class="params">    _In_ PCWSTR Description,</span></span><br><span class="line"><span class="params">    _In_opt_ PVOID EventData,</span></span><br><span class="line"><span class="params">    _In_ SIZE_T DataSize</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PDIAGNOSTIC_EVENT event;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����Ƿ���Ҫ��¼</span></span><br><span class="line">    <span class="keyword">if</span> (!DiagMgr-&gt;Enabled ||</span><br><span class="line">        (DiagMgr-&gt;EventFilter.FilterEnabled &amp;&amp; </span><br><span class="line">         !(DiagMgr-&gt;EventFilter.TypeFilter &amp; (<span class="number">1</span> &lt;&lt; Type)))) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����¼��ṹ</span></span><br><span class="line">    event = ExAllocateFromNPagedLookasideList(&amp;DiagMgr-&gt;EventPool);</span><br><span class="line">    <span class="keyword">if</span> (!event) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����¼���Ϣ</span></span><br><span class="line">    RtlZeroMemory(event, <span class="keyword">sizeof</span>(DIAGNOSTIC_EVENT));</span><br><span class="line">    event-&gt;Type = Type;</span><br><span class="line">    event-&gt;Status = Status;</span><br><span class="line">    event-&gt;Sequence = InterlockedIncrement(&amp;DiagMgr-&gt;SequenceNumber);</span><br><span class="line">    KeQuerySystemTime(&amp;event-&gt;Timestamp);</span><br><span class="line">    event-&gt;ProcessId = (ULONG)PsGetCurrentProcessId();</span><br><span class="line">    event-&gt;ThreadId = (ULONG)PsGetCurrentThreadId();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (Description) &#123;</span><br><span class="line">        RtlStringCchCopyW(event-&gt;Description, </span><br><span class="line">                         ARRAYSIZE(event-&gt;Description),</span><br><span class="line">                         Description);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �����¼��ض�����</span></span><br><span class="line">    <span class="keyword">if</span> (EventData &amp;&amp; DataSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        RtlCopyMemory(&amp;event-&gt;Data, EventData, </span><br><span class="line">                      min(DataSize, <span class="keyword">sizeof</span>(event-&gt;Data)));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ���ӵ��¼��б�</span></span><br><span class="line">    KeAcquireSpinLock(&amp;DiagMgr-&gt;EventLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (DiagMgr-&gt;CurrentEvents &gt;= DiagMgr-&gt;MaxEvents) &#123;</span><br><span class="line">        <span class="comment">// �Ƴ���ɵ��¼�</span></span><br><span class="line">        PLIST_ENTRY oldestEntry = RemoveHeadList(&amp;DiagMgr-&gt;EventList);</span><br><span class="line">        PDIAGNOSTIC_EVENT oldestEvent = CONTAINING_RECORD(</span><br><span class="line">            oldestEntry,</span><br><span class="line">            DIAGNOSTIC_EVENT,</span><br><span class="line">            ListEntry);</span><br><span class="line">        ExFreeToNPagedLookasideList(&amp;DiagMgr-&gt;EventPool, oldestEvent);</span><br><span class="line">        DiagMgr-&gt;CurrentEvents--;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    InsertTailList(&amp;DiagMgr-&gt;EventList, &amp;event-&gt;ListEntry);</span><br><span class="line">    DiagMgr-&gt;CurrentEvents++;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;DiagMgr-&gt;EventLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ���ü�ػص�</span></span><br><span class="line">    <span class="keyword">if</span> (DiagMgr-&gt;MonitorCallback) &#123;</span><br><span class="line">        DiagMgr-&gt;MonitorCallback(event, DiagMgr-&gt;MonitorContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �¼�������</span></span><br><span class="line">VOID <span class="title function_">RtsPciAnalyzeDiagnosticEvents</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDIAGNOSTIC_MANAGER DiagMgr,</span></span><br><span class="line"><span class="params">    _Out_ PDIAGNOSTIC_ANALYSIS Analysis</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PLIST_ENTRY entry;</span><br><span class="line">    ULONG errorCount = <span class="number">0</span>;</span><br><span class="line">    ULONG warningCount = <span class="number">0</span>;</span><br><span class="line">    ULONG totalIOTime = <span class="number">0</span>;</span><br><span class="line">    ULONG ioCount = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(Analysis, <span class="keyword">sizeof</span>(DIAGNOSTIC_ANALYSIS));</span><br><span class="line">    </span><br><span class="line">    KeAcquireSpinLock(&amp;DiagMgr-&gt;EventLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���������¼����з���</span></span><br><span class="line">    <span class="keyword">for</span> (entry = DiagMgr-&gt;EventList.Flink;</span><br><span class="line">         entry != &amp;DiagMgr-&gt;EventList;</span><br><span class="line">         entry = entry-&gt;Flink) &#123;</span><br><span class="line">        PDIAGNOSTIC_EVENT event = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            DIAGNOSTIC_EVENT,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">switch</span> (event-&gt;Type) &#123;</span><br><span class="line">            <span class="keyword">case</span> DiagEventError:</span><br><span class="line">                errorCount++;</span><br><span class="line">                Analysis-&gt;LastError = event-&gt;Status;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> DiagEventWarning:</span><br><span class="line">                warningCount++;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> DiagEventIO:</span><br><span class="line">                totalIOTime += event-&gt;Data.IO.Duration;</span><br><span class="line">                ioCount++;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> DiagEventPerformance:</span><br><span class="line">                <span class="comment">// ������������</span></span><br><span class="line">                RtsPciAnalyzePerformanceEvent(event, Analysis);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;DiagMgr-&gt;EventLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ͳ������</span></span><br><span class="line">    Analysis-&gt;ErrorRate = (errorCount * <span class="number">100</span>) / DiagMgr-&gt;CurrentEvents;</span><br><span class="line">    Analysis-&gt;WarningRate = (warningCount * <span class="number">100</span>) / DiagMgr-&gt;CurrentEvents;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ioCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        Analysis-&gt;AverageIOTime = totalIOTime / ioCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h3 id="13-3-���Խӿ�ʵ��"><a href="#13-3-���Խӿ�ʵ��" class="headerlink" title="13.3 ���Խӿ�ʵ��"></a>13.3 ���Խӿ�ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �����������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEBUG_COMMAND_HANDLER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    WDFQUEUE DebugQueue;</span><br><span class="line">    WDFWORKITEM DebugWorkItem;</span><br><span class="line">    LIST_ENTRY CommandList;</span><br><span class="line">    KSPIN_LOCK CommandLock;</span><br><span class="line">    KEVENT CommandEvent;</span><br><span class="line">&#125; DEBUG_COMMAND_HANDLER, *PDEBUG_COMMAND_HANDLER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��������ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEBUG_COMMAND</span> &#123;</span></span><br><span class="line">    LIST_ENTRY ListEntry;</span><br><span class="line">    ULONG CommandCode;</span><br><span class="line">    PVOID InputBuffer;</span><br><span class="line">    SIZE_T InputBufferSize;</span><br><span class="line">    PVOID OutputBuffer;</span><br><span class="line">    SIZE_T OutputBufferSize;</span><br><span class="line">    NTSTATUS Status;</span><br><span class="line">    KEVENT CompletionEvent;</span><br><span class="line">&#125; DEBUG_COMMAND, *PDEBUG_COMMAND;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ������������</span></span><br><span class="line">VOID <span class="title function_">RtsPciProcessDebugCommand</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEBUG_COMMAND_HANDLER DebugHandler,</span></span><br><span class="line"><span class="params">    _In_ PDEBUG_COMMAND Command</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (Command-&gt;CommandCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> DEBUG_CMD_DUMP_REGISTERS:</span><br><span class="line">            Command-&gt;Status = RtsPciDumpRegistersDebug(</span><br><span class="line">                DebugHandler-&gt;DevContext,</span><br><span class="line">                Command-&gt;OutputBuffer,</span><br><span class="line">                Command-&gt;OutputBufferSize);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DEBUG_CMD_TRACE_IO:</span><br><span class="line">            Command-&gt;Status = RtsPciConfigureIOTracing(</span><br><span class="line">                DebugHandler-&gt;DevContext,</span><br><span class="line">                Command-&gt;InputBuffer,</span><br><span class="line">                Command-&gt;InputBufferSize);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DEBUG_CMD_TEST_DMA:</span><br><span class="line">            Command-&gt;Status = RtsPciExecuteDMATest(</span><br><span class="line">                DebugHandler-&gt;DevContext,</span><br><span class="line">                Command-&gt;InputBuffer,</span><br><span class="line">                Command-&gt;OutputBuffer);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DEBUG_CMD_ANALYZE_PERFORMANCE:</span><br><span class="line">            Command-&gt;Status = RtsPciAnalyzePerformanceDebug(</span><br><span class="line">                DebugHandler-&gt;DevContext,</span><br><span class="line">                Command-&gt;OutputBuffer,</span><br><span class="line">                Command-&gt;OutputBufferSize);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            Command-&gt;Status = STATUS_INVALID_PARAMETER;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ֪ͨ�������</span></span><br><span class="line">    KeSetEvent(&amp;Command-&gt;CompletionEvent, <span class="number">0</span>, FALSE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ע����Իص�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciRegisterDebugCallback</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ PDEBUG_CALLBACK_ROUTINE CallbackRoutine,</span></span><br><span class="line"><span class="params">    _In_ PVOID Context</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PDEBUG_CALLBACK callback;</span><br><span class="line">    </span><br><span class="line">    callback = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(DEBUG_CALLBACK),</span><br><span class="line">        <span class="string">&#x27;CBPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!callback) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    callback-&gt;CallbackRoutine = CallbackRoutine;</span><br><span class="line">    callback-&gt;Context = Context;</span><br><span class="line">    </span><br><span class="line">    KeAcquireSpinLock(&amp;DevContext-&gt;DebugHandler-&gt;CommandLock, &amp;oldIrql);</span><br><span class="line">    InsertTailList(&amp;DevContext-&gt;DebugHandler-&gt;CallbackList,</span><br><span class="line">                   &amp;callback-&gt;ListEntry);</span><br><span class="line">    KeReleaseSpinLock(&amp;DevContext-&gt;DebugHandler-&gt;CommandLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<p>[���� - ��һ���ֽ���ϸ���ܰ�ȫ�ԺͿɿ�����ǿ]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-47"><a href="#User-47" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-47"><a href="#AI-claude-3-5-sonnet-47" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ����ȫ�ԺͿɿ�����ǿ���֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-13"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-13" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 13"></a>WDF SD Host Controller����ʵ����� - Part 13</h1><h2 id="14-��o�ԺͿɿ�����o"><a href="#14-��o�ԺͿɿ�����o" class="headerlink" title="14. ��ȫ�ԺͿɿ�����ǿ"></a>14. ��ȫ�ԺͿɿ�����ǿ</h2><h3 id="14-1-��o������ʵ��"><a href="#14-1-��o������ʵ��" class="headerlink" title="14.1 ��ȫ������ʵ��"></a>14.1 ��ȫ������ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��ȫ������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">SECURITY_LEVEL</span> &#123;</span></span><br><span class="line">    SecurityLevelLow = <span class="number">0</span>,</span><br><span class="line">    SecurityLevelMedium,</span><br><span class="line">    SecurityLevelHigh,</span><br><span class="line">    SecurityLevelMax</span><br><span class="line">&#125; SECURITY_LEVEL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ȫ��������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SECURITY_POLICY</span> &#123;</span></span><br><span class="line">    SECURITY_LEVEL Level;</span><br><span class="line">    BOOLEAN EnableAccessControl;</span><br><span class="line">    BOOLEAN EnableDataEncryption;</span><br><span class="line">    BOOLEAN EnableCommandValidation;</span><br><span class="line">    BOOLEAN EnableTimeoutProtection;</span><br><span class="line">    ULONG CommandTimeout;        <span class="comment">// ����</span></span><br><span class="line">    ULONG MaxRetryCount;</span><br><span class="line">    ULONG ValidationFlags;</span><br><span class="line">&#125; SECURITY_POLICY, *PSECURITY_POLICY;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ȫ������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SECURITY_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    SECURITY_POLICY Policy;</span><br><span class="line">    KSPIN_LOCK PolicyLock;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ʿ���</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY AccessList;</span><br><span class="line">        KSPIN_LOCK AccessLock;</span><br><span class="line">        BOOLEAN Enabled;</span><br><span class="line">    &#125; AccessControl;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������֤</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG ValidCommandMask;</span><br><span class="line">        ULONG BlockedCommandMask;</span><br><span class="line">        KSPIN_LOCK ValidationLock;</span><br><span class="line">    &#125; CommandValidation;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �������</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG SecurityViolations;</span><br><span class="line">        ULONG ValidationFailures;</span><br><span class="line">        ULONG TimeoutCount;</span><br><span class="line">        LARGE_INTEGER LastViolationTime;</span><br><span class="line">    &#125; Statistics;</span><br><span class="line">&#125; SECURITY_MANAGER, *PSECURITY_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ����ȫ������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeSecurityManager</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PSECURITY_MANAGER secMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���䰲ȫ������</span></span><br><span class="line">    secMgr = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(SECURITY_MANAGER),</span><br><span class="line">        <span class="string">&#x27;SMPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!secMgr) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(secMgr, <span class="keyword">sizeof</span>(SECURITY_MANAGER));</span><br><span class="line">    secMgr-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ�������б�</span></span><br><span class="line">    KeInitializeSpinLock(&amp;secMgr-&gt;PolicyLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;secMgr-&gt;AccessControl.AccessLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;secMgr-&gt;CommandValidation.ValidationLock);</span><br><span class="line">    InitializeListHead(&amp;secMgr-&gt;AccessControl.AccessList);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����Ĭ�ϰ�ȫ����</span></span><br><span class="line">    secMgr-&gt;Policy.Level = SecurityLevelMedium;</span><br><span class="line">    secMgr-&gt;Policy.EnableAccessControl = TRUE;</span><br><span class="line">    secMgr-&gt;Policy.EnableCommandValidation = TRUE;</span><br><span class="line">    secMgr-&gt;Policy.EnableTimeoutProtection = TRUE;</span><br><span class="line">    secMgr-&gt;Policy.CommandTimeout = <span class="number">5000</span>;  <span class="comment">// 5��</span></span><br><span class="line">    secMgr-&gt;Policy.MaxRetryCount = <span class="number">3</span>;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;SecurityManager = secMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="14-2-������֤�ͷ��ʿ���"><a href="#14-2-������֤�ͷ��ʿ���" class="headerlink" title="14.2 ������֤�ͷ��ʿ���"></a>14.2 ������֤�ͷ��ʿ���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ������֤ʵ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciValidateCommand</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PSECURITY_MANAGER SecMgr,</span></span><br><span class="line"><span class="params">    _In_ PSD_COMMAND Command</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �������Ƿ�������֤</span></span><br><span class="line">    <span class="keyword">if</span> (!SecMgr-&gt;Policy.EnableCommandValidation) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeAcquireSpinLock(&amp;SecMgr-&gt;CommandValidation.ValidationLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��������Ƿ���ֹ</span></span><br><span class="line">    <span class="keyword">if</span> (SecMgr-&gt;CommandValidation.BlockedCommandMask &amp; (<span class="number">1</span> &lt;&lt; Command-&gt;Index)) &#123;</span><br><span class="line">        status = STATUS_ACCESS_DENIED;</span><br><span class="line">        InterlockedIncrement(&amp;SecMgr-&gt;Statistics.ValidationFailures);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��֤�������</span></span><br><span class="line">    <span class="keyword">switch</span> (Command-&gt;Index) &#123;</span><br><span class="line">        <span class="keyword">case</span> SD_CMD_APP_CMD:</span><br><span class="line">        <span class="keyword">case</span> SD_CMD_APP_SET_BUS_WIDTH:</span><br><span class="line">            <span class="comment">// ��֤ACMD����</span></span><br><span class="line">            status = RtsPciValidateACMD(SecMgr, Command);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SD_CMD_READ_MULTIPLE_BLOCK:</span><br><span class="line">        <span class="keyword">case</span> SD_CMD_WRITE_MULTIPLE_BLOCK:</span><br><span class="line">            <span class="comment">// ��֤���ݴ�������</span></span><br><span class="line">            status = RtsPciValidateDataTransfer(SecMgr, Command);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> SD_CMD_ERASE_START:</span><br><span class="line">        <span class="keyword">case</span> SD_CMD_ERASE_END:</span><br><span class="line">        <span class="keyword">case</span> SD_CMD_ERASE:</span><br><span class="line">            <span class="comment">// ��֤��������</span></span><br><span class="line">            status = RtsPciValidateEraseCommand(SecMgr, Command);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="built_in">exit</span>:</span><br><span class="line">    KeReleaseSpinLock(&amp;SecMgr-&gt;CommandValidation.ValidationLock, oldIrql);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���ʿ���ʵ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciCheckAccess</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PSECURITY_MANAGER SecMgr,</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_OBJECT DeviceObject,</span></span><br><span class="line"><span class="params">    _In_ ACCESS_MASK DesiredAccess</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    BOOLEAN accessGranted = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �������Ƿ����÷��ʿ���</span></span><br><span class="line">    <span class="keyword">if</span> (!SecMgr-&gt;Policy.EnableAccessControl) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeAcquireSpinLock(&amp;SecMgr-&gt;AccessControl.AccessLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �������б�</span></span><br><span class="line">    PLIST_ENTRY entry;</span><br><span class="line">    <span class="keyword">for</span> (entry = SecMgr-&gt;AccessControl.AccessList.Flink;</span><br><span class="line">         entry != &amp;SecMgr-&gt;AccessControl.AccessList;</span><br><span class="line">         entry = entry-&gt;Flink) &#123;</span><br><span class="line">        PACCESS_ENTRY accessEntry = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            ACCESS_ENTRY,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (RtsPciMatchAccessEntry(accessEntry, DeviceObject, DesiredAccess)) &#123;</span><br><span class="line">            accessGranted = TRUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!accessGranted) &#123;</span><br><span class="line">        status = STATUS_ACCESS_DENIED;</span><br><span class="line">        InterlockedIncrement(&amp;SecMgr-&gt;Statistics.SecurityViolations);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ��¼Υ�����</span></span><br><span class="line">        KeQuerySystemTime(&amp;SecMgr-&gt;Statistics.LastViolationTime);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ֪ͨ��ȫ�¼�</span></span><br><span class="line">        RtsPciNotifySecurityViolation(SecMgr, DeviceObject, DesiredAccess);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;SecMgr-&gt;AccessControl.AccessLock, oldIrql);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="14-3-��ʱ�����ʹ���ָ�"><a href="#14-3-��ʱ�����ʹ���ָ�" class="headerlink" title="14.3 ��ʱ�����ʹ���ָ�"></a>14.3 ��ʱ�����ʹ���ָ�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��ʱ����������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">TIMEOUT_CONTEXT</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    KDPC TimeoutDpc;</span><br><span class="line">    KTIMER TimeoutTimer;</span><br><span class="line">    BOOLEAN TimerActive;</span><br><span class="line">    WDFREQUEST PendingRequest;</span><br><span class="line">    ULONG TimeoutValue;</span><br><span class="line">    PFN_TIMEOUT_CALLBACK TimeoutCallback;</span><br><span class="line">&#125; TIMEOUT_CONTEXT, *PTIMEOUT_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʱ����ʵ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciSetupTimeoutProtection</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ ULONG TimeoutValue,</span></span><br><span class="line"><span class="params">    _In_ PFN_TIMEOUT_CALLBACK TimeoutCallback</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PTIMEOUT_CONTEXT timeoutCtx;</span><br><span class="line">    LARGE_INTEGER dueTime;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �������Ƿ����ó�ʱ����</span></span><br><span class="line">    <span class="keyword">if</span> (!DevContext-&gt;SecurityManager-&gt;Policy.EnableTimeoutProtection) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ����ʱ������</span></span><br><span class="line">    timeoutCtx = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(TIMEOUT_CONTEXT),</span><br><span class="line">        <span class="string">&#x27;TOPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!timeoutCtx) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(timeoutCtx, <span class="keyword">sizeof</span>(TIMEOUT_CONTEXT));</span><br><span class="line">    timeoutCtx-&gt;DevContext = DevContext;</span><br><span class="line">    timeoutCtx-&gt;PendingRequest = Request;</span><br><span class="line">    timeoutCtx-&gt;TimeoutValue = TimeoutValue;</span><br><span class="line">    timeoutCtx-&gt;TimeoutCallback = TimeoutCallback;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʼ��DPC�Ͷ�ʱ��</span></span><br><span class="line">    KeInitializeDpc(</span><br><span class="line">        &amp;timeoutCtx-&gt;TimeoutDpc,</span><br><span class="line">        RtsPciTimeoutDpcRoutine,</span><br><span class="line">        timeoutCtx);</span><br><span class="line">        </span><br><span class="line">    KeInitializeTimer(&amp;timeoutCtx-&gt;TimeoutTimer);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���ó�ʱʱ��</span></span><br><span class="line">    dueTime.QuadPart = Int32x32To64(TimeoutValue, <span class="number">-10000</span>);</span><br><span class="line">    timeoutCtx-&gt;TimerActive = TRUE;</span><br><span class="line">    </span><br><span class="line">    KeSetTimer(</span><br><span class="line">        &amp;timeoutCtx-&gt;TimeoutTimer,</span><br><span class="line">        dueTime,</span><br><span class="line">        &amp;timeoutCtx-&gt;TimeoutDpc);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 5. ���泬ʱ������</span></span><br><span class="line">    WdfRequestSetContext(Request, timeoutCtx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʱDPC����</span></span><br><span class="line">VOID <span class="title function_">RtsPciTimeoutDpcRoutine</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PKDPC Dpc,</span></span><br><span class="line"><span class="params">    _In_ PVOID DeferredContext,</span></span><br><span class="line"><span class="params">    _In_ PVOID SystemArgument1,</span></span><br><span class="line"><span class="params">    _In_ PVOID SystemArgument2</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PTIMEOUT_CONTEXT timeoutCtx = (PTIMEOUT_CONTEXT)DeferredContext;</span><br><span class="line">    PSECURITY_MANAGER secMgr = timeoutCtx-&gt;DevContext-&gt;SecurityManager;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��������Ƿ���Ȼ��Ч</span></span><br><span class="line">    <span class="keyword">if</span> (!timeoutCtx-&gt;TimerActive) &#123;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ������ʱ</span></span><br><span class="line">    InterlockedIncrement(&amp;secMgr-&gt;Statistics.TimeoutCount);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (timeoutCtx-&gt;TimeoutCallback) &#123;</span><br><span class="line">        timeoutCtx-&gt;TimeoutCallback(</span><br><span class="line">            timeoutCtx-&gt;DevContext,</span><br><span class="line">            timeoutCtx-&gt;PendingRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ȡ������</span></span><br><span class="line">    WdfRequestComplete(</span><br><span class="line">        timeoutCtx-&gt;PendingRequest,</span><br><span class="line">        STATUS_TIMEOUT);</span><br><span class="line">        </span><br><span class="line">cleanup:</span><br><span class="line">    ExFreePool(timeoutCtx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����ָ�ʵ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciHandleSecurityError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PSECURITY_MANAGER SecMgr,</span></span><br><span class="line"><span class="params">    _In_ NTSTATUS ErrorStatus,</span></span><br><span class="line"><span class="params">    _In_ ULONG ErrorFlags</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (ErrorStatus) &#123;</span><br><span class="line">        <span class="keyword">case</span> STATUS_ACCESS_DENIED:</span><br><span class="line">            <span class="comment">// ��������Υ��</span></span><br><span class="line">            status = RtsPciHandleAccessViolation(SecMgr, ErrorFlags);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> STATUS_TIMEOUT:</span><br><span class="line">            <span class="comment">// ������ʱ����</span></span><br><span class="line">            status = RtsPciHandleTimeout(SecMgr, ErrorFlags);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> STATUS_INVALID_PARAMETER:</span><br><span class="line">            <span class="comment">// ����������֤ʧ��</span></span><br><span class="line">            status = RtsPciHandleValidationFailure(SecMgr, ErrorFlags);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��¼����ͳ��</span></span><br><span class="line">    RtsPciUpdateSecurityStatistics(SecMgr, ErrorStatus);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>[���� - ��һ���ֽ���ϸ�������ܼ�غ��Ż�]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-48"><a href="#User-48" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-48"><a href="#AI-claude-3-5-sonnet-48" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ�����ܼ�غ��Ż����֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-14"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-14" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 14"></a>WDF SD Host Controller����ʵ����� - Part 14</h1><h2 id="15-���ܼ�غ��Z�"><a href="#15-���ܼ�غ��Z�" class="headerlink" title="15. ���ܼ�غ��Ż�"></a>15. ���ܼ�غ��Ż�</h2><h3 id="15-1-���ܼ����ʵ��"><a href="#15-1-���ܼ����ʵ��" class="headerlink" title="15.1 ���ܼ����ʵ��"></a>15.1 ���ܼ����ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ���ܼ���������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PERFORMANCE_COUNTERS</span> &#123;</span></span><br><span class="line">    <span class="comment">// IOͳ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LARGE_INTEGER TotalReadBytes;</span><br><span class="line">        LARGE_INTEGER TotalWriteBytes;</span><br><span class="line">        ULONG ReadCount;</span><br><span class="line">        ULONG WriteCount;</span><br><span class="line">        ULONG ReadErrors;</span><br><span class="line">        ULONG WriteErrors;</span><br><span class="line">    &#125; IO;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ӳ�ͳ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG AverageReadLatency;   <span class="comment">// ΢��</span></span><br><span class="line">        ULONG AverageWriteLatency;</span><br><span class="line">        ULONG MaxReadLatency;</span><br><span class="line">        ULONG MaxWriteLatency;</span><br><span class="line">        ULONG MinReadLatency;</span><br><span class="line">        ULONG MinWriteLatency;</span><br><span class="line">    &#125; Latency;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMAͳ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG DmaTransferCount;</span><br><span class="line">        ULONG DmaErrors;</span><br><span class="line">        LARGE_INTEGER TotalDmaBytes;</span><br><span class="line">        ULONG AverageDmaTime;</span><br><span class="line">    &#125; DMA;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ͳ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG AverageQueueDepth;</span><br><span class="line">        ULONG MaxQueueDepth;</span><br><span class="line">        ULONG QueueOverflows;</span><br><span class="line">        ULONG RequestTimeouts;</span><br><span class="line">    &#125; Queue;</span><br><span class="line">&#125; PERFORMANCE_COUNTERS, *PPERFORMANCE_COUNTERS;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���ܼ����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PERFORMANCE_MONITOR</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    PERFORMANCE_COUNTERS Counters;</span><br><span class="line">    KSPIN_LOCK CounterLock;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ܲ���</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        KTIMER SamplingTimer;</span><br><span class="line">        KDPC SamplingDpc;</span><br><span class="line">        ULONG SamplingInterval;    <span class="comment">// ����</span></span><br><span class="line">        BOOLEAN SamplingEnabled;</span><br><span class="line">    &#125; Sampling;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������ֵ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG LatencyThreshold;    <span class="comment">// ΢��</span></span><br><span class="line">        ULONG QueueDepthThreshold;</span><br><span class="line">        ULONG ErrorRateThreshold;  <span class="comment">// �ٷֱ�</span></span><br><span class="line">        BOOLEAN ThresholdEnabled;</span><br><span class="line">    &#125; Thresholds;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������־</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY LogEntries;</span><br><span class="line">        KSPIN_LOCK LogLock;</span><br><span class="line">        ULONG MaxLogEntries;</span><br><span class="line">        ULONG CurrentLogEntries;</span><br><span class="line">    &#125; Log;</span><br><span class="line">&#125; PERFORMANCE_MONITOR, *PPERFORMANCE_MONITOR;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ�����ܼ����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializePerformanceMonitor</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PPERFORMANCE_MONITOR perfMon;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �������ܼ����</span></span><br><span class="line">    perfMon = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(PERFORMANCE_MONITOR),</span><br><span class="line">        <span class="string">&#x27;PMPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!perfMon) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(perfMon, <span class="keyword">sizeof</span>(PERFORMANCE_MONITOR));</span><br><span class="line">    perfMon-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ�������б�</span></span><br><span class="line">    KeInitializeSpinLock(&amp;perfMon-&gt;CounterLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;perfMon-&gt;Log.LogLock);</span><br><span class="line">    InitializeListHead(&amp;perfMon-&gt;Log.LogEntries);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʼ��������ʱ����DPC</span></span><br><span class="line">    KeInitializeTimer(&amp;perfMon-&gt;Sampling.SamplingTimer);</span><br><span class="line">    KeInitializeDpc(</span><br><span class="line">        &amp;perfMon-&gt;Sampling.SamplingDpc,</span><br><span class="line">        RtsPciPerformanceSamplingDpc,</span><br><span class="line">        perfMon);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 4. ����Ĭ������</span></span><br><span class="line">    perfMon-&gt;Sampling.SamplingInterval = <span class="number">1000</span>;  <span class="comment">// 1��</span></span><br><span class="line">    perfMon-&gt;Sampling.SamplingEnabled = TRUE;</span><br><span class="line">    perfMon-&gt;Thresholds.LatencyThreshold = <span class="number">100000</span>;  <span class="comment">// 100ms</span></span><br><span class="line">    perfMon-&gt;Thresholds.QueueDepthThreshold = <span class="number">32</span>;</span><br><span class="line">    perfMon-&gt;Thresholds.ErrorRateThreshold = <span class="number">5</span>;     <span class="comment">// 5%</span></span><br><span class="line">    perfMon-&gt;Thresholds.ThresholdEnabled = TRUE;</span><br><span class="line">    perfMon-&gt;Log.MaxLogEntries = <span class="number">1000</span>;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;PerformanceMonitor = perfMon;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. �������ܲ���</span></span><br><span class="line">    <span class="keyword">if</span> (perfMon-&gt;Sampling.SamplingEnabled) &#123;</span><br><span class="line">        RtsPciStartPerformanceSampling(perfMon);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="15-2-�������ݲɼ��ͷ���"><a href="#15-2-�������ݲɼ��ͷ���" class="headerlink" title="15.2 �������ݲɼ��ͷ���"></a>15.2 �������ݲɼ��ͷ���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ���ܲ���DPC</span></span><br><span class="line">VOID <span class="title function_">RtsPciPerformanceSamplingDpc</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PKDPC Dpc,</span></span><br><span class="line"><span class="params">    _In_ PVOID DeferredContext,</span></span><br><span class="line"><span class="params">    _In_ PVOID SystemArgument1,</span></span><br><span class="line"><span class="params">    _In_ PVOID SystemArgument2</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PPERFORMANCE_MONITOR perfMon = (PPERFORMANCE_MONITOR)DeferredContext;</span><br><span class="line">    PERFORMANCE_SAMPLE sample = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �ռ���ǰ��������</span></span><br><span class="line">    KeAcquireSpinLock(&amp;perfMon-&gt;CounterLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// IO����</span></span><br><span class="line">    sample.ReadThroughput = </span><br><span class="line">        (perfMon-&gt;Counters.IO.TotalReadBytes.QuadPart -</span><br><span class="line">         perfMon-&gt;LastSample.TotalReadBytes) / </span><br><span class="line">        (perfMon-&gt;Sampling.SamplingInterval / <span class="number">1000</span>);</span><br><span class="line">         </span><br><span class="line">    sample.WriteThroughput = </span><br><span class="line">        (perfMon-&gt;Counters.IO.TotalWriteBytes.QuadPart -</span><br><span class="line">         perfMon-&gt;LastSample.TotalWriteBytes) / </span><br><span class="line">        (perfMon-&gt;Sampling.SamplingInterval / <span class="number">1000</span>);</span><br><span class="line">         </span><br><span class="line">    <span class="comment">// �ӳ�����</span></span><br><span class="line">    sample.CurrentReadLatency = perfMon-&gt;Counters.Latency.AverageReadLatency;</span><br><span class="line">    sample.CurrentWriteLatency = perfMon-&gt;Counters.Latency.AverageWriteLatency;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">    sample.CurrentQueueDepth = </span><br><span class="line">        WdfIoQueueGetCurrentDepth(perfMon-&gt;DevContext-&gt;IoQueue);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ������</span></span><br><span class="line">    sample.ErrorRate = </span><br><span class="line">        ((perfMon-&gt;Counters.IO.ReadErrors + </span><br><span class="line">          perfMon-&gt;Counters.IO.WriteErrors) * <span class="number">100</span>) /</span><br><span class="line">        (perfMon-&gt;Counters.IO.ReadCount + </span><br><span class="line">         perfMon-&gt;Counters.IO.WriteCount);</span><br><span class="line">         </span><br><span class="line">    KeReleaseSpinLock(&amp;perfMon-&gt;CounterLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ������������</span></span><br><span class="line">    RtsPciAnalyzePerformanceSample(perfMon, &amp;sample);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��¼������־</span></span><br><span class="line">    RtsPciLogPerformanceSample(perfMon, &amp;sample);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���������ֵ</span></span><br><span class="line">    <span class="keyword">if</span> (perfMon-&gt;Thresholds.ThresholdEnabled) &#123;</span><br><span class="line">        RtsPciCheckPerformanceThresholds(perfMon, &amp;sample);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. �����ϴβ�������</span></span><br><span class="line">    perfMon-&gt;LastSample = sample;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. �������ö�ʱ��</span></span><br><span class="line">    <span class="keyword">if</span> (perfMon-&gt;Sampling.SamplingEnabled) &#123;</span><br><span class="line">        LARGE_INTEGER dueTime;</span><br><span class="line">        dueTime.QuadPart = Int32x32To64(</span><br><span class="line">            <span class="number">-10000</span>,  <span class="comment">// 100ns units</span></span><br><span class="line">            perfMon-&gt;Sampling.SamplingInterval);</span><br><span class="line">            </span><br><span class="line">        KeSetTimer(</span><br><span class="line">            &amp;perfMon-&gt;Sampling.SamplingTimer,</span><br><span class="line">            dueTime,</span><br><span class="line">            &amp;perfMon-&gt;Sampling.SamplingDpc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �������ݷ���</span></span><br><span class="line">VOID <span class="title function_">RtsPciAnalyzePerformanceSample</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PPERFORMANCE_MONITOR PerfMon,</span></span><br><span class="line"><span class="params">    _In_ PPERFORMANCE_SAMPLE Sample</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. ����IO����</span></span><br><span class="line">    <span class="keyword">if</span> (Sample-&gt;ReadThroughput &lt; </span><br><span class="line">        (PerfMon-&gt;LastSample.ReadThroughput * <span class="number">80</span> / <span class="number">100</span>)) &#123;</span><br><span class="line">        <span class="comment">// �������������½�</span></span><br><span class="line">        RtsPciHandlePerformanceDegradation(</span><br><span class="line">            PerfMon,</span><br><span class="line">            PerformanceMetricReadThroughput);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (Sample-&gt;WriteThroughput &lt; </span><br><span class="line">        (PerfMon-&gt;LastSample.WriteThroughput * <span class="number">80</span> / <span class="number">100</span>)) &#123;</span><br><span class="line">        <span class="comment">// д�����������½�</span></span><br><span class="line">        RtsPciHandlePerformanceDegradation(</span><br><span class="line">            PerfMon,</span><br><span class="line">            PerformanceMetricWriteThroughput);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����ӳ�����</span></span><br><span class="line">    <span class="keyword">if</span> (Sample-&gt;CurrentReadLatency &gt; </span><br><span class="line">        (PerfMon-&gt;LastSample.CurrentReadLatency * <span class="number">150</span> / <span class="number">100</span>)) &#123;</span><br><span class="line">        <span class="comment">// ���ӳ���������</span></span><br><span class="line">        RtsPciHandleLatencyIncrease(</span><br><span class="line">            PerfMon,</span><br><span class="line">            PerformanceMetricReadLatency);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��������״̬</span></span><br><span class="line">    <span class="keyword">if</span> (Sample-&gt;CurrentQueueDepth &gt;= </span><br><span class="line">        PerfMon-&gt;Thresholds.QueueDepthThreshold) &#123;</span><br><span class="line">        <span class="comment">// ����ӵ��</span></span><br><span class="line">        RtsPciHandleQueueCongestion(PerfMon);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����������</span></span><br><span class="line">    <span class="keyword">if</span> (Sample-&gt;ErrorRate &gt; PerfMon-&gt;Thresholds.ErrorRateThreshold) &#123;</span><br><span class="line">        <span class="comment">// �����ʹ���</span></span><br><span class="line">        RtsPciHandleHighErrorRate(PerfMon);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="15-3-�����Z�����"><a href="#15-3-�����Z�����" class="headerlink" title="15.3 �����Ż�����"></a>15.3 �����Ż�����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �����Ż�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PERFORMANCE_OPTIMIZATION_CONFIG</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableReadAhead;</span><br><span class="line">        BOOLEAN EnableWriteCoalescing;</span><br><span class="line">        ULONG ReadAheadSize;</span><br><span class="line">        ULONG WriteCoalescingSize;</span><br><span class="line">    &#125; IO;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableDynamicClocking;</span><br><span class="line">        BOOLEAN EnablePowerOptimization;</span><br><span class="line">        ULONG MinClockFrequency;</span><br><span class="line">        ULONG MaxClockFrequency;</span><br><span class="line">    &#125; Power;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableLoadBalancing;</span><br><span class="line">        BOOLEAN EnableQueueOptimization;</span><br><span class="line">        ULONG OptimalQueueDepth;</span><br><span class="line">        ULONG LoadBalanceInterval;</span><br><span class="line">    &#125; Queue;</span><br><span class="line">&#125; PERFORMANCE_OPTIMIZATION_CONFIG, *PPERFORMANCE_OPTIMIZATION_CONFIG;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �����Ż�������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PERFORMANCE_OPTIMIZER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    PERFORMANCE_OPTIMIZATION_CONFIG Config;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ǰ�Ż�״̬</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG CurrentClockFrequency;</span><br><span class="line">        ULONG CurrentQueueDepth;</span><br><span class="line">        BOOLEAN ReadAheadActive;</span><br><span class="line">        BOOLEAN WriteCoalescingActive;</span><br><span class="line">    &#125; CurrentState;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �Ż�����</span></span><br><span class="line">    KSPIN_LOCK OptimizationLock;</span><br><span class="line">    KTIMER OptimizationTimer;</span><br><span class="line">    KDPC OptimizationDpc;</span><br><span class="line">&#125; PERFORMANCE_OPTIMIZER, *PPERFORMANCE_OPTIMIZER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ӧ�������Ż�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciApplyPerformanceOptimizations</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PPERFORMANCE_OPTIMIZER Optimizer,</span></span><br><span class="line"><span class="params">    _In_ PPERFORMANCE_SAMPLE Sample</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    KeAcquireSpinLock(&amp;Optimizer-&gt;OptimizationLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. IO�Ż�</span></span><br><span class="line">    <span class="keyword">if</span> (Optimizer-&gt;Config.IO.EnableReadAhead) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Sample-&gt;ReadThroughput &gt; </span><br><span class="line">            (Sample-&gt;WriteThroughput * <span class="number">2</span>)) &#123;</span><br><span class="line">            <span class="comment">// ���ܼ��͹������أ�����Ԥ��</span></span><br><span class="line">            status = RtsPciAdjustReadAhead(</span><br><span class="line">                Optimizer,</span><br><span class="line">                Optimizer-&gt;Config.IO.ReadAheadSize * <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (Optimizer-&gt;Config.IO.EnableWriteCoalescing) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Sample-&gt;CurrentQueueDepth &gt; </span><br><span class="line">            Optimizer-&gt;Config.Queue.OptimalQueueDepth) &#123;</span><br><span class="line">            <span class="comment">// ����ӵ��������д�ϲ�</span></span><br><span class="line">            status = RtsPciEnableWriteCoalescing(</span><br><span class="line">                Optimizer,</span><br><span class="line">                Optimizer-&gt;Config.IO.WriteCoalescingSize);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ʱ��Ƶ���Ż�</span></span><br><span class="line">    <span class="keyword">if</span> (Optimizer-&gt;Config.Power.EnableDynamicClocking) &#123;</span><br><span class="line">        ULONG targetFreq = RtsPciCalculateOptimalFrequency(</span><br><span class="line">            Optimizer,</span><br><span class="line">            Sample);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (targetFreq != Optimizer-&gt;CurrentState.CurrentClockFrequency) &#123;</span><br><span class="line">            status = RtsPciSetClockFrequency(</span><br><span class="line">                Optimizer-&gt;DevContext,</span><br><span class="line">                targetFreq);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">                Optimizer-&gt;CurrentState.CurrentClockFrequency = targetFreq;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �����Ż�</span></span><br><span class="line">    <span class="keyword">if</span> (Optimizer-&gt;Config.Queue.EnableQueueOptimization) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Sample-&gt;CurrentQueueDepth &gt; </span><br><span class="line">            Optimizer-&gt;Config.Queue.OptimalQueueDepth) &#123;</span><br><span class="line">            <span class="comment">// �����������</span></span><br><span class="line">            status = RtsPciAdjustQueueDepth(</span><br><span class="line">                Optimizer,</span><br><span class="line">                Optimizer-&gt;Config.Queue.OptimalQueueDepth);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;Optimizer-&gt;OptimizationLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>[���� - ��һ���ֽ���ϸ���ܸ߼�DMA����]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-49"><a href="#User-49" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-49"><a href="#AI-claude-3-5-sonnet-49" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼�DMA�������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-15"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-15" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 15"></a>WDF SD Host Controller����ʵ����� - Part 15</h1><h2 id="16-�߼�DMA����"><a href="#16-�߼�DMA����" class="headerlink" title="16. �߼�DMA����"></a>16. �߼�DMA����</h2><h3 id="16-1-DMA������ʵ��"><a href="#16-1-DMA������ʵ��" class="headerlink" title="16.1 DMA������ʵ��"></a>16.1 DMA������ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DMA����ģʽ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">DMA_TRANSFER_MODE</span> &#123;</span></span><br><span class="line">    DmaTransferModeSingle = <span class="number">0</span>,</span><br><span class="line">    DmaTransferModeMultiple,</span><br><span class="line">    DmaTransferModeScatter,</span><br><span class="line">    DmaTransferModeGather</span><br><span class="line">&#125; DMA_TRANSFER_MODE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DMA�������ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DMA_DESCRIPTOR</span> &#123;</span></span><br><span class="line">    PHYSICAL_ADDRESS PhysicalAddress;</span><br><span class="line">    ULONG Length;</span><br><span class="line">    ULONG Flags;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">DMA_DESCRIPTOR</span>* <span class="title">NextDescriptor</span>;</span></span><br><span class="line">    PVOID Context;</span><br><span class="line">&#125; DMA_DESCRIPTOR, *PDMA_DESCRIPTOR;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DMA����������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DMA_TRANSFER_CONTEXT</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    WDFREQUEST Request;</span><br><span class="line">    DMA_TRANSFER_MODE Mode;</span><br><span class="line">    PDMA_DESCRIPTOR FirstDescriptor;</span><br><span class="line">    PDMA_DESCRIPTOR CurrentDescriptor;</span><br><span class="line">    ULONG TotalLength;</span><br><span class="line">    ULONG TransferredLength;</span><br><span class="line">    BOOLEAN IsRead;</span><br><span class="line">    KEVENT CompletionEvent;</span><br><span class="line">    PFN_DMA_COMPLETION_ROUTINE CompletionRoutine;</span><br><span class="line">    PVOID CompletionContext;</span><br><span class="line">&#125; DMA_TRANSFER_CONTEXT, *PDMA_TRANSFER_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DMA������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DMA_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    WDFDMAENABLER DmaEnabler;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA����</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG MaxTransferLength;</span><br><span class="line">        ULONG AlignmentRequirement;</span><br><span class="line">        ULONG MaximumScatterGatherElements;</span><br><span class="line">        BOOLEAN DoubleBufferingEnabled;</span><br><span class="line">    &#125; Configuration;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMAͳ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG TotalTransfers;</span><br><span class="line">        ULONG FailedTransfers;</span><br><span class="line">        LARGE_INTEGER TotalBytesTransferred;</span><br><span class="line">        ULONG ActiveTransfers;</span><br><span class="line">    &#125; Statistics;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA��Դ����</span></span><br><span class="line">    LIST_ENTRY FreeDescriptorList;</span><br><span class="line">    LIST_ENTRY ActiveTransferList;</span><br><span class="line">    KSPIN_LOCK TransferLock;</span><br><span class="line">    NPAGED_LOOKASIDE_LIST DescriptorPool;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// DMA�жϴ���</span></span><br><span class="line">    WDFINTERRUPT DmaInterrupt;</span><br><span class="line">    BOOLEAN InterruptEnabled;</span><br><span class="line">&#125; DMA_MANAGER, *PDMA_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ��DMA������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeDmaManager</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PDMA_MANAGER dmaManager;</span><br><span class="line">    WDF_DMA_ENABLER_CONFIG dmaConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����DMA������</span></span><br><span class="line">    dmaManager = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(DMA_MANAGER),</span><br><span class="line">        <span class="string">&#x27;DMPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!dmaManager) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(dmaManager, <span class="keyword">sizeof</span>(DMA_MANAGER));</span><br><span class="line">    dmaManager-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ��DMAʹ����</span></span><br><span class="line">    WDF_DMA_ENABLER_CONFIG_INIT(</span><br><span class="line">        &amp;dmaConfig,</span><br><span class="line">        WdfDmaProfileScatterGather,</span><br><span class="line">        DevContext-&gt;Capabilities.MaxTransferLength);</span><br><span class="line">        </span><br><span class="line">    status = WdfDmaEnablerCreate(</span><br><span class="line">        DevContext-&gt;Device,</span><br><span class="line">        &amp;dmaConfig,</span><br><span class="line">        WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">        &amp;dmaManager-&gt;DmaEnabler);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʼ����Դ����</span></span><br><span class="line">    InitializeListHead(&amp;dmaManager-&gt;FreeDescriptorList);</span><br><span class="line">    InitializeListHead(&amp;dmaManager-&gt;ActiveTransferList);</span><br><span class="line">    KeInitializeSpinLock(&amp;dmaManager-&gt;TransferLock);</span><br><span class="line">    </span><br><span class="line">    ExInitializeNPagedLookasideList(</span><br><span class="line">        &amp;dmaManager-&gt;DescriptorPool,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="keyword">sizeof</span>(DMA_DESCRIPTOR),</span><br><span class="line">        <span class="string">&#x27;DDPR&#x27;</span>,</span><br><span class="line">        <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 4. ����DMA����</span></span><br><span class="line">    dmaManager-&gt;Configuration.MaxTransferLength = </span><br><span class="line">        DevContext-&gt;Capabilities.MaxTransferLength;</span><br><span class="line">    dmaManager-&gt;Configuration.AlignmentRequirement = </span><br><span class="line">        DevContext-&gt;Capabilities.AlignmentRequirement;</span><br><span class="line">    dmaManager-&gt;Configuration.MaximumScatterGatherElements = </span><br><span class="line">        DevContext-&gt;Capabilities.MaxScatterGatherElements;</span><br><span class="line">    dmaManager-&gt;Configuration.DoubleBufferingEnabled = TRUE;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;DmaManager = dmaManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">cleanup:</span><br><span class="line">    <span class="keyword">if</span> (dmaManager) &#123;</span><br><span class="line">        ExFreePool(dmaManager);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






<h3 id="16-2-DMA�������"><a href="#16-2-DMA�������" class="headerlink" title="16.2 DMA�������"></a>16.2 DMA�������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ׼��DMA����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciPrepareDmaTransfer</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDMA_MANAGER DmaManager,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ DMA_TRANSFER_MODE Mode,</span></span><br><span class="line"><span class="params">    _In_ BOOLEAN IsRead</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PDMA_TRANSFER_CONTEXT transferCtx;</span><br><span class="line">    WDFMEMORY requestMemory;</span><br><span class="line">    WDF_DMA_DIRECTION direction;</span><br><span class="line">    SIZE_T length;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��������������</span></span><br><span class="line">    transferCtx = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(DMA_TRANSFER_CONTEXT),</span><br><span class="line">        <span class="string">&#x27;DTPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!transferCtx) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(transferCtx, <span class="keyword">sizeof</span>(DMA_TRANSFER_CONTEXT));</span><br><span class="line">    transferCtx-&gt;DevContext = DmaManager-&gt;DevContext;</span><br><span class="line">    transferCtx-&gt;Request = Request;</span><br><span class="line">    transferCtx-&gt;Mode = Mode;</span><br><span class="line">    transferCtx-&gt;IsRead = IsRead;</span><br><span class="line">    KeInitializeEvent(&amp;transferCtx-&gt;CompletionEvent, </span><br><span class="line">                     NotificationEvent, </span><br><span class="line">                     FALSE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ȡ�����ڴ�</span></span><br><span class="line">    status = WdfRequestRetrieveOutputMemory(Request, &amp;requestMemory);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    length = WdfMemoryGetLength(requestMemory);</span><br><span class="line">    direction = IsRead ? WdfDmaDirectionReadFromDevice : </span><br><span class="line">                        WdfDmaDirectionWriteToDevice;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����DMA��������</span></span><br><span class="line">    status = RtsPciBuildDmaDescriptors(</span><br><span class="line">        DmaManager,</span><br><span class="line">        transferCtx,</span><br><span class="line">        requestMemory,</span><br><span class="line">        length,</span><br><span class="line">        direction);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���ӵ�������б�</span></span><br><span class="line">    ExInterlockedInsertTailList(</span><br><span class="line">        &amp;DmaManager-&gt;ActiveTransferList,</span><br><span class="line">        &amp;transferCtx-&gt;ListEntry,</span><br><span class="line">        &amp;DmaManager-&gt;TransferLock);</span><br><span class="line">        </span><br><span class="line">    InterlockedIncrement(&amp;DmaManager-&gt;Statistics.ActiveTransfers);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����DMA����</span></span><br><span class="line">    status = RtsPciStartDmaTransfer(DmaManager, transferCtx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">    </span><br><span class="line">cleanup:</span><br><span class="line">    <span class="keyword">if</span> (transferCtx) &#123;</span><br><span class="line">        RtsPciFreeDmaTransferContext(DmaManager, transferCtx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DMA������ɴ���</span></span><br><span class="line">VOID <span class="title function_">RtsPciDmaTransferComplete</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDMA_MANAGER DmaManager,</span></span><br><span class="line"><span class="params">    _In_ PDMA_TRANSFER_CONTEXT TransferCtx,</span></span><br><span class="line"><span class="params">    _In_ NTSTATUS CompletionStatus</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����ͳ����Ϣ</span></span><br><span class="line">    InterlockedDecrement(&amp;DmaManager-&gt;Statistics.ActiveTransfers);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(CompletionStatus)) &#123;</span><br><span class="line">        InterlockedIncrement(&amp;DmaManager-&gt;Statistics.TotalTransfers);</span><br><span class="line">        InterlockedAdd64(</span><br><span class="line">            &amp;DmaManager-&gt;Statistics.TotalBytesTransferred.QuadPart,</span><br><span class="line">            TransferCtx-&gt;TotalLength);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        InterlockedIncrement(&amp;DmaManager-&gt;Statistics.FailedTransfers);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �ӻ�б��Ƴ�</span></span><br><span class="line">    KeAcquireSpinLock(&amp;DmaManager-&gt;TransferLock, &amp;oldIrql);</span><br><span class="line">    RemoveEntryList(&amp;TransferCtx-&gt;ListEntry);</span><br><span class="line">    KeReleaseSpinLock(&amp;DmaManager-&gt;TransferLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ������ɻص�</span></span><br><span class="line">    <span class="keyword">if</span> (TransferCtx-&gt;CompletionRoutine) &#123;</span><br><span class="line">        TransferCtx-&gt;CompletionRoutine(</span><br><span class="line">            TransferCtx-&gt;DevContext,</span><br><span class="line">            TransferCtx-&gt;Request,</span><br><span class="line">            CompletionStatus,</span><br><span class="line">            TransferCtx-&gt;CompletionContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �ͷ���Դ</span></span><br><span class="line">    RtsPciFreeDmaTransferContext(DmaManager, TransferCtx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ��������¼�</span></span><br><span class="line">    KeSetEvent(&amp;TransferCtx-&gt;CompletionEvent, <span class="number">0</span>, FALSE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






<h3 id="16-3-DMA�жϴ���"><a href="#16-3-DMA�жϴ���" class="headerlink" title="16.3 DMA�жϴ���"></a>16.3 DMA�жϴ���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DMA�жϷ�������</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciDmaInterruptIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ ULONG MessageID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDMA_MANAGER dmaManager;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    BOOLEAN handled = FALSE;</span><br><span class="line">    ULONG dmaStatus;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(WdfInterruptGetDevice(Interrupt));</span><br><span class="line">    dmaManager = devContext-&gt;DmaManager;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡDMA״̬</span></span><br><span class="line">    dmaStatus = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + DMA_STATUS_REG);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!(dmaStatus &amp; DMA_STATUS_INTERRUPT)) &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����ж�״̬</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + DMA_STATUS_REG,</span><br><span class="line">        dmaStatus);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. ���DMA����</span></span><br><span class="line">    <span class="keyword">if</span> (dmaStatus &amp; DMA_STATUS_ERROR) &#123;</span><br><span class="line">        RtsPciHandleDmaError(dmaManager, dmaStatus);</span><br><span class="line">        handled = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ��鴫�����</span></span><br><span class="line">    <span class="keyword">if</span> (dmaStatus &amp; DMA_STATUS_COMPLETE) &#123;</span><br><span class="line">        RtsPciHandleDmaComplete(dmaManager, dmaStatus);</span><br><span class="line">        handled = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DMA������</span></span><br><span class="line">VOID <span class="title function_">RtsPciHandleDmaError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDMA_MANAGER DmaManager,</span></span><br><span class="line"><span class="params">    _In_ ULONG ErrorStatus</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PLIST_ENTRY entry;</span><br><span class="line">    PDMA_TRANSFER_CONTEXT transferCtx;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ֹͣ����DMA����</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        DmaManager-&gt;DevContext-&gt;RegisterBase + DMA_CONTROL_REG,</span><br><span class="line">        DMA_CONTROL_STOP);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. �������л����</span></span><br><span class="line">    KeAcquireSpinLock(&amp;DmaManager-&gt;TransferLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (entry = DmaManager-&gt;ActiveTransferList.Flink;</span><br><span class="line">         entry != &amp;DmaManager-&gt;ActiveTransferList;</span><br><span class="line">         entry = entry-&gt;Flink) &#123;</span><br><span class="line">        transferCtx = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            DMA_TRANSFER_CONTEXT,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// ��ɴ��䣬�������</span></span><br><span class="line">        RtsPciDmaTransferComplete(</span><br><span class="line">            DmaManager,</span><br><span class="line">            transferCtx,</span><br><span class="line">            STATUS_DEVICE_DATA_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;DmaManager-&gt;TransferLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����DMA������</span></span><br><span class="line">    RtsPciResetDmaController(DmaManager);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DMA��ɴ���</span></span><br><span class="line">VOID <span class="title function_">RtsPciHandleDmaComplete</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDMA_MANAGER DmaManager,</span></span><br><span class="line"><span class="params">    _In_ ULONG Status</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PLIST_ENTRY entry;</span><br><span class="line">    PDMA_TRANSFER_CONTEXT transferCtx;</span><br><span class="line">    ULONG completedLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ��ɵĴ��䳤��</span></span><br><span class="line">    completedLength = READ_REGISTER_ULONG(</span><br><span class="line">        DmaManager-&gt;DevContext-&gt;RegisterBase + DMA_TRANSFERRED_REG);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. ���Ҷ�Ӧ�Ĵ���������</span></span><br><span class="line">    KeAcquireSpinLock(&amp;DmaManager-&gt;TransferLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    entry = DmaManager-&gt;ActiveTransferList.Flink;</span><br><span class="line">    <span class="keyword">if</span> (entry != &amp;DmaManager-&gt;ActiveTransferList) &#123;</span><br><span class="line">        transferCtx = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            DMA_TRANSFER_CONTEXT,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// ���´��䳤��</span></span><br><span class="line">        transferCtx-&gt;TransferredLength += completedLength;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����Ƿ�������д���</span></span><br><span class="line">        <span class="keyword">if</span> (transferCtx-&gt;TransferredLength &gt;= transferCtx-&gt;TotalLength) &#123;</span><br><span class="line">            RtsPciDmaTransferComplete(</span><br><span class="line">                DmaManager,</span><br><span class="line">                transferCtx,</span><br><span class="line">                STATUS_SUCCESS);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ������һ��������</span></span><br><span class="line">            RtsPciStartNextDmaDescriptor(DmaManager, transferCtx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;DmaManager-&gt;TransferLock, oldIrql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






<p>[���� - ��һ���ֽ���ϸ���ܸ߼���Դ����]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-50"><a href="#User-50" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-50"><a href="#AI-claude-3-5-sonnet-50" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼���Դ�������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-16"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-16" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 16"></a>WDF SD Host Controller����ʵ����� - Part 16</h1><h2 id="17-�߼���Դ����"><a href="#17-�߼���Դ����" class="headerlink" title="17. �߼���Դ����"></a>17. �߼���Դ����</h2><h3 id="17-1-��Դ���Թ�����ʵ��"><a href="#17-1-��Դ���Թ�����ʵ��" class="headerlink" title="17.1 ��Դ���Թ�����ʵ��"></a>17.1 ��Դ���Թ�����ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��Դ״̬����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">DEVICE_POWER_STATE_EX</span> &#123;</span></span><br><span class="line">    PowerStateD0Active = <span class="number">0</span>,    <span class="comment">// ��ȫ����״̬</span></span><br><span class="line">    PowerStateD0Idle,          <span class="comment">// ����״̬</span></span><br><span class="line">    PowerStateD1Light,         <span class="comment">// ���˯��</span></span><br><span class="line">    PowerStateD2Standby,       <span class="comment">// ����״̬</span></span><br><span class="line">    PowerStateD3Sleep,         <span class="comment">// ���˯��</span></span><br><span class="line">    PowerStateD3Off            <span class="comment">// ��ȫ�ر�</span></span><br><span class="line">&#125; DEVICE_POWER_STATE_EX;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ��������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">POWER_POLICY_CONFIG</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableIdleDetection;</span><br><span class="line">        ULONG IdleTimeout;           <span class="comment">// ����</span></span><br><span class="line">        DEVICE_POWER_STATE_EX IdleState;</span><br><span class="line">    &#125; Idle;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableDynamicPower;</span><br><span class="line">        ULONG PerformanceThreshold;  <span class="comment">// �ٷֱ�</span></span><br><span class="line">        ULONG PowerSavingThreshold;</span><br><span class="line">    &#125; Dynamic;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableWakeSupport;</span><br><span class="line">        ULONG WakeSignals;</span><br><span class="line">        DEVICE_POWER_STATE_EX DeepestWakeState;</span><br><span class="line">    &#125; Wake;</span><br><span class="line">&#125; POWER_POLICY_CONFIG, *PPOWER_POLICY_CONFIG;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">POWER_MANAGER_EX</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    POWER_POLICY_CONFIG PolicyConfig;</span><br><span class="line">    DEVICE_POWER_STATE_EX CurrentState;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ״̬����</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LARGE_INTEGER LastStateChangeTime;</span><br><span class="line">        ULONG StateTransitions;</span><br><span class="line">        ULONG FailedTransitions;</span><br><span class="line">        DEVICE_POWER_STATE_EX LastState;</span><br><span class="line">    &#125; StateTracking;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���м��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        KTIMER IdleTimer;</span><br><span class="line">        KDPC IdleDpc;</span><br><span class="line">        BOOLEAN IdleTimerActive;</span><br><span class="line">        LARGE_INTEGER LastActivityTime;</span><br><span class="line">    &#125; IdleDetection;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��̬��Դ����</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG CurrentPerformanceLevel;</span><br><span class="line">        ULONG CurrentPowerLevel;</span><br><span class="line">        KSPIN_LOCK PowerLock;</span><br><span class="line">        KEVENT PowerEvent;</span><br><span class="line">    &#125; DynamicPower;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ѹ���</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN WakeEnabled;</span><br><span class="line">        ULONG WakeReason;</span><br><span class="line">        LIST_ENTRY WakeSourceList;</span><br><span class="line">        KSPIN_LOCK WakeLock;</span><br><span class="line">    &#125; WakeManagement;</span><br><span class="line">&#125; POWER_MANAGER_EX, *PPOWER_MANAGER_EX;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ����Դ������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializePowerManagerEx</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PPOWER_MANAGER_EX powerMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����Դ������</span></span><br><span class="line">    powerMgr = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(POWER_MANAGER_EX),</span><br><span class="line">        <span class="string">&#x27;PMEX&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!powerMgr) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(powerMgr, <span class="keyword">sizeof</span>(POWER_MANAGER_EX));</span><br><span class="line">    powerMgr-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ���������</span></span><br><span class="line">    KeInitializeSpinLock(&amp;powerMgr-&gt;DynamicPower.PowerLock);</span><br><span class="line">    KeInitializeEvent(&amp;powerMgr-&gt;DynamicPower.PowerEvent, </span><br><span class="line">                     NotificationEvent, </span><br><span class="line">                     FALSE);</span><br><span class="line">    InitializeListHead(&amp;powerMgr-&gt;WakeManagement.WakeSourceList);</span><br><span class="line">    KeInitializeSpinLock(&amp;powerMgr-&gt;WakeManagement.WakeLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʼ�����м��</span></span><br><span class="line">    KeInitializeTimer(&amp;powerMgr-&gt;IdleDetection.IdleTimer);</span><br><span class="line">    KeInitializeDpc(</span><br><span class="line">        &amp;powerMgr-&gt;IdleDetection.IdleDpc,</span><br><span class="line">        RtsPciIdleTimeoutDpc,</span><br><span class="line">        powerMgr);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 4. ����Ĭ�ϲ���</span></span><br><span class="line">    powerMgr-&gt;PolicyConfig.Idle.EnableIdleDetection = TRUE;</span><br><span class="line">    powerMgr-&gt;PolicyConfig.Idle.IdleTimeout = <span class="number">5000</span>;    <span class="comment">// 5��</span></span><br><span class="line">    powerMgr-&gt;PolicyConfig.Idle.IdleState = PowerStateD1Light;</span><br><span class="line">    </span><br><span class="line">    powerMgr-&gt;PolicyConfig.Dynamic.EnableDynamicPower = TRUE;</span><br><span class="line">    powerMgr-&gt;PolicyConfig.Dynamic.PerformanceThreshold = <span class="number">80</span>;</span><br><span class="line">    powerMgr-&gt;PolicyConfig.Dynamic.PowerSavingThreshold = <span class="number">30</span>;</span><br><span class="line">    </span><br><span class="line">    powerMgr-&gt;PolicyConfig.Wake.EnableWakeSupport = TRUE;</span><br><span class="line">    powerMgr-&gt;PolicyConfig.Wake.DeepestWakeState = PowerStateD2Standby;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;PowerManagerEx = powerMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="17-2-��̬��Դ����"><a href="#17-2-��̬��Դ����" class="headerlink" title="17.2 ��̬��Դ����"></a>17.2 ��̬��Դ����</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��̬��Դ����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciAdjustPowerState</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PPOWER_MANAGER_EX PowerMgr,</span></span><br><span class="line"><span class="params">    _In_ ULONG WorkloadLevel</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    DEVICE_POWER_STATE_EX targetState;</span><br><span class="line">    ULONG targetPowerLevel;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ȷ��Ŀ���Դ״̬</span></span><br><span class="line">    KeAcquireSpinLock(&amp;PowerMgr-&gt;DynamicPower.PowerLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (WorkloadLevel &gt;= PowerMgr-&gt;PolicyConfig.Dynamic.PerformanceThreshold) &#123;</span><br><span class="line">        <span class="comment">// �߸��� - ��������</span></span><br><span class="line">        targetState = PowerStateD0Active;</span><br><span class="line">        targetPowerLevel = <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (WorkloadLevel &lt;= PowerMgr-&gt;PolicyConfig.Dynamic.PowerSavingThreshold) &#123;</span><br><span class="line">        <span class="comment">// �͸��� - ����ģʽ</span></span><br><span class="line">        targetState = PowerStateD0Idle;</span><br><span class="line">        targetPowerLevel = <span class="number">50</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// �еȸ��� - ƽ��ģʽ</span></span><br><span class="line">        targetState = PowerStateD0Active;</span><br><span class="line">        targetPowerLevel = <span class="number">75</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ִ��״̬ת��</span></span><br><span class="line">    <span class="keyword">if</span> (targetState != PowerMgr-&gt;CurrentState) &#123;</span><br><span class="line">        status = RtsPciTransitionPowerState(</span><br><span class="line">            PowerMgr,</span><br><span class="line">            PowerMgr-&gt;CurrentState,</span><br><span class="line">            targetState);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            PowerMgr-&gt;CurrentState = targetState;</span><br><span class="line">            PowerMgr-&gt;StateTracking.StateTransitions++;</span><br><span class="line">            PowerMgr-&gt;StateTracking.LastStateChangeTime = KeQueryInterruptTime();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            PowerMgr-&gt;StateTracking.FailedTransitions++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �������ʼ���</span></span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status) &amp;&amp; </span><br><span class="line">        targetPowerLevel != PowerMgr-&gt;DynamicPower.CurrentPowerLevel) &#123;</span><br><span class="line">        status = RtsPciSetPowerLevel(</span><br><span class="line">            PowerMgr-&gt;DevContext,</span><br><span class="line">            targetPowerLevel);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            PowerMgr-&gt;DynamicPower.CurrentPowerLevel = targetPowerLevel;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;PowerMgr-&gt;DynamicPower.PowerLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ״̬ת��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciTransitionPowerState</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PPOWER_MANAGER_EX PowerMgr,</span></span><br><span class="line"><span class="params">    _In_ DEVICE_POWER_STATE_EX CurrentState,</span></span><br><span class="line"><span class="params">    _In_ DEVICE_POWER_STATE_EX TargetState</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    POWER_TRANSITION_CONTEXT transCtx = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ׼��ת��������</span></span><br><span class="line">    transCtx.OldState = CurrentState;</span><br><span class="line">    transCtx.NewState = TargetState;</span><br><span class="line">    transCtx.SaveContext = (TargetState &gt; PowerStateD0Idle);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ִ��Ԥת������</span></span><br><span class="line">    status = RtsPciPrePowerTransition(PowerMgr, &amp;transCtx);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �����豸������(�����Ҫ)</span></span><br><span class="line">    <span class="keyword">if</span> (transCtx.SaveContext) &#123;</span><br><span class="line">        status = RtsPciSaveDeviceContext(PowerMgr-&gt;DevContext);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">return</span> status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����Ӳ����Դ״̬</span></span><br><span class="line">    status = RtsPciSetHardwarePowerState(</span><br><span class="line">        PowerMgr-&gt;DevContext,</span><br><span class="line">        TargetState);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="comment">// �ع��ѱ����������</span></span><br><span class="line">        <span class="keyword">if</span> (transCtx.SaveContext) &#123;</span><br><span class="line">            RtsPciRestoreDeviceContext(PowerMgr-&gt;DevContext);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ִ�к�ת������</span></span><br><span class="line">    status = RtsPciPostPowerTransition(PowerMgr, &amp;transCtx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="17-3-���ѹ���"><a href="#17-3-���ѹ���" class="headerlink" title="17.3 ���ѹ���"></a>17.3 ���ѹ���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ����Դ����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">WAKE_SOURCE_CONFIG</span> &#123;</span></span><br><span class="line">    ULONG SourceId;</span><br><span class="line">    ULONG WakeSignal;</span><br><span class="line">    BOOLEAN Enabled;</span><br><span class="line">    DEVICE_POWER_STATE_EX MinWakeState;</span><br><span class="line">    DEVICE_POWER_STATE_EX MaxWakeState;</span><br><span class="line">&#125; WAKE_SOURCE_CONFIG, *PWAKE_SOURCE_CONFIG;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���û���Դ</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciConfigureWakeSource</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PPOWER_MANAGER_EX PowerMgr,</span></span><br><span class="line"><span class="params">    _In_ PWAKE_SOURCE_CONFIG WakeConfig</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PWAKE_SOURCE_ENTRY wakeEntry;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��֤����</span></span><br><span class="line">    <span class="keyword">if</span> (WakeConfig-&gt;MinWakeState &gt; PowerMgr-&gt;PolicyConfig.Wake.DeepestWakeState) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���份��Դ��Ŀ</span></span><br><span class="line">    wakeEntry = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(WAKE_SOURCE_ENTRY),</span><br><span class="line">        <span class="string">&#x27;WSPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!wakeEntry) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlCopyMemory(&amp;wakeEntry-&gt;Config, </span><br><span class="line">                  WakeConfig, </span><br><span class="line">                  <span class="keyword">sizeof</span>(WAKE_SOURCE_CONFIG));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����Ӳ������Դ</span></span><br><span class="line">    status = RtsPciSetupHardwareWakeSource(</span><br><span class="line">        PowerMgr-&gt;DevContext,</span><br><span class="line">        WakeConfig);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        ExFreePool(wakeEntry);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���ӵ�����Դ�б�</span></span><br><span class="line">    KeAcquireSpinLock(&amp;PowerMgr-&gt;WakeManagement.WakeLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    InsertTailList(</span><br><span class="line">        &amp;PowerMgr-&gt;WakeManagement.WakeSourceList,</span><br><span class="line">        &amp;wakeEntry-&gt;ListEntry);</span><br><span class="line">        </span><br><span class="line">    PowerMgr-&gt;WakeManagement.WakeEnabled = TRUE;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;PowerMgr-&gt;WakeManagement.WakeLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���������¼�</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciHandleWakeEvent</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PPOWER_MANAGER_EX PowerMgr,</span></span><br><span class="line"><span class="params">    _In_ ULONG WakeReason</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    BOOLEAN handled = FALSE;</span><br><span class="line">    PLIST_ENTRY entry;</span><br><span class="line">    PWAKE_SOURCE_ENTRY wakeEntry;</span><br><span class="line">    </span><br><span class="line">    KeAcquireSpinLock(&amp;PowerMgr-&gt;WakeManagement.WakeLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���Ҵ����Ļ���Դ</span></span><br><span class="line">    <span class="keyword">for</span> (entry = PowerMgr-&gt;WakeManagement.WakeSourceList.Flink;</span><br><span class="line">         entry != &amp;PowerMgr-&gt;WakeManagement.WakeSourceList;</span><br><span class="line">         entry = entry-&gt;Flink) &#123;</span><br><span class="line">        wakeEntry = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            WAKE_SOURCE_ENTRY,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (wakeEntry-&gt;Config.WakeSignal &amp; WakeReason) &#123;</span><br><span class="line">            <span class="comment">// �ҵ�ƥ��Ļ���Դ</span></span><br><span class="line">            PowerMgr-&gt;WakeManagement.WakeReason = WakeReason;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. ִ�л��Ѵ���</span></span><br><span class="line">            status = RtsPciProcessWakeup(</span><br><span class="line">                PowerMgr,</span><br><span class="line">                wakeEntry);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">                handled = TRUE;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;PowerMgr-&gt;WakeManagement.WakeLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ֪ͨϵͳ�����¼�</span></span><br><span class="line">    <span class="keyword">if</span> (handled) &#123;</span><br><span class="line">        PoSetSystemState(PowerSystemWorking);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






<p>[���� - ��һ���ֽ���ϸ���ܸ߼��жϴ���]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-51"><a href="#User-51" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-51"><a href="#AI-claude-3-5-sonnet-51" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼��жϴ������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-17"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-17" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 17"></a>WDF SD Host Controller����ʵ����� - Part 17</h1><h2 id="18-�߼��жϴ���"><a href="#18-�߼��жϴ���" class="headerlink" title="18. �߼��жϴ���"></a>18. �߼��жϴ���</h2><h3 id="18-1-�жϹ�����ʵ��"><a href="#18-1-�жϹ�����ʵ��" class="headerlink" title="18.1 �жϹ�����ʵ��"></a>18.1 �жϹ�����ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �ж����Ͷ���</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">INTERRUPT_TYPE</span> &#123;</span></span><br><span class="line">    InterruptTypeNormal = <span class="number">0</span>,</span><br><span class="line">    InterruptTypeDma,</span><br><span class="line">    InterruptTypeError,</span><br><span class="line">    InterruptTypeCardDetect,</span><br><span class="line">    InterruptTypeWake,</span><br><span class="line">    InterruptTypeMax</span><br><span class="line">&#125; INTERRUPT_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �жϴ���������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">INTERRUPT_CONTEXT</span> &#123;</span></span><br><span class="line">    INTERRUPT_TYPE Type;</span><br><span class="line">    ULONG InterruptStatus;</span><br><span class="line">    ULONG ErrorStatus;</span><br><span class="line">    BOOLEAN IsMsi;</span><br><span class="line">    ULONG MessageId;</span><br><span class="line">    ULONG ProcessorNumber;</span><br><span class="line">    LARGE_INTEGER Timestamp;</span><br><span class="line">&#125; INTERRUPT_CONTEXT, *PINTERRUPT_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �жϹ�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">INTERRUPT_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    WDFINTERRUPT Interrupts[InterruptTypeMax];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ж�����</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN MsiEnabled;</span><br><span class="line">        BOOLEAN MsiXEnabled;</span><br><span class="line">        ULONG NumMessageRequested;</span><br><span class="line">        ULONG NumMessageAssigned;</span><br><span class="line">        ULONG InterruptModeration;</span><br><span class="line">    &#125; Configuration;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ж�ͳ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG InterruptCount[InterruptTypeMax];</span><br><span class="line">        ULONG SpuriousCount;</span><br><span class="line">        ULONG DpcCount;</span><br><span class="line">        ULONG CoalescedCount;</span><br><span class="line">        LARGE_INTEGER LastInterruptTime;</span><br><span class="line">        KSPIN_LOCK StatsLock;</span><br><span class="line">    &#125; Statistics;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �жϺϲ�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN CoalescingEnabled;</span><br><span class="line">        ULONG CoalescingThreshold;</span><br><span class="line">        ULONG CoalescingTimeout;    <span class="comment">// ΢��</span></span><br><span class="line">        LIST_ENTRY PendingList;</span><br><span class="line">        KSPIN_LOCK CoalesceLock;</span><br><span class="line">        KTIMER CoalesceTimer;</span><br><span class="line">        KDPC CoalesceDpc;</span><br><span class="line">    &#125; Coalescing;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ж���������</span></span><br><span class="line">    ULONG MessageTable[InterruptTypeMax];</span><br><span class="line">    KSPIN_LOCK MessageLock;</span><br><span class="line">&#125; INTERRUPT_MANAGER, *PINTERRUPT_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ���жϹ�����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeInterruptManager</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PINTERRUPT_MANAGER intManager;</span><br><span class="line">    WDF_INTERRUPT_CONFIG intConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����жϹ�����</span></span><br><span class="line">    intManager = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(INTERRUPT_MANAGER),</span><br><span class="line">        <span class="string">&#x27;IMPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!intManager) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(intManager, <span class="keyword">sizeof</span>(INTERRUPT_MANAGER));</span><br><span class="line">    intManager-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ�������б�</span></span><br><span class="line">    KeInitializeSpinLock(&amp;intManager-&gt;Statistics.StatsLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;intManager-&gt;Coalescing.CoalesceLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;intManager-&gt;MessageLock);</span><br><span class="line">    InitializeListHead(&amp;intManager-&gt;Coalescing.PendingList);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʼ���жϺϲ���ʱ��</span></span><br><span class="line">    KeInitializeTimer(&amp;intManager-&gt;Coalescing.CoalesceTimer);</span><br><span class="line">    KeInitializeDpc(</span><br><span class="line">        &amp;intManager-&gt;Coalescing.CoalesceDpc,</span><br><span class="line">        RtsPciInterruptCoalesceDpc,</span><br><span class="line">        intManager);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 4. �����ж�</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; InterruptTypeMax; i++) &#123;</span><br><span class="line">        WDF_INTERRUPT_CONFIG_INIT(</span><br><span class="line">            &amp;intConfig,</span><br><span class="line">            RtsPciInterruptIsr,</span><br><span class="line">            RtsPciInterruptDpc);</span><br><span class="line">            </span><br><span class="line">        intConfig.InterruptTranslated = TRUE;</span><br><span class="line">        intConfig.PassiveHandling = FALSE;</span><br><span class="line">        </span><br><span class="line">        status = WdfInterruptCreate(</span><br><span class="line">            DevContext-&gt;Device,</span><br><span class="line">            &amp;intConfig,</span><br><span class="line">            WDF_NO_OBJECT_ATTRIBUTES,</span><br><span class="line">            &amp;intManager-&gt;Interrupts[i]);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����Ĭ������</span></span><br><span class="line">    intManager-&gt;Configuration.MsiEnabled = TRUE;</span><br><span class="line">    intManager-&gt;Configuration.NumMessageRequested = InterruptTypeMax;</span><br><span class="line">    intManager-&gt;Configuration.InterruptModeration = <span class="number">1000</span>;  <span class="comment">// 1ms</span></span><br><span class="line">    </span><br><span class="line">    intManager-&gt;Coalescing.CoalescingEnabled = TRUE;</span><br><span class="line">    intManager-&gt;Coalescing.CoalescingThreshold = <span class="number">8</span>;</span><br><span class="line">    intManager-&gt;Coalescing.CoalescingTimeout = <span class="number">100</span>;  <span class="comment">// 100us</span></span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;InterruptManager = intManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">cleanup:</span><br><span class="line">    RtsPciCleanupInterruptManager(intManager);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>








<h3 id="18-2-�жϴ����ͷַ�"><a href="#18-2-�жϴ����ͷַ�" class="headerlink" title="18.2 �жϴ����ͷַ�"></a>18.2 �жϴ����ͷַ�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �жϷ�������</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciInterruptIsr</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ ULONG MessageID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PINTERRUPT_MANAGER intManager;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    INTERRUPT_CONTEXT intContext = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    BOOLEAN handled = FALSE;</span><br><span class="line">    ULONG status, error;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(WdfInterruptGetDevice(Interrupt));</span><br><span class="line">    intManager = devContext-&gt;InterruptManager;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ�ж�״̬</span></span><br><span class="line">    status = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_STATUS_REG);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!(status &amp; HOST_INT_STATUS_MASK)) &#123;</span><br><span class="line">        InterlockedIncrement(&amp;intManager-&gt;Statistics.SpuriousCount);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ׼���ж�������</span></span><br><span class="line">    intContext.InterruptStatus = status;</span><br><span class="line">    intContext.IsMsi = intManager-&gt;Configuration.MsiEnabled;</span><br><span class="line">    intContext.MessageId = MessageID;</span><br><span class="line">    intContext.ProcessorNumber = KeGetCurrentProcessorNumber();</span><br><span class="line">    KeQuerySystemTime(&amp;intContext.Timestamp);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �������ж�</span></span><br><span class="line">    <span class="keyword">if</span> (status &amp; HOST_INT_ERROR_MASK) &#123;</span><br><span class="line">        error = READ_REGISTER_ULONG(</span><br><span class="line">            devContext-&gt;RegisterBase + HOST_ERROR_STATUS_REG);</span><br><span class="line">        intContext.ErrorStatus = error;</span><br><span class="line">        intContext.Type = InterruptTypeError;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ���������ж�</span></span><br><span class="line">        handled = RtsPciHandleErrorInterrupt(intManager, &amp;intContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���DMA�ж�</span></span><br><span class="line">    <span class="keyword">if</span> (status &amp; HOST_INT_DMA_MASK) &#123;</span><br><span class="line">        intContext.Type = InterruptTypeDma;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����DMA�ж�</span></span><br><span class="line">        handled |= RtsPciHandleDmaInterrupt(intManager, &amp;intContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ��鿨����ж�</span></span><br><span class="line">    <span class="keyword">if</span> (status &amp; HOST_INT_CARD_DETECT_MASK) &#123;</span><br><span class="line">        intContext.Type = InterruptTypeCardDetect;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����������ж�</span></span><br><span class="line">        handled |= RtsPciHandleCardDetectInterrupt(intManager, &amp;intContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ����ͳ����Ϣ</span></span><br><span class="line">    <span class="keyword">if</span> (handled) &#123;</span><br><span class="line">        InterlockedIncrement(&amp;intManager-&gt;Statistics.InterruptCount[intContext.Type]);</span><br><span class="line">        intManager-&gt;Statistics.LastInterruptTime = intContext.Timestamp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7. ����ж�״̬</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + HOST_INT_STATUS_REG,</span><br><span class="line">        status);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �ж�DPC����</span></span><br><span class="line">VOID <span class="title function_">RtsPciInterruptDpc</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ WDFINTERRUPT Interrupt,</span></span><br><span class="line"><span class="params">    _In_ WDFOBJECT AssociatedObject</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PINTERRUPT_MANAGER intManager;</span><br><span class="line">    PDEVICE_CONTEXT devContext;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    devContext = GetDeviceContext(WdfInterruptGetDevice(Interrupt));</span><br><span class="line">    intManager = devContext-&gt;InterruptManager;</span><br><span class="line">    </span><br><span class="line">    InterlockedIncrement(&amp;intManager-&gt;Statistics.DpcCount);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����Ƿ���Ҫ�жϺϲ�</span></span><br><span class="line">    <span class="keyword">if</span> (intManager-&gt;Coalescing.CoalescingEnabled) &#123;</span><br><span class="line">        KeAcquireSpinLock(&amp;intManager-&gt;Coalescing.CoalesceLock, &amp;oldIrql);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!IsListEmpty(&amp;intManager-&gt;Coalescing.PendingList)) &#123;</span><br><span class="line">            <span class="comment">// �����ϲ����ж�</span></span><br><span class="line">            RtsPciProcessCoalescedInterrupts(intManager);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        KeReleaseSpinLock(&amp;intManager-&gt;Coalescing.CoalesceLock, oldIrql);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����DPC����Ĺ���</span></span><br><span class="line">    RtsPciProcessDpcWork(intManager);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>








<h3 id="18-3-�жϺϲ��Z�"><a href="#18-3-�жϺϲ��Z�" class="headerlink" title="18.3 �жϺϲ��Ż�"></a>18.3 �жϺϲ��Ż�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �жϺϲ�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">INTERRUPT_COALESCE_CONFIG</span> &#123;</span></span><br><span class="line">    ULONG TimeThreshold;      <span class="comment">// ΢��</span></span><br><span class="line">    ULONG CountThreshold;     <span class="comment">// �ж�����</span></span><br><span class="line">    ULONG BatchSize;          <span class="comment">// ÿ����������</span></span><br><span class="line">    BOOLEAN AdaptiveEnabled;  <span class="comment">// ����Ӧ�ϲ�</span></span><br><span class="line">&#125; INTERRUPT_COALESCE_CONFIG, *PINTERRUPT_COALESCE_CONFIG;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �жϺϲ�����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciCoalesceInterrupt</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PINTERRUPT_MANAGER IntManager,</span></span><br><span class="line"><span class="params">    _In_ PINTERRUPT_CONTEXT IntContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PCOALESCE_ENTRY coalesceEntry;</span><br><span class="line">    BOOLEAN startTimer = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����Ƿ���Ժϲ�</span></span><br><span class="line">    <span class="keyword">if</span> (!IntManager-&gt;Coalescing.CoalescingEnabled ||</span><br><span class="line">        IntContext-&gt;Type == InterruptTypeError) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_NOT_SUPPORTED;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����ϲ���Ŀ</span></span><br><span class="line">    coalesceEntry = ExAllocateFromNPagedLookasideList(</span><br><span class="line">        &amp;IntManager-&gt;Coalescing.EntryPool);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!coalesceEntry) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlCopyMemory(&amp;coalesceEntry-&gt;Context,</span><br><span class="line">                  IntContext,</span><br><span class="line">                  <span class="keyword">sizeof</span>(INTERRUPT_CONTEXT));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���ӵ��������б�</span></span><br><span class="line">    KeAcquireSpinLock(&amp;IntManager-&gt;Coalescing.CoalesceLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    InsertTailList(</span><br><span class="line">        &amp;IntManager-&gt;Coalescing.PendingList,</span><br><span class="line">        &amp;coalesceEntry-&gt;ListEntry);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 4. ����Ƿ���Ҫ������ʱ��</span></span><br><span class="line">    <span class="keyword">if</span> (IsListEmpty(&amp;IntManager-&gt;Coalescing.PendingList)) &#123;</span><br><span class="line">        LARGE_INTEGER dueTime;</span><br><span class="line">        </span><br><span class="line">        dueTime.QuadPart = Int32x32To64(</span><br><span class="line">            <span class="number">-10</span>,  <span class="comment">// 100ns units</span></span><br><span class="line">            IntManager-&gt;Coalescing.CoalescingTimeout);</span><br><span class="line">            </span><br><span class="line">        KeSetTimer(</span><br><span class="line">            &amp;IntManager-&gt;Coalescing.CoalesceTimer,</span><br><span class="line">            dueTime,</span><br><span class="line">            &amp;IntManager-&gt;Coalescing.CoalesceDpc);</span><br><span class="line">            </span><br><span class="line">        startTimer = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����Ƿ�ﵽ�ϲ���ֵ</span></span><br><span class="line">    <span class="keyword">if</span> (GetListLength(&amp;IntManager-&gt;Coalescing.PendingList) &gt;= </span><br><span class="line">        IntManager-&gt;Coalescing.CoalescingThreshold) &#123;</span><br><span class="line">        <span class="comment">// ���������ϲ����ж�</span></span><br><span class="line">        RtsPciProcessCoalescedInterrupts(IntManager);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;IntManager-&gt;Coalescing.CoalesceLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ����ͳ����Ϣ</span></span><br><span class="line">    <span class="keyword">if</span> (!startTimer) &#123;</span><br><span class="line">        InterlockedIncrement(&amp;IntManager-&gt;Statistics.CoalescedCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �����ϲ����ж�</span></span><br><span class="line">VOID <span class="title function_">RtsPciProcessCoalescedInterrupts</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PINTERRUPT_MANAGER IntManager</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PLIST_ENTRY entry;</span><br><span class="line">    PCOALESCE_ENTRY coalesceEntry;</span><br><span class="line">    ULONG processedCount = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �������д��������ж�</span></span><br><span class="line">    <span class="keyword">while</span> (!IsListEmpty(&amp;IntManager-&gt;Coalescing.PendingList) &amp;&amp;</span><br><span class="line">           processedCount &lt; IntManager-&gt;Coalescing.Config.BatchSize) &#123;</span><br><span class="line">        entry = RemoveHeadList(&amp;IntManager-&gt;Coalescing.PendingList);</span><br><span class="line">        coalesceEntry = CONTAINING_RECORD(entry, COALESCE_ENTRY, ListEntry);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. �����ж����ͷַ�����</span></span><br><span class="line">        <span class="keyword">switch</span> (coalesceEntry-&gt;Context.Type) &#123;</span><br><span class="line">            <span class="keyword">case</span> InterruptTypeDma:</span><br><span class="line">                RtsPciHandleDmaInterrupt(</span><br><span class="line">                    IntManager,</span><br><span class="line">                    &amp;coalesceEntry-&gt;Context);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> InterruptTypeCardDetect:</span><br><span class="line">                RtsPciHandleCardDetectInterrupt(</span><br><span class="line">                    IntManager,</span><br><span class="line">                    &amp;coalesceEntry-&gt;Context);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> InterruptTypeWake:</span><br><span class="line">                RtsPciHandleWakeInterrupt(</span><br><span class="line">                    IntManager,</span><br><span class="line">                    &amp;coalesceEntry-&gt;Context);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ExFreeToNPagedLookasideList(</span><br><span class="line">            &amp;IntManager-&gt;Coalescing.EntryPool,</span><br><span class="line">            coalesceEntry);</span><br><span class="line">            </span><br><span class="line">        processedCount++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �������δ�������жϣ�����������ʱ��</span></span><br><span class="line">    <span class="keyword">if</span> (!IsListEmpty(&amp;IntManager-&gt;Coalescing.PendingList)) &#123;</span><br><span class="line">        LARGE_INTEGER dueTime;</span><br><span class="line">        </span><br><span class="line">        dueTime.QuadPart = Int32x32To64(</span><br><span class="line">            <span class="number">-10</span>,</span><br><span class="line">            IntManager-&gt;Coalescing.CoalescingTimeout);</span><br><span class="line">            </span><br><span class="line">        KeSetTimer(</span><br><span class="line">            &amp;IntManager-&gt;Coalescing.CoalesceTimer,</span><br><span class="line">            dueTime,</span><br><span class="line">            &amp;IntManager-&gt;Coalescing.CoalesceDpc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<p>[���� - ��һ���ֽ���ϸ���ܸ߼����Թ���]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-52"><a href="#User-52" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-52"><a href="#AI-claude-3-5-sonnet-52" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼����Թ��ܲ��֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-18"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-18" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 18"></a>WDF SD Host Controller����ʵ����� - Part 18</h1><h2 id="19-�߼����Թ���"><a href="#19-�߼����Թ���" class="headerlink" title="19. �߼����Թ���"></a>19. �߼����Թ���</h2><h3 id="19-1-��������ʵ��"><a href="#19-1-��������ʵ��" class="headerlink" title="19.1 ��������ʵ��"></a>19.1 ��������ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ���Լ�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">DEBUG_LEVEL</span> &#123;</span></span><br><span class="line">    DebugLevelError = <span class="number">0</span>,</span><br><span class="line">    DebugLevelWarning,</span><br><span class="line">    DebugLevelInfo,</span><br><span class="line">    DebugLevelVerbose,</span><br><span class="line">    DebugLevelMax</span><br><span class="line">&#125; DEBUG_LEVEL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �����������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">DEBUG_COMPONENT</span> &#123;</span></span><br><span class="line">    DebugCompDriver = <span class="number">0</span>,</span><br><span class="line">    DebugCompPower,</span><br><span class="line">    DebugCompInterrupt,</span><br><span class="line">    DebugCompDma,</span><br><span class="line">    DebugCompIo,</span><br><span class="line">    DebugCompMax</span><br><span class="line">&#125; DEBUG_COMPONENT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEBUG_ENGINE</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN Enabled;</span><br><span class="line">        DEBUG_LEVEL Level;</span><br><span class="line">        ULONG ComponentMask;</span><br><span class="line">        BOOLEAN BreakOnError;</span><br><span class="line">        BOOLEAN LogToFile;</span><br><span class="line">        WCHAR LogFilePath[MAX_PATH];</span><br><span class="line">    &#125; Config;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���Ի�����</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        PUCHAR Buffer;</span><br><span class="line">        SIZE_T BufferSize;</span><br><span class="line">        SIZE_T WriteOffset;</span><br><span class="line">        KSPIN_LOCK BufferLock;</span><br><span class="line">        KEVENT BufferEvent;</span><br><span class="line">    &#125; TraceBuffer;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���Իص�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY CallbackList;</span><br><span class="line">        KSPIN_LOCK CallbackLock;</span><br><span class="line">    &#125; Callbacks;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ͳ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG ErrorCount;</span><br><span class="line">        ULONG WarningCount;</span><br><span class="line">        ULONG BreakpointHits;</span><br><span class="line">        LARGE_INTEGER StartTime;</span><br><span class="line">    &#125; Statistics;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �����ļ�</span></span><br><span class="line">    HANDLE LogFileHandle;</span><br><span class="line">    KSPIN_LOCK FileLock;</span><br><span class="line">&#125; DEBUG_ENGINE, *PDEBUG_ENGINE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ����������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeDebugEngine</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PDEBUG_ENGINE debugEngine;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����������</span></span><br><span class="line">    debugEngine = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(DEBUG_ENGINE),</span><br><span class="line">        <span class="string">&#x27;DBPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!debugEngine) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(debugEngine, <span class="keyword">sizeof</span>(DEBUG_ENGINE));</span><br><span class="line">    debugEngine-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ�������б�</span></span><br><span class="line">    KeInitializeSpinLock(&amp;debugEngine-&gt;TraceBuffer.BufferLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;debugEngine-&gt;Callbacks.CallbackLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;debugEngine-&gt;FileLock);</span><br><span class="line">    InitializeListHead(&amp;debugEngine-&gt;Callbacks.CallbackList);</span><br><span class="line">    KeInitializeEvent(&amp;debugEngine-&gt;TraceBuffer.BufferEvent, </span><br><span class="line">                     NotificationEvent, </span><br><span class="line">                     FALSE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ������Ի�����</span></span><br><span class="line">    debugEngine-&gt;TraceBuffer.BufferSize = PAGE_SIZE * <span class="number">4</span>;  <span class="comment">// 16KB</span></span><br><span class="line">    debugEngine-&gt;TraceBuffer.Buffer = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        debugEngine-&gt;TraceBuffer.BufferSize,</span><br><span class="line">        <span class="string">&#x27;DBUF&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!debugEngine-&gt;TraceBuffer.Buffer) &#123;</span><br><span class="line">        status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����Ĭ������</span></span><br><span class="line">    debugEngine-&gt;Config.Enabled = TRUE;</span><br><span class="line">    debugEngine-&gt;Config.Level = DebugLevelWarning;</span><br><span class="line">    debugEngine-&gt;Config.ComponentMask = (<span class="number">1</span> &lt;&lt; DebugCompDriver) | </span><br><span class="line">                                      (<span class="number">1</span> &lt;&lt; DebugCompError);</span><br><span class="line">    debugEngine-&gt;Config.BreakOnError = FALSE;</span><br><span class="line">    </span><br><span class="line">    KeQuerySystemTime(&amp;debugEngine-&gt;Statistics.StartTime);</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;DebugEngine = debugEngine;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">cleanup:</span><br><span class="line">    RtsPciCleanupDebugEngine(debugEngine);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h3 id="19-2-���Ը��ٺ���־"><a href="#19-2-���Ը��ٺ���־" class="headerlink" title="19.2 ���Ը��ٺ���־"></a>19.2 ���Ը��ٺ���־</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ������Ϣ�ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEBUG_MESSAGE</span> &#123;</span></span><br><span class="line">    DEBUG_LEVEL Level;</span><br><span class="line">    DEBUG_COMPONENT Component;</span><br><span class="line">    LARGE_INTEGER Timestamp;</span><br><span class="line">    ULONG ProcessId;</span><br><span class="line">    ULONG ThreadId;</span><br><span class="line">    CHAR FunctionName[<span class="number">64</span>];</span><br><span class="line">    ULONG LineNumber;</span><br><span class="line">    CHAR Message[<span class="number">256</span>];</span><br><span class="line">    NTSTATUS Status;</span><br><span class="line">&#125; DEBUG_MESSAGE, *PDEBUG_MESSAGE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��¼������Ϣ</span></span><br><span class="line">VOID <span class="title function_">RtsPciLogDebugMessage</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEBUG_ENGINE DebugEngine,</span></span><br><span class="line"><span class="params">    _In_ DEBUG_LEVEL Level,</span></span><br><span class="line"><span class="params">    _In_ DEBUG_COMPONENT Component,</span></span><br><span class="line"><span class="params">    _In_ PCHAR Function,</span></span><br><span class="line"><span class="params">    _In_ ULONG Line,</span></span><br><span class="line"><span class="params">    _In_ PCHAR Format,</span></span><br><span class="line"><span class="params">    ...</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    DEBUG_MESSAGE message;</span><br><span class="line">    va_list args;</span><br><span class="line">    SIZE_T messageSize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����Լ�����������</span></span><br><span class="line">    <span class="keyword">if</span> (!DebugEngine-&gt;Config.Enabled ||</span><br><span class="line">        Level &gt; DebugEngine-&gt;Config.Level ||</span><br><span class="line">        !(DebugEngine-&gt;Config.ComponentMask &amp; (<span class="number">1</span> &lt;&lt; Component))) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����Ϣ�ṹ</span></span><br><span class="line">    RtlZeroMemory(&amp;message, <span class="keyword">sizeof</span>(DEBUG_MESSAGE));</span><br><span class="line">    message.Level = Level;</span><br><span class="line">    message.Component = Component;</span><br><span class="line">    KeQuerySystemTime(&amp;message.Timestamp);</span><br><span class="line">    message.ProcessId = (ULONG)PsGetCurrentProcessId();</span><br><span class="line">    message.ThreadId = (ULONG)PsGetCurrentThreadId();</span><br><span class="line">    message.LineNumber = Line;</span><br><span class="line">    </span><br><span class="line">    RtlStringCchCopyA(message.FunctionName, </span><br><span class="line">                      <span class="keyword">sizeof</span>(message.FunctionName),</span><br><span class="line">                      Function);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʽ����Ϣ</span></span><br><span class="line">    va_start(args, Format);</span><br><span class="line">    RtlStringCchVPrintfA(message.Message,</span><br><span class="line">                        <span class="keyword">sizeof</span>(message.Message),</span><br><span class="line">                        Format,</span><br><span class="line">                        args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. д����Ի�����</span></span><br><span class="line">    messageSize = <span class="keyword">sizeof</span>(DEBUG_MESSAGE);</span><br><span class="line">    </span><br><span class="line">    KeAcquireSpinLock(&amp;DebugEngine-&gt;TraceBuffer.BufferLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((DebugEngine-&gt;TraceBuffer.WriteOffset + messageSize) &lt;= </span><br><span class="line">        DebugEngine-&gt;TraceBuffer.BufferSize) &#123;</span><br><span class="line">        RtlCopyMemory(</span><br><span class="line">            DebugEngine-&gt;TraceBuffer.Buffer + </span><br><span class="line">                DebugEngine-&gt;TraceBuffer.WriteOffset,</span><br><span class="line">            &amp;message,</span><br><span class="line">            messageSize);</span><br><span class="line">            </span><br><span class="line">        DebugEngine-&gt;TraceBuffer.WriteOffset += messageSize;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;DebugEngine-&gt;TraceBuffer.BufferLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. д����־�ļ�</span></span><br><span class="line">    <span class="keyword">if</span> (DebugEngine-&gt;Config.LogToFile) &#123;</span><br><span class="line">        RtsPciWriteDebugLogFile(DebugEngine, &amp;message);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ���õ��Իص�</span></span><br><span class="line">    RtsPciNotifyDebugCallbacks(DebugEngine, &amp;message);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7. ����Ƿ���Ҫ�ϵ�</span></span><br><span class="line">    <span class="keyword">if</span> (Level == DebugLevelError &amp;&amp; DebugEngine-&gt;Config.BreakOnError) &#123;</span><br><span class="line">        DbgBreakPoint();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// д�������־�ļ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciWriteDebugLogFile</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEBUG_ENGINE DebugEngine,</span></span><br><span class="line"><span class="params">    _In_ PDEBUG_MESSAGE Message</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    IO_STATUS_BLOCK ioStatus;</span><br><span class="line">    LARGE_INTEGER offset;</span><br><span class="line">    CHAR logBuffer[<span class="number">512</span>];</span><br><span class="line">    SIZE_T logLength;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ʽ����־��Ŀ</span></span><br><span class="line">    logLength = RtsPciFormatDebugLogEntry(</span><br><span class="line">        Message,</span><br><span class="line">        logBuffer,</span><br><span class="line">        <span class="keyword">sizeof</span>(logBuffer));</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (logLength == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_BUFFER_TOO_SMALL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. д���ļ�</span></span><br><span class="line">    KeAcquireSpinLock(&amp;DebugEngine-&gt;FileLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    offset.QuadPart = FILE_WRITE_TO_END_OF_FILE;</span><br><span class="line">    </span><br><span class="line">    status = ZwWriteFile(</span><br><span class="line">        DebugEngine-&gt;LogFileHandle,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;ioStatus,</span><br><span class="line">        logBuffer,</span><br><span class="line">        (ULONG)logLength,</span><br><span class="line">        &amp;offset,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">    KeReleaseSpinLock(&amp;DebugEngine-&gt;FileLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h3 id="19-3-���������"><a href="#19-3-���������" class="headerlink" title="19.3 ���������"></a>19.3 ���������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ���������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">DEBUG_COMMAND</span> &#123;</span></span><br><span class="line">    DebugCmdSetLevel = <span class="number">0</span>,</span><br><span class="line">    DebugCmdSetMask,</span><br><span class="line">    DebugCmdDumpRegisters,</span><br><span class="line">    DebugCmdDumpBuffers,</span><br><span class="line">    DebugCmdTraceOn,</span><br><span class="line">    DebugCmdTraceOff,</span><br><span class="line">    DebugCmdBreakpoint,</span><br><span class="line">    DebugCmdMax</span><br><span class="line">&#125; DEBUG_COMMAND;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �����������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DEBUG_COMMAND_HANDLER</span> &#123;</span></span><br><span class="line">    DEBUG_COMMAND Command;</span><br><span class="line">    PFN_DEBUG_COMMAND_HANDLER Handler;</span><br><span class="line">    PCHAR Description;</span><br><span class="line">&#125; DEBUG_COMMAND_HANDLER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ������������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciProcessDebugCommand</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEBUG_ENGINE DebugEngine,</span></span><br><span class="line"><span class="params">    _In_ DEBUG_COMMAND Command,</span></span><br><span class="line"><span class="params">    _In_opt_ PVOID InputBuffer,</span></span><br><span class="line"><span class="params">    _In_ SIZE_T InputBufferSize,</span></span><br><span class="line"><span class="params">    _Out_opt_ PVOID OutputBuffer,</span></span><br><span class="line"><span class="params">    _In_ SIZE_T OutputBufferSize</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (Command) &#123;</span><br><span class="line">        <span class="keyword">case</span> DebugCmdSetLevel:</span><br><span class="line">            <span class="keyword">if</span> (InputBufferSize &lt; <span class="keyword">sizeof</span>(DEBUG_LEVEL)) &#123;</span><br><span class="line">                <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line">            &#125;</span><br><span class="line">            DebugEngine-&gt;Config.Level = *(PDEBUG_LEVEL)InputBuffer;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DebugCmdSetMask:</span><br><span class="line">            <span class="keyword">if</span> (InputBufferSize &lt; <span class="keyword">sizeof</span>(ULONG)) &#123;</span><br><span class="line">                <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line">            &#125;</span><br><span class="line">            DebugEngine-&gt;Config.ComponentMask = *(PULONG)InputBuffer;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DebugCmdDumpRegisters:</span><br><span class="line">            status = RtsPciDumpRegisters(</span><br><span class="line">                DebugEngine,</span><br><span class="line">                OutputBuffer,</span><br><span class="line">                OutputBufferSize);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DebugCmdDumpBuffers:</span><br><span class="line">            status = RtsPciDumpBuffers(</span><br><span class="line">                DebugEngine,</span><br><span class="line">                OutputBuffer,</span><br><span class="line">                OutputBufferSize);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DebugCmdTraceOn:</span><br><span class="line">            DebugEngine-&gt;Config.Enabled = TRUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DebugCmdTraceOff:</span><br><span class="line">            DebugEngine-&gt;Config.Enabled = FALSE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> DebugCmdBreakpoint:</span><br><span class="line">            DbgBreakPoint();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            status = STATUS_INVALID_PARAMETER;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �Ĵ���ת��ʵ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciDumpRegisters</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEBUG_ENGINE DebugEngine,</span></span><br><span class="line"><span class="params">    _Out_opt_ PVOID OutputBuffer,</span></span><br><span class="line"><span class="params">    _In_ SIZE_T OutputBufferSize</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = DebugEngine-&gt;DevContext;</span><br><span class="line">    PUCHAR regBase = devContext-&gt;RegisterBase;</span><br><span class="line">    PDEBUG_REGISTER_DUMP regDump;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!OutputBuffer || OutputBufferSize &lt; <span class="keyword">sizeof</span>(DEBUG_REGISTER_DUMP)) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_BUFFER_TOO_SMALL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    regDump = (PDEBUG_REGISTER_DUMP)OutputBuffer;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ȡ�ؼ��Ĵ���</span></span><br><span class="line">    regDump-&gt;HostControl = READ_REGISTER_ULONG(regBase + HOST_CONTROL_REG);</span><br><span class="line">    regDump-&gt;PowerControl = READ_REGISTER_ULONG(regBase + POWER_CONTROL_REG);</span><br><span class="line">    regDump-&gt;ClockControl = READ_REGISTER_ULONG(regBase + CLOCK_CONTROL_REG);</span><br><span class="line">    regDump-&gt;IntStatus = READ_REGISTER_ULONG(regBase + INT_STATUS_REG);</span><br><span class="line">    regDump-&gt;IntEnable = READ_REGISTER_ULONG(regBase + INT_ENABLE_REG);</span><br><span class="line">    regDump-&gt;ErrorStatus = READ_REGISTER_ULONG(regBase + ERROR_STATUS_REG);</span><br><span class="line">    regDump-&gt;Capabilities = READ_REGISTER_ULONG(regBase + CAPABILITIES_REG);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<p>[���� - ��һ���ֽ���ϸ���ܸ߼�������]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-53"><a href="#User-53" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ���������в���</p>
<h2 id="AI-claude-3-5-sonnet-53"><a href="#AI-claude-3-5-sonnet-53" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼����������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-19"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-19" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 19"></a>WDF SD Host Controller����ʵ����� - Part 19</h1><h2 id="20-�߼�������"><a href="#20-�߼�������" class="headerlink" title="20. �߼�������"></a>20. �߼�������</h2><h3 id="20-1-���������ʵ��"><a href="#20-1-���������ʵ��" class="headerlink" title="20.1 ���������ʵ��"></a>20.1 ���������ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �������Ͷ���</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">ERROR_TYPE</span> &#123;</span></span><br><span class="line">    ErrorTypeHardware = <span class="number">0</span>,</span><br><span class="line">    ErrorTypeDma,</span><br><span class="line">    ErrorTypeProtocol,</span><br><span class="line">    ErrorTypeTimeout,</span><br><span class="line">    ErrorTypeResource,</span><br><span class="line">    ErrorTypeSystem,</span><br><span class="line">    ErrorTypeMax</span><br><span class="line">&#125; ERROR_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���󼶱���</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">ERROR_SEVERITY</span> &#123;</span></span><br><span class="line">    ErrorSeverityFatal = <span class="number">0</span>,</span><br><span class="line">    ErrorSeverityCritical,</span><br><span class="line">    ErrorSeverityRecoverable,</span><br><span class="line">    ErrorSeverityWarning,</span><br><span class="line">    ErrorSeverityInfo</span><br><span class="line">&#125; ERROR_SEVERITY;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �����¼�ṹ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ERROR_RECORD</span> &#123;</span></span><br><span class="line">    ERROR_TYPE Type;</span><br><span class="line">    ERROR_SEVERITY Severity;</span><br><span class="line">    NTSTATUS Status;</span><br><span class="line">    LARGE_INTEGER Timestamp;</span><br><span class="line">    ULONG ProcessId;</span><br><span class="line">    ULONG ThreadId;</span><br><span class="line">    CHAR Location[<span class="number">64</span>];</span><br><span class="line">    CHAR Description[<span class="number">256</span>];</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            ULONG RegisterValue;</span><br><span class="line">            ULONG ExpectedValue;</span><br><span class="line">            ULONG ErrorMask;</span><br><span class="line">        &#125; Hardware;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            ULONG TransferSize;</span><br><span class="line">            ULONG CompletedSize;</span><br><span class="line">            ULONG ErrorFlags;</span><br><span class="line">        &#125; Dma;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            ULONG Command;</span><br><span class="line">            ULONG Response;</span><br><span class="line">            ULONG State;</span><br><span class="line">        &#125; Protocol;</span><br><span class="line">    &#125; Details;</span><br><span class="line">&#125; ERROR_RECORD, *PERROR_RECORD;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ERROR_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN AutoRecover;</span><br><span class="line">        ULONG MaxRetries;</span><br><span class="line">        ULONG RecoveryTimeout;</span><br><span class="line">        ERROR_SEVERITY MinSeverity;</span><br><span class="line">    &#125; Config;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������ʷ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        PERROR_RECORD Records;</span><br><span class="line">        ULONG MaxRecords;</span><br><span class="line">        ULONG CurrentIndex;</span><br><span class="line">        KSPIN_LOCK HistoryLock;</span><br><span class="line">    &#125; History;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ͳ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG ErrorCount[ErrorTypeMax];</span><br><span class="line">        ULONG RecoveryCount;</span><br><span class="line">        ULONG UnrecoverableCount;</span><br><span class="line">        LARGE_INTEGER LastErrorTime;</span><br><span class="line">    &#125; Statistics;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����ָ�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY RecoveryQueue;</span><br><span class="line">        KSPIN_LOCK RecoveryLock;</span><br><span class="line">        KEVENT RecoveryEvent;</span><br><span class="line">        BOOLEAN RecoveryInProgress;</span><br><span class="line">    &#125; Recovery;</span><br><span class="line">&#125; ERROR_MANAGER, *PERROR_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ�����������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeErrorManager</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PERROR_MANAGER errorMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ������������</span></span><br><span class="line">    errorMgr = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(ERROR_MANAGER),</span><br><span class="line">        <span class="string">&#x27;EMPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!errorMgr) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(errorMgr, <span class="keyword">sizeof</span>(ERROR_MANAGER));</span><br><span class="line">    errorMgr-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ�������¼�</span></span><br><span class="line">    KeInitializeSpinLock(&amp;errorMgr-&gt;History.HistoryLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;errorMgr-&gt;Recovery.RecoveryLock);</span><br><span class="line">    KeInitializeEvent(&amp;errorMgr-&gt;Recovery.RecoveryEvent,</span><br><span class="line">                     NotificationEvent,</span><br><span class="line">                     FALSE);</span><br><span class="line">    InitializeListHead(&amp;errorMgr-&gt;Recovery.RecoveryQueue);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���������ʷ��¼</span></span><br><span class="line">    errorMgr-&gt;History.MaxRecords = <span class="number">100</span>;</span><br><span class="line">    errorMgr-&gt;History.Records = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(ERROR_RECORD) * errorMgr-&gt;History.MaxRecords,</span><br><span class="line">        <span class="string">&#x27;EREC&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!errorMgr-&gt;History.Records) &#123;</span><br><span class="line">        status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����Ĭ������</span></span><br><span class="line">    errorMgr-&gt;Config.AutoRecover = TRUE;</span><br><span class="line">    errorMgr-&gt;Config.MaxRetries = <span class="number">3</span>;</span><br><span class="line">    errorMgr-&gt;Config.RecoveryTimeout = <span class="number">5000</span>;  <span class="comment">// 5��</span></span><br><span class="line">    errorMgr-&gt;Config.MinSeverity = ErrorSeverityRecoverable;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;ErrorManager = errorMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">cleanup:</span><br><span class="line">    RtsPciCleanupErrorManager(errorMgr);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h3 id="20-2-������ͼ�¼"><a href="#20-2-������ͼ�¼" class="headerlink" title="20.2 ������ͼ�¼"></a>20.2 ������ͼ�¼</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��¼����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciLogError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PERROR_MANAGER ErrorMgr,</span></span><br><span class="line"><span class="params">    _In_ ERROR_TYPE Type,</span></span><br><span class="line"><span class="params">    _In_ ERROR_SEVERITY Severity,</span></span><br><span class="line"><span class="params">    _In_ NTSTATUS Status,</span></span><br><span class="line"><span class="params">    _In_ PCHAR Location,</span></span><br><span class="line"><span class="params">    _In_ PCHAR Description,</span></span><br><span class="line"><span class="params">    _In_opt_ PVOID ErrorDetails,</span></span><br><span class="line"><span class="params">    _In_ SIZE_T DetailsSize</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PERROR_RECORD record;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����󼶱�</span></span><br><span class="line">    <span class="keyword">if</span> (Severity &lt; ErrorMgr-&gt;Config.MinSeverity) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ȡ�µĴ����¼</span></span><br><span class="line">    KeAcquireSpinLock(&amp;ErrorMgr-&gt;History.HistoryLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    record = &amp;ErrorMgr-&gt;History.Records[ErrorMgr-&gt;History.CurrentIndex];</span><br><span class="line">    ErrorMgr-&gt;History.CurrentIndex = </span><br><span class="line">        (ErrorMgr-&gt;History.CurrentIndex + <span class="number">1</span>) % ErrorMgr-&gt;History.MaxRecords;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. �������¼</span></span><br><span class="line">    RtlZeroMemory(record, <span class="keyword">sizeof</span>(ERROR_RECORD));</span><br><span class="line">    record-&gt;Type = Type;</span><br><span class="line">    record-&gt;Severity = Severity;</span><br><span class="line">    record-&gt;Status = Status;</span><br><span class="line">    KeQuerySystemTime(&amp;record-&gt;Timestamp);</span><br><span class="line">    record-&gt;ProcessId = (ULONG)PsGetCurrentProcessId();</span><br><span class="line">    record-&gt;ThreadId = (ULONG)PsGetCurrentThreadId();</span><br><span class="line">    </span><br><span class="line">    RtlStringCchCopyA(record-&gt;Location,</span><br><span class="line">                      <span class="keyword">sizeof</span>(record-&gt;Location),</span><br><span class="line">                      Location);</span><br><span class="line">                      </span><br><span class="line">    RtlStringCchCopyA(record-&gt;Description,</span><br><span class="line">                      <span class="keyword">sizeof</span>(record-&gt;Description),</span><br><span class="line">                      Description);</span><br><span class="line">                      </span><br><span class="line">    <span class="comment">// 4. ���ƴ�������</span></span><br><span class="line">    <span class="keyword">if</span> (ErrorDetails &amp;&amp; DetailsSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (Type) &#123;</span><br><span class="line">            <span class="keyword">case</span> ErrorTypeHardware:</span><br><span class="line">                RtlCopyMemory(&amp;record-&gt;Details.Hardware,</span><br><span class="line">                             ErrorDetails,</span><br><span class="line">                             min(DetailsSize, <span class="keyword">sizeof</span>(record-&gt;Details.Hardware)));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> ErrorTypeDma:</span><br><span class="line">                RtlCopyMemory(&amp;record-&gt;Details.Dma,</span><br><span class="line">                             ErrorDetails,</span><br><span class="line">                             min(DetailsSize, <span class="keyword">sizeof</span>(record-&gt;Details.Dma)));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> ErrorTypeProtocol:</span><br><span class="line">                RtlCopyMemory(&amp;record-&gt;Details.Protocol,</span><br><span class="line">                             ErrorDetails,</span><br><span class="line">                             min(DetailsSize, <span class="keyword">sizeof</span>(record-&gt;Details.Protocol)));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;ErrorMgr-&gt;History.HistoryLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����ͳ����Ϣ</span></span><br><span class="line">    InterlockedIncrement(&amp;ErrorMgr-&gt;Statistics.ErrorCount[Type]);</span><br><span class="line">    ErrorMgr-&gt;Statistics.LastErrorTime = record-&gt;Timestamp;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ��������ָ�</span></span><br><span class="line">    <span class="keyword">if</span> (ErrorMgr-&gt;Config.AutoRecover &amp;&amp; </span><br><span class="line">        Severity &lt;= ErrorSeverityRecoverable) &#123;</span><br><span class="line">        RtsPciQueueErrorRecovery(ErrorMgr, record);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7. ֪ͨ�����¼�</span></span><br><span class="line">    RtsPciNotifyErrorEvent(ErrorMgr, record);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���Ӳ������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciCheckHardwareError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PERROR_MANAGER ErrorMgr</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = ErrorMgr-&gt;DevContext;</span><br><span class="line">    ULONG errorStatus, expectedValue;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ����״̬�Ĵ���</span></span><br><span class="line">    errorStatus = READ_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + ERROR_STATUS_REG);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (errorStatus &amp; ERROR_STATUS_MASK) &#123;</span><br><span class="line">        ERROR_RECORD_HARDWARE hwError;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. ���Ӳ����������</span></span><br><span class="line">        hwError.RegisterValue = errorStatus;</span><br><span class="line">        hwError.ExpectedValue = expectedValue;</span><br><span class="line">        hwError.ErrorMask = ERROR_STATUS_MASK;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. ��¼����</span></span><br><span class="line">        RtsPciLogError(</span><br><span class="line">            ErrorMgr,</span><br><span class="line">            ErrorTypeHardware,</span><br><span class="line">            ErrorSeverityRecoverable,</span><br><span class="line">            STATUS_DEVICE_HARDWARE_ERROR,</span><br><span class="line">            <span class="string">&quot;HardwareCheck&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Hardware error detected in status register&quot;</span>,</span><br><span class="line">            &amp;hwError,</span><br><span class="line">            <span class="keyword">sizeof</span>(hwError));</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> STATUS_DEVICE_HARDWARE_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h3 id="20-3-����ָ�ʵ��"><a href="#20-3-����ָ�ʵ��" class="headerlink" title="20.3 ����ָ�ʵ��"></a>20.3 ����ָ�ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ����ָ�������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ERROR_RECOVERY_CONTEXT</span> &#123;</span></span><br><span class="line">    LIST_ENTRY ListEntry;</span><br><span class="line">    ERROR_RECORD Record;</span><br><span class="line">    ULONG RetryCount;</span><br><span class="line">    LARGE_INTEGER StartTime;</span><br><span class="line">    NTSTATUS LastStatus;</span><br><span class="line">    BOOLEAN InProgress;</span><br><span class="line">&#125; ERROR_RECOVERY_CONTEXT, *PERROR_RECOVERY_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���д���ָ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciQueueErrorRecovery</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PERROR_MANAGER ErrorMgr,</span></span><br><span class="line"><span class="params">    _In_ PERROR_RECORD Record</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PERROR_RECOVERY_CONTEXT recoveryCtx;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����ָ�������</span></span><br><span class="line">    recoveryCtx = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(ERROR_RECOVERY_CONTEXT),</span><br><span class="line">        <span class="string">&#x27;EREC&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!recoveryCtx) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(recoveryCtx, <span class="keyword">sizeof</span>(ERROR_RECOVERY_CONTEXT));</span><br><span class="line">    RtlCopyMemory(&amp;recoveryCtx-&gt;Record,</span><br><span class="line">                  Record,</span><br><span class="line">                  <span class="keyword">sizeof</span>(ERROR_RECORD));</span><br><span class="line">                  </span><br><span class="line">    KeQuerySystemTime(&amp;recoveryCtx-&gt;StartTime);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���ӵ��ָ�����</span></span><br><span class="line">    KeAcquireSpinLock(&amp;ErrorMgr-&gt;Recovery.RecoveryLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    InsertTailList(</span><br><span class="line">        &amp;ErrorMgr-&gt;Recovery.RecoveryQueue,</span><br><span class="line">        &amp;recoveryCtx-&gt;ListEntry);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!ErrorMgr-&gt;Recovery.RecoveryInProgress) &#123;</span><br><span class="line">        ErrorMgr-&gt;Recovery.RecoveryInProgress = TRUE;</span><br><span class="line">        KeSetEvent(&amp;ErrorMgr-&gt;Recovery.RecoveryEvent, <span class="number">0</span>, FALSE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;ErrorMgr-&gt;Recovery.RecoveryLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ִ�д���ָ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciPerformErrorRecovery</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PERROR_MANAGER ErrorMgr,</span></span><br><span class="line"><span class="params">    _In_ PERROR_RECOVERY_CONTEXT RecoveryCtx</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ������Դ���</span></span><br><span class="line">    <span class="keyword">if</span> (RecoveryCtx-&gt;RetryCount &gt;= ErrorMgr-&gt;Config.MaxRetries) &#123;</span><br><span class="line">        InterlockedIncrement(&amp;ErrorMgr-&gt;Statistics.UnrecoverableCount);</span><br><span class="line">        <span class="keyword">return</span> STATUS_RETRY_EXHAUSTED;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���ݴ�������ִ�лָ�</span></span><br><span class="line">    <span class="keyword">switch</span> (RecoveryCtx-&gt;Record.Type) &#123;</span><br><span class="line">        <span class="keyword">case</span> ErrorTypeHardware:</span><br><span class="line">            status = RtsPciRecoverHardwareError(</span><br><span class="line">                ErrorMgr,</span><br><span class="line">                &amp;RecoveryCtx-&gt;Record.Details.Hardware);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ErrorTypeDma:</span><br><span class="line">            status = RtsPciRecoverDmaError(</span><br><span class="line">                ErrorMgr,</span><br><span class="line">                &amp;RecoveryCtx-&gt;Record.Details.Dma);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ErrorTypeProtocol:</span><br><span class="line">            status = RtsPciRecoverProtocolError(</span><br><span class="line">                ErrorMgr,</span><br><span class="line">                &amp;RecoveryCtx-&gt;Record.Details.Protocol);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            status = STATUS_NOT_SUPPORTED;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���»ָ�״̬</span></span><br><span class="line">    RecoveryCtx-&gt;LastStatus = status;</span><br><span class="line">    RecoveryCtx-&gt;RetryCount++;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        InterlockedIncrement(&amp;ErrorMgr-&gt;Statistics.RecoveryCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ӳ������ָ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciRecoverHardwareError</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PERROR_MANAGER ErrorMgr,</span></span><br><span class="line"><span class="params">    _In_ PERROR_RECORD_HARDWARE HwError</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDEVICE_CONTEXT devContext = ErrorMgr-&gt;DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����Ӳ��״̬</span></span><br><span class="line">    WRITE_REGISTER_ULONG(</span><br><span class="line">        devContext-&gt;RegisterBase + RESET_CONTROL_REG,</span><br><span class="line">        RESET_CONTROL_SOFT_RESET);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. �ȴ��������</span></span><br><span class="line">    <span class="keyword">if</span> (!RtsPciWaitForReset(devContext)) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_DEVICE_HARDWARE_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���³�ʼ��Ӳ��</span></span><br><span class="line">    <span class="keyword">return</span> RtsPciInitializeHardware(devContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<p>[���� - ��һ���ֽ���ϸ���ܸ߼������Ż�]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-54"><a href="#User-54" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-54"><a href="#AI-claude-3-5-sonnet-54" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼������Ż����֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-20"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-20" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 20"></a>WDF SD Host Controller����ʵ����� - Part 20</h1><h2 id="21-�߼������Z�"><a href="#21-�߼������Z�" class="headerlink" title="21. �߼������Ż�"></a>21. �߼������Ż�</h2><h3 id="21-1-�����Z�������ʵ��"><a href="#21-1-�����Z�������ʵ��" class="headerlink" title="21.1 �����Ż�������ʵ��"></a>21.1 �����Ż�������ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �����Ż�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">OPTIMIZATION_TYPE</span> &#123;</span></span><br><span class="line">    OptimizationTypeIO = <span class="number">0</span>,</span><br><span class="line">    OptimizationTypeMemory,</span><br><span class="line">    OptimizationTypeCPU,</span><br><span class="line">    OptimizationTypePower,</span><br><span class="line">    OptimizationTypeMax</span><br><span class="line">&#125; OPTIMIZATION_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �����Ż�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">OPTIMIZATION_CONFIG</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableReadAhead;</span><br><span class="line">        BOOLEAN EnableWriteCoalescing;</span><br><span class="line">        ULONG ReadAheadSize;</span><br><span class="line">        ULONG WriteCoalesceSize;</span><br><span class="line">        ULONG MaxQueueDepth;</span><br><span class="line">    &#125; IO;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableDmaCoalescing;</span><br><span class="line">        BOOLEAN EnableBufferReuse;</span><br><span class="line">        ULONG PreallocatedBuffers;</span><br><span class="line">        ULONG MaxDmaTransferSize;</span><br><span class="line">    &#125; Memory;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableInterruptCoalescing;</span><br><span class="line">        BOOLEAN EnableDpcBatching;</span><br><span class="line">        ULONG InterruptThreshold;</span><br><span class="line">        ULONG DpcBatchSize;</span><br><span class="line">    &#125; CPU;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN EnableDynamicClocking;</span><br><span class="line">        BOOLEAN EnablePowerGating;</span><br><span class="line">        ULONG MinClockFrequency;</span><br><span class="line">        ULONG MaxClockFrequency;</span><br><span class="line">    &#125; Power;</span><br><span class="line">&#125; OPTIMIZATION_CONFIG, *POPTIMIZATION_CONFIG;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �����Ż�������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">OPTIMIZATION_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    OPTIMIZATION_CONFIG Config;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// IO�Ż�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        NPAGED_LOOKASIDE_LIST BufferPool;</span><br><span class="line">        LIST_ENTRY PendingWriteList;</span><br><span class="line">        KSPIN_LOCK WriteLock;</span><br><span class="line">        KDPC WriteCoalesceDpc;</span><br><span class="line">        KTIMER WriteCoalesceTimer;</span><br><span class="line">    &#125; IOOptimization;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ڴ��Ż�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY FreeBufferList;</span><br><span class="line">        KSPIN_LOCK BufferLock;</span><br><span class="line">        ULONG BufferCount;</span><br><span class="line">        SIZE_T TotalBufferSize;</span><br><span class="line">    &#125; MemoryOptimization;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// CPU�Ż�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG InterruptCount;</span><br><span class="line">        LARGE_INTEGER LastInterruptTime;</span><br><span class="line">        LIST_ENTRY DpcQueue;</span><br><span class="line">        KSPIN_LOCK DpcLock;</span><br><span class="line">    &#125; CPUOptimization;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ�Ż�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG CurrentFrequency;</span><br><span class="line">        ULONG CurrentPowerState;</span><br><span class="line">        KSPIN_LOCK PowerLock;</span><br><span class="line">        KTIMER PowerAdjustTimer;</span><br><span class="line">    &#125; PowerOptimization;</span><br><span class="line">&#125; OPTIMIZATION_MANAGER, *POPTIMIZATION_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ�������Ż�������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeOptimizationManager</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    POPTIMIZATION_MANAGER optMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����Ż�������</span></span><br><span class="line">    optMgr = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(OPTIMIZATION_MANAGER),</span><br><span class="line">        <span class="string">&#x27;OMPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!optMgr) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(optMgr, <span class="keyword">sizeof</span>(OPTIMIZATION_MANAGER));</span><br><span class="line">    optMgr-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ��IO�Ż�</span></span><br><span class="line">    ExInitializeNPagedLookasideList(</span><br><span class="line">        &amp;optMgr-&gt;IOOptimization.BufferPool,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        PAGE_SIZE,</span><br><span class="line">        <span class="string">&#x27;IOPL&#x27;</span>,</span><br><span class="line">        <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">    InitializeListHead(&amp;optMgr-&gt;IOOptimization.PendingWriteList);</span><br><span class="line">    KeInitializeSpinLock(&amp;optMgr-&gt;IOOptimization.WriteLock);</span><br><span class="line">    KeInitializeTimer(&amp;optMgr-&gt;IOOptimization.WriteCoalesceTimer);</span><br><span class="line">    KeInitializeDpc(</span><br><span class="line">        &amp;optMgr-&gt;IOOptimization.WriteCoalesceDpc,</span><br><span class="line">        RtsPciWriteCoalesceDpc,</span><br><span class="line">        optMgr);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. ��ʼ���ڴ��Ż�</span></span><br><span class="line">    InitializeListHead(&amp;optMgr-&gt;MemoryOptimization.FreeBufferList);</span><br><span class="line">    KeInitializeSpinLock(&amp;optMgr-&gt;MemoryOptimization.BufferLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ��ʼ��CPU�Ż�</span></span><br><span class="line">    InitializeListHead(&amp;optMgr-&gt;CPUOptimization.DpcQueue);</span><br><span class="line">    KeInitializeSpinLock(&amp;optMgr-&gt;CPUOptimization.DpcLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ��ʼ����Դ�Ż�</span></span><br><span class="line">    KeInitializeSpinLock(&amp;optMgr-&gt;PowerOptimization.PowerLock);</span><br><span class="line">    KeInitializeTimer(&amp;optMgr-&gt;PowerOptimization.PowerAdjustTimer);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ����Ĭ������</span></span><br><span class="line">    optMgr-&gt;Config.IO.EnableReadAhead = TRUE;</span><br><span class="line">    optMgr-&gt;Config.IO.EnableWriteCoalescing = TRUE;</span><br><span class="line">    optMgr-&gt;Config.IO.ReadAheadSize = PAGE_SIZE * <span class="number">4</span>;</span><br><span class="line">    optMgr-&gt;Config.IO.WriteCoalesceSize = PAGE_SIZE * <span class="number">4</span>;</span><br><span class="line">    optMgr-&gt;Config.IO.MaxQueueDepth = <span class="number">32</span>;</span><br><span class="line">    </span><br><span class="line">    optMgr-&gt;Config.Memory.EnableDmaCoalescing = TRUE;</span><br><span class="line">    optMgr-&gt;Config.Memory.EnableBufferReuse = TRUE;</span><br><span class="line">    optMgr-&gt;Config.Memory.PreallocatedBuffers = <span class="number">16</span>;</span><br><span class="line">    </span><br><span class="line">    optMgr-&gt;Config.CPU.EnableInterruptCoalescing = TRUE;</span><br><span class="line">    optMgr-&gt;Config.CPU.EnableDpcBatching = TRUE;</span><br><span class="line">    optMgr-&gt;Config.CPU.InterruptThreshold = <span class="number">8</span>;</span><br><span class="line">    optMgr-&gt;Config.CPU.DpcBatchSize = <span class="number">4</span>;</span><br><span class="line">    </span><br><span class="line">    optMgr-&gt;Config.Power.EnableDynamicClocking = TRUE;</span><br><span class="line">    optMgr-&gt;Config.Power.EnablePowerGating = TRUE;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;OptimizationManager = optMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h3 id="21-2-IO�����Z�"><a href="#21-2-IO�����Z�" class="headerlink" title="21.2 IO�����Ż�"></a>21.2 IO�����Ż�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IO�����Ż�������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_OPTIMIZATION_CONTEXT</span> &#123;</span></span><br><span class="line">    LIST_ENTRY ListEntry;</span><br><span class="line">    WDFREQUEST Request;</span><br><span class="line">    PVOID Buffer;</span><br><span class="line">    SIZE_T BufferLength;</span><br><span class="line">    BOOLEAN IsRead;</span><br><span class="line">    LARGE_INTEGER Timestamp;</span><br><span class="line">&#125; IO_OPTIMIZATION_CONTEXT, *PIO_OPTIMIZATION_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �Ż�IO����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciOptimizeIoRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ POPTIMIZATION_MANAGER OptMgr,</span></span><br><span class="line"><span class="params">    _In_ WDFREQUEST Request,</span></span><br><span class="line"><span class="params">    _In_ BOOLEAN IsRead</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PIO_OPTIMIZATION_CONTEXT ioCtx;</span><br><span class="line">    PVOID buffer;</span><br><span class="line">    SIZE_T length;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ȡ������Ϣ</span></span><br><span class="line">    <span class="keyword">if</span> (IsRead) &#123;</span><br><span class="line">        status = WdfRequestRetrieveOutputBuffer(</span><br><span class="line">            Request,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            &amp;buffer,</span><br><span class="line">            &amp;length);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        status = WdfRequestRetrieveInputBuffer(</span><br><span class="line">            Request,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            &amp;buffer,</span><br><span class="line">            &amp;length);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����Ż�������</span></span><br><span class="line">    ioCtx = ExAllocateFromNPagedLookasideList(</span><br><span class="line">        &amp;OptMgr-&gt;IOOptimization.BufferPool);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!ioCtx) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ioCtx-&gt;Request = Request;</span><br><span class="line">    ioCtx-&gt;Buffer = buffer;</span><br><span class="line">    ioCtx-&gt;BufferLength = length;</span><br><span class="line">    ioCtx-&gt;IsRead = IsRead;</span><br><span class="line">    KeQuerySystemTime(&amp;ioCtx-&gt;Timestamp);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. Ӧ��IO�Ż�</span></span><br><span class="line">    <span class="keyword">if</span> (IsRead &amp;&amp; OptMgr-&gt;Config.IO.EnableReadAhead) &#123;</span><br><span class="line">        status = RtsPciApplyReadAhead(OptMgr, ioCtx);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!IsRead &amp;&amp; OptMgr-&gt;Config.IO.EnableWriteCoalescing) &#123;</span><br><span class="line">        status = RtsPciApplyWriteCoalescing(OptMgr, ioCtx);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        status = RtsPciProcessIoRequestDirect(OptMgr, ioCtx);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        ExFreeToNPagedLookasideList(</span><br><span class="line">            &amp;OptMgr-&gt;IOOptimization.BufferPool,</span><br><span class="line">            ioCtx);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// д����ϲ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciApplyWriteCoalescing</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ POPTIMIZATION_MANAGER OptMgr,</span></span><br><span class="line"><span class="params">    _In_ PIO_OPTIMIZATION_CONTEXT IoCtx</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    BOOLEAN startTimer = FALSE;</span><br><span class="line">    </span><br><span class="line">    KeAcquireSpinLock(&amp;OptMgr-&gt;IOOptimization.WriteLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���ӵ��������б�</span></span><br><span class="line">    InsertTailList(</span><br><span class="line">        &amp;OptMgr-&gt;IOOptimization.PendingWriteList,</span><br><span class="line">        &amp;IoCtx-&gt;ListEntry);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. ����Ƿ���Ҫ�����ϲ���ʱ��</span></span><br><span class="line">    <span class="keyword">if</span> (IsListEmpty(&amp;OptMgr-&gt;IOOptimization.PendingWriteList)) &#123;</span><br><span class="line">        LARGE_INTEGER dueTime;</span><br><span class="line">        </span><br><span class="line">        dueTime.QuadPart = Int32x32To64(</span><br><span class="line">            <span class="number">-10000</span>,  <span class="comment">// 1ms</span></span><br><span class="line">            <span class="number">1</span>);</span><br><span class="line">            </span><br><span class="line">        KeSetTimer(</span><br><span class="line">            &amp;OptMgr-&gt;IOOptimization.WriteCoalesceTimer,</span><br><span class="line">            dueTime,</span><br><span class="line">            &amp;OptMgr-&gt;IOOptimization.WriteCoalesceDpc);</span><br><span class="line">            </span><br><span class="line">        startTimer = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����Ƿ�ﵽ�ϲ���ֵ</span></span><br><span class="line">    <span class="keyword">if</span> (GetListLength(&amp;OptMgr-&gt;IOOptimization.PendingWriteList) &gt;= </span><br><span class="line">        OptMgr-&gt;Config.IO.WriteCoalesceSize) &#123;</span><br><span class="line">        <span class="comment">// ���������ϲ���д����</span></span><br><span class="line">        RtsPciProcessCoalescedWrites(OptMgr);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;OptMgr-&gt;IOOptimization.WriteLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_PENDING;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h3 id="21-3-�ڴ��CPU�Z�"><a href="#21-3-�ڴ��CPU�Z�" class="headerlink" title="21.3 �ڴ��CPU�Ż�"></a>21.3 �ڴ��CPU�Ż�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �ڴ滺�����Ż�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciOptimizeMemoryBuffers</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ POPTIMIZATION_MANAGER OptMgr</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    PVOID buffer;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����Ƿ���ҪԤ���仺����</span></span><br><span class="line">    KeAcquireSpinLock(&amp;OptMgr-&gt;MemoryOptimization.BufferLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (OptMgr-&gt;MemoryOptimization.BufferCount &lt; </span><br><span class="line">        OptMgr-&gt;Config.Memory.PreallocatedBuffers) &#123;</span><br><span class="line">        <span class="comment">// 2. �����»�����</span></span><br><span class="line">        buffer = ExAllocatePoolWithTag(</span><br><span class="line">            NonPagedPool,</span><br><span class="line">            PAGE_SIZE,</span><br><span class="line">            <span class="string">&#x27;MBUF&#x27;</span>);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (buffer) &#123;</span><br><span class="line">            PMEMORY_BUFFER_ENTRY entry;</span><br><span class="line">            </span><br><span class="line">            entry = ExAllocatePoolWithTag(</span><br><span class="line">                NonPagedPool,</span><br><span class="line">                <span class="keyword">sizeof</span>(MEMORY_BUFFER_ENTRY),</span><br><span class="line">                <span class="string">&#x27;MBEN&#x27;</span>);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (entry) &#123;</span><br><span class="line">                entry-&gt;Buffer = buffer;</span><br><span class="line">                entry-&gt;Size = PAGE_SIZE;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 3. ���ӵ������б�</span></span><br><span class="line">                InsertTailList(</span><br><span class="line">                    &amp;OptMgr-&gt;MemoryOptimization.FreeBufferList,</span><br><span class="line">                    &amp;entry-&gt;ListEntry);</span><br><span class="line">                    </span><br><span class="line">                OptMgr-&gt;MemoryOptimization.BufferCount++;</span><br><span class="line">                OptMgr-&gt;MemoryOptimization.TotalBufferSize += PAGE_SIZE;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ExFreePool(buffer);</span><br><span class="line">                status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;OptMgr-&gt;MemoryOptimization.BufferLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CPU�Ż� - DPC������</span></span><br><span class="line">VOID <span class="title function_">RtsPciOptimizeDpcProcessing</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ POPTIMIZATION_MANAGER OptMgr,</span></span><br><span class="line"><span class="params">    _In_ PKDPC Dpc</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    ULONG processedCount = <span class="number">0</span>;</span><br><span class="line">    LIST_ENTRY localList;</span><br><span class="line">    </span><br><span class="line">    InitializeListHead(&amp;localList);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �ռ���������DPC</span></span><br><span class="line">    KeAcquireSpinLock(&amp;OptMgr-&gt;CPUOptimization.DpcLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!IsListEmpty(&amp;OptMgr-&gt;CPUOptimization.DpcQueue) &amp;&amp;</span><br><span class="line">           processedCount &lt; OptMgr-&gt;Config.CPU.DpcBatchSize) &#123;</span><br><span class="line">        PLIST_ENTRY entry = RemoveHeadList(</span><br><span class="line">            &amp;OptMgr-&gt;CPUOptimization.DpcQueue);</span><br><span class="line">            </span><br><span class="line">        InsertTailList(&amp;localList, entry);</span><br><span class="line">        processedCount++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;OptMgr-&gt;CPUOptimization.DpcLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��������DPC</span></span><br><span class="line">    <span class="keyword">while</span> (!IsListEmpty(&amp;localList)) &#123;</span><br><span class="line">        PLIST_ENTRY entry = RemoveHeadList(&amp;localList);</span><br><span class="line">        PDPC_WORK_ITEM workItem = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            DPC_WORK_ITEM,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// ִ��DPC������</span></span><br><span class="line">        workItem-&gt;WorkRoutine(</span><br><span class="line">            workItem-&gt;Context,</span><br><span class="line">            workItem-&gt;Parameter1,</span><br><span class="line">            workItem-&gt;Parameter2);</span><br><span class="line">            </span><br><span class="line">        ExFreePool(workItem);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CPU�Ż� - �жϺϲ�</span></span><br><span class="line">BOOLEAN <span class="title function_">RtsPciOptimizeInterruptProcessing</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ POPTIMIZATION_MANAGER OptMgr,</span></span><br><span class="line"><span class="params">    _In_ ULONG InterruptStatus</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    LARGE_INTEGER currentTime;</span><br><span class="line">    BOOLEAN shouldDefer = FALSE;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!OptMgr-&gt;Config.CPU.EnableInterruptCoalescing) &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeQuerySystemTime(&amp;currentTime);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����ж�Ƶ��</span></span><br><span class="line">    <span class="keyword">if</span> ((currentTime.QuadPart - </span><br><span class="line">         OptMgr-&gt;CPUOptimization.LastInterruptTime.QuadPart) &lt; </span><br><span class="line">        <span class="number">10000</span>) &#123;  <span class="comment">// 1ms</span></span><br><span class="line">        OptMgr-&gt;CPUOptimization.InterruptCount++;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. ����Ƿ���Ҫ�ϲ�</span></span><br><span class="line">        <span class="keyword">if</span> (OptMgr-&gt;CPUOptimization.InterruptCount &gt;= </span><br><span class="line">            OptMgr-&gt;Config.CPU.InterruptThreshold) &#123;</span><br><span class="line">            shouldDefer = TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ���ü�����</span></span><br><span class="line">        OptMgr-&gt;CPUOptimization.InterruptCount = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    OptMgr-&gt;CPUOptimization.LastInterruptTime = currentTime;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> shouldDefer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<p>[���� - ��һ���ֽ���ϸ���ܸ߼���Դ����]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-55"><a href="#User-55" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-55"><a href="#AI-claude-3-5-sonnet-55" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼���Դ�������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-21"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-21" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 21"></a>WDF SD Host Controller����ʵ����� - Part 21</h1><h2 id="22-�߼���Դ����"><a href="#22-�߼���Դ����" class="headerlink" title="22. �߼���Դ����"></a>22. �߼���Դ����</h2><h3 id="22-1-��Դ������ʵ��"><a href="#22-1-��Դ������ʵ��" class="headerlink" title="22.1 ��Դ������ʵ��"></a>22.1 ��Դ������ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��Դ���Ͷ���</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">RESOURCE_TYPE</span> &#123;</span></span><br><span class="line">    ResourceTypeMemory = <span class="number">0</span>,</span><br><span class="line">    ResourceTypeDma,</span><br><span class="line">    ResourceTypeInterrupt,</span><br><span class="line">    ResourceTypePort,</span><br><span class="line">    ResourceTypeMax</span><br><span class="line">&#125; RESOURCE_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ״̬</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">RESOURCE_STATE</span> &#123;</span></span><br><span class="line">    ResourceStateUninitialized = <span class="number">0</span>,</span><br><span class="line">    ResourceStateAllocated,</span><br><span class="line">    ResourceStateActive,</span><br><span class="line">    ResourceStateError,</span><br><span class="line">    ResourceStateReleased</span><br><span class="line">&#125; RESOURCE_STATE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">RESOURCE_DESCRIPTOR</span> &#123;</span></span><br><span class="line">    RESOURCE_TYPE Type;</span><br><span class="line">    RESOURCE_STATE State;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            PHYSICAL_ADDRESS PhysicalAddress;</span><br><span class="line">            PVOID VirtualAddress;</span><br><span class="line">            SIZE_T Length;</span><br><span class="line">            BOOLEAN Cached;</span><br><span class="line">        &#125; Memory;</span><br><span class="line">        </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            PHYSICAL_ADDRESS PortBase;</span><br><span class="line">            ULONG PortCount;</span><br><span class="line">            BOOLEAN WriteAccess;</span><br><span class="line">        &#125; Port;</span><br><span class="line">        </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            ULONG Vector;</span><br><span class="line">            KIRQL Irql;</span><br><span class="line">            KINTERRUPT_MODE InterruptMode;</span><br><span class="line">            BOOLEAN ShareVector;</span><br><span class="line">        &#125; Interrupt;</span><br><span class="line">        </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            PHYSICAL_ADDRESS LogicalAddress;</span><br><span class="line">            PVOID VirtualAddress;</span><br><span class="line">            ULONG Channel;</span><br><span class="line">            BOOLEAN WriteAccess;</span><br><span class="line">        &#125; Dma;</span><br><span class="line">    &#125; Info;</span><br><span class="line">&#125; RESOURCE_DESCRIPTOR, *PRESOURCE_DESCRIPTOR;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">RESOURCE_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ�б�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY ResourceList;</span><br><span class="line">        KSPIN_LOCK ResourceLock;</span><br><span class="line">        ULONG ResourceCount;</span><br><span class="line">    &#125; Resources[ResourceTypeMax];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դͳ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ULONG AllocatedCount[ResourceTypeMax];</span><br><span class="line">        ULONG FailedAllocations;</span><br><span class="line">        SIZE_T TotalMemoryAllocated;</span><br><span class="line">        ULONG ActiveResources;</span><br><span class="line">    &#125; Statistics;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ����</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        SIZE_T MaxMemoryAllocation;</span><br><span class="line">        ULONG MaxDmaChannels;</span><br><span class="line">        ULONG MaxInterruptVectors;</span><br><span class="line">        ULONG MaxPortCount;</span><br><span class="line">    &#125; Limits;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��Դ���</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        KTIMER MonitorTimer;</span><br><span class="line">        KDPC MonitorDpc;</span><br><span class="line">        LARGE_INTEGER LastCheckTime;</span><br><span class="line">        KSPIN_LOCK MonitorLock;</span><br><span class="line">    &#125; Monitor;</span><br><span class="line">&#125; RESOURCE_MANAGER, *PRESOURCE_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ����Դ������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeResourceManager</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PRESOURCE_MANAGER resMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ������Դ������</span></span><br><span class="line">    resMgr = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(RESOURCE_MANAGER),</span><br><span class="line">        <span class="string">&#x27;RMPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!resMgr) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(resMgr, <span class="keyword">sizeof</span>(RESOURCE_MANAGER));</span><br><span class="line">    resMgr-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ����Դ�б�</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; ResourceTypeMax; i++) &#123;</span><br><span class="line">        InitializeListHead(&amp;resMgr-&gt;Resources[i].ResourceList);</span><br><span class="line">        KeInitializeSpinLock(&amp;resMgr-&gt;Resources[i].ResourceLock);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʼ��������</span></span><br><span class="line">    KeInitializeSpinLock(&amp;resMgr-&gt;Monitor.MonitorLock);</span><br><span class="line">    KeInitializeTimer(&amp;resMgr-&gt;Monitor.MonitorTimer);</span><br><span class="line">    KeInitializeDpc(</span><br><span class="line">        &amp;resMgr-&gt;Monitor.MonitorDpc,</span><br><span class="line">        RtsPciResourceMonitorDpc,</span><br><span class="line">        resMgr);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 4. ������Դ����</span></span><br><span class="line">    resMgr-&gt;Limits.MaxMemoryAllocation = PAGE_SIZE * <span class="number">256</span>;  <span class="comment">// 1MB</span></span><br><span class="line">    resMgr-&gt;Limits.MaxDmaChannels = <span class="number">8</span>;</span><br><span class="line">    resMgr-&gt;Limits.MaxInterruptVectors = <span class="number">16</span>;</span><br><span class="line">    resMgr-&gt;Limits.MaxPortCount = <span class="number">32</span>;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;ResourceManager = resMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ������Դ���</span></span><br><span class="line">    RtsPciStartResourceMonitoring(resMgr);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h3 id="22-2-��Դ����͸���"><a href="#22-2-��Դ����͸���" class="headerlink" title="22.2 ��Դ����͸���"></a>22.2 ��Դ����͸���</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ������Դ</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciAllocateResource</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PRESOURCE_MANAGER ResMgr,</span></span><br><span class="line"><span class="params">    _In_ RESOURCE_TYPE Type,</span></span><br><span class="line"><span class="params">    _In_ PVOID ResourceInfo,</span></span><br><span class="line"><span class="params">    _Out_ PRESOURCE_DESCRIPTOR* ResourceDesc</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    PRESOURCE_DESCRIPTOR resDesc;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��֤��Դ����</span></span><br><span class="line">    <span class="keyword">if</span> (!RtsPciValidateResourceAllocation(ResMgr, Type, ResourceInfo)) &#123;</span><br><span class="line">        InterlockedIncrement(&amp;ResMgr-&gt;Statistics.FailedAllocations);</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ������Դ������</span></span><br><span class="line">    resDesc = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(RESOURCE_DESCRIPTOR),</span><br><span class="line">        <span class="string">&#x27;RDPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!resDesc) &#123;</span><br><span class="line">        InterlockedIncrement(&amp;ResMgr-&gt;Statistics.FailedAllocations);</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(resDesc, <span class="keyword">sizeof</span>(RESOURCE_DESCRIPTOR));</span><br><span class="line">    resDesc-&gt;Type = Type;</span><br><span class="line">    resDesc-&gt;State = ResourceStateAllocated;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ������Դ���ͽ����ض���ʼ��</span></span><br><span class="line">    <span class="keyword">switch</span> (Type) &#123;</span><br><span class="line">        <span class="keyword">case</span> ResourceTypeMemory:</span><br><span class="line">            status = RtsPciInitializeMemoryResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                resDesc,</span><br><span class="line">                (PMEMORY_RESOURCE_INFO)ResourceInfo);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ResourceTypeDma:</span><br><span class="line">            status = RtsPciInitializeDmaResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                resDesc,</span><br><span class="line">                (PDMA_RESOURCE_INFO)ResourceInfo);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ResourceTypeInterrupt:</span><br><span class="line">            status = RtsPciInitializeInterruptResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                resDesc,</span><br><span class="line">                (PINTERRUPT_RESOURCE_INFO)ResourceInfo);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ResourceTypePort:</span><br><span class="line">            status = RtsPciInitializePortResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                resDesc,</span><br><span class="line">                (PPORT_RESOURCE_INFO)ResourceInfo);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            status = STATUS_INVALID_PARAMETER;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        ExFreePool(resDesc);</span><br><span class="line">        InterlockedIncrement(&amp;ResMgr-&gt;Statistics.FailedAllocations);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���ӵ���Դ�б�</span></span><br><span class="line">    KeAcquireSpinLock(&amp;ResMgr-&gt;Resources[Type].ResourceLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    InsertTailList(</span><br><span class="line">        &amp;ResMgr-&gt;Resources[Type].ResourceList,</span><br><span class="line">        &amp;resDesc-&gt;ListEntry);</span><br><span class="line">        </span><br><span class="line">    ResMgr-&gt;Resources[Type].ResourceCount++;</span><br><span class="line">    InterlockedIncrement(&amp;ResMgr-&gt;Statistics.AllocatedCount[Type]);</span><br><span class="line">    InterlockedIncrement(&amp;ResMgr-&gt;Statistics.ActiveResources);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (Type == ResourceTypeMemory) &#123;</span><br><span class="line">        ResMgr-&gt;Statistics.TotalMemoryAllocated += </span><br><span class="line">            resDesc-&gt;Info.Memory.Length;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;ResMgr-&gt;Resources[Type].ResourceLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    *ResourceDesc = resDesc;</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��Դ���DPC</span></span><br><span class="line">VOID <span class="title function_">RtsPciResourceMonitorDpc</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PKDPC Dpc,</span></span><br><span class="line"><span class="params">    _In_ PVOID DeferredContext,</span></span><br><span class="line"><span class="params">    _In_ PVOID SystemArgument1,</span></span><br><span class="line"><span class="params">    _In_ PVOID SystemArgument2</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PRESOURCE_MANAGER resMgr = (PRESOURCE_MANAGER)DeferredContext;</span><br><span class="line">    LARGE_INTEGER currentTime;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    KeQuerySystemTime(&amp;currentTime);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����Դʹ�����</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG type = <span class="number">0</span>; type &lt; ResourceTypeMax; type++) &#123;</span><br><span class="line">        PLIST_ENTRY entry;</span><br><span class="line">        PRESOURCE_DESCRIPTOR resDesc;</span><br><span class="line">        </span><br><span class="line">        KeAcquireSpinLock(&amp;resMgr-&gt;Resources[type].ResourceLock, &amp;oldIrql);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (entry = resMgr-&gt;Resources[type].ResourceList.Flink;</span><br><span class="line">             entry != &amp;resMgr-&gt;Resources[type].ResourceList;</span><br><span class="line">             entry = entry-&gt;Flink) &#123;</span><br><span class="line">             </span><br><span class="line">            resDesc = CONTAINING_RECORD(</span><br><span class="line">                entry,</span><br><span class="line">                RESOURCE_DESCRIPTOR,</span><br><span class="line">                ListEntry);</span><br><span class="line">                </span><br><span class="line">            <span class="comment">// 2. �����Դ״̬</span></span><br><span class="line">            <span class="keyword">if</span> (resDesc-&gt;State == ResourceStateError) &#123;</span><br><span class="line">                <span class="comment">// ���Իָ�������Դ</span></span><br><span class="line">                RtsPciRecoverResource(resMgr, resDesc);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. �����Դй©</span></span><br><span class="line">            <span class="keyword">if</span> (resDesc-&gt;State == ResourceStateAllocated &amp;&amp;</span><br><span class="line">                (currentTime.QuadPart - resDesc-&gt;AllocationTime.QuadPart) &gt;</span><br><span class="line">                <span class="number">10000000</span>) &#123;  <span class="comment">// 1��</span></span><br><span class="line">                <span class="comment">// ��¼���ܵ���Դй©</span></span><br><span class="line">                RtsPciLogResourceLeak(resMgr, resDesc);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        KeReleaseSpinLock(&amp;resMgr-&gt;Resources[type].ResourceLock, oldIrql);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���µ��ȼ�ض�ʱ��</span></span><br><span class="line">    RtsPciScheduleResourceMonitor(resMgr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h3 id="22-3-��Դ�ͷzͻָ�"><a href="#22-3-��Դ�ͷzͻָ�" class="headerlink" title="22.3 ��Դ�ͷźͻָ�"></a>22.3 ��Դ�ͷźͻָ�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �ͷ���Դ</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciReleaseResource</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PRESOURCE_MANAGER ResMgr,</span></span><br><span class="line"><span class="params">    _In_ PRESOURCE_DESCRIPTOR ResourceDesc</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!ResourceDesc || ResourceDesc-&gt;State == ResourceStateReleased) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ������Դ����ִ������</span></span><br><span class="line">    <span class="keyword">switch</span> (ResourceDesc-&gt;Type) &#123;</span><br><span class="line">        <span class="keyword">case</span> ResourceTypeMemory:</span><br><span class="line">            status = RtsPciCleanupMemoryResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                ResourceDesc);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ResourceTypeDma:</span><br><span class="line">            status = RtsPciCleanupDmaResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                ResourceDesc);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ResourceTypeInterrupt:</span><br><span class="line">            status = RtsPciCleanupInterruptResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                ResourceDesc);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ResourceTypePort:</span><br><span class="line">            status = RtsPciCleanupPortResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                ResourceDesc);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����Դ�б��Ƴ�</span></span><br><span class="line">    KeAcquireSpinLock(</span><br><span class="line">        &amp;ResMgr-&gt;Resources[ResourceDesc-&gt;Type].ResourceLock,</span><br><span class="line">        &amp;oldIrql);</span><br><span class="line">        </span><br><span class="line">    RemoveEntryList(&amp;ResourceDesc-&gt;ListEntry);</span><br><span class="line">    ResMgr-&gt;Resources[ResourceDesc-&gt;Type].ResourceCount--;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ResourceDesc-&gt;Type == ResourceTypeMemory) &#123;</span><br><span class="line">        ResMgr-&gt;Statistics.TotalMemoryAllocated -= </span><br><span class="line">            ResourceDesc-&gt;Info.Memory.Length;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    InterlockedDecrement(&amp;ResMgr-&gt;Statistics.ActiveResources);</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(</span><br><span class="line">        &amp;ResMgr-&gt;Resources[ResourceDesc-&gt;Type].ResourceLock,</span><br><span class="line">        oldIrql);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. �ͷ���Դ������</span></span><br><span class="line">    ResourceDesc-&gt;State = ResourceStateReleased;</span><br><span class="line">    ExFreePool(ResourceDesc);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �ָ�������Դ</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciRecoverResource</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PRESOURCE_MANAGER ResMgr,</span></span><br><span class="line"><span class="params">    _In_ PRESOURCE_DESCRIPTOR ResourceDesc</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��֤��Դ״̬</span></span><br><span class="line">    <span class="keyword">if</span> (ResourceDesc-&gt;State != ResourceStateError) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ������Դ����ִ�лָ�</span></span><br><span class="line">    <span class="keyword">switch</span> (ResourceDesc-&gt;Type) &#123;</span><br><span class="line">        <span class="keyword">case</span> ResourceTypeMemory:</span><br><span class="line">            status = RtsPciRecoverMemoryResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                ResourceDesc);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ResourceTypeDma:</span><br><span class="line">            status = RtsPciRecoverDmaResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                ResourceDesc);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ResourceTypeInterrupt:</span><br><span class="line">            status = RtsPciRecoverInterruptResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                ResourceDesc);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ResourceTypePort:</span><br><span class="line">            status = RtsPciRecoverPortResource(</span><br><span class="line">                ResMgr,</span><br><span class="line">                ResourceDesc);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        ResourceDesc-&gt;State = ResourceStateActive;</span><br><span class="line">        ResourceDesc-&gt;ErrorCount = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ResourceDesc-&gt;ErrorCount++;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. ����Ƿ񳬹����ָ����Դ���</span></span><br><span class="line">        <span class="keyword">if</span> (ResourceDesc-&gt;ErrorCount &gt;= MAX_RECOVERY_ATTEMPTS) &#123;</span><br><span class="line">            <span class="comment">// ǿ���ͷ���Դ</span></span><br><span class="line">            RtsPciReleaseResource(ResMgr, ResourceDesc);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �ڴ���Դ�ָ�ʵ��</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciRecoverMemoryResource</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PRESOURCE_MANAGER ResMgr,</span></span><br><span class="line"><span class="params">    _In_ PRESOURCE_DESCRIPTOR ResourceDesc</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PHYSICAL_ADDRESS physAddr;</span><br><span class="line">    PVOID virtAddr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ����ӳ���ڴ�</span></span><br><span class="line">    virtAddr = MmMapIoSpace(</span><br><span class="line">        ResourceDesc-&gt;Info.Memory.PhysicalAddress,</span><br><span class="line">        ResourceDesc-&gt;Info.Memory.Length,</span><br><span class="line">        ResourceDesc-&gt;Info.Memory.Cached ? </span><br><span class="line">            MmCached : MmNonCached);</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">if</span> (!virtAddr) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ������Դ��Ϣ</span></span><br><span class="line">    <span class="keyword">if</span> (ResourceDesc-&gt;Info.Memory.VirtualAddress) &#123;</span><br><span class="line">        MmUnmapIoSpace(</span><br><span class="line">            ResourceDesc-&gt;Info.Memory.VirtualAddress,</span><br><span class="line">            ResourceDesc-&gt;Info.Memory.Length);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ResourceDesc-&gt;Info.Memory.VirtualAddress = virtAddr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��֤�ڴ����</span></span><br><span class="line">    <span class="keyword">if</span> (!RtsPciValidateMemoryAccess(</span><br><span class="line">            ResourceDesc-&gt;Info.Memory.VirtualAddress,</span><br><span class="line">            ResourceDesc-&gt;Info.Memory.Length)) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_DEVICE_HARDWARE_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<p>[���� - ��һ���ֽ���ϸ���ܸ߼����ù���]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-56"><a href="#User-56" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����չ����������</p>
<h2 id="AI-claude-3-5-sonnet-56"><a href="#AI-claude-3-5-sonnet-56" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ���߼����ù������֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-22"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-22" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 22"></a>WDF SD Host Controller����ʵ����� - Part 22</h1><h2 id="23-�߼����u���"><a href="#23-�߼����u���" class="headerlink" title="23. �߼����ù���"></a>23. �߼����ù���</h2><h3 id="23-1-���u�����ʵ��"><a href="#23-1-���u�����ʵ��" class="headerlink" title="23.1 ���ù�����ʵ��"></a>23.1 ���ù�����ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ����������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">CONFIG_ITEM_TYPE</span> &#123;</span></span><br><span class="line">    ConfigTypeInteger = <span class="number">0</span>,</span><br><span class="line">    ConfigTypeBoolean,</span><br><span class="line">    ConfigTypeString,</span><br><span class="line">    ConfigTypeBinary,</span><br><span class="line">    ConfigTypeMax</span><br><span class="line">&#125; CONFIG_ITEM_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���������Ȩ��</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">CONFIG_ACCESS</span> &#123;</span></span><br><span class="line">    ConfigAccessReadOnly = <span class="number">0</span>,</span><br><span class="line">    ConfigAccessReadWrite,</span><br><span class="line">    ConfigAccessWriteOnce</span><br><span class="line">&#125; CONFIG_ACCESS;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ������������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">CONFIG_ITEM_DESCRIPTOR</span> &#123;</span></span><br><span class="line">    WCHAR Name[<span class="number">64</span>];</span><br><span class="line">    CONFIG_ITEM_TYPE Type;</span><br><span class="line">    CONFIG_ACCESS Access;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            LONG MinValue;</span><br><span class="line">            LONG MaxValue;</span><br><span class="line">            LONG DefaultValue;</span><br><span class="line">            LONG CurrentValue;</span><br><span class="line">        &#125; Integer;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            BOOLEAN DefaultValue;</span><br><span class="line">            BOOLEAN CurrentValue;</span><br><span class="line">        &#125; Boolean;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            WCHAR DefaultValue[<span class="number">256</span>];</span><br><span class="line">            WCHAR CurrentValue[<span class="number">256</span>];</span><br><span class="line">            ULONG MaxLength;</span><br><span class="line">        &#125; String;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            PUCHAR DefaultValue;</span><br><span class="line">            PUCHAR CurrentValue;</span><br><span class="line">            ULONG Length;</span><br><span class="line">        &#125; Binary;</span><br><span class="line">    &#125; Data;</span><br><span class="line">    BOOLEAN Modified;</span><br><span class="line">    LARGE_INTEGER LastModified;</span><br><span class="line">&#125; CONFIG_ITEM_DESCRIPTOR, *PCONFIG_ITEM_DESCRIPTOR;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���ù�����</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">CONFIG_MANAGER</span> &#123;</span></span><br><span class="line">    PDEVICE_CONTEXT DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������洢</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        PCONFIG_ITEM_DESCRIPTOR Items;</span><br><span class="line">        ULONG ItemCount;</span><br><span class="line">        KSPIN_LOCK ItemLock;</span><br><span class="line">    &#125; Storage;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ñ��֪ͨ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY NotifyList;</span><br><span class="line">        KSPIN_LOCK NotifyLock;</span><br><span class="line">    &#125; Notification;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ó־û�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN PersistenceEnabled;</span><br><span class="line">        WCHAR RegistryPath[<span class="number">256</span>];</span><br><span class="line">        HANDLE RegistryKey;</span><br><span class="line">    &#125; Persistence;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ������֤</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        BOOLEAN ValidationEnabled;</span><br><span class="line">        PFN_CONFIG_VALIDATE ValidateCallback;</span><br><span class="line">        PVOID ValidateContext;</span><br><span class="line">    &#125; Validation;</span><br><span class="line">&#125; CONFIG_MANAGER, *PCONFIG_MANAGER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ�����ù�����</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeConfigManager</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDEVICE_CONTEXT DevContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PCONFIG_MANAGER cfgMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �������ù�����</span></span><br><span class="line">    cfgMgr = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(CONFIG_MANAGER),</span><br><span class="line">        <span class="string">&#x27;CMPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!cfgMgr) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(cfgMgr, <span class="keyword">sizeof</span>(CONFIG_MANAGER));</span><br><span class="line">    cfgMgr-&gt;DevContext = DevContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ�����ô洢</span></span><br><span class="line">    KeInitializeSpinLock(&amp;cfgMgr-&gt;Storage.ItemLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Ԥ��������������</span></span><br><span class="line">    cfgMgr-&gt;Storage.Items = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(CONFIG_ITEM_DESCRIPTOR) * MAX_CONFIG_ITEMS,</span><br><span class="line">        <span class="string">&#x27;CIPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!cfgMgr-&gt;Storage.Items) &#123;</span><br><span class="line">        status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(</span><br><span class="line">        cfgMgr-&gt;Storage.Items,</span><br><span class="line">        <span class="keyword">sizeof</span>(CONFIG_ITEM_DESCRIPTOR) * MAX_CONFIG_ITEMS);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 3. ��ʼ��֪ͨϵͳ</span></span><br><span class="line">    InitializeListHead(&amp;cfgMgr-&gt;Notification.NotifyList);</span><br><span class="line">    KeInitializeSpinLock(&amp;cfgMgr-&gt;Notification.NotifyLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����Ĭ������</span></span><br><span class="line">    cfgMgr-&gt;Persistence.PersistenceEnabled = TRUE;</span><br><span class="line">    cfgMgr-&gt;Validation.ValidationEnabled = TRUE;</span><br><span class="line">    </span><br><span class="line">    DevContext-&gt;ConfigManager = cfgMgr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ���س־û�����</span></span><br><span class="line">    <span class="keyword">if</span> (cfgMgr-&gt;Persistence.PersistenceEnabled) &#123;</span><br><span class="line">        status = RtsPciLoadPersistedConfig(cfgMgr);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="comment">// ����ʧ��ʱʹ��Ĭ��ֵ</span></span><br><span class="line">            RtsPciInitializeDefaultConfig(cfgMgr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">cleanup:</span><br><span class="line">    RtsPciCleanupConfigManager(cfgMgr);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>










<h3 id="23-2-���������"><a href="#23-2-���������" class="headerlink" title="23.2 ���������"></a>23.2 ���������</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ע��������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciRegisterConfigItem</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCONFIG_MANAGER CfgMgr,</span></span><br><span class="line"><span class="params">    _In_ PWCHAR Name,</span></span><br><span class="line"><span class="params">    _In_ CONFIG_ITEM_TYPE Type,</span></span><br><span class="line"><span class="params">    _In_ CONFIG_ACCESS Access,</span></span><br><span class="line"><span class="params">    _In_ PVOID DefaultValue,</span></span><br><span class="line"><span class="params">    _In_opt_ PVOID Constraints</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    KIRQL oldIrql;</span><br><span class="line">    PCONFIG_ITEM_DESCRIPTOR item = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��֤����</span></span><br><span class="line">    <span class="keyword">if</span> (!Name || !DefaultValue) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����Ƿ��Ѵ���</span></span><br><span class="line">    KeAcquireSpinLock(&amp;CfgMgr-&gt;Storage.ItemLock, &amp;oldIrql);</span><br><span class="line">    </span><br><span class="line">    item = RtsPciFindConfigItem(CfgMgr, Name);</span><br><span class="line">    <span class="keyword">if</span> (item) &#123;</span><br><span class="line">        KeReleaseSpinLock(&amp;CfgMgr-&gt;Storage.ItemLock, oldIrql);</span><br><span class="line">        <span class="keyword">return</span> STATUS_DUPLICATE_NAME;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ������������</span></span><br><span class="line">    <span class="keyword">if</span> (CfgMgr-&gt;Storage.ItemCount &gt;= MAX_CONFIG_ITEMS) &#123;</span><br><span class="line">        KeReleaseSpinLock(&amp;CfgMgr-&gt;Storage.ItemLock, oldIrql);</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    item = &amp;CfgMgr-&gt;Storage.Items[CfgMgr-&gt;Storage.ItemCount];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ��ʼ��������</span></span><br><span class="line">    RtlZeroMemory(item, <span class="keyword">sizeof</span>(CONFIG_ITEM_DESCRIPTOR));</span><br><span class="line">    RtlStringCchCopyW(item-&gt;Name, ARRAYSIZE(item-&gt;Name), Name);</span><br><span class="line">    item-&gt;Type = Type;</span><br><span class="line">    item-&gt;Access = Access;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ������������Ĭ��ֵ</span></span><br><span class="line">    <span class="keyword">switch</span> (Type) &#123;</span><br><span class="line">        <span class="keyword">case</span> ConfigTypeInteger:</span><br><span class="line">            &#123;</span><br><span class="line">                PCONFIG_INTEGER_CONSTRAINTS constraints = </span><br><span class="line">                    (PCONFIG_INTEGER_CONSTRAINTS)Constraints;</span><br><span class="line">                    </span><br><span class="line">                item-&gt;Data.Integer.DefaultValue = </span><br><span class="line">                    *(PLONG)DefaultValue;</span><br><span class="line">                item-&gt;Data.Integer.CurrentValue = </span><br><span class="line">                    *(PLONG)DefaultValue;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">if</span> (constraints) &#123;</span><br><span class="line">                    item-&gt;Data.Integer.MinValue = </span><br><span class="line">                        constraints-&gt;MinValue;</span><br><span class="line">                    item-&gt;Data.Integer.MaxValue = </span><br><span class="line">                        constraints-&gt;MaxValue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ConfigTypeBoolean:</span><br><span class="line">            item-&gt;Data.Boolean.DefaultValue = </span><br><span class="line">                *(PBOOLEAN)DefaultValue;</span><br><span class="line">            item-&gt;Data.Boolean.CurrentValue = </span><br><span class="line">                *(PBOOLEAN)DefaultValue;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ConfigTypeString:</span><br><span class="line">            &#123;</span><br><span class="line">                PCONFIG_STRING_CONSTRAINTS constraints =</span><br><span class="line">                    (PCONFIG_STRING_CONSTRAINTS)Constraints;</span><br><span class="line">                    </span><br><span class="line">                RtlStringCchCopyW(</span><br><span class="line">                    item-&gt;Data.String.DefaultValue,</span><br><span class="line">                    ARRAYSIZE(item-&gt;Data.String.DefaultValue),</span><br><span class="line">                    (PWCHAR)DefaultValue);</span><br><span class="line">                    </span><br><span class="line">                RtlStringCchCopyW(</span><br><span class="line">                    item-&gt;Data.String.CurrentValue,</span><br><span class="line">                    ARRAYSIZE(item-&gt;Data.String.CurrentValue),</span><br><span class="line">                    (PWCHAR)DefaultValue);</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">if</span> (constraints) &#123;</span><br><span class="line">                    item-&gt;Data.String.MaxLength = </span><br><span class="line">                        constraints-&gt;MaxLength;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ConfigTypeBinary:</span><br><span class="line">            &#123;</span><br><span class="line">                PCONFIG_BINARY_CONSTRAINTS constraints =</span><br><span class="line">                    (PCONFIG_BINARY_CONSTRAINTS)Constraints;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">if</span> (constraints &amp;&amp; constraints-&gt;Length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    item-&gt;Data.Binary.DefaultValue = </span><br><span class="line">                        ExAllocatePoolWithTag(</span><br><span class="line">                            NonPagedPool,</span><br><span class="line">                            constraints-&gt;Length,</span><br><span class="line">                            <span class="string">&#x27;CBPR&#x27;</span>);</span><br><span class="line">                            </span><br><span class="line">                    item-&gt;Data.Binary.CurrentValue = </span><br><span class="line">                        ExAllocatePoolWithTag(</span><br><span class="line">                            NonPagedPool,</span><br><span class="line">                            constraints-&gt;Length,</span><br><span class="line">                            <span class="string">&#x27;CBPR&#x27;</span>);</span><br><span class="line">                            </span><br><span class="line">                    <span class="keyword">if</span> (!item-&gt;Data.Binary.DefaultValue ||</span><br><span class="line">                        !item-&gt;Data.Binary.CurrentValue) &#123;</span><br><span class="line">                        status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    RtlCopyMemory(</span><br><span class="line">                        item-&gt;Data.Binary.DefaultValue,</span><br><span class="line">                        DefaultValue,</span><br><span class="line">                        constraints-&gt;Length);</span><br><span class="line">                        </span><br><span class="line">                    RtlCopyMemory(</span><br><span class="line">                        item-&gt;Data.Binary.CurrentValue,</span><br><span class="line">                        DefaultValue,</span><br><span class="line">                        constraints-&gt;Length);</span><br><span class="line">                        </span><br><span class="line">                    item-&gt;Data.Binary.Length = constraints-&gt;Length;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        CfgMgr-&gt;Storage.ItemCount++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    KeReleaseSpinLock(&amp;CfgMgr-&gt;Storage.ItemLock, oldIrql);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>










<h3 id="23-3-���o־u�"><a href="#23-3-���o־u�" class="headerlink" title="23.3 ���ó־û�"></a>23.3 ���ó־û�</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �������õ�ע���</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciSaveConfigToRegistry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCONFIG_MANAGER CfgMgr</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    HANDLE regKey;</span><br><span class="line">    UNICODE_STRING valueName;</span><br><span class="line">    PCONFIG_ITEM_DESCRIPTOR item;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ע�����</span></span><br><span class="line">    status = RtsPciOpenConfigRegistry(</span><br><span class="line">        CfgMgr,</span><br><span class="line">        &amp;regKey,</span><br><span class="line">        TRUE);  <span class="comment">// �������������</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��������������</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; CfgMgr-&gt;Storage.ItemCount; i++) &#123;</span><br><span class="line">        item = &amp;CfgMgr-&gt;Storage.Items[i];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ֻ�������޸ĵ���</span></span><br><span class="line">        <span class="keyword">if</span> (!item-&gt;Modified) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        RtlInitUnicodeString(&amp;valueName, item-&gt;Name);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. �������ͱ���ֵ</span></span><br><span class="line">        <span class="keyword">switch</span> (item-&gt;Type) &#123;</span><br><span class="line">            <span class="keyword">case</span> ConfigTypeInteger:</span><br><span class="line">                status = RtlWriteRegistryValue(</span><br><span class="line">                    RTL_REGISTRY_ABSOLUTE,</span><br><span class="line">                    CfgMgr-&gt;Persistence.RegistryPath,</span><br><span class="line">                    valueName.Buffer,</span><br><span class="line">                    REG_DWORD,</span><br><span class="line">                    &amp;item-&gt;Data.Integer.CurrentValue,</span><br><span class="line">                    <span class="keyword">sizeof</span>(LONG));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> ConfigTypeBoolean:</span><br><span class="line">                &#123;</span><br><span class="line">                    ULONG value = item-&gt;Data.Boolean.CurrentValue;</span><br><span class="line">                    status = RtlWriteRegistryValue(</span><br><span class="line">                        RTL_REGISTRY_ABSOLUTE,</span><br><span class="line">                        CfgMgr-&gt;Persistence.RegistryPath,</span><br><span class="line">                        valueName.Buffer,</span><br><span class="line">                        REG_DWORD,</span><br><span class="line">                        &amp;value,</span><br><span class="line">                        <span class="keyword">sizeof</span>(ULONG));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> ConfigTypeString:</span><br><span class="line">                status = RtlWriteRegistryValue(</span><br><span class="line">                    RTL_REGISTRY_ABSOLUTE,</span><br><span class="line">                    CfgMgr-&gt;Persistence.RegistryPath,</span><br><span class="line">                    valueName.Buffer,</span><br><span class="line">                    REG_SZ,</span><br><span class="line">                    item-&gt;Data.String.CurrentValue,</span><br><span class="line">                    (wcslen(item-&gt;Data.String.CurrentValue) + <span class="number">1</span>) * </span><br><span class="line">                        <span class="keyword">sizeof</span>(WCHAR));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> ConfigTypeBinary:</span><br><span class="line">                status = RtlWriteRegistryValue(</span><br><span class="line">                    RTL_REGISTRY_ABSOLUTE,</span><br><span class="line">                    CfgMgr-&gt;Persistence.RegistryPath,</span><br><span class="line">                    valueName.Buffer,</span><br><span class="line">                    REG_BINARY,</span><br><span class="line">                    item-&gt;Data.Binary.CurrentValue,</span><br><span class="line">                    item-&gt;Data.Binary.Length);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            item-&gt;Modified = FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ZwClose(regKey);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ע�����������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciLoadConfigFromRegistry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCONFIG_MANAGER CfgMgr</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    HANDLE regKey;</span><br><span class="line">    UNICODE_STRING valueName;</span><br><span class="line">    PCONFIG_ITEM_DESCRIPTOR item;</span><br><span class="line">    UCHAR buffer[<span class="number">512</span>];</span><br><span class="line">    ULONG length;</span><br><span class="line">    PKEY_VALUE_PARTIAL_INFORMATION valueInfo;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��ע�����</span></span><br><span class="line">    status = RtsPciOpenConfigRegistry(</span><br><span class="line">        CfgMgr,</span><br><span class="line">        &amp;regKey,</span><br><span class="line">        FALSE);  <span class="comment">// ������</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    valueInfo = (PKEY_VALUE_PARTIAL_INFORMATION)buffer;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��������������</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; CfgMgr-&gt;Storage.ItemCount; i++) &#123;</span><br><span class="line">        item = &amp;CfgMgr-&gt;Storage.Items[i];</span><br><span class="line">        RtlInitUnicodeString(&amp;valueName, item-&gt;Name);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. ��ȡע���ֵ</span></span><br><span class="line">        status = ZwQueryValueKey(</span><br><span class="line">            regKey,</span><br><span class="line">            &amp;valueName,</span><br><span class="line">            KeyValuePartialInformation,</span><br><span class="line">            valueInfo,</span><br><span class="line">            <span class="keyword">sizeof</span>(buffer),</span><br><span class="line">            &amp;length);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="comment">// 4. �������͸���ֵ</span></span><br><span class="line">            <span class="keyword">switch</span> (item-&gt;Type) &#123;</span><br><span class="line">                <span class="keyword">case</span> ConfigTypeInteger:</span><br><span class="line">                    <span class="keyword">if</span> (valueInfo-&gt;Type == REG_DWORD &amp;&amp;</span><br><span class="line">                        valueInfo-&gt;DataLength == <span class="keyword">sizeof</span>(LONG)) &#123;</span><br><span class="line">                        item-&gt;Data.Integer.CurrentValue = </span><br><span class="line">                            *(PLONG)valueInfo-&gt;Data;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> ConfigTypeBoolean:</span><br><span class="line">                    <span class="keyword">if</span> (valueInfo-&gt;Type == REG_DWORD &amp;&amp;</span><br><span class="line">                        valueInfo-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG)) &#123;</span><br><span class="line">                        item-&gt;Data.Boolean.CurrentValue = </span><br><span class="line">                            (*(PULONG)valueInfo-&gt;Data != <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> ConfigTypeString:</span><br><span class="line">                    <span class="keyword">if</span> (valueInfo-&gt;Type == REG_SZ) &#123;</span><br><span class="line">                        RtlStringCchCopyW(</span><br><span class="line">                            item-&gt;Data.String.CurrentValue,</span><br><span class="line">                            ARRAYSIZE(item-&gt;Data.String.CurrentValue),</span><br><span class="line">                            (PWCHAR)valueInfo-&gt;Data);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> ConfigTypeBinary:</span><br><span class="line">                    <span class="keyword">if</span> (valueInfo-&gt;Type == REG_BINARY &amp;&amp;</span><br><span class="line">                        valueInfo-&gt;DataLength &lt;= item-&gt;Data.Binary.Length) &#123;</span><br><span class="line">                        RtlCopyMemory(</span><br><span class="line">                            item-&gt;Data.Binary.CurrentValue,</span><br><span class="line">                            valueInfo-&gt;Data,</span><br><span class="line">                            valueInfo-&gt;DataLength);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ZwClose(regKey);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>










<p>[���� - ��һ���ֽ���ϸ���ܸ߼���ȫ����]</p>
<p>��Ҫ�Ҽ���չ������������</p>
<h2 id="User-57"><a href="#User-57" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����û��</p>
<h2 id="AI-claude-3-5-sonnet-57"><a href="#AI-claude-3-5-sonnet-57" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>���м�����Ҫ������Ҫչ����</p>
<ol>
<li>�߼���ȫ����</li>
<li>�߼���Ϲ���</li>
<li>�߼�ң�⹦��</li>
<li>�߼��̼�����</li>
<li>���������Բ���</li>
<li>�����������ܻ�׼����</li>
<li>������������Բ���</li>
<li>���������ĵ�����</li>
</ol>
<p>����������ĸ����֣������Ѿ������ˣ���Щ������Ը߼��Ĺ���ģ�飬����ÿ����������Ҫʵ����ô�����Ĺ��ܡ��ҿ��Ը���������Ȥѡ���Ե�չ��ĳЩ���֣����ߵ���Ϊֹ��</p>
<p>����������Ѿ��㹻�ˣ����ǿ��Խ������ϵ�С��Ͼ�ǰ���Ѿ�������SD������������������Ҫ���Ĺ���ʵ�֡�</p>
<p>�������أ�</p>
<h2 id="User-58"><a href="#User-58" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>���������ĵ�����</p>
<h2 id="AI-claude-3-5-sonnet-58"><a href="#AI-claude-3-5-sonnet-58" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�õģ�����չ�����������ĵ����ɲ��֣�</p>
<h1 id="WDF-SD-Host-Controller����ʵ�����-Part-23"><a href="#WDF-SD-Host-Controller����ʵ�����-Part-23" class="headerlink" title="WDF SD Host Controller����ʵ����� - Part 23"></a>WDF SD Host Controller����ʵ����� - Part 23</h1><h2 id="24-���������j�����"><a href="#24-���������j�����" class="headerlink" title="24. ���������ĵ�����"></a>24. ���������ĵ�����</h2><h3 id="24-1-�j�������ʵ��"><a href="#24-1-�j�������ʵ��" class="headerlink" title="24.1 �ĵ�������ʵ��"></a>24.1 �ĵ�������ʵ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// �ĵ����Ͷ���</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">DOC_TYPE</span> &#123;</span></span><br><span class="line">    DocTypeAPI = <span class="number">0</span>,</span><br><span class="line">    DocTypeArchitecture,</span><br><span class="line">    DocTypeDeployment,</span><br><span class="line">    DocTypeTesting,</span><br><span class="line">    DocTypeMax</span><br><span class="line">&#125; DOC_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �ĵ���ʽ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">DOC_FORMAT</span> &#123;</span></span><br><span class="line">    DocFormatMarkdown = <span class="number">0</span>,</span><br><span class="line">    DocFormatHTML,</span><br><span class="line">    DocFormatPDF,</span><br><span class="line">    DocFormatRTF</span><br><span class="line">&#125; DOC_FORMAT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// �ĵ�������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DOC_GENERATOR</span> &#123;</span></span><br><span class="line">    <span class="comment">// ��������</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        DOC_FORMAT OutputFormat;</span><br><span class="line">        WCHAR OutputPath[MAX_PATH];</span><br><span class="line">        BOOLEAN IncludePrivate;</span><br><span class="line">        BOOLEAN IncludeInternal;</span><br><span class="line">        BOOLEAN GenerateIndex;</span><br><span class="line">        BOOLEAN GenerateDiagrams;</span><br><span class="line">    &#125; Config;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Դ�������</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY SourceFiles;</span><br><span class="line">        KSPIN_LOCK SourceLock;</span><br><span class="line">        ULONG FileCount;</span><br><span class="line">        ULONG TotalLines;</span><br><span class="line">    &#125; Source;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// API�ĵ�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY Functions;</span><br><span class="line">        LIST_ENTRY Structures;</span><br><span class="line">        LIST_ENTRY Enums;</span><br><span class="line">        LIST_ENTRY Callbacks;</span><br><span class="line">        KSPIN_LOCK ApiLock;</span><br><span class="line">    &#125; API;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ܹ��ĵ�</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        LIST_ENTRY Components;</span><br><span class="line">        LIST_ENTRY Interfaces;</span><br><span class="line">        LIST_ENTRY Dependencies;</span><br><span class="line">        KSPIN_LOCK ArchLock;</span><br><span class="line">    &#125; Architecture;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// �ĵ�ģ��</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        PWCHAR HeaderTemplate;</span><br><span class="line">        PWCHAR FooterTemplate;</span><br><span class="line">        PWCHAR FunctionTemplate;</span><br><span class="line">        PWCHAR StructTemplate;</span><br><span class="line">        PWCHAR EnumTemplate;</span><br><span class="line">    &#125; Templates;</span><br><span class="line">&#125; DOC_GENERATOR, *PDOC_GENERATOR;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʼ���ĵ�������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciInitializeDocGenerator</span><span class="params">(</span></span><br><span class="line"><span class="params">    _Out_ PDOC_GENERATOR* DocGen</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PDOC_GENERATOR docGen;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �����ĵ�������</span></span><br><span class="line">    docGen = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(DOC_GENERATOR),</span><br><span class="line">        <span class="string">&#x27;DGPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!docGen) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(docGen, <span class="keyword">sizeof</span>(DOC_GENERATOR));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ʼ���б�����</span></span><br><span class="line">    InitializeListHead(&amp;docGen-&gt;Source.SourceFiles);</span><br><span class="line">    InitializeListHead(&amp;docGen-&gt;API.Functions);</span><br><span class="line">    InitializeListHead(&amp;docGen-&gt;API.Structures);</span><br><span class="line">    InitializeListHead(&amp;docGen-&gt;API.Enums);</span><br><span class="line">    InitializeListHead(&amp;docGen-&gt;API.Callbacks);</span><br><span class="line">    InitializeListHead(&amp;docGen-&gt;Architecture.Components);</span><br><span class="line">    InitializeListHead(&amp;docGen-&gt;Architecture.Interfaces);</span><br><span class="line">    InitializeListHead(&amp;docGen-&gt;Architecture.Dependencies);</span><br><span class="line">    </span><br><span class="line">    KeInitializeSpinLock(&amp;docGen-&gt;Source.SourceLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;docGen-&gt;API.ApiLock);</span><br><span class="line">    KeInitializeSpinLock(&amp;docGen-&gt;Architecture.ArchLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����Ĭ������</span></span><br><span class="line">    docGen-&gt;Config.OutputFormat = DocFormatMarkdown;</span><br><span class="line">    docGen-&gt;Config.IncludePrivate = FALSE;</span><br><span class="line">    docGen-&gt;Config.IncludeInternal = TRUE;</span><br><span class="line">    docGen-&gt;Config.GenerateIndex = TRUE;</span><br><span class="line">    docGen-&gt;Config.GenerateDiagrams = TRUE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �����ĵ�ģ��</span></span><br><span class="line">    RtsPciLoadDocTemplates(docGen);</span><br><span class="line">    </span><br><span class="line">    *DocGen = docGen;</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>










<h3 id="24-2-Դ���������API��ȡ"><a href="#24-2-Դ���������API��ȡ" class="headerlink" title="24.2 Դ���������API��ȡ"></a>24.2 Դ���������API��ȡ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Դ�ļ�����������</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SOURCE_PARSE_CONTEXT</span> &#123;</span></span><br><span class="line">    PWCHAR FilePath;</span><br><span class="line">    PWCHAR FileContent;</span><br><span class="line">    SIZE_T FileSize;</span><br><span class="line">    ULONG LineCount;</span><br><span class="line">    ULONG CurrentLine;</span><br><span class="line">    PWCHAR CurrentPos;</span><br><span class="line">&#125; SOURCE_PARSE_CONTEXT, *PSOURCE_PARSE_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ����Դ�ļ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciParseSourceFile</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDOC_GENERATOR DocGen,</span></span><br><span class="line"><span class="params">    _In_ PWCHAR FilePath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    SOURCE_PARSE_CONTEXT parseCtx = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    HANDLE fileHandle;</span><br><span class="line">    LARGE_INTEGER fileSize;</span><br><span class="line">    IO_STATUS_BLOCK ioStatus;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��Դ�ļ�</span></span><br><span class="line">    status = RtsPciOpenSourceFile(FilePath, &amp;fileHandle);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ȡ�ļ�����</span></span><br><span class="line">    status = ZwQueryInformationFile(</span><br><span class="line">        fileHandle,</span><br><span class="line">        &amp;ioStatus,</span><br><span class="line">        &amp;fileSize,</span><br><span class="line">        <span class="keyword">sizeof</span>(fileSize),</span><br><span class="line">        FileStandardInformation);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        ZwClose(fileHandle);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    parseCtx.FileContent = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        fileSize.QuadPart,</span><br><span class="line">        <span class="string">&#x27;SFPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!parseCtx.FileContent) &#123;</span><br><span class="line">        ZwClose(fileHandle);</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    status = ZwReadFile(</span><br><span class="line">        fileHandle,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;ioStatus,</span><br><span class="line">        parseCtx.FileContent,</span><br><span class="line">        fileSize.LowPart,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">    ZwClose(fileHandle);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        ExFreePool(parseCtx.FileContent);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʼ������������</span></span><br><span class="line">    parseCtx.FilePath = FilePath;</span><br><span class="line">    parseCtx.FileSize = fileSize.QuadPart;</span><br><span class="line">    parseCtx.CurrentPos = parseCtx.FileContent;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. �����ļ�����</span></span><br><span class="line">    <span class="keyword">while</span> (parseCtx.CurrentPos &lt; </span><br><span class="line">           parseCtx.FileContent + parseCtx.FileSize) &#123;</span><br><span class="line">        <span class="comment">// ������������</span></span><br><span class="line">        status = RtsPciParseFunctionDefinition(DocGen, &amp;parseCtx);</span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// �����ṹ����</span></span><br><span class="line">        status = RtsPciParseStructDefinition(DocGen, &amp;parseCtx);</span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ����ö�ٶ���</span></span><br><span class="line">        status = RtsPciParseEnumDefinition(DocGen, &amp;parseCtx);</span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// �����ص�����</span></span><br><span class="line">        status = RtsPciParseCallbackDefinition(DocGen, &amp;parseCtx);</span><br><span class="line">        <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// �ƶ�����һ��</span></span><br><span class="line">        RtsPciAdvanceToNextLine(&amp;parseCtx);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����</span></span><br><span class="line">    ExFreePool(parseCtx.FileContent);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ������������</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciParseFunctionDefinition</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDOC_GENERATOR DocGen,</span></span><br><span class="line"><span class="params">    _In_ PSOURCE_PARSE_CONTEXT ParseCtx</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    PFUNCTION_DOC_ENTRY funcEntry;</span><br><span class="line">    PWCHAR funcStart, funcEnd;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ���Һ�����ʼ���</span></span><br><span class="line">    funcStart = RtsPciFindFunctionStart(ParseCtx-&gt;CurrentPos);</span><br><span class="line">    <span class="keyword">if</span> (!funcStart) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_NOT_FOUND;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ���Һ����������</span></span><br><span class="line">    funcEnd = RtsPciFindFunctionEnd(funcStart);</span><br><span class="line">    <span class="keyword">if</span> (!funcEnd) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_NOT_FOUND;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���������ĵ���Ŀ</span></span><br><span class="line">    funcEntry = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        <span class="keyword">sizeof</span>(FUNCTION_DOC_ENTRY),</span><br><span class="line">        <span class="string">&#x27;FDPR&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!funcEntry) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RtlZeroMemory(funcEntry, <span class="keyword">sizeof</span>(FUNCTION_DOC_ENTRY));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����������Ϣ</span></span><br><span class="line">    status = RtsPciExtractFunctionInfo(</span><br><span class="line">        funcStart,</span><br><span class="line">        funcEnd - funcStart,</span><br><span class="line">        funcEntry);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="comment">// 5. ���ӵ�API�ĵ�</span></span><br><span class="line">        ExInterlockedInsertTailList(</span><br><span class="line">            &amp;DocGen-&gt;API.Functions,</span><br><span class="line">            &amp;funcEntry-&gt;ListEntry,</span><br><span class="line">            &amp;DocGen-&gt;API.ApiLock);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ExFreePool(funcEntry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ���½���λ��</span></span><br><span class="line">    ParseCtx-&gt;CurrentPos = funcEnd;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>










<h3 id="24-3-�j����ɺ͸�ʽ��"><a href="#24-3-�j����ɺ͸�ʽ��" class="headerlink" title="24.3 �ĵ����ɺ͸�ʽ��"></a>24.3 �ĵ����ɺ͸�ʽ��</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ����API�ĵ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciGenerateApiDocumentation</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDOC_GENERATOR DocGen,</span></span><br><span class="line"><span class="params">    _In_ PWCHAR OutputPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    HANDLE fileHandle;</span><br><span class="line">    IO_STATUS_BLOCK ioStatus;</span><br><span class="line">    PLIST_ENTRY entry;</span><br><span class="line">    UNICODE_STRING fileName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. ��������ļ�</span></span><br><span class="line">    RtlInitUnicodeString(&amp;fileName, OutputPath);</span><br><span class="line">    </span><br><span class="line">    status = RtsPciCreateOutputFile(</span><br><span class="line">        &amp;fileName,</span><br><span class="line">        &amp;fileHandle);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. д���ĵ�ͷ��</span></span><br><span class="line">    status = RtsPciWriteDocHeader(</span><br><span class="line">        fileHandle,</span><br><span class="line">        DocGen-&gt;Templates.HeaderTemplate);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���ɺ����ĵ�</span></span><br><span class="line">    <span class="keyword">for</span> (entry = DocGen-&gt;API.Functions.Flink;</span><br><span class="line">         entry != &amp;DocGen-&gt;API.Functions;</span><br><span class="line">         entry = entry-&gt;Flink) &#123;</span><br><span class="line">        PFUNCTION_DOC_ENTRY funcEntry = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            FUNCTION_DOC_ENTRY,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        status = RtsPciFormatFunctionDoc(</span><br><span class="line">            DocGen,</span><br><span class="line">            funcEntry,</span><br><span class="line">            fileHandle);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ���ɽṹ�ĵ�</span></span><br><span class="line">    <span class="keyword">for</span> (entry = DocGen-&gt;API.Structures.Flink;</span><br><span class="line">         entry != &amp;DocGen-&gt;API.Structures;</span><br><span class="line">         entry = entry-&gt;Flink) &#123;</span><br><span class="line">        PSTRUCT_DOC_ENTRY structEntry = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            STRUCT_DOC_ENTRY,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        status = RtsPciFormatStructDoc(</span><br><span class="line">            DocGen,</span><br><span class="line">            structEntry,</span><br><span class="line">            fileHandle);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ����ö���ĵ�</span></span><br><span class="line">    <span class="keyword">for</span> (entry = DocGen-&gt;API.Enums.Flink;</span><br><span class="line">         entry != &amp;DocGen-&gt;API.Enums;</span><br><span class="line">         entry = entry-&gt;Flink) &#123;</span><br><span class="line">        PENUM_DOC_ENTRY enumEntry = CONTAINING_RECORD(</span><br><span class="line">            entry,</span><br><span class="line">            ENUM_DOC_ENTRY,</span><br><span class="line">            ListEntry);</span><br><span class="line">            </span><br><span class="line">        status = RtsPciFormatEnumDoc(</span><br><span class="line">            DocGen,</span><br><span class="line">            enumEntry,</span><br><span class="line">            fileHandle);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. д���ĵ�β��</span></span><br><span class="line">    status = RtsPciWriteDocFooter(</span><br><span class="line">        fileHandle,</span><br><span class="line">        DocGen-&gt;Templates.FooterTemplate);</span><br><span class="line">        </span><br><span class="line">cleanup:</span><br><span class="line">    ZwClose(fileHandle);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ��ʽ�������ĵ�</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciFormatFunctionDoc</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDOC_GENERATOR DocGen,</span></span><br><span class="line"><span class="params">    _In_ PFUNCTION_DOC_ENTRY FuncEntry,</span></span><br><span class="line"><span class="params">    _In_ HANDLE FileHandle</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PWCHAR buffer;</span><br><span class="line">    SIZE_T bufferSize;</span><br><span class="line">    IO_STATUS_BLOCK ioStatus;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. �������軺������С</span></span><br><span class="line">    bufferSize = RtsPciCalculateFunctionDocSize(</span><br><span class="line">        DocGen-&gt;Templates.FunctionTemplate,</span><br><span class="line">        FuncEntry);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 2. ���仺����</span></span><br><span class="line">    buffer = ExAllocatePoolWithTag(</span><br><span class="line">        NonPagedPool,</span><br><span class="line">        bufferSize,</span><br><span class="line">        <span class="string">&#x27;FDOC&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!buffer) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ��ʽ�������ĵ�</span></span><br><span class="line">    status = RtsPciFormatFunctionDocContent(</span><br><span class="line">        DocGen-&gt;Templates.FunctionTemplate,</span><br><span class="line">        FuncEntry,</span><br><span class="line">        buffer,</span><br><span class="line">        bufferSize);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(status)) &#123;</span><br><span class="line">        <span class="comment">// 4. д���ļ�</span></span><br><span class="line">        status = ZwWriteFile(</span><br><span class="line">            FileHandle,</span><br><span class="line">            <span class="literal">NULL</span>,</span><br><span class="line">            <span class="literal">NULL</span>,</span><br><span class="line">            <span class="literal">NULL</span>,</span><br><span class="line">            &amp;ioStatus,</span><br><span class="line">            buffer,</span><br><span class="line">            (ULONG)wcslen(buffer) * <span class="keyword">sizeof</span>(WCHAR),</span><br><span class="line">            <span class="literal">NULL</span>,</span><br><span class="line">            <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ExFreePool(buffer);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ���ɼܹ�ͼ</span></span><br><span class="line">NTSTATUS <span class="title function_">RtsPciGenerateArchitectureDiagram</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDOC_GENERATOR DocGen,</span></span><br><span class="line"><span class="params">    _In_ PWCHAR OutputPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ʹ��Graphviz������ͼ�ο����ɼܹ�ͼ</span></span><br><span class="line">    <span class="comment">// ����ʡ�Ծ���ʵ��...</span></span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>










<p>��������������ĵ�����������Ҫʵ�֡������ԣ�</p>
<ol>
<li>�Զ�����Դ���룬��ȡAPI���塢�ṹ��ö�ٵ�</li>
<li>���ɸ�ʽ����API�ĵ�</li>
<li>���ɼܹ�ͼ�������ϵͼ</li>
<li>֧�ֶ��������ʽ(Markdown��HTML��PDF��)</li>
<li>�����õ��ĵ�����ѡ��</li>
</ol>
<p>����ĵ�����������ά����������������Ŀ���а��������Ա��ִ�����ĵ���ͬ���ԡ�</p>
<p>��Ҫ�Ҽ���չ�����������𣿻��ǵ���Ϊֹ��</p>
<h2 id="User-59"><a href="#User-59" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����һ��SD������������������Ҫ���Ĺ��������ļ�������</p>
<h2 id="AI-claude-3-5-sonnet-59"><a href="#AI-claude-3-5-sonnet-59" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>SD������������������Ҫ���Ĺ�����Ҫ���������¼����ؼ����֣�</p>
<ol>
<li>�豸��ʼ���ͻ�������</li>
</ol>
<ul>
<li>�豸�����ĳ�ʼ��</li>
<li>Ӳ����Դ��ȡ��ӳ��</li>
<li>�Ĵ�������</li>
<li>�жϳ�ʼ��</li>
</ul>
<ol start="2">
<li>I&#x2F;O������</li>
</ol>
<ul>
<li>��д������</li>
<li>����������</li>
<li>DMA�������</li>
<li>������й���</li>
</ul>
<ol start="3">
<li>�жϴ���</li>
</ol>
<ul>
<li>�жϷ�������(ISR)</li>
<li>DPC����</li>
<li>�����жϴ���</li>
<li>�жϺϲ��Ż�</li>
</ul>
<ol start="4">
<li>��Դ����</li>
</ol>
<ul>
<li>��Դ״̬ת��</li>
<li>�͹���ģʽ����</li>
<li>���Ѵ���</li>
<li>��̬��Դ����</li>
</ul>
<ol start="5">
<li>�������ͻָ�</li>
</ol>
<ul>
<li>Ӳ��������</li>
<li>����ָ�����</li>
<li>��ʱ����</li>
<li>���Ի���</li>
</ul>
<p>��Щ��������͹ؼ��Ĺ���ģ�顣������߼����ԡ������Ż������ù����ȶ�������Щ���Ĺ��ܻ����ϵ���չ���ܡ�</p>
<p>Ҫʵ��һ���������õ�SD�����������������ص���Ҫʵ�ֺ��⼸�����Ĳ��֡�����I&#x2F;O�������жϴ�������ؼ��Ĳ��֣���Ϊ����ֱ��Ӱ�����������ܺ��ȶ��ԡ�</p>
<h2 id="User-60"><a href="#User-60" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>SD����������������INF�ļ���classnameӦ����ʲô����</p>
<h2 id="AI-claude-3-5-sonnet-60"><a href="#AI-claude-3-5-sonnet-60" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>����SD����������������INF�ļ��е�ClassӦ������Ϊ��</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">Class=SDHost</span><br><span class="line">ClassGuid=&#123;4D36E978-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line">Provider=%ManufacturerName%</span><br><span class="line">CatalogFile=YourDriver.cat</span><br><span class="line">DriverVer=</span><br><span class="line">PnpLockdown=1</span><br></pre></td></tr></table></figure>

<p>SDHost��ר��ΪSD�����������豸������豸�ࡣ������ר������:</p>
<ol>
<li>SD����������</li>
<li>SDIO����������</li>
<li>MMC����������</li>
</ol>
<p>ʹ����ȷ���豸������Ҫ����Ϊ��������:</p>
<ol>
<li>Windows��μ��غ͹����������</li>
<li>�������豸�������е���ʾλ��</li>
<li>ϵͳ�������豸��Ĭ�ϲ��Ժʹ�����ʽ</li>
</ol>
<p>ע�⣺ClassGuid�ǹ̶�ֵ�����GUID��WindowsϵͳԤ����ģ�ר�����ڱ�ʶSDHost���豸��</p>
<h2 id="User-61"><a href="#User-61" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>SD Host���̵�������ʹ��Class SDHost��</p>
<h2 id="AI-claude-3-5-sonnet-61"><a href="#AI-claude-3-5-sonnet-61" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>���ܡ�����SD Host���̵���������Intel��AMD��Realtek�ȵ�SD������������������Ӧ��ʹ�ã�</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">Class=System</span><br><span class="line">ClassGuid=&#123;4D36E97D-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line">Provider=%ManufacturerName%</span><br><span class="line">CatalogFile=YourDriver.cat</span><br><span class="line">DriverVer=</span><br><span class="line">PnpLockdown=1</span><br></pre></td></tr></table></figure>

<p>ԭ��</p>
<ol>
<li>SDHost����ΪMicrosoft��ͨ��SD��������������(sdhost.sys)������</li>
<li>���������̵�SD��������������Ӧ��ʹ��System��</li>
<li>��Щ����ͨ������Ϊϵͳ������У���Ҫ���ߵ�ϵͳȨ��</li>
</ol>
<p>����˵����</p>
<ul>
<li>����ǿ����Լ���SD��������������Ӧ��ʹ��SDHost��</li>
<li>����ǿ��������ϼ��ɵ�SD����������������Ӧ��ʹ��System��</li>
<li>Microsoft��ͨ��SD��������������(sdhost.sys)ʹ��SDHost��</li>
</ul>
<p>����Windows����ģ�͵�һ����ƹ淶����Ҫ�ϸ�������ȷ����������ȷ��װ�����С�</p>
<h2 id="User-62"><a href="#User-62" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>Realtek��SD Host�����ƺ�ʹ�õ���MTD�࣬��û������</p>
<h2 id="AI-claude-3-5-sonnet-62"><a href="#AI-claude-3-5-sonnet-62" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�ǵģ�Realtekʹ��MTD (Memory Technology Device) ��Ҳ����ȷ�ġ���֮ǰ�Ļش𲻹�ȫ�档</p>
<p>����SD Host����������ʵ�����м��ֳ�����Classѡ��</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">; ����1: MTD��</span><br><span class="line">Class=MTD</span><br><span class="line">ClassGuid=&#123;4D36E970-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line"></span><br><span class="line">; ����2: System��</span><br><span class="line">Class=System</span><br><span class="line">ClassGuid=&#123;4D36E97D-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line"></span><br><span class="line">; ����3: SDHost�ࣨ����Microsoftͨ��������</span><br><span class="line">Class=SDHost</span><br><span class="line">ClassGuid=&#123;4D36E978-E325-11CE-BFC1-08002BE10318&#125;</span><br></pre></td></tr></table></figure>

<p>ʹ��MTD������ƣ�</p>
<ol>
<li>MTD��ר�������ڴ漼���豸������������������洢����������</li>
<li>�������豸��ʵ�ʹ��ܶ�λ</li>
<li>��������Windows��MTD���豸�ĵ�Դ��������Դ��������</li>
</ol>
<p>����Realtekʹ��MTD���Ǻ�����ѡ����ȡ���ڣ�</p>
<ol>
<li>���̶��������ܵĶ�λ</li>
<li>��Windowsϵͳ�ļ�������</li>
<li>��ʷ�����Կ���</li>
</ol>
<p>��֮��System���MTD�඼�ǿɽ��ܵ�ѡ�񣬹ؼ���Ҫ���ϳ��̵ľ��������ʵ�ַ�ʽ��</p>
<h2 id="User-63"><a href="#User-63" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>Bayhub��SD Host�����ƺ�ʹ�õ���SCSIAdapter�࣬��û������</p>
<h2 id="AI-claude-3-5-sonnet-63"><a href="#AI-claude-3-5-sonnet-63" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�ǵģ�Bayhubʹ��SCSIAdapter��Ҳ�Ǻ�����ѡ�����Ҹ���һ��SD Host�����������õ�Class���ͣ�</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">; ����1: MTD�� - �������ڴ漼���豸</span><br><span class="line">Class=MTD</span><br><span class="line">ClassGuid=&#123;4D36E970-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line"></span><br><span class="line">; ����2: System�� - ������ϵͳ�豸</span><br><span class="line">Class=System</span><br><span class="line">ClassGuid=&#123;4D36E97D-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line"></span><br><span class="line">; ����3: SCSIAdapter�� - �����ڴ洢������</span><br><span class="line">Class=SCSIAdapter</span><br><span class="line">ClassGuid=&#123;4D36E97B-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line"></span><br><span class="line">; ����4: SDHost�� - ����Microsoftͨ������</span><br><span class="line">Class=SDHost</span><br><span class="line">ClassGuid=&#123;4D36E978-E325-11CE-BFC1-08002BE10318&#125;</span><br></pre></td></tr></table></figure>

<p>ʹ��SCSIAdapter������ƣ�</p>
<ol>
<li>��������Windows�洢��ջ�ı�׼����</li>
<li>���õ�֧���Ȳ�κʹ洢�豸ö��</li>
<li>�ܹ�����Windows�Դ洢�������ĵ�Դ��������</li>
<li>�������洢��������������һ�µĹ�����ʽ</li>
</ol>
<p>ѡ���ĸ�Class��Ҫȡ���ڣ�</p>
<ol>
<li>������ʵ�ּܹ����Ƿ�ʹ��storport.sys�ȣ�</li>
<li>��Windows�洢��ջ�ļ��ɷ�ʽ</li>
<li>�豸�ľ��幦�ܺ�ʹ�ó���</li>
<li>���̵ļ���·��ѡ��</li>
</ol>
<p>����Bayhubʹ��SCSIAdapter������ȫ�����ģ��ⷴӳ�����ǿ��ܲ����˻��ڴ洢�˿�������ʵ�ַ�ʽ��</p>
<h2 id="User-64"><a href="#User-64" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����SD Host���̣�����Intel�� AMD��ʹ��ʲô��</p>
<h2 id="AI-claude-3-5-sonnet-64"><a href="#AI-claude-3-5-sonnet-64" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>Intel��AMD��SD Host����ͨ��ʹ�ã�</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">Class=System</span><br><span class="line">ClassGuid=&#123;4D36E97D-E325-11CE-BFC1-08002BE10318&#125;</span><br></pre></td></tr></table></figure>

<p>ԭ��</p>
<ol>
<li>Intel��AMD��SD Host������ͨ���Ǽ�����оƬ���е�ϵͳ���</li>
<li>��Щ������������оƬ����������һ����</li>
<li>��Ϊϵͳ�ؼ��������Ҫ�ϸߵ�ϵͳȨ�޺͸����ܵ�ϵͳ����</li>
</ol>
<p>���尸����</p>
<ul>
<li><p>Intel��</p>
<ul>
<li>Intel PCH ϵ�� SD������</li>
<li>Intel 300&#x2F;400&#x2F;500ϵ��оƬ���SD������<br>��ʹ��System��</li>
</ul>
</li>
<li><p>AMD��</p>
<ul>
<li>AMD FCH ϵ�� SD������</li>
<li>AMD 500ϵ��оƬ���SD������<br>ͬ��ʹ��System��</li>
</ul>
</li>
</ul>
<p>�ⷴӳ�˲�ͬ���̻����似��·�ߺͲ�Ʒ��λ�Ĳ�ͬѡ��</p>
<ul>
<li>Intel&#x2F;AMD��System�ࣨϵͳ���������</li>
<li>Realtek��MTD�ࣨ�洢�豸������</li>
<li>Bayhub��SCSIAdapter�ࣨ�洢������������</li>
</ul>
<h2 id="User-65"><a href="#User-65" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>��win11 22621��װ inf��ʾ�� The folder you specified does’nt contain a compatible software driver for your device</p>
<h2 id="AI-claude-3-5-sonnet-65"><a href="#AI-claude-3-5-sonnet-65" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�����������м���ԭ���������޸�INF�ļ���</p>
<ol>
<li>���ȳ��Ը���System�ࣺ</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">Class=System</span><br><span class="line">ClassGuid=&#123;4D36E97D-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line">; �������ֲ���</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>���Ӹ���ϸ��Ӳ��IDƥ�䣺</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Standard.NTamd64]</span><br><span class="line">%O2Micro_SDHost.DeviceDesc%=O2Micro_SDHost_Device, PCI\VEN_1217&amp;DEV_8620          ; ����ƥ��</span><br><span class="line">%O2Micro_SDHost.DeviceDesc%=O2Micro_SDHost_Device, PCI\VEN_1217&amp;DEV_8620&amp;CC_0805  ; �������</span><br><span class="line">%O2Micro_SDHost.DeviceDesc%=O2Micro_SDHost_Device, PCI\VEN_1217&amp;DEV_8620&amp;REV_01   ; ���汾��</span><br><span class="line">%O2Micro_SDHost.DeviceDesc%=O2Micro_SDHost_Device, PCI\VEN_1217&amp;DEV_8620&amp;SUBSYS_*  ; ����ϵͳID</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>����WDF�汾�����µİ汾��</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[O2Micro_SDHost_wdfsect]</span><br><span class="line">KmdfLibraryVersion = 1.33  ; ���µ�Win11֧�ֵİ汾</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>���ӱ�Ҫ�İ�ȫ�ͼ�����������</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">Class=System</span><br><span class="line">ClassGuid=&#123;4D36E97D-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line">Provider=%ManufacturerName%</span><br><span class="line">CatalogFile=o2micro_sdhost.cat</span><br><span class="line">DriverVer=01/01/2024,1.0.0.0</span><br><span class="line">PnpLockdown=1</span><br><span class="line"></span><br><span class="line">; ������Щ����</span><br><span class="line">CompanyName=&quot;O2Micro International&quot;</span><br><span class="line">WindowsVersions=&quot;Windows 10,Windows 11&quot;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>���Գ���ʹ��SCSIAdapter�ࣺ</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Version]</span><br><span class="line">Signature=&quot;$WINDOWS NT$&quot;</span><br><span class="line">Class=SCSIAdapter</span><br><span class="line">ClassGuid=&#123;4D36E97B-E325-11CE-BFC1-08002BE10318&#125;</span><br><span class="line">; �������ֲ���</span><br></pre></td></tr></table></figure>

<p>���鰴˳������Щ�޸ģ����ĸ��ܽ�����⡣ͬʱ��ȷ����</p>
<ol>
<li>�����Ѿ�ǩ��</li>
<li>cat�ļ���ȷ����</li>
<li>�豸���������ܿ�����ȷ��Ӳ��ID</li>
</ol>
<p>������ǲ��У����Բ鿴setupapi.dev.log��־�ļ����˽�����ʧ��ԭ��</p>
<p>���ۣ���������ԭ��ʵ����Ӳ��ID���󣬶�����Class������</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Cursor/" rel="tag"># Cursor</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/07/30/BH201%20LinuxAndroid%20patch%E4%BB%A3%E7%A0%81%E5%90%88%E5%B9%B6%E6%89%8B%E5%86%8C/" rel="prev" title="BH201 Linux/Android patch代码合并手册">
      <i class="fa fa-chevron-left"></i> BH201 Linux/Android patch代码合并手册
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/08/30/Cursor%E8%AE%B0%E5%BD%95--storport-pofx-dfx/" rel="next" title="Cursor��¼-����Storport Pofx����">
      Cursor��¼-����Storport Pofx���� <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Cursor%EF%BF%BD%EF%BF%BD%C2%BC-20241111-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BDStorport-Pofx%EF%BF%BD%EF%BF%BDSD-Host-WDF%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%DC%B9%EF%BF%BD%EF%BF%BDj%EF%BF%BD"><span class="nav-number">1.</span> <span class="nav-text">Cursor��¼-20241111-����Storport Pofx��SD Host WDF�����ܹ��ĵ�</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Chat-Transcript-Tab-2"><span class="nav-number">2.</span> <span class="nav-text">Chat Transcript - Tab 2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#User"><span class="nav-number">2.1.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet"><span class="nav-number">2.2.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-1"><span class="nav-number">2.3.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-1"><span class="nav-number">2.4.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-2"><span class="nav-number">2.5.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Debugging-Details"><span class="nav-number">2.6.</span> <span class="nav-text">Debugging Details:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-2"><span class="nav-number">2.7.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-3"><span class="nav-number">2.8.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-3"><span class="nav-number">2.9.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-4"><span class="nav-number">2.10.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-4"><span class="nav-number">2.11.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-5"><span class="nav-number">2.12.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-5"><span class="nav-number">2.13.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-6"><span class="nav-number">2.14.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-6"><span class="nav-number">2.15.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-7"><span class="nav-number">2.16.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-7"><span class="nav-number">2.17.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-8"><span class="nav-number">2.18.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-8"><span class="nav-number">2.19.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-9"><span class="nav-number">2.20.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-9"><span class="nav-number">2.21.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-10"><span class="nav-number">2.22.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-10"><span class="nav-number">2.23.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-11"><span class="nav-number">2.24.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-11"><span class="nav-number">2.25.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-12"><span class="nav-number">2.26.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-12"><span class="nav-number">2.27.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-13"><span class="nav-number">2.28.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-13"><span class="nav-number">2.29.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-14"><span class="nav-number">2.30.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-14"><span class="nav-number">2.31.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-15"><span class="nav-number">2.32.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-15"><span class="nav-number">2.33.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-16"><span class="nav-number">2.34.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-16"><span class="nav-number">2.35.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-17"><span class="nav-number">2.36.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-17"><span class="nav-number">2.37.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-18"><span class="nav-number">2.38.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-18"><span class="nav-number">2.39.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-19"><span class="nav-number">2.40.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-19"><span class="nav-number">2.41.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-20"><span class="nav-number">2.42.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-20"><span class="nav-number">2.43.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-21"><span class="nav-number">2.44.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-21"><span class="nav-number">2.45.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-22"><span class="nav-number">2.46.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-22"><span class="nav-number">2.47.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-23"><span class="nav-number">2.48.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-23"><span class="nav-number">2.49.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-24"><span class="nav-number">2.50.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-24"><span class="nav-number">2.51.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-25"><span class="nav-number">2.52.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-25"><span class="nav-number">2.53.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-26"><span class="nav-number">2.54.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-26"><span class="nav-number">2.55.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-27"><span class="nav-number">2.56.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-27"><span class="nav-number">2.57.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-28"><span class="nav-number">2.58.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-28"><span class="nav-number">2.59.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-29"><span class="nav-number">2.60.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-29"><span class="nav-number">2.61.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-30"><span class="nav-number">2.62.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-30"><span class="nav-number">2.63.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-31"><span class="nav-number">2.64.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-31"><span class="nav-number">2.65.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-32"><span class="nav-number">2.66.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-32"><span class="nav-number">2.67.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%D6%B8%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.</span> <span class="nav-text">WDF SD Host Controller����ʵ��ָ��</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%DC%B9%EF%BF%BD"><span class="nav-number">3.1.</span> <span class="nav-text">1. ����ܹ�</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.1.1.</span> <span class="nav-text">1.1 �������</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%EF%BF%BD%EF%BF%BD%D2%AA%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BDg%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.1.2.</span> <span class="nav-text">1.2 ��Ҫ����ģ��</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%DC%B3%EF%BF%BD%CA%BC%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.2.</span> <span class="nav-text">2. ������ܳ�ʼ��</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.2.1.</span> <span class="nav-text">2.1 �������</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%EF%BF%BD%E8%B1%B8%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.2.2.</span> <span class="nav-text">2.2 �豸������</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Host-Controller%EF%BF%BD%EF%BF%BD%CA%BC%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.3.</span> <span class="nav-text">3. Host Controller��ʼ��</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%D3%B2%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%D4%B4%EF%BF%BD%EF%BF%BD%C8%A1"><span class="nav-number">3.3.1.</span> <span class="nav-text">3.1 Ӳ����Դ��ȡ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.3.2.</span> <span class="nav-text">3.2 Host Controller����</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-SD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%BC%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.4.</span> <span class="nav-text">4. SD����ʼ��������</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%BC%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.4.1.</span> <span class="nav-text">4.1 ��������ʼ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.4.2.</span> <span class="nav-text">4.2 ������</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%EF%BF%BD%E6%B4%A2%EF%BF%BD%D3%BF%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.5.</span> <span class="nav-text">5. �洢�ӿ�ʵ��</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%EF%BF%BD%E8%B1%B8%EF%BF%BD%D3%BF%EF%BF%BD%D7%A2%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.5.1.</span> <span class="nav-text">5.1 �豸�ӿ�ע��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.5.2.</span> <span class="nav-text">5.2 ������</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-I-O%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.6.</span> <span class="nav-text">6. I&#x2F;O����</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%EF%BF%BD%EF%BF%BD%D0%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.6.1.</span> <span class="nav-text">6.1 ��д����</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-DMA%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.6.2.</span> <span class="nav-text">6.2 DMA����</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%EF%BF%BD%D0%B6%CF%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.7.</span> <span class="nav-text">7. �жϴ���</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-ISR"><span class="nav-number">3.7.1.</span> <span class="nav-text">7.1 ISR</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-DPC"><span class="nav-number">3.7.2.</span> <span class="nav-text">7.2 DPC</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%EF%BF%BD%EF%BF%BD%D4%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.8.</span> <span class="nav-text">8. ��Դ����</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-%EF%BF%BD%EF%BF%BD%D4%B4%D7%B4%CC%AC%D7%AA%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.8.1.</span> <span class="nav-text">8.1 ��Դ״̬ת��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-%EF%BF%BD%EF%BF%BD%EF%BF%BD%D0%B9%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.8.2.</span> <span class="nav-text">8.2 ���й���</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.9.</span> <span class="nav-text">9. ������</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.9.1.</span> <span class="nav-text">9.1 �������</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.9.2.</span> <span class="nav-text">9.2 �������</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%D6%A7%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.10.</span> <span class="nav-text">10. ����֧��</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-1-WPP%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.10.1.</span> <span class="nav-text">10.1 WPP����</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-%EF%BF%BD%EF%BF%BD%EF%BF%BD%DC%BC%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">3.10.2.</span> <span class="nav-text">10.2 ���ܼ�����</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-%EF%BF%BD%DC%BD%EF%BF%BD"><span class="nav-number">3.11.</span> <span class="nav-text">11. �ܽ�</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-33"><span class="nav-number">3.12.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-33"><span class="nav-number">3.13.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-1"><span class="nav-number">4.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%DC%B9%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">4.1.</span> <span class="nav-text">1. ����ܹ����</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">4.1.1.</span> <span class="nav-text">1.1 ����������</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%EF%BF%BD%D8%BC%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%DD%BDu"><span class="nav-number">4.1.2.</span> <span class="nav-text">1.2 �ؼ����ݽṹ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%BC%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">4.1.3.</span> <span class="nav-text">1.3 ������ʼ������</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-%EF%BF%BD%E8%B1%B8%EF%BF%BD%EF%BF%BD%EF%BF%BD%F3%B4%B4%BD%EF%BF%BD"><span class="nav-number">4.1.4.</span> <span class="nav-text">1.4 �豸���󴴽�</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-34"><span class="nav-number">4.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-34"><span class="nav-number">4.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-2"><span class="nav-number">5.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Host-Controller%EF%BF%BD%EF%BF%BD%CA%BC%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">5.1.</span> <span class="nav-text">2. Host Controller��ʼ��������</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%D3%B2%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%D4%B4%EF%BF%BD%EF%BF%BD%C8%A1"><span class="nav-number">5.1.1.</span> <span class="nav-text">2.1 Ӳ����Դ��ȡ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Host-Controller%EF%BF%BD%EF%BF%BD%CA%BC%EF%BF%BD%EF%BF%BD"><span class="nav-number">5.1.2.</span> <span class="nav-text">2.2 Host Controller��ʼ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-DMA%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">5.1.3.</span> <span class="nav-text">2.3 DMA����</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-%EF%BF%BD%D0%B6%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">5.1.4.</span> <span class="nav-text">2.4 �ж�����</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-%EF%BF%BD%EF%BF%BD%D4%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">5.1.5.</span> <span class="nav-text">2.5 ��Դ����</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-35"><span class="nav-number">5.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-35"><span class="nav-number">5.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-3"><span class="nav-number">6.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 3</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-SD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%BC%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EE%B4%A6%EF%BF%BD%EF%BF%BD"><span class="nav-number">6.1.</span> <span class="nav-text">3. SD����ʼ���������</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-SD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%BC%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">6.1.1.</span> <span class="nav-text">3.1 SD��������ʼ������</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EE%B4%A6%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">6.1.2.</span> <span class="nav-text">3.2 �����ʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">6.1.3.</span> <span class="nav-text">3.3 ������</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-36"><span class="nav-number">6.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-36"><span class="nav-number">6.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-4"><span class="nav-number">7.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 4</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%EF%BF%BD%EF%BF%BD%EF%BF%BD%DD%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BDDMA%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">7.1.</span> <span class="nav-text">4. ���ݴ�����DMA����</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%EF%BF%BD%EF%BF%BD%D0%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">7.1.1.</span> <span class="nav-text">4.1 ��д������</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%D7%BC%EF%BF%BD%EF%BF%BD"><span class="nav-number">7.1.2.</span> <span class="nav-text">4.2 ����׼��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-DMA%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">7.1.3.</span> <span class="nav-text">4.3 DMA����</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%C9%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">7.1.4.</span> <span class="nav-text">4.4 ������ɴ���</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-37"><span class="nav-number">7.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-37"><span class="nav-number">7.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-5"><span class="nav-number">8.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 5</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%EF%BF%BD%D0%B6%CF%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">8.1.</span> <span class="nav-text">5. �жϴ���</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-ISR%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">8.1.1.</span> <span class="nav-text">5.1 ISRʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-DPC%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">8.1.2.</span> <span class="nav-text">5.2 DPCʵ��</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%EF%BF%BD%EF%BF%BD%D4%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">8.2.</span> <span class="nav-text">6. ��Դ����</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%EF%BF%BD%EF%BF%BD%D4%B4%D7%B4%CC%AC%D7%AA%EF%BF%BD%EF%BF%BD"><span class="nav-number">8.2.1.</span> <span class="nav-text">6.1 ��Դ״̬ת��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%EF%BF%BD%EF%BF%BD%EF%BF%BD%D0%B5%EF%BF%BD%D4%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">8.2.2.</span> <span class="nav-text">6.2 ���е�Դ����</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-38"><span class="nav-number">8.3.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-38"><span class="nav-number">8.4.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-39"><span class="nav-number">8.5.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-39"><span class="nav-number">8.6.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-40"><span class="nav-number">8.7.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-40"><span class="nav-number">8.8.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-6"><span class="nav-number">9.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 6</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%D6%A7%EF%BF%BD%EF%BF%BD"><span class="nav-number">9.1.</span> <span class="nav-text">7. ����֧��</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-WPP%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">9.1.1.</span> <span class="nav-text">7.1 WPP����ʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-%EF%BF%BD%EF%BF%BD%EF%BF%BD%DC%BC%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">9.1.2.</span> <span class="nav-text">7.2 ���ܼ�����ʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-%EF%BF%BD%EF%BF%BD%CF%BD%D3%BF%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">9.1.3.</span> <span class="nav-text">7.3 ��Ͻӿ�ʵ��</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-41"><span class="nav-number">9.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-41"><span class="nav-number">9.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-7"><span class="nav-number">10.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 7</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CD%BB%D6%B8%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">10.1.</span> <span class="nav-text">8. �������ͻָ�����</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CD%B6%EF%BF%BD%EF%BF%BD%EF%BF%BD%CD%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">10.1.1.</span> <span class="nav-text">8.1 �������Ͷ���ʹ���</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">10.1.2.</span> <span class="nav-text">8.2 ���������ʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-%EF%BF%BD%D6%B8%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">10.1.3.</span> <span class="nav-text">8.3 �ָ�����ʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%D6%B8%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">10.1.4.</span> <span class="nav-text">8.4 ����ָ�����</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-42"><span class="nav-number">10.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-42"><span class="nav-number">10.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-8"><span class="nav-number">11.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 8</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#9-%EF%BF%BD%E8%B1%B8%D7%B4%CC%AC%EF%BF%BD%EF%BF%BD%D8%BA%EF%BF%BD%CE%AC%EF%BF%BD%EF%BF%BD"><span class="nav-number">11.1.</span> <span class="nav-text">9. �豸״̬��غ�ά��</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-%EF%BF%BD%E8%B1%B8%D7%B4%CC%AC%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CD%B9%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">11.1.1.</span> <span class="nav-text">9.1 �豸״̬����͹���</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">11.1.2.</span> <span class="nav-text">9.2 �������ʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-%D7%B4%CC%AC%D7%AA%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">11.1.3.</span> <span class="nav-text">9.3 ״̬ת������</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-43"><span class="nav-number">11.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-43"><span class="nav-number">11.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-9"><span class="nav-number">12.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 9</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#10-%EF%BF%BD%DF%BC%EF%BF%BD%EF%BF%BD%EF%BF%BD%D4%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">12.1.</span> <span class="nav-text">10. �߼���Դ����</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-1-%EF%BF%BD%EF%BF%BD%CC%AC%EF%BF%BD%EF%BF%BD%D4%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">12.1.1.</span> <span class="nav-text">10.1 ��̬��Դ����</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-%EF%BF%BD%EF%BF%BD%CC%ACZ%EF%BF%BD%CA%BA%CD%B5%EF%BF%BD%D1%B9%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">12.1.2.</span> <span class="nav-text">10.2 ��̬Ƶ�ʺ͵�ѹ����</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-3-%EF%BF%BD%EF%BF%BD%D4%B4%D7%B4%CC%AC%D7%AA%EF%BF%BD%EF%BF%BD%EF%BF%BDZ%EF%BF%BD"><span class="nav-number">12.1.3.</span> <span class="nav-text">10.3 ��Դ״̬ת���Ż�</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-44"><span class="nav-number">12.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-44"><span class="nav-number">12.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-10"><span class="nav-number">13.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 10</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#11-%EF%BF%BD%DF%BC%EF%BF%BDIO%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BDZ%EF%BF%BD"><span class="nav-number">13.1.</span> <span class="nav-text">11. �߼�IO�����������Ż�</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-1-IO%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BDZ%EF%BF%BD"><span class="nav-number">13.1.1.</span> <span class="nav-text">11.1 IO��������Ż�</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CF%B2%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">13.1.2.</span> <span class="nav-text">11.2 ����ϲ�������</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-3-%D4%A4%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%D3%B3%EF%BF%BD%D0%B4"><span class="nav-number">13.1.3.</span> <span class="nav-text">11.3 Ԥ�����ӳ�д</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-45"><span class="nav-number">13.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-45"><span class="nav-number">13.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-11"><span class="nav-number">14.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 11</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#12-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%D6%A7%EF%BF%BD%D6%BA%CD%B2%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BDZ%EF%BF%BD"><span class="nav-number">14.1.</span> <span class="nav-text">12. �����֧�ֺͲ����Ż�</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#12-1-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%D0%B9%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">14.1.1.</span> <span class="nav-text">12.1 ����й�����ʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-2-%EF%BF%BD%EF%BF%BD%EF%BF%BD%D8%BE%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">14.1.2.</span> <span class="nav-text">12.2 ���ؾ���ʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-3-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BDZ%EF%BF%BD"><span class="nav-number">14.1.3.</span> <span class="nav-text">12.3 ���������Ż�</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-46"><span class="nav-number">14.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-46"><span class="nav-number">14.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-12"><span class="nav-number">15.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 12</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#13-%EF%BF%BD%DF%BC%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%D4%BA%EF%BF%BD%EF%BF%BD%EF%BF%BD%CF%B9%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">15.1.</span> <span class="nav-text">13. �߼����Ժ���Ϲ���</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#13-1-%CA%B5%CA%B1%EF%BF%BD%EF%BF%BD%EF%BF%BD%CF%B5%CD%B3"><span class="nav-number">15.1.1.</span> <span class="nav-text">13.1 ʵʱ���ϵͳ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-2-%CA%B5%CA%B1%EF%BF%BD%C2%BC%EF%BF%BD%EF%BF%BD%EF%BF%BD%C2%BC%EF%BF%BD%CD%B7%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">15.1.2.</span> <span class="nav-text">13.2 ʵʱ�¼���¼�ͷ���</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-3-%EF%BF%BD%EF%BF%BD%EF%BF%BD%D4%BD%D3%BF%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">15.1.3.</span> <span class="nav-text">13.3 ���Խӿ�ʵ��</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-47"><span class="nav-number">15.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-47"><span class="nav-number">15.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-13"><span class="nav-number">16.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 13</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#14-%EF%BF%BD%EF%BF%BDo%EF%BF%BD%D4%BA%CD%BF%C9%BF%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BDo"><span class="nav-number">16.1.</span> <span class="nav-text">14. ��ȫ�ԺͿɿ�����ǿ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#14-1-%EF%BF%BD%EF%BF%BDo%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">16.1.1.</span> <span class="nav-text">14.1 ��ȫ������ʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-2-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%D6%A4%EF%BF%BD%CD%B7%EF%BF%BD%EF%BF%BD%CA%BF%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">16.1.2.</span> <span class="nav-text">14.2 ������֤�ͷ��ʿ���</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-3-%EF%BF%BD%EF%BF%BD%CA%B1%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CD%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%D6%B8%EF%BF%BD"><span class="nav-number">16.1.3.</span> <span class="nav-text">14.3 ��ʱ�����ʹ���ָ�</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-48"><span class="nav-number">16.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-48"><span class="nav-number">16.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-14"><span class="nav-number">17.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 14</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#15-%EF%BF%BD%EF%BF%BD%EF%BF%BD%DC%BC%EF%BF%BD%D8%BA%EF%BF%BD%EF%BF%BDZ%EF%BF%BD"><span class="nav-number">17.1.</span> <span class="nav-text">15. ���ܼ�غ��Ż�</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#15-1-%EF%BF%BD%EF%BF%BD%EF%BF%BD%DC%BC%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">17.1.1.</span> <span class="nav-text">15.1 ���ܼ����ʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-2-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%DD%B2%C9%BC%EF%BF%BD%EF%BF%BD%CD%B7%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">17.1.2.</span> <span class="nav-text">15.2 �������ݲɼ��ͷ���</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-3-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BDZ%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">17.1.3.</span> <span class="nav-text">15.3 �����Ż�����</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-49"><span class="nav-number">17.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-49"><span class="nav-number">17.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-15"><span class="nav-number">18.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 15</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#16-%EF%BF%BD%DF%BC%EF%BF%BDDMA%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">18.1.</span> <span class="nav-text">16. �߼�DMA����</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#16-1-DMA%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">18.1.1.</span> <span class="nav-text">16.1 DMA������ʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-2-DMA%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">18.1.2.</span> <span class="nav-text">16.2 DMA�������</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-3-DMA%EF%BF%BD%D0%B6%CF%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">18.1.3.</span> <span class="nav-text">16.3 DMA�жϴ���</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-50"><span class="nav-number">18.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-50"><span class="nav-number">18.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-16"><span class="nav-number">19.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 16</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#17-%EF%BF%BD%DF%BC%EF%BF%BD%EF%BF%BD%EF%BF%BD%D4%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">19.1.</span> <span class="nav-text">17. �߼���Դ����</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#17-1-%EF%BF%BD%EF%BF%BD%D4%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%D4%B9%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">19.1.1.</span> <span class="nav-text">17.1 ��Դ���Թ�����ʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-2-%EF%BF%BD%EF%BF%BD%CC%AC%EF%BF%BD%EF%BF%BD%D4%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">19.1.2.</span> <span class="nav-text">17.2 ��̬��Դ����</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-3-%EF%BF%BD%EF%BF%BD%EF%BF%BD%D1%B9%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">19.1.3.</span> <span class="nav-text">17.3 ���ѹ���</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-51"><span class="nav-number">19.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-51"><span class="nav-number">19.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-17"><span class="nav-number">20.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 17</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#18-%EF%BF%BD%DF%BC%EF%BF%BD%EF%BF%BD%D0%B6%CF%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">20.1.</span> <span class="nav-text">18. �߼��жϴ���</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#18-1-%EF%BF%BD%D0%B6%CF%B9%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">20.1.1.</span> <span class="nav-text">18.1 �жϹ�����ʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#18-2-%EF%BF%BD%D0%B6%CF%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CD%B7%D6%B7%EF%BF%BD"><span class="nav-number">20.1.2.</span> <span class="nav-text">18.2 �жϴ����ͷַ�</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#18-3-%EF%BF%BD%D0%B6%CF%BA%CF%B2%EF%BF%BD%EF%BF%BDZ%EF%BF%BD"><span class="nav-number">20.1.3.</span> <span class="nav-text">18.3 �жϺϲ��Ż�</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-52"><span class="nav-number">20.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-52"><span class="nav-number">20.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-18"><span class="nav-number">21.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 18</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#19-%EF%BF%BD%DF%BC%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%D4%B9%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">21.1.</span> <span class="nav-text">19. �߼����Թ���</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#19-1-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">21.1.1.</span> <span class="nav-text">19.1 ��������ʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#19-2-%EF%BF%BD%EF%BF%BD%EF%BF%BD%D4%B8%EF%BF%BD%EF%BF%BD%D9%BA%EF%BF%BD%EF%BF%BD%EF%BF%BD%D6%BE"><span class="nav-number">21.1.2.</span> <span class="nav-text">19.2 ���Ը��ٺ���־</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#19-3-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EE%B4%A6%EF%BF%BD%EF%BF%BD"><span class="nav-number">21.1.3.</span> <span class="nav-text">19.3 ���������</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-53"><span class="nav-number">21.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-53"><span class="nav-number">21.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-19"><span class="nav-number">22.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 19</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#20-%EF%BF%BD%DF%BC%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">22.1.</span> <span class="nav-text">20. �߼�������</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#20-1-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">22.1.1.</span> <span class="nav-text">20.1 ���������ʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#20-2-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CD%BC%EF%BF%BD%C2%BC"><span class="nav-number">22.1.2.</span> <span class="nav-text">20.2 ������ͼ�¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#20-3-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%D6%B8%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">22.1.3.</span> <span class="nav-text">20.3 ����ָ�ʵ��</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-54"><span class="nav-number">22.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-54"><span class="nav-number">22.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-20"><span class="nav-number">23.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 20</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#21-%EF%BF%BD%DF%BC%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BDZ%EF%BF%BD"><span class="nav-number">23.1.</span> <span class="nav-text">21. �߼������Ż�</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#21-1-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BDZ%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">23.1.1.</span> <span class="nav-text">21.1 �����Ż�������ʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#21-2-IO%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BDZ%EF%BF%BD"><span class="nav-number">23.1.2.</span> <span class="nav-text">21.2 IO�����Ż�</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#21-3-%EF%BF%BD%DA%B4%EF%BF%BD%EF%BF%BDCPU%EF%BF%BDZ%EF%BF%BD"><span class="nav-number">23.1.3.</span> <span class="nav-text">21.3 �ڴ��CPU�Ż�</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-55"><span class="nav-number">23.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-55"><span class="nav-number">23.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-21"><span class="nav-number">24.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 21</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#22-%EF%BF%BD%DF%BC%EF%BF%BD%EF%BF%BD%EF%BF%BD%D4%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">24.1.</span> <span class="nav-text">22. �߼���Դ����</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#22-1-%EF%BF%BD%EF%BF%BD%D4%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">24.1.1.</span> <span class="nav-text">22.1 ��Դ������ʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#22-2-%EF%BF%BD%EF%BF%BD%D4%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CD%B8%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">24.1.2.</span> <span class="nav-text">22.2 ��Դ����͸���</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#22-3-%EF%BF%BD%EF%BF%BD%D4%B4%EF%BF%BD%CD%B7z%CD%BB%D6%B8%EF%BF%BD"><span class="nav-number">24.1.3.</span> <span class="nav-text">22.3 ��Դ�ͷźͻָ�</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-56"><span class="nav-number">24.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-56"><span class="nav-number">24.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-22"><span class="nav-number">25.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 22</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#23-%EF%BF%BD%DF%BC%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BDu%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">25.1.</span> <span class="nav-text">23. �߼����ù���</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#23-1-%EF%BF%BD%EF%BF%BD%EF%BF%BDu%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">25.1.1.</span> <span class="nav-text">23.1 ���ù�����ʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#23-2-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">25.1.2.</span> <span class="nav-text">23.2 ���������</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#23-3-%EF%BF%BD%EF%BF%BD%EF%BF%BDo%D6%BEu%EF%BF%BD"><span class="nav-number">25.1.3.</span> <span class="nav-text">23.3 ���ó־û�</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-57"><span class="nav-number">25.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-57"><span class="nav-number">25.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-58"><span class="nav-number">25.4.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-58"><span class="nav-number">25.5.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WDF-SD-Host-Controller%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD-Part-23"><span class="nav-number">26.</span> <span class="nav-text">WDF SD Host Controller����ʵ����� - Part 23</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#24-%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BDj%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">26.1.</span> <span class="nav-text">24. ���������ĵ�����</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#24-1-%EF%BF%BDj%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%CA%B5%EF%BF%BD%EF%BF%BD"><span class="nav-number">26.1.1.</span> <span class="nav-text">24.1 �ĵ�������ʵ��</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#24-2-%D4%B4%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BDAPI%EF%BF%BD%EF%BF%BD%C8%A1"><span class="nav-number">26.1.2.</span> <span class="nav-text">24.2 Դ���������API��ȡ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#24-3-%EF%BF%BDj%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD%C9%BA%CD%B8%EF%BF%BD%CA%BD%EF%BF%BD%EF%BF%BD"><span class="nav-number">26.1.3.</span> <span class="nav-text">24.3 �ĵ����ɺ͸�ʽ��</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-59"><span class="nav-number">26.2.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-59"><span class="nav-number">26.3.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-60"><span class="nav-number">26.4.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-60"><span class="nav-number">26.5.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-61"><span class="nav-number">26.6.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-61"><span class="nav-number">26.7.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-62"><span class="nav-number">26.8.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-62"><span class="nav-number">26.9.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-63"><span class="nav-number">26.10.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-63"><span class="nav-number">26.11.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-64"><span class="nav-number">26.12.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-64"><span class="nav-number">26.13.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-65"><span class="nav-number">26.14.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-65"><span class="nav-number">26.15.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="cursorhu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">cursorhu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">113</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">55</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/cursorhu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cursorhu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:2449055512@qq.com" title="E-Mail → mailto:2449055512@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cursorhu</span>
</div>



        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
