<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 8.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/my_icon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/my_icon/favicon-16x16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="manifest" href="/images/my_icon/manifest.json">
  <meta name="msapplication-config" content="/images/my_icon/browserconfig.xml">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC|Roboto/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Roboto:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"cursorhu.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Cursor��¼-����Storport Pofx���� Chat Transcript - Tab 1User:[text]@Codebase @Web ����һ��Storport miniport �������һ��ɵ�Դ������ع��������⣬ ���ѯStorport�ĵ��Լ�Windows driver Pofx��DFx(Direct Pofx)�ĵ�������">
<meta property="og:type" content="article">
<meta property="og:title" content="Cursor��¼-����Storport Pofx����">
<meta property="og:url" content="https://cursorhu.github.io/2024/08/30/Cursor%E8%AE%B0%E5%BD%95--storport-pofx-dfx/index.html">
<meta property="og:site_name" content="ThinkNotes">
<meta property="og:description" content="Cursor��¼-����Storport Pofx���� Chat Transcript - Tab 1User:[text]@Codebase @Web ����һ��Storport miniport �������һ��ɵ�Դ������ع��������⣬ ���ѯStorport�ĵ��Լ�Windows driver Pofx��DFx(Direct Pofx)�ĵ�������">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-08-30T07:50:54.000Z">
<meta property="article:modified_time" content="2025-11-04T09:13:23.701Z">
<meta property="article:author" content="cursorhu">
<meta property="article:tag" content="Cursor">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://cursorhu.github.io/2024/08/30/Cursor%E8%AE%B0%E5%BD%95--storport-pofx-dfx/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Cursor��¼-����Storport Pofx���� | ThinkNotes</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ThinkNotes</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Simple is not easy       化繁为简，知易行难</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于我</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2024/08/30/Cursor%E8%AE%B0%E5%BD%95--storport-pofx-dfx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Cursor��¼-����Storport Pofx����
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-08-30 15:50:54" itemprop="dateCreated datePublished" datetime="2024-08-30T15:50:54+08:00">2024-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:13:23" itemprop="dateModified" datetime="2025-11-04T17:13:23+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI%EF%BF%BD%EF%BF%BD%EF%BF%BD/" itemprop="url" rel="index"><span itemprop="name">AI���</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>Cursor��¼-����Storport Pofx����</p>
<h1 id="Chat-Transcript-Tab-1"><a href="#Chat-Transcript-Tab-1" class="headerlink" title="Chat Transcript - Tab 1"></a>Chat Transcript - Tab 1</h1><h2 id="User"><a href="#User" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>@Codebase @Web ����һ��Storport miniport �������һ��ɵ�Դ������ع��������⣬ ���ѯStorport�ĵ��Լ�Windows driver Pofx��DFx(Direct Pofx)�ĵ�����������</p>
<h2 id="AI-claude-3-5-sonnet"><a href="#AI-claude-3-5-sonnet" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��������һ����������ĵ�Դ������ش���:</p>
<ol>
<li>��Ҫ�ĵ�Դ�������������¼����ļ���:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br></pre></td><td class="code"><pre><span class="line">void pm_init(bht_dev_ext_t * pdx)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_MAIN_PM, FEATURE_DRIVER_INIT, 0, &quot;Enter %s chip:%xh\n&quot;, __FUNCTION__, pdx-&gt;host.chip_type);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //TODO: RTD3 enable From the registry</span><br><span class="line"></span><br><span class="line">    pdx-&gt;pm_state.s3s4_entered = FALSE;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;pm_state.rtd3_en = hostven_rtd3_check(&amp;pdx-&gt;host);</span><br><span class="line"></span><br><span class="line">    pdx-&gt;pm_state.rtd3_entered = FALSE;</span><br><span class="line">    pdx-&gt;pm_state.s5_entered = FALSE;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;pm_state.warm_boot_entered = FALSE;</span><br><span class="line"></span><br><span class="line">    hostven_pm_mode_cfg(&amp;pdx-&gt;host, &amp;(pdx-&gt;pm_state));</span><br><span class="line"></span><br><span class="line">    os_pm_init(pdx);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_MAIN_PM, FEATURE_PM_TRACE, 0, &quot;Exit %s\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> void SetSlowLTRNoRequire(sd_host_t * host)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">	if (host-&gt;cfg-&gt;issue_fix_item.ltr_c10_patch.enable_ltr_patch)</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		if (host-&gt;chip_type == CHIP_FUJIN2 || host-&gt;chip_type == CHIP_SEABIRD)</span><br><span class="line"></span><br><span class="line">		&#123;</span><br><span class="line"></span><br><span class="line">            pci_andl(host, 0x3e8, 0x7fff7fff);</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">            pci_orl(host, 0x3e8, 0x20000000);</span><br><span class="line"></span><br><span class="line">             DbgInfo(MODULE_SD_HOST, FEATURE_CARD_INIT , NOT_TO_RAM,&quot;SetSlowLTRNoRequire\n&quot;);</span><br><span class="line"></span><br><span class="line">			//DbgInfo((&quot;no LTR\n&quot;));</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> void SetSlowLTRRequire_when_Enabledriver(sd_host_t* host)</span><br><span class="line"></span><br><span class="line"> &#123;</span><br><span class="line"></span><br><span class="line">     if (!host-&gt;cfg-&gt;issue_fix_item.ltr_c10_patch.enable_ltr_patch)</span><br><span class="line"></span><br><span class="line">     &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">         if (host-&gt;chip_type == CHIP_FUJIN2 || host-&gt;chip_type == CHIP_SEABIRD)</span><br><span class="line"></span><br><span class="line">         &#123;</span><br><span class="line"></span><br><span class="line">             pci_orw(host, 0x3e8, 0x8000);</span><br><span class="line"></span><br><span class="line">             pci_orl(host, 0x3e8, 0x20000000);</span><br><span class="line"></span><br><span class="line">             DbgInfo(MODULE_SD_HOST, FEATURE_CARD_INIT, NOT_TO_RAM, &quot;SetSlowLTRNoRequire When Enable Driver\n&quot;);</span><br><span class="line"></span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line">...</span><br><span class="line">void pcr_part_a_backup(bht_dev_ext_t * pdx)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    if(pdx-&gt;cfg-&gt;driver_item.backup_part_a)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        //enable or disable LED output or not.</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0xdc = pci_readl(&amp;pdx-&gt;host, 0xdc);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //disable or enable RTD3</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x3e0	= pci_readl(&amp;pdx-&gt;host, 0x3e0);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x3e8 = pci_readl(&amp;pdx-&gt;host, 0x3e8);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x3ec = pci_readl(&amp;pdx-&gt;host, 0x3ec);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //Change the ASPM L0s Exit Latency</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0xf4 = pci_readl(&amp;pdx-&gt;host, 0xf4);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //ep nfts value</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x74  = pci_readl(&amp;pdx-&gt;host, 0x74);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //Power saving mode setting</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0xf0 = pci_readl(&amp;pdx-&gt;host, 0xf0);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //enable or disable ASPM L0s&amp;L1</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x90  =  pci_readl(&amp;pdx-&gt;host, 0x90);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void pcr_part_b_backup(bht_dev_ext_t * pdx)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    if(pdx-&gt;cfg-&gt;driver_item.backup_part_b)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x64 = pci_readl(&amp;pdx-&gt;host, 0x64);</span><br><span class="line"></span><br><span class="line">        //skt power control output enable</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0xec = pci_readl(&amp;pdx-&gt;host, 0xec);</span><br><span class="line"></span><br><span class="line">        //ocb cntl timer</span><br><span class="line">        //ocb cntl enable</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0xd4 = pci_readl(&amp;pdx-&gt;host, 0xd4);</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x3e4 = pci_readl(&amp;pdx-&gt;host, 0x3e4);</span><br><span class="line"></span><br><span class="line">        //PLL DM</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x304 = pci_readl(&amp;pdx-&gt;host, 0x304);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //Set Base Clock Frequency</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x328 = pci_readl(&amp;pdx-&gt;host, 0x328);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //Set DLL tuning window</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x300 = pci_readl(&amp;pdx-&gt;host, 0x300);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //aux power LDO</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x68 = pci_readl(&amp;pdx-&gt;host, 0x68);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //Adjust the output delay for SD2.0 high speed mode</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x350 = pci_readl(&amp;pdx-&gt;host, 0x350);</span><br><span class="line"></span><br><span class="line">        //T_EIDL_ENTRY</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x35c = pci_readl(&amp;pdx-&gt;host, 0x35c);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //disable bit for UHSII term_resistor_calibration</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x3e0 = pci_readl(&amp;pdx-&gt;host, 0x3e0);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //Set the Max power supply capability of SD host</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x334	= pci_readl(&amp;pdx-&gt;host, 0x334);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //external enable polarity control pin</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0xd8 = pci_readl(&amp;pdx-&gt;host, 0xd8);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //AOSC off support</span><br><span class="line">        pdx-&gt;pm_state.reg_0x3f0 = pci_readl(&amp;pdx-&gt;host, 0x3f0);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //max read request size</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x88 =  pci_readl(&amp;pdx-&gt;host, 0x88);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //UHSII DLL watch dog</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0x33c = pci_readl(&amp;pdx-&gt;host, 0x33c);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //PCI-PM L1 entrance timer</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0xe0 = pci_readl(&amp;pdx-&gt;host, 0xe0);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //ASPM L1 entrance timer</span><br><span class="line"></span><br><span class="line">        pdx-&gt;pm_state.reg_0xfc = pci_readl(&amp;pdx-&gt;host, 0xfc);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void pcr_part_a_restore(bht_dev_ext_t * pdx)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    if(pdx-&gt;cfg-&gt;driver_item.backup_part_a)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line"></span><br><span class="line">        The register mapping way to write register must be in D0 state(at which device register is mapped to PCIe BAR space).</span><br><span class="line"></span><br><span class="line">        In D3 state, the register access is invalid and return 0xFF.</span><br><span class="line"></span><br><span class="line">        Refer to:</span><br><span class="line"></span><br><span class="line">        StorPortWriteRegisterBufferUlong: The given Register must be in a mapped memory space range that was returned by StorPortGetDeviceBase</span><br><span class="line"></span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">        Usually this ScsiSetRunningConfig is after receive ScsiAdapterPower - D0 and it&#x27;s in D0 state, </span><br><span class="line"></span><br><span class="line">        but in some platform AMD or BIOS difference, the operation is in D3 (storport allows it)</span><br><span class="line">        When PCI config register is accessed in D3, must use PORT access to write register, StorPortSetBusDataByOffset can only be used in ScsiSetRunningConfig in AdapterControl.</span><br><span class="line"></span><br><span class="line">        Refer to:</span><br><span class="line"></span><br><span class="line">        https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ne-storport-scsi_adapter_control_type</span><br><span class="line"></span><br><span class="line">        https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportsetbusdatabyoffset</span><br><span class="line"></span><br><span class="line">        */</span><br><span class="line"></span><br><span class="line">        if (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD0) &#123;</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0xdc, pdx-&gt;pm_state.reg_0xdc);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x3e0, pdx-&gt;pm_state.reg_0x3e0);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x3e8, pdx-&gt;pm_state.reg_0x3e8);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x3ec, pdx-&gt;pm_state.reg_0x3ec);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0xf4, pdx-&gt;pm_state.reg_0xf4);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x74, pdx-&gt;pm_state.reg_0x74);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0xf0, pdx-&gt;pm_state.reg_0xf0);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x90, pdx-&gt;pm_state.reg_0x90);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        else &#123; //D3</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0xdc, pdx-&gt;pm_state.reg_0xdc);</span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x3e0, pdx-&gt;pm_state.reg_0x3e0);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x3e8, pdx-&gt;pm_state.reg_0x3e8);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x3ec, pdx-&gt;pm_state.reg_0x3ec);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0xf4, pdx-&gt;pm_state.reg_0xf4);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x74, pdx-&gt;pm_state.reg_0x74);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0xf0, pdx-&gt;pm_state.reg_0xf0);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x90, pdx-&gt;pm_state.reg_0x90);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void pcr_part_b_restore(bht_dev_ext_t * pdx)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    if(pdx-&gt;cfg-&gt;driver_item.backup_part_b)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD0) &#123;</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x64, pdx-&gt;pm_state.reg_0x64);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0xec, pdx-&gt;pm_state.reg_0xec);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0xd4, pdx-&gt;pm_state.reg_0xd4);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x304, pdx-&gt;pm_state.reg_0x304);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x328, pdx-&gt;pm_state.reg_0x328);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x300, pdx-&gt;pm_state.reg_0x300);</span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x3e4, pdx-&gt;pm_state.reg_0x3e4);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x68, pdx-&gt;pm_state.reg_0x68);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x350, pdx-&gt;pm_state.reg_0x350);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x35c, pdx-&gt;pm_state.reg_0x35c);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x3e0, pdx-&gt;pm_state.reg_0x3e0);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x334, pdx-&gt;pm_state.reg_0x334);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0xd8, pdx-&gt;pm_state.reg_0xd8);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x3f0, pdx-&gt;pm_state.reg_0x3f0);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x88, pdx-&gt;pm_state.reg_0x88);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0x33c, pdx-&gt;pm_state.reg_0x33c);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0xe0, pdx-&gt;pm_state.reg_0xe0);</span><br><span class="line"></span><br><span class="line">            pci_writel(&amp;pdx-&gt;host, 0xfc, pdx-&gt;pm_state.reg_0xfc);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        else &#123;</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x64, pdx-&gt;pm_state.reg_0x64);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0xec, pdx-&gt;pm_state.reg_0xec);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0xd4, pdx-&gt;pm_state.reg_0xd4);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x304, pdx-&gt;pm_state.reg_0x304);</span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x328, pdx-&gt;pm_state.reg_0x328);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x300, pdx-&gt;pm_state.reg_0x300);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x3e4, pdx-&gt;pm_state.reg_0x3e4);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x68, pdx-&gt;pm_state.reg_0x68);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x350, pdx-&gt;pm_state.reg_0x350);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x35c, pdx-&gt;pm_state.reg_0x35c);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x3e0, pdx-&gt;pm_state.reg_0x3e0);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x334, pdx-&gt;pm_state.reg_0x334);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0xd8, pdx-&gt;pm_state.reg_0xd8);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x3f0, pdx-&gt;pm_state.reg_0x3f0);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x88, pdx-&gt;pm_state.reg_0x88);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0x33c, pdx-&gt;pm_state.reg_0x33c);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0xe0, pdx-&gt;pm_state.reg_0xe0);</span><br><span class="line"></span><br><span class="line">            pci_cfgio_writel(&amp;pdx-&gt;host, 0xfc, pdx-&gt;pm_state.reg_0xfc);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void failsafe_fct(bht_dev_ext_t * pdx)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">     if(pdx-&gt;pm_state.s3s4_entered)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">    	if(1 == pdx-&gt;cfg-&gt;driver_item.failsafe_en)</span><br><span class="line"></span><br><span class="line">		pci_orl(&amp;(pdx-&gt;host), 0x3E0, BIT6);//Failsafe enable</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void req_enter_d3(bht_dev_ext_t * pdx)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_MAIN_PM, FEATURE_PM_TRACE, 0, &quot;Enter %s\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    func_autotimer_stop(pdx);</span><br><span class="line"></span><br><span class="line">    card_power_off(&amp;(pdx-&gt;card), FALSE);</span><br><span class="line"></span><br><span class="line">    thermal_uninit(pdx);</span><br><span class="line"></span><br><span class="line">    host_int_sig_dis(&amp;(pdx-&gt;host), 0xffffffff);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //if(pdx-&gt;pm_state.s3s4_entered &amp;&amp; pdx-&gt;cfg-&gt;driver_item.removable == TRUE)</span><br><span class="line"></span><br><span class="line">	//if (pdx-&gt;pm_state.s3s4_entered || pdx-&gt;pm_state.rtd3_entered)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        pdx-&gt;card.initialized_once = FALSE;</span><br><span class="line"></span><br><span class="line">        card_stuct_init(pdx);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //if(pdx-&gt;pm_state.d3_silc_en)</span><br><span class="line"></span><br><span class="line">    //&#123;</span><br><span class="line"></span><br><span class="line">    //backup register value into the registry</span><br><span class="line"></span><br><span class="line">    //os_bak_reg_hibernate();</span><br><span class="line"></span><br><span class="line">    //&#125;</span><br><span class="line"></span><br><span class="line">    //failsafe_fct(pdx);</span><br><span class="line"></span><br><span class="line">    pcr_part_a_backup(pdx);</span><br><span class="line"></span><br><span class="line">    pcr_part_b_backup(pdx);</span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_MAIN_PM, FEATURE_PM_TRACE, 0, &quot;Exit %s\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN</span><br><span class="line"></span><br><span class="line">Adapter_PoFx_Enabled(</span><br><span class="line"></span><br><span class="line">    _In_ void * AdapterExtension</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t * pdx = (bht_dev_ext_t *)AdapterExtension;</span><br><span class="line"></span><br><span class="line">    return (pdx-&gt;os.StateFlags.PoFxEnabled == 1);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BOOLEAN</span><br><span class="line"></span><br><span class="line">Adapter_Acquire_Active_Reference(</span><br><span class="line"></span><br><span class="line">    _In_ bht_dev_ext_t * AdapterExtension,</span><br><span class="line"></span><br><span class="line">    _Inout_opt_ PBOOLEAN		 InIdle</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    BOOLEAN idle = FALSE;</span><br><span class="line"></span><br><span class="line">    BOOLEAN referenceAcquired = FALSE;</span><br><span class="line"></span><br><span class="line">    ULONG status = 0;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_OS_ENTRYAPI, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;Enter %s\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line">    if(Adapter_PoFx_Enabled(AdapterExtension))</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        status = StorPortPoFxActivateComponent(AdapterExtension,</span><br><span class="line"></span><br><span class="line">                                               NULL,</span><br><span class="line"></span><br><span class="line">                                               NULL,</span><br><span class="line"></span><br><span class="line">                                               0,</span><br><span class="line"></span><br><span class="line">                                               0);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        DbgInfo(MODULE_OS_ENTRYAPI, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;StorPortPoFxActivateComponent=%x\n&quot;, status);</span><br><span class="line"></span><br><span class="line">        // STOR_STATUS_BUSY indicates that ActivateComponent is not completed yet.</span><br><span class="line"></span><br><span class="line">        idle = (status == STOR_STATUS_BUSY);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if((status == STOR_STATUS_SUCCESS) || (status == STOR_STATUS_BUSY))</span><br><span class="line"></span><br><span class="line">            referenceAcquired = TRUE;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if(InIdle != NULL)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        *InIdle = idle;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_OS_ENTRYAPI, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;Exit %s, referenceAcquired:%x\n&quot;, __FUNCTION__, referenceAcquired);</span><br><span class="line"></span><br><span class="line">    return referenceAcquired;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VOID</span><br><span class="line"></span><br><span class="line">Adapter_Release_Active_Reference(</span><br><span class="line"></span><br><span class="line">    _In_ bht_dev_ext_t * AdapterExtension</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    ULONG status = 0;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if(Adapter_PoFx_Enabled(AdapterExtension))</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        status = StorPortPoFxIdleComponent(AdapterExtension,</span><br><span class="line"></span><br><span class="line">                                           NULL,</span><br><span class="line"></span><br><span class="line">                                           NULL,</span><br><span class="line"></span><br><span class="line">                                           0,</span><br><span class="line"></span><br><span class="line">                                           0);</span><br><span class="line"></span><br><span class="line">        DbgInfo(MODULE_OS_ENTRYAPI, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;StorPortPoFxIdleComponent=%x\n&quot;, status);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ol start="2">
<li>���ֵ�Ǳ������:</li>
</ol>
<p>a) PoFx ʵ�ֲ�����:</p>
<ul>
<li>����ʹ����StorPortPoFxActivateComponent&#x2F;StorPortPoFxIdleComponent,��û����ȷʵ��������PoFx�ص�</li>
<li>ȱ�ٶ�F-state transitions�Ĵ���</li>
<li>û��ʵ��StorPortPoFxPowerControl�ص�</li>
</ul>
<p>b) D-state ת����������:</p>
<ul>
<li>D3״̬�µļĴ������ʿ���������</li>
<li>��D3״̬����Ȼ���Է����豸�Ĵ���,���ǲ�������</li>
<li>D0��D3��ת��������û����ȷ����ͻָ��豸״̬</li>
</ul>
<p>c) ����Ľ�:</p>
<ol>
<li>����PoFx֧��:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ���ӱ�Ҫ��PoFx�ص�</span></span><br><span class="line">STOR_POFX_COMPONENT_IDLE_STATE_CALLBACK IdleStateCallback;</span><br><span class="line">STOR_POFX_COMPONENT_ACTIVE_CONDITION_CALLBACK ActiveConditionCallback;</span><br><span class="line">STOR_POFX_COMPONENT_IDLE_CONDITION_CALLBACK IdleConditionCallback;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>��ȷ����D-stateת��:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// D3״̬�±�������豸�Ĵ���</span></span><br><span class="line"><span class="keyword">if</span> (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD3) &#123;</span><br><span class="line">    <span class="comment">// ʹ�����ÿռ����</span></span><br><span class="line">    StorPortSetBusDataByOffset();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ���������豸�Ĵ���</span></span><br><span class="line">    StorPortWriteRegisterUlong();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ʵ��DFx֧��:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">STOR_DFX_SETTINGS DfxSettings;</span><br><span class="line">DfxSettings.Version = STOR_DFX_SETTINGS_VERSION_V1;</span><br><span class="line">DfxSettings.Size = <span class="keyword">sizeof</span>(STOR_DFX_SETTINGS); </span><br><span class="line">StorPortInitializeDfx();</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>���Ƶ�Դ״̬ת��:</li>
</ol>
<ul>
<li>�ڽ���D3ǰ�������б�Ҫ���豸״̬</li>
<li>�ڻָ�D0ʱ��ȷ�ָ��豸״̬</li>
<li>ʵ����ȷ��idle��ʱ����</li>
</ul>
<ol start="5">
<li>�Ľ�������:</li>
</ol>
<ul>
<li>���Ӹ���Ĵ�����ͻָ�����</li>
<li>ʵ�������ĵ�Դ���ϻָ�����</li>
</ul>
<p>��Щ�Ľ����԰�����������ĵ�Դ�����ɿ��Ժ����ܡ�����ο����µ�Windows���������ĵ�������Ӧ�ĸ��¡�</p>
<h2 id="User-1"><a href="#User-1" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>ע�⣬���Ǹ�miniport����������·��� @Codebase @Web </p>
<h2 id="AI-claude-3-5-sonnet-1"><a href="#AI-claude-3-5-sonnet-1" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>���ݴ���������ҷ������Storport miniport�����ĵ�Դ����ʵ�ִ������¼�����Ҫ����:</p>
<ol>
<li>PoFxʵ�ֲ�����:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">pdx-&gt;os.AdptPoFxDevice.Version = STOR_POFX_DEVICE_VERSION_V2;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Size = STOR_POFX_DEVICE_V2_SIZE;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.ComponentCount = 1;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// indicate dump miniport can&#x27;t bring adapter to active</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_NO_DUMP_ACTIVE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].Version = STOR_POFX_COMPONENT_VERSION_V1;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].Size = STOR_POFX_COMPONENT_SIZE;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].FStateCount = 1;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].DeepestWakeableFState = 0;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].Id = STORPORT_POFX_ADAPTER_GUID;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].Version = STOR_POFX_COMPONENT_IDLE_STATE_VERSION_V1;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].Size = STOR_POFX_COMPONENT_IDLE_STATE_SIZE;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].TransitionLatency = 0;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].ResidencyRequirement = 0;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].NominalPower = STOR_POFX_UNKNOWN_POWER;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// registry runtime power management for Adapter</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_IDLE_TIMEOUT;</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_ADAPTER_D3_WAKE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//pdx-&gt;os.AdptPoFxDevice.AdapterIdleTimeoutInMS = 1000; //10ms Idle tiemout for D3.</span><br><span class="line"></span><br><span class="line">pdx-&gt;os.AdptPoFxDevice.AdapterIdleTimeoutInMS = pdx-&gt;cfg-&gt;feature_item.psd_mode.adapter_idle_time_s * 1000; //The unit is 1ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">status = StorPortInitializePoFxPower(DeviceExtension, NULL, (PSTOR_POFX_DEVICE)(&amp;(pdx-&gt;os.AdptPoFxDevice)), &amp;enableD3Cold);</span><br><span class="line"></span><br><span class="line">DbgInfo(MODULE_OS_ENTRY, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;%s StorPortInitializePoFxPower=%x,enableD3Cold=%x\n&quot;,</span><br><span class="line"></span><br><span class="line">        __TIME__, status, enableD3Cold);</span><br><span class="line"></span><br><span class="line">DbgInfo(MODULE_OS_ENTRY, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;pdx-&gt;os.AdptPoFxDevice.AdapterIdleTimeoutInMS =%d ,pdx-&gt;os.AdptPoFxDevice.Flags=%x , STOR_STATUS_SUCCESS=%x\n&quot;,</span><br><span class="line"></span><br><span class="line">        pdx-&gt;os.AdptPoFxDevice.AdapterIdleTimeoutInMS, pdx-&gt;os.AdptPoFxDevice.Flags, STOR_STATUS_SUCCESS);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if(status != STOR_STATUS_SUCCESS)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.StateFlags.PoFxEnabled = FALSE;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.StateFlags.PoFxActive = FALSE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    goto Exit;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ul>
<li>��Ȼ��ʼ����PoFx�豸,��ȱ�ٹؼ��Ļص�����ʵ��</li>
<li>û��ʵ��ScsiAdapterPoFxPowerControl����</li>
<li>F-stateת������������</li>
</ul>
<ol start="2">
<li>D-stateת������:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">void req_enter_d3(bht_dev_ext_t * pdx)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_MAIN_PM, FEATURE_PM_TRACE, 0, &quot;Enter %s\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    func_autotimer_stop(pdx);</span><br><span class="line"></span><br><span class="line">    card_power_off(&amp;(pdx-&gt;card), FALSE);</span><br><span class="line"></span><br><span class="line">    thermal_uninit(pdx);</span><br><span class="line"></span><br><span class="line">    host_int_sig_dis(&amp;(pdx-&gt;host), 0xffffffff);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //if(pdx-&gt;pm_state.s3s4_entered &amp;&amp; pdx-&gt;cfg-&gt;driver_item.removable == TRUE)</span><br><span class="line"></span><br><span class="line">	//if (pdx-&gt;pm_state.s3s4_entered || pdx-&gt;pm_state.rtd3_entered)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        pdx-&gt;card.initialized_once = FALSE;</span><br><span class="line"></span><br><span class="line">        card_stuct_init(pdx);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //if(pdx-&gt;pm_state.d3_silc_en)</span><br><span class="line"></span><br><span class="line">    //&#123;</span><br><span class="line"></span><br><span class="line">    //backup register value into the registry</span><br><span class="line"></span><br><span class="line">    //os_bak_reg_hibernate();</span><br><span class="line"></span><br><span class="line">    //&#125;</span><br><span class="line"></span><br><span class="line">    //failsafe_fct(pdx);</span><br><span class="line"></span><br><span class="line">    pcr_part_a_backup(pdx);</span><br><span class="line"></span><br><span class="line">    pcr_part_b_backup(pdx);</span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_MAIN_PM, FEATURE_PM_TRACE, 0, &quot;Exit %s\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ul>
<li>D3״̬�µļĴ������ʿ���������</li>
<li>����D3״̬ʱû�����������豸״̬</li>
<li>��D3�ָ�ʱû����ȷ�ָ�����״̬</li>
</ul>
<ol start="3">
<li>Runtime D3(RTD3)ʵ������:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">    DbgInfo(MODULE_VEN_HOST, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;Enter %s\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line">    if(host-&gt;chip_type == CHIP_SEAEAGLE2)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        if(rtd3_setting.rtd3_ctrl_mode)</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            d3_mode = rtd3_setting.d3_work_mode_sel;</span><br><span class="line"></span><br><span class="line">            pci_andl(host, 0x3f0, ~(3 &lt;&lt; 28));</span><br><span class="line"></span><br><span class="line">            pci_orl(host, 0x3f0, (d3_mode &amp; 3) &lt;&lt; 28);</span><br><span class="line"></span><br><span class="line">            pci_andl(host, 0x3f0, ~(1 &lt;&lt; 26));</span><br><span class="line"></span><br><span class="line">            pci_orl(host, 0x3f0, (rtd3_setting.d3silence_submode_sel &lt;&lt; 26));</span><br><span class="line"></span><br><span class="line">            *d3_submode = rtd3_setting.d3silence_submode_sel;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        else</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            d3_mode = (pci_readl(host, 0x3f0) &gt;&gt; 28) &amp; 3;</span><br><span class="line"></span><br><span class="line">            *d3_submode = (pci_readl(host, 0x3f0) &gt;&gt; 26) &amp; 1;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_VEN_HOST, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;Exit %s, D3 mode:%x\n&quot;, __FUNCTION__, d3_mode);</span><br><span class="line"></span><br><span class="line">    return d3_mode;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ul>
<li>RTD3ģʽѡ���߼�������</li>
<li>ȱ�ٶ�RTD3 wake-up�Ĵ���</li>
<li>RTD3״̬�µĵ�Դ����������</li>
</ul>
<p>����Ľ�:</p>
<ol>
<li>����PoFx֧��:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ���ӱ�Ҫ��PoFx�ص�</span></span><br><span class="line">STOR_POFX_DEVICE_SETTINGS PoFxSettings = &#123;</span><br><span class="line">    .Version = STOR_POFX_SETTINGS_VERSION_V1,</span><br><span class="line">    .Size = <span class="keyword">sizeof</span>(STOR_POFX_DEVICE_SETTINGS),</span><br><span class="line">    .ComponentIdleStateCallback = ComponentIdleStateCallback,</span><br><span class="line">    .ComponentActiveConditionCallback = ComponentActiveConditionCallback,</span><br><span class="line">    .ComponentIdleConditionCallback = ComponentIdleConditionCallback</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>�Ľ�D-stateת��:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">EnterD3State</span><span class="params">(<span class="type">bht_dev_ext_t</span> *pdx)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. ֹͣ����I/O</span></span><br><span class="line">    StopAllIO(pdx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. �����豸״̬</span></span><br><span class="line">    SaveDeviceState(pdx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. �ر��豸��Դ</span></span><br><span class="line">    DisableDevicePower(pdx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����״̬��־</span></span><br><span class="line">    pdx-&gt;pm_state.d0d3_state = StorPowerDeviceD3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>����RTD3֧��:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">HandleRTD3Transition</span><span class="params">(<span class="type">bht_dev_ext_t</span> *pdx)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. ���RTD3����</span></span><br><span class="line">    <span class="keyword">if</span> (!CanEnterRTD3(pdx)) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_UNSUCCESSFUL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ����RTD3������</span></span><br><span class="line">    SaveRTD3Context(pdx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ���û�������</span></span><br><span class="line">    ConfigureWakeSettings(pdx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ����RTD3</span></span><br><span class="line">    EnterRTD3State(pdx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>���ӵ�Դ״̬���:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">MonitorPowerState</span><span class="params">(<span class="type">bht_dev_ext_t</span> *pdx)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. ��¼״̬ת��</span></span><br><span class="line">    LogPowerStateTransition(pdx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ��ع���</span></span><br><span class="line">    MonitorPowerConsumption(pdx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ����쳣</span></span><br><span class="line">    DetectPowerAnomalies(pdx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>ʵ��������DFx֧��:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">InitializeDFx</span><span class="params">(<span class="type">bht_dev_ext_t</span> *pdx)</span> &#123;</span><br><span class="line">    STOR_DFX_SETTINGS DfxSettings;</span><br><span class="line">    DfxSettings.Version = STOR_DFX_SETTINGS_VERSION_V1;</span><br><span class="line">    DfxSettings.Size = <span class="keyword">sizeof</span>(STOR_DFX_SETTINGS);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ����DFx����</span></span><br><span class="line">    ConfigureDFxSettings(&amp;DfxSettings);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> StorPortInitializeDfx(pdx, &amp;DfxSettings);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Щ�Ľ�����:</p>
<ol>
<li>��ߵ�Դ�����Ŀɿ���</li>
<li>�Ż����Ŀ���</li>
<li>�����豸�ڲ�ͬ��Դ״̬�µ���Ϊ</li>
<li>�ṩ���õĵ��Ժ��������</li>
</ol>
<p>����ο����µ�Windows���������ĵ�������Ӧ���¡�</p>
<h2 id="User-2"><a href="#User-2" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����Щ�������WIndows Storport Miniport�淶��</p>
<h2 id="AI-claude-3-5-sonnet-2"><a href="#AI-claude-3-5-sonnet-2" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�������»��� Storport Miniport �淶�������ͽ���:</p>
<ol>
<li>Storport PoFx ֧��Ӧ��ͨ�����·�ʽʵ��:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. �� HwInitialize �г�ʼ�� PoFx</span></span><br><span class="line">BOOLEAN <span class="title function_">HwInitialize</span><span class="params">(PVOID DeviceExtension)</span> &#123;</span><br><span class="line">    PSTOR_POFX_DEVICE pPoFxDevice = &amp;pdx-&gt;os.AdptPoFxDevice;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���� PoFx �豸</span></span><br><span class="line">    pPoFxDevice-&gt;Version = STOR_POFX_DEVICE_VERSION_V2;</span><br><span class="line">    pPoFxDevice-&gt;Size = STOR_POFX_DEVICE_V2_SIZE;</span><br><span class="line">    pPoFxDevice-&gt;ComponentCount = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ���ÿ��г�ʱ</span></span><br><span class="line">    pPoFxDevice-&gt;Flags |= STOR_POFX_DEVICE_FLAG_IDLE_TIMEOUT;</span><br><span class="line">    pPoFxDevice-&gt;AdapterIdleTimeoutInMS = IdleTimeoutValue;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ��ʼ�� PoFx</span></span><br><span class="line">    status = StorPortInitializePoFxPower(DeviceExtension, </span><br><span class="line">                                       <span class="literal">NULL</span>,</span><br><span class="line">                                       pPoFxDevice,</span><br><span class="line">                                       &amp;enableD3Cold);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>��ȷʵ�� ScsiAdapterControl ������Դ״̬ת��:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">SCSI_ADAPTER_CONTROL_STATUS </span><br><span class="line">HwAdapterControl(</span><br><span class="line">    IN PVOID DeviceExtension,</span><br><span class="line">    IN SCSI_ADAPTER_CONTROL_TYPE ControlType,</span><br><span class="line">    IN PVOID Parameters</span><br><span class="line">    )</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    switch(ControlType) &#123;</span><br><span class="line">        case ScsiAdapterPowerState:</span><br><span class="line">            PSCSI_ADAPTER_CONTROL_POWER Power = </span><br><span class="line">                (PSCSI_ADAPTER_CONTROL_POWER)Parameters;</span><br><span class="line">            </span><br><span class="line">            switch(Power-&gt;PowerState) &#123;</span><br><span class="line">                case StorPowerDeviceD0:</span><br><span class="line">                    // �� D3 �ָ�</span><br><span class="line">                    RestoreFromD3(pdx);</span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                case StorPowerDeviceD3:</span><br><span class="line">                    // ���� D3</span><br><span class="line">                    PrepareForD3(pdx);</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case ScsiAdapterPoFxPowerRequired:</span><br><span class="line">            // ���� PoFx ��������</span><br><span class="line">            HandlePoFxActivation(pdx);</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case ScsiAdapterPoFxPowerActive:</span><br><span class="line">            // ���� PoFx �������</span><br><span class="line">            HandlePoFxActiveComplete(pdx);</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return ScsiAdapterControlSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>��ȷ�� D3 ״̬����:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">void PrepareForD3(bht_dev_ext_t *pdx) &#123;</span><br><span class="line">    // 1. ֹͣ���� I/O</span><br><span class="line">    StorPortPause(pdx);</span><br><span class="line">    </span><br><span class="line">    // 2. �����ж�</span><br><span class="line">    StorPortDisableInterrupts(pdx);</span><br><span class="line">    </span><br><span class="line">    // 3. �����Ҫ�ļĴ���״̬</span><br><span class="line">    pcr_part_a_backup(pdx);</span><br><span class="line">    pcr_part_b_backup(pdx);</span><br><span class="line">    </span><br><span class="line">    // 4. �ر��豸��Դ</span><br><span class="line">    card_power_off(&amp;(pdx-&gt;card), FALSE);</span><br><span class="line">    </span><br><span class="line">    // 5. ����״̬</span><br><span class="line">    pdx-&gt;pm_state.d0d3_state = StorPowerDeviceD3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void RestoreFromD3(bht_dev_ext_t *pdx) &#123;</span><br><span class="line">    // 1. �ָ��Ĵ���״̬</span><br><span class="line">    pcr_part_a_restore(pdx);</span><br><span class="line">    pcr_part_b_restore(pdx);</span><br><span class="line">    </span><br><span class="line">    // 2. ���³�ʼ���豸</span><br><span class="line">    host_init(&amp;pdx-&gt;host);</span><br><span class="line">    </span><br><span class="line">    // 3. �����ж�</span><br><span class="line">    StorPortEnableInterrupts(pdx);</span><br><span class="line">    </span><br><span class="line">    // 4. �ָ� I/O</span><br><span class="line">    StorPortResume(pdx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>���� RTD3 ��֧��:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// �� HwFindAdapter ��ע�� RTD3 ֧��</span><br><span class="line">BOOLEAN HwFindAdapter(</span><br><span class="line">    PVOID DeviceExtension,</span><br><span class="line">    HW_INITIALIZATION_DATA *HwInitializationData)</span><br><span class="line">&#123;</span><br><span class="line">    // ���� RTD3 ֧�ֱ�־</span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_ADAPTER_D3_WAKE;</span><br><span class="line">    </span><br><span class="line">    // ���� RTD3 ��������</span><br><span class="line">    if (pdx-&gt;cfg-&gt;feature_item.rtd3_support) &#123;</span><br><span class="line">        ConfigureRTD3WakeSettings(pdx);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ��Ľ�����:</p>
<ol>
<li>�ϸ���ѭ Storport �ĵ�Դ�����ӿ�:</li>
</ol>
<ul>
<li>ʹ�� StorPortInitializePoFxPower ��ʼ��</li>
<li>��ȷʵ�� ScsiAdapterControl �ص�</li>
<li>ʹ�� StorPort �ṩ�ĵ�Դ���� API</li>
</ul>
<ol start="2">
<li>��ȷ�����ж�:</li>
</ol>
<ul>
<li>D3 ǰ�����ж�</li>
<li>D0 ʱ���������ж�</li>
</ul>
<ol start="3">
<li>�Ĵ�������:</li>
</ol>
<ul>
<li>D3 ״̬�±���ֱ�ӷ����豸�Ĵ���</li>
<li>ʹ�� StorPortGetDeviceBase �� StorPortWriteRegisterUlong �Ƚӿ�</li>
</ul>
<ol start="4">
<li>����ָ�:</li>
</ol>
<ul>
<li>ʵ�������Ĵ�����ͻָ�����</li>
<li>ʹ�� StorPort �ṩ�Ĵ���������</li>
</ul>
<p>��Щ���鶼���� Microsoft Storport Miniport �����淶��������������Ŀɿ��Ժͼ����ԡ�</p>
<h2 id="User-3"><a href="#User-3" class="headerlink" title="User:"></a>User:</h2><p>[selections]  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> ScsiAdapterPoFxPowerRequired:</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ���� PoFx ��������</span></span><br><span class="line"></span><br><span class="line">            HandlePoFxActivation(pdx);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> ScsiAdapterPoFxPowerActive:</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ���� PoFx �������</span></span><br><span class="line"></span><br><span class="line">            HandlePoFxActiveComplete(pdx);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>[text]<br>�����ⲿ�����ʵ��:</p>
<h2 id="AI-claude-3-5-sonnet-3"><a href="#AI-claude-3-5-sonnet-3" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>���� Storport Miniport �淶���������ص���ʵ��Ӧ������:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">SCSI_ADAPTER_CONTROL_STATUS </span><br><span class="line">HwAdapterControl(</span><br><span class="line">    IN PVOID DeviceExtension,</span><br><span class="line">    IN SCSI_ADAPTER_CONTROL_TYPE ControlType,</span><br><span class="line">    IN PVOID Parameters</span><br><span class="line">) &#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    SCSI_ADAPTER_CONTROL_STATUS status = ScsiAdapterControlSuccess;</span><br><span class="line"></span><br><span class="line">    switch(ControlType) &#123;</span><br><span class="line">        case ScsiAdapterPoFxPowerRequired:</span><br><span class="line">            // PoFx ֪ͨ������Ҫ�����豸</span><br><span class="line">            // ��ʱ�豸���ܴ��ڵ͹���״̬����Ҫ׼���ָ�����</span><br><span class="line">            </span><br><span class="line">            // 1. ��鵱ǰ״̬</span><br><span class="line">            if (pdx-&gt;pm_state.d0d3_state != StorPowerDeviceD0) &#123;</span><br><span class="line">                // 2. �ָ�ʱ�Ӻ͵�Դ</span><br><span class="line">                if (!host_enable_clock(&amp;pdx-&gt;host, TRUE)) &#123;</span><br><span class="line">                    status = ScsiAdapterControlFailure;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                // 3. �ȴ��豸�ȶ�</span><br><span class="line">                StorPortStallExecution(pdx-&gt;cfg-&gt;feature_item.power_stable_time_us);</span><br><span class="line">                </span><br><span class="line">                // 4. �ָ��ؼ��Ĵ���</span><br><span class="line">                pcr_part_a_restore(pdx);</span><br><span class="line">                </span><br><span class="line">                // 5. ����״̬��־</span><br><span class="line">                pdx-&gt;pm_state.d0d3_state = StorPowerDeviceD0;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case ScsiAdapterPoFxPowerActive:</span><br><span class="line">            // PoFx ֪ͨ�����豸����ȫ����</span><br><span class="line">            // ��ʱ���Իָ���������</span><br><span class="line">            </span><br><span class="line">            // 1. �ָ��������豸״̬</span><br><span class="line">            pcr_part_b_restore(pdx);</span><br><span class="line">            </span><br><span class="line">            // 2. ���³�ʼ���ж�</span><br><span class="line">            host_int_sig_en(&amp;pdx-&gt;host, pdx-&gt;host.int_mask);</span><br><span class="line">            </span><br><span class="line">            // 3. �ָ� DMA ����</span><br><span class="line">            if (pdx-&gt;cfg-&gt;feature_item.dma_enable) &#123;</span><br><span class="line">                if (!host_dma_init(&amp;pdx-&gt;host)) &#123;</span><br><span class="line">                    status = ScsiAdapterControlFailure;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 4. �ָ��Զ���ʱ��</span><br><span class="line">            if (pdx-&gt;auto_timer.enable) &#123;</span><br><span class="line">                func_autotimer_start(pdx);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 5. ��鿨״̬</span><br><span class="line">            if (pdx-&gt;card.card_present) &#123;</span><br><span class="line">                // �������λ��������Ҫ���³�ʼ��</span><br><span class="line">                if (!card_reinit(&amp;pdx-&gt;card)) &#123;</span><br><span class="line">                    DbgWarn(&quot;Card reinit failed after power active&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 6. ���� PoFx ״̬��־</span><br><span class="line">            pdx-&gt;os.StateFlags.PoFxActive = TRUE;</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ�˵��:</p>
<ol>
<li>ScsiAdapterPoFxPowerRequired:</li>
</ol>
<ul>
<li>���ǵ�һ�׶εĵ�Դ�ָ�֪ͨ</li>
<li>��ʱֻ�ָ�������Ĺ���(ʱ�ӡ���Դ��)</li>
<li>��Ҫִ�к�ʱ��������Ϊ������� PoFx ���</li>
</ul>
<ol start="2">
<li>ScsiAdapterPoFxPowerActive:</li>
</ol>
<ul>
<li>���ǵڶ��׶εĵ�Դ�ָ�֪ͨ</li>
<li>��ʱ����ִ���������豸��ʼ��</li>
<li>���Իָ����й��ܣ����� DMA���жϵ�</li>
<li>���Դ�����ʱ����</li>
</ul>
<ol start="3">
<li>������:</li>
</ol>
<ul>
<li>���йؼ���������Ҫ��鷵��ֵ</li>
<li>����ָ�ʧ�ܣ����� ScsiAdapterControlFailure</li>
<li>��¼������־���ڵ���</li>
</ul>
<ol start="4">
<li>״̬ͬ��:</li>
</ol>
<ul>
<li>ȷ����ȷ�����ڲ�״̬��־</li>
<li>���� PoFx ״̬���豸ʵ��״̬ͬ��</li>
</ul>
<ol start="5">
<li>���ܿ���:</li>
</ol>
<ul>
<li>PowerRequired �ص�Ҫ���췵��</li>
<li>��ʱ�������� PowerActive ��ִ��</li>
<li>ʹ���ʵ�����ʱȷ���豸�ȶ�</li>
</ul>
<p>������ʵ�ֿ���ȷ��:</p>
<ol>
<li>���� Storport PoFx �淶</li>
<li>��ȷ�����豸��Դ״̬ת��</li>
<li>�ṩ�ɿ��Ĵ���ָ�����</li>
<li>�Ż���Դ��������</li>
</ol>
<h2 id="User-4"><a href="#User-4" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>ʲôʱ����Ҫ����Pofx��Active��Idle������Ҫ���Storport miniport���ڵĵ�Դ��������ͻ</p>
<h2 id="AI-claude-3-5-sonnet-4"><a href="#AI-claude-3-5-sonnet-4" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�� Storport miniport �����У�PoFx �� Active&#x2F;Idle ������Ҫ�����õĵ�Դ����Э������������ȷ��ʹ�ó�����</p>
<ol>
<li>���� StorPortPoFxActivateComponent:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN Adapter_Acquire_Active_Reference(</span><br><span class="line">    _In_ bht_dev_ext_t *pdx,</span><br><span class="line">    _Inout_opt_ PBOOLEAN InIdle</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    BOOLEAN referenceAcquired = FALSE;</span><br><span class="line">    ULONG status;</span><br><span class="line"></span><br><span class="line">    // 1. ֻ�� PoFx ����ʱ����</span><br><span class="line">    if (!pdx-&gt;os.StateFlags.PoFxEnabled) &#123;</span><br><span class="line">        return TRUE;  // ��� PoFx δ���ã���Ϊ�豸ʼ�մ��ڼ���״̬</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 2. �����ظ�����</span><br><span class="line">    if (pdx-&gt;os.StateFlags.PoFxActive) &#123;</span><br><span class="line">        return TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 3. �����³�������:</span><br><span class="line">    // - �����µ� I/O ����ǰ</span><br><span class="line">    // - ��Ҫ�����豸�Ĵ���ʱ</span><br><span class="line">    // - �豸��Ҫ���ֻ״̬ʱ</span><br><span class="line">    status = StorPortPoFxActivateComponent(</span><br><span class="line">        pdx,</span><br><span class="line">        NULL,</span><br><span class="line">        NULL,</span><br><span class="line">        0,</span><br><span class="line">        0</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    if (status == STOR_STATUS_SUCCESS || status == STOR_STATUS_BUSY) &#123;</span><br><span class="line">        referenceAcquired = TRUE;</span><br><span class="line">        if (InIdle) &#123;</span><br><span class="line">            *InIdle = (status == STOR_STATUS_BUSY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return referenceAcquired;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>���� StorPortPoFxIdleComponent:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">VOID Adapter_Release_Active_Reference(</span><br><span class="line">    _In_ bht_dev_ext_t *pdx</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    // 1. ֻ�� PoFx ����ʱ����</span><br><span class="line">    if (!pdx-&gt;os.StateFlags.PoFxEnabled) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 2. �����³�������:</span><br><span class="line">    // - I/O ������ɺ�</span><br><span class="line">    // - �豸���Խ���͹���״̬ʱ</span><br><span class="line">    // - ��ʱ���޻ʱ</span><br><span class="line">    if (pdx-&gt;os.StateFlags.PoFxActive) &#123;</span><br><span class="line">        StorPortPoFxIdleComponent(</span><br><span class="line">            pdx,</span><br><span class="line">            NULL,</span><br><span class="line">            NULL,</span><br><span class="line">            0,</span><br><span class="line">            0</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>��ȷ��ʹ��λ��:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">// ʾ������ StartIo ������</span><br><span class="line">BOOLEAN HwStartIo(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ PSCSI_REQUEST_BLOCK Srb</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    BOOLEAN inIdle = FALSE;</span><br><span class="line"></span><br><span class="line">    // 1. �ڴ��� I/O ǰ��ȡ��������</span><br><span class="line">    if (!Adapter_Acquire_Active_Reference(pdx, &amp;inIdle)) &#123;</span><br><span class="line">        return FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 2. ����豸���ڴӿ���״̬�ָ����ȴ����</span><br><span class="line">    if (inIdle) &#123;</span><br><span class="line">        // ���������ȴ�����</span><br><span class="line">        QueuePendingRequest(pdx, Srb);</span><br><span class="line">        return TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ���� I/O ����</span><br><span class="line">    ProcessIoRequest(pdx, Srb);</span><br><span class="line"></span><br><span class="line">    // 3. I/O ��ɺ��ͷ�����</span><br><span class="line">    Adapter_Release_Active_Reference(pdx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>��Ҫ��������:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ����ʾ������Ҫ����Щ�������� PoFx ����</span></span><br><span class="line">SCSI_ADAPTER_CONTROL_STATUS <span class="title function_">HwAdapterControl</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID DeviceExtension,</span></span><br><span class="line"><span class="params">    _In_ SCSI_ADAPTER_CONTROL_TYPE ControlType,</span></span><br><span class="line"><span class="params">    _In_ PVOID Parameters</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">bht_dev_ext_t</span> *pdx = (<span class="type">bht_dev_ext_t</span> *)DeviceExtension;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (ControlType) &#123;</span><br><span class="line">        <span class="keyword">case</span> ScsiAdapterPowerState:</span><br><span class="line">            <span class="comment">// ���󣺲�Ҫ�ڵ�Դ״̬ת�������е��� PoFx ����</span></span><br><span class="line">            <span class="comment">// Adapter_Acquire_Active_Reference(pdx, NULL);  // ����</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> ScsiAdapterPoFxPowerRequired:</span><br><span class="line">        <span class="keyword">case</span> ScsiAdapterPoFxPowerActive:</span><br><span class="line">            <span class="comment">// ���󣺲�Ҫ�� PoFx �ص����ٵ��� PoFx ����</span></span><br><span class="line">            <span class="comment">// Adapter_Acquire_Active_Reference(pdx, NULL);  // ����</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>�� Storport ��Դ����Э��:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ��ȷ������Դ״̬ת��</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">HandlePowerTransition</span><span class="params">(<span class="type">bht_dev_ext_t</span> *pdx, STOR_DEVICE_POWER_STATE newState)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (newState) &#123;</span><br><span class="line">        <span class="keyword">case</span> StorPowerDeviceD0:</span><br><span class="line">            <span class="comment">// �豸���� D0 ״̬������Ҫ�������� PoFx ����</span></span><br><span class="line">            <span class="comment">// �� Storport ��ܴ��� PoFx ״̬</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> StorPowerDeviceD3:</span><br><span class="line">            <span class="comment">// ȷ���ڽ��� D3 ǰ���� PoFx ���ö����ͷ�</span></span><br><span class="line">            WaitForAllPoFxReferencesReleased(pdx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ�ԭ��</p>
<ol>
<li>ʱ��ѡ��</li>
</ol>
<ul>
<li>����Ҫ�����豸ǰ���� Activate</li>
<li>������豸���ʺ���� Idle</li>
<li>�����ڵ�Դ״̬ת�������е���</li>
</ul>
<ol start="2">
<li>״̬ͬ����</li>
</ol>
<ul>
<li>ά����ȷ�� PoFx ״̬��־</li>
<li>ȷ���� Storport ��Դ״̬����һ��</li>
<li>�����ظ�����</li>
</ul>
<ol start="3">
<li>��������</li>
</ol>
<ul>
<li>���� STOR_STATUS_BUSY ״̬</li>
<li>ʵ�ֳ�ʱ�����Ի���</li>
<li>��ȷ������Դ</li>
</ul>
<ol start="4">
<li>�����Ż���</li>
</ol>
<ul>
<li>����ʹ�����ü���</li>
<li>����Ƶ����״̬�л�</li>
<li>��������������</li>
</ul>
<p>������ʵ�ֿ���ȷ�� PoFx ������ Storport �����õ�Դ������ȷЭ�����ṩ�ɿ��ĵ�Դ�������ܡ�</p>
<h2 id="User-5"><a href="#User-5" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�ղŵ�����ֻ�漰miniport���ʵ�֣�������������miniport�Ĳ��֣�������Щ������������storport��DDI�ӿ�Ҫ��</p>
<h2 id="AI-claude-3-5-sonnet-5"><a href="#AI-claude-3-5-sonnet-5" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��˵�ö�,�������»��� Storport DDI �淶��������:</p>
<ol>
<li>������ PoFx �ĳ�ʼ��,Ӧ���� HwFindAdapter �����:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">ULONG </span><br><span class="line">HwFindAdapter(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ PVOID HwContext,</span><br><span class="line">    _In_ PVOID BusInformation,</span><br><span class="line">    _In_ PCHAR ArgumentString,</span><br><span class="line">    _Inout_ PPORT_CONFIGURATION_INFORMATION ConfigInfo,</span><br><span class="line">    _Out_ PBOOLEAN Again</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    // ... ������ʼ������ ...</span><br><span class="line">    </span><br><span class="line">    // ��ʼ�� PoFx</span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Version = STOR_POFX_DEVICE_VERSION_V2;</span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Size = STOR_POFX_DEVICE_V2_SIZE;</span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_IDLE_TIMEOUT;</span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.AdapterIdleTimeoutInMS = </span><br><span class="line">        pdx-&gt;cfg-&gt;feature_item.psd_mode.adapter_idle_time_s * 1000;</span><br><span class="line">        </span><br><span class="line">    status = StorPortInitializePoFxPower(</span><br><span class="line">        DeviceExtension,</span><br><span class="line">        NULL,</span><br><span class="line">        &amp;pdx-&gt;os.AdptPoFxDevice,</span><br><span class="line">        &amp;enableD3Cold</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    return SP_RETURN_FOUND;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>��Դ�����ص�Ӧ���� HwAdapterControl �д���:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">SCSI_ADAPTER_CONTROL_STATUS </span><br><span class="line">HwAdapterControl(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ SCSI_ADAPTER_CONTROL_TYPE ControlType,</span><br><span class="line">    _In_ PVOID Parameters</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    switch(ControlType) &#123;</span><br><span class="line">        case ScsiAdapterPoFxPowerRequired:</span><br><span class="line">            // ִֻ�л����ĵ�Դ�ָ�</span><br><span class="line">            if (pdx-&gt;pm_state.d0d3_state != StorPowerDeviceD0) &#123;</span><br><span class="line">                // ʹ�� StorPort API ����Ӳ��</span><br><span class="line">                StorPortWriteRegisterUlong(pdx, &amp;pdx-&gt;host.base[0], 0);</span><br><span class="line">                StorPortStallExecution(1000); // 1ms</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case ScsiAdapterPoFxPowerActive:</span><br><span class="line">            // �������豸��ʼ��</span><br><span class="line">            StorPortWriteRegisterUlong(pdx, &amp;pdx-&gt;host.base[0], </span><br><span class="line">                pdx-&gt;pm_state.reg_0x3e0);</span><br><span class="line">            </span><br><span class="line">            // �����ж�</span><br><span class="line">            StorPortEnableInterrupts(pdx);</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case ScsiAdapterPowerState:</span><br><span class="line">            PSCSI_ADAPTER_CONTROL_POWER Power = </span><br><span class="line">                (PSCSI_ADAPTER_CONTROL_POWER)Parameters;</span><br><span class="line">            switch(Power-&gt;PowerState) &#123;</span><br><span class="line">                case StorPowerDeviceD0:</span><br><span class="line">                    // D0 �ָ�</span><br><span class="line">                    break;</span><br><span class="line">                case StorPowerDeviceD3:</span><br><span class="line">                    // D3 ׼��</span><br><span class="line">                    StorPortDisableInterrupts(pdx);</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return ScsiAdapterControlSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>���� I&#x2F;O ����Ĵ���:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN </span><br><span class="line">HwStartIo(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ PSCSI_REQUEST_BLOCK Srb</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    // ����豸״̬</span><br><span class="line">    if (pdx-&gt;pm_state.d0d3_state != StorPowerDeviceD0) &#123;</span><br><span class="line">        StorPortCompleteRequest(DeviceExtension, </span><br><span class="line">                              Srb-&gt;PathId,</span><br><span class="line">                              Srb-&gt;TargetId, </span><br><span class="line">                              Srb-&gt;Lun,</span><br><span class="line">                              SRB_STATUS_BUSY);</span><br><span class="line">        return TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // ���� I/O ����</span><br><span class="line">    return ProcessSrbRequest(pdx, Srb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>��ȷʹ�� StorPort API:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">void SaveDeviceState(bht_dev_ext_t *pdx)</span><br><span class="line">&#123;</span><br><span class="line">    // ʹ�� StorPort API ��ȡ�Ĵ���</span><br><span class="line">    pdx-&gt;pm_state.reg_0x3e0 = StorPortReadRegisterUlong(</span><br><span class="line">        pdx, </span><br><span class="line">        &amp;pdx-&gt;host.base[0x3e0]</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    // ʹ�� StorPort API ������ʱ</span><br><span class="line">    StorPortStallExecution(100);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void RestoreDeviceState(bht_dev_ext_t *pdx)</span><br><span class="line">&#123;</span><br><span class="line">    // ʹ�� StorPort API д��Ĵ���</span><br><span class="line">    StorPortWriteRegisterUlong(</span><br><span class="line">        pdx,</span><br><span class="line">        &amp;pdx-&gt;host.base[0x3e0],</span><br><span class="line">        pdx-&gt;pm_state.reg_0x3e0</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ�����:</p>
<ol>
<li><p>�Ƴ����Զ���� Active&#x2F;Idle ����,��Ϊ��ЩӦ���� Storport ��ܹ���</p>
</li>
<li><p>ʹ�ñ�׼�� StorPort DDI:</p>
</li>
</ol>
<ul>
<li>StorPortReadRegisterUlong</li>
<li>StorPortWriteRegisterUlong</li>
<li>StorPortStallExecution</li>
<li>StorPortEnableInterrupts&#x2F;DisableInterrupts</li>
</ul>
<ol start="3">
<li>��ȷ���� SRB ����:</li>
</ol>
<ul>
<li>ʹ�� StorPortCompleteRequest</li>
<li>���ر�׼�� SRB_STATUS ֵ</li>
</ul>
<ol start="4">
<li>��ѭ Storport �ĵ�Դ��������:</li>
</ol>
<ul>
<li>ͨ�� ScsiAdapterControl ������Դ״̬ת��</li>
<li>ʹ�� StorPort �ṩ���жϹ�������</li>
<li>��ȷ���� D-state �� PoFx ״̬</li>
</ul>
<p>������ʵ�ָ����� Storport Miniport �����淶,������ Storport ��ܸ��õ�Э����</p>
<h2 id="User-6"><a href="#User-6" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>Ϊʲô Active&#x2F;Idle ������Ӧ�õ���,��Ϊ��ЩӦ���� Storport ��ܹ������� @Web ���Ӹ���֤��</p>
<h2 id="AI-claude-3-5-sonnet-6"><a href="#AI-claude-3-5-sonnet-6" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>����Ҫ����֮ǰ��˵����</p>
<p>���� Microsoft �ĵ�:</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportpofxactivatecomponent">StorPortPoFxActivateComponent function</a><br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/nf-storport-storportpofxidlecomponent">StorPortPoFxIdleComponent function</a></p>
<p>Miniport ����ȷʵ��Ҫ����������Щ��������������ĵ�Դ״̬��������˵:</p>
<ol>
<li>StorPortPoFxActivateComponent:</li>
</ol>
<ul>
<li>��������Ҫ�����豸ʱ����</li>
<li>�ڴ��� I&#x2F;O ����ǰ����</li>
<li>ȷ���豸���ڻ״̬</li>
</ul>
<ol start="2">
<li>StorPortPoFxIdleComponent:</li>
</ol>
<ul>
<li>����������豸���ʺ����</li>
<li>�����豸����͹���״̬</li>
<li>��� idle timeout ����ʹ��</li>
</ul>
<p>��ȷ��ʹ��ʾ��:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN</span><br><span class="line">Adapter_Acquire_Active_Reference(</span><br><span class="line">    _In_ void * AdapterExtension,</span><br><span class="line">    _Inout_opt_ PBOOLEAN InIdle</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t * pdx = (bht_dev_ext_t *)AdapterExtension;</span><br><span class="line">    BOOLEAN referenceAcquired = FALSE;</span><br><span class="line">    ULONG status = 0;</span><br><span class="line"></span><br><span class="line">    if(Adapter_PoFx_Enabled(AdapterExtension))</span><br><span class="line">    &#123;</span><br><span class="line">        status = StorPortPoFxActivateComponent(AdapterExtension,</span><br><span class="line">                                               NULL,</span><br><span class="line">                                               NULL,</span><br><span class="line">                                               0,</span><br><span class="line">                                               0);</span><br><span class="line"></span><br><span class="line">        // STOR_STATUS_BUSY ��ʾ�������ڽ�����</span><br><span class="line">        if(InIdle != NULL)</span><br><span class="line">        &#123;</span><br><span class="line">            *InIdle = (status == STOR_STATUS_BUSY);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if((status == STOR_STATUS_SUCCESS) || (status == STOR_STATUS_BUSY))</span><br><span class="line">            referenceAcquired = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return referenceAcquired;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID</span><br><span class="line">Adapter_Release_Active_Reference(</span><br><span class="line">    _In_ bht_dev_ext_t * AdapterExtension</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    if(Adapter_PoFx_Enabled(AdapterExtension))</span><br><span class="line">    &#123;</span><br><span class="line">        StorPortPoFxIdleComponent(AdapterExtension,</span><br><span class="line">                                   NULL,</span><br><span class="line">                                   NULL,</span><br><span class="line">                                   0,</span><br><span class="line">                                   0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>��Щ������Ҫ�� ScsiAdapterControl �е� PoFx �ص����ʹ��:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">case ScsiAdapterPoFxPowerRequired:</span><br><span class="line">    // ��Ӧ StorPortPoFxActivateComponent �ĵ���</span><br><span class="line">    // ִ�л����ĵ�Դ�ָ�</span><br><span class="line">    break;</span><br><span class="line"></span><br><span class="line">case ScsiAdapterPoFxPowerActive:</span><br><span class="line">    // �豸����ȫ����</span><br><span class="line">    // ���Կ�ʼ�����豸</span><br><span class="line">    break;</span><br></pre></td></tr></table></figure>

<p>��Ϊ֮ǰ˵”��ЩӦ���� Storport ��ܹ���”��˵����Ǹ�����ǲ���ȷ�ģ�Miniport ������Ҫ����������Щ�����������豸�ĵ�Դ״̬��</p>
<h2 id="User-7"><a href="#User-7" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����ϸ�������룬miniport driver�ںδ�����StorPortPoFxActivateComponent��StorPortPoFxIdleComponent��������μ���ScsiAdapterControl �е� PoFx �ص����Լ�ScsiAdapterControl �е�ScsiAdapterPower D0&#x2F;D3����</p>
<h2 id="AI-claude-3-5-sonnet-7"><a href="#AI-claude-3-5-sonnet-7" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>���� Storport �淶����������ϸ��ʵ�ַ�����</p>
<ol>
<li>�����ڹؼ��� I&#x2F;O ·���е��� Active&#x2F;Idle��</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN HwStartIo(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ PSCSI_REQUEST_BLOCK Srb</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    BOOLEAN inIdle = FALSE;</span><br><span class="line">    </span><br><span class="line">    // 1. ����Ƿ���D3״̬</span><br><span class="line">    if (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD3) &#123;</span><br><span class="line">        StorPortCompleteRequest(DeviceExtension, </span><br><span class="line">                              Srb-&gt;PathId,</span><br><span class="line">                              Srb-&gt;TargetId,</span><br><span class="line">                              Srb-&gt;Lun,</span><br><span class="line">                              SRB_STATUS_BUSY);</span><br><span class="line">        return TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 2. ��ȡActive����</span><br><span class="line">    if (Adapter_PoFx_Enabled(pdx)) &#123;</span><br><span class="line">        ULONG status = StorPortPoFxActivateComponent(pdx, NULL, NULL, 0, 0);</span><br><span class="line">        if (status == STOR_STATUS_BUSY) &#123;</span><br><span class="line">            // �豸���ڻָ������������ȴ�����</span><br><span class="line">            QueueDeferredSrb(pdx, Srb);</span><br><span class="line">            return TRUE;</span><br><span class="line">        &#125; else if (status != STOR_STATUS_SUCCESS) &#123;</span><br><span class="line">            StorPortCompleteRequest(DeviceExtension, </span><br><span class="line">                                  Srb-&gt;PathId,</span><br><span class="line">                                  Srb-&gt;TargetId,</span><br><span class="line">                                  Srb-&gt;Lun,</span><br><span class="line">                                  SRB_STATUS_ERROR);</span><br><span class="line">            return TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 3. ����I/O����</span><br><span class="line">    BOOLEAN result = ProcessSrbRequest(pdx, Srb);</span><br><span class="line">    </span><br><span class="line">    // 4. �ͷ�Active����</span><br><span class="line">    if (Adapter_PoFx_Enabled(pdx)) &#123;</span><br><span class="line">        StorPortPoFxIdleComponent(pdx, NULL, NULL, 0, 0);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>�� ScsiAdapterControl ����ȷ�������е�Դ��ػص���</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">SCSI_ADAPTER_CONTROL_STATUS </span><br><span class="line">HwAdapterControl(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ SCSI_ADAPTER_CONTROL_TYPE ControlType,</span><br><span class="line">    _In_ PVOID Parameters</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    SCSI_ADAPTER_CONTROL_STATUS status = ScsiAdapterControlSuccess;</span><br><span class="line"></span><br><span class="line">    switch(ControlType) &#123;</span><br><span class="line">        case ScsiAdapterPowerState: &#123;</span><br><span class="line">            PSCSI_ADAPTER_CONTROL_POWER Power = </span><br><span class="line">                (PSCSI_ADAPTER_CONTROL_POWER)Parameters;</span><br><span class="line">            </span><br><span class="line">            switch(Power-&gt;PowerState) &#123;</span><br><span class="line">                case StorPowerDeviceD0:</span><br><span class="line">                    // 1. ����״̬</span><br><span class="line">                    pdx-&gt;pm_state.d0d3_state = StorPowerDeviceD0;</span><br><span class="line">                    </span><br><span class="line">                    // 2. ������ʼ��</span><br><span class="line">                    if (!host_init(&amp;pdx-&gt;host)) &#123;</span><br><span class="line">                        status = ScsiAdapterControlFailure;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    // 3. ע�⣺��Ҫ���������StorPortPoFxActivateComponent</span><br><span class="line">                    // D0�ָ���PoFx��ͨ��ScsiAdapterPoFxPowerRequired/Active֪ͨ</span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                case StorPowerDeviceD3:</span><br><span class="line">                    // 1. ȷ������I/O���</span><br><span class="line">                    StorPortPauseDevice(DeviceExtension);</span><br><span class="line">                    </span><br><span class="line">                    // 2. �����ж�</span><br><span class="line">                    StorPortDisableInterrupts(DeviceExtension);</span><br><span class="line">                    </span><br><span class="line">                    // 3. �����豸״̬</span><br><span class="line">                    SaveDeviceState(pdx);</span><br><span class="line">                    </span><br><span class="line">                    // 4. ����״̬</span><br><span class="line">                    pdx-&gt;pm_state.d0d3_state = StorPowerDeviceD3;</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">            </span><br><span class="line">        case ScsiAdapterPoFxPowerRequired:</span><br><span class="line">            // ���Ƕ�StorPortPoFxActivateComponent���õ���Ӧ</span><br><span class="line">            if (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD0) &#123;</span><br><span class="line">                // 1. ������Դ�ָ�</span><br><span class="line">                if (!host_power_on(&amp;pdx-&gt;host)) &#123;</span><br><span class="line">                    status = ScsiAdapterControlFailure;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                // 2. �ȴ�Ӳ���ȶ�</span><br><span class="line">                StorPortStallExecution(pdx-&gt;cfg-&gt;power_stable_time_us);</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case ScsiAdapterPoFxPowerActive:</span><br><span class="line">            // StorPortPoFxActivateComponent��ɺ��֪ͨ</span><br><span class="line">            if (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD0) &#123;</span><br><span class="line">                // 1. �ָ������豸״̬</span><br><span class="line">                RestoreDeviceState(pdx);</span><br><span class="line">                </span><br><span class="line">                // 2. �����ж�</span><br><span class="line">                StorPortEnableInterrupts(DeviceExtension);</span><br><span class="line">                </span><br><span class="line">                // 3. ����֮ǰ�ӳٵ�����</span><br><span class="line">                ProcessDeferredSrbs(pdx);</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>������Ҫ�����豸�ĵط�Ҳ��Ҫ��ȡ Active ���ã�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN HwResetBus(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ ULONG PathId</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    BOOLEAN result = FALSE;</span><br><span class="line">    </span><br><span class="line">    // 1. ��ȡActive����</span><br><span class="line">    if (Adapter_PoFx_Enabled(pdx)) &#123;</span><br><span class="line">        ULONG status = StorPortPoFxActivateComponent(pdx, NULL, NULL, 0, 0);</span><br><span class="line">        if (status != STOR_STATUS_SUCCESS &amp;&amp; status != STOR_STATUS_BUSY) &#123;</span><br><span class="line">            return FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 2. ִ����������</span><br><span class="line">    result = ResetBusOperation(pdx);</span><br><span class="line">    </span><br><span class="line">    // 3. �ͷ�Active����</span><br><span class="line">    if (Adapter_PoFx_Enabled(pdx)) &#123;</span><br><span class="line">        StorPortPoFxIdleComponent(pdx, NULL, NULL, 0, 0);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ���˵����</p>
<ol>
<li>StorPortPoFxActivateComponent&#x2F;IdleComponent��</li>
</ol>
<ul>
<li>����Ҫ�����豸ǰ���� Activate</li>
<li>������豸���ʺ���� Idle</li>
<li>���� STOR_STATUS_BUSY ״̬</li>
</ul>
<ol start="2">
<li>D-State ת����</li>
</ol>
<ul>
<li>D3 ����ʱ����״̬��ֹͣ���л</li>
<li>D0 �ָ�ʱֻ��������ʼ��</li>
<li>�ȴ� PoFx �ص�����豸�ָ�</li>
</ul>
<ol start="3">
<li>PoFx �ص���</li>
</ol>
<ul>
<li>PowerRequired��ִ�л�����Դ�ָ�</li>
<li>PowerActive����������豸��ʼ��</li>
</ul>
<ol start="4">
<li>״̬ͬ����</li>
</ol>
<ul>
<li>ά����ȷ�� D-State ״̬</li>
<li>�����ӳٵ� I&#x2F;O ����</li>
<li>ȷ���жϿ�����ȷ</li>
</ul>
<p>������ʵ�ֿ���ȷ����</p>
<ol>
<li>��ȷ�������е�Դ״̬ת��</li>
<li>�����ڴ����״̬�����豸</li>
<li>�ṩ�ɿ��ĵ�Դ��������</li>
<li>���� Storport �淶Ҫ��</li>
</ol>
<h2 id="User-8"><a href="#User-8" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>����ϸ����һ�����µ�Դ���õĹ��̣�1.StorPortPoFxActivateComponent��StorPortPoFxIdleComponent��2.ScsiAdapterControl �е� PoFx �ص���3.ScsiAdapterControl �е�ScsiAdapterPower D0&#x2F;D3����</p>
<h2 id="AI-claude-3-5-sonnet-8"><a href="#AI-claude-3-5-sonnet-8" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>������ϸ˵����Щ��Դ�������õ����̣�</p>
<ol>
<li>StorPortPoFxActivateComponent&#x2F;IdleComponent �ĵ������̣�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant IO as I/O Request</span><br><span class="line">    participant Miniport as Miniport Driver</span><br><span class="line">    participant Storport as Storport Driver</span><br><span class="line">    participant PoFx as Power Framework</span><br><span class="line">    participant Hardware as Hardware</span><br><span class="line"></span><br><span class="line">    IO-&gt;&gt;Miniport: HwStartIo</span><br><span class="line">    Miniport-&gt;&gt;Storport: StorPortPoFxActivateComponent</span><br><span class="line">    Storport-&gt;&gt;PoFx: Request Active</span><br><span class="line">    PoFx--&gt;&gt;Miniport: ScsiAdapterPoFxPowerRequired</span><br><span class="line">    Miniport--&gt;&gt;PoFx: Return Success</span><br><span class="line">    PoFx--&gt;&gt;Miniport: ScsiAdapterPoFxPowerActive</span><br><span class="line">    Miniport--&gt;&gt;Storport: Return Success</span><br><span class="line">    Miniport-&gt;&gt;Hardware: Process I/O</span><br><span class="line">    Miniport-&gt;&gt;Storport: StorPortPoFxIdleComponent</span><br><span class="line">    Storport-&gt;&gt;PoFx: Request Idle</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ScsiAdapterControl �е� PoFx �ص����̣�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant PoFx as Power Framework</span><br><span class="line">    participant Storport as Storport Driver</span><br><span class="line">    participant Miniport as Miniport Driver</span><br><span class="line">    participant Hardware as Hardware</span><br><span class="line"></span><br><span class="line">    Note over PoFx,Hardware: Active Flow</span><br><span class="line">    PoFx-&gt;&gt;Storport: Request Power Up</span><br><span class="line">    Storport-&gt;&gt;Miniport: ScsiAdapterPoFxPowerRequired</span><br><span class="line">    Miniport-&gt;&gt;Hardware: Basic Power Restore</span><br><span class="line">    Note right of Miniport: Only essential power</span><br><span class="line">    Miniport--&gt;&gt;Storport: Return Success</span><br><span class="line">    Storport--&gt;&gt;PoFx: Acknowledge</span><br><span class="line">    PoFx-&gt;&gt;Storport: Power Up Complete</span><br><span class="line">    Storport-&gt;&gt;Miniport: ScsiAdapterPoFxPowerActive</span><br><span class="line">    Miniport-&gt;&gt;Hardware: Full Device Init</span><br><span class="line">    Note right of Miniport: Complete initialization</span><br><span class="line">    Miniport--&gt;&gt;Storport: Return Success</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ScsiAdapterPower D0&#x2F;D3 �������̣�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant PnP as PnP Manager</span><br><span class="line">    participant Storport as Storport Driver</span><br><span class="line">    participant Miniport as Miniport Driver</span><br><span class="line">    participant Hardware as Hardware</span><br><span class="line"></span><br><span class="line">    Note over PnP,Hardware: D0 Flow</span><br><span class="line">    PnP-&gt;&gt;Storport: IRP_MJ_POWER (D0)</span><br><span class="line">    Storport-&gt;&gt;Miniport: ScsiAdapterControl(PowerState:D0)</span><br><span class="line">    Miniport-&gt;&gt;Hardware: Basic D0 Init</span><br><span class="line">    Note right of Miniport: No PoFx calls here</span><br><span class="line">    Miniport--&gt;&gt;Storport: Return Success</span><br><span class="line">    Note over PnP,Hardware: PoFx Flow Follows</span><br><span class="line">    </span><br><span class="line">    Note over PnP,Hardware: D3 Flow</span><br><span class="line">    PnP-&gt;&gt;Storport: IRP_MJ_POWER (D3)</span><br><span class="line">    Storport-&gt;&gt;Miniport: ScsiAdapterControl(PowerState:D3)</span><br><span class="line">    Miniport-&gt;&gt;Hardware: Prepare for D3</span><br><span class="line">    Note right of Miniport: Save state &amp; power down</span><br><span class="line">    Miniport--&gt;&gt;Storport: Return Success</span><br></pre></td></tr></table></figure>

<p>�ؼ�ʱ��˵����</p>
<ol>
<li>Active&#x2F;Idle ���ã�</li>
</ol>
<ul>
<li>Miniport ����Ҫ����Ӳ��ʱ���� StorPortPoFxActivateComponent</li>
<li>���ú�ᴥ�� PowerRequired �� PowerActive �ص�</li>
<li>���Ӳ�����ʺ���� StorPortPoFxIdleComponent</li>
</ul>
<ol start="2">
<li>PoFx �ص���</li>
</ol>
<ul>
<li>PowerRequired����һ�׶Σ�ֻ�ָ�������Դ</li>
<li>PowerActive���ڶ��׶Σ����������ʼ��</li>
<li>�������ص��� Active ���õĽ��</li>
</ul>
<ol start="3">
<li>D-State ת����</li>
</ol>
<ul>
<li>D0&#x2F;D3 ��ϵͳ��Դ������һ����</li>
<li>�� PoFx �Ƕ���������</li>
<li>D0 �ָ��������Ҫ�����豸������Ҫ PoFx Active ����</li>
</ul>
<p>ʾ�������еĹؼ�ʱ��</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. ����Ҫ�����豸ʱ</span></span><br><span class="line">ULONG status = StorPortPoFxActivateComponent(pdx, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (status == STOR_STATUS_BUSY) &#123;</span><br><span class="line">    <span class="comment">// �豸���ڻָ����ȴ� PowerActive �ص�</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. PoFx �ص�����</span></span><br><span class="line"><span class="keyword">case</span> ScsiAdapterPoFxPowerRequired:</span><br><span class="line">    <span class="comment">// ������Դ�ָ�</span></span><br><span class="line">    host_power_on(&amp;pdx-&gt;host);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> ScsiAdapterPoFxPowerActive:</span><br><span class="line">    <span class="comment">// ������ʼ��</span></span><br><span class="line">    RestoreDeviceState(pdx);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. D-State ����</span></span><br><span class="line"><span class="keyword">case</span> ScsiAdapterPowerState:</span><br><span class="line">    <span class="keyword">switch</span>(Power-&gt;PowerState) &#123;</span><br><span class="line">        <span class="keyword">case</span> StorPowerDeviceD0:</span><br><span class="line">            <span class="comment">// ���� D0 ��ʼ��</span></span><br><span class="line">            <span class="comment">// ������ PoFx ����</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> StorPowerDeviceD3:</span><br><span class="line">            <span class="comment">// ׼������ D3</span></span><br><span class="line">            SaveDeviceState(pdx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ע�����</p>
<ol>
<li>״̬ͬ����</li>
</ol>
<ul>
<li>ά����ȷ�� D-State �� PoFx ״̬</li>
<li>����״̬��ͻ</li>
</ul>
<ol start="2">
<li>����ʱ����</li>
</ol>
<ul>
<li>D-State ת��ʱ������ PoFx ����</li>
<li>PoFx �ص��в����� PoFx ����</li>
</ul>
<ol start="3">
<li>��������</li>
</ol>
<ul>
<li>�������п��ܵ�״̬ת��ʧ��</li>
<li>ʵ����ȷ����������</li>
</ul>
<p>������ʵ��ȷ���˵�Դ��������ȷ�ԺͿɿ��ԡ�</p>
<h2 id="User-9"><a href="#User-9" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>Storport miniport driver���ʵ��DFx(Direct Pofx), ��SD Host driver���֧��SD card��DFx����(pwrtest), ��ο� @Web Storport�ĵ���DFx�ĵ�</p>
<h2 id="AI-claude-3-5-sonnet-9"><a href="#AI-claude-3-5-sonnet-9" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>���� <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/storage/storport-direct-pofx">Storport DFx �ĵ�</a> �� <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/power-framework-direct-i-o">Power Framework Direct I&#x2F;O</a>, SD Host miniport driver ��Ҫ:</p>
<ol>
<li>������ HwFindAdapter �г�ʼ�� DFx:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">ULONG </span><br><span class="line">HwFindAdapter(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ PVOID HwContext,</span><br><span class="line">    _In_ PVOID BusInformation,</span><br><span class="line">    _In_ PCHAR ArgumentString,</span><br><span class="line">    _Inout_ PPORT_CONFIGURATION_INFORMATION ConfigInfo,</span><br><span class="line">    _Out_ PBOOLEAN Again</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line"></span><br><span class="line">    // 1. ��ʼ�� DFx ����</span><br><span class="line">    STOR_DFX_SETTINGS DfxSettings = &#123;0&#125;;</span><br><span class="line">    DfxSettings.Version = STOR_DFX_SETTINGS_VERSION_V1;</span><br><span class="line">    DfxSettings.Size = sizeof(STOR_DFX_SETTINGS);</span><br><span class="line"></span><br><span class="line">    // 2. ���� Unit ����� DFx</span><br><span class="line">    DfxSettings.UnitDfxSettings.Version = STOR_UNIT_DFX_SETTINGS_VERSION_V1;</span><br><span class="line">    DfxSettings.UnitDfxSettings.Size = sizeof(STOR_UNIT_DFX_SETTINGS);</span><br><span class="line">    </span><br><span class="line">    // 3. ���� F-state ����������</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStateCount = 2; // F0 �� F1</span><br><span class="line">    DfxSettings.UnitDfxSettings.DeepestWakeableFState = 0;</span><br><span class="line">    </span><br><span class="line">    // 4. ���� F-states</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[0].Version = </span><br><span class="line">        STOR_UNIT_DFX_F_STATE_VERSION_V1;</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[0].Size = </span><br><span class="line">        sizeof(STOR_UNIT_DFX_F_STATE);</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[0].TransitionLatency = 0;</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[0].ResidencyRequirement = 0;</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[0].NominalPower = </span><br><span class="line">        STOR_POFX_UNKNOWN_POWER;</span><br><span class="line"></span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[1].Version = </span><br><span class="line">        STOR_UNIT_DFX_F_STATE_VERSION_V1;</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[1].Size = </span><br><span class="line">        sizeof(STOR_UNIT_DFX_F_STATE);</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[1].TransitionLatency = 1000; // 1ms</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[1].ResidencyRequirement = 2000; // 2ms</span><br><span class="line">    DfxSettings.UnitDfxSettings.FStates[1].NominalPower = </span><br><span class="line">        STOR_POFX_UNKNOWN_POWER;</span><br><span class="line"></span><br><span class="line">    // 5. ��ʼ�� DFx</span><br><span class="line">    status = StorPortInitializeDfx(DeviceExtension, &amp;DfxSettings);</span><br><span class="line">    if (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        return SP_RETURN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return SP_RETURN_FOUND;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ʵ�� Unit ����� DFx �ص�:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">SCSI_ADAPTER_CONTROL_STATUS </span><br><span class="line">HwAdapterControl(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ SCSI_ADAPTER_CONTROL_TYPE ControlType,</span><br><span class="line">    _In_ PVOID Parameters</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    switch(ControlType) &#123;</span><br><span class="line">        case ScsiUnitPoFxPowerRequired: &#123;</span><br><span class="line">            PSCSI_UNIT_POFX_POWER_REQUIRED Params = </span><br><span class="line">                (PSCSI_UNIT_POFX_POWER_REQUIRED)Parameters;</span><br><span class="line">            </span><br><span class="line">            // ���� Unit �ĵ�Դ�ָ�����</span><br><span class="line">            if (!card_power_on(&amp;pdx-&gt;card)) &#123;</span><br><span class="line">                return ScsiAdapterControlFailure;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // �ȴ����ȶ�</span><br><span class="line">            StorPortStallExecution(pdx-&gt;cfg-&gt;card_power_stable_time_us);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        case ScsiUnitPoFxPowerActive: &#123;</span><br><span class="line">            PSCSI_UNIT_POFX_POWER_ACTIVE Params = </span><br><span class="line">                (PSCSI_UNIT_POFX_POWER_ACTIVE)Parameters;</span><br><span class="line">            </span><br><span class="line">            // ��ɿ��ĳ�ʼ��</span><br><span class="line">            if (!card_init(&amp;pdx-&gt;card)) &#123;</span><br><span class="line">                return ScsiAdapterControlFailure;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        case ScsiUnitPoFxPowerSetFState: &#123;</span><br><span class="line">            PSCSI_UNIT_POFX_SET_F_STATE Params = </span><br><span class="line">                (PSCSI_UNIT_POFX_SET_F_STATE)Parameters;</span><br><span class="line">            </span><br><span class="line">            // ���� F-state �л�</span><br><span class="line">            switch(Params-&gt;FState) &#123;</span><br><span class="line">                case 0: // F0</span><br><span class="line">                    if (!card_set_active_state(&amp;pdx-&gt;card)) &#123;</span><br><span class="line">                        return ScsiAdapterControlFailure;</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                case 1: // F1</span><br><span class="line">                    if (!card_set_low_power_state(&amp;pdx-&gt;card)) &#123;</span><br><span class="line">                        return ScsiAdapterControlFailure;</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return ScsiAdapterControlSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>�� I&#x2F;O ·����ʹ�� DFx API:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN </span><br><span class="line">HwStartIo(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ PSCSI_REQUEST_BLOCK Srb</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    ULONG status;</span><br><span class="line">    </span><br><span class="line">    // 1. ��ȡ Unit �� Active ����</span><br><span class="line">    status = StorPortUnitPoFxActivateComponent(</span><br><span class="line">        DeviceExtension,</span><br><span class="line">        Srb-&gt;PathId,</span><br><span class="line">        Srb-&gt;TargetId,</span><br><span class="line">        Srb-&gt;Lun,</span><br><span class="line">        NULL,</span><br><span class="line">        NULL,</span><br><span class="line">        0,</span><br><span class="line">        0</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    if (status == STOR_STATUS_BUSY) &#123;</span><br><span class="line">        // Unit ���ڻָ����ӳٴ���</span><br><span class="line">        QueueDeferredSrb(pdx, Srb);</span><br><span class="line">        return TRUE;</span><br><span class="line">    &#125; else if (status != STOR_STATUS_SUCCESS) &#123;</span><br><span class="line">        StorPortCompleteRequest(DeviceExtension, </span><br><span class="line">                              Srb-&gt;PathId,</span><br><span class="line">                              Srb-&gt;TargetId,</span><br><span class="line">                              Srb-&gt;Lun,</span><br><span class="line">                              SRB_STATUS_ERROR);</span><br><span class="line">        return TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 2. ���� I/O</span><br><span class="line">    BOOLEAN result = ProcessSrbRequest(pdx, Srb);</span><br><span class="line">    </span><br><span class="line">    // 3. �ͷ� Unit ����</span><br><span class="line">    StorPortUnitPoFxIdleComponent(</span><br><span class="line">        DeviceExtension,</span><br><span class="line">        Srb-&gt;PathId,</span><br><span class="line">        Srb-&gt;TargetId,</span><br><span class="line">        Srb-&gt;Lun,</span><br><span class="line">        NULL,</span><br><span class="line">        NULL,</span><br><span class="line">        0,</span><br><span class="line">        0</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>ʵ�� idle timeout ֧��:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// �� HwFindAdapter ������</span><br><span class="line">pdx-&gt;os.UnitPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_IDLE_TIMEOUT;</span><br><span class="line">pdx-&gt;os.UnitPoFxDevice.UnitIdleTimeoutInMS = </span><br><span class="line">    pdx-&gt;cfg-&gt;feature_item.card_idle_timeout_ms;</span><br></pre></td></tr></table></figure>

<p>�ؼ���˵��:</p>
<ol>
<li>DFx ��ʼ��:</li>
</ol>
<ul>
<li>���� F-states ��������</li>
<li>������ȷ���ӳٺ�פ��ʱ��</li>
<li>���� idle timeout ����</li>
</ul>
<ol start="2">
<li>Unit ����ص�:</li>
</ol>
<ul>
<li>PowerRequired: ������Դ�ָ�</li>
<li>PowerActive: ������ʼ��</li>
<li>SetFState: F-state �л�</li>
</ul>
<ol start="3">
<li>������:</li>
</ol>
<ul>
<li>���лص�����Ҫ������ȷ��״̬</li>
<li>ʵ�ֳ�ʱ�����Ի���</li>
<li>��ȷ������Դ</li>
</ul>
<ol start="4">
<li>pwrtest ֧��:</li>
</ol>
<ul>
<li>ȷ����ȷ��Ӧ F-state �л�</li>
<li>ʵ�ֿɿ��� idle timeout</li>
<li>֧�ֵ�Դ״̬ͳ��</li>
</ul>
<p>������ʵ�ֿ���:</p>
<ol>
<li>֧�� SD ����ϸ���ȵ�Դ����</li>
<li>ͨ�� pwrtest ��֤</li>
<li>�ṩ�ɿ��ĵ�Դ��������</li>
</ol>
<h2 id="User-10"><a href="#User-10" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>�ղŵĽ��鲻����Storport�ĵ��������� @Web @<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-_stor_pofx_device_v3">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/storport/ns-storport-_stor_pofx_device_v3</a> Remarks<br>To register a storage adapter for Storport PoFx support, the miniport driver calls StorPortEnablePassiveInitialization in its HwStorInitialize routine and implements a HwStorPassiveInitializeRoutine. The miniport calls StorPortInitializePoFxPower within it’s HwStorPassiveInitializeRoutine to provide information about the adapter component.</p>
<p>To register a storage unit for Storport PoFx support, the miniport driver implements the HwStorUnitControl callback routine and provides handling of the ScsiUnitPoFxPowerInfo unit control code. When the handling the ScsiUnitPoFxPowerInfo control code, the miniport calls StorPortInitializePoFxPower if idle power management for the unit component is enabled.</p>
<p>The component for the storage device identified by its Components array index. Storage devices have only one component so the index of 0 is used. Routines such as StorPortPoFxActivateComponent and StorPortPoFxIdleComponent use the array index of a component to identify the component.</p>
<h2 id="AI-claude-3-5-sonnet-10"><a href="#AI-claude-3-5-sonnet-10" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>��˵�öԣ��Ҹ��� Storport �ĵ���������ʵ�ַ�����</p>
<ol>
<li>������ HwStorInitialize �����ñ�����ʼ����</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN </span><br><span class="line">HwStorInitialize(</span><br><span class="line">    _In_ PVOID DeviceExtension</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    // ���ñ�����ʼ��</span><br><span class="line">    return StorPortEnablePassiveInitialization(DeviceExtension);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>�� HwStorPassiveInitializeRoutine �г�ʼ���������� PoFx��</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN </span><br><span class="line">HwStorPassiveInitializeRoutine(</span><br><span class="line">    _In_ PVOID DeviceExtension</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    BOOLEAN enableD3Cold = FALSE;</span><br><span class="line">    ULONG status;</span><br><span class="line"></span><br><span class="line">    // ��ʼ�������� PoFx</span><br><span class="line">    STOR_POFX_DEVICE AdapterPoFxDevice = &#123;0&#125;;</span><br><span class="line">    AdapterPoFxDevice.Version = STOR_POFX_DEVICE_VERSION_V3;</span><br><span class="line">    AdapterPoFxDevice.Size = sizeof(STOR_POFX_DEVICE);</span><br><span class="line">    AdapterPoFxDevice.ComponentCount = 1;  // �洢�豸ֻ��һ�����</span><br><span class="line">    </span><br><span class="line">    // ������� 0</span><br><span class="line">    AdapterPoFxDevice.Components[0].Version = STOR_POFX_COMPONENT_VERSION_V1;</span><br><span class="line">    AdapterPoFxDevice.Components[0].Size = sizeof(STOR_POFX_COMPONENT);</span><br><span class="line">    AdapterPoFxDevice.Components[0].FStateCount = 2;</span><br><span class="line">    AdapterPoFxDevice.Components[0].DeepestWakeableFState = 0;</span><br><span class="line">    </span><br><span class="line">    // ���� idle timeout</span><br><span class="line">    AdapterPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_IDLE_TIMEOUT;</span><br><span class="line">    AdapterPoFxDevice.AdapterIdleTimeoutInMS = </span><br><span class="line">        pdx-&gt;cfg-&gt;feature_item.psd_mode.adapter_idle_time_s * 1000;</span><br><span class="line"></span><br><span class="line">    status = StorPortInitializePoFxPower(</span><br><span class="line">        DeviceExtension,</span><br><span class="line">        NULL,</span><br><span class="line">        &amp;AdapterPoFxDevice,</span><br><span class="line">        &amp;enableD3Cold</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    return (status == STOR_STATUS_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ʵ�� HwStorUnitControl ���� Unit ����� PoFx��</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN </span><br><span class="line">HwStorUnitControl(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ SCSI_UNIT_CONTROL_TYPE ControlType,</span><br><span class="line">    _In_ PVOID Parameters</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    </span><br><span class="line">    switch(ControlType) &#123;</span><br><span class="line">        case ScsiUnitPoFxPowerInfo: &#123;</span><br><span class="line">            PSCSI_UNIT_POFX_POWER_INFO PowerInfo = </span><br><span class="line">                (PSCSI_UNIT_POFX_POWER_INFO)Parameters;</span><br><span class="line">            BOOLEAN enableD3Cold = FALSE;</span><br><span class="line">            </span><br><span class="line">            // ����Ƿ���ҪΪ�� Unit ���� idle power management</span><br><span class="line">            if (IsUnitIdlePowerManagementEnabled(pdx, PowerInfo)) &#123;</span><br><span class="line">                STOR_POFX_DEVICE UnitPoFxDevice = &#123;0&#125;;</span><br><span class="line">                UnitPoFxDevice.Version = STOR_POFX_DEVICE_VERSION_V3;</span><br><span class="line">                UnitPoFxDevice.Size = sizeof(STOR_POFX_DEVICE);</span><br><span class="line">                UnitPoFxDevice.ComponentCount = 1;</span><br><span class="line">                </span><br><span class="line">                // ���� Unit ���</span><br><span class="line">                UnitPoFxDevice.Components[0].Version = STOR_POFX_COMPONENT_VERSION_V1;</span><br><span class="line">                UnitPoFxDevice.Components[0].Size = sizeof(STOR_POFX_COMPONENT);</span><br><span class="line">                UnitPoFxDevice.Components[0].FStateCount = 2;</span><br><span class="line">                UnitPoFxDevice.Components[0].DeepestWakeableFState = 0;</span><br><span class="line">                </span><br><span class="line">                // ���� Unit idle timeout</span><br><span class="line">                UnitPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_IDLE_TIMEOUT;</span><br><span class="line">                UnitPoFxDevice.UnitIdleTimeoutInMS = </span><br><span class="line">                    pdx-&gt;cfg-&gt;feature_item.card_idle_timeout_ms;</span><br><span class="line"></span><br><span class="line">                ULONG status = StorPortInitializePoFxPower(</span><br><span class="line">                    DeviceExtension,</span><br><span class="line">                    PowerInfo-&gt;UnitParameters,  // Unit ����</span><br><span class="line">                    &amp;UnitPoFxDevice,</span><br><span class="line">                    &amp;enableD3Cold</span><br><span class="line">                );</span><br><span class="line">                </span><br><span class="line">                return (status == STOR_STATUS_SUCCESS);</span><br><span class="line">            &#125;</span><br><span class="line">            return TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>����Ҫ�����豸ʱʹ�� PoFx API��</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN </span><br><span class="line">HwStartIo(</span><br><span class="line">    _In_ PVOID DeviceExtension,</span><br><span class="line">    _In_ PSCSI_REQUEST_BLOCK Srb</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line">    ULONG status;</span><br><span class="line">    </span><br><span class="line">    // ��ȡ����������� Active ���� (������� 0)</span><br><span class="line">    status = StorPortPoFxActivateComponent(</span><br><span class="line">        DeviceExtension,</span><br><span class="line">        NULL,</span><br><span class="line">        NULL,</span><br><span class="line">        0,  // ������� 0</span><br><span class="line">        0</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    if (status == STOR_STATUS_BUSY) &#123;</span><br><span class="line">        // �豸���ڻָ�</span><br><span class="line">        return FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // ���� I/O</span><br><span class="line">    BOOLEAN result = ProcessSrbRequest(pdx, Srb);</span><br><span class="line">    </span><br><span class="line">    // �ͷ��������������</span><br><span class="line">    StorPortPoFxIdleComponent(</span><br><span class="line">        DeviceExtension,</span><br><span class="line">        NULL,</span><br><span class="line">        NULL,</span><br><span class="line">        0,  // ������� 0</span><br><span class="line">        0</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ�������</p>
<ol>
<li>��ʼ�����̣�</li>
</ol>
<ul>
<li>ʹ�� HwStorInitialize �� HwStorPassiveInitializeRoutine</li>
<li>����ȷ�Ļص��г�ʼ�� PoFx</li>
</ul>
<ol start="2">
<li>Unit ֧�֣�</li>
</ol>
<ul>
<li>ͨ�� HwStorUnitControl �� ScsiUnitPoFxPowerInfo ʵ��</li>
<li>Ϊÿ�� Unit �������� PoFx</li>
</ul>
<ol start="3">
<li>���������</li>
</ol>
<ul>
<li>�洢�豸ֻʹ��һ����������� 0��</li>
<li>���� PoFx API ����ʹ��������� 0</li>
</ul>
<p>������ʵ�ָ����� Storport �淶Ҫ��</p>
<h2 id="User-11"><a href="#User-11" class="headerlink" title="User:"></a>User:</h2><p>[selections]  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HW_PASSIVE_INITIALIZE_ROUTINE	StorHwPassiveInitialize;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scsi_HwUnitControl</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>[text]<br>���鵱ǰ���� @Codebase   @StorHwPassiveInitialize  @@scsi_HwUnitControl(PVOID, SCSI_UNIT_CONTROL_TYPE, PVOID) ����Ϊ�Ѿ����Ϲ淶</p>
<h2 id="AI-claude-3-5-sonnet-11"><a href="#AI-claude-3-5-sonnet-11" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>�����������Ϊ��ǰʵ�ֻ������� Storport �淶�����м�����Ҫע������ƣ�</p>
<ol>
<li>StorHwPassiveInitialize ʵ�ֻ�����ȷ��</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN</span><br><span class="line"></span><br><span class="line">StorHwPassiveInitialize(IN PVOID DeviceExtension)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_OS_ENTRY, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;Enter %s\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    UCHAR i;</span><br><span class="line"></span><br><span class="line">    ULONG status = STOR_STATUS_SUCCESS;</span><br><span class="line"></span><br><span class="line">    BOOLEAN enableD3Cold = FALSE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    bht_dev_ext_t *pdx = (bht_dev_ext_t *)DeviceExtension;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    req_global_init(pdx); //todo failed then FindAdapter failed</span><br><span class="line"></span><br><span class="line">    DevMapAdd(pdx); // call this to add pdx to Map   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // Registry RTD3 en controls POfx register process.</span><br><span class="line"></span><br><span class="line">    if (pdx-&gt;pm_state.rtd3_en != TRUE)</span><br><span class="line"></span><br><span class="line">        goto Exit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //</span><br><span class="line"></span><br><span class="line">    // Get and cache D3Cold support.  </span><br><span class="line"></span><br><span class="line">    //</span><br><span class="line"></span><br><span class="line">     status = StorPortGetD3ColdSupport(DeviceExtension, NULL, &amp;enableD3Cold);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     if (status == STOR_STATUS_SUCCESS) &#123;</span><br><span class="line"></span><br><span class="line">         DbgInfo(MODULE_OS_ENTRY, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;d3Coldsupported %0x\n&quot;, enableD3Cold);</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    os_memset((PCHAR)(&amp;(pdx-&gt;os.AdptPoFxDevice)), 0, sizeof(STOR_POFX_DEVICE_V2));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Version = STOR_POFX_DEVICE_VERSION_V2;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Size = STOR_POFX_DEVICE_V2_SIZE;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.ComponentCount = 1;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // indicate dump miniport can&#x27;t bring adapter to active</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_NO_DUMP_ACTIVE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].Version = STOR_POFX_COMPONENT_VERSION_V1;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].Size = STOR_POFX_COMPONENT_SIZE;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].FStateCount = 1;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].DeepestWakeableFState = 0;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].Id = STORPORT_POFX_ADAPTER_GUID;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].Version = STOR_POFX_COMPONENT_IDLE_STATE_VERSION_V1;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].Size = STOR_POFX_COMPONENT_IDLE_STATE_SIZE;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].TransitionLatency = 0;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].ResidencyRequirement = 0;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Components[0].FStates[0].NominalPower = STOR_POFX_UNKNOWN_POWER;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // registry runtime power management for Adapter</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_IDLE_TIMEOUT;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.Flags |= STOR_POFX_DEVICE_FLAG_ADAPTER_D3_WAKE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //pdx-&gt;os.AdptPoFxDevice.AdapterIdleTimeoutInMS = 1000; //10ms Idle tiemout for D3.</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.AdptPoFxDevice.AdapterIdleTimeoutInMS = pdx-&gt;cfg-&gt;feature_item.psd_mode.adapter_idle_time_s * 1000; //The unit is 1ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    status = StorPortInitializePoFxPower(DeviceExtension, NULL, (PSTOR_POFX_DEVICE)(&amp;(pdx-&gt;os.AdptPoFxDevice)), &amp;enableD3Cold);</span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_OS_ENTRY, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;%s StorPortInitializePoFxPower=%x,enableD3Cold=%x\n&quot;,</span><br><span class="line"></span><br><span class="line">            __TIME__, status, enableD3Cold);</span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_OS_ENTRY, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;pdx-&gt;os.AdptPoFxDevice.AdapterIdleTimeoutInMS =%d ,pdx-&gt;os.AdptPoFxDevice.Flags=%x , STOR_STATUS_SUCCESS=%x\n&quot;,</span><br><span class="line"></span><br><span class="line">            pdx-&gt;os.AdptPoFxDevice.AdapterIdleTimeoutInMS, pdx-&gt;os.AdptPoFxDevice.Flags, STOR_STATUS_SUCCESS);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if(status != STOR_STATUS_SUCCESS)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        pdx-&gt;os.StateFlags.PoFxEnabled = FALSE;</span><br><span class="line"></span><br><span class="line">        pdx-&gt;os.StateFlags.PoFxActive = FALSE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        goto Exit;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // register success</span><br><span class="line"></span><br><span class="line">    // win_rtd3_req_wait_wake(pdx);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.StateFlags.PoFxEnabled = TRUE;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;os.StateFlags.PoFxActive = TRUE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exit:</span><br><span class="line"></span><br><span class="line">    //create work thread at end of stor-initialization entry.</span><br><span class="line"></span><br><span class="line">    os_create_thread(pdx, &amp;pdx-&gt;os.thread[0], pdx, thread_main);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_OS_ENTRY, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;Exit %s\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line">    return TRUE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>��Ҫ������</p>
<ul>
<li>��ȷ��ʼ�� STOR_POFX_DEVICE_V2 �ṹ</li>
<li>��������ȷ�� Version �� ComponentCount</li>
<li>������ IDLE_TIMEOUT ��־</li>
<li>���� StorPortInitializePoFxPower</li>
</ul>
<ol start="2">
<li>���� HwAdapterControl �е� PoFx ������������</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">case ScsiAdapterPoFxPowerControl:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    break;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>��Ҫ���� ScsiAdapterPoFxPowerControl �Ĵ�����</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> ScsiAdapterPoFxPowerControl:</span><br><span class="line">&#123;</span><br><span class="line">    PSCSI_PO_FX_POWER_CONTROL poFxControl = </span><br><span class="line">        (PSCSI_PO_FX_POWER_CONTROL)Parameters;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">switch</span>(poFxControl-&gt;PowerControlCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> ScsiPoFxPowerControlComponentActive:</span><br><span class="line">            <span class="comment">// ����豸��ʼ��</span></span><br><span class="line">            <span class="keyword">if</span> (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD0) &#123;</span><br><span class="line">                pcr_part_a_restore(pdx);</span><br><span class="line">                pcr_part_b_restore(pdx);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> ScsiPoFxPowerControlComponentIdle:</span><br><span class="line">            <span class="comment">// ׼������͹���״̬</span></span><br><span class="line">            pcr_part_a_backup(pdx);</span><br><span class="line">            pcr_part_b_backup(pdx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Unit ����� PoFx ֧���Ѿ�ʵ�֣�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">    if(sd_bus_PoFxEnabled(sdbusport_ext))</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        ULONG status;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        status = StorPortPoFxActivateComponent((bht_dev_ext_t *)(sdbusport_ext-&gt;AdapterExtension),</span><br><span class="line"></span><br><span class="line">                                               (PSTOR_ADDRESS)&amp;sdbusport_ext-&gt;DeviceExtension[0].DeviceAddress,</span><br><span class="line"></span><br><span class="line">                                               (PSCSI_REQUEST_BLOCK)Srb,</span><br><span class="line"></span><br><span class="line">                                               0,</span><br><span class="line"></span><br><span class="line">                                               0);</span><br><span class="line"></span><br><span class="line">        // STOR_STATUS_BUSY indicates that ActivateComponent is not completed yet.</span><br><span class="line"></span><br><span class="line">        idle = (status == STOR_STATUS_BUSY);</span><br><span class="line"></span><br><span class="line">        DbgInfo(MODULE_OS_ENTRYAPI, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;rtget---StorPortPoFxActivateComponent =%x\n&quot;, status);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if((status == STOR_STATUS_SUCCESS) || (status == STOR_STATUS_BUSY))</span><br><span class="line"></span><br><span class="line">            referenceAcquired = TRUE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    else</span><br><span class="line"></span><br><span class="line">        UNREFERENCED_PARAMETER(Srb);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if(InIdle != NULL)</span><br><span class="line"></span><br><span class="line">        *InIdle = idle;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    return referenceAcquired;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>������</p>
<ul>
<li>��ȷʹ�� StorPortPoFxActivateComponent</li>
<li>���� STOR_STATUS_BUSY ״̬</li>
<li>ʵ�������ü�������</li>
</ul>
<p>����Ľ���</p>
<ol>
<li>�� StorHwPassiveInitialize �����Ӵ�������</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (status != STOR_STATUS_SUCCESS) &#123;</span><br><span class="line">    DbgErr(<span class="string">&quot;StorPortInitializePoFxPower failed: %x\n&quot;</span>, status);</span><br><span class="line">    <span class="keyword">return</span> FALSE;  <span class="comment">// ���� FALSE ��ʾ��ʼ��ʧ��</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>���ƼĴ������ʵ�״̬��飺</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">if (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD0) &#123;</span><br><span class="line"></span><br><span class="line">    pci_writel(&amp;pdx-&gt;host, 0xdc, pdx-&gt;pm_state.reg_0xdc);</span><br><span class="line"></span><br><span class="line">    pci_writel(&amp;pdx-&gt;host, 0x3e0, pdx-&gt;pm_state.reg_0x3e0);</span><br><span class="line"></span><br><span class="line">    pci_writel(&amp;pdx-&gt;host, 0x3e8, pdx-&gt;pm_state.reg_0x3e8);</span><br><span class="line"></span><br><span class="line">    pci_writel(&amp;pdx-&gt;host, 0x3ec, pdx-&gt;pm_state.reg_0x3ec);</span><br><span class="line"></span><br><span class="line">    pci_writel(&amp;pdx-&gt;host, 0xf4, pdx-&gt;pm_state.reg_0xf4);</span><br><span class="line"></span><br><span class="line">    pci_writel(&amp;pdx-&gt;host, 0x74, pdx-&gt;pm_state.reg_0x74);</span><br><span class="line"></span><br><span class="line">    pci_writel(&amp;pdx-&gt;host, 0xf0, pdx-&gt;pm_state.reg_0xf0);</span><br><span class="line"></span><br><span class="line">    pci_writel(&amp;pdx-&gt;host, 0x90, pdx-&gt;pm_state.reg_0x90);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">else &#123; //D3</span><br><span class="line"></span><br><span class="line">    pci_cfgio_writel(&amp;pdx-&gt;host, 0xdc, pdx-&gt;pm_state.reg_0xdc);</span><br></pre></td></tr></table></figure>


<p>�ⲿ�ִ����Ѿ���ȷ������ D0&#x2F;D3 ״̬�µļĴ������ʲ��졣</p>
<p>������˵����ǰʵ�ַ��� Storport �淶��ֻ��Ҫ���� ScsiAdapterPoFxPowerControl �Ĵ������ɡ�</p>
<h2 id="User-12"><a href="#User-12" class="headerlink" title="User:"></a>User:</h2><p>[text]<br>ScsiAdapterPoFxPowerControl�Ĺ�����ʲô���������, ��ο� @Codebase @Web </p>
<h2 id="AI-claude-3-5-sonnet-12"><a href="#AI-claude-3-5-sonnet-12" class="headerlink" title="AI (claude-3.5-sonnet):"></a>AI (claude-3.5-sonnet):</h2><p>���� <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/storage/storport-pofx">Storport PoFx �ĵ�</a> �ʹ���⣬ScsiAdapterPoFxPowerControl �� PoFx �������֪ͨ miniport �������״̬�仯�Ļص���</p>
<p>��Ҫ�� scsi_HwAdapterControl �����ƴ˴�����</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">case ScsiAdapterPoFxPowerControl:</span><br><span class="line">&#123;</span><br><span class="line">    PSCSI_PO_FX_POWER_CONTROL poFxControl = </span><br><span class="line">        (PSCSI_PO_FX_POWER_CONTROL)Parameters;</span><br><span class="line">    </span><br><span class="line">    switch(poFxControl-&gt;PowerControlCode) &#123;</span><br><span class="line">        case ScsiPoFxPowerControlComponentIdle:</span><br><span class="line">            // ����������״̬</span><br><span class="line">            if (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD0) &#123;</span><br><span class="line">                // ����Ĵ���״̬���ο����д���:</span><br><span class="line">                // SDSTORDriver/sdstor/main/pmfunc.c startLine: 290 endLine: 306</span><br><span class="line">                req_pre_enter_d3(pdx);</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case ScsiPoFxPowerControlComponentActive:</span><br><span class="line">            // ����ָ��״̬</span><br><span class="line">            if (pdx-&gt;pm_state.d0d3_state == StorPowerDeviceD0) &#123;</span><br><span class="line">                // �ָ��豸״̬</span><br><span class="line">                req_exit_d3(pdx);</span><br><span class="line">                </span><br><span class="line">                // �����ӳٵ�����</span><br><span class="line">                ProcessDeferredRequests(pdx);</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case ScsiPoFxPowerControlComponentIdleState:</span><br><span class="line">            // F-state �ı�֪ͨ</span><br><span class="line">            ULONG newFState = poFxControl-&gt;PowerParameters.FState;</span><br><span class="line">            if (newFState == 0) &#123;</span><br><span class="line">                // F0 ״̬ - ��ȫ����</span><br><span class="line">                pdx-&gt;pm_state.current_fstate = 0;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // F1 �����ĵ͹���״̬</span><br><span class="line">                pdx-&gt;pm_state.current_fstate = newFState;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>�ؼ��㣺</p>
<ol>
<li>�˻ص��� StorPortPoFxActivateComponent&#x2F;IdleComponent ��ϣ�</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">    if(sd_bus_PoFxEnabled(sdbusport_ext))</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        ULONG status;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        status = StorPortPoFxActivateComponent((bht_dev_ext_t *)(sdbusport_ext-&gt;AdapterExtension),</span><br><span class="line"></span><br><span class="line">                                               (PSTOR_ADDRESS)&amp;sdbusport_ext-&gt;DeviceExtension[0].DeviceAddress,</span><br><span class="line"></span><br><span class="line">                                               (PSCSI_REQUEST_BLOCK)Srb,</span><br><span class="line"></span><br><span class="line">                                               0,</span><br><span class="line"></span><br><span class="line">                                               0);</span><br><span class="line"></span><br><span class="line">        // STOR_STATUS_BUSY indicates that ActivateComponent is not completed yet.</span><br><span class="line"></span><br><span class="line">        idle = (status == STOR_STATUS_BUSY);</span><br><span class="line"></span><br><span class="line">        DbgInfo(MODULE_OS_ENTRYAPI, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;rtget---StorPortPoFxActivateComponent =%x\n&quot;, status);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if((status == STOR_STATUS_SUCCESS) || (status == STOR_STATUS_BUSY))</span><br><span class="line"></span><br><span class="line">            referenceAcquired = TRUE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    else</span><br><span class="line"></span><br><span class="line">        UNREFERENCED_PARAMETER(Srb);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if(InIdle != NULL)</span><br><span class="line"></span><br><span class="line">        *InIdle = idle;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    return referenceAcquired;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ol start="2">
<li>��Ҫ�� D-state ״̬ͬ����</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">DbgInfo(MODULE_OS_ENTRY, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;ScsiAdapterPower - %s\n&quot;,</span><br><span class="line"></span><br><span class="line">        adpt_pow-&gt;PowerState == StorPowerDeviceD0 ? &quot;D0&quot; : &quot;D3&quot;);</span><br><span class="line"></span><br><span class="line">PrintMsg(&quot;ScsiAdapterPower - %s!\n&quot;, adpt_pow-&gt;PowerState == StorPowerDeviceD0 ? &quot;D0&quot; : &quot;D3&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//Record the D-state, WDM driver must handle it well. Every time D-state is changed, it must be changed here.</span><br><span class="line"></span><br><span class="line">pdx-&gt;pm_state.d0d3_state = adpt_pow-&gt;PowerState;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if(StorPowerActionNone == adpt_pow-&gt;PowerAction</span><br><span class="line"></span><br><span class="line">        &amp;&amp; StorPowerDeviceD3  == adpt_pow-&gt;PowerState)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    DbgInfo(MODULE_OS_ENTRY, FEATURE_PM_TRACE, NOT_TO_RAM, &quot;Enter Runtime D3!\n&quot;);</span><br><span class="line"></span><br><span class="line">    PrintMsg(&quot;Enter Runtime D3!\n&quot;);</span><br><span class="line"></span><br><span class="line">    pdx-&gt;pm_state.rtd3_entered = TRUE;</span><br><span class="line"></span><br><span class="line">    pdx-&gt;pre_card.s3s4_resume_for_card_init = TRUE;</span><br><span class="line"></span><br><span class="line">    // if (FALSE == os_pending_thread(pdx, TRUE))  //for thread sync : such as autotimer stop infinite</span><br><span class="line"></span><br><span class="line">    //     DbgErr(&quot;%s pending thread failed\n&quot;, __FUNCTION__);</span><br><span class="line"></span><br><span class="line">    req_pre_enter_d3(pdx);</span><br><span class="line"></span><br><span class="line">    req_enter_d3(pdx);</span><br><span class="line"></span><br><span class="line">    //os_pending_thread(pdx, FALSE);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ol start="3">
<li>��Ҫ���ܣ�</li>
</ol>
<ul>
<li>�����������&#x2F;�˳�����״̬</li>
<li>���� F-state �仯</li>
<li>ȷ���� D-state ״̬��ȷЭ��</li>
<li>�����豸�Ĵ���״̬</li>
</ul>
<ol start="4">
<li>ע�����</li>
</ol>
<ul>
<li>ֻ�� D0 ״̬�·����豸�Ĵ���</li>
<li>��ȷ�����ӳٵ�����</li>
<li>ά����ȷ�Ĺ���״̬��־</li>
</ul>
<p>������ʵ�ֿ���ȷ�� PoFx �������豸״̬��������ȷЭ����</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Cursor/" rel="tag"># Cursor</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/08/30/Cursor%E8%AE%B0%E5%BD%95-20241111-%E5%85%B3%E4%BA%8EStorport%20Pofx%E5%92%8CSD%20Host%20WDF%E9%A9%B1%E5%8A%A8%E6%9E%B6%E6%9E%84%E6%96%87%E6%A1%A3/" rel="prev" title="Cursor��¼-����Storport Pofx��SD Host WDF�����ܹ��ĵ�">
      <i class="fa fa-chevron-left"></i> Cursor��¼-����Storport Pofx��SD Host WDF�����ܹ��ĵ�
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/08/30/Cursor%20%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%92%8C%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" rel="next" title="Cursor 环境配置和简单使用">
      Cursor 环境配置和简单使用 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Chat-Transcript-Tab-1"><span class="nav-number">1.</span> <span class="nav-text">Chat Transcript - Tab 1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#User"><span class="nav-number">1.1.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet"><span class="nav-number">1.2.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-1"><span class="nav-number">1.3.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-1"><span class="nav-number">1.4.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-2"><span class="nav-number">1.5.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-2"><span class="nav-number">1.6.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-3"><span class="nav-number">1.7.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-3"><span class="nav-number">1.8.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-4"><span class="nav-number">1.9.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-4"><span class="nav-number">1.10.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-5"><span class="nav-number">1.11.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-5"><span class="nav-number">1.12.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-6"><span class="nav-number">1.13.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-6"><span class="nav-number">1.14.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-7"><span class="nav-number">1.15.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-7"><span class="nav-number">1.16.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-8"><span class="nav-number">1.17.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-8"><span class="nav-number">1.18.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-9"><span class="nav-number">1.19.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-9"><span class="nav-number">1.20.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-10"><span class="nav-number">1.21.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-10"><span class="nav-number">1.22.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-11"><span class="nav-number">1.23.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-11"><span class="nav-number">1.24.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-12"><span class="nav-number">1.25.</span> <span class="nav-text">User:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-claude-3-5-sonnet-12"><span class="nav-number">1.26.</span> <span class="nav-text">AI (claude-3.5-sonnet):</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="cursorhu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">cursorhu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">114</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">56</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/cursorhu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cursorhu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:2449055512@qq.com" title="E-Mail → mailto:2449055512@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cursorhu</span>
</div>



        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
