<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 8.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/my_icon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/my_icon/favicon-16x16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="manifest" href="/images/my_icon/manifest.json">
  <meta name="msapplication-config" content="/images/my_icon/browserconfig.xml">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC|Roboto/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Roboto:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"cursorhu.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="ThinkNotes">
<meta property="og:url" content="https://cursorhu.github.io/index.html">
<meta property="og:site_name" content="ThinkNotes">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="cursorhu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://cursorhu.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>ThinkNotes</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ThinkNotes</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Simple is not easy       化繁为简，知易行难</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于我</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2025/11/17/hexo%E5%8D%9A%E5%AE%A2%E5%92%8Cnext%E4%B8%BB%E9%A2%98%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/17/hexo%E5%8D%9A%E5%AE%A2%E5%92%8Cnext%E4%B8%BB%E9%A2%98%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">hexo博客和next主题环境搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-17 19:39:02 / 修改时间：18:55:16" itemprop="dateCreated datePublished" datetime="2025-11-17T19:39:02+08:00">2025-11-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hexo/" itemprop="url" rel="index"><span itemprop="name">hexo</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="hexo博客和next主题环境搭建"><a href="#hexo博客和next主题环境搭建" class="headerlink" title="hexo博客和next主题环境搭建"></a>hexo博客和next主题环境搭建</h1><p>本文描述从0搭建hexo博客环境，以及配置next主题的过程和坑</p>
<h2 id="主环境安装"><a href="#主环境安装" class="headerlink" title="主环境安装"></a>主环境安装</h2><h3 id="安装node-js"><a href="#安装node-js" class="headerlink" title="安装node js"></a>安装node js</h3><p><a target="_blank" rel="noopener" href="https://nodejs.org/en/">https://nodejs.org/en/</a></p>
<p>用cmd检验一下是否安装成功：用 node -v 和 npm -v 命令检查版本</p>
<h3 id="安装hexo"><a href="#安装hexo" class="headerlink" title="安装hexo"></a>安装hexo</h3><p>D盘建立一个文件夹 如hexo-blog，在此目录安装hexo：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hexo-cli</span><br></pre></td></tr></table></figure>

<p>安装完的目录如下，详细见：<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/setup">https://hexo.io/zh-cn/docs/setup</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── _config.yml</span><br><span class="line">├── package.json</span><br><span class="line">├── scaffolds</span><br><span class="line">├── source</span><br><span class="line">|   ├── _drafts</span><br><span class="line">|   └── _posts</span><br><span class="line">└── themes</span><br></pre></td></tr></table></figure>

<p>测试一下创建默认页面本地访问：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">D:\hexo-blog&gt;hexo g  #将blog资料创建为css,html静态文件</span><br><span class="line">INFO  Generated: archives/index.html </span><br><span class="line">D:\hexo-blog&gt;hexo s  #运行hexo server</span><br><span class="line">INFO  Hexo is running at http://localhost:4000/ . Press Ctrl+C to stop.</span><br></pre></td></tr></table></figure>

<h3 id="安装next主题"><a href="#安装next主题" class="headerlink" title="安装next主题"></a>安装next主题</h3><p>在D:\hexo-blog目录下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/theme-next/hexo-theme-next themes/next</span><br></pre></td></tr></table></figure>

<p>主题位于hexo的theme子目录，结构为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── _config.yml</span><br><span class="line">├── languages</span><br><span class="line">├── layout</span><br><span class="line">├── scripts</span><br><span class="line">└── source</span><br></pre></td></tr></table></figure>

<p>含义见：<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/themes">https://hexo.io/zh-cn/docs/themes</a></p>
<h3 id="安装部署插件"><a href="#安装部署插件" class="headerlink" title="安装部署插件"></a>安装部署插件</h3><p>后面部署博客到github会用到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>

<h2 id="hexo配置"><a href="#hexo配置" class="headerlink" title="hexo配置"></a>hexo配置</h2><p>在默认的hexo config.yaml改以下部分：</p>
<p>配置主页面的标题，中英文</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Site</span><br><span class="line">title: ThinkNotes</span><br><span class="line">subtitle: &#x27;Simple is not easy&#x27;</span><br><span class="line">description: &#x27;&#x27;</span><br><span class="line">keywords:</span><br><span class="line">author: cursorhu</span><br><span class="line">language: zh-CN</span><br><span class="line">timezone: &#x27;&#x27;</span><br></pre></td></tr></table></figure>

<p>配置主题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Extensions</span><br><span class="line">## Plugins: https://hexo.io/plugins/</span><br><span class="line">## Themes: https://hexo.io/themes/</span><br><span class="line">theme: next</span><br></pre></td></tr></table></figure>

<p>配置部署到github repo(没有的话要先创建一个公开repo)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Deployment</span><br><span class="line">## Docs: https://hexo.io/docs/one-command-deployment</span><br><span class="line">deploy:</span><br><span class="line">  type: &#x27;git&#x27;</span><br><span class="line">  repo: https://github.com/cursorhu/cursorhu.github.io</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure>

<p>注意git部署需要hexo-deployer-git已安装</p>
<h2 id="next主题配置"><a href="#next主题配置" class="headerlink" title="next主题配置"></a>next主题配置</h2><p>编辑themes\next_config.yml主题配置文件，改动如下：</p>
<p>选择next子主题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Schemes</span><br><span class="line">#scheme: Muse</span><br><span class="line">#scheme: Mist</span><br><span class="line">scheme: Pisces</span><br><span class="line">#scheme: Gemini</span><br></pre></td></tr></table></figure>

<h3 id="主页菜单设置"><a href="#主页菜单设置" class="headerlink" title="主页菜单设置"></a>主页菜单设置</h3><p>配置文件去掉#注释，打开tags，categories，about页面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># ---------------------------------------------------------------</span><br><span class="line"># Menu Settings</span><br><span class="line"># ---------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"># Usage: `Key: /link/ || icon`</span><br><span class="line"># Key is the name of menu item. If the translation for this item is available, the translated text will be loaded, otherwise the Key name will be used. Key is case-senstive.</span><br><span class="line"># Value before `||` delimiter is the target link, value after `||` delimiter is the name of Font Awesome icon.</span><br><span class="line"># When running the site in a subdirectory (e.g. yoursite.com/blog), remove the leading slash from link value (/archives -&gt; archives).</span><br><span class="line"># External url should start with http:// or https://</span><br><span class="line">menu:</span><br><span class="line">  home: / || fa fa-home</span><br><span class="line">  tags: /tags/ || fa fa-tags</span><br><span class="line">  categories: /categories/ || fa fa-th</span><br><span class="line">  archives: /archives/ || fa fa-archive</span><br><span class="line">  about: /about/ || fa fa-user</span><br><span class="line">  #schedule: /schedule/ || fa fa-calendar</span><br><span class="line">  #sitemap: /sitemap.xml || fa fa-sitemap</span><br><span class="line">  #commonweal: /404/ || fa fa-heartbeat</span><br></pre></td></tr></table></figure>

<p>只是主页打开还不行，还需要手动创建page页面，否则报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Cannot GET /about/</span><br><span class="line">Cannot GET /tags/</span><br><span class="line">Cannot GET /categories/</span><br></pre></td></tr></table></figure>

<p>在hexo根目录手动创建page页面：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo new page &quot;about&quot;</span><br><span class="line">hexo new page &quot;tags&quot;</span><br><span class="line">hexo new page &quot;categories&quot;</span><br></pre></td></tr></table></figure>

<p>在 source 目录下会新建 <code>about</code>、<code>tags</code>、<code>categories</code>文件夹，每个文件夹下还会创建一个<code>index.md</code>文件，编辑各页面对应的<code>index.md</code>文件，增加 type字段 ：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: about # 这里可以中英文，显示为页面的标题</span><br><span class="line">date: 2025-11-13 15:21:30 # 这个实际可以删掉，用不上</span><br><span class="line">type: &quot;about&quot;</span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line">title: tages # 这里可以中英文，如 标签</span><br><span class="line">date: 2025-11-13 15:21:30</span><br><span class="line">type: &quot;tags&quot;</span><br><span class="line">---</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line">title: categories # 这里可以中英文，如 分类</span><br><span class="line">date: 2025-11-13 15:21:30</span><br><span class="line">type: &quot;categories&quot;</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<p>注意，这几个页面用本地server测试：hexo g + hexo s并不能看到内容，只有hexo d部署后才能看到。</p>
<h3 id="社交链接"><a href="#社交链接" class="headerlink" title="社交链接"></a>社交链接</h3><p>修改主页显示的社交链接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">social:</span><br><span class="line">  GitHub: https://github.com/cursorhu || fab fa-github</span><br><span class="line">  E-Mail: mailto:2449055512@qq.com || fa fa-envelope</span><br><span class="line">  </span><br><span class="line">social_icons:</span><br><span class="line">  enable: true</span><br></pre></td></tr></table></figure>

<h3 id="字体设置"><a href="#字体设置" class="headerlink" title="字体设置"></a>字体设置</h3><p>推荐英文字体使用Roboto，中文字体使用 Noto Serif SC(宋体思源)</p>
<p>在<a target="_blank" rel="noopener" href="https://www.googlefonts.cn/">Google字体中国网站</a>搜索框搜索字体英文名添加以上两种字体，产生URI(Uniform Resource Identifier)，复制href字段的引号内容。</p>
<p>如下图只是示例，实际需要替换URI，将fonts.googlefonts.cn替换为fonts.googleapis.com，Noto Serif替换为Noto Serif SC。</p>
<p><img src="https://s3.bmp.ovh/imgs/2025/11/17/8756b9beefdaee51.png" alt="image-20251117170618261"></p>
<p>在config.yml的font字段添加host URI和字体名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">font:</span><br><span class="line">  enable: true</span><br><span class="line"></span><br><span class="line">  # Uri of fonts host, e.g. https://fonts.googleapis.com (Default).</span><br><span class="line">  host: https://fonts.googleapis.com/css?family=Noto+Serif+SC|Roboto</span><br><span class="line"></span><br><span class="line">  # Font options:</span><br><span class="line">  # `external: true` will load this font family from `host` above.</span><br><span class="line">  # `family: Times New Roman`. Without any quotes.</span><br><span class="line">  # `size: x.x`. Use `em` as unit. Default: 1 (16px)</span><br><span class="line"></span><br><span class="line">  # Global font settings used for all elements inside &lt;body&gt;.</span><br><span class="line">  global:</span><br><span class="line">    external: true</span><br><span class="line">    family: Noto Serif SC</span><br><span class="line">    size:</span><br><span class="line"></span><br><span class="line">  # Font settings for site title (.site-title).</span><br><span class="line">  title:</span><br><span class="line">    external: true</span><br><span class="line">    family:</span><br><span class="line">    size:</span><br><span class="line"></span><br><span class="line">  # Font settings for headlines (&lt;h1&gt; to &lt;h6&gt;).</span><br><span class="line">  headings:</span><br><span class="line">    external: true</span><br><span class="line">    family:</span><br><span class="line">    size:</span><br><span class="line"></span><br><span class="line">  # Font settings for posts (.post-body).</span><br><span class="line">  posts:</span><br><span class="line">    external: true</span><br><span class="line">    family:</span><br><span class="line"></span><br><span class="line">  # Font settings for &lt;code&gt; and code blocks.</span><br><span class="line">  codes:</span><br><span class="line">    external: true</span><br><span class="line">    family: Roboto</span><br></pre></td></tr></table></figure>

<p>在静态页面的base style配置文件<code>hexo\themes\next\source\css\_variables\base.styl</code>指定中文字体font-family-chinese为’Noto Serif SC’，base.styl是所有主题使用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// Font families.</span><br><span class="line">$font-family-chinese      = &quot;Noto Serif SC&quot;;</span><br><span class="line"></span><br><span class="line">$font-family-base         = $font-family-chinese, sans-serif;</span><br><span class="line">$font-family-base         = get_font_family(&#x27;global&#x27;), $font-family-chinese, sans-serif if get_font_family(&#x27;global&#x27;);</span><br><span class="line"></span><br><span class="line">$font-family-logo         = $font-family-base;</span><br><span class="line">$font-family-logo         = get_font_family(&#x27;title&#x27;), $font-family-base if get_font_family(&#x27;title&#x27;);</span><br><span class="line"></span><br><span class="line">$font-family-headings     = $font-family-base;</span><br><span class="line">$font-family-headings     = get_font_family(&#x27;headings&#x27;), $font-family-base if get_font_family(&#x27;headings&#x27;);</span><br><span class="line"></span><br><span class="line">$font-family-posts        = $font-family-base;</span><br><span class="line">$font-family-posts        = get_font_family(&#x27;posts&#x27;), $font-family-base if get_font_family(&#x27;posts&#x27;);</span><br><span class="line"></span><br><span class="line">$font-family-monospace    = consolas, Menlo, monospace, $font-family-chinese;</span><br><span class="line">$font-family-monospace    = get_font_family(&#x27;codes&#x27;), consolas, Menlo, monospace, $font-family-chinese if get_font_family(&#x27;codes&#x27;);</span><br></pre></td></tr></table></figure>

<h3 id="访问统计"><a href="#访问统计" class="headerlink" title="访问统计"></a>访问统计</h3><p>config.yaml先打开卜算子统计：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Show Views / Visitors of the website / page with busuanzi.</span><br><span class="line"># Get more information on http://ibruce.info/2015/04/04/busuanzi</span><br><span class="line">busuanzi_count:</span><br><span class="line">  enable: true</span><br><span class="line">  total_visitors: true</span><br><span class="line">  total_visitors_icon: fa fa-user</span><br><span class="line">  total_views: true</span><br><span class="line">  total_views_icon: fa fa-eye</span><br><span class="line">  post_views: true</span><br><span class="line">  post_views_icon: fa fa-eye</span><br></pre></td></tr></table></figure>

<p><code>\themes\next\layout\_partials</code>找到<code>footer.swig</code>文件，添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if theme.footer.counter %&#125;</span><br><span class="line">    &lt;script async src=&quot;//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<p>这个链接见官网说明：<a target="_blank" rel="noopener" href="http://ibruce.info/2015/04/04/busuanzi/">http://ibruce.info/2015/04/04/busuanzi/</a></p>
<h3 id="站点图标"><a href="#站点图标" class="headerlink" title="站点图标"></a>站点图标</h3><p>博客站点图标默认为next的logo, 可修改为自定义图标集合。使用<a target="_blank" rel="noopener" href="https://www.favicon-generator.org/">https://www.favicon-generator.org</a> 创建图标包，放到next&#x2F;images下，例如&#x2F;images&#x2F;my_icon&#x2F;，再修改config.yaml配置不同客户端的图标路径：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">favicon:</span><br><span class="line">  small: /images/my_icon/favicon-16x16.ico #用my_icon</span><br><span class="line">  medium: /images/my_icon/favicon-32x32.png</span><br><span class="line">  apple_touch_icon: /images/apple-touch-icon-next.png #这里用默认的</span><br><span class="line">  safari_pinned_tab: /images/logo.svg</span><br><span class="line">  android_manifest: /images/my_icon/manifest.json #用my_icon</span><br><span class="line">  ms_browserconfig: /images/my_icon/browserconfig.xml</span><br></pre></td></tr></table></figure>

<h3 id="主页头像"><a href="#主页头像" class="headerlink" title="主页头像"></a>主页头像</h3><p>将图片放在<code>\MyBlog\themes\next\source\images</code>下，并修改<code>头像名.后缀</code>配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">avatar:</span><br><span class="line">  # Replace the default image and set the url here.</span><br><span class="line">  url: /images/头像名.后缀</span><br></pre></td></tr></table></figure>

<h3 id="主页菜单图标"><a href="#主页菜单图标" class="headerlink" title="主页菜单图标"></a>主页菜单图标</h3><p>打开<code>主题配置文件</code>，找到<code>menu</code>字段</p>
<p>以<code>about</code>菜单项为例，可以看到<code>about: /about/ || fa fa-user</code>这一行，其中<code>||</code>后面的<code>fa fa-user</code>即为本菜单项的图标</p>
<p>如果需要更改图标，可以进入<a href="https://sspai.com/link?target=https://fontawesome.dashgame.com/">Font Awesome</a>获取新图标，只需将文件改为“fa + 复制的图标”即可</p>
<h3 id="主页文章预览控制"><a href="#主页文章预览控制" class="headerlink" title="主页文章预览控制"></a>主页文章预览控制</h3><p>config设置 excerpt_description: true，然后下面方法二选一：</p>
<p>自己手写概述，在文件头添加到description：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: Hexo</span><br><span class="line">categories:  Hexo</span><br><span class="line">tags: Hexo</span><br><span class="line">description: XXXXXXXXX</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<p>或者文章截断，在文章中间加入 <code>&lt;!--more--&gt;</code></p>
<h3 id="搜索栏"><a href="#搜索栏" class="headerlink" title="搜索栏"></a>搜索栏</h3><p>在hexo的config.yaml添加如下，目的是在主页显示搜索菜单项</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Search Config</span><br><span class="line">search:</span><br><span class="line">  path: search.xml</span><br><span class="line">  field: post</span><br><span class="line">  format: html</span><br><span class="line">  limit: 100</span><br></pre></td></tr></table></figure>

<p>安装hexo search插件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-generator-search --save</span><br><span class="line">npm install hexo-generator-searchdb --save</span><br></pre></td></tr></table></figure>

<p>在next的config.yaml使能search</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">local_search:</span><br><span class="line">  enable: true</span><br></pre></td></tr></table></figure>

<h3 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h3><ol>
<li><strong>系统</strong>切换至深色模式时启动暗黑模式</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">darkmode: true</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>一键复制代码：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">codeblock: </span><br><span class="line">	copy_button:</span><br><span class="line">    	enable: true</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>关掉Powered by Hexo &amp; NexT：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powered: false</span><br></pre></td></tr></table></figure>

<h2 id="hexo命令"><a href="#hexo命令" class="headerlink" title="hexo命令"></a>hexo命令</h2><h3 id="创建文章"><a href="#创建文章" class="headerlink" title="创建文章"></a>创建文章</h3><p>创建新文章</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo n &quot;blog&quot; #new</span><br></pre></td></tr></table></figure>

<p>创建指定tags和categories的new post文章</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo n &quot;blog&quot; --tags &quot;tags&quot; --categories &quot;categories&quot;</span><br></pre></td></tr></table></figure>

<p>将常规markdown转化为可以发布的博客：手动复制文章头到任意markdown文件，也是和hexo n命令一样效果</p>
<h3 id="本地部署测试"><a href="#本地部署测试" class="headerlink" title="本地部署测试"></a>本地部署测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo clean #删除缓存，重新生成public博客静态文件</span><br><span class="line">hexo g #generate新博客静态文件</span><br><span class="line">hexo s #server，运行本地服务，用于测试</span><br></pre></td></tr></table></figure>

<h3 id="远程部署"><a href="#远程部署" class="headerlink" title="远程部署"></a>远程部署</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo d #deploy到服务器，如github repo，网络不好需要梯子</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://sspai.com/post/85116">https://sspai.com/post/85116</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2025/10/30/QCOM%20BH202%20SDR50%20tuning%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/10/30/QCOM%20BH202%20SDR50%20tuning%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">QCOM BH202 SDR50 tuning问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-10-30 17:52:38" itemprop="dateCreated datePublished" datetime="2025-10-30T17:52:38+08:00">2025-10-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:17:58" itemprop="dateModified" datetime="2025-11-04T17:17:58+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux%E9%A9%B1%E5%8A%A8/" itemprop="url" rel="index"><span itemprop="name">linux驱动</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="QCOM-BH202-SDR50-tuning问题"><a href="#QCOM-BH202-SDR50-tuning问题" class="headerlink" title="QCOM BH202 SDR50 tuning问题"></a>QCOM BH202 SDR50 tuning问题</h1><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>现象：QCOM+BH202平台，SDR50模式下，Host侧发送tuning CMD19命令处理响应失败(TIMEOUT)，导致无法工作在SDR50模式，BH202驱动log打印wait DLL unlock和CMD19 timeout。其他模式如SDR104模式可以正常工作。</p>
<p>分析：经SD CMD&#x2F;DATA line信号测量，SD card发送了CMD19的响应，问题出在SD Host侧未处理响应。</p>
<p>问题指向SD Host侧在SDR50模式的tuning配置有问题。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p><img src="https://s3.bmp.ovh/imgs/2025/11/04/16c0750eff90aa6f.png" alt="BH202 tuning sdr50.drawio"></p>
<p>如图是SD Host - BH20X bridge - SD card系统。</p>
<p>通常SD Host直连SD card时，SDR50模式host clock &lt;&#x3D;100MHz, 不需要执行SDR50 tuning流程，SDR50 tuning只是可选项。</p>
<p>但是BH20X bridge的数字逻辑要求SDR50模式下也走SDR50 tuning流程，否则SDR50模式无法正常工作。</p>
<p>因此需要修改Host驱动，支持SDR50 tuning，包括两个部分：</p>
<ul>
<li>配置DLL，以支持tuning block所需要的时钟</li>
<li>发送多个(16个) tuning block CMD19命令，解析SD卡响应数据，统计tuning pass相位窗口</li>
</ul>
<p>BH20X驱动也需要适配，调用Host tuning函数时使用高通的tuning流程，而不再直接发tuning block CMD19而不配置DLL。</p>
<h2 id="代码说明"><a href="#代码说明" class="headerlink" title="代码说明"></a>代码说明</h2><p>如下是SDR50 tuning patch，修改点见三处注释</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/mmc/host/sdhci-bayhub.c b/mmc/host/sdhci-bayhub.c</span><br><span class="line">index 5533d38..762d46c 100644</span><br><span class="line">--- a/mmc/host/sdhci-bayhub.c</span><br><span class="line">+++ b/mmc/host/sdhci-bayhub.c</span><br><span class="line">@@ -2087,7 +2087,7 @@ int sdhci_bht_sdr104_execute_tuning(struct sdhci_host *host, u32 opcode)</span><br><span class="line"> </span><br><span class="line"> int sdhci_bht_sdr50_execute_tuning(struct sdhci_host *host, u32 opcode)</span><br><span class="line"> &#123;</span><br><span class="line">-#ifdef MSM_HOST_USED</span><br><span class="line">+#if 0         /* SDR50 host side tuning使用SDR104一样的入口，即调用qcom的sdhci_msm_execute_tuning */</span><br><span class="line">     u8 phase, *data_buf;</span><br><span class="line">     int size = 64;</span><br><span class="line">     int rc = 0;</span><br><span class="line">@@ -3671,7 +3671,7 @@ void ggc_tuning_result_reset(struct sdhci_host *host)</span><br><span class="line">     vendor_host-&gt;ggc.dll_unlock_reinit_flg = 0;</span><br><span class="line">     vendor_host-&gt;ggc.tuning_cmd7_timeout_reinit_flg = 0;</span><br><span class="line">     vendor_host-&gt;ggc.tuning_cmd7_timeout_reinit_cnt = 0;</span><br><span class="line">-    vendor_host-&gt;ggc.sdr50_notuning_sela_inject_flag = 1;</span><br><span class="line">+    vendor_host-&gt;ggc.sdr50_notuning_sela_inject_flag = 0; /* SDR50不需要指定notuning相位，按高通tuning流程执行即可 */</span><br><span class="line">     vendor_host-&gt;ggc.sdr50_notuning_crc_error_flag = 0;</span><br><span class="line">     vendor_host-&gt;ggc.degrade = 0;</span><br><span class="line"> </span><br><span class="line">diff --git a/mmc/host/sdhci-msm.c b/mmc/host/sdhci-msm.c</span><br><span class="line">index 8da7c4f..5a49b7e 100644</span><br><span class="line">--- a/mmc/host/sdhci-msm.c</span><br><span class="line">+++ b/mmc/host/sdhci-msm.c</span><br><span class="line">@@ -1131,6 +1131,10 @@ static bool sdhci_msm_is_tuning_needed(struct sdhci_host *host)</span><br><span class="line"> &#123;</span><br><span class="line"> 	struct mmc_ios *ios = &amp;host-&gt;mmc-&gt;ios;</span><br><span class="line"> 	</span><br><span class="line"> /* 如果当前模式是SDR50且host flag配置了NEEDS_TUNING，则执行tuning流程（DLL配置和CMD19） </span><br><span class="line"> *	注：BH20X驱动默认配置了host-&gt;flags SDHCI_SDR50_NEEDS_TUNING</span><br><span class="line"> */</span><br><span class="line"> +#ifdef CONFIG_MMC_SDHCI_BH201</span><br><span class="line"> +    if (ios-&gt;timing == MMC_TIMING_UHS_SDR50 &amp;&amp;</span><br><span class="line"> +        host-&gt;flags &amp; SDHCI_SDR50_NEEDS_TUNING)</span><br><span class="line"> +    return true;</span><br><span class="line"> +#endif</span><br><span class="line"> 	/*</span><br><span class="line"> 	 * Tuning is required for SDR104, HS200 and HS400 cards and</span><br><span class="line"> 	 * if clock frequency is greater than 100MHz in these modes.</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2025/10/30/Qualcomm%20HDK845%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/10/30/Qualcomm%20HDK845%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" class="post-title-link" itemprop="url">Qualcomm HDK845开发环境</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-10-30 17:52:38" itemprop="dateCreated datePublished" datetime="2025-10-30T17:52:38+08:00">2025-10-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:18:29" itemprop="dateModified" datetime="2025-11-04T17:18:29+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux%E9%A9%B1%E5%8A%A8/" itemprop="url" rel="index"><span itemprop="name">linux驱动</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Qualcomm-HDK845开发环境"><a href="#Qualcomm-HDK845开发环境" class="headerlink" title="Qualcomm HDK845开发环境"></a>Qualcomm HDK845开发环境</h1><h2 id="初始环境搭建（离线BSP包）"><a href="#初始环境搭建（离线BSP包）" class="headerlink" title="初始环境搭建（离线BSP包）"></a>初始环境搭建（离线BSP包）</h2><p>按SDM845(Open-Q 845 HDK) BSP v2.1 离线编译包中的README操作：</p>
<p>离线包约80GB，不需要翻墙下载android AOSP repo，只需要把Linux PC交叉编译环境搭好就能编译完整系统。</p>
<p>注意Linux系统必须使用Ubuntu18.04，其他版本有apt-get找不到包的问题。</p>
<hr>
<p>本压缩包（<code>Open-Q_845_Android-P_v2.1.offline.tar</code>）在原厂BSP编译包（Open-Q_845_Android-P_v2.1.zip）的基础上包含了CAF源码库，可直接编译，无需再从外网下载代码库。</p>
<p>建议先阅读原厂文档中对应的Programmer’s Guide（PG）, e.g., <code>Intrinsyc Open-Q_845 Development Kit BSP Programmer Guide_v1.0.pdf</code>.</p>
<p>本离线编译包涉及如下非原厂文件：</p>
<ol>
<li><code>./bm_README.txt</code><br>本说明文档。</li>
<li><code>Source_Package/bm_getSource.sh</code><br>该脚本为我们解压完原厂BSP编译包后运行的第一个脚本。它仅仅从CAF下载完代码库。</li>
<li><code>Source_Package/bm_first_build.sh</code><br>该脚本将不再下载代码库，顺序执行：应用Patches， 解压专属代码&#x2F;库，执行编译。 前两步需要且只能执行一次。</li>
<li><code>Source_Package/bm_rebuild.sh</code><br>该脚本仅执行编译。</li>
</ol>
<p>后三个文件，均为在原厂<code>Source_Package/getSource_and_build.sh</code>上简单修改而成。</p>
<p>如下步骤演示了如何使用本压缩包。</p>
<h3 id="创建虚拟机（可选）"><a href="#创建虚拟机（可选）" class="headerlink" title="创建虚拟机（可选）"></a>创建虚拟机（可选）</h3><p>使用如下配置，在 Windows 10 上，使用 VMWare Workstation 创建一个Ubuntu 虚拟机。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">内存：  不低于8GB</span><br><span class="line">处理器：建议内核总数不低于4；建议开启各虚拟引擎选项</span><br><span class="line">硬盘：  不低于300GB</span><br><span class="line">网络适配器： NAT或桥接模式均可</span><br><span class="line">CD/DVD(SATA)：使用 `ubuntu-18.04.3-desktop-amd64.iso`，可从Ubuntu官网下载</span><br></pre></td></tr></table></figure>

<p>虚拟机启动后，安装Ubuntu系统时，使用如下选项：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">语言： English</span><br><span class="line">Apps： Minimal Installation</span><br><span class="line">Other options:</span><br><span class="line">   - [uncheck] Download updates while installing ubuntu</span><br><span class="line">   - [check] Install third-part software ...</span><br><span class="line">Where are you: Shanghai / Hongkong</span><br><span class="line">Your computer&#x27;s name: 比如 `qc`</span><br><span class="line">Pick a username: 请务必先使用`bmx`</span><br></pre></td></tr></table></figure>

<p>安装完，系统启动后，推荐参照如下步骤设置：</p>
<ul>
<li>推荐设置更新源为本地更新源，比如<code>China</code>下的<code>mirrors.tuna.tsinghua.edu.cn</code></li>
<li>推荐通过<code>What&#39;s new in Ubuntu</code>引导界面，设置好Livepatch</li>
<li>执行<code>sudo apt update; sudo apt upgrade -y</code> 后重启系统</li>
<li>完整安装VMWare Tools，包含共享目录功能，之后重启系统</li>
</ul>
<h3 id="配置开发环境"><a href="#配置开发环境" class="headerlink" title="配置开发环境"></a>配置开发环境</h3><p>在重启后的Ubuntu中，创建一个内容为如下的脚本，e.g., prep.sh ，并执行它：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; Updating system ...&quot;</span></span><br><span class="line"><span class="built_in">sudo</span> add-apt-repository -y ppa:git-core/ppa</span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt upgrade -y</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; Install libs ...&quot;</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install openjdk-8-jdk -y</span><br><span class="line"><span class="built_in">sudo</span> apt-get install -y curl ccache automake lzop python-networkx bzip2 libbz2-dev libbz2-1.0 \</span><br><span class="line">  libghc-bzlib-dev squashfs-tools pngcrush schedtool dpkg-dev liblz4-tool optipng maven \</span><br><span class="line">  libc6-dev linux-libc-dev g++-5-multilib libssl-dev zip aria2 bc git net-tools openssh-server</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; Configure GIT ...&quot;</span></span><br><span class="line">git config --global user.name <span class="variable">$USER</span></span><br><span class="line">git config --global user.email <span class="variable">$USER</span>@<span class="variable">$HOSTNAME</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; Install repo ...&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span> ~/bin</span><br><span class="line">curl https://storage.googleapis.com/git-repo-downloads/repo &gt; ~/bin/repo</span><br><span class="line"><span class="comment">#curl https://mirrors.tuna.tsinghua.edu.cn/git/git-repo &gt; ~/bin/repo</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> +x ~/bin/repo</span><br><span class="line">bash -c <span class="string">&quot;echo &#x27;#added by <span class="variable">$USER</span>, to add repo&#x27; &gt;&gt; ~/.bashrc&quot;</span></span><br><span class="line">bash -c <span class="string">&quot;echo &#x27;export PATH=<span class="variable">$HOME</span>/bin:\$PATH&#x27; &gt;&gt; ~/.bashrc&quot;</span></span><br><span class="line"><span class="comment">#bash -c &quot;echo &#x27;export REPO_URL=&#x27;https://mirrors.tuna.tsinghua.edu.cn/git/git-repo&#x27;&#x27; &gt;&gt; ~/.bashrc&quot;</span></span><br></pre></td></tr></table></figure>

<p>之后，在终端中执行 <code>source ~/.bashrc</code> 来使 <code>repo</code> 命令生效。</p>
<p>下面，在VMWare Workstation 的虚拟机设置的 <code>选项</code> -&gt; <code>共享文件夹</code> 中，将本离线包（<code>Open-Q_845_Android-P_v2.1.offline.tar</code>）所在的Windows目录 <code>添加</code> 到 <code>文件夹（F）</code>中。<br>这里假设该目录的 <code>名称（N）</code>为 <code>WinDownloads</code>。</p>
<p>之后，在终端中依次执行如下指令将离线包解压到Ubuntu系统中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> ~/openq</span><br><span class="line"><span class="built_in">cd</span> ~/openq</span><br><span class="line">tar xvf /mnt/hgfs/WinDownloads/Open-Q_845_Android-P_v2.1.offline.tar</span><br></pre></td></tr></table></figure>

<h3 id="首次编译系统镜像"><a href="#首次编译系统镜像" class="headerlink" title="首次编译系统镜像"></a>首次编译系统镜像</h3><p>解压完后，请执行如下命令来进行首次编译：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/openq/Open-Q_845_Android-P_v2.1/Source_Package/</span><br><span class="line">./bm_first_build.sh</span><br></pre></td></tr></table></figure>

<p>首次编译会需 5~6 个小时，视Ubuntu硬件配置不同。编译成功后，终端会有如下<code>build completed successfully</code>字样的绿色输出，提示编译顺利结束：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[100% 777/777] Target vbmeta image: out/target/product/sdm845/vbmeta.img</span><br><span class="line"></span><br><span class="line">#### build completed successfully (08:25 (mm:ss)) ####</span><br></pre></td></tr></table></figure>

<p>新编译好的镜像位于 <code>Source_Package/SDA845_Open-Q_845_Android-P_v2.1/out/target/product/sdm845</code> 目录下。</p>
<p>后续可参考 PG 或 <code>README.txt</code> 中的说明来烧录新编译的镜像。</p>
<h3 id="重新编译镜像"><a href="#重新编译镜像" class="headerlink" title="重新编译镜像"></a>重新编译镜像</h3><p>客户在自己定制系统镜像时，做完定制功能的代码修订后，请进入到<code>Source_Package</code>目录后执行<code>./bm_rebuild.sh</code>即可重新编译镜像。<br>选择性&#x2F;部分&#x2F;增量编译和烧录，请参见PG中的说明或原脚本。</p>
<p><strong>请勿再执行<code>./bm_first_build.sh</code>脚本来重新编译镜像。</strong></p>
<h2 id="HDK845的镜像烧录"><a href="#HDK845的镜像烧录" class="headerlink" title="HDK845的镜像烧录"></a>HDK845的镜像烧录</h2><h3 id="平台环境准备"><a href="#平台环境准备" class="headerlink" title="平台环境准备"></a>平台环境准备</h3><p>开发板通过micro USB和type-C USB连接到主机<br>type-C: 用于开发板接收Adb&#x2F;fastboot指令<br>micro USB：用于HOST PC接收开发板的输出打印<br>按键和连接如下：</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504091608737.png" alt="图片1"></p>
<h3 id="使用ADB烧录镜像（Linux）"><a href="#使用ADB烧录镜像（Linux）" class="headerlink" title="使用ADB烧录镜像（Linux）"></a>使用ADB烧录镜像（Linux）</h3><p>编译完需要用ADB USB-C烧录img镜像文件。</p>
<p>（1）设置Linux PC的ADB USB驱动，参考官方README 5.1 Setting up ADB in Linux。</p>
<p>（2）正确调用flashall.sh执行烧录</p>
<p>为了一键编译和烧录，创建了flash_img.sh脚本。必须用source或 . 执行脚本否则pwd路径错误。</p>
<p>脚本记录了进fastboot模式的注意事项，必须先boot到fastboot模式，再插USB-C ADB线。</p>
<p>flash_img.sh:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># How to use this script:</span><br><span class="line"># 1.power on HDK845 with vol- key pressed, enter fastboot mode(HDK845 screen show RECOVERY MODE/Other modes...). notice: do not connect type-C usb fastboot cable for now, otherwise cannot enter fastboot.</span><br><span class="line"># 2.Then connect type-C usb fastboot cable to this PC. use &#x27;lsusb&#x27; to find HDK845 fastboot device(ID 18d1:d00d Google Inc.)</span><br><span class="line"># 3.run this script with source or . command, the flash command resule shall print on terminal.</span><br><span class="line"># 4.HDK845 shall reboot in normal mode, capture micro-USB&#x27;s serial print log with putty or xshell, the type-C fastboot cable does not affect normal boot.</span><br><span class="line"></span><br><span class="line">cd ./SDA845_Open-Q_845_Android-P_v2.1/out/target/product/sdm845</span><br><span class="line">$(pwd)/flashall.sh</span><br><span class="line">cd -</span><br></pre></td></tr></table></figure>

<p>烧录过充如下：</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504091551743.png" alt="image-20250409155137702"></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504091554925.png" alt="image-20250409155422892"></p>
<p>out目录flashall.sh的内容是执行当前目录下img的烧录，并重启</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504091555100.png" alt="image-20250409155512053"></p>
<h3 id="使用ADB烧录镜像（Windows）"><a href="#使用ADB烧录镜像（Windows）" class="headerlink" title="使用ADB烧录镜像（Windows）"></a>使用ADB烧录镜像（Windows）</h3><p>使用Windows ADB USB驱动需要bcdedit打开测试模式才能装Windows ADB USB驱动，装完后设备管理器可看到ADB设备</p>
<p>- 1 首先使开发版进入fastboot模式，连接micro USB，电源选项拨到DC电源, 上电后长按vol-, 然后连接type-C，串口打印出现<code>Fastboot: Processing commands</code>则进入fastboot。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504091613766.jpg" alt="img"><br>- 2 <code>win + R</code>打开<code>cmd</code>，用fastboot烧写编译出来的镜像<br>`&#96;&#96;<br>fastboot flash system system.img<br>fastboot flash persist persist.img<br>fastboot flash boot boot.img<br>fastboot flash dtbo dtbo.img<br>fastboot flash vbmeta vbmeta.img<br>fastboot flash vendor vendor.img<br>fastboot reboot<br>`&#96;&#96;<br>可写入flash.bat脚本,放到系统镜像同一目录下运行<br>`&#96;&#96;<br>@echo off </p>
<p>@echo Reboot bootloader…<br>adb reboot bootloader </p>
<p>@echo Flashing device…<br>fastboot flash system system.img<br>fastboot flash persist persist.img<br>fastboot flash boot boot.img<br>fastboot flash dtbo dtbo.img<br>fastboot flash vbmeta vbmeta.img<br>fastboot flash vendor vendor.img </p>
<p>@echo Flashing finish, rebooting system…<br>fastboot reboot<br>`&#96;&#96;<br>完成后系统重启进入Android桌面。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504091613776.jpg" alt="img"> </p>
<h3 id="HDK845官方README"><a href="#HDK845官方README" class="headerlink" title="HDK845官方README"></a>HDK845官方README</h3><hr>
<ol>
<li>Introduction<br>This release is intended to use for Intrinsyc Open-Q 845 HDK Development Kit.<br>This release uses the standard Codeaurora.org source code as open source development environment.</li>
</ol>
<p>Please make sure to use the Release notes.</p>
<ol start="2">
<li><p>Scope<br>This document assumes prior knowledge of Android source build process.<br>The board comes with preprogrammed boot-loader and Android 9.0.0.<br>User can program from bootloader to all images on target.</p>
</li>
<li><p>Directory structure</p>
</li>
</ol>
<p>Open-Q_845_Android-P_v2.1<br>|– Binaries  —————————————-Prebuilt Binaries<br>|   |– boot.img  ———————————–Linux kernel and ramdisk<br>|   |– dtbo.img  ———————————–Linux kernel device tree overlay<br>|   |– flashall.bat  ———————————Windows batch file to autoload&#x2F;program images using fastboot<br>|   |– flashall.sh  ———————————-Linux shell script to autoload&#x2F;program images using fastboot<br>|   |– persist.img  ——————————Android persist partition<br>|   |– system.img  ——————————–Android core OS partition<br>|   |– vbmeta.img  ——————————–Android VBMeta partition<br>|   <code>-- vendor.img  --------------------------------Android vendor partition | |-- README.txt  --------------------------------------This document | |-- usb_driver/  -------------------------------------Windows USB driver |    |-- amd64/ |    |   |-- NOTICE.txt |    |   |-- WdfCoInstaller01009.dll |    |   |-- winusbcoinstaller2.dll |    |   </code>– WUDFUpdate_01009.dll<br>|    |– androidwinusb86.cat<br>|    |– androidwinusba64.cat<br>|    |– android_winusb.inf<br>|    |– i386&#x2F;<br>|    |   |– NOTICE.txt<br>|    |   |– WdfCoInstaller01009.dll<br>|    |   |– winusbcoinstaller2.dll<br>|    |   <code>-- WUDFUpdate_01009.dll |    </code>– source.properties<br>|<br>|<br>|<br><code>-- Source_Package  ----------------------------------Source code patches     |-- getSource_and_build.sh  ----------------------Main download and build script     |-- proprietary.tar.gz  --------------------------Qualcomm Proprietary Binaries     </code>– patches  ————————————-Patches for Open-Q 845 support</p>
<ol start="4">
<li>How to use this release</li>
</ol>
<p>4.1 Setup the Android build environment for Android Source code build.</p>
<p>4.2 Copy Source Package to build &#x2F; work directory.<br>Note: Before proceeding make sure your internet connection is fine to download code from Code Aurora, and you have necessary hard-disk space.<br>For complete compilation minimum 100GB free space is recommended.</p>
<p>4.3 Copy the Source_Package to build machine.</p>
<p>4.5 Use following commands to compile the source code</p>
<p>user@builmachine$ cd Source_Package<br>user@builmachine$ chmod +x getSource_and_build.sh<br>user@builmachine$i .&#x2F;getSource_and_build.sh<br>The script downloads the source code from codeaurora.org and starts the build process.</p>
<p>4.6 If download and compilation fails script will report error, otherwise you will get the compiled binaries under<br>…&#x2F;out&#x2F;target&#x2F;product&#x2F;sdm845<br>		– boot.img  ————————————Linux kernel and ramdisk<br>		– dtbo.img  ————————————Linux device tree overlay<br>		– system.img  ———————————-Android core OS partition<br>		– userdata.img  ——————————–Android User data partition<br>		– vbmeta.img  ——————————–Android VBMeta partition<br>		– vendor.img  ——————————–Android vendor partition</p>
<p><strong>To program these images,  connect micro USB cable to target and copy flashall.sh to …&#x2F;out&#x2F;target&#x2F;product&#x2F;sdm845&#x2F;</strong><br><strong>And run the script as below:</strong></p>
<p> <strong>.&#x2F;flashall.sh this will program the image and reboot the device.</strong></p>
<ol start="5">
<li>Setting up adb for devices</li>
</ol>
<p><strong>5.1 Setting up ADB in Linux</strong></p>
<p><strong>5.1.1.1 Setup the Android SDK for adb binaries or use the build terminal</strong><br>      <strong>Create file etc&#x2F;udev&#x2F;rules.d&#x2F;51-android.rules with following lines</strong><br>      <strong>#for Fastboot bootloader interface</strong><br>      <strong>SUBSYSTEM&#x3D;&#x3D;”usb”, ATTR{idVendor}&#x3D;&#x3D;”18d1”, MODE&#x3D;”0777”, GROUP&#x3D;”adm”</strong><br>      <strong>#for Device adb interface</strong><br>      <strong>SUBSYSTEM&#x3D;&#x3D;”usb”, ATTR{idVendor}&#x3D;&#x3D;”05c6”, MODE&#x3D;”0777”, GROUP&#x3D;”adm”</strong></p>
<p>5.1.2 Reboot Linux machine and connect devices with micro USB cable<br>Make sure adb binary is in the path or you are in the build terminal</p>
<p>5.2 Setting up ADB in Windows<br>Download Android SDK Platform-Tools for Windows.<br><a target="_blank" rel="noopener" href="https://developer.android.com/studio/releases/platform-tools.html">https://developer.android.com/studio/releases/platform-tools.html</a></p>
<p>You only need to download Android SDK Platform-Tools and Google USB Driver, if you just want to play with the phone. If you plan to develop apps, install also the API of your choice and Eclipse Classic (this is the recommended version by Google devs).</p>
<p>To make available everywhere your platform tools (adb, fastboot, etc.), add your platform-tools directory to Path:<br>Connect USB cable to target.</p>
<p>Device will appear as Android and install the drivers from usb_driver folder.</p>
<p>Please note:<br>Default there are 4 functional interfaces created only one is ADB other are used as diagnostic purpose (QPST, MDM, DIAG, MASS STORAGE).<br>Only one endpoint with following is applicable for ADB.<br>Your android_winusb.inf file should have below lines ADB.<br>android_winusb.inf<br>[Google.NTx86]<br>;Qualcomm SURF&#x2F;FFA<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_9025<br>%CompositeAdbInterface%     &#x3D; USB_Install, USB\VID_05C6&amp;PID_9025&amp;MI_01<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_9025<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_9025&amp;MI_01</p>
<p>;Qualcomm SURF&#x2F;FFA (PTP+ADB)<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_904E<br>%CompositeAdbInterface%     &#x3D; USB_Install, USB\VID_05C6&amp;PID_904E&amp;MI_01<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_904E<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_904E&amp;MI_01</p>
<p>;Qualcomm SURF&#x2F;FFA (MTP+ADB)<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_9039<br>%CompositeAdbInterface%     &#x3D; USB_Install, USB\VID_05C6&amp;PID_9039&amp;MI_01<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_9039<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_9039&amp;MI_01</p>
<p>;Qualcomm SURF&#x2F;FFA (UMS+ADB)<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_9015<br>%CompositeAdbInterface%     &#x3D; USB_Install, USB\VID_05C6&amp;PID_9015&amp;MI_00<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_9015<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_9015&amp;MI_00<br>[Google.NTamd64]<br>;Qualcomm SURF&#x2F;FFA<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_9025<br>%CompositeAdbInterface%     &#x3D; USB_Install, USB\VID_05C6&amp;PID_9025&amp;MI_01<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_9025</p>
<p>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_9025&amp;MI_01</p>
<p>;Qualcomm SURF&#x2F;FFA (PTP+ADB)<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_904E<br>%CompositeAdbInterface%     &#x3D; USB_Install, USB\VID_05C6&amp;PID_904E&amp;MI_01<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_904E<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_904E&amp;MI_01</p>
<p>;Qualcomm SURF&#x2F;FFA (MTP+ADB)<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_9039<br>%CompositeAdbInterface%     &#x3D; USB_Install, USB\VID_05C6&amp;PID_9039&amp;MI_01<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_9039<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_9039&amp;MI_01</p>
<p>;Qualcomm SURF&#x2F;FFA (UMS+ADB)<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_9015<br>%CompositeAdbInterface%     &#x3D; USB_Install, USB\VID_05C6&amp;PID_9015&amp;MI_00<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_9015<br>%SingleAdbInterface%        &#x3D; USB_Install, USB\VID_05C6&amp;PID_9015&amp;MI_00</p>
<p>[Strings]<br>SingleAdbInterface &#x3D; “Android ADB Interface”<br>CompositeAdbInterface &#x3D; “Android Composite ADB Interface”<br>SingleBootLoaderInterface &#x3D; “Android Bootloader Interface”</p>
<p>When you see a Windows pop-up requesting drivers, provide the usb_driver folder path. Other device notifications from Windows should be ignored.</p>
<p>Each time you change your USB connection type from the Android Settings APP, you will see one time installation pop-up requesting for ADB driver to be installed,  provide the usb_driver folder.</p>
<h2 id="代码更新、编译、下载、日志"><a href="#代码更新、编译、下载、日志" class="headerlink" title="代码更新、编译、下载、日志"></a>代码更新、编译、下载、日志</h2><h3 id="代码更新"><a href="#代码更新" class="headerlink" title="代码更新"></a>代码更新</h3><p>Windows PC的VSCode Remote远程改Linux PC上的代码包，配置ssh ip为Linux Host的IP</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504091529645.png" alt="image-20250409152929578"></p>
<h3 id="重新编译和下载img"><a href="#重新编译和下载img" class="headerlink" title="重新编译和下载img"></a>重新编译和下载img</h3><p>见1.4和2.2节。</p>
<p><code>Source_Package</code>目录执行:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bm_rebuild.sh</span><br></pre></td></tr></table></figure>

<p>拔ADB线，按vol- 启动平台进入测试模式，再插ADB线，才可以下载img</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source flash_img.sh</span><br></pre></td></tr></table></figure>

<h3 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h3><p>下载完毕重启，即可通过microUSB的输出查看日志</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504091525317.png" alt="image-20250409152530246"></p>
<h2 id="附录-安卓编译生态"><a href="#附录-安卓编译生态" class="headerlink" title="附录-安卓编译生态"></a>附录-安卓编译生态</h2><p>高通平台HDK845推荐的编译环境如下：</p>
<table>
<thead>
<tr>
<th>HOST</th>
<th>Toolchain</th>
<th>Source code repository</th>
<th>build out Android version</th>
</tr>
</thead>
<tbody><tr>
<td>Ubuntu14.04&#x2F;16.04&#x2F;18.04 LTS</td>
<td>Clang&#x2F;LLVM</td>
<td>CAF</td>
<td>support Android 9 Pie</td>
</tr>
</tbody></table>
<p>理论上支持android编译的环境：</p>
<table>
<thead>
<tr>
<th>HOST</th>
<th>Linux 稳定发行版（ubuntu&#x2F;centOS&#x2F;…）</th>
</tr>
</thead>
<tbody><tr>
<td>Hard Disk</td>
<td>size &gt; 200GB</td>
</tr>
<tr>
<td>Memory</td>
<td>Memory size &gt; 8GB</td>
</tr>
<tr>
<td>CPU</td>
<td>无严格要求，最好Core &gt; 4 Frequency &gt; 3.0GHz</td>
</tr>
</tbody></table>
<p><em><strong>*Clang和LLVM的关系*</strong></em>：</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504091619044.png" alt="img"></p>
<p><em><strong>*CAF和ASOP的关系*</strong></em></p>
<p>CAF is <em><strong>*Code Aurora repository.*</strong></em> It’s the place where Qualcomm releases source code for their phone processors. It’s directly supported by Qualcomm and it’s generally a more optimized branch for Snapdragon phones.</p>
<p>Actually, there are two main baselines for support of Qualcomm devices:</p>
<p><em><strong>*CodeAurora (CAF)*</strong></em> - These are Qualcomm’s reference sources for their platform. This is what they provide to OEMs, and what nearly all OEMs base their software off of. As a result - nearly all non-Nexus devices are running kernels&#x2F;display HALs&#x2F;etc. that are derived from a CAF baseline.</p>
<p><em><strong>*Google’s software baseline*</strong></em>, or <em><strong>*AOSP*</strong></em> - Usually when Google starts working on a new Android version, they’ll fork from CAF at the beginning. Very often Google will be adding “new” features specific to the new Android version, while Qualcomm will continue with performance enhancements and bugfixes against the “old” baseline.</p>
<p>So when a new Android revision comes out, you have two baselines: CAF which is usually “ahead” in performance but “behind” in features, while AOSP is “behind” in performance (relatively) but “ahead” in features.</p>
<p>Nowadays, developers are directly compiling the builds from CAF source code which is really difficult as this is what Google does initially before upgrading to a new version, and then they add features and the source by the time gets ‘compilable’, it is easier to compile the one on Google Sources than the one which is there on CAF.</p>
<p>CAF can be considered as Vanilla version of a Vanilla version of Android.</p>
<p><em><strong>*在线下载和编译的流程：*</strong></em></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504091617471.png" alt="img"></p>
<h2 id="附录-交叉编译概念"><a href="#附录-交叉编译概念" class="headerlink" title="附录-交叉编译概念"></a>附录-交叉编译概念</h2><h3 id="本地编译和交叉编译"><a href="#本地编译和交叉编译" class="headerlink" title="本地编译和交叉编译"></a>本地编译和交叉编译</h3><p>本地编译</p>
<p>本地编译可以理解为，在当前编译平台下，编译出来的程序只能放到当前平台下运行。平时我们常见的软件开发，都是属于本地编译：</p>
<p>比如，在 x86 平台上编写程序并编译成可执行程序。这种方式下，我们使用 x86 平台上的工具，开发针对 x86 平台本身的可执行程序，这个编译过程称为本地编译。</p>
<p>交叉编译</p>
<p>交叉编译可以理解为，在当前编译平台下，编译出来的程序能运行在体系结构不同的另一种目标平台上，但是编译平台本身却不能运行该程序：</p>
<p>比如，在 x86 平台上，编写程序并编译成能运行在 ARM 平台的程序，编译得到的程序在 x86 平台上是不能运行的，必须放到 ARM 平台上才能运行。</p>
<h3 id="交叉编译工具链"><a href="#交叉编译工具链" class="headerlink" title="交叉编译工具链"></a>交叉编译工具链</h3><p>常见的编译过程如下图。编译过程包括了预处理、编译、汇编、链接等功能。每个子功能都是一个单独的工具来实现，它们合在一起形成了一个完整的工具集。</p>
<p>****交叉编译链****就是为了编译跨平台体系结构的程序代码而形成的由多个子工具构成的一套完整的工具集。同时，它隐藏了预处理、编译、汇编、链接等细节，当我们指定了源文件时，它会自动按照编译流程调用不同的子工具，自动生成最终的二进制程序映像。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504091622780.png" alt="image-20250409162245746"> </p>
<p>如上图，交叉编译工具链中最主要的部分包含编译器（如gcc）,汇编器（如as）,连接器（如ld）。通常as和ld及objcopy等其他工具由GNU打包成了binutils（binary utilitys）工具，再加上编译器组成整个工具链。</p>
<p>交叉编译工具链中编译器的命名规则，以如下为例</p>
<p>arm-linux-androideabi-gcc</p>
<p>arm-linux-gnueabihf-clang</p>
<p>命名规则为：</p>
<p><em><strong>*arch-core-kernel-system-compiler*</strong></em></p>
<p>arch：目标平台架构，如arm, x86_64。</p>
<p>core： 目标平台的CPU Core，如Cortex A8</p>
<p>kernel： 目标平台所运行的OS，如Linux，Android，bare（无OS）。</p>
<p>systen：交叉编译链所选择的库函数和目标系统的规范，如gnu，gnueabi等。</p>
<p>compiler: 编译器名，如gcc, g++,clang,clang++</p>
<p>ABI：二进制应用程序接口(Application Binary Interface (ABI) for the ARM Architecture)。在计算机中，应用二进制接口描述了应用程序（或者其他类型）和操作系统之间或其他应用程序的低级接口。</p>
<p>EABI：嵌入式ABI。嵌入式应用二进制接口指定了文件格式、数据类型、寄存器使用、堆积组织优化和在一个嵌入式软件中的参数的标准约定。开发者使用自己的汇编语言也可以使用 EABI 作为与兼容的编译器生成的汇编语言的接口。</p>
<p>两者主要区别是，ABI是计算机上的，EABI是嵌入式平台上（如ARM，MIPS等）。</p>
<h3 id="交叉编译架构"><a href="#交叉编译架构" class="headerlink" title="交叉编译架构"></a>交叉编译架构</h3><p>HOST OS 通常为Linux，包含自身的kernel、glibc基础库和Target程序的依赖库。Toolchain包含C&#x2F;C++及其他语言编译器和汇编、链接器等组件。Toolchain依赖于HOST的glibc基础库。Target binary是编译出的目标镜像&#x2F;程序，编译过程依赖于Toolchain及HOST的build essential libs。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504091623366.png" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2025/10/30/Qualcomm%20sdhci%20dts%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/10/30/Qualcomm%20sdhci%20dts%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">Qualcomm sdhci dts分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-10-30 17:52:38" itemprop="dateCreated datePublished" datetime="2025-10-30T17:52:38+08:00">2025-10-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:19:36" itemprop="dateModified" datetime="2025-11-04T17:19:36+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux%E9%A9%B1%E5%8A%A8/" itemprop="url" rel="index"><span itemprop="name">linux驱动</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Qualcomm-sdhci-dts分析"><a href="#Qualcomm-sdhci-dts分析" class="headerlink" title="Qualcomm sdhci dts分析"></a>Qualcomm sdhci dts分析</h1><h2 id="clocks部分"><a href="#clocks部分" class="headerlink" title="clocks部分"></a>clocks部分</h2><p>sc7280.dtsi中，sdhc的clocks属性如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/* 定义clocks数组，包含三个时钟的值 */</span><br><span class="line">clocks = &lt;&amp;gcc GCC_SDCC1_AHB_CLK&gt;, /* 第一个值，见gcc对象数组的索引GCC_SDCC1_AHB_CLK的成员的值 */</span><br><span class="line">		&lt;&amp;gcc GCC_SDCC1_APPS_CLK&gt;, /* 第二个值，见...对象的...成员的值 */</span><br><span class="line">		&lt;&amp;rpmhcc RPMH_CXO_CLK&gt;; /* 第三个值，见rpmhcc对象数组的索引RPMH_CXO_CLK的成员的值 */</span><br><span class="line">clock-names = &quot;iface&quot;, &quot;core&quot;, &quot;xo&quot;;  /* 以上三个clocks的数组成员，分别命名, 例如&quot;xo&quot;就对应第三个值 */</span><br></pre></td></tr></table></figure>

<p>以”xo”这个clock为例，看下这个clock值到底是多少。</p>
<p>首先找&amp;rpmhcc这个对象，这里有隐藏知识：rpmhcc是个”Clock providers”对象，一定是用”clock别名: clock-controller”的格式定义，在当前SOC dts搜索“rpmhcc: clock-controller”就直接找到其定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rpmhcc: clock-controller &#123;</span><br><span class="line">    compatible = &quot;qcom,sc7280-rpmh-clk&quot;; /* 这里很重要！ */</span><br><span class="line">    clocks = &lt;&amp;xo_board&gt;; /* rpmhcc的clocks源是xo_board */</span><br><span class="line">    clock-names = &quot;xo&quot;; /* 当前clock别名xo */</span><br><span class="line">    #clock-cells = &lt;1&gt;; /* 有两个clock输入(cells是0-based)，即xo_board应该有两组值 */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里很奇怪：</p>
<ol>
<li>rpmhcc没有定义regs，即没有直接定义他提供的时钟的值数值</li>
<li>compatible是干吗用的？</li>
</ol>
<p>原因见下图，clock provider提供的时钟值，是compatible指定的代码里面定义的！</p>
<p><img src="https://img-blog.csdnimg.cn/20190215150254844.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzU0MjMwNQ==,size_16,color_FFFFFF,t_70" alt="img"></p>
<p>rpmhcc本身的clocks源是xo_board对象，这里#clock-cells &#x3D; &lt;1&gt;是表示rpmhcc clocks被几个消费者使用（输出几路时钟），0-based，#clock-cells &#x3D; &lt;0&gt; 表示只有一个成员。</p>
<p>搜索driver&#x2F;clk&#x2F;qcom找rpmh时钟的源文件：</p>
<p>linux-6.7\drivers\clk\qcom\clk-rpmh.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">static const struct of_device_id clk_rpmh_match_table[] = &#123;</span><br><span class="line">	&#123; .compatible = &quot;qcom,qdu1000-rpmh-clk&quot;, .data = &amp;clk_rpmh_qdu1000&#125;,</span><br><span class="line">	&#123; .compatible = &quot;qcom,sa8775p-rpmh-clk&quot;, .data = &amp;clk_rpmh_sa8775p&#125;,</span><br><span class="line">	&#123; .compatible = &quot;qcom,sc7180-rpmh-clk&quot;, .data = &amp;clk_rpmh_sc7180&#125;,</span><br><span class="line">	....</span><br><span class="line">	&#123; .compatible = &quot;qcom,sc7280-rpmh-clk&quot;, .data = &amp;clk_rpmh_sc7280&#125;,</span><br><span class="line">	&#123; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const struct clk_rpmh_desc clk_rpmh_sc7280 = &#123;</span><br><span class="line">	.clks = sc7280_rpmh_clocks,</span><br><span class="line">	.num_clks = ARRAY_SIZE(sc7280_rpmh_clocks),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static struct clk_hw *sc7280_rpmh_clocks[] = &#123;</span><br><span class="line">	[RPMH_CXO_CLK]      = &amp;clk_rpmh_bi_tcxo_div4.hw,</span><br><span class="line">	[RPMH_CXO_CLK_A]    = &amp;clk_rpmh_bi_tcxo_div4_ao.hw,</span><br><span class="line">	[RPMH_LN_BB_CLK2]   = &amp;clk_rpmh_ln_bb_clk2_a2.hw,</span><br><span class="line">	[RPMH_LN_BB_CLK2_A] = &amp;clk_rpmh_ln_bb_clk2_a2_ao.hw,</span><br><span class="line">	[RPMH_RF_CLK1]      = &amp;clk_rpmh_rf_clk1_a.hw,</span><br><span class="line">	[RPMH_RF_CLK1_A]    = &amp;clk_rpmh_rf_clk1_a_ao.hw,</span><br><span class="line">	[RPMH_RF_CLK3]      = &amp;clk_rpmh_rf_clk3_a.hw,</span><br><span class="line">	[RPMH_RF_CLK3_A]    = &amp;clk_rpmh_rf_clk3_a_ao.hw,</span><br><span class="line">	[RPMH_RF_CLK4]      = &amp;clk_rpmh_rf_clk4_a.hw,</span><br><span class="line">	[RPMH_RF_CLK4_A]    = &amp;clk_rpmh_rf_clk4_a_ao.hw,</span><br><span class="line">	[RPMH_IPA_CLK]      = &amp;clk_rpmh_ipa.hw,</span><br><span class="line">	[RPMH_PKA_CLK]      = &amp;clk_rpmh_pka.hw,</span><br><span class="line">	[RPMH_HWKM_CLK]     = &amp;clk_rpmh_hwkm.hw,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中”qcom,sc7280-rpmh-clk”最终data是sc7280_rpmh_clocks[]数组，因此按index RPMH_CXO_CLK拿到的值是&amp;clk_rpmh_bi_tcxo_div4.hw</p>
<p>这个值到底是多少？</p>
<p>最后看下rpmhcc的上游：xo_board对象：</p>
<p>xo_board有两个clocks源：xo_board和sleep_clk，这里的clock-frequency是是固定晶振时钟，整个时钟树的最上游。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">clocks &#123;</span><br><span class="line">    xo_board: xo-board &#123;</span><br><span class="line">        compatible = &quot;fixed-clock&quot;;</span><br><span class="line">        clock-frequency = &lt;76800000&gt;;</span><br><span class="line">        #clock-cells = &lt;0&gt;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	sleep_clk: sleep-clk &#123;</span><br><span class="line">        compatible = &quot;fixed-clock&quot;;</span><br><span class="line">        clock-frequency = &lt;32000&gt;;</span><br><span class="line">        #clock-cells = &lt;0&gt;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>&lt;&amp;rpmhcc RPMH_CXO_CLK&gt;中的index RPMH_CXO_CLK是哪个值，在SOC dts头文件可以看到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;dt-bindings/clock/qcom,rpmh.h&gt;</span><br></pre></td></tr></table></figure>

<p>去kernel&#x2F;include的dt-bindings&#x2F;clock&#x2F;qcom,rpmh.h查找到是0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/* RPMh controlled clocks */</span><br><span class="line">#define RPMH_CXO_CLK				0 </span><br><span class="line">#define RPMH_CXO_CLK_A				1</span><br><span class="line">#define RPMH_LN_BB_CLK2				2</span><br><span class="line">#define RPMH_LN_BB_CLK2_A			3</span><br></pre></td></tr></table></figure>

<p>这个头文件是厂商自定义的索引，其实没必要关系具体值是多少。</p>
<p>看下xo clock在sdhci代码怎么用的：sdhci-msm.c的probe函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/* devm_clk_get是获取clock dts的API，此处获取别名未&quot;xo&quot;的clock值 */</span><br><span class="line">msm_host-&gt;xo_clk = devm_clk_get(&amp;pdev-&gt;dev, &quot;xo&quot;);</span><br><span class="line">if (IS_ERR(msm_host-&gt;xo_clk)) &#123;</span><br><span class="line">    ret = PTR_ERR(msm_host-&gt;xo_clk);</span><br><span class="line">    dev_warn(&amp;pdev-&gt;dev, &quot;TCXO clk not present (%d)\n&quot;, ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>dts clock参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43542305/article/details/87363277">设备树中时钟的使用</a></p>
<p>下面看下core这个clock，和xo clock不一样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">clocks = &lt;&amp;gcc GCC_SDCC2_AHB_CLK&gt;,</span><br><span class="line">        &lt;&amp;gcc GCC_SDCC2_APPS_CLK&gt;, /* core对应的clock */</span><br><span class="line">        &lt;&amp;rpmhcc RPMH_CXO_CLK&gt;;</span><br><span class="line">clock-names = &quot;iface&quot;, &quot;core&quot;, &quot;xo&quot;;</span><br></pre></td></tr></table></figure>

<p>GCC_SDCC2_APPS_CLK在当前SOC的qcom,gcc-sc7280.h是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define GCC_SDCC2_APPS_CLK				114</span><br></pre></td></tr></table></figure>

<p>gcc: clock-controller内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">gcc: clock-controller@100000 &#123;</span><br><span class="line">compatible = &quot;qcom,gcc-sc7280&quot;;</span><br><span class="line">reg = &lt;0 0x00100000 0 0x1f0000&gt;;</span><br><span class="line">clocks = &lt;&amp;rpmhcc RPMH_CXO_CLK&gt;,</span><br><span class="line">	&lt;&amp;rpmhcc RPMH_CXO_CLK_A&gt;, &lt;&amp;sleep_clk&gt;,</span><br><span class="line">	&lt;0&gt;, &lt;&amp;pcie1_phy&gt;,</span><br><span class="line">	&lt;0&gt;, &lt;0&gt;, &lt;0&gt;,</span><br><span class="line">	&lt;&amp;usb_1_qmpphy QMP_USB43DP_USB3_PIPE_CLK&gt;;</span><br><span class="line">clock-names = &quot;bi_tcxo&quot;, &quot;bi_tcxo_ao&quot;, &quot;sleep_clk&quot;,</span><br><span class="line">	&quot;pcie_0_pipe_clk&quot;, &quot;pcie_1_pipe_clk&quot;,</span><br><span class="line">	&quot;ufs_phy_rx_symbol_0_clk&quot;, &quot;ufs_phy_rx_symbol_1_clk&quot;,</span><br><span class="line">	&quot;ufs_phy_tx_symbol_0_clk&quot;,</span><br><span class="line">	&quot;usb3_phy_wrapper_gcc_usb30_pipe_clk&quot;;</span><br><span class="line">#clock-cells = &lt;1&gt;;</span><br><span class="line">#reset-cells = &lt;1&gt;;</span><br><span class="line">#power-domain-cells = &lt;1&gt;;</span><br><span class="line">power-domains = &lt;&amp;rpmhpd SC7280_CX&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>重点看下reg &#x3D; &lt;0 0x00100000 0 0x1f0000&gt;;</p>
<p>一般reg都是<code>&lt;address size&gt;</code>，这里怎么定义了两个从0开始的空间，size还不一样？</p>
<p>这是因为此SOC dts使用的是双32bit（64bit）定义，见SOC dts开头的定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#address-cells = &lt;2&gt;; /* address使用两个cell，每个cell 32bit表示地址 */</span><br><span class="line">#size-cells = &lt;2&gt;; /* size使用两个cell，每个cell 32bit表示地址 */</span><br></pre></td></tr></table></figure>

<p>因此”0 0x00100000”是高位为0，低位为0x00100000，这就是address；”0 0x00100000”也是同理， 0x00100000就是address。</p>
<p>下面看下gcc: clock-controller@100000 的compatible有没有data：</p>
<p>linux-6.7\drivers\clk\qcom\gcc-sc7280.c：没有定义data，因此这个clock的值是reg区间定义的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">static const struct of_device_id gcc_sc7280_match_table[] = &#123;</span><br><span class="line">	&#123; .compatible = &quot;qcom,gcc-sc7280&quot; &#125;,</span><br><span class="line">	&#123; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>为了确保这个理解正确，全局搜索一下”qcom,gcc-sc7280”，没有其他位置有data，有个示例文档：</p>
<p>linux-6.7\linux-6.7\Documentation\devicetree\bindings\clock\qcom,gcc-sc7280.yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clock-controller@100000 &#123;</span><br><span class="line">  compatible = &quot;qcom,gcc-sc7280&quot;;</span><br><span class="line">  reg = &lt;0x00100000 0x1f0000&gt;;</span><br></pre></td></tr></table></figure>

<p>进一步验证了之前分析的address和size使用双32bit定义。</p>
<p>结论：”core” clock的值要看SOC sc7280的0x00100000区间的offset 114 bytes（GCC_SDCC2_APPS_CLK）的值，取决于硬件，dts无法直接看到值。</p>
<p>题外话：在调查GCC_SDCC2_APPS_CLK时找到一些容易产生误导的代码：</p>
<p>linux-6.7\drivers\clk\qcom\gcc-sc7280.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">static struct clk_branch gcc_sdcc2_apps_clk = &#123;</span><br><span class="line">	.halt_reg = 0x14004,</span><br><span class="line">	.halt_check = BRANCH_HALT,</span><br><span class="line">	.clkr = &#123;</span><br><span class="line">		.enable_reg = 0x14004,</span><br><span class="line">		.enable_mask = BIT(0),</span><br><span class="line">		.hw.init = &amp;(struct clk_init_data)&#123;</span><br><span class="line">			.name = &quot;gcc_sdcc2_apps_clk&quot;,</span><br><span class="line">			.parent_hws = (const struct clk_hw*[])&#123;</span><br><span class="line">				&amp;gcc_sdcc2_apps_clk_src.clkr.hw,</span><br><span class="line">			&#125;,</span><br><span class="line">			.num_parents = 1,</span><br><span class="line">			.flags = CLK_SET_RATE_PARENT,</span><br><span class="line">			.ops = &amp;clk_branch2_ops,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const struct freq_tbl ftbl_gcc_sdcc2_apps_clk_src[] = &#123;</span><br><span class="line">	F(400000, P_BI_TCXO, 12, 1, 4),</span><br><span class="line">	F(19200000, P_BI_TCXO, 1, 0, 0),</span><br><span class="line">	F(25000000, P_GCC_GPLL0_OUT_EVEN, 12, 0, 0),</span><br><span class="line">	F(50000000, P_GCC_GPLL0_OUT_EVEN, 6, 0, 0),</span><br><span class="line">	F(100000000, P_GCC_GPLL0_OUT_EVEN, 3, 0, 0),</span><br><span class="line">	F(202000000, P_GCC_GPLL9_OUT_MAIN, 4, 0, 0),</span><br><span class="line">	&#123; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static struct clk_rcg2 gcc_sdcc2_apps_clk_src = &#123;</span><br><span class="line">	.cmd_rcgr = 0x1400c,</span><br><span class="line">	.mnd_width = 8,</span><br><span class="line">	.hid_width = 5,</span><br><span class="line">	.parent_map = gcc_parent_map_9,</span><br><span class="line">	.freq_tbl = ftbl_gcc_sdcc2_apps_clk_src,</span><br><span class="line">	.clkr.hw.init = &amp;(struct clk_init_data)&#123;</span><br><span class="line">		.name = &quot;gcc_sdcc2_apps_clk_src&quot;,</span><br><span class="line">		.parent_data = gcc_parent_data_9,</span><br><span class="line">		.num_parents = ARRAY_SIZE(gcc_parent_data_9),</span><br><span class="line">		.flags = CLK_OPS_PARENT_ENABLE,</span><br><span class="line">		.ops = &amp;clk_rcg2_floor_ops,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2025/10/30/SD%20Host%20Retimer%20%20IC%20Software%20Architecture/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/10/30/SD%20Host%20Retimer%20%20IC%20Software%20Architecture/" class="post-title-link" itemprop="url">SD Host Retimer Software Architecture</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-10-30 17:52:38" itemprop="dateCreated datePublished" datetime="2025-10-30T17:52:38+08:00">2025-10-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:19:58" itemprop="dateModified" datetime="2025-11-04T17:19:58+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux%E9%A9%B1%E5%8A%A8/" itemprop="url" rel="index"><span itemprop="name">linux驱动</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="SD-Host-Retimer-Software-Architecture"><a href="#SD-Host-Retimer-Software-Architecture" class="headerlink" title="SD Host Retimer Software Architecture"></a>SD Host Retimer Software Architecture</h1><h2 id="信号完整性与Redriver-Retimer"><a href="#信号完整性与Redriver-Retimer" class="headerlink" title="信号完整性与Redriver&#x2F;Retimer"></a>信号完整性与Redriver&#x2F;Retimer</h2><h3 id="信号完整性-Signal-Integrity-SI"><a href="#信号完整性-Signal-Integrity-SI" class="headerlink" title="信号完整性(Signal Integrity, SI)"></a>信号完整性(Signal Integrity, SI)</h3><p>（1）数字信号与眼图</p>
<p>简单地讲，数字信号的逻辑0、1是依赖于模拟信号的高低电平</p>
<p>如下图，CMOS电平下，3.3V<del>2V为逻辑1，0.8V</del>0V(GND)为逻辑0；TTL电平下是5V<del>2V为逻辑1，0.8V</del>0V(GND)为逻辑0。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202410311100267.png" alt="image-20241031110053224"></p>
<p>考虑到模拟信号的跳变是有个过程的，如下图，在模拟电平还没达到数字逻辑0、1对应的电压时（下图Rise time和fall time的阶段），此时采样的数据是无效的。只有模拟电平达到逻辑0、1对应的电压时（下图Bit period），才能对信号采样，得到正确的逻辑0、1。</p>
<p>下图即眼图，能得到正确的逻辑0、1的采样区间越大，信号质量越好。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202410311106844.png" alt="image-20241031110611736"></p>
<p>（2）信号完整性</p>
<p>信号在传输过程中会参杂噪声信号，导致信号失真，眼图变差。信号失真太大，就会导致无法正确接收电路中传输的0或1信号，并导致错误的二进制值。</p>
<p>信号完整性即表示传输过程中的信号还保有多少原始信号的质量。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.ansys.com/zh-cn/simulation-topics/what-is-signal-integrity#what-is">ansys.com: 什么是信号完整性？</a></p>
<p>（3）高速信号的信号完整性</p>
<p>高速信号一般有两个特点：</p>
<ol>
<li>时钟周期短，对应时钟和数据采样频率高，即模拟信号跳变频繁，可采样时间更短，对传输线路的信号完整性要求高。</li>
<li>信号电压水平低，比如逻辑1在TTL是5V，CMOS是3.3V，更高速数字电路常用1.8V，1.2V作为高电平。低电压能减少模拟电路的电平建立时间，才能支持更短的信号周期；此外低电平也为了信号传输的功耗更低。信号电压水平低更容易收到噪声电平干扰（更小的噪声电压就能淹没信号电压），因此对传输线路的信号完整性要求高。</li>
</ol>
<p>因此信号完整性问题一般只在高速信号场景中需要重点考虑，低速信号一般没有信号完整性问题。</p>
<h3 id="提高信号完整性：Redriver和Retimer"><a href="#提高信号完整性：Redriver和Retimer" class="headerlink" title="提高信号完整性：Redriver和Retimer"></a>提高信号完整性：Redriver和Retimer</h3><p>既然信号质量变差是原始信号被传输过程的噪声干扰导致，有两种思路提高信号质量：</p>
<ol>
<li>改良派：通过模拟器件滤波过滤噪声，效果有限</li>
<li>改革派：直接重建信号，更彻底</li>
</ol>
<p>以上两种思路落地的方案分别是redriver和retimer</p>
<p>参考<a target="_blank" rel="noopener" href="https://www.asteralabs.com/pci-express-retimers-vs-redrivers-an-eye-popping-difference/">PCI Express® Retimers vs. Redrivers: An Eye-Popping Difference</a></p>
<ul>
<li><strong>Redriver</strong>: A non-protocol-aware software-transparent extension device.</li>
<li><strong>Retimer</strong>: A physical layer protocol-aware, software-transparent extension device that forms two separate electrical link segments.</li>
</ul>
<p>Retimer和Redriver的主要区别在于：</p>
<p>A retimer is a mixed signal analog&#x2F;digital device that is protocol-aware and has the ability to fully recover the data, extract the embedded clock and retransmit a fresh copy of the data using a clean clock. </p>
<ol>
<li>retimer IC是包含模拟、数字的混合器件</li>
<li>retimer IC涉及到数据传输协议（例如<strong>PCIe protocol</strong>）：协议包含数据和时钟，retimer能接收原始数据信号再重新生成数据信号，能接收原始时钟信号再重新生成时钟信号，相当于retimer能完整地重建信号，相比redriver仅用模拟器件过滤噪声效果更好。</li>
</ol>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202410311049454.png" alt="image-20241031104940359"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2025/10/30/SD%20Spec%E5%B8%B8%E7%94%A8%E6%B5%81%E7%A8%8B%E6%91%98%E8%A6%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/10/30/SD%20Spec%E5%B8%B8%E7%94%A8%E6%B5%81%E7%A8%8B%E6%91%98%E8%A6%81/" class="post-title-link" itemprop="url">SD Spec常用流程摘要</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-10-30 17:52:38" itemprop="dateCreated datePublished" datetime="2025-10-30T17:52:38+08:00">2025-10-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:20:19" itemprop="dateModified" datetime="2025-11-04T17:20:19+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux%E9%A9%B1%E5%8A%A8/" itemprop="url" rel="index"><span itemprop="name">linux驱动</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="SD-Spec常用流程摘要"><a href="#SD-Spec常用流程摘要" class="headerlink" title="SD Spec常用流程摘要"></a>SD Spec常用流程摘要</h1><h2 id="SD-legacy初始化流程"><a href="#SD-legacy初始化流程" class="headerlink" title="SD legacy初始化流程"></a>SD legacy初始化流程</h2><p>SD legacy初始化是指所有SD卡在SD模式下的通用初始化流程，在此流程之后才可能指向UHS-I，UHS-II的初始化流程。</p>
<p>流程图见SD physical spec:</p>
<p>CMD0：GO_IDLE_STATE：使卡进入Idle state，即卡复位状态</p>
<p>CMD8：SEND_IF_COND：验证卡接口（I&#x2F;F）的operating conditon（COND），根据返回值的bit判断卡类型，这里不细讲，legacy初始化只看卡有没有返回CMD8，如果返回，获取到卡支持的电压（3.3V&#x2F;1.8V），后面再用这个电压值。</p>
<p>ACMD41（CMD55+CMD41）：SD_SEND_OP_COND：设置operating conditon，相当于根据CMD8的结果，host发起对卡的配置请求。ACMD41并不指向具体的卡设置，可理解为设置流程之前的握手。</p>
<p>CMD11：Voltage Switch：切换Host和SD card之间的信号电平，一般从3.3V切到1.8V，电压切换包括CLK，DATA，CMD线。注意这里的电压切换不是指通信电平的电压，而不是SD卡的供电电压VDD。</p>
<p>CMD2：SEND_CID：Card Identification，获取卡的CID，此命令完毕后卡从idle state进入identify state。</p>
<p>CMD3：SEND_RCA：Relative Card Address，获取卡的地址（来自于卡的RCA register），此命令完毕后卡进入stand-by state(属于data transfer mode中的一种子状态)。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202501031758279.png" alt="image-20250103175846219"></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202501031918136.png" alt="image-20250103191821054"></p>
<p>下图详细描述ACMD41的S18R和S18A，以及CMD11电压切换</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202501031930634.png" alt="image-20250103193000571"></p>
<h2 id="SD-UHS-I的初始化流程"><a href="#SD-UHS-I的初始化流程" class="headerlink" title="SD UHS-I的初始化流程"></a>SD UHS-I的初始化流程</h2><p>legacy初始化的CMD3使卡进入transfer mode的standby状态后，CMD7-&gt;CMD42-&gt;ACMD6-&gt;CMD6-&gt;CMD19即UHS-I的初始化流程：</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202501031933260.png" alt="image-20250103193305212"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2025/05/18/%E7%94%B5%E9%87%8F%E8%AE%A1%20--%2077561%E7%94%B5%E6%B1%A0%E5%BB%BA%E6%A8%A1%E5%92%8C%E8%B0%83%E5%8F%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/05/18/%E7%94%B5%E9%87%8F%E8%AE%A1%20--%2077561%E7%94%B5%E6%B1%A0%E5%BB%BA%E6%A8%A1%E5%92%8C%E8%B0%83%E5%8F%82/" class="post-title-link" itemprop="url">电量计 -- 77561电池建模和调参</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-05-18 15:50:54" itemprop="dateCreated datePublished" datetime="2025-05-18T15:50:54+08:00">2025-05-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:04:01" itemprop="dateModified" datetime="2025-11-04T17:04:01+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/BMS/" itemprop="url" rel="index"><span itemprop="name">BMS</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="电量计-–-77561电池建模和调参"><a href="#电量计-–-77561电池建模和调参" class="headerlink" title="电量计 – 77561电池建模和调参"></a>电量计 – 77561电池建模和调参</h1><h2 id="合并电池建模数据到PRJ"><a href="#合并电池建模数据到PRJ" class="headerlink" title="合并电池建模数据到PRJ"></a>合并电池建模数据到PRJ</h2><p>77561的可配参数包括建模表都是cobra直接配置到flash，因此直接在现有prj上编辑参数：</p>
<p>（1）导入TableMaker输出的OCV_falcon.txt(X轴是电压的版本)和RC.txt表</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503311736904.png" alt="image-20250331173554812"></p>
<p>（2）导入电池规格参数</p>
<p>电量计采样是双节电芯才按双节电压处理；如果是电量计两个通道分别采样单节电芯要按单节电芯算，电池包的电压参数要除2。</p>
<p>多串电芯的示例（双节采样）：</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503311931715.png" alt="image-20250331193151566"></p>
<p>多并电芯的示例：</p>
<p><img src="https://s3.bmp.ovh/imgs/2025/10/23/721c9ec0991e071f.png" alt="image-20251023102148780"></p>
<p>注意保护电压也要调整，Cell OV threshold &gt;&#x3D; 充电限制电压，如果设置低了ADC就不采集，SBS通信就读不出电压为0</p>
<p><img src="https://s3.bmp.ovh/imgs/2025/10/23/b134e7905f5f7e10.png" alt="image-20251023115325601"></p>
<h2 id="FW环境数据更新"><a href="#FW环境数据更新" class="headerlink" title="FW环境数据更新"></a>FW环境数据更新</h2><p>(1) 初始化DFCC表</p>
<p>放电精度调参主要是调DFCC，其定义取决于客户需求要关注哪几个电流和温度，如下图是初始值，默认权重都是100%即保持当前soc不缩小或放大。</p>
<p>注意：DFCC_Y和DFCC_Z的值也要跟随调整，DFCC_X一般不动。</p>
<p><img src="https://s3.bmp.ovh/imgs/2025/10/23/b246339726250faf.png" alt="image-20251023103321369"></p>
<p>sysim系统阻抗是电量计芯片和电芯之间的线阻，影响放大误差，如果默认值1毫欧和实际硬件有很大不匹配可能导致很大的放电误差。</p>
<p>需要测量电池包内，电芯到电量计芯片的阻抗，注意不是电池包到外部充放电线的阻抗，再配置代码参数sysim(单位0.1毫欧)</p>
<p>例如 cfg.sysim &#x3D; 2*10; 表示系统阻抗2毫欧。</p>
<p>(2)更新RC建模表的XY个数</p>
<p>注意Firmware的RC table XY值也要调整为和建模表一致！仿真环境也必须一致，否则仿真曲线和实测曲线不重合！</p>
<p><img src="https://s3.bmp.ovh/imgs/2025/11/03/b8d01a0779dd4593.png" alt="image-20251103110429290"></p>
<h2 id="仿真环境数据更新"><a href="#仿真环境数据更新" class="headerlink" title="仿真环境数据更新"></a>仿真环境数据更新</h2><p>(1)更新建模表和参数</p>
<p>batsim代码里新增一个DATA_TYPE宏区分不同项目配置，根据OCV_falcon.txt和RC.txt表合并OCV,RC table和parameter，需要修改SOCLib的table.c&#x2F;table.h&#x2F;parameter.c</p>
<p>使用python脚本完成以上OCV和RC表数据替换，详见python tool注释；</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503312033925.png" alt="image-20250331203309863"></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503312033583.png" alt="image-20250331203328434"></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503312038052.png" alt="image-20250331203805982"></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504031426429.png" alt="image-20250403142611409"></p>
<p>注意DFCC需要手动配置。从Firmware代码拷DFCC table和Y，Z个数到仿真代码。必须一致否则调参对不上而且问题隐蔽！</p>
<p>还有一些参数在仿真代码main.c直接定义的，如sysim，eod_ddv。</p>
<p>（2）FW 的lib_fg.c需要同步到仿真的SOCLib77561\lib，仿真使用的到底是那个lib_fg .c和.h可以在vs环境查看，将FW的lib&#x2F;lib_fg.c和lib_fg.h复制到仿真工程的SOCLib77561\lib，在vs工程中移除之前的libfg.c和.h，再添加existing file libfg.c和.h。</p>
<p>移植FW lib到仿真工程可能有的问题：dbg_print编译报错，注释掉所有dbg_print。最后winmerge比较确认和FW一致性。参数定义不一致问题，以当前FW定义为准。</p>
<p>以上全部配置好后，编译SOCLib和Simer GUI</p>
<h2 id="仿真软件调参DFCC"><a href="#仿真软件调参DFCC" class="headerlink" title="仿真软件调参DFCC"></a>仿真软件调参DFCC</h2><p>实测不同温度电流下的cobra放电数据（cycler-cobra .csv)</p>
<h3 id="Bat-simmer软件"><a href="#Bat-simmer软件" class="headerlink" title="Bat simmer软件"></a>Bat simmer软件</h3><p>先编译Lib和GUI，运行bat simmer，加载cobra采集数据csv。csv可能包含充电和放电过充，可手动设置Display只显示放电区域的x轴范围</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504021732398.png" alt="image-20250402173244348"></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504011050736.png" alt="image-20250401105054688"></p>
<p>已更新Bat simmer版本功能，GUI X轴自动显示放电过程</p>
<h3 id="DFCC调参"><a href="#DFCC调参" class="headerlink" title="DFCC调参"></a>DFCC调参</h3><p>调参是根据cyc-sim蓝绿曲线的最大值，找对应的SOC，再结合电流和温度，查表对应的DFCC值。</p>
<p>（1）DFCC调参基本思路：</p>
<p>cycle曲线是以cobra csv的电荷积分信息算出的真实电量信息，作为目标值；</p>
<p>simer曲线是以SOCLib中算法输出的rsoc电量信息，作为待调试值；</p>
<p>调参目标：放电阶段，simer曲线逼近cycle曲线，对应的cyc-sim误差全局小于3%。</p>
<p>cycle-cobra的误差反映的是调参以前的实测误差，在调参过程中用不到这个误差。调参以后可以再cobra实测确认误差应该和cyc-sim一致。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504021727057.png" alt="image-20250402172723008"></p>
<p>（2）调参过程：</p>
<p>如果simmer &gt; cycle，调低对应的DFCC区间值；反之则调高DFCC区间值。</p>
<p>以调整RSOC 10位置的误差为例：</p>
<p>由于DFCC表的电流是离散的几个值，可能当前测试的电流(1A)不在DFCC电流表中(0.6A, 1.5A)，算法查DFCC表会依赖于临近电流插值，因此估计(0.6A, 1.5A)两个电流点的DFCC值会共同决定1A的DFCC值，可以同时把(0.6A, 1.5A)两个点调大，也可以只调1.5A, 0.6A不变，以调整结果为准。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504021715840.png" alt="image-20250402171530799"></p>
<p>在调参后需要编译SOCLib更新DLL，Bat Sim界面程序不需要更新，可以直接VS F5运行查看效果（sln项目配置需要设置F5运行默认从Bat sim启动）。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504021736896.png" alt="image-20250402173650853"></p>
<p>（3）DFCC表是有调整规律的：</p>
<p>低温的容量会调低，大电流的容量会调高，高温的容量会调高。</p>
<p>同一 Y, Z轴下的一行DFCC值不会反复跳变，一般是从40%递增到100%甚至超过100。</p>
<p>某个soc点位怎么调都缩写不了误差如何处理：</p>
<ol>
<li><p>考虑调它前面的点位（曲线左侧soc更高的点位），因为前面的soc会累积影响到当前soc，当前误差最大可能是前面soc影响。</p>
</li>
<li><p>曲线要看转折点而不仅仅是最大误差点，看左侧趋势在哪个点位发生斜率改变，这个转折点就是要调的soc，而不是后面误差累计达到最大的点</p>
</li>
</ol>
<p>（4）注意：Bat simer全局最大误差idx log是不准确的，调参应该以曲线鼠标显示的soc值为准</p>
<p>如下图说RSOC 30是误差最大点，实际误差很小；RSOC 8是误差最大点，要调的是这个点）</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504021707148.png" alt="image-20250402170734028"></p>
<p>（5）调参也应该参考cobra曲线和sim曲线，某处soc对应误差大，不一定是修改DFCC这个soc的值，而是修改这个soc前面或者后面的值，要根据sim曲线趋势判断误差发生在前面还是后面的soc。</p>
<p>如下图左侧是cobra原始DFCC，右侧是调参后的DFCC。</p>
<p>正常的调参，DFCC值应该是连续变化，如果有误差在当前soc改不动，例如当前soc偏低，但怎么调高也纠正不了，考虑原因是前面放电更高soc点位的DFCC值偏低。</p>
<p>调参切忌盯着一个soc点位调，错误把DFCC值改成跳变。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504081636016.png" alt="image-20250408163614933"></p>
<p>（5）权重互补</p>
<p>因为DFCC表只是几个采样，实际电流情况会有插值。DFCC调参需要考虑权重互补，考虑相邻DFCC行的权重。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504181030594.png" alt="image-20250418103046531"></p>
<p>(6) 使用cobra数据精确调参</p>
<p>遇到常温误差比较大的情况时，首先排查两个问题：1.看EOD电压附近+-50mV以内是否电量达到0，这是EOD参数基础功能要求。2.如果发现电池开始放电压降大，怀疑sysim问题，仿真代码可以修改sysim看看效果。</p>
<p>然后才是调DFCC：查看GGMEM0的fcc和facc比例，可以直接得出dfcc该如何调整。</p>
<p><img src="https://s3.bmp.ovh/imgs/2025/10/28/fa4464af99381706.png" alt="image-20251028150421032"></p>
<h1 id="Bug-fix记录"><a href="#Bug-fix记录" class="headerlink" title="Bug fix记录"></a>Bug fix记录</h1><h2 id="CADC补偿问题影响低温精度"><a href="#CADC补偿问题影响低温精度" class="headerlink" title="CADC补偿问题影响低温精度"></a>CADC补偿问题影响低温精度</h2><p>77561有CADC TRIM功能，是利用ATE对不同批次芯片测试中发现某些批次电流误差较大时（良率问题），ATE将25度和60度下CADC电流误差纠正值写入flash，FW根据flash值按一定斜率推算低温-20度的电流补偿值。25度和60度的补偿是数字逻辑纠偏不需要FW参与。</p>
<p>如果CADC TRIM功能失效，会导致-20C精度测试的误差很大（达到20%），这时不管怎么调DFCC都很难纠正。因此低温下SOC精度问题尤其要注意CADC补偿是否正常。</p>
<p>CADC TRIM功能和DFCC调参的相关性：</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504111418301.png" alt="image-20250411141816196"></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504111419341.png" alt="image-20250411141914294"></p>
<h2 id="低温大电流放电，cycle曲线异常"><a href="#低温大电流放电，cycle曲线异常" class="headerlink" title="低温大电流放电，cycle曲线异常"></a>低温大电流放电，cycle曲线异常</h2><p>低温-20度用大电流0.5C 2.5A放电，工具读csv显示的cycle曲线异常，下降极快</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504161602548.png" alt="image-20250416160203454"></p>
<p>而同样环境，低温-20度小电流0.2C 1A放电，或者是低温-10度大电流0.5C 2.5A放电，cycle曲线都是正常。</p>
<p>问题原因：低温+大电流两个条件叠加，导致放电开始时初始电压就降到3.4V，而截止电压是3.3V。但工具解析cycle csv数据对放电终点有误判认为3.4V就是终点导致cycle曲线错误解析。</p>
<p>-20度 2.5A的放电数据cycle csv：</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504161610370.png" alt="image-20250416161004330"></p>
<p>解决办法：用rsoc &#x3D; 0作为放电终点，只对小电流放电补充判断截止电压，避免大电流放电误判</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504161610510.png" alt="image-20250416161023471"></p>
<p>修复之后效果：</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202504161612037.png" alt="image-20250416161237987"></p>
<h2 id="电池一致性问题"><a href="#电池一致性问题" class="headerlink" title="电池一致性问题"></a>电池一致性问题</h2><p>一般电池建模和放电cobra测试使用同型号的电芯，但有时电芯一致性区别大，使用#1号电芯建模，使用#2电芯放电测试，怎么调参都达不到仿真效果，可能是一致性问题，即两个同型号电芯的实际容量和内阻等特性有大的差异，导致建模不匹配。</p>
<p>对这种问题，首先确认三个数据是否一致，排除软件引起：建模RCtable，Cobra测试FW的算法和RCtable，仿真环境FW的算法和RCtable，应该完全一致。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202505141930422.png" alt="image-20250514193017205"></p>
<p>问题特性是：</p>
<ol>
<li><p>仿真可以调得很好，但cobra测试误差很大（相同的FW和建模数据，cobra测试曲线和仿真曲线不能保持一致），如下图</p>
</li>
<li><p>查看cobra csv log无异常，温度(内部外部温度区别不大)，电流值（originCurrent和CADC校准后的Bat current），电量（放电的 电流*时间 积分 &#x3D; ccmAh电量）等关键数据都没问题。</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202505141931240.png" alt="image-20250514193136189"></p>
<p>使用当前电芯做一次建模，和已有的RCtable的建模结果比较，如果soc误差大即确认建模不匹配，如下图：</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202505141945794.png" alt="微信图片_20250514194341"></p>
<p>然后用已有RCtable的那块建模电芯再复测，如果仿真曲线和cobra曲线能匹配，就确认了是一致性问题。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2025/05/18/%E7%94%B5%E9%87%8F%E8%AE%A1%20--%20HDQ%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/05/18/%E7%94%B5%E9%87%8F%E8%AE%A1%20--%20HDQ%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B/" class="post-title-link" itemprop="url">电量计 -- HDQ调试过程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-05-18 15:50:54" itemprop="dateCreated datePublished" datetime="2025-05-18T15:50:54+08:00">2025-05-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:04:23" itemprop="dateModified" datetime="2025-11-04T17:04:23+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/BMS/" itemprop="url" rel="index"><span itemprop="name">BMS</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="电量计-–-HDQ调试过程"><a href="#电量计-–-HDQ调试过程" class="headerlink" title="电量计 – HDQ调试过程"></a>电量计 – HDQ调试过程</h1><p>用GPIO INT pin（支持WKUP）实现HDQ接口，实现slave，配合host驱动通信，获取电量信息。并且和I2C接口兼容不冲突。</p>
<h2 id="Keil-sct和项目配置"><a href="#Keil-sct和项目配置" class="headerlink" title="Keil sct和项目配置"></a>Keil sct和项目配置</h2><p>(1) Keil工程配置</p>
<p>Keil的IROM，IRAM配置的主要作用是在编译期发现空间不够的问题，编译器提前报错。</p>
<p>IRAM只是代码段，不包含堆栈，所以IRAM大小要预留STACK和HEAP空间，不然编译期不报错，运行期STACK爆了很难查</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202507161146082.png" alt="image-20250716114617057"></p>
<p>(2) sct链接配置 </p>
<p>真正配置IROM和IRAM空间分布的是.sct文件，如下是newton FW sct</p>
<p>sct的含义参考Keil文档，这里不详细描述。需要会区分IROM，IRAM，知道(+RO)表示代码段，(+RW +ZI)表示数据段，.ANY和*.o是通配。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">;;Flash mapping, total 64KB EEPROM </span><br><span class="line">;0x0~0x2000 8KB bootloader code</span><br><span class="line">;0x2000~0xD3FF 45KB Firmware code</span><br><span class="line">;0xD400~0xF3FF 8KB Table and Parameter data</span><br><span class="line">;0xF400~0xFFFF 3KB log page and trim data</span><br><span class="line"></span><br><span class="line">;;RAM mapping, total 4KB RAM</span><br><span class="line">;0x20000000 ~ 0x20000400 1KB bootloader data</span><br><span class="line">;0x20000400 ~ 0x20000F80 3KB-128 firmware data</span><br><span class="line">;0x20000F80 ~ 0x20001000 128 bytes remain for stack and heap</span><br><span class="line"></span><br><span class="line">LR_IROM1 0x00000000 0x00002000  &#123;</span><br><span class="line">  ER_IROM1 0x00000000 0x00002000  &#123;  ; bootloader 8KB, load address = execution address</span><br><span class="line">   ;.ANY (+RO)</span><br><span class="line">   *.o (RESET, +First)</span><br><span class="line">   ;*(InRoot$$Sections)</span><br><span class="line">   ;startup_armcm0.o</span><br><span class="line">   ;system_ARMCM0.o</span><br><span class="line">   ;newton_o2bootloader_main.o</span><br><span class="line">   ;systime_o2bl.o</span><br><span class="line">   .ANY (+RO)</span><br><span class="line">  &#125;</span><br><span class="line">  RW_IRAM1 0x20000000 0x00000400  &#123;  ; RW data, 1KB</span><br><span class="line">   ;.ANY (+RW +ZI)</span><br><span class="line">   newton_o2bootloader_main.o (+RW +ZI)</span><br><span class="line">  &#125;</span><br><span class="line">  RW_STACK +0 UNINIT ALIGN 16       ; RW data - Stack &lt;&lt;&lt; THIS SECTION IS WHAT I ADDED</span><br><span class="line">  &#123;</span><br><span class="line">    *.o (Stack)</span><br><span class="line">	*.o (Heap)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LR_IROM2 0x00002000 0x0000B400  &#123;    ; FW ROM 45KB(0xB400), +Bootloader 8KB(0x2000) = 53KB, 后面还有8KB</span><br><span class="line">  ER_IROM2 0x00002000 0x0000B400  &#123; </span><br><span class="line">   ;.ANY (+RO)</span><br><span class="line">   *(InRoot$$Sections)</span><br><span class="line">   main.o</span><br><span class="line">   ...</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ;RW_IRAM2 0x20000460 0x00000BA0 &#123; ; original setting, 0x460+0xBA0=0x1000 4KB</span><br><span class="line">  RW_IRAM2 0x20000400 0x00000B80  &#123;  ; RW data, 3KB - 128 bytes(remain for stack)</span><br><span class="line">   ;.ANY (+RW +ZI)</span><br><span class="line">   main.o (+RW +ZI)</span><br><span class="line">  ...</span><br><span class="line">   .ANY (+RW +ZI)  ; Catch-all for any remaining BSS sections</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(3) RAM紧缺的优化方法</p>
<p>修改大数组，添加const使编译器从原本是RW数据区的数组放置到ROM区，减少RAM占用。</p>
<p>注意只读数组可以这么改，修改后数组在EEPROM&#x2F;Flash，无法在RAM中被更新。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202507161136815.png" alt="image-20250716113642727"></p>
<h2 id="Sleep-time过程"><a href="#Sleep-time过程" class="headerlink" title="Sleep time过程"></a>Sleep time过程</h2><p>Chip Sleep主要依赖于Timer1的timeout中断来计时(单位1HZ)，Timer1还能同时配置wakeup中断使timeout时chip从sleep低功耗模式下恢复成全功率模式</p>
<p>Timer2基本没使用，Chip Idle状态下的sleep和定时active都是由timer1完成。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202507181141454.png" alt="image-20250718114147290"></p>
<h2 id="HDQ调试–UART方式"><a href="#HDQ调试–UART方式" class="headerlink" title="HDQ调试–UART方式"></a>HDQ调试–UART方式</h2><p>UART打印只需要使用slave的TX，即GPIO TX；UART打印一次约一百毫秒以上，会影响毫秒级别HDQ timing，secure CRT看到的uart时间戳并不是真实的HDQ timing时间戳。因此UART打印只能用来调试秒级的HDQ的基本逻辑功能。</p>
<h2 id="HDQ调试–GPIO方式"><a href="#HDQ调试–GPIO方式" class="headerlink" title="HDQ调试–GPIO方式"></a>HDQ调试–GPIO方式</h2><p>基本GPIO配置：（INT和TX都可用于调试信号，配置模式不一样）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;chip_uart.h&quot;</span><br><span class="line">void Set_INTGPIO(uint8_t val)</span><br><span class="line">&#123;</span><br><span class="line">    Chip_IO_SetINTCFG(EXINTCFG_MODE_OUTPUT_PUSH_PULL | EXINTCFG_PU_ENABLE);</span><br><span class="line">    UART-&gt;CTL &amp;= ~(UART_CTRL_RX_ENABLE);</span><br><span class="line">    if(val)</span><br><span class="line">        Chip_IO_SetINT_DOUT(EXINTDAT_OUTPUT_HIGH);</span><br><span class="line">    else</span><br><span class="line">        Chip_IO_SetINT_DOUT(EXINTDAT_OUTPUT_LOW);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void Set_TXGPIO(uint8_t val)</span><br><span class="line">&#123;</span><br><span class="line">    Chip_IO_SetGPIOCFG(GPIOCFG_MODE_DIGI_OUTPUT); //注意模式是DIGI_OUTPUT，不是OUTPUT_PUSH_PULL</span><br><span class="line">    UART-&gt;CTL &amp;= ~(UART_CTRL_TX_ENABLE);</span><br><span class="line">    if(val)</span><br><span class="line">        Chip_IO_SetGPIO_DOUT(GPIODATA_OUTPUT_HIGH);</span><br><span class="line">    else</span><br><span class="line">        Chip_IO_SetGPIO_DOUT(GPIODATA_OUTPUT_LOW);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调试信号函数：输出n+1次脉冲(1 &amp; 0)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">static void hdq_txgpio_dbg_signal(int n)&#123;</span><br><span class="line">    do&#123;</span><br><span class="line">        Set_TXGPIO(1);</span><br><span class="line">        Set_TXGPIO(0);</span><br><span class="line">    &#125;while(n--);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用可在中断内，例如HDQ WKUP handler，TIM1 hander：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//HDQ WKUP isr内调用，用dslogic查看break信号是否超时:   </span><br><span class="line"></span><br><span class="line">   hdq_txgpio_dbg_signal(1);</span><br><span class="line"></span><br><span class="line">    // 等待break结束（检测上升沿）</span><br><span class="line">    while (!hdq_gpio_read()) &#123;</span><br><span class="line">        if (hdq_wait_timeout(hdq_ctrl.break_start_ms, 3*HDQ_BREAK_MAX_MS)) &#123;</span><br><span class="line">            // break超时，退出</span><br><span class="line">            dbg_print(&quot;HDQ: Break timeout, elapsed=%dms\r\n&quot;, hdq_timer_elapsed_ms(hdq_ctrl.break_start_ms, hdq_timer_get_ms_count()));</span><br><span class="line">            hdq_ctrl.state = HDQ_STATE_IDLE;</span><br><span class="line">            hdq_enable_sleep();</span><br><span class="line">            </span><br><span class="line">            hdq_txgpio_dbg_signal(2);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    hdq_txgpio_dbg_signal(1);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">void TIM1_IRQHandler(void)</span><br><span class="line">&#123;</span><br><span class="line">	//每次timeout中断翻转一次TX，用于检测中断时间是否准确</span><br><span class="line">    int gpio = Chip_IO_GetGPIO_DOUT();</span><br><span class="line">    Set_TXGPIO(gpio? 0: 1);</span><br><span class="line">    </span><br><span class="line">    TIMER16_1-&gt;TIMINTR |= 1; // TIMER_INT_FLAG;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="HDQ帧间sleep后不能再wkup"><a href="#HDQ帧间sleep后不能再wkup" class="headerlink" title="HDQ帧间sleep后不能再wkup"></a>HDQ帧间sleep后不能再wkup</h2><p>drive sleep前需要初始化配置HDQ的GPIO模式，避免被其他配置干扰</p>
<h2 id="HDQ-fast-sleep"><a href="#HDQ-fast-sleep" class="headerlink" title="HDQ fast sleep"></a>HDQ fast sleep</h2><p>一个SBS通信期间需要多个HDQ帧，如果每个帧都等待systick idle 1s sleep，一次SBS通信太慢，所以需要SBS通信active时，HDQ快速进入sleep</p>
<p>具体方法：新增HDQ register定义：SBS_STATUS_REG_ADDR用于Host通知slave，什么时候SBS开始，什么时候结束，SBS期间slave主动drive sleep不用等idle。</p>
<p>Host侧读SBS：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// 发SBS_STATUS_REG_ADDR = 1表示启动了SBS通信会有多个HDQ帧，</span><br><span class="line">sd77561_hdq_write_byte(chip, SBS_STATUS_REG_ADDR, 1);</span><br><span class="line"></span><br><span class="line">// 写CMD</span><br><span class="line">  sd77561_hdq_write_byte(chip, CMD_REG_ADDR, sbs_cmd_code);</span><br><span class="line">  sd77561_hdq_wait_slave_sleep(HDQ_SBS_RUNNING_WAIT_MS);</span><br><span class="line"></span><br><span class="line">  // 读数据</span><br><span class="line">  for (indx = 0; indx &lt; size; indx++)</span><br><span class="line">  &#123;</span><br><span class="line">   if (sd77561_hdq_read_byte(chip, DATA0_REG_ADDR + indx, &amp;sbs_data[indx]) &lt; 0)</span><br><span class="line">   return -1;</span><br><span class="line">   sd77561_hdq_wait_slave_sleep(HDQ_SBS_RUNNING_WAIT_MS);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 读CRC(CMD+Data的)</span><br><span class="line">  sd77561_hdq_read_byte(chip, CRC_REG_ADDR, &amp;crc_slave) ;</span><br><span class="line">  </span><br><span class="line">// 发SBS_STATUS_REG_ADDR = 0表示完成了SBS通信，固件会恢复1s idle sleep时间</span><br><span class="line">  sd77561_hdq_wait_slave_sleep(HDQ_SBS_RUNNING_WAIT_MS);</span><br><span class="line">  sd77561_hdq_write_byte(chip, SBS_STATUS_REG_ADDR, 0);</span><br></pre></td></tr></table></figure>

<p>Slave侧在SBS的一个HDQ完成后，但SBS没结束的状态下，以ms级别轮询，主动drive sleep</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">if (systime_passed_ms())</span><br><span class="line">    &#123;</span><br><span class="line">#if HDQ_SW_ENABLE</span><br><span class="line">        // dbg_print(&quot;systime_get_ms(): %d\r\n&quot;, systime_get_ms());</span><br><span class="line">        // dbg_print(&quot;hdq_timer_get_count(): %d\r\n&quot;, hdq_timer_get_count());</span><br><span class="line"></span><br><span class="line">        //如果只用HDQ帧idle就进sleep，会导致秒级算法轮询无法更新因为ms级别polling一定比秒级先执行，</span><br><span class="line">        //所以额外使用SBS状态判断，必须是SBS通信过程中的HDQ帧间idle才快速进入sleep，SBS通信标志由host写HDQ reg status设置和清除</span><br><span class="line">        if(hdq_ctrl.state == HDQ_STATE_IDLE) &#123;</span><br><span class="line">            // 检查SBS状态，如果SBS通信进行中则快速进入sleep以便下一帧HDQ</span><br><span class="line">            if (hdq_ctrl.registers.sbs_status_reg &amp; HDQ_SBS_STATUS_RUNNING) &#123;</span><br><span class="line">                stm_drive_sleep(10, STM_SLPMD_SLEEP);  // SBS通信中，快速sleep，下个HDQ break会马上WKUP</span><br><span class="line">            &#125; else&#123; //SBS通信结束，恢复timer和isr使能, 让VADC/CADC能更新</span><br><span class="line">                hdq_timer_restore(); //关闭hdq 1ms timer，避免频繁中断影响cadc等其他中断的更新，因为timer优先级很高</span><br><span class="line">                hdq_isr_restore(); //恢复cadc唤醒等中断，之前hdq启动时关闭了防止充电时频繁唤醒导致hdq通信不能进sleep</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">#endif</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>注：</p>
<p>1.如果不用HDQ_SBS_STATUS_RUNNING限制毫秒级别sleep，会影响秒级的libfg更新算法，所有电量数据将不变。</p>
<p>2.WKUP中断内drive sleep不生效，所以只能在ms级别轮询里做。</p>
<h2 id="HDQ充电时无法进sleep"><a href="#HDQ充电时无法进sleep" class="headerlink" title="HDQ充电时无法进sleep"></a>HDQ充电时无法进sleep</h2><p>是因为CADC中断有触发条件：当电流大于CADC触发阈值，就会自动wakeup更新CADC。所以hdq drive sleep被cadc中断提前唤醒了。</p>
<p>解决：在HDQ帧开始禁用CADC wakeup， HDQ帧（或SBS帧）完成后restore CADC wakeup。</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202507291029945.png" alt="image-20250729102943925"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2025/05/18/%E7%94%B5%E9%87%8F%E8%AE%A1%20--%20%E7%94%B5%E6%B1%A0%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E5%92%8C%E7%94%B5%E9%87%8F%E8%AE%A1%E7%AE%97%E6%B3%95%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/05/18/%E7%94%B5%E9%87%8F%E8%AE%A1%20--%20%E7%94%B5%E6%B1%A0%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E5%92%8C%E7%94%B5%E9%87%8F%E8%AE%A1%E7%AE%97%E6%B3%95%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">电量计 -- 电池基础知识和电量计算法简介</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-05-18 15:50:54" itemprop="dateCreated datePublished" datetime="2025-05-18T15:50:54+08:00">2025-05-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:04:52" itemprop="dateModified" datetime="2025-11-04T17:04:52+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/BMS/" itemprop="url" rel="index"><span itemprop="name">BMS</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="电量计-–-电池基础知识和电量计算法简介"><a href="#电量计-–-电池基础知识和电量计算法简介" class="headerlink" title="电量计 – 电池基础知识和电量计算法简介"></a>电量计 – 电池基础知识和电量计算法简介</h1><h2 id="算法背景简介"><a href="#算法背景简介" class="headerlink" title="算法背景简介"></a>算法背景简介</h2><h3 id="电池建模"><a href="#电池建模" class="headerlink" title="电池建模"></a>电池建模</h3><p>电量计芯片算法首先是建立在电池 &#x2F; 电芯建模的基础上。 由于电芯的SOC受到电池的电压，电池充放电电流以及温度的影响。</p>
<p>根据客户应用场景的需求， 将电芯按照不同的温度和电流进行充电和放电，得到不同场景的充放电数据。 通过大瞬科技自己研发的数据处理软件， 作为该种电池的基础模型数据保存下来， 储存在芯片 flash 或主机端中作为算法的内部数据使用。 当电池进行充放电时， 芯片固件会参考该数据， 对芯片的充放电 SOC 状态进行误差评估， 然后结合当前的电压， 电流和温度， 进行动态的修正。 抑制各种动态环境带来的偏差。</p>
<p>电量计建模会生成两种数据内容：</p>
<p>电池的OCV（Open Circuit Voltage）表，由于库伦积分法无法得到电池的初始SOC，所以在电池上电的初始阶段会应用此表查到的SOC来作为电池初始化的SOC.</p>
<p>电池在不同电压，不同电流以及不同温度下的SOC表格，此表用来作为安时积分法的SOC计算参考表格。<br>温度一般选取-10度，0度，25度和45度4个点。<br>电流根据客户的充放电应用选取3-4个点。<br>同时记录电池在不同温度和不同电流下不同SOC对应的电压点。<br>在实际应用中，对于温度或电流不在建模表范围内的点，采用专用算法进行插值处理。</p>
<h3 id="算法介绍"><a href="#算法介绍" class="headerlink" title="算法介绍"></a>算法介绍</h3><p>电芯按照充放电状态，可以分为充充电状态，空闲状态和放电状态，三种状态会分别执行不同的逻辑。</p>
<p>对于充电状态：<br>在充电初始状态，使用当前电压，电流，温度和 SOH 值来对整体满充电芯容量进行预估。<br>在充电进行中，使用库仑计进行库伦积分，当温度和电流变化时，芯片会计算不同电流和温度下的库伦效率值，整合滤波算法来更新 SOC。<br>根据当前的电压和电流值，以及设定的截至电压和截至电流来判定 CC 和 CV 充电状态。<br>根据设定的截至电压和截至电流以及库伦积分值来判定是否达到满充。其中截至电压和截至电流作为主要判定条件。</p>
<p>对于放电状态：</p>
<p>在放电初始状态，使用当前电压，电流，温度和 SOH 值来对整体电芯的可用容量进行预估。<br>在放电进行中，使用库仑计进行库伦积分，结合 放电模型更新当前可用的有效容量和 SOC，当温度，电流和电压变化时，放电模型会自动更新电芯的有效容量，同时结合自适应 算法 来更新 SOC，保证 SOC 的精度。<br>在放电末端，SOC 小于 10%之后，根据放电的截止电压，对 SOC 值进行额外的滤波处理使其在尾端尽可能逼近截止电压，同时不会因为特定的应用情况而出现跳变。</p>
<p>对于空闲状态：</p>
<p>对于电流死区（10mA，可配置）以上的电流，库伦会记录电流积分数据并更新到SOC 上。<br>对于长时间处于空闲状态的电池，每隔一定时间（12h，可配置），使用电压查询OCV，得到 SOC，对当前的 SOC 进行滤波修正。<br>在无负载状态时，当温度发生变化，电芯电压可能会发生变化。为了避免终端用户在无负载情况下，直接观察到 SOC 下降或者上升，认为设备异常。在这种情况下，电量计 SOC 输出会维持不变。当电芯转入充电或者放电状态时，再根据实际电流，电压和温度情况调整电芯容量预估值，使 SOC 平滑过渡，准确达到充电截止或者放电截止。</p>
<h3 id="调参"><a href="#调参" class="headerlink" title="调参"></a>调参</h3><p>由于不同客户电池的放电容量不同，EOD（End of Discharge）电压不同，电池内阻不同，温度等其他参数对电量的影响也不同，所以在基于大瞬电量计的基础算法上，需根据电量计精度的测试结果来进行调参。<br>对于电池包端电量计，大瞬科技开发有专用的调参仿真软件进行调参。<br>对于主板端电量计，目前仍需实测方式进行调参。</p>
<p>充电精度测量：<br>在实际测试中，充电阶段以芯片报 0%开始，芯片达到 100%结束。通过统计该阶段的库仑计值，就可以计算出该充电阶段的标准 SOC 值。使用该值减去芯片输出的 RSOC 值就可以得到充电阶段 SOC 的误差值。同时充电也需要评估芯片充电截止时的截止电流与客户配置的截止电流之间的实际差异。<br>放电精度测量：<br>对于放电阶段同理，以满充状态为 100%，以芯片报 0%为放电完成。统计该阶段的库仑计值，计算出该放电阶段的标准 SOC 值。使用该值减去芯片输出的 RSOC 值就可以得到放电阶段 SOC 的误差值。放电阶段需要额外评估放电阶段的实际截止电压与客户配置的截止电压之间的差异。</p>
<h2 id="锂电池基础知识"><a href="#锂电池基础知识" class="headerlink" title="锂电池基础知识"></a>锂电池基础知识</h2><h3 id="常用电池参数"><a href="#常用电池参数" class="headerlink" title="常用电池参数"></a>常用电池参数</h3><p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211602675.png" alt="image-20250321160203631"></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211602332.png" alt="image-20250321160221281"></p>
<h3 id="电池充电曲线"><a href="#电池充电曲线" class="headerlink" title="电池充电曲线"></a>电池充电曲线</h3><p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211602487.png" alt="image-20250321160244457"></p>
<h3 id="电池放电特性"><a href="#电池放电特性" class="headerlink" title="电池放电特性"></a>电池放电特性</h3><p>放电电流影响内阻压降</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211603864.png" alt="image-20250321160323833"></p>
<p>负载移除有瞬态效应</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211603115.png" alt="image-20250321160343073"></p>
<p>环境温度影响放电曲线</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211604683.png" alt="image-20250321160416649"></p>
<h3 id="循环次数"><a href="#循环次数" class="headerlink" title="循环次数"></a>循环次数</h3><p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211607520.png" alt="image-20250321160709488"></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211607989.png" alt="image-20250321160721945"></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211607159.png" alt="image-20250321160743128"></p>
<h2 id="电量计简介"><a href="#电量计简介" class="headerlink" title="电量计简介"></a>电量计简介</h2><h3 id="电量计功能"><a href="#电量计功能" class="headerlink" title="电量计功能"></a>电量计功能</h3><p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211608835.png" alt="image-20250321160835792"></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211608143.png" alt="image-20250321160848105"></p>
<h3 id="系统结构"><a href="#系统结构" class="headerlink" title="系统结构"></a>系统结构</h3><p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211610665.png" alt="image-20250321161013632"></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211610250.png" alt="image-20250321161026216"></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211611917.png" alt="image-20250321161050760"></p>
<h3 id="电量检测算法简介"><a href="#电量检测算法简介" class="headerlink" title="电量检测算法简介"></a>电量检测算法简介</h3><p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211611646.png" alt="image-20250321161131608"></p>
<h4 id="OCV查询"><a href="#OCV查询" class="headerlink" title="OCV查询"></a>OCV查询</h4><p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211611128.png" alt="image-20250321161159088"></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211612406.png" alt="image-20250321161210368"></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211612126.png" alt="image-20250321161223080"></p>
<h4 id="库伦监测"><a href="#库伦监测" class="headerlink" title="库伦监测"></a>库伦监测</h4><p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211612654.png" alt="image-20250321161249617"></p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211613724.png" alt="image-20250321161306688"></p>
<h3 id="通用算法流程"><a href="#通用算法流程" class="headerlink" title="通用算法流程"></a>通用算法流程</h3><p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202503211620706.png" alt="image-20250321162020664"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cursorhu.github.io/2025/05/18/%E7%94%B5%E9%87%8F%E8%AE%A1%20--%20%E9%98%BB%E6%8A%97%E8%BF%BD%E8%B8%AA%E7%AE%97%E6%B3%95%E7%A7%BB%E6%A4%8D%E5%92%8C%E8%B0%83%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="cursorhu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThinkNotes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/05/18/%E7%94%B5%E9%87%8F%E8%AE%A1%20--%20%E9%98%BB%E6%8A%97%E8%BF%BD%E8%B8%AA%E7%AE%97%E6%B3%95%E7%A7%BB%E6%A4%8D%E5%92%8C%E8%B0%83%E8%AF%95/" class="post-title-link" itemprop="url">电量计 -- 阻抗追踪算法移植和调试</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-05-18 15:50:54" itemprop="dateCreated datePublished" datetime="2025-05-18T15:50:54+08:00">2025-05-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-04 17:05:20" itemprop="dateModified" datetime="2025-11-04T17:05:20+08:00">2025-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/BMS/" itemprop="url" rel="index"><span itemprop="name">BMS</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="电量计-–-阻抗追踪算法移植和调试"><a href="#电量计-–-阻抗追踪算法移植和调试" class="headerlink" title="电量计 – 阻抗追踪算法移植和调试"></a>电量计 – 阻抗追踪算法移植和调试</h1><h2 id="V-term跳变导致R跳变"><a href="#V-term跳变导致R跳变" class="headerlink" title="V_term跳变导致R跳变"></a>V_term跳变导致R跳变</h2><p>放电电流的大小本身不会影响电池内阻，电池内阻是电池固有状态。</p>
<p>但是调整电流时，因为压降变化，V_term会有大幅度跳变，会影响内阻计算，导致内阻跳变。</p>
<p>这属于算法问题，并不是真实内阻有跳变。</p>
<p>方案：平滑V_term，使用avgcellmv</p>
<p><img src="https://raw.githubusercontent.com/cursorhu/blog-images-on-picgo/master/images/202508041642079.png" alt="image-20250804164236977"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="cursorhu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">cursorhu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">114</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">56</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/cursorhu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cursorhu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:2449055512@qq.com" title="E-Mail → mailto:2449055512@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cursorhu</span>
</div>



        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
